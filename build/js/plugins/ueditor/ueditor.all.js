/*!
 * UEditor
 * version: ueditor
 * build: Wed Aug 10 2016 11:06:16 GMT+0800 (CST)
 */

(function(){

// editor.js
UEDITOR_CONFIG = window.UEDITOR_CONFIG || {};

var baidu = window.baidu || {};

window.baidu = baidu;

window.UE = baidu.editor =  window.UE || {};

UE.plugins = {};

UE.commands = {};

UE.instants = {};

UE.I18N = {};

UE._customizeUI = {};

UE.version = "1.4.3";

var dom = UE.dom = {};

// core/browser.js
/**
 * 浏览器判断模块
 * @file
 * @module UE.browser
 * @since 1.2.6.1
 */

/**
 * 提供浏览器检测的模块
 * @unfile
 * @module UE.browser
 */
var browser = UE.browser = function(){
    var agent = navigator.userAgent.toLowerCase(),
        opera = window.opera,
        browser = {
        /**
         * @property {boolean} ie 检测当前浏览器是否为IE
         * @example
         * ```javascript
         * if ( UE.browser.ie ) {
         *     console.log( '当前浏览器是IE' );
         * }
         * ```
         */
        ie		:  /(msie\s|trident.*rv:)([\w.]+)/.test(agent),

        /**
         * @property {boolean} opera 检测当前浏览器是否为Opera
         * @example
         * ```javascript
         * if ( UE.browser.opera ) {
         *     console.log( '当前浏览器是Opera' );
         * }
         * ```
         */
        opera	: ( !!opera && opera.version ),

        /**
         * @property {boolean} webkit 检测当前浏览器是否是webkit内核的浏览器
         * @example
         * ```javascript
         * if ( UE.browser.webkit ) {
         *     console.log( '当前浏览器是webkit内核浏览器' );
         * }
         * ```
         */
        webkit	: ( agent.indexOf( ' applewebkit/' ) > -1 ),

        /**
         * @property {boolean} mac 检测当前浏览器是否是运行在mac平台下
         * @example
         * ```javascript
         * if ( UE.browser.mac ) {
         *     console.log( '当前浏览器运行在mac平台下' );
         * }
         * ```
         */
        mac	: ( agent.indexOf( 'macintosh' ) > -1 ),

        /**
         * @property {boolean} quirks 检测当前浏览器是否处于“怪异模式”下
         * @example
         * ```javascript
         * if ( UE.browser.quirks ) {
         *     console.log( '当前浏览器运行处于“怪异模式”' );
         * }
         * ```
         */
        quirks : ( document.compatMode == 'BackCompat' )
    };

    /**
    * @property {boolean} gecko 检测当前浏览器内核是否是gecko内核
    * @example
    * ```javascript
    * if ( UE.browser.gecko ) {
    *     console.log( '当前浏览器内核是gecko内核' );
    * }
    * ```
    */
    browser.gecko =( navigator.product == 'Gecko' && !browser.webkit && !browser.opera && !browser.ie);

    var version = 0;

    // Internet Explorer 6.0+
    if ( browser.ie ){

        var v1 =  agent.match(/(?:msie\s([\w.]+))/);
        var v2 = agent.match(/(?:trident.*rv:([\w.]+))/);
        if(v1 && v2 && v1[1] && v2[1]){
            version = Math.max(v1[1]*1,v2[1]*1);
        }else if(v1 && v1[1]){
            version = v1[1]*1;
        }else if(v2 && v2[1]){
            version = v2[1]*1;
        }else{
            version = 0;
        }

        browser.ie11Compat = document.documentMode == 11;
        /**
         * @property { boolean } ie9Compat 检测浏览器模式是否为 IE9 兼容模式
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie9Compat ) {
         *     console.log( '当前浏览器运行在IE9兼容模式下' );
         * }
         * ```
         */
        browser.ie9Compat = document.documentMode == 9;

        /**
         * @property { boolean } ie8 检测浏览器是否是IE8浏览器
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie8 ) {
         *     console.log( '当前浏览器是IE8浏览器' );
         * }
         * ```
         */
        browser.ie8 = !!document.documentMode;

        /**
         * @property { boolean } ie8Compat 检测浏览器模式是否为 IE8 兼容模式
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie8Compat ) {
         *     console.log( '当前浏览器运行在IE8兼容模式下' );
         * }
         * ```
         */
        browser.ie8Compat = document.documentMode == 8;

        /**
         * @property { boolean } ie7Compat 检测浏览器模式是否为 IE7 兼容模式
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie7Compat ) {
         *     console.log( '当前浏览器运行在IE7兼容模式下' );
         * }
         * ```
         */
        browser.ie7Compat = ( ( version == 7 && !document.documentMode )
                || document.documentMode == 7 );

        /**
         * @property { boolean } ie6Compat 检测浏览器模式是否为 IE6 模式 或者怪异模式
         * @warning 如果浏览器不是IE， 则该值为undefined
         * @example
         * ```javascript
         * if ( UE.browser.ie6Compat ) {
         *     console.log( '当前浏览器运行在IE6模式或者怪异模式下' );
         * }
         * ```
         */
        browser.ie6Compat = ( version < 7 || browser.quirks );

        browser.ie9above = version > 8;

        browser.ie9below = version < 9;

        browser.ie11above = version > 10;

        browser.ie11below = version < 11;

    }

    // Gecko.
    if ( browser.gecko ){
        var geckoRelease = agent.match( /rv:([\d\.]+)/ );
        if ( geckoRelease )
        {
            geckoRelease = geckoRelease[1].split( '.' );
            version = geckoRelease[0] * 10000 + ( geckoRelease[1] || 0 ) * 100 + ( geckoRelease[2] || 0 ) * 1;
        }
    }

    /**
     * @property { Number } chrome 检测当前浏览器是否为Chrome, 如果是，则返回Chrome的大版本号
     * @warning 如果浏览器不是chrome， 则该值为undefined
     * @example
     * ```javascript
     * if ( UE.browser.chrome ) {
     *     console.log( '当前浏览器是Chrome' );
     * }
     * ```
     */
    if (/chrome\/(\d+\.\d)/i.test(agent)) {
        browser.chrome = + RegExp['\x241'];
    }

    /**
     * @property { Number } safari 检测当前浏览器是否为Safari, 如果是，则返回Safari的大版本号
     * @warning 如果浏览器不是safari， 则该值为undefined
     * @example
     * ```javascript
     * if ( UE.browser.safari ) {
     *     console.log( '当前浏览器是Safari' );
     * }
     * ```
     */
    if(/(\d+\.\d)?(?:\.\d)?\s+safari\/?(\d+\.\d+)?/i.test(agent) && !/chrome/i.test(agent)){
    	browser.safari = + (RegExp['\x241'] || RegExp['\x242']);
    }


    // Opera 9.50+
    if ( browser.opera )
        version = parseFloat( opera.version() );

    // WebKit 522+ (Safari 3+)
    if ( browser.webkit )
        version = parseFloat( agent.match( / applewebkit\/(\d+)/ )[1] );

    /**
     * @property { Number } version 检测当前浏览器版本号
     * @remind
     * <ul>
     *     <li>IE系列返回值为5,6,7,8,9,10等</li>
     *     <li>gecko系列会返回10900，158900等</li>
     *     <li>webkit系列会返回其build号 (如 522等)</li>
     * </ul>
     * @example
     * ```javascript
     * console.log( '当前浏览器版本号是： ' + UE.browser.version );
     * ```
     */
    browser.version = version;

    /**
     * @property { boolean } isCompatible 检测当前浏览器是否能够与UEditor良好兼容
     * @example
     * ```javascript
     * if ( UE.browser.isCompatible ) {
     *     console.log( '浏览器与UEditor能够良好兼容' );
     * }
     * ```
     */
    browser.isCompatible =
        !browser.mobile && (
        ( browser.ie && version >= 6 ) ||
        ( browser.gecko && version >= 10801 ) ||
        ( browser.opera && version >= 9.5 ) ||
        ( browser.air && version >= 1 ) ||
        ( browser.webkit && version >= 522 ) ||
        false );
    return browser;
}();
//快捷方式
var ie = browser.ie,
    webkit = browser.webkit,
    gecko = browser.gecko,
    opera = browser.opera;

// core/utils.js
/**
 * 工具函数包
 * @file
 * @module UE.utils
 * @since 1.2.6.1
 */

/**
 * UEditor封装使用的静态工具函数
 * @module UE.utils
 * @unfile
 */

var utils = UE.utils = {

    /**
     * 用给定的迭代器遍历对象
     * @method each
     * @param { Object } obj 需要遍历的对象
     * @param { Function } iterator 迭代器， 该方法接受两个参数， 第一个参数是当前所处理的value， 第二个参数是当前遍历对象的key
     * @example
     * ```javascript
     * var demoObj = {
     *     key1: 1,
     *     key2: 2
     * };
     *
     * //output: key1: 1, key2: 2
     * UE.utils.each( demoObj, funciton ( value, key ) {
     *
     *     console.log( key + ":" + value );
     *
     * } );
     * ```
     */

    /**
     * 用给定的迭代器遍历数组或类数组对象
     * @method each
     * @param { Array } array 需要遍历的数组或者类数组
     * @param { Function } iterator 迭代器， 该方法接受两个参数， 第一个参数是当前所处理的value， 第二个参数是当前遍历对象的key
     * @example
     * ```javascript
     * var divs = document.getElmentByTagNames( "div" );
     *
     * //output: 0: DIV, 1: DIV ...
     * UE.utils.each( divs, funciton ( value, key ) {
     *
     *     console.log( key + ":" + value.tagName );
     *
     * } );
     * ```
     */
    each : function(obj, iterator, context) {
        if (obj == null) return;
        if (obj.length === +obj.length) {
            for (var i = 0, l = obj.length; i < l; i++) {
                if(iterator.call(context, obj[i], i, obj) === false)
                    return false;
            }
        } else {
            for (var key in obj) {
                if (obj.hasOwnProperty(key)) {
                    if(iterator.call(context, obj[key], key, obj) === false)
                        return false;
                }
            }
        }
    },

    /**
     * 以给定对象作为原型创建一个新对象
     * @method makeInstance
     * @param { Object } protoObject 该对象将作为新创建对象的原型
     * @return { Object } 新的对象， 该对象的原型是给定的protoObject对象
     * @example
     * ```javascript
     *
     * var protoObject = { sayHello: function () { console.log('Hello UEditor!'); } };
     *
     * var newObject = UE.utils.makeInstance( protoObject );
     * //output: Hello UEditor!
     * newObject.sayHello();
     * ```
     */
    makeInstance:function (obj) {
        var noop = new Function();
        noop.prototype = obj;
        obj = new noop;
        noop.prototype = null;
        return obj;
    },

    /**
     * 将source对象中的属性扩展到target对象上
     * @method extend
     * @remind 该方法将强制把source对象上的属性复制到target对象上
     * @see UE.utils.extend(Object,Object,Boolean)
     * @param { Object } target 目标对象， 新的属性将附加到该对象上
     * @param { Object } source 源对象， 该对象的属性会被附加到target对象上
     * @return { Object } 返回target对象
     * @example
     * ```javascript
     *
     * var target = { name: 'target', sex: 1 },
     *      source = { name: 'source', age: 17 };
     *
     * UE.utils.extend( target, source );
     *
     * //output: { name: 'source', sex: 1, age: 17 }
     * console.log( target );
     *
     * ```
     */

    /**
     * 将source对象中的属性扩展到target对象上， 根据指定的isKeepTarget值决定是否保留目标对象中与
     * 源对象属性名相同的属性值。
     * @method extend
     * @param { Object } target 目标对象， 新的属性将附加到该对象上
     * @param { Object } source 源对象， 该对象的属性会被附加到target对象上
     * @param { Boolean } isKeepTarget 是否保留目标对象中与源对象中属性名相同的属性
     * @return { Object } 返回target对象
     * @example
     * ```javascript
     *
     * var target = { name: 'target', sex: 1 },
     *      source = { name: 'source', age: 17 };
     *
     * UE.utils.extend( target, source, true );
     *
     * //output: { name: 'target', sex: 1, age: 17 }
     * console.log( target );
     *
     * ```
     */
    extend:function (t, s, b) {
        if (s) {
            for (var k in s) {
                if (!b || !t.hasOwnProperty(k)) {
                    t[k] = s[k];
                }
            }
        }
        return t;
    },

    /**
     * 将给定的多个对象的属性复制到目标对象target上
     * @method extend2
     * @remind 该方法将强制把源对象上的属性复制到target对象上
     * @remind 该方法支持两个及以上的参数， 从第二个参数开始， 其属性都会被复制到第一个参数上。 如果遇到同名的属性，
     *          将会覆盖掉之前的值。
     * @param { Object } target 目标对象， 新的属性将附加到该对象上
     * @param { Object... } source 源对象， 支持多个对象， 该对象的属性会被附加到target对象上
     * @return { Object } 返回target对象
     * @example
     * ```javascript
     *
     * var target = {},
     *     source1 = { name: 'source', age: 17 },
     *     source2 = { title: 'dev' };
     *
     * UE.utils.extend2( target, source1, source2 );
     *
     * //output: { name: 'source', age: 17, title: 'dev' }
     * console.log( target );
     *
     * ```
     */
    extend2:function (t) {
        var a = arguments;
        for (var i = 1; i < a.length; i++) {
            var x = a[i];
            for (var k in x) {
                if (!t.hasOwnProperty(k)) {
                    t[k] = x[k];
                }
            }
        }
        return t;
    },

    /**
     * 模拟继承机制， 使得subClass继承自superClass
     * @method inherits
     * @param { Object } subClass 子类对象
     * @param { Object } superClass 超类对象
     * @warning 该方法只能让subClass继承超类的原型， subClass对象自身的属性和方法不会被继承
     * @return { Object } 继承superClass后的子类对象
     * @example
     * ```javascript
     * function SuperClass(){
     *     this.name = "小李";
     * }
     *
     * SuperClass.prototype = {
     *     hello:function(str){
     *         console.log(this.name + str);
     *     }
     * }
     *
     * function SubClass(){
     *     this.name = "小张";
     * }
     *
     * UE.utils.inherits(SubClass,SuperClass);
     *
     * var sub = new SubClass();
     * //output: '小张早上好!
     * sub.hello("早上好!");
     * ```
     */
    inherits:function (subClass, superClass) {
        var oldP = subClass.prototype,
            newP = utils.makeInstance(superClass.prototype);
        utils.extend(newP, oldP, true);
        subClass.prototype = newP;
        return (newP.constructor = subClass);
    },

    /**
     * 用指定的context对象作为函数fn的上下文
     * @method bind
     * @param { Function } fn 需要绑定上下文的函数对象
     * @param { Object } content 函数fn新的上下文对象
     * @return { Function } 一个新的函数， 该函数作为原始函数fn的代理， 将完成fn的上下文调换工作。
     * @example
     * ```javascript
     *
     * var name = 'window',
     *     newTest = null;
     *
     * function test () {
     *     console.log( this.name );
     * }
     *
     * newTest = UE.utils.bind( test, { name: 'object' } );
     *
     * //output: object
     * newTest();
     *
     * //output: window
     * test();
     *
     * ```
     */
    bind:function (fn, context) {
        return function () {
            return fn.apply(context, arguments);
        };
    },

    /**
     * 创建延迟指定时间后执行的函数fn
     * @method defer
     * @param { Function } fn 需要延迟执行的函数对象
     * @param { int } delay 延迟的时间， 单位是毫秒
     * @warning 该方法的时间控制是不精确的，仅仅只能保证函数的执行是在给定的时间之后，
     *           而不能保证刚好到达延迟时间时执行。
     * @return { Function } 目标函数fn的代理函数， 只有执行该函数才能起到延时效果
     * @example
     * ```javascript
     * var start = 0;
     *
     * function test(){
     *     console.log( new Date() - start );
     * }
     *
     * var testDefer = UE.utils.defer( test, 1000 );
     * //
     * start = new Date();
     * //output: (大约在1000毫秒之后输出) 1000
     * testDefer();
     * ```
     */

    /**
     * 创建延迟指定时间后执行的函数fn, 如果在延迟时间内再次执行该方法， 将会根据指定的exclusion的值，
     * 决定是否取消前一次函数的执行， 如果exclusion的值为true， 则取消执行，反之，将继续执行前一个方法。
     * @method defer
     * @param { Function } fn 需要延迟执行的函数对象
     * @param { int } delay 延迟的时间， 单位是毫秒
     * @param { Boolean } exclusion 如果在延迟时间内再次执行该函数，该值将决定是否取消执行前一次函数的执行，
     *                     值为true表示取消执行， 反之则将在执行前一次函数之后才执行本次函数调用。
     * @warning 该方法的时间控制是不精确的，仅仅只能保证函数的执行是在给定的时间之后，
     *           而不能保证刚好到达延迟时间时执行。
     * @return { Function } 目标函数fn的代理函数， 只有执行该函数才能起到延时效果
     * @example
     * ```javascript
     *
     * function test(){
     *     console.log(1);
     * }
     *
     * var testDefer = UE.utils.defer( test, 1000, true );
     *
     * //output: (两次调用仅有一次输出) 1
     * testDefer();
     * testDefer();
     * ```
     */
    defer:function (fn, delay, exclusion) {
        var timerID;
        return function () {
            if (exclusion) {
                clearTimeout(timerID);
            }
            timerID = setTimeout(fn, delay);
        };
    },

    /**
     * 获取元素item在数组array中首次出现的位置, 如果未找到item， 则返回-1
     * @method indexOf
     * @remind 该方法的匹配过程使用的是恒等“===”
     * @param { Array } array 需要查找的数组对象
     * @param { * } item 需要在目标数组中查找的值
     * @return { int } 返回item在目标数组array中首次出现的位置， 如果在数组中未找到item， 则返回-1
     * @example
     * ```javascript
     * var item = 1,
     *     arr = [ 3, 4, 6, 8, 1, 1, 2 ];
     *
     * //output: 4
     * console.log( UE.utils.indexOf( arr, item ) );
     * ```
     */

    /**
     * 获取元素item数组array中首次出现的位置, 如果未找到item， 则返回-1。通过start的值可以指定搜索的起始位置。
     * @method indexOf
     * @remind 该方法的匹配过程使用的是恒等“===”
     * @param { Array } array 需要查找的数组对象
     * @param { * } item 需要在目标数组中查找的值
     * @param { int } start 搜索的起始位置
     * @return { int } 返回item在目标数组array中的start位置之后首次出现的位置， 如果在数组中未找到item， 则返回-1
     * @example
     * ```javascript
     * var item = 1,
     *     arr = [ 3, 4, 6, 8, 1, 2, 8, 3, 2, 1, 1, 4 ];
     *
     * //output: 9
     * console.log( UE.utils.indexOf( arr, item, 5 ) );
     * ```
     */
    indexOf:function (array, item, start) {
        var index = -1;
        start = this.isNumber(start) ? start : 0;
        this.each(array, function (v, i) {
            if (i >= start && v === item) {
                index = i;
                return false;
            }
        });
        return index;
    },

    /**
     * 移除数组array中所有的元素item
     * @method removeItem
     * @param { Array } array 要移除元素的目标数组
     * @param { * } item 将要被移除的元素
     * @remind 该方法的匹配过程使用的是恒等“===”
     * @example
     * ```javascript
     * var arr = [ 4, 5, 7, 1, 3, 4, 6 ];
     *
     * UE.utils.removeItem( arr, 4 );
     * //output: [ 5, 7, 1, 3, 6 ]
     * console.log( arr );
     *
     * ```
     */
    removeItem:function (array, item) {
        for (var i = 0, l = array.length; i < l; i++) {
            if (array[i] === item) {
                array.splice(i, 1);
                i--;
            }
        }
    },

    /**
     * 删除字符串str的首尾空格
     * @method trim
     * @param { String } str 需要删除首尾空格的字符串
     * @return { String } 删除了首尾的空格后的字符串
     * @example
     * ```javascript
     *
     * var str = " UEdtior ";
     *
     * //output: 9
     * console.log( str.length );
     *
     * //output: 7
     * console.log( UE.utils.trim( " UEdtior " ).length );
     *
     * //output: 9
     * console.log( str.length );
     *
     *  ```
     */
    trim:function (str) {
        return str.replace(/(^[ \t\n\r]+)|([ \t\n\r]+$)/g, '');
    },

    /**
     * 将字符串str以','分隔成数组后，将该数组转换成哈希对象， 其生成的hash对象的key为数组中的元素， value为1
     * @method listToMap
     * @warning 该方法在生成的hash对象中，会为每一个key同时生成一个另一个全大写的key。
     * @param { String } str 该字符串将被以','分割为数组， 然后进行转化
     * @return { Object } 转化之后的hash对象
     * @example
     * ```javascript
     *
     * //output: Object {UEdtior: 1, UEDTIOR: 1, Hello: 1, HELLO: 1}
     * console.log( UE.utils.listToMap( 'UEdtior,Hello' ) );
     *
     * ```
     */

    /**
     * 将字符串数组转换成哈希对象， 其生成的hash对象的key为数组中的元素， value为1
     * @method listToMap
     * @warning 该方法在生成的hash对象中，会为每一个key同时生成一个另一个全大写的key。
     * @param { Array } arr 字符串数组
     * @return { Object } 转化之后的hash对象
     * @example
     * ```javascript
     *
     * //output: Object {UEdtior: 1, UEDTIOR: 1, Hello: 1, HELLO: 1}
     * console.log( UE.utils.listToMap( [ 'UEdtior', 'Hello' ] ) );
     *
     * ```
     */
    listToMap:function (list) {
        if (!list)return {};
        list = utils.isArray(list) ? list : list.split(',');
        for (var i = 0, ci, obj = {}; ci = list[i++];) {
            obj[ci.toUpperCase()] = obj[ci] = 1;
        }
        return obj;
    },

    /**
     * 将str中的html符号转义,将转义“'，&，<，"，>”五个字符
     * @method unhtml
     * @param { String } str 需要转义的字符串
     * @return { String } 转义后的字符串
     * @example
     * ```javascript
     * var html = '<body>&</body>';
     *
     * //output: &lt;body&gt;&amp;&lt;/body&gt;
     * console.log( UE.utils.unhtml( html ) );
     *
     * ```
     */
    unhtml:function (str, reg) {
        return str ? str.replace(reg || /[&<">'](?:(amp|lt|quot|gt|#39|nbsp|#\d+);)?/g, function (a, b) {
            if (b) {
                return a;
            } else {
                return {
                    '<':'&lt;',
                    '&':'&amp;',
                    '"':'&quot;',
                    '>':'&gt;',
                    "'":'&#39;'
                }[a]
            }

        }) : '';
    },
    /**
     * 将url中的html字符转义， 仅转义  ', ", <, > 四个字符
     * @param  { String } str 需要转义的字符串
     * @param  { RegExp } reg 自定义的正则
     * @return { String }     转义后的字符串
     */
    unhtmlForUrl:function (str, reg) {
        return str ? str.replace(reg || /[<">']/g, function (a) {
            return {
                '<':'&lt;',
                '&':'&amp;',
                '"':'&quot;',
                '>':'&gt;',
                "'":'&#39;'
            }[a]

        }) : '';
    },

    /**
     * 将str中的转义字符还原成html字符
     * @see UE.utils.unhtml(String);
     * @method html
     * @param { String } str 需要逆转义的字符串
     * @return { String } 逆转义后的字符串
     * @example
     * ```javascript
     *
     * var str = '&lt;body&gt;&amp;&lt;/body&gt;';
     *
     * //output: <body>&</body>
     * console.log( UE.utils.html( str ) );
     *
     * ```
     */
    html:function (str) {
        return str ? str.replace(/&((g|l|quo)t|amp|#39|nbsp);/g, function (m) {
            return {
                '&lt;':'<',
                '&amp;':'&',
                '&quot;':'"',
                '&gt;':'>',
                '&#39;':"'",
                '&nbsp;':' '
            }[m]
        }) : '';
    },

    /**
     * 将css样式转换为驼峰的形式
     * @method cssStyleToDomStyle
     * @param { String } cssName 需要转换的css样式名
     * @return { String } 转换成驼峰形式后的css样式名
     * @example
     * ```javascript
     *
     * var str = 'border-top';
     *
     * //output: borderTop
     * console.log( UE.utils.cssStyleToDomStyle( str ) );
     *
     * ```
     */
    cssStyleToDomStyle:function () {
        var test = document.createElement('div').style,
            cache = {
                'float':test.cssFloat != undefined ? 'cssFloat' : test.styleFloat != undefined ? 'styleFloat' : 'float'
            };

        return function (cssName) {
            return cache[cssName] || (cache[cssName] = cssName.toLowerCase().replace(/-./g, function (match) {
                return match.charAt(1).toUpperCase();
            }));
        };
    }(),

    /**
     * 动态加载文件到doc中
     * @method loadFile
     * @param { DomDocument } document 需要加载资源文件的文档对象
     * @param { Object } options 加载资源文件的属性集合， 取值请参考代码示例
     * @example
     * ```javascript
     *
     * UE.utils.loadFile( document, {
     *     src:"test.js",
     *     tag:"script",
     *     type:"text/javascript",
     *     defer:"defer"
     * } );
     *
     * ```
     */

    /**
     * 动态加载文件到doc中，加载成功后执行的回调函数fn
     * @method loadFile
     * @param { DomDocument } document 需要加载资源文件的文档对象
     * @param { Object } options 加载资源文件的属性集合， 该集合支持的值是script标签和style标签支持的所有属性。
     * @param { Function } fn 资源文件加载成功之后执行的回调
     * @warning 对于在同一个文档中多次加载同一URL的文件， 该方法会在第一次加载之后缓存该请求，
     *           在此之后的所有同一URL的请求， 将会直接触发回调。
     * @example
     * ```javascript
     *
     * UE.utils.loadFile( document, {
     *     src:"test.js",
     *     tag:"script",
     *     type:"text/javascript",
     *     defer:"defer"
     * }, function () {
     *     console.log('加载成功');
     * } );
     *
     * ```
     */
    loadFile:function () {
        var tmpList = [];

        function getItem(doc, obj) {
            try {
                for (var i = 0, ci; ci = tmpList[i++];) {
                    if (ci.doc === doc && ci.url == (obj.src || obj.href)) {
                        return ci;
                    }
                }
            } catch (e) {
                return null;
            }

        }

        return function (doc, obj, fn) {
            var item = getItem(doc, obj);
            if (item) {
                if (item.ready) {
                    fn && fn();
                } else {
                    item.funs.push(fn)
                }
                return;
            }
            tmpList.push({
                doc:doc,
                url:obj.src || obj.href,
                funs:[fn]
            });
            if (!doc.body) {
                var html = [];
                for (var p in obj) {
                    if (p == 'tag')continue;
                    html.push(p + '="' + obj[p] + '"')
                }
                doc.write('<' + obj.tag + ' ' + html.join(' ') + ' ></' + obj.tag + '>');
                return;
            }
            if (obj.id && doc.getElementById(obj.id)) {
                return;
            }
            var element = doc.createElement(obj.tag);
            delete obj.tag;
            for (var p in obj) {
                element.setAttribute(p, obj[p]);
            }
            element.onload = element.onreadystatechange = function () {
                if (!this.readyState || /loaded|complete/.test(this.readyState)) {
                    item = getItem(doc, obj);
                    if (item.funs.length > 0) {
                        item.ready = 1;
                        for (var fi; fi = item.funs.pop();) {
                            fi();
                        }
                    }
                    element.onload = element.onreadystatechange = null;
                }
            };
            element.onerror = function () {
                throw Error('The load ' + (obj.href || obj.src) + ' fails,check the url settings of file ueditor.config.js ')
            };
            doc.getElementsByTagName("head")[0].appendChild(element);
        }
    }(),

    /**
     * 判断obj对象是否为空
     * @method isEmptyObject
     * @param { * } obj 需要判断的对象
     * @remind 如果判断的对象是NULL， 将直接返回true， 如果是数组且为空， 返回true， 如果是字符串， 且字符串为空，
     *          返回true， 如果是普通对象， 且该对象没有任何实例属性， 返回true
     * @return { Boolean } 对象是否为空
     * @example
     * ```javascript
     *
     * //output: true
     * console.log( UE.utils.isEmptyObject( {} ) );
     *
     * //output: true
     * console.log( UE.utils.isEmptyObject( [] ) );
     *
     * //output: true
     * console.log( UE.utils.isEmptyObject( "" ) );
     *
     * //output: false
     * console.log( UE.utils.isEmptyObject( { key: 1 } ) );
     *
     * //output: false
     * console.log( UE.utils.isEmptyObject( [1] ) );
     *
     * //output: false
     * console.log( UE.utils.isEmptyObject( "1" ) );
     *
     * ```
     */
    isEmptyObject:function (obj) {
        if (obj == null) return true;
        if (this.isArray(obj) || this.isString(obj)) return obj.length === 0;
        for (var key in obj) if (obj.hasOwnProperty(key)) return false;
        return true;
    },

    /**
     * 把rgb格式的颜色值转换成16进制格式
     * @method fixColor
     * @param { String } rgb格式的颜色值
     * @param { String }
     * @example
     * rgb(255,255,255)  => "#ffffff"
     */
    fixColor:function (name, value) {
        if (/color/i.test(name) && /rgba?/.test(value)) {
            var array = value.split(",");
            if (array.length > 3)
                return "";
            value = "#";
            for (var i = 0, color; color = array[i++];) {
                color = parseInt(color.replace(/[^\d]/gi, ''), 10).toString(16);
                value += color.length == 1 ? "0" + color : color;
            }
            value = value.toUpperCase();
        }
        return  value;
    },
    /**
     * 只针对border,padding,margin做了处理，因为性能问题
     * @public
     * @function
     * @param {String}    val style字符串
     */
    optCss:function (val) {
        var padding, margin, border;
        val = val.replace(/(padding|margin|border)\-([^:]+):([^;]+);?/gi, function (str, key, name, val) {
            if (val.split(' ').length == 1) {
                switch (key) {
                    case 'padding':
                        !padding && (padding = {});
                        padding[name] = val;
                        return '';
                    case 'margin':
                        !margin && (margin = {});
                        margin[name] = val;
                        return '';
                    case 'border':
                        return val == 'initial' ? '' : str;
                }
            }
            return str;
        });

        function opt(obj, name) {
            if (!obj) {
                return '';
            }
            var t = obj.top , b = obj.bottom, l = obj.left, r = obj.right, val = '';
            if (!t || !l || !b || !r) {
                for (var p in obj) {
                    val += ';' + name + '-' + p + ':' + obj[p] + ';';
                }
            } else {
                val += ';' + name + ':' +
                    (t == b && b == l && l == r ? t :
                        t == b && l == r ? (t + ' ' + l) :
                            l == r ? (t + ' ' + l + ' ' + b) : (t + ' ' + r + ' ' + b + ' ' + l)) + ';'
            }
            return val;
        }

        val += opt(padding, 'padding') + opt(margin, 'margin');
        return val.replace(/^[ \n\r\t;]*|[ \n\r\t]*$/, '').replace(/;([ \n\r\t]+)|\1;/g, ';')
            .replace(/(&((l|g)t|quot|#39))?;{2,}/g, function (a, b) {
                return b ? b + ";;" : ';'
            });
    },

    /**
     * 克隆对象
     * @method clone
     * @param { Object } source 源对象
     * @return { Object } source的一个副本
     */

    /**
     * 深度克隆对象，将source的属性克隆到target对象， 会覆盖target重名的属性。
     * @method clone
     * @param { Object } source 源对象
     * @param { Object } target 目标对象
     * @return { Object } 附加了source对象所有属性的target对象
     */
    clone:function (source, target) {
        var tmp;
        target = target || {};
        for (var i in source) {
            if (source.hasOwnProperty(i)) {
                tmp = source[i];
                if (typeof tmp == 'object') {
                    target[i] = utils.isArray(tmp) ? [] : {};
                    utils.clone(source[i], target[i])
                } else {
                    target[i] = tmp;
                }
            }
        }
        return target;
    },

    /**
     * 把cm／pt为单位的值转换为px为单位的值
     * @method transUnitToPx
     * @param { String } 待转换的带单位的字符串
     * @return { String } 转换为px为计量单位的值的字符串
     * @example
     * ```javascript
     *
     * //output: 500px
     * console.log( UE.utils.transUnitToPx( '20cm' ) );
     *
     * //output: 27px
     * console.log( UE.utils.transUnitToPx( '20pt' ) );
     *
     * ```
     */
    transUnitToPx:function (val) {
        if (!/(pt|cm)/.test(val)) {
            return val
        }
        var unit;
        val.replace(/([\d.]+)(\w+)/, function (str, v, u) {
            val = v;
            unit = u;
        });
        switch (unit) {
            case 'cm':
                val = parseFloat(val) * 25;
                break;
            case 'pt':
                val = Math.round(parseFloat(val) * 96 / 72);
        }
        return val + (val ? 'px' : '');
    },

    /**
     * 在dom树ready之后执行给定的回调函数
     * @method domReady
     * @remind 如果在执行该方法的时候， dom树已经ready， 那么回调函数将立刻执行
     * @param { Function } fn dom树ready之后的回调函数
     * @example
     * ```javascript
     *
     * UE.utils.domReady( function () {
     *
     *     console.log('123');
     *
     * } );
     *
     * ```
     */
    domReady:function () {

        var fnArr = [];

        function doReady(doc) {
            //确保onready只执行一次
            doc.isReady = true;
            for (var ci; ci = fnArr.pop(); ci()) {
            }
        }

        return function (onready, win) {
            win = win || window;
            var doc = win.document;
            onready && fnArr.push(onready);
            if (doc.readyState === "complete") {
                doReady(doc);
            } else {
                doc.isReady && doReady(doc);
                if (browser.ie && browser.version != 11) {
                    (function () {
                        if (doc.isReady) return;
                        try {
                            doc.documentElement.doScroll("left");
                        } catch (error) {
                            setTimeout(arguments.callee, 0);
                            return;
                        }
                        doReady(doc);
                    })();
                    win.attachEvent('onload', function () {
                        doReady(doc)
                    });
                } else {
                    doc.addEventListener("DOMContentLoaded", function () {
                        doc.removeEventListener("DOMContentLoaded", arguments.callee, false);
                        doReady(doc);
                    }, false);
                    win.addEventListener('load', function () {
                        doReady(doc)
                    }, false);
                }
            }

        }
    }(),

    /**
     * 动态添加css样式
     * @method cssRule
     * @param { String } 节点名称
     * @grammar UE.utils.cssRule('添加的样式的节点名称',['样式'，'放到哪个document上'])
     * @grammar UE.utils.cssRule('body','body{background:#ccc}') => null  //给body添加背景颜色
     * @grammar UE.utils.cssRule('body') =>样式的字符串  //取得key值为body的样式的内容,如果没有找到key值先关的样式将返回空，例如刚才那个背景颜色，将返回 body{background:#ccc}
     * @grammar UE.utils.cssRule('body',document) => 返回指定key的样式，并且指定是哪个document
     * @grammar UE.utils.cssRule('body','') =>null //清空给定的key值的背景颜色
     */
    cssRule:browser.ie && browser.version != 11 ? function (key, style, doc) {
        var indexList, index;
        if(style === undefined || style && style.nodeType && style.nodeType == 9){
            //获取样式
            doc = style && style.nodeType && style.nodeType == 9 ? style : (doc || document);
            indexList = doc.indexList || (doc.indexList = {});
            index = indexList[key];
            if(index !==  undefined){
                return doc.styleSheets[index].cssText
            }
            return undefined;
        }
        doc = doc || document;
        indexList = doc.indexList || (doc.indexList = {});
        index = indexList[key];
        //清除样式
        if(style === ''){
            if(index!== undefined){
                doc.styleSheets[index].cssText = '';
                delete indexList[key];
                return true
            }
            return false;
        }

        //添加样式
        if(index!== undefined){
            sheetStyle =  doc.styleSheets[index];
        }else{
            sheetStyle = doc.createStyleSheet('', index = doc.styleSheets.length);
            indexList[key] = index;
        }
        sheetStyle.cssText = style;
    }: function (key, style, doc) {
        var head, node;
        if(style === undefined || style && style.nodeType && style.nodeType == 9){
            //获取样式
            doc = style && style.nodeType && style.nodeType == 9 ? style : (doc || document);
            node = doc.getElementById(key);
            return node ? node.innerHTML : undefined;
        }
        doc = doc || document;
        node = doc.getElementById(key);

        //清除样式
        if(style === ''){
            if(node){
                node.parentNode.removeChild(node);
                return true
            }
            return false;
        }

        //添加样式
        if(node){
            node.innerHTML = style;
        }else{
            node = doc.createElement('style');
            node.id = key;
            node.innerHTML = style;
            doc.getElementsByTagName('head')[0].appendChild(node);
        }
    },
    sort:function(array,compareFn){
        compareFn = compareFn || function(item1, item2){ return item1.localeCompare(item2);};
        for(var i= 0,len = array.length; i<len; i++){
            for(var j = i,length = array.length; j<length; j++){
                if(compareFn(array[i], array[j]) > 0){
                    var t = array[i];
                    array[i] = array[j];
                    array[j] = t;
                }
            }
        }
        return array;
    },
    serializeParam:function (json) {
        var strArr = [];
        for (var i in json) {
            //忽略默认的几个参数
            if(i=="method" || i=="timeout" || i=="async") continue;
            //传递过来的对象和函数不在提交之列
            if (!((typeof json[i]).toLowerCase() == "function" || (typeof json[i]).toLowerCase() == "object")) {
                strArr.push( encodeURIComponent(i) + "="+encodeURIComponent(json[i]) );
            } else if (utils.isArray(json[i])) {
                //支持传数组内容
                for(var j = 0; j < json[i].length; j++) {
                    strArr.push( encodeURIComponent(i) + "[]="+encodeURIComponent(json[i][j]) );
                }
            }
        }
        return strArr.join("&");
    },
    formatUrl:function (url) {
        var u = url.replace(/&&/g, '&');
        u = u.replace(/\?&/g, '?');
        u = u.replace(/&$/g, '');
        u = u.replace(/&#/g, '#');
        u = u.replace(/&+/g, '&');
        return u;
    },
    isCrossDomainUrl:function (url) {
        var a = document.createElement('a');
        a.href = url;
        if (browser.ie) {
            a.href = a.href;
        }
        return !(a.protocol == location.protocol && a.hostname == location.hostname &&
        (a.port == location.port || (a.port == '80' && location.port == '') || (a.port == '' && location.port == '80')));
    },
    clearEmptyAttrs : function(obj){
        for(var p in obj){
            if(obj[p] === ''){
                delete obj[p]
            }
        }
        return obj;
    },
    str2json : function(s){

        if (!utils.isString(s)) return null;
        if (window.JSON) {
            return JSON.parse(s);
        } else {
            return (new Function("return " + utils.trim(s || '')))();
        }

    },
    json2str : (function(){

        if (window.JSON) {

            return JSON.stringify;

        } else {

            var escapeMap = {
                "\b": '\\b',
                "\t": '\\t',
                "\n": '\\n',
                "\f": '\\f',
                "\r": '\\r',
                '"' : '\\"',
                "\\": '\\\\'
            };

            function encodeString(source) {
                if (/["\\\x00-\x1f]/.test(source)) {
                    source = source.replace(
                        /["\\\x00-\x1f]/g,
                        function (match) {
                            var c = escapeMap[match];
                            if (c) {
                                return c;
                            }
                            c = match.charCodeAt();
                            return "\\u00"
                            + Math.floor(c / 16).toString(16)
                            + (c % 16).toString(16);
                        });
                }
                return '"' + source + '"';
            }

            function encodeArray(source) {
                var result = ["["],
                    l = source.length,
                    preComma, i, item;

                for (i = 0; i < l; i++) {
                    item = source[i];

                    switch (typeof item) {
                        case "undefined":
                        case "function":
                        case "unknown":
                            break;
                        default:
                            if(preComma) {
                                result.push(',');
                            }
                            result.push(utils.json2str(item));
                            preComma = 1;
                    }
                }
                result.push("]");
                return result.join("");
            }

            function pad(source) {
                return source < 10 ? '0' + source : source;
            }

            function encodeDate(source){
                return '"' + source.getFullYear() + "-"
                + pad(source.getMonth() + 1) + "-"
                + pad(source.getDate()) + "T"
                + pad(source.getHours()) + ":"
                + pad(source.getMinutes()) + ":"
                + pad(source.getSeconds()) + '"';
            }

            return function (value) {
                switch (typeof value) {
                    case 'undefined':
                        return 'undefined';

                    case 'number':
                        return isFinite(value) ? String(value) : "null";

                    case 'string':
                        return encodeString(value);

                    case 'boolean':
                        return String(value);

                    default:
                        if (value === null) {
                            return 'null';
                        } else if (utils.isArray(value)) {
                            return encodeArray(value);
                        } else if (utils.isDate(value)) {
                            return encodeDate(value);
                        } else {
                            var result = ['{'],
                                encode = utils.json2str,
                                preComma,
                                item;

                            for (var key in value) {
                                if (Object.prototype.hasOwnProperty.call(value, key)) {
                                    item = value[key];
                                    switch (typeof item) {
                                        case 'undefined':
                                        case 'unknown':
                                        case 'function':
                                            break;
                                        default:
                                            if (preComma) {
                                                result.push(',');
                                            }
                                            preComma = 1;
                                            result.push(encode(key) + ':' + encode(item));
                                    }
                                }
                            }
                            result.push('}');
                            return result.join('');
                        }
                }
            };
        }

    })()

};
/**
 * 判断给定的对象是否是字符串
 * @method isString
 * @param { * } object 需要判断的对象
 * @return { Boolean } 给定的对象是否是字符串
 */

/**
 * 判断给定的对象是否是数组
 * @method isArray
 * @param { * } object 需要判断的对象
 * @return { Boolean } 给定的对象是否是数组
 */

/**
 * 判断给定的对象是否是一个Function
 * @method isFunction
 * @param { * } object 需要判断的对象
 * @return { Boolean } 给定的对象是否是Function
 */

/**
 * 判断给定的对象是否是Number
 * @method isNumber
 * @param { * } object 需要判断的对象
 * @return { Boolean } 给定的对象是否是Number
 */

/**
 * 判断给定的对象是否是一个正则表达式
 * @method isRegExp
 * @param { * } object 需要判断的对象
 * @return { Boolean } 给定的对象是否是正则表达式
 */

/**
 * 判断给定的对象是否是一个普通对象
 * @method isObject
 * @param { * } object 需要判断的对象
 * @return { Boolean } 给定的对象是否是普通对象
 */
utils.each(['String', 'Function', 'Array', 'Number', 'RegExp', 'Object', 'Date'], function (v) {
    UE.utils['is' + v] = function (obj) {
        return Object.prototype.toString.apply(obj) == '[object ' + v + ']';
    }
});


// core/EventBase.js
/**
 * UE采用的事件基类
 * @file
 * @module UE
 * @class EventBase
 * @since 1.2.6.1
 */

/**
 * UEditor公用空间，UEditor所有的功能都挂载在该空间下
 * @unfile
 * @module UE
 */

/**
 * UE采用的事件基类，继承此类的对应类将获取addListener,removeListener,fireEvent方法。
 * 在UE中，Editor以及所有ui实例都继承了该类，故可以在对应的ui对象以及editor对象上使用上述方法。
 * @unfile
 * @module UE
 * @class EventBase
 */

/**
 * 通过此构造器，子类可以继承EventBase获取事件监听的方法
 * @constructor
 * @example
 * ```javascript
 * UE.EventBase.call(editor);
 * ```
 */
var EventBase = UE.EventBase = function () {};

EventBase.prototype = {

    /**
     * 注册事件监听器
     * @method addListener
     * @param { String } types 监听的事件名称，同时监听多个事件使用空格分隔
     * @param { Function } fn 监听的事件被触发时，会执行该回调函数
     * @waining 事件被触发时，监听的函数假如返回的值恒等于true，回调函数的队列中后面的函数将不执行
     * @example
     * ```javascript
     * editor.addListener('selectionchange',function(){
     *      console.log("选区已经变化！");
     * })
     * editor.addListener('beforegetcontent aftergetcontent',function(type){
     *         if(type == 'beforegetcontent'){
     *             //do something
     *         }else{
     *             //do something
     *         }
     *         console.log(this.getContent) // this是注册的事件的编辑器实例
     * })
     * ```
     * @see UE.EventBase:fireEvent(String)
     */
    addListener:function (types, listener) {
        types = utils.trim(types).split(/\s+/);
        for (var i = 0, ti; ti = types[i++];) {
            getListener(this, ti, true).push(listener);
        }
    },

    on : function(types, listener){
      return this.addListener(types,listener);
    },
    off : function(types, listener){
        return this.removeListener(types, listener)
    },
    trigger:function(){
        return this.fireEvent.apply(this,arguments);
    },
    /**
     * 移除事件监听器
     * @method removeListener
     * @param { String } types 移除的事件名称，同时移除多个事件使用空格分隔
     * @param { Function } fn 移除监听事件的函数引用
     * @example
     * ```javascript
     * //changeCallback为方法体
     * editor.removeListener("selectionchange",changeCallback);
     * ```
     */
    removeListener:function (types, listener) {
        types = utils.trim(types).split(/\s+/);
        for (var i = 0, ti; ti = types[i++];) {
            utils.removeItem(getListener(this, ti) || [], listener);
        }
    },

    /**
     * 触发事件
     * @method fireEvent
     * @param { String } types 触发的事件名称，同时触发多个事件使用空格分隔
     * @remind 该方法会触发addListener
     * @return { * } 返回触发事件的队列中，最后执行的回调函数的返回值
     * @example
     * ```javascript
     * editor.fireEvent("selectionchange");
     * ```
     */

    /**
     * 触发事件
     * @method fireEvent
     * @param { String } types 触发的事件名称，同时触发多个事件使用空格分隔
     * @param { *... } options 可选参数，可以传入一个或多个参数，会传给事件触发的回调函数
     * @return { * } 返回触发事件的队列中，最后执行的回调函数的返回值
     * @example
     * ```javascript
     *
     * editor.addListener( "selectionchange", function ( type, arg1, arg2 ) {
     *
     *     console.log( arg1 + " " + arg2 );
     *
     * } );
     *
     * //触发selectionchange事件， 会执行上面的事件监听器
     * //output: Hello World
     * editor.fireEvent("selectionchange", "Hello", "World");
     * ```
     */
    fireEvent:function () {
        var types = arguments[0];
        types = utils.trim(types).split(' ');
        for (var i = 0, ti; ti = types[i++];) {
            var listeners = getListener(this, ti),
                r, t, k;
            if (listeners) {
                k = listeners.length;
                while (k--) {
                    if(!listeners[k])continue;
                    t = listeners[k].apply(this, arguments);
                    if(t === true){
                        return t;
                    }
                    if (t !== undefined) {
                        r = t;
                    }
                }
            }
            if (t = this['on' + ti.toLowerCase()]) {
                r = t.apply(this, arguments);
            }
        }
        return r;
    }
};
/**
 * 获得对象所拥有监听类型的所有监听器
 * @unfile
 * @module UE
 * @since 1.2.6.1
 * @method getListener
 * @public
 * @param { Object } obj  查询监听器的对象
 * @param { String } type 事件类型
 * @param { Boolean } force  为true且当前所有type类型的侦听器不存在时，创建一个空监听器数组
 * @return { Array } 监听器数组
 */
function getListener(obj, type, force) {
    var allListeners;
    type = type.toLowerCase();
    return ( ( allListeners = ( obj.__allListeners || force && ( obj.__allListeners = {} ) ) )
        && ( allListeners[type] || force && ( allListeners[type] = [] ) ) );
}



// core/dtd.js
///import editor.js
///import core/dom/dom.js
///import core/utils.js
/**
 * dtd html语义化的体现类
 * @constructor
 * @namespace dtd
 */
var dtd = dom.dtd = (function() {
    function _( s ) {
        for (var k in s) {
            s[k.toUpperCase()] = s[k];
        }
        return s;
    }
    var X = utils.extend2;
    var A = _({isindex:1,fieldset:1}),
        B = _({input:1,button:1,select:1,textarea:1,label:1}),
        C = X( _({a:1}), B ),
        D = X( {iframe:1}, C ),
        E = _({hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1}),
        F = _({ins:1,del:1,script:1,style:1}),
        G = X( _({b:1,acronym:1,bdo:1,'var':1,'#':1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1}), F ),
        H = X( _({sub:1,img:1,embed:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1}), G ),
        I = X( _({p:1}), H ),
        J = X( _({iframe:1}), H, B ),
        K = _({img:1,embed:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,'#':1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,'var':1,div:1,object:1,sup:1,strike:1,dir:1,map:1,dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1}),

        L = X( _({a:0}), J ),//a不能被切开，所以把他
        M = _({tr:1}),
        N = _({'#':1}),
        O = X( _({param:1}), K ),
        P = X( _({form:1}), A, D, E, I ),
        Q = _({li:1,ol:1,ul:1}),
        R = _({style:1,script:1}),
        S = _({base:1,link:1,meta:1,title:1}),
        T = X( S, R ),
        U = _({head:1,body:1}),
        V = _({html:1});

    var block = _({address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1}),

        empty =  _({area:1,base:1,basefont:1,br:1,col:1,command:1,dialog:1,embed:1,hr:1,img:1,input:1,isindex:1,keygen:1,link:1,meta:1,param:1,source:1,track:1,wbr:1});

    return  _({

        // $ 表示自定的属性

        // body外的元素列表.
        $nonBodyContent: X( V, U, S ),

        //块结构元素列表
        $block : block,

        //内联元素列表
        $inline : L,

        $inlineWithA : X(_({a:1}),L),

        $body : X( _({script:1,style:1}), block ),

        $cdata : _({script:1,style:1}),

        //自闭和元素
        $empty : empty,

        //不是自闭合，但不能让range选中里边
        $nonChild : _({iframe:1,textarea:1}),
        //列表元素列表
        $listItem : _({dd:1,dt:1,li:1}),

        //列表根元素列表
        $list: _({ul:1,ol:1,dl:1}),

        //不能认为是空的元素
        $isNotEmpty : _({table:1,ul:1,ol:1,dl:1,iframe:1,area:1,base:1,col:1,hr:1,img:1,embed:1,input:1,link:1,meta:1,param:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1}),

        //如果没有子节点就可以删除的元素列表，像span,a
        $removeEmpty : _({a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,'var':1}),

        $removeEmptyBlock : _({'p':1,'div':1}),

        //在table元素里的元素列表
        $tableContent : _({caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1,table:1}),
        //不转换的标签
        $notTransContent : _({pre:1,script:1,style:1,textarea:1}),
        html: U,
        head: T,
        style: N,
        script: N,
        body: P,
        base: {},
        link: {},
        meta: {},
        title: N,
        col : {},
        tr : _({td:1,th:1}),
        img : {},
        embed: {},
        colgroup : _({thead:1,col:1,tbody:1,tr:1,tfoot:1}),
        noscript : P,
        td : P,
        br : {},
        th : P,
        center : P,
        kbd : L,
        button : X( I, E ),
        basefont : {},
        h5 : L,
        h4 : L,
        samp : L,
        h6 : L,
        ol : Q,
        h1 : L,
        h3 : L,
        option : N,
        h2 : L,
        form : X( A, D, E, I ),
        select : _({optgroup:1,option:1}),
        font : L,
        ins : L,
        menu : Q,
        abbr : L,
        label : L,
        table : _({thead:1,col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1}),
        code : L,
        tfoot : M,
        cite : L,
        li : P,
        input : {},
        iframe : P,
        strong : L,
        textarea : N,
        noframes : P,
        big : L,
        small : L,
        //trace:
        span :_({'#':1,br:1,b:1,strong:1,u:1,i:1,em:1,sub:1,sup:1,strike:1,span:1}),
        hr : L,
        dt : L,
        sub : L,
        optgroup : _({option:1}),
        param : {},
        bdo : L,
        'var' : L,
        div : P,
        object : O,
        sup : L,
        dd : P,
        strike : L,
        area : {},
        dir : Q,
        map : X( _({area:1,form:1,p:1}), A, F, E ),
        applet : O,
        dl : _({dt:1,dd:1}),
        del : L,
        isindex : {},
        fieldset : X( _({legend:1}), K ),
        thead : M,
        ul : Q,
        acronym : L,
        b : L,
        a : X( _({a:1}), J ),
        blockquote :X(_({td:1,tr:1,tbody:1,li:1}),P),
        caption : L,
        i : L,
        u : L,
        tbody : M,
        s : L,
        address : X( D, I ),
        tt : L,
        legend : L,
        q : L,
        pre : X( G, C ),
        p : X(_({'a':1}),L),
        em :L,
        dfn : L
    });
})();


// core/domUtils.js
/**
 * Dom操作工具包
 * @file
 * @module UE.dom.domUtils
 * @since 1.2.6.1
 */

/**
 * Dom操作工具包
 * @unfile
 * @module UE.dom.domUtils
 */
function getDomNode(node, start, ltr, startFromChild, fn, guard) {
    var tmpNode = startFromChild && node[start],
        parent;
    !tmpNode && (tmpNode = node[ltr]);
    while (!tmpNode && (parent = (parent || node).parentNode)) {
        if (parent.tagName == 'BODY' || guard && !guard(parent)) {
            return null;
        }
        tmpNode = parent[ltr];
    }
    if (tmpNode && fn && !fn(tmpNode)) {
        return  getDomNode(tmpNode, start, ltr, false, fn);
    }
    return tmpNode;
}
var attrFix = ie && browser.version < 9 ? {
        tabindex:"tabIndex",
        readonly:"readOnly",
        "for":"htmlFor",
        "class":"className",
        maxlength:"maxLength",
        cellspacing:"cellSpacing",
        cellpadding:"cellPadding",
        rowspan:"rowSpan",
        colspan:"colSpan",
        usemap:"useMap",
        frameborder:"frameBorder"
    } : {
        tabindex:"tabIndex",
        readonly:"readOnly"
    },
    styleBlock = utils.listToMap([
        '-webkit-box', '-moz-box', 'block' ,
        'list-item' , 'table' , 'table-row-group' ,
        'table-header-group', 'table-footer-group' ,
        'table-row' , 'table-column-group' , 'table-column' ,
        'table-cell' , 'table-caption'
    ]);
var domUtils = dom.domUtils = {
    //节点常量
    NODE_ELEMENT:1,
    NODE_DOCUMENT:9,
    NODE_TEXT:3,
    NODE_COMMENT:8,
    NODE_DOCUMENT_FRAGMENT:11,

    //位置关系
    POSITION_IDENTICAL:0,
    POSITION_DISCONNECTED:1,
    POSITION_FOLLOWING:2,
    POSITION_PRECEDING:4,
    POSITION_IS_CONTAINED:8,
    POSITION_CONTAINS:16,
    //ie6使用其他的会有一段空白出现
    fillChar:ie && browser.version == '6' ? '\ufeff' : '\u200B',
    //-------------------------Node部分--------------------------------
    keys:{
        /*Backspace*/ 8:1, /*Delete*/ 46:1,
        /*Shift*/ 16:1, /*Ctrl*/ 17:1, /*Alt*/ 18:1,
        37:1, 38:1, 39:1, 40:1,
        13:1 /*enter*/
    },
    /**
     * 获取节点A相对于节点B的位置关系
     * @method getPosition
     * @param { Node } nodeA 需要查询位置关系的节点A
     * @param { Node } nodeB 需要查询位置关系的节点B
     * @return { Number } 节点A与节点B的关系
     * @example
     * ```javascript
     * //output: 20
     * var position = UE.dom.domUtils.getPosition( document.documentElement, document.body );
     *
     * switch ( position ) {
     *
     *      //0
     *      case UE.dom.domUtils.POSITION_IDENTICAL:
     *          console.log('元素相同');
     *          break;
     *      //1
     *      case UE.dom.domUtils.POSITION_DISCONNECTED:
     *          console.log('两个节点在不同的文档中');
     *          break;
     *      //2
     *      case UE.dom.domUtils.POSITION_FOLLOWING:
     *          console.log('节点A在节点B之后');
     *          break;
     *      //4
     *      case UE.dom.domUtils.POSITION_PRECEDING;
     *          console.log('节点A在节点B之前');
     *          break;
     *      //8
     *      case UE.dom.domUtils.POSITION_IS_CONTAINED:
     *          console.log('节点A被节点B包含');
     *          break;
     *      case 10:
     *          console.log('节点A被节点B包含且节点A在节点B之后');
     *          break;
     *      //16
     *      case UE.dom.domUtils.POSITION_CONTAINS:
     *          console.log('节点A包含节点B');
     *          break;
     *      case 20:
     *          console.log('节点A包含节点B且节点A在节点B之前');
     *          break;
     *
     * }
     * ```
     */
    getPosition:function (nodeA, nodeB) {
        // 如果两个节点是同一个节点
        if (nodeA === nodeB) {
            // domUtils.POSITION_IDENTICAL
            return 0;
        }
        var node,
            parentsA = [nodeA],
            parentsB = [nodeB];
        node = nodeA;
        while (node = node.parentNode) {
            // 如果nodeB是nodeA的祖先节点
            if (node === nodeB) {
                // domUtils.POSITION_IS_CONTAINED + domUtils.POSITION_FOLLOWING
                return 10;
            }
            parentsA.push(node);
        }
        node = nodeB;
        while (node = node.parentNode) {
            // 如果nodeA是nodeB的祖先节点
            if (node === nodeA) {
                // domUtils.POSITION_CONTAINS + domUtils.POSITION_PRECEDING
                return 20;
            }
            parentsB.push(node);
        }
        parentsA.reverse();
        parentsB.reverse();
        if (parentsA[0] !== parentsB[0]) {
            // domUtils.POSITION_DISCONNECTED
            return 1;
        }
        var i = -1;
        while (i++, parentsA[i] === parentsB[i]) {
        }
        nodeA = parentsA[i];
        nodeB = parentsB[i];
        while (nodeA = nodeA.nextSibling) {
            if (nodeA === nodeB) {
                // domUtils.POSITION_PRECEDING
                return 4
            }
        }
        // domUtils.POSITION_FOLLOWING
        return  2;
    },

    /**
     * 检测节点node在父节点中的索引位置
     * @method getNodeIndex
     * @param { Node } node 需要检测的节点对象
     * @return { Number } 该节点在父节点中的位置
     * @see UE.dom.domUtils.getNodeIndex(Node,Boolean)
     */

    /**
     * 检测节点node在父节点中的索引位置， 根据给定的mergeTextNode参数决定是否要合并多个连续的文本节点为一个节点
     * @method getNodeIndex
     * @param { Node } node 需要检测的节点对象
     * @param { Boolean } mergeTextNode 是否合并多个连续的文本节点为一个节点
     * @return { Number } 该节点在父节点中的位置
     * @example
     * ```javascript
     *
     *      var node = document.createElement("div");
     *
     *      node.appendChild( document.createTextNode( "hello" ) );
     *      node.appendChild( document.createTextNode( "world" ) );
     *      node.appendChild( node = document.createElement( "div" ) );
     *
     *      //output: 2
     *      console.log( UE.dom.domUtils.getNodeIndex( node ) );
     *
     *      //output: 1
     *      console.log( UE.dom.domUtils.getNodeIndex( node, true ) );
     *
     * ```
     */
    getNodeIndex:function (node, ignoreTextNode) {
        var preNode = node,
            i = 0;
        while (preNode = preNode.previousSibling) {
            if (ignoreTextNode && preNode.nodeType == 3) {
                if(preNode.nodeType != preNode.nextSibling.nodeType ){
                    i++;
                }
                continue;
            }
            i++;
        }
        return i;
    },

    /**
     * 检测节点node是否在给定的document对象上
     * @method inDoc
     * @param { Node } node 需要检测的节点对象
     * @param { DomDocument } doc 需要检测的document对象
     * @return { Boolean } 该节点node是否在给定的document的dom树上
     * @example
     * ```javascript
     *
     * var node = document.createElement("div");
     *
     * //output: false
     * console.log( UE.do.domUtils.inDoc( node, document ) );
     *
     * document.body.appendChild( node );
     *
     * //output: true
     * console.log( UE.do.domUtils.inDoc( node, document ) );
     *
     * ```
     */
    inDoc:function (node, doc) {
        return domUtils.getPosition(node, doc) == 10;
    },
    /**
     * 根据给定的过滤规则filterFn， 查找符合该过滤规则的node节点的第一个祖先节点，
     * 查找的起点是给定node节点的父节点。
     * @method findParent
     * @param { Node } node 需要查找的节点
     * @param { Function } filterFn 自定义的过滤方法。
     * @warning 查找的终点是到body节点为止
     * @remind 自定义的过滤方法filterFn接受一个Node对象作为参数， 该对象代表当前执行检测的祖先节点。 如果该
     *          节点满足过滤条件， 则要求返回true， 这时将直接返回该节点作为findParent()的结果， 否则， 请返回false。
     * @return { Node | Null } 如果找到符合过滤条件的节点， 就返回该节点， 否则返回NULL
     * @example
     * ```javascript
     * var filterNode = UE.dom.domUtils.findParent( document.body.firstChild, function ( node ) {
     *
     *     //由于查找的终点是body节点， 所以永远也不会匹配当前过滤器的条件， 即这里永远会返回false
     *     return node.tagName === "HTML";
     *
     * } );
     *
     * //output: true
     * console.log( filterNode === null );
     * ```
     */

    /**
     * 根据给定的过滤规则filterFn， 查找符合该过滤规则的node节点的第一个祖先节点，
     * 如果includeSelf的值为true，则查找的起点是给定的节点node， 否则， 起点是node的父节点
     * @method findParent
     * @param { Node } node 需要查找的节点
     * @param { Function } filterFn 自定义的过滤方法。
     * @param { Boolean } includeSelf 查找过程是否包含自身
     * @warning 查找的终点是到body节点为止
     * @remind 自定义的过滤方法filterFn接受一个Node对象作为参数， 该对象代表当前执行检测的祖先节点。 如果该
     *          节点满足过滤条件， 则要求返回true， 这时将直接返回该节点作为findParent()的结果， 否则， 请返回false。
     * @remind 如果includeSelf为true， 则过滤器第一次执行时的参数会是节点本身。
     *          反之， 过滤器第一次执行时的参数将是该节点的父节点。
     * @return { Node | Null } 如果找到符合过滤条件的节点， 就返回该节点， 否则返回NULL
     * @example
     * ```html
     * <body>
     *
     *      <div id="test">
     *      </div>
     *
     *      <script type="text/javascript">
     *
     *          //output: DIV, BODY
     *          var filterNode = UE.dom.domUtils.findParent( document.getElementById( "test" ), function ( node ) {
     *
     *              console.log( node.tagName );
     *              return false;
     *
     *          }, true );
     *
     *      </script>
     * </body>
     * ```
     */
    findParent:function (node, filterFn, includeSelf) {
        if (node && !domUtils.isBody(node)) {
            node = includeSelf ? node : node.parentNode;
            while (node) {
                if (!filterFn || filterFn(node) || domUtils.isBody(node)) {
                    return filterFn && !filterFn(node) && domUtils.isBody(node) ? null : node;
                }
                node = node.parentNode;
            }
        }
        return null;
    },
    /**
     * 查找node的节点名为tagName的第一个祖先节点， 查找的起点是node节点的父节点。
     * @method findParentByTagName
     * @param { Node } node 需要查找的节点对象
     * @param { Array } tagNames 需要查找的父节点的名称数组
     * @warning 查找的终点是到body节点为止
     * @return { Node | NULL } 如果找到符合条件的节点， 则返回该节点， 否则返回NULL
     * @example
     * ```javascript
     * var node = UE.dom.domUtils.findParentByTagName( document.getElementsByTagName("div")[0], [ "BODY" ] );
     * //output: BODY
     * console.log( node.tagName );
     * ```
     */

    /**
     * 查找node的节点名为tagName的祖先节点， 如果includeSelf的值为true，则查找的起点是给定的节点node，
     * 否则， 起点是node的父节点。
     * @method findParentByTagName
     * @param { Node } node 需要查找的节点对象
     * @param { Array } tagNames 需要查找的父节点的名称数组
     * @param { Boolean } includeSelf 查找过程是否包含node节点自身
     * @warning 查找的终点是到body节点为止
     * @return { Node | NULL } 如果找到符合条件的节点， 则返回该节点， 否则返回NULL
     * @example
     * ```javascript
     * var queryTarget = document.getElementsByTagName("div")[0];
     * var node = UE.dom.domUtils.findParentByTagName( queryTarget, [ "DIV" ], true );
     * //output: true
     * console.log( queryTarget === node );
     * ```
     */
    findParentByTagName:function (node, tagNames, includeSelf, excludeFn) {
        tagNames = utils.listToMap(utils.isArray(tagNames) ? tagNames : [tagNames]);
        return domUtils.findParent(node, function (node) {
            return tagNames[node.tagName] && !(excludeFn && excludeFn(node));
        }, includeSelf);
    },
    /**
     * 查找节点node的祖先节点集合， 查找的起点是给定节点的父节点，结果集中不包含给定的节点。
     * @method findParents
     * @param { Node } node 需要查找的节点对象
     * @return { Array } 给定节点的祖先节点数组
     * @grammar UE.dom.domUtils.findParents(node)  => Array  //返回一个祖先节点数组集合，不包含自身
     * @grammar UE.dom.domUtils.findParents(node,includeSelf)  => Array  //返回一个祖先节点数组集合，includeSelf指定是否包含自身
     * @grammar UE.dom.domUtils.findParents(node,includeSelf,filterFn)  => Array  //返回一个祖先节点数组集合，filterFn指定过滤条件，返回true的node将被选取
     * @grammar UE.dom.domUtils.findParents(node,includeSelf,filterFn,closerFirst)  => Array  //返回一个祖先节点数组集合，closerFirst为true的话，node的直接父亲节点是数组的第0个
     */

    /**
     * 查找节点node的祖先节点集合， 如果includeSelf的值为true，
     * 则返回的结果集中允许出现当前给定的节点， 否则， 该节点不会出现在其结果集中。
     * @method findParents
     * @param { Node } node 需要查找的节点对象
     * @param { Boolean } includeSelf 查找的结果中是否允许包含当前查找的节点对象
     * @return { Array } 给定节点的祖先节点数组
     */
    findParents:function (node, includeSelf, filterFn, closerFirst) {
        var parents = includeSelf && ( filterFn && filterFn(node) || !filterFn ) ? [node] : [];
        while (node = domUtils.findParent(node, filterFn)) {
            parents.push(node);
        }
        return closerFirst ? parents : parents.reverse();
    },

    /**
     * 在节点node后面插入新节点newNode
     * @method insertAfter
     * @param { Node } node 目标节点
     * @param { Node } newNode 新插入的节点， 该节点将置于目标节点之后
     * @return { Node } 新插入的节点
     */
    insertAfter:function (node, newNode) {
        return node.nextSibling ? node.parentNode.insertBefore(newNode, node.nextSibling):
            node.parentNode.appendChild(newNode);
    },

    /**
     * 删除节点node及其下属的所有节点
     * @method remove
     * @param { Node } node 需要删除的节点对象
     * @return { Node } 返回刚删除的节点对象
     * @example
     * ```html
     * <div id="test">
     *     <div id="child">你好</div>
     * </div>
     * <script>
     *     UE.dom.domUtils.remove( document.body, false );
     *     //output: false
     *     console.log( document.getElementById( "child" ) !== null );
     * </script>
     * ```
     */

    /**
     * 删除节点node，并根据keepChildren的值决定是否保留子节点
     * @method remove
     * @param { Node } node 需要删除的节点对象
     * @param { Boolean } keepChildren 是否需要保留子节点
     * @return { Node } 返回刚删除的节点对象
     * @example
     * ```html
     * <div id="test">
     *     <div id="child">你好</div>
     * </div>
     * <script>
     *     UE.dom.domUtils.remove( document.body, true );
     *     //output: true
     *     console.log( document.getElementById( "child" ) !== null );
     * </script>
     * ```
     */
    remove:function (node, keepChildren) {
        var parent = node.parentNode,
            child;
        if (parent) {
            if (keepChildren && node.hasChildNodes()) {
                while (child = node.firstChild) {
                    parent.insertBefore(child, node);
                }
            }
            parent.removeChild(node);
        }
        return node;
    },

    /**
     * 取得node节点的下一个兄弟节点， 如果该节点其后没有兄弟节点， 则递归查找其父节点之后的第一个兄弟节点，
     * 直到找到满足条件的节点或者递归到BODY节点之后才会结束。
     * @method getNextDomNode
     * @param { Node } node 需要获取其后的兄弟节点的节点对象
     * @return { Node | NULL } 如果找满足条件的节点， 则返回该节点， 否则返回NULL
     * @example
     * ```html
     *     <body>
     *      <div id="test">
     *          <span></span>
     *      </div>
     *      <i>xxx</i>
     * </body>
     * <script>
     *
     *     //output: i节点
     *     console.log( UE.dom.domUtils.getNextDomNode( document.getElementById( "test" ) ) );
     *
     * </script>
     * ```
     * @example
     * ```html
     * <body>
     *      <div>
     *          <span></span>
     *          <i id="test">xxx</i>
     *      </div>
     *      <b>xxx</b>
     * </body>
     * <script>
     *
     *     //由于id为test的i节点之后没有兄弟节点， 则查找其父节点（div）后面的兄弟节点
     *     //output: b节点
     *     console.log( UE.dom.domUtils.getNextDomNode( document.getElementById( "test" ) ) );
     *
     * </script>
     * ```
     */

    /**
     * 取得node节点的下一个兄弟节点， 如果startFromChild的值为ture，则先获取其子节点，
     * 如果有子节点则直接返回第一个子节点；如果没有子节点或者startFromChild的值为false，
     * 则执行<a href="#UE.dom.domUtils.getNextDomNode(Node)">getNextDomNode(Node node)</a>的查找过程。
     * @method getNextDomNode
     * @param { Node } node 需要获取其后的兄弟节点的节点对象
     * @param { Boolean } startFromChild 查找过程是否从其子节点开始
     * @return { Node | NULL } 如果找满足条件的节点， 则返回该节点， 否则返回NULL
     * @see UE.dom.domUtils.getNextDomNode(Node)
     */
    getNextDomNode:function (node, startFromChild, filterFn, guard) {
        return getDomNode(node, 'firstChild', 'nextSibling', startFromChild, filterFn, guard);
    },
    getPreDomNode:function (node, startFromChild, filterFn, guard) {
        return getDomNode(node, 'lastChild', 'previousSibling', startFromChild, filterFn, guard);
    },
    /**
     * 检测节点node是否属是UEditor定义的bookmark节点
     * @method isBookmarkNode
     * @private
     * @param { Node } node 需要检测的节点对象
     * @return { Boolean } 是否是bookmark节点
     * @example
     * ```html
     * <span id="_baidu_bookmark_1"></span>
     * <script>
     *      var bookmarkNode = document.getElementById("_baidu_bookmark_1");
     *      //output: true
     *      console.log( UE.dom.domUtils.isBookmarkNode( bookmarkNode ) );
     * </script>
     * ```
     */
    isBookmarkNode:function (node) {
        return node.nodeType == 1 && node.id && /^_baidu_bookmark_/i.test(node.id);
    },
    /**
     * 获取节点node所属的window对象
     * @method  getWindow
     * @param { Node } node 节点对象
     * @return { Window } 当前节点所属的window对象
     * @example
     * ```javascript
     * //output: true
     * console.log( UE.dom.domUtils.getWindow( document.body ) === window );
     * ```
     */
    getWindow:function (node) {
        var doc = node.ownerDocument || node;
        return doc.defaultView || doc.parentWindow;
    },
    /**
     * 获取离nodeA与nodeB最近的公共的祖先节点
     * @method  getCommonAncestor
     * @param { Node } nodeA 第一个节点
     * @param { Node } nodeB 第二个节点
     * @remind 如果给定的两个节点是同一个节点， 将直接返回该节点。
     * @return { Node | NULL } 如果未找到公共节点， 返回NULL， 否则返回最近的公共祖先节点。
     * @example
     * ```javascript
     * var commonAncestor = UE.dom.domUtils.getCommonAncestor( document.body, document.body.firstChild );
     * //output: true
     * console.log( commonAncestor.tagName.toLowerCase() === 'body' );
     * ```
     */
    getCommonAncestor:function (nodeA, nodeB) {
        if (nodeA === nodeB)
            return nodeA;
        var parentsA = [nodeA] , parentsB = [nodeB], parent = nodeA, i = -1;
        while (parent = parent.parentNode) {
            if (parent === nodeB) {
                return parent;
            }
            parentsA.push(parent);
        }
        parent = nodeB;
        while (parent = parent.parentNode) {
            if (parent === nodeA)
                return parent;
            parentsB.push(parent);
        }
        parentsA.reverse();
        parentsB.reverse();
        while (i++, parentsA[i] === parentsB[i]) {
        }
        return i == 0 ? null : parentsA[i - 1];

    },
    /**
     * 清除node节点左右连续为空的兄弟inline节点
     * @method clearEmptySibling
     * @param { Node } node 执行的节点对象， 如果该节点的左右连续的兄弟节点是空的inline节点，
     * 则这些兄弟节点将被删除
     * @grammar UE.dom.domUtils.clearEmptySibling(node,ignoreNext)  //ignoreNext指定是否忽略右边空节点
     * @grammar UE.dom.domUtils.clearEmptySibling(node,ignoreNext,ignorePre)  //ignorePre指定是否忽略左边空节点
     * @example
     * ```html
     * <body>
     *     <div></div>
     *     <span id="test"></span>
     *     <i></i>
     *     <b></b>
     *     <em>xxx</em>
     *     <span></span>
     * </body>
     * <script>
     *
     *      UE.dom.domUtils.clearEmptySibling( document.getElementById( "test" ) );
     *
     *      //output: <div></div><span id="test"></span><em>xxx</em><span></span>
     *      console.log( document.body.innerHTML );
     *
     * </script>
     * ```
     */

    /**
     * 清除node节点左右连续为空的兄弟inline节点， 如果ignoreNext的值为true，
     * 则忽略对右边兄弟节点的操作。
     * @method clearEmptySibling
     * @param { Node } node 执行的节点对象， 如果该节点的左右连续的兄弟节点是空的inline节点，
     * @param { Boolean } ignoreNext 是否忽略忽略对右边的兄弟节点的操作
     * 则这些兄弟节点将被删除
     * @see UE.dom.domUtils.clearEmptySibling(Node)
     */

    /**
     * 清除node节点左右连续为空的兄弟inline节点， 如果ignoreNext的值为true，
     * 则忽略对右边兄弟节点的操作， 如果ignorePre的值为true，则忽略对左边兄弟节点的操作。
     * @method clearEmptySibling
     * @param { Node } node 执行的节点对象， 如果该节点的左右连续的兄弟节点是空的inline节点，
     * @param { Boolean } ignoreNext 是否忽略忽略对右边的兄弟节点的操作
     * @param { Boolean } ignorePre 是否忽略忽略对左边的兄弟节点的操作
     * 则这些兄弟节点将被删除
     * @see UE.dom.domUtils.clearEmptySibling(Node)
     */
    clearEmptySibling:function (node, ignoreNext, ignorePre) {
        function clear(next, dir) {
            var tmpNode;
            while (next && !domUtils.isBookmarkNode(next) && (domUtils.isEmptyInlineElement(next)
                //这里不能把空格算进来会吧空格干掉，出现文字间的空格丢掉了
                || !new RegExp('[^\t\n\r' + domUtils.fillChar + ']').test(next.nodeValue) )) {
                tmpNode = next[dir];
                domUtils.remove(next);
                next = tmpNode;
            }
        }
        !ignoreNext && clear(node.nextSibling, 'nextSibling');
        !ignorePre && clear(node.previousSibling, 'previousSibling');
    },
    /**
     * 将一个文本节点textNode拆分成两个文本节点，offset指定拆分位置
     * @method split
     * @param { Node } textNode 需要拆分的文本节点对象
     * @param { int } offset 需要拆分的位置， 位置计算从0开始
     * @return { Node } 拆分后形成的新节点
     * @example
     * ```html
     * <div id="test">abcdef</div>
     * <script>
     *      var newNode = UE.dom.domUtils.split( document.getElementById( "test" ).firstChild, 3 );
     *      //output: def
     *      console.log( newNode.nodeValue );
     * </script>
     * ```
     */
    split:function (node, offset) {
        var doc = node.ownerDocument;
        if (browser.ie && offset == node.nodeValue.length) {
            var next = doc.createTextNode('');
            return domUtils.insertAfter(node, next);
        }
        var retval = node.splitText(offset);
        //ie8下splitText不会跟新childNodes,我们手动触发他的更新
        if (browser.ie8) {
            var tmpNode = doc.createTextNode('');
            domUtils.insertAfter(retval, tmpNode);
            domUtils.remove(tmpNode);
        }
        return retval;
    },

    /**
     * 检测文本节点textNode是否为空节点（包括空格、换行、占位符等字符）
     * @method  isWhitespace
     * @param { Node } node 需要检测的节点对象
     * @return { Boolean } 检测的节点是否为空
     * @example
     * ```html
     * <div id="test">
     *
     * </div>
     * <script>
     *      //output: true
     *      console.log( UE.dom.domUtils.isWhitespace( document.getElementById("test").firstChild ) );
     * </script>
     * ```
     */
    isWhitespace:function (node) {
        return !new RegExp('[^ \t\n\r' + domUtils.fillChar + ']').test(node.nodeValue);
    },
    /**
     * 获取元素element相对于viewport的位置坐标
     * @method getXY
     * @param { Node } element 需要计算位置的节点对象
     * @return { Object } 返回形如{x:left,y:top}的一个key-value映射对象， 其中键x代表水平偏移距离，
     *                          y代表垂直偏移距离。
     *
     * @example
     * ```javascript
     * var location = UE.dom.domUtils.getXY( document.getElementById("test") );
     * //output: test的坐标为: 12, 24
     * console.log( 'test的坐标为： ', location.x, ',', location.y );
     * ```
     */
    getXY:function (element) {
        var x = 0, y = 0;
        while (element.offsetParent) {
            y += element.offsetTop;
            x += element.offsetLeft;
            element = element.offsetParent;
        }
        return { 'x':x, 'y':y};
    },
    /**
     * 为元素element绑定原生DOM事件，type为事件类型，handler为处理函数
     * @method on
     * @param { Node } element 需要绑定事件的节点对象
     * @param { String } type 绑定的事件类型
     * @param { Function } handler 事件处理器
     * @example
     * ```javascript
     * UE.dom.domUtils.on(document.body,"click",function(e){
     *     //e为事件对象，this为被点击元素对戏那个
     * });
     * ```
     */

    /**
     * 为元素element绑定原生DOM事件，type为事件类型，handler为处理函数
     * @method on
     * @param { Node } element 需要绑定事件的节点对象
     * @param { Array } type 绑定的事件类型数组
     * @param { Function } handler 事件处理器
     * @example
     * ```javascript
     * UE.dom.domUtils.on(document.body,["click","mousedown"],function(evt){
     *     //evt为事件对象，this为被点击元素对象
     * });
     * ```
     */
    on:function (element, type, handler) {

        var types = utils.isArray(type) ? type : utils.trim(type).split(/\s+/),
            k = types.length;
        if (k) while (k--) {
            type = types[k];
            if (element.addEventListener) {
                element.addEventListener(type, handler, false);
            } else {
                if (!handler._d) {
                    handler._d = {
                        els : []
                    };
                }
                var key = type + handler.toString(),index = utils.indexOf(handler._d.els,element);
                if (!handler._d[key] || index == -1) {
                    if(index == -1){
                        handler._d.els.push(element);
                    }
                    if(!handler._d[key]){
                        handler._d[key] = function (evt) {
                            return handler.call(evt.srcElement, evt || window.event);
                        };
                    }


                    element.attachEvent('on' + type, handler._d[key]);
                }
            }
        }
        element = null;
    },
    /**
     * 解除DOM事件绑定
     * @method un
     * @param { Node } element 需要解除事件绑定的节点对象
     * @param { String } type 需要接触绑定的事件类型
     * @param { Function } handler 对应的事件处理器
     * @example
     * ```javascript
     * UE.dom.domUtils.un(document.body,"click",function(evt){
     *     //evt为事件对象，this为被点击元素对象
     * });
     * ```
     */

    /**
     * 解除DOM事件绑定
     * @method un
     * @param { Node } element 需要解除事件绑定的节点对象
     * @param { Array } type 需要接触绑定的事件类型数组
     * @param { Function } handler 对应的事件处理器
     * @example
     * ```javascript
     * UE.dom.domUtils.un(document.body, ["click","mousedown"],function(evt){
     *     //evt为事件对象，this为被点击元素对象
     * });
     * ```
     */
    un:function (element, type, handler) {
        var types = utils.isArray(type) ? type : utils.trim(type).split(/\s+/),
            k = types.length;
        if (k) while (k--) {
            type = types[k];
            if (element.removeEventListener) {
                element.removeEventListener(type, handler, false);
            } else {
                var key = type + handler.toString();
                try{
                    element.detachEvent('on' + type, handler._d ? handler._d[key] : handler);
                }catch(e){}
                if (handler._d && handler._d[key]) {
                    var index = utils.indexOf(handler._d.els,element);
                    if(index!=-1){
                        handler._d.els.splice(index,1);
                    }
                    handler._d.els.length == 0 && delete handler._d[key];
                }
            }
        }
    },

    /**
     * 比较节点nodeA与节点nodeB是否具有相同的标签名、属性名以及属性值
     * @method  isSameElement
     * @param { Node } nodeA 需要比较的节点
     * @param { Node } nodeB 需要比较的节点
     * @return { Boolean } 两个节点是否具有相同的标签名、属性名以及属性值
     * @example
     * ```html
     * <span style="font-size:12px">ssss</span>
     * <span style="font-size:12px">bbbbb</span>
     * <span style="font-size:13px">ssss</span>
     * <span style="font-size:14px">bbbbb</span>
     *
     * <script>
     *
     *     var nodes = document.getElementsByTagName( "span" );
     *
     *     //output: true
     *     console.log( UE.dom.domUtils.isSameElement( nodes[0], nodes[1] ) );
     *
     *     //output: false
     *     console.log( UE.dom.domUtils.isSameElement( nodes[2], nodes[3] ) );
     *
     * </script>
     * ```
     */
    isSameElement:function (nodeA, nodeB) {
        if (nodeA.tagName != nodeB.tagName) {
            return false;
        }
        var thisAttrs = nodeA.attributes,
            otherAttrs = nodeB.attributes;
        if (!ie && thisAttrs.length != otherAttrs.length) {
            return false;
        }
        var attrA, attrB, al = 0, bl = 0;
        for (var i = 0; attrA = thisAttrs[i++];) {
            if (attrA.nodeName == 'style') {
                if (attrA.specified) {
                    al++;
                }
                if (domUtils.isSameStyle(nodeA, nodeB)) {
                    continue;
                } else {
                    return false;
                }
            }
            if (ie) {
                if (attrA.specified) {
                    al++;
                    attrB = otherAttrs.getNamedItem(attrA.nodeName);
                } else {
                    continue;
                }
            } else {
                attrB = nodeB.attributes[attrA.nodeName];
            }
            if (!attrB.specified || attrA.nodeValue != attrB.nodeValue) {
                return false;
            }
        }
        // 有可能attrB的属性包含了attrA的属性之外还有自己的属性
        if (ie) {
            for (i = 0; attrB = otherAttrs[i++];) {
                if (attrB.specified) {
                    bl++;
                }
            }
            if (al != bl) {
                return false;
            }
        }
        return true;
    },

    /**
     * 判断节点nodeA与节点nodeB的元素的style属性是否一致
     * @method isSameStyle
     * @param { Node } nodeA 需要比较的节点
     * @param { Node } nodeB 需要比较的节点
     * @return { Boolean } 两个节点是否具有相同的style属性值
     * @example
     * ```html
     * <span style="font-size:12px">ssss</span>
     * <span style="font-size:12px">bbbbb</span>
     * <span style="font-size:13px">ssss</span>
     * <span style="font-size:14px">bbbbb</span>
     *
     * <script>
     *
     *     var nodes = document.getElementsByTagName( "span" );
     *
     *     //output: true
     *     console.log( UE.dom.domUtils.isSameStyle( nodes[0], nodes[1] ) );
     *
     *     //output: false
     *     console.log( UE.dom.domUtils.isSameStyle( nodes[2], nodes[3] ) );
     *
     * </script>
     * ```
     */
    isSameStyle:function (nodeA, nodeB) {
        var styleA = nodeA.style.cssText.replace(/( ?; ?)/g, ';').replace(/( ?: ?)/g, ':'),
            styleB = nodeB.style.cssText.replace(/( ?; ?)/g, ';').replace(/( ?: ?)/g, ':');
        if (browser.opera) {
            styleA = nodeA.style;
            styleB = nodeB.style;
            if (styleA.length != styleB.length)
                return false;
            for (var p in styleA) {
                if (/^(\d+|csstext)$/i.test(p)) {
                    continue;
                }
                if (styleA[p] != styleB[p]) {
                    return false;
                }
            }
            return true;
        }
        if (!styleA || !styleB) {
            return styleA == styleB;
        }
        styleA = styleA.split(';');
        styleB = styleB.split(';');
        if (styleA.length != styleB.length) {
            return false;
        }
        for (var i = 0, ci; ci = styleA[i++];) {
            if (utils.indexOf(styleB, ci) == -1) {
                return false;
            }
        }
        return true;
    },
    /**
     * 检查节点node是否为block元素
     * @method isBlockElm
     * @param { Node } node 需要检测的节点对象
     * @return { Boolean } 是否是block元素节点
     * @warning 该方法的判断规则如下： 如果该元素原本是block元素， 则不论该元素当前的css样式是什么都会返回true；
     *          否则，检测该元素的css样式， 如果该元素当前是block元素， 则返回true。 其余情况下都返回false。
     * @example
     * ```html
     * <span id="test1" style="display: block"></span>
     * <span id="test2"></span>
     * <div id="test3" style="display: inline"></div>
     *
     * <script>
     *
     *     //output: true
     *     console.log( UE.dom.domUtils.isBlockElm( document.getElementById("test1") ) );
     *
     *     //output: false
     *     console.log( UE.dom.domUtils.isBlockElm( document.getElementById("test2") ) );
     *
     *     //output: true
     *     console.log( UE.dom.domUtils.isBlockElm( document.getElementById("test3") ) );
     *
     * </script>
     * ```
     */
    isBlockElm:function (node) {
        return node.nodeType == 1 && (dtd.$block[node.tagName] || styleBlock[domUtils.getComputedStyle(node, 'display')]) && !dtd.$nonChild[node.tagName];
    },
    /**
     * 检测node节点是否为body节点
     * @method isBody
     * @param { Element } node 需要检测的dom元素
     * @return { Boolean } 给定的元素是否是body元素
     * @example
     * ```javascript
     * //output: true
     * console.log( UE.dom.domUtils.isBody( document.body ) );
     * ```
     */
    isBody:function (node) {
        return  node && node.nodeType == 1 && node.tagName.toLowerCase() == 'body';
    },
    /**
     * 以node节点为分界，将该节点的指定祖先节点parent拆分成两个独立的节点，
     * 拆分形成的两个节点之间是node节点
     * @method breakParent
     * @param { Node } node 作为分界的节点对象
     * @param { Node } parent 该节点必须是node节点的祖先节点， 且是block节点。
     * @return { Node } 给定的node分界节点
     * @example
     * ```javascript
     *
     *      var node = document.createElement("span"),
     *          wrapNode = document.createElement( "div" ),
     *          parent = document.createElement("p");
     *
     *      parent.appendChild( node );
     *      wrapNode.appendChild( parent );
     *
     *      //拆分前
     *      //output: <p><span></span></p>
     *      console.log( wrapNode.innerHTML );
     *
     *
     *      UE.dom.domUtils.breakParent( node, parent );
     *      //拆分后
     *      //output: <p></p><span></span><p></p>
     *      console.log( wrapNode.innerHTML );
     *
     * ```
     */
    breakParent:function (node, parent) {
        var tmpNode,
            parentClone = node,
            clone = node,
            leftNodes,
            rightNodes;
        do {
            parentClone = parentClone.parentNode;
            if (leftNodes) {
                tmpNode = parentClone.cloneNode(false);
                tmpNode.appendChild(leftNodes);
                leftNodes = tmpNode;
                tmpNode = parentClone.cloneNode(false);
                tmpNode.appendChild(rightNodes);
                rightNodes = tmpNode;
            } else {
                leftNodes = parentClone.cloneNode(false);
                rightNodes = leftNodes.cloneNode(false);
            }
            while (tmpNode = clone.previousSibling) {
                leftNodes.insertBefore(tmpNode, leftNodes.firstChild);
            }
            while (tmpNode = clone.nextSibling) {
                rightNodes.appendChild(tmpNode);
            }
            clone = parentClone;
        } while (parent !== parentClone);
        tmpNode = parent.parentNode;
        tmpNode.insertBefore(leftNodes, parent);
        tmpNode.insertBefore(rightNodes, parent);
        tmpNode.insertBefore(node, rightNodes);
        domUtils.remove(parent);
        return node;
    },
    /**
     * 检查节点node是否是空inline节点
     * @method  isEmptyInlineElement
     * @param { Node } node 需要检测的节点对象
     * @return { Number }  如果给定的节点是空的inline节点， 则返回1, 否则返回0。
     * @example
     * ```html
     * <b><i></i></b> => 1
     * <b><i></i><u></u></b> => 1
     * <b></b> => 1
     * <b>xx<i></i></b> => 0
     * ```
     */
    isEmptyInlineElement:function (node) {
        if (node.nodeType != 1 || !dtd.$removeEmpty[ node.tagName ]) {
            return 0;
        }
        node = node.firstChild;
        while (node) {
            //如果是创建的bookmark就跳过
            if (domUtils.isBookmarkNode(node)) {
                return 0;
            }
            if (node.nodeType == 1 && !domUtils.isEmptyInlineElement(node) ||
                node.nodeType == 3 && !domUtils.isWhitespace(node)
                ) {
                return 0;
            }
            node = node.nextSibling;
        }
        return 1;

    },

    /**
     * 删除node节点下首尾两端的空白文本子节点
     * @method trimWhiteTextNode
     * @param { Element } node 需要执行删除操作的元素对象
     * @example
     * ```javascript
     *      var node = document.createElement("div");
     *
     *      node.appendChild( document.createTextNode( "" ) );
     *
     *      node.appendChild( document.createElement("div") );
     *
     *      node.appendChild( document.createTextNode( "" ) );
     *
     *      //3
     *      console.log( node.childNodes.length );
     *
     *      UE.dom.domUtils.trimWhiteTextNode( node );
     *
     *      //1
     *      console.log( node.childNodes.length );
     * ```
     */
    trimWhiteTextNode:function (node) {
        function remove(dir) {
            var child;
            while ((child = node[dir]) && child.nodeType == 3 && domUtils.isWhitespace(child)) {
                node.removeChild(child);
            }
        }
        remove('firstChild');
        remove('lastChild');
    },

    /**
     * 合并node节点下相同的子节点
     * @name mergeChild
     * @desc
     * UE.dom.domUtils.mergeChild(node,tagName) //tagName要合并的子节点的标签
     * @example
     * <p><span style="font-size:12px;">xx<span style="font-size:12px;">aa</span>xx</span></p>
     * ==> UE.dom.domUtils.mergeChild(node,'span')
     * <p><span style="font-size:12px;">xxaaxx</span></p>
     */
    mergeChild:function (node, tagName, attrs) {
        var list = domUtils.getElementsByTagName(node, node.tagName.toLowerCase());
        for (var i = 0, ci; ci = list[i++];) {
            if (!ci.parentNode || domUtils.isBookmarkNode(ci)) {
                continue;
            }
            //span单独处理
            if (ci.tagName.toLowerCase() == 'span') {
                if (node === ci.parentNode) {
                    domUtils.trimWhiteTextNode(node);
                    if (node.childNodes.length == 1) {
                        node.style.cssText = ci.style.cssText + ";" + node.style.cssText;
                        domUtils.remove(ci, true);
                        continue;
                    }
                }
                ci.style.cssText = node.style.cssText + ';' + ci.style.cssText;
                if (attrs) {
                    var style = attrs.style;
                    if (style) {
                        style = style.split(';');
                        for (var j = 0, s; s = style[j++];) {
                            ci.style[utils.cssStyleToDomStyle(s.split(':')[0])] = s.split(':')[1];
                        }
                    }
                }
                if (domUtils.isSameStyle(ci, node)) {
                    domUtils.remove(ci, true);
                }
                continue;
            }
            if (domUtils.isSameElement(node, ci)) {
                domUtils.remove(ci, true);
            }
        }
    },

    /**
     * 原生方法getElementsByTagName的封装
     * @method getElementsByTagName
     * @param { Node } node 目标节点对象
     * @param { String } tagName 需要查找的节点的tagName， 多个tagName以空格分割
     * @return { Array } 符合条件的节点集合
     */
    getElementsByTagName:function (node, name,filter) {
        if(filter && utils.isString(filter)){
           var className = filter;
           filter =  function(node){return domUtils.hasClass(node,className)}
        }
        name = utils.trim(name).replace(/[ ]{2,}/g,' ').split(' ');
        var arr = [];
        for(var n = 0,ni;ni=name[n++];){
            var list = node.getElementsByTagName(ni);
            for (var i = 0, ci; ci = list[i++];) {
                if(!filter || filter(ci))
                    arr.push(ci);
            }
        }

        return arr;
    },
    /**
     * 将节点node提取到父节点上
     * @method mergeToParent
     * @param { Element } node 需要提取的元素对象
     * @example
     * ```html
     * <div id="parent">
     *     <div id="sub">
     *         <span id="child"></span>
     *     </div>
     * </div>
     *
     * <script>
     *
     *     var child = document.getElementById( "child" );
     *
     *     //output: sub
     *     console.log( child.parentNode.id );
     *
     *     UE.dom.domUtils.mergeToParent( child );
     *
     *     //output: parent
     *     console.log( child.parentNode.id );
     *
     * </script>
     * ```
     */
    mergeToParent:function (node) {
        var parent = node.parentNode;
        while (parent && dtd.$removeEmpty[parent.tagName]) {
            if (parent.tagName == node.tagName || parent.tagName == 'A') {//针对a标签单独处理
                domUtils.trimWhiteTextNode(parent);
                //span需要特殊处理  不处理这样的情况 <span stlye="color:#fff">xxx<span style="color:#ccc">xxx</span>xxx</span>
                if (parent.tagName == 'SPAN' && !domUtils.isSameStyle(parent, node)
                    || (parent.tagName == 'A' && node.tagName == 'SPAN')) {
                    if (parent.childNodes.length > 1 || parent !== node.parentNode) {
                        node.style.cssText = parent.style.cssText + ";" + node.style.cssText;
                        parent = parent.parentNode;
                        continue;
                    } else {
                        parent.style.cssText += ";" + node.style.cssText;
                        //trace:952 a标签要保持下划线
                        if (parent.tagName == 'A') {
                            parent.style.textDecoration = 'underline';
                        }
                    }
                }
                if (parent.tagName != 'A') {
                    parent === node.parentNode && domUtils.remove(node, true);
                    break;
                }
            }
            parent = parent.parentNode;
        }
    },
    /**
     * 合并节点node的左右兄弟节点
     * @method mergeSibling
     * @param { Element } node 需要合并的目标节点
     * @example
     * ```html
     * <b>xxxx</b><b id="test">ooo</b><b>xxxx</b>
     *
     * <script>
     *     var demoNode = document.getElementById("test");
     *     UE.dom.domUtils.mergeSibling( demoNode );
     *     //output: xxxxoooxxxx
     *     console.log( demoNode.innerHTML );
     * </script>
     * ```
     */

    /**
     * 合并节点node的左右兄弟节点， 可以根据给定的条件选择是否忽略合并左节点。
     * @method mergeSibling
     * @param { Element } node 需要合并的目标节点
     * @param { Boolean } ignorePre 是否忽略合并左节点
     * @example
     * ```html
     * <b>xxxx</b><b id="test">ooo</b><b>xxxx</b>
     *
     * <script>
     *     var demoNode = document.getElementById("test");
     *     UE.dom.domUtils.mergeSibling( demoNode, true );
     *     //output: oooxxxx
     *     console.log( demoNode.innerHTML );
     * </script>
     * ```
     */

    /**
     * 合并节点node的左右兄弟节点，可以根据给定的条件选择是否忽略合并左右节点。
     * @method mergeSibling
     * @param { Element } node 需要合并的目标节点
     * @param { Boolean } ignorePre 是否忽略合并左节点
     * @param { Boolean } ignoreNext 是否忽略合并右节点
     * @remind 如果同时忽略左右节点， 则该操作什么也不会做
     * @example
     * ```html
     * <b>xxxx</b><b id="test">ooo</b><b>xxxx</b>
     *
     * <script>
     *     var demoNode = document.getElementById("test");
     *     UE.dom.domUtils.mergeSibling( demoNode, false, true );
     *     //output: xxxxooo
     *     console.log( demoNode.innerHTML );
     * </script>
     * ```
     */
    mergeSibling:function (node, ignorePre, ignoreNext) {
        function merge(rtl, start, node) {
            var next;
            if ((next = node[rtl]) && !domUtils.isBookmarkNode(next) && next.nodeType == 1 && domUtils.isSameElement(node, next)) {
                while (next.firstChild) {
                    if (start == 'firstChild') {
                        node.insertBefore(next.lastChild, node.firstChild);
                    } else {
                        node.appendChild(next.firstChild);
                    }
                }
                domUtils.remove(next);
            }
        }
        !ignorePre && merge('previousSibling', 'firstChild', node);
        !ignoreNext && merge('nextSibling', 'lastChild', node);
    },

    /**
     * 设置节点node及其子节点不会被选中
     * @method unSelectable
     * @param { Element } node 需要执行操作的dom元素
     * @remind 执行该操作后的节点， 将不能被鼠标选中
     * @example
     * ```javascript
     * UE.dom.domUtils.unSelectable( document.body );
     * ```
     */
    unSelectable:ie && browser.ie9below || browser.opera ? function (node) {
        //for ie9
        node.onselectstart = function () {
            return false;
        };
        node.onclick = node.onkeyup = node.onkeydown = function () {
            return false;
        };
        node.unselectable = 'on';
        node.setAttribute("unselectable", "on");
        for (var i = 0, ci; ci = node.all[i++];) {
            switch (ci.tagName.toLowerCase()) {
                case 'iframe' :
                case 'textarea' :
                case 'input' :
                case 'select' :
                    break;
                default :
                    ci.unselectable = 'on';
                    node.setAttribute("unselectable", "on");
            }
        }
    } : function (node) {
        node.style.MozUserSelect =
            node.style.webkitUserSelect =
                node.style.msUserSelect =
                    node.style.KhtmlUserSelect = 'none';
    },
    /**
     * 删除节点node上的指定属性名称的属性
     * @method  removeAttributes
     * @param { Node } node 需要删除属性的节点对象
     * @param { String } attrNames 可以是空格隔开的多个属性名称，该操作将会依次删除相应的属性
     * @example
     * ```html
     * <div id="wrap">
     *      <span style="font-size:14px;" id="test" name="followMe">xxxxx</span>
     * </div>
     *
     * <script>
     *
     *     UE.dom.domUtils.removeAttributes( document.getElementById( "test" ), "id name" );
     *
     *     //output: <span style="font-size:14px;">xxxxx</span>
     *     console.log( document.getElementById("wrap").innerHTML );
     *
     * </script>
     * ```
     */

    /**
     * 删除节点node上的指定属性名称的属性
     * @method  removeAttributes
     * @param { Node } node 需要删除属性的节点对象
     * @param { Array } attrNames 需要删除的属性名数组
     * @example
     * ```html
     * <div id="wrap">
     *      <span style="font-size:14px;" id="test" name="followMe">xxxxx</span>
     * </div>
     *
     * <script>
     *
     *     UE.dom.domUtils.removeAttributes( document.getElementById( "test" ), ["id", "name"] );
     *
     *     //output: <span style="font-size:14px;">xxxxx</span>
     *     console.log( document.getElementById("wrap").innerHTML );
     *
     * </script>
     * ```
     */
    removeAttributes:function (node, attrNames) {
        attrNames = utils.isArray(attrNames) ? attrNames : utils.trim(attrNames).replace(/[ ]{2,}/g,' ').split(' ');
        for (var i = 0, ci; ci = attrNames[i++];) {
            ci = attrFix[ci] || ci;
            switch (ci) {
                case 'className':
                    node[ci] = '';
                    break;
                case 'style':
                    node.style.cssText = '';
                    var val = node.getAttributeNode('style');
                    !browser.ie && val && node.removeAttributeNode(val);
            }
            node.removeAttribute(ci);
        }
    },
    /**
     * 在doc下创建一个标签名为tag，属性为attrs的元素
     * @method createElement
     * @param { DomDocument } doc 新创建的元素属于该document节点创建
     * @param { String } tagName 需要创建的元素的标签名
     * @param { Object } attrs 新创建的元素的属性key-value集合
     * @return { Element } 新创建的元素对象
     * @example
     * ```javascript
     * var ele = UE.dom.domUtils.createElement( document, 'div', {
     *     id: 'test'
     * } );
     *
     * //output: DIV
     * console.log( ele.tagName );
     *
     * //output: test
     * console.log( ele.id );
     *
     * ```
     */
    createElement:function (doc, tag, attrs) {
        return domUtils.setAttributes(doc.createElement(tag), attrs)
    },
    /**
     * 为节点node添加属性attrs，attrs为属性键值对
     * @method setAttributes
     * @param { Element } node 需要设置属性的元素对象
     * @param { Object } attrs 需要设置的属性名-值对
     * @return { Element } 设置属性的元素对象
     * @example
     * ```html
     * <span id="test"></span>
     *
     * <script>
     *
     *     var testNode = UE.dom.domUtils.setAttributes( document.getElementById( "test" ), {
     *         id: 'demo'
     *     } );
     *
     *     //output: demo
     *     console.log( testNode.id );
     *
     * </script>
     *
     */
    setAttributes:function (node, attrs) {
        for (var attr in attrs) {
            if(attrs.hasOwnProperty(attr)){
                var value = attrs[attr];
                switch (attr) {
                    case 'class':
                        //ie下要这样赋值，setAttribute不起作用
                        node.className = value;
                        break;
                    case 'style' :
                        node.style.cssText = node.style.cssText + ";" + value;
                        break;
                    case 'innerHTML':
                        node[attr] = value;
                        break;
                    case 'value':
                        node.value = value;
                        break;
                    default:
                        node.setAttribute(attrFix[attr] || attr, value);
                }
            }
        }
        return node;
    },

    /**
     * 获取元素element经过计算后的样式值
     * @method getComputedStyle
     * @param { Element } element 需要获取样式的元素对象
     * @param { String } styleName 需要获取的样式名
     * @return { String } 获取到的样式值
     * @example
     * ```html
     * <style type="text/css">
     *      #test {
     *          font-size: 15px;
     *      }
     * </style>
     *
     * <span id="test"></span>
     *
     * <script>
     *     //output: 15px
     *     console.log( UE.dom.domUtils.getComputedStyle( document.getElementById( "test" ), 'font-size' ) );
     * </script>
     * ```
     */
    getComputedStyle:function (element, styleName) {
        //一下的属性单独处理
        var pros = 'width height top left';

        if(pros.indexOf(styleName) > -1){
            return element['offset' + styleName.replace(/^\w/,function(s){return s.toUpperCase()})] + 'px';
        }
        //忽略文本节点
        if (element.nodeType == 3) {
            element = element.parentNode;
        }
        //ie下font-size若body下定义了font-size，则从currentStyle里会取到这个font-size. 取不到实际值，故此修改.
        if (browser.ie && browser.version < 9 && styleName == 'font-size' && !element.style.fontSize &&
            !dtd.$empty[element.tagName] && !dtd.$nonChild[element.tagName]) {
            var span = element.ownerDocument.createElement('span');
            span.style.cssText = 'padding:0;border:0;font-family:simsun;';
            span.innerHTML = '.';
            element.appendChild(span);
            var result = span.offsetHeight;
            element.removeChild(span);
            span = null;
            return result + 'px';
        }
        try {
            var value = domUtils.getStyle(element, styleName) ||
                (window.getComputedStyle ? domUtils.getWindow(element).getComputedStyle(element, '').getPropertyValue(styleName) :
                    ( element.currentStyle || element.style )[utils.cssStyleToDomStyle(styleName)]);

        } catch (e) {
            return "";
        }
        return utils.transUnitToPx(utils.fixColor(styleName, value));
    },
    /**
     * 删除元素element指定的className
     * @method removeClasses
     * @param { Element } ele 需要删除class的元素节点
     * @param { String } classNames 需要删除的className， 多个className之间以空格分开
     * @example
     * ```html
     * <span id="test" class="test1 test2 test3">xxx</span>
     *
     * <script>
     *
     *     var testNode = document.getElementById( "test" );
     *     UE.dom.domUtils.removeClasses( testNode, "test1 test2" );
     *
     *     //output: test3
     *     console.log( testNode.className );
     *
     * </script>
     * ```
     */

    /**
     * 删除元素element指定的className
     * @method removeClasses
     * @param { Element } ele 需要删除class的元素节点
     * @param { Array } classNames 需要删除的className数组
     * @example
     * ```html
     * <span id="test" class="test1 test2 test3">xxx</span>
     *
     * <script>
     *
     *     var testNode = document.getElementById( "test" );
     *     UE.dom.domUtils.removeClasses( testNode, ["test1", "test2"] );
     *
     *     //output: test3
     *     console.log( testNode.className );
     *
     * </script>
     * ```
     */
    removeClasses:function (elm, classNames) {
        classNames = utils.isArray(classNames) ? classNames :
            utils.trim(classNames).replace(/[ ]{2,}/g,' ').split(' ');
        for(var i = 0,ci,cls = elm.className;ci=classNames[i++];){
            cls = cls.replace(new RegExp('\\b' + ci + '\\b'),'')
        }
        cls = utils.trim(cls).replace(/[ ]{2,}/g,' ');
        if(cls){
            elm.className = cls;
        }else{
            domUtils.removeAttributes(elm,['class']);
        }
    },
    /**
     * 给元素element添加className
     * @method addClass
     * @param { Node } ele 需要增加className的元素
     * @param { String } classNames 需要添加的className， 多个className之间以空格分割
     * @remind 相同的类名不会被重复添加
     * @example
     * ```html
     * <span id="test" class="cls1 cls2"></span>
     *
     * <script>
     *     var testNode = document.getElementById("test");
     *
     *     UE.dom.domUtils.addClass( testNode, "cls2 cls3 cls4" );
     *
     *     //output: cl1 cls2 cls3 cls4
     *     console.log( testNode.className );
     *
     * <script>
     * ```
     */

    /**
     * 给元素element添加className
     * @method addClass
     * @param { Node } ele 需要增加className的元素
     * @param { Array } classNames 需要添加的className的数组
     * @remind 相同的类名不会被重复添加
     * @example
     * ```html
     * <span id="test" class="cls1 cls2"></span>
     *
     * <script>
     *     var testNode = document.getElementById("test");
     *
     *     UE.dom.domUtils.addClass( testNode, ["cls2", "cls3", "cls4"] );
     *
     *     //output: cl1 cls2 cls3 cls4
     *     console.log( testNode.className );
     *
     * <script>
     * ```
     */
    addClass:function (elm, classNames) {
        if(!elm)return;
        classNames = utils.trim(classNames).replace(/[ ]{2,}/g,' ').split(' ');
        for(var i = 0,ci,cls = elm.className;ci=classNames[i++];){
            if(!new RegExp('\\b' + ci + '\\b').test(cls)){
                cls += ' ' + ci;
            }
        }
        elm.className = utils.trim(cls);
    },
    /**
     * 判断元素element是否包含给定的样式类名className
     * @method hasClass
     * @param { Node } ele 需要检测的元素
     * @param { String } classNames 需要检测的className， 多个className之间用空格分割
     * @return { Boolean } 元素是否包含所有给定的className
     * @example
     * ```html
     * <span id="test1" class="cls1 cls2"></span>
     *
     * <script>
     *     var test1 = document.getElementById("test1");
     *
     *     //output: false
     *     console.log( UE.dom.domUtils.hasClass( test1, "cls2 cls1 cls3" ) );
     *
     *     //output: true
     *     console.log( UE.dom.domUtils.hasClass( test1, "cls2 cls1" ) );
     * </script>
     * ```
     */

    /**
     * 判断元素element是否包含给定的样式类名className
     * @method hasClass
     * @param { Node } ele 需要检测的元素
     * @param { Array } classNames 需要检测的className数组
     * @return { Boolean } 元素是否包含所有给定的className
     * @example
     * ```html
     * <span id="test1" class="cls1 cls2"></span>
     *
     * <script>
     *     var test1 = document.getElementById("test1");
     *
     *     //output: false
     *     console.log( UE.dom.domUtils.hasClass( test1, [ "cls2", "cls1", "cls3" ] ) );
     *
     *     //output: true
     *     console.log( UE.dom.domUtils.hasClass( test1, [ "cls2", "cls1" ]) );
     * </script>
     * ```
     */
    hasClass:function (element, className) {
        if(utils.isRegExp(className)){
            return className.test(element.className)
        }
        className = utils.trim(className).replace(/[ ]{2,}/g,' ').split(' ');
        for(var i = 0,ci,cls = element.className;ci=className[i++];){
            if(!new RegExp('\\b' + ci + '\\b','i').test(cls)){
                return false;
            }
        }
        return i - 1 == className.length;
    },

    /**
     * 阻止事件默认行为
     * @method preventDefault
     * @param { Event } evt 需要阻止默认行为的事件对象
     * @example
     * ```javascript
     * UE.dom.domUtils.preventDefault( evt );
     * ```
     */
    preventDefault:function (evt) {
        evt.preventDefault ? evt.preventDefault() : (evt.returnValue = false);
    },
    /**
     * 删除元素element指定的样式
     * @method removeStyle
     * @param { Element } element 需要删除样式的元素
     * @param { String } styleName 需要删除的样式名
     * @example
     * ```html
     * <span id="test" style="color: red; background: blue;"></span>
     *
     * <script>
     *
     *     var testNode = document.getElementById("test");
     *
     *     UE.dom.domUtils.removeStyle( testNode, 'color' );
     *
     *     //output: background: blue;
     *     console.log( testNode.style.cssText );
     *
     * </script>
     * ```
     */
    removeStyle:function (element, name) {
        if(browser.ie ){
            //针对color先单独处理一下
            if(name == 'color'){
                name = '(^|;)' + name;
            }
            element.style.cssText = element.style.cssText.replace(new RegExp(name + '[^:]*:[^;]+;?','ig'),'')
        }else{
            if (element.style.removeProperty) {
                element.style.removeProperty (name);
            }else {
                element.style.removeAttribute (utils.cssStyleToDomStyle(name));
            }
        }


        if (!element.style.cssText) {
            domUtils.removeAttributes(element, ['style']);
        }
    },
    /**
     * 获取元素element的style属性的指定值
     * @method getStyle
     * @param { Element } element 需要获取属性值的元素
     * @param { String } styleName 需要获取的style的名称
     * @warning 该方法仅获取元素style属性中所标明的值
     * @return { String } 该元素包含指定的style属性值
     * @example
     * ```html
     * <div id="test" style="color: red;"></div>
     *
     * <script>
     *
     *      var testNode = document.getElementById( "test" );
     *
     *      //output: red
     *      console.log( UE.dom.domUtils.getStyle( testNode, "color" ) );
     *
     *      //output: ""
     *      console.log( UE.dom.domUtils.getStyle( testNode, "background" ) );
     *
     * </script>
     * ```
     */
    getStyle:function (element, name) {
        var value = element.style[ utils.cssStyleToDomStyle(name) ];
        return utils.fixColor(name, value);
    },
    /**
     * 为元素element设置样式属性值
     * @method setStyle
     * @param { Element } element 需要设置样式的元素
     * @param { String } styleName 样式名
     * @param { String } styleValue 样式值
     * @example
     * ```html
     * <div id="test"></div>
     *
     * <script>
     *
     *      var testNode = document.getElementById( "test" );
     *
     *      //output: ""
     *      console.log( testNode.style.color );
     *
     *      UE.dom.domUtils.setStyle( testNode, 'color', 'red' );
     *      //output: "red"
     *      console.log( testNode.style.color );
     *
     * </script>
     * ```
     */
    setStyle:function (element, name, value) {
        element.style[utils.cssStyleToDomStyle(name)] = value;
        if(!utils.trim(element.style.cssText)){
            this.removeAttributes(element,'style')
        }
    },
    /**
     * 为元素element设置多个样式属性值
     * @method setStyles
     * @param { Element } element 需要设置样式的元素
     * @param { Object } styles 样式名值对
     * @example
     * ```html
     * <div id="test"></div>
     *
     * <script>
     *
     *      var testNode = document.getElementById( "test" );
     *
     *      //output: ""
     *      console.log( testNode.style.color );
     *
     *      UE.dom.domUtils.setStyles( testNode, {
     *          'color': 'red'
     *      } );
     *      //output: "red"
     *      console.log( testNode.style.color );
     *
     * </script>
     * ```
     */
    setStyles:function (element, styles) {
        for (var name in styles) {
            if (styles.hasOwnProperty(name)) {
                domUtils.setStyle(element, name, styles[name]);
            }
        }
    },
    /**
     * 删除_moz_dirty属性
     * @private
     * @method removeDirtyAttr
     */
    removeDirtyAttr:function (node) {
        for (var i = 0, ci, nodes = node.getElementsByTagName('*'); ci = nodes[i++];) {
            ci.removeAttribute('_moz_dirty');
        }
        node.removeAttribute('_moz_dirty');
    },
    /**
     * 获取子节点的数量
     * @method getChildCount
     * @param { Element } node 需要检测的元素
     * @return { Number } 给定的node元素的子节点数量
     * @example
     * ```html
     * <div id="test">
     *      <span></span>
     * </div>
     *
     * <script>
     *
     *     //output: 3
     *     console.log( UE.dom.domUtils.getChildCount( document.getElementById("test") ) );
     *
     * </script>
     * ```
     */

    /**
     * 根据给定的过滤规则， 获取符合条件的子节点的数量
     * @method getChildCount
     * @param { Element } node 需要检测的元素
     * @param { Function } fn 过滤器， 要求对符合条件的子节点返回true， 反之则要求返回false
     * @return { Number } 符合过滤条件的node元素的子节点数量
     * @example
     * ```html
     * <div id="test">
     *      <span></span>
     * </div>
     *
     * <script>
     *
     *     //output: 1
     *     console.log( UE.dom.domUtils.getChildCount( document.getElementById("test"), function ( node ) {
     *
     *         return node.nodeType === 1;
     *
     *     } ) );
     *
     * </script>
     * ```
     */
    getChildCount:function (node, fn) {
        var count = 0, first = node.firstChild;
        fn = fn || function () {
            return 1;
        };
        while (first) {
            if (fn(first)) {
                count++;
            }
            first = first.nextSibling;
        }
        return count;
    },

    /**
     * 判断给定节点是否为空节点
     * @method isEmptyNode
     * @param { Node } node 需要检测的节点对象
     * @return { Boolean } 节点是否为空
     * @example
     * ```javascript
     * UE.dom.domUtils.isEmptyNode( document.body );
     * ```
     */
    isEmptyNode:function (node) {
        return !node.firstChild || domUtils.getChildCount(node, function (node) {
            return  !domUtils.isBr(node) && !domUtils.isBookmarkNode(node) && !domUtils.isWhitespace(node)
        }) == 0
    },
    clearSelectedArr:function (nodes) {
        var node;
        while (node = nodes.pop()) {
            domUtils.removeAttributes(node, ['class']);
        }
    },
    /**
     * 将显示区域滚动到指定节点的位置
     * @method scrollToView
     * @param    {Node}   node    节点
     * @param    {window}   win      window对象
     * @param    {Number}    offsetTop    距离上方的偏移量
     */
    scrollToView:function (node, win, offsetTop) {
        var getViewPaneSize = function () {
                var doc = win.document,
                    mode = doc.compatMode == 'CSS1Compat';
                return {
                    width:( mode ? doc.documentElement.clientWidth : doc.body.clientWidth ) || 0,
                    height:( mode ? doc.documentElement.clientHeight : doc.body.clientHeight ) || 0
                };
            },
            getScrollPosition = function (win) {
                if ('pageXOffset' in win) {
                    return {
                        x:win.pageXOffset || 0,
                        y:win.pageYOffset || 0
                    };
                }
                else {
                    var doc = win.document;
                    return {
                        x:doc.documentElement.scrollLeft || doc.body.scrollLeft || 0,
                        y:doc.documentElement.scrollTop || doc.body.scrollTop || 0
                    };
                }
            };
        var winHeight = getViewPaneSize().height, offset = winHeight * -1 + offsetTop;
        offset += (node.offsetHeight || 0);
        var elementPosition = domUtils.getXY(node);
        offset += elementPosition.y;
        var currentScroll = getScrollPosition(win).y;
        // offset += 50;
        if (offset > currentScroll || offset < currentScroll - winHeight) {
            win.scrollTo(0, offset + (offset < 0 ? -20 : 20));
        }
    },
    /**
     * 判断给定节点是否为br
     * @method isBr
     * @param { Node } node 需要判断的节点对象
     * @return { Boolean } 给定的节点是否是br节点
     */
    isBr:function (node) {
        return node.nodeType == 1 && node.tagName == 'BR';
    },
    /**
     * 判断给定的节点是否是一个“填充”节点
     * @private
     * @method isFillChar
     * @param { Node } node 需要判断的节点
     * @param { Boolean } isInStart 是否从节点内容的开始位置匹配
     * @returns { Boolean } 节点是否是填充节点
     */
    isFillChar:function (node,isInStart) {
        if(node.nodeType != 3)
            return false;
        var text = node.nodeValue;
        if(isInStart){
            return new RegExp('^' + domUtils.fillChar).test(text)
        }
        return !text.replace(new RegExp(domUtils.fillChar,'g'), '').length
    },
    isStartInblock:function (range) {
        var tmpRange = range.cloneRange(),
            flag = 0,
            start = tmpRange.startContainer,
            tmp;
        if(start.nodeType == 1 && start.childNodes[tmpRange.startOffset]){
            start = start.childNodes[tmpRange.startOffset];
            var pre = start.previousSibling;
            while(pre && domUtils.isFillChar(pre)){
                start = pre;
                pre = pre.previousSibling;
            }
        }
        if(this.isFillChar(start,true) && tmpRange.startOffset == 1){
            tmpRange.setStartBefore(start);
            start = tmpRange.startContainer;
        }

        while (start && domUtils.isFillChar(start)) {
            tmp = start;
            start = start.previousSibling
        }
        if (tmp) {
            tmpRange.setStartBefore(tmp);
            start = tmpRange.startContainer;
        }
        if (start.nodeType == 1 && domUtils.isEmptyNode(start) && tmpRange.startOffset == 1) {
            tmpRange.setStart(start, 0).collapse(true);
        }
        while (!tmpRange.startOffset) {
            start = tmpRange.startContainer;
            if (domUtils.isBlockElm(start) || domUtils.isBody(start)) {
                flag = 1;
                break;
            }
            var pre = tmpRange.startContainer.previousSibling,
                tmpNode;
            if (!pre) {
                tmpRange.setStartBefore(tmpRange.startContainer);
            } else {
                while (pre && domUtils.isFillChar(pre)) {
                    tmpNode = pre;
                    pre = pre.previousSibling;
                }
                if (tmpNode) {
                    tmpRange.setStartBefore(tmpNode);
                } else {
                    tmpRange.setStartBefore(tmpRange.startContainer);
                }
            }
        }
        return flag && !domUtils.isBody(tmpRange.startContainer) ? 1 : 0;
    },

    /**
     * 判断给定的元素是否是一个空元素
     * @method isEmptyBlock
     * @param { Element } node 需要判断的元素
     * @return { Boolean } 是否是空元素
     * @example
     * ```html
     * <div id="test"></div>
     *
     * <script>
     *     //output: true
     *     console.log( UE.dom.domUtils.isEmptyBlock( document.getElementById("test") ) );
     * </script>
     * ```
     */

    /**
     * 根据指定的判断规则判断给定的元素是否是一个空元素
     * @method isEmptyBlock
     * @param { Element } node 需要判断的元素
     * @param { RegExp } reg 对内容执行判断的正则表达式对象
     * @return { Boolean } 是否是空元素
     */
    isEmptyBlock:function (node,reg) {
        if(node.nodeType != 1)
            return 0;
        reg = reg || new RegExp('[ \xa0\t\r\n' + domUtils.fillChar + ']', 'g');

        if (node[browser.ie ? 'innerText' : 'textContent'].replace(reg, '').length > 0) {
            return 0;
        }
        for (var n in dtd.$isNotEmpty) {
            if (node.getElementsByTagName(n).length) {
                return 0;
            }
        }
        return 1;
    },

    /**
     * 移动元素使得该元素的位置移动指定的偏移量的距离
     * @method setViewportOffset
     * @param { Element } element 需要设置偏移量的元素
     * @param { Object } offset 偏移量， 形如{ left: 100, top: 50 }的一个键值对， 表示该元素将在
     *                                  现有的位置上向水平方向偏移offset.left的距离， 在竖直方向上偏移
     *                                  offset.top的距离
     * @example
     * ```html
     * <div id="test" style="top: 100px; left: 50px; position: absolute;"></div>
     *
     * <script>
     *
     *     var testNode = document.getElementById("test");
     *
     *     UE.dom.domUtils.setViewportOffset( testNode, {
     *         left: 200,
     *         top: 50
     *     } );
     *
     *     //output: top: 300px; left: 100px; position: absolute;
     *     console.log( testNode.style.cssText );
     *
     * </script>
     * ```
     */
    setViewportOffset:function (element, offset) {
        var left = parseInt(element.style.left) | 0;
        var top = parseInt(element.style.top) | 0;
        var rect = element.getBoundingClientRect();
        var offsetLeft = offset.left - rect.left;
        var offsetTop = offset.top - rect.top;
        if (offsetLeft) {
            element.style.left = left + offsetLeft + 'px';
        }
        if (offsetTop) {
            element.style.top = top + offsetTop + 'px';
        }
    },

    /**
     * 用“填充字符”填充节点
     * @method fillNode
     * @private
     * @param { DomDocument } doc 填充的节点所在的docment对象
     * @param { Node } node 需要填充的节点对象
     * @example
     * ```html
     * <div id="test"></div>
     *
     * <script>
     *     var testNode = document.getElementById("test");
     *
     *     //output: 0
     *     console.log( testNode.childNodes.length );
     *
     *     UE.dom.domUtils.fillNode( document, testNode );
     *
     *     //output: 1
     *     console.log( testNode.childNodes.length );
     *
     * </script>
     * ```
     */
    fillNode:function (doc, node) {
        var tmpNode = browser.ie ? doc.createTextNode(domUtils.fillChar) : doc.createElement('br');
        node.innerHTML = '';
        node.appendChild(tmpNode);
    },

    /**
     * 把节点src的所有子节点追加到另一个节点tag上去
     * @method moveChild
     * @param { Node } src 源节点， 该节点下的所有子节点将被移除
     * @param { Node } tag 目标节点， 从源节点移除的子节点将被追加到该节点下
     * @example
     * ```html
     * <div id="test1">
     *      <span></span>
     * </div>
     * <div id="test2">
     *     <div></div>
     * </div>
     *
     * <script>
     *
     *     var test1 = document.getElementById("test1"),
     *         test2 = document.getElementById("test2");
     *
     *     UE.dom.domUtils.moveChild( test1, test2 );
     *
     *     //output: ""（空字符串）
     *     console.log( test1.innerHTML );
     *
     *     //output: "<div></div><span></span>"
     *     console.log( test2.innerHTML );
     *
     * </script>
     * ```
     */

    /**
     * 把节点src的所有子节点移动到另一个节点tag上去, 可以通过dir参数控制附加的行为是“追加”还是“插入顶部”
     * @method moveChild
     * @param { Node } src 源节点， 该节点下的所有子节点将被移除
     * @param { Node } tag 目标节点， 从源节点移除的子节点将被附加到该节点下
     * @param { Boolean } dir 附加方式， 如果为true， 则附加进去的节点将被放到目标节点的顶部， 反之，则放到末尾
     * @example
     * ```html
     * <div id="test1">
     *      <span></span>
     * </div>
     * <div id="test2">
     *     <div></div>
     * </div>
     *
     * <script>
     *
     *     var test1 = document.getElementById("test1"),
     *         test2 = document.getElementById("test2");
     *
     *     UE.dom.domUtils.moveChild( test1, test2, true );
     *
     *     //output: ""（空字符串）
     *     console.log( test1.innerHTML );
     *
     *     //output: "<span></span><div></div>"
     *     console.log( test2.innerHTML );
     *
     * </script>
     * ```
     */
    moveChild:function (src, tag, dir) {
        while (src.firstChild) {
            if (dir && tag.firstChild) {
                tag.insertBefore(src.lastChild, tag.firstChild);
            } else {
                tag.appendChild(src.firstChild);
            }
        }
    },

    /**
     * 判断节点的标签上是否不存在任何属性
     * @method hasNoAttributes
     * @private
     * @param { Node } node 需要检测的节点对象
     * @return { Boolean } 节点是否不包含任何属性
     * @example
     * ```html
     * <div id="test"><span>xxxx</span></div>
     *
     * <script>
     *
     *     //output: false
     *     console.log( UE.dom.domUtils.hasNoAttributes( document.getElementById("test") ) );
     *
     *     //output: true
     *     console.log( UE.dom.domUtils.hasNoAttributes( document.getElementById("test").firstChild ) );
     *
     * </script>
     * ```
     */
    hasNoAttributes:function (node) {
        return browser.ie ? /^<\w+\s*?>/.test(node.outerHTML) : node.attributes.length == 0;
    },

    /**
     * 检测节点是否是UEditor所使用的辅助节点
     * @method isCustomeNode
     * @private
     * @param { Node } node 需要检测的节点
     * @remind 辅助节点是指编辑器要完成工作临时添加的节点， 在输出的时候将会从编辑器内移除， 不会影响最终的结果。
     * @return { Boolean } 给定的节点是否是一个辅助节点
     */
    isCustomeNode:function (node) {
        return node.nodeType == 1 && node.getAttribute('_ue_custom_node_');
    },

    /**
     * 检测节点的标签是否是给定的标签
     * @method isTagNode
     * @param { Node } node 需要检测的节点对象
     * @param { String } tagName 标签
     * @return { Boolean } 节点的标签是否是给定的标签
     * @example
     * ```html
     * <div id="test"></div>
     *
     * <script>
     *
     *     //output: true
     *     console.log( UE.dom.domUtils.isTagNode( document.getElementById("test"), "div" ) );
     *
     * </script>
     * ```
     */
    isTagNode:function (node, tagNames) {
        return node.nodeType == 1 && new RegExp('\\b' + node.tagName + '\\b','i').test(tagNames)
    },

    /**
     * 给定一个节点数组，在通过指定的过滤器过滤后， 获取其中满足过滤条件的第一个节点
     * @method filterNodeList
     * @param { Array } nodeList 需要过滤的节点数组
     * @param { Function } fn 过滤器， 对符合条件的节点， 执行结果返回true， 反之则返回false
     * @return { Node | NULL } 如果找到符合过滤条件的节点， 则返回该节点， 否则返回NULL
     * @example
     * ```javascript
     * var divNodes = document.getElementsByTagName("div");
     * divNodes = [].slice.call( divNodes, 0 );
     *
     * //output: null
     * console.log( UE.dom.domUtils.filterNodeList( divNodes, function ( node ) {
     *     return node.tagName.toLowerCase() !== 'div';
     * } ) );
     * ```
     */

    /**
     * 给定一个节点数组nodeList和一组标签名tagNames， 获取其中能够匹配标签名的节点集合中的第一个节点
     * @method filterNodeList
     * @param { Array } nodeList 需要过滤的节点数组
     * @param { String } tagNames 需要匹配的标签名， 多个标签名之间用空格分割
     * @return { Node | NULL } 如果找到标签名匹配的节点， 则返回该节点， 否则返回NULL
     * @example
     * ```javascript
     * var divNodes = document.getElementsByTagName("div");
     * divNodes = [].slice.call( divNodes, 0 );
     *
     * //output: null
     * console.log( UE.dom.domUtils.filterNodeList( divNodes, 'a span' ) );
     * ```
     */

    /**
     * 给定一个节点数组，在通过指定的过滤器过滤后， 如果参数forAll为true， 则会返回所有满足过滤
     * 条件的节点集合， 否则， 返回满足条件的节点集合中的第一个节点
     * @method filterNodeList
     * @param { Array } nodeList 需要过滤的节点数组
     * @param { Function } fn 过滤器， 对符合条件的节点， 执行结果返回true， 反之则返回false
     * @param { Boolean } forAll 是否返回整个节点数组, 如果该参数为false， 则返回节点集合中的第一个节点
     * @return { Array | Node | NULL } 如果找到符合过滤条件的节点， 则根据参数forAll的值决定返回满足
     *                                      过滤条件的节点数组或第一个节点， 否则返回NULL
     * @example
     * ```javascript
     * var divNodes = document.getElementsByTagName("div");
     * divNodes = [].slice.call( divNodes, 0 );
     *
     * //output: 3（假定有3个div）
     * console.log( divNodes.length );
     *
     * var nodes = UE.dom.domUtils.filterNodeList( divNodes, function ( node ) {
     *     return node.tagName.toLowerCase() === 'div';
     * }, true );
     *
     * //output: 3
     * console.log( nodes.length );
     *
     * var node = UE.dom.domUtils.filterNodeList( divNodes, function ( node ) {
     *     return node.tagName.toLowerCase() === 'div';
     * }, false );
     *
     * //output: div
     * console.log( node.nodeName );
     * ```
     */
    filterNodeList : function(nodelist,filter,forAll){
        var results = [];
        if(!utils .isFunction(filter)){
            var str = filter;
            filter = function(n){
                return utils.indexOf(utils.isArray(str) ? str:str.split(' '), n.tagName.toLowerCase()) != -1
            };
        }
        utils.each(nodelist,function(n){
            filter(n) && results.push(n)
        });
        return results.length  == 0 ? null : results.length == 1 || !forAll ? results[0] : results
    },

    /**
     * 查询给定的range选区是否在给定的node节点内，且在该节点的最末尾
     * @method isInNodeEndBoundary
     * @param { UE.dom.Range } rng 需要判断的range对象， 该对象的startContainer不能为NULL
     * @param node 需要检测的节点对象
     * @return { Number } 如果给定的选取range对象是在node内部的最末端， 则返回1, 否则返回0
     */
    isInNodeEndBoundary : function (rng,node){
        var start = rng.startContainer;
        if(start.nodeType == 3 && rng.startOffset != start.nodeValue.length){
            return 0;
        }
        if(start.nodeType == 1 && rng.startOffset != start.childNodes.length){
            return 0;
        }
        while(start !== node){
            if(start.nextSibling){
                return 0
            };
            start = start.parentNode;
        }
        return 1;
    },
    isBoundaryNode : function (node,dir){
        var tmp;
        while(!domUtils.isBody(node)){
            tmp = node;
            node = node.parentNode;
            if(tmp !== node[dir]){
                return false;
            }
        }
        return true;
    },
    fillHtml :  browser.ie11below ? '&nbsp;' : '<br/>'
};
var fillCharReg = new RegExp(domUtils.fillChar, 'g');

// core/Range.js
/**
 * Range封装
 * @file
 * @module UE.dom
 * @class Range
 * @since 1.2.6.1
 */

/**
 * dom操作封装
 * @unfile
 * @module UE.dom
 */

/**
 * Range实现类，本类是UEditor底层核心类，封装不同浏览器之间的Range操作。
 * @unfile
 * @module UE.dom
 * @class Range
 */


(function () {
    var guid = 0,
        fillChar = domUtils.fillChar,
        fillData;

    /**
     * 更新range的collapse状态
     * @param  {Range}   range    range对象
     */
    function updateCollapse(range) {
        range.collapsed =
            range.startContainer && range.endContainer &&
                range.startContainer === range.endContainer &&
                range.startOffset == range.endOffset;
    }

    function selectOneNode(rng){
        return !rng.collapsed && rng.startContainer.nodeType == 1 && rng.startContainer === rng.endContainer && rng.endOffset - rng.startOffset == 1
    }
    function setEndPoint(toStart, node, offset, range) {
        //如果node是自闭合标签要处理
        if (node.nodeType == 1 && (dtd.$empty[node.tagName] || dtd.$nonChild[node.tagName])) {
            offset = domUtils.getNodeIndex(node) + (toStart ? 0 : 1);
            node = node.parentNode;
        }
        if (toStart) {
            range.startContainer = node;
            range.startOffset = offset;
            if (!range.endContainer) {
                range.collapse(true);
            }
        } else {
            range.endContainer = node;
            range.endOffset = offset;
            if (!range.startContainer) {
                range.collapse(false);
            }
        }
        updateCollapse(range);
        return range;
    }

    function execContentsAction(range, action) {
        //调整边界
        //range.includeBookmark();
        var start = range.startContainer,
            end = range.endContainer,
            startOffset = range.startOffset,
            endOffset = range.endOffset,
            doc = range.document,
            frag = doc.createDocumentFragment(),
            tmpStart, tmpEnd;
        if (start.nodeType == 1) {
            start = start.childNodes[startOffset] || (tmpStart = start.appendChild(doc.createTextNode('')));
        }
        if (end.nodeType == 1) {
            end = end.childNodes[endOffset] || (tmpEnd = end.appendChild(doc.createTextNode('')));
        }
        if (start === end && start.nodeType == 3) {
            frag.appendChild(doc.createTextNode(start.substringData(startOffset, endOffset - startOffset)));
            //is not clone
            if (action) {
                start.deleteData(startOffset, endOffset - startOffset);
                range.collapse(true);
            }
            return frag;
        }
        var current, currentLevel, clone = frag,
            startParents = domUtils.findParents(start, true), endParents = domUtils.findParents(end, true);
        for (var i = 0; startParents[i] == endParents[i];) {
            i++;
        }
        for (var j = i, si; si = startParents[j]; j++) {
            current = si.nextSibling;
            if (si == start) {
                if (!tmpStart) {
                    if (range.startContainer.nodeType == 3) {
                        clone.appendChild(doc.createTextNode(start.nodeValue.slice(startOffset)));
                        //is not clone
                        if (action) {
                            start.deleteData(startOffset, start.nodeValue.length - startOffset);
                        }
                    } else {
                        clone.appendChild(!action ? start.cloneNode(true) : start);
                    }
                }
            } else {
                currentLevel = si.cloneNode(false);
                clone.appendChild(currentLevel);
            }
            while (current) {
                if (current === end || current === endParents[j]) {
                    break;
                }
                si = current.nextSibling;
                clone.appendChild(!action ? current.cloneNode(true) : current);
                current = si;
            }
            clone = currentLevel;
        }
        clone = frag;
        if (!startParents[i]) {
            clone.appendChild(startParents[i - 1].cloneNode(false));
            clone = clone.firstChild;
        }
        for (var j = i, ei; ei = endParents[j]; j++) {
            current = ei.previousSibling;
            if (ei == end) {
                if (!tmpEnd && range.endContainer.nodeType == 3) {
                    clone.appendChild(doc.createTextNode(end.substringData(0, endOffset)));
                    //is not clone
                    if (action) {
                        end.deleteData(0, endOffset);
                    }
                }
            } else {
                currentLevel = ei.cloneNode(false);
                clone.appendChild(currentLevel);
            }
            //如果两端同级，右边第一次已经被开始做了
            if (j != i || !startParents[i]) {
                while (current) {
                    if (current === start) {
                        break;
                    }
                    ei = current.previousSibling;
                    clone.insertBefore(!action ? current.cloneNode(true) : current, clone.firstChild);
                    current = ei;
                }
            }
            clone = currentLevel;
        }
        if (action) {
            range.setStartBefore(!endParents[i] ? endParents[i - 1] : !startParents[i] ? startParents[i - 1] : endParents[i]).collapse(true);
        }
        tmpStart && domUtils.remove(tmpStart);
        tmpEnd && domUtils.remove(tmpEnd);
        return frag;
    }

    /**
     * 创建一个跟document绑定的空的Range实例
     * @constructor
     * @param { Document } document 新建的选区所属的文档对象
     */

    /**
     * @property { Node } startContainer 当前Range的开始边界的容器节点, 可以是一个元素节点或者是文本节点
     */

    /**
     * @property { Node } startOffset 当前Range的开始边界容器节点的偏移量, 如果是元素节点，
     *                              该值就是childNodes中的第几个节点， 如果是文本节点就是文本内容的第几个字符
     */

    /**
     * @property { Node } endContainer 当前Range的结束边界的容器节点, 可以是一个元素节点或者是文本节点
     */

    /**
     * @property { Node } endOffset 当前Range的结束边界容器节点的偏移量, 如果是元素节点，
     *                              该值就是childNodes中的第几个节点， 如果是文本节点就是文本内容的第几个字符
     */

    /**
     * @property { Boolean } collapsed 当前Range是否闭合
     * @default true
     * @remind Range是闭合的时候， startContainer === endContainer && startOffset === endOffset
     */

    /**
     * @property { Document } document 当前Range所属的Document对象
     * @remind 不同range的的document属性可以是不同的
     */
    var Range = dom.Range = function (document) {
        var me = this;
        me.startContainer =
            me.startOffset =
                me.endContainer =
                    me.endOffset = null;
        me.document = document;
        me.collapsed = true;
    };

    /**
     * 删除fillData
     * @param doc
     * @param excludeNode
     */
    function removeFillData(doc, excludeNode) {
        try {
            if (fillData && domUtils.inDoc(fillData, doc)) {
                if (!fillData.nodeValue.replace(fillCharReg, '').length) {
                    var tmpNode = fillData.parentNode;
                    domUtils.remove(fillData);
                    while (tmpNode && domUtils.isEmptyInlineElement(tmpNode) &&
                        //safari的contains有bug
                        (browser.safari ? !(domUtils.getPosition(tmpNode,excludeNode) & domUtils.POSITION_CONTAINS) : !tmpNode.contains(excludeNode))
                        ) {
                        fillData = tmpNode.parentNode;
                        domUtils.remove(tmpNode);
                        tmpNode = fillData;
                    }
                } else {
                    fillData.nodeValue = fillData.nodeValue.replace(fillCharReg, '');
                }
            }
        } catch (e) {
        }
    }

    /**
     * @param node
     * @param dir
     */
    function mergeSibling(node, dir) {
        var tmpNode;
        node = node[dir];
        while (node && domUtils.isFillChar(node)) {
            tmpNode = node[dir];
            domUtils.remove(node);
            node = tmpNode;
        }
    }

    Range.prototype = {

        /**
         * 克隆选区的内容到一个DocumentFragment里
         * @method cloneContents
         * @return { DocumentFragment | NULL } 如果选区是闭合的将返回null， 否则， 返回包含所clone内容的DocumentFragment元素
         * @example
         * ```html
         * <body>
         *      <!-- 中括号表示选区 -->
         *      <b>x<i>x[x</i>xx]x</b>
         *
         *      <script>
         *          //range是已选中的选区
         *          var fragment = range.cloneContents(),
         *              node = document.createElement("div");
         *
         *          node.appendChild( fragment );
         *
         *          //output: <i>x</i>xx
         *          console.log( node.innerHTML );
         *
         *      </script>
         * </body>
         * ```
         */
        cloneContents:function () {
            return this.collapsed ? null : execContentsAction(this, 0);
        },

        /**
         * 删除当前选区范围中的所有内容
         * @method deleteContents
         * @remind 执行完该操作后， 当前Range对象变成了闭合状态
         * @return { UE.dom.Range } 当前操作的Range对象
         * @example
         * ```html
         * <body>
         *      <!-- 中括号表示选区 -->
         *      <b>x<i>x[x</i>xx]x</b>
         *
         *      <script>
         *          //range是已选中的选区
         *          range.deleteContents();
         *
         *          //竖线表示闭合后的选区位置
         *          //output: <b>x<i>x</i>|x</b>
         *          console.log( document.body.innerHTML );
         *
         *          //此时， range的各项属性为
         *          //output: B
         *          console.log( range.startContainer.tagName );
         *          //output: 2
         *          console.log( range.startOffset );
         *          //output: B
         *          console.log( range.endContainer.tagName );
         *          //output: 2
         *          console.log( range.endOffset );
         *          //output: true
         *          console.log( range.collapsed );
         *
         *      </script>
         * </body>
         * ```
         */
        deleteContents:function () {
            var txt;
            if (!this.collapsed) {
                execContentsAction(this, 1);
            }
            if (browser.webkit) {
                txt = this.startContainer;
                if (txt.nodeType == 3 && !txt.nodeValue.length) {
                    this.setStartBefore(txt).collapse(true);
                    domUtils.remove(txt);
                }
            }
            return this;
        },

        /**
         * 将当前选区的内容提取到一个DocumentFragment里
         * @method extractContents
         * @remind 执行该操作后， 选区将变成闭合状态
         * @warning 执行该操作后， 原来选区所选中的内容将从dom树上剥离出来
         * @return { DocumentFragment } 返回包含所提取内容的DocumentFragment对象
         * @example
         * ```html
         * <body>
         *      <!-- 中括号表示选区 -->
         *      <b>x<i>x[x</i>xx]x</b>
         *
         *      <script>
         *          //range是已选中的选区
         *          var fragment = range.extractContents(),
         *              node = document.createElement( "div" );
         *
         *          node.appendChild( fragment );
         *
         *          //竖线表示闭合后的选区位置
         *
         *          //output: <b>x<i>x</i>|x</b>
         *          console.log( document.body.innerHTML );
         *          //output: <i>x</i>xx
         *          console.log( node.innerHTML );
         *
         *          //此时， range的各项属性为
         *          //output: B
         *          console.log( range.startContainer.tagName );
         *          //output: 2
         *          console.log( range.startOffset );
         *          //output: B
         *          console.log( range.endContainer.tagName );
         *          //output: 2
         *          console.log( range.endOffset );
         *          //output: true
         *          console.log( range.collapsed );
         *
         *      </script>
         * </body>
         */
        extractContents:function () {
            return this.collapsed ? null : execContentsAction(this, 2);
        },

        /**
         * 设置Range的开始容器节点和偏移量
         * @method  setStart
         * @remind 如果给定的节点是元素节点，那么offset指的是其子元素中索引为offset的元素，
         *          如果是文本节点，那么offset指的是其文本内容的第offset个字符
         * @remind 如果提供的容器节点是一个不能包含子元素的节点， 则该选区的开始容器将被设置
         *          为该节点的父节点， 此时， 其距离开始容器的偏移量也变成了该节点在其父节点
         *          中的索引
         * @param { Node } node 将被设为当前选区开始边界容器的节点对象
         * @param { int } offset 选区的开始位置偏移量
         * @return { UE.dom.Range } 当前range对象
         * @example
         * ```html
         * <!-- 选区 -->
         * <b>xxx<i>x<span>xx</span>xx<em>xx</em>xxx</i>[xxx]</b>
         *
         * <script>
         *
         *     //执行操作
         *     range.setStart( document.getElementsByTagName("i")[0], 1 );
         *
         *     //此时， 选区变成了
         *     //<b>xxx<i>x[<span>xx</span>xx<em>xx</em>xxx</i>xxx]</b>
         *
         * </script>
         * ```
         * @example
         * ```html
         * <!-- 选区 -->
         * <b>xxx<img>[xx]x</b>
         *
         * <script>
         *
         *     //执行操作
         *     range.setStart( document.getElementsByTagName("img")[0], 3 );
         *
         *     //此时， 选区变成了
         *     //<b>xxx[<img>xx]x</b>
         *
         * </script>
         * ```
         */
        setStart:function (node, offset) {
            return setEndPoint(true, node, offset, this);
        },

        /**
         * 设置Range的结束容器和偏移量
         * @method  setEnd
         * @param { Node } node 作为当前选区结束边界容器的节点对象
         * @param { int } offset 结束边界的偏移量
         * @see UE.dom.Range:setStart(Node,int)
         * @return { UE.dom.Range } 当前range对象
         */
        setEnd:function (node, offset) {
            return setEndPoint(false, node, offset, this);
        },

        /**
         * 将Range开始位置设置到node节点之后
         * @method  setStartAfter
         * @remind 该操作将会把给定节点的父节点作为range的开始容器， 且偏移量是该节点在其父节点中的位置索引+1
         * @param { Node } node 选区的开始边界将紧接着该节点之后
         * @return { UE.dom.Range } 当前range对象
         * @example
         * ```html
         * <!-- 选区示例 -->
         * <b>xx<i>xxx</i><span>xx[x</span>xxx]</b>
         *
         * <script>
         *
         *     //执行操作
         *     range.setStartAfter( document.getElementsByTagName("i")[0] );
         *
         *     //结果选区
         *     //<b>xx<i>xxx</i>[<span>xxx</span>xxx]</b>
         *
         * </script>
         * ```
         */
        setStartAfter:function (node) {
            return this.setStart(node.parentNode, domUtils.getNodeIndex(node) + 1);
        },

        /**
         * 将Range开始位置设置到node节点之前
         * @method  setStartBefore
         * @remind 该操作将会把给定节点的父节点作为range的开始容器， 且偏移量是该节点在其父节点中的位置索引
         * @param { Node } node 新的选区开始位置在该节点之前
         * @see UE.dom.Range:setStartAfter(Node)
         * @return { UE.dom.Range } 当前range对象
         */
        setStartBefore:function (node) {
            return this.setStart(node.parentNode, domUtils.getNodeIndex(node));
        },

        /**
         * 将Range结束位置设置到node节点之后
         * @method  setEndAfter
         * @remind 该操作将会把给定节点的父节点作为range的结束容器， 且偏移量是该节点在其父节点中的位置索引+1
         * @param { Node } node 目标节点
         * @see UE.dom.Range:setStartAfter(Node)
         * @return { UE.dom.Range } 当前range对象
         * @example
         * ```html
         * <!-- 选区示例 -->
         * <b>[xx<i>xxx</i><span>xx]x</span>xxx</b>
         *
         * <script>
         *
         *     //执行操作
         *     range.setStartAfter( document.getElementsByTagName("span")[0] );
         *
         *     //结果选区
         *     //<b>[xx<i>xxx</i><span>xxx</span>]xxx</b>
         *
         * </script>
         * ```
         */
        setEndAfter:function (node) {
            return this.setEnd(node.parentNode, domUtils.getNodeIndex(node) + 1);
        },

        /**
         * 将Range结束位置设置到node节点之前
         * @method  setEndBefore
         * @remind 该操作将会把给定节点的父节点作为range的结束容器， 且偏移量是该节点在其父节点中的位置索引
         * @param { Node } node 目标节点
         * @see UE.dom.Range:setEndAfter(Node)
         * @return { UE.dom.Range } 当前range对象
         */
        setEndBefore:function (node) {
            return this.setEnd(node.parentNode, domUtils.getNodeIndex(node));
        },

        /**
         * 设置Range的开始位置到node节点内的第一个子节点之前
         * @method  setStartAtFirst
         * @remind 选区的开始容器将变成给定的节点， 且偏移量为0
         * @remind 如果给定的节点是元素节点， 则该节点必须是允许包含子节点的元素。
         * @param { Node } node 目标节点
         * @see UE.dom.Range:setStartBefore(Node)
         * @return { UE.dom.Range } 当前range对象
         * @example
         * ```html
         * <!-- 选区示例 -->
         * <b>xx<i>xxx</i><span>[xx]x</span>xxx</b>
         *
         * <script>
         *
         *     //执行操作
         *     range.setStartAtFirst( document.getElementsByTagName("i")[0] );
         *
         *     //结果选区
         *     //<b>xx<i>[xxx</i><span>xx]x</span>xxx</b>
         *
         * </script>
         * ```
         */
        setStartAtFirst:function (node) {
            return this.setStart(node, 0);
        },

        /**
         * 设置Range的开始位置到node节点内的最后一个节点之后
         * @method setStartAtLast
         * @remind 选区的开始容器将变成给定的节点， 且偏移量为该节点的子节点数
         * @remind 如果给定的节点是元素节点， 则该节点必须是允许包含子节点的元素。
         * @param { Node } node 目标节点
         * @see UE.dom.Range:setStartAtFirst(Node)
         * @return { UE.dom.Range } 当前range对象
         */
        setStartAtLast:function (node) {
            return this.setStart(node, node.nodeType == 3 ? node.nodeValue.length : node.childNodes.length);
        },

        /**
         * 设置Range的结束位置到node节点内的第一个节点之前
         * @method  setEndAtFirst
         * @param { Node } node 目标节点
         * @remind 选区的结束容器将变成给定的节点， 且偏移量为0
         * @remind node必须是一个元素节点， 且必须是允许包含子节点的元素。
         * @see UE.dom.Range:setStartAtFirst(Node)
         * @return { UE.dom.Range } 当前range对象
         */
        setEndAtFirst:function (node) {
            return this.setEnd(node, 0);
        },

        /**
         * 设置Range的结束位置到node节点内的最后一个节点之后
         * @method  setEndAtLast
         * @param { Node } node 目标节点
         * @remind 选区的结束容器将变成给定的节点， 且偏移量为该节点的子节点数量
         * @remind node必须是一个元素节点， 且必须是允许包含子节点的元素。
         * @see UE.dom.Range:setStartAtFirst(Node)
         * @return { UE.dom.Range } 当前range对象
         */
        setEndAtLast:function (node) {
            return this.setEnd(node, node.nodeType == 3 ? node.nodeValue.length : node.childNodes.length);
        },

        /**
         * 选中给定节点
         * @method  selectNode
         * @remind 此时， 选区的开始容器和结束容器都是该节点的父节点， 其startOffset是该节点在父节点中的位置索引，
         *          而endOffset为startOffset+1
         * @param { Node } node 需要选中的节点
         * @return { UE.dom.Range } 当前range对象，此时的range仅包含当前给定的节点对象
         * @example
         * ```html
         * <!-- 选区示例 -->
         * <b>xx<i>xxx</i><span>[xx]x</span>xxx</b>
         *
         * <script>
         *
         *     //执行操作
         *     range.selectNode( document.getElementsByTagName("i")[0] );
         *
         *     //结果选区
         *     //<b>xx[<i>xxx</i>]<span>xxx</span>xxx</b>
         *
         * </script>
         * ```
         */
        selectNode:function (node) {
            return this.setStartBefore(node).setEndAfter(node);
        },

        /**
         * 选中给定节点内部的所有节点
         * @method  selectNodeContents
         * @remind 此时， 选区的开始容器和结束容器都是该节点， 其startOffset为0，
         *          而endOffset是该节点的子节点数。
         * @param { Node } node 目标节点， 当前range将包含该节点内的所有节点
         * @return { UE.dom.Range } 当前range对象， 此时range仅包含给定节点的所有子节点
         * @example
         * ```html
         * <!-- 选区示例 -->
         * <b>xx<i>xxx</i><span>[xx]x</span>xxx</b>
         *
         * <script>
         *
         *     //执行操作
         *     range.selectNode( document.getElementsByTagName("b")[0] );
         *
         *     //结果选区
         *     //<b>[xx<i>xxx</i><span>xxx</span>xxx]</b>
         *
         * </script>
         * ```
         */
        selectNodeContents:function (node) {
            return this.setStart(node, 0).setEndAtLast(node);
        },

        /**
         * clone当前Range对象
         * @method  cloneRange
         * @remind 返回的range是一个全新的range对象， 其内部所有属性与当前被clone的range相同。
         * @return { UE.dom.Range } 当前range对象的一个副本
         */
        cloneRange:function () {
            var me = this;
            return new Range(me.document).setStart(me.startContainer, me.startOffset).setEnd(me.endContainer, me.endOffset);

        },

        /**
         * 向当前选区的结束处闭合选区
         * @method  collapse
         * @return { UE.dom.Range } 当前range对象
         * @example
         * ```html
         * <!-- 选区示例 -->
         * <b>xx<i>xxx</i><span>[xx]x</span>xxx</b>
         *
         * <script>
         *
         *     //执行操作
         *     range.collapse();
         *
         *     //结果选区
         *     //“|”表示选区已闭合
         *     //<b>xx<i>xxx</i><span>xx|x</span>xxx</b>
         *
         * </script>
         * ```
         */

        /**
         * 闭合当前选区，根据给定的toStart参数项决定是向当前选区开始处闭合还是向结束处闭合，
         * 如果toStart的值为true，则向开始位置闭合， 反之，向结束位置闭合。
         * @method  collapse
         * @param { Boolean } toStart 是否向选区开始处闭合
         * @return { UE.dom.Range } 当前range对象，此时range对象处于闭合状态
         * @see UE.dom.Range:collapse()
         * @example
         * ```html
         * <!-- 选区示例 -->
         * <b>xx<i>xxx</i><span>[xx]x</span>xxx</b>
         *
         * <script>
         *
         *     //执行操作
         *     range.collapse( true );
         *
         *     //结果选区
         *     //“|”表示选区已闭合
         *     //<b>xx<i>xxx</i><span>|xxx</span>xxx</b>
         *
         * </script>
         * ```
         */
        collapse:function (toStart) {
            var me = this;
            if (toStart) {
                me.endContainer = me.startContainer;
                me.endOffset = me.startOffset;
            } else {
                me.startContainer = me.endContainer;
                me.startOffset = me.endOffset;
            }
            me.collapsed = true;
            return me;
        },

        /**
         * 调整range的开始位置和结束位置，使其"收缩"到最小的位置
         * @method  shrinkBoundary
         * @return { UE.dom.Range } 当前range对象
         * @example
         * ```html
         * <span>xx<b>xx[</b>xxxxx]</span> => <span>xx<b>xx</b>[xxxxx]</span>
         * ```
         *
         * @example
         * ```html
         * <!-- 选区示例 -->
         * <b>x[xx</b><i>]xxx</i>
         *
         * <script>
         *
         *     //执行收缩
         *     range.shrinkBoundary();
         *
         *     //结果选区
         *     //<b>x[xx]</b><i>xxx</i>
         * </script>
         * ```
         *
         * @example
         * ```html
         * [<b><i>xxxx</i>xxxxxxx</b>] => <b><i>[xxxx</i>xxxxxxx]</b>
         * ```
         */

        /**
         * 调整range的开始位置和结束位置，使其"收缩"到最小的位置，
         * 如果ignoreEnd的值为true，则忽略对结束位置的调整
         * @method  shrinkBoundary
         * @param { Boolean } ignoreEnd 是否忽略对结束位置的调整
         * @return { UE.dom.Range } 当前range对象
         * @see UE.dom.domUtils.Range:shrinkBoundary()
         */
        shrinkBoundary:function (ignoreEnd) {
            var me = this, child,
                collapsed = me.collapsed;
            function check(node){
                return node.nodeType == 1 && !domUtils.isBookmarkNode(node) && !dtd.$empty[node.tagName] && !dtd.$nonChild[node.tagName]
            }
            while (me.startContainer.nodeType == 1 //是element
                && (child = me.startContainer.childNodes[me.startOffset]) //子节点也是element
                && check(child)) {
                me.setStart(child, 0);
            }
            if (collapsed) {
                return me.collapse(true);
            }
            if (!ignoreEnd) {
                while (me.endContainer.nodeType == 1//是element
                    && me.endOffset > 0 //如果是空元素就退出 endOffset=0那么endOffst-1为负值，childNodes[endOffset]报错
                    && (child = me.endContainer.childNodes[me.endOffset - 1]) //子节点也是element
                    && check(child)) {
                    me.setEnd(child, child.childNodes.length);
                }
            }
            return me;
        },

        /**
         * 获取离当前选区内包含的所有节点最近的公共祖先节点，
         * @method  getCommonAncestor
         * @remind 返回的公共祖先节点一定不是range自身的容器节点， 但有可能是一个文本节点
         * @return { Node } 当前range对象内所有节点的公共祖先节点
         * @example
         * ```html
         * //选区示例
         * <span>xxx<b>x[x<em>xx]x</em>xxx</b>xx</span>
         * <script>
         *
         *     var node = range.getCommonAncestor();
         *
         *     //公共祖先节点是： b节点
         *     //输出： B
         *     console.log(node.tagName);
         *
         * </script>
         * ```
         */

        /**
         * 获取当前选区所包含的所有节点的公共祖先节点， 可以根据给定的参数 includeSelf 决定获取到
         * 的公共祖先节点是否可以是当前选区的startContainer或endContainer节点， 如果 includeSelf
         * 的取值为true， 则返回的节点可以是自身的容器节点， 否则， 则不能是容器节点
         * @method  getCommonAncestor
         * @param { Boolean } includeSelf 是否允许获取到的公共祖先节点是当前range对象的容器节点
         * @return { Node } 当前range对象内所有节点的公共祖先节点
         * @see UE.dom.Range:getCommonAncestor()
         * @example
         * ```html
         * <body>
         *
         *     <!-- 选区示例 -->
         *     <b>xxx<i>xxxx<span>xx[x</span>xx]x</i>xxxxxxx</b>
         *
         *     <script>
         *
         *         var node = range.getCommonAncestor( false );
         *
         *         //这里的公共祖先节点是B而不是I， 是因为参数限制了获取到的节点不能是容器节点
         *         //output: B
         *         console.log( node.tagName );
         *
         *     </script>
         *
         * </body>
         * ```
         */

        /**
         * 获取当前选区所包含的所有节点的公共祖先节点， 可以根据给定的参数 includeSelf 决定获取到
         * 的公共祖先节点是否可以是当前选区的startContainer或endContainer节点， 如果 includeSelf
         * 的取值为true， 则返回的节点可以是自身的容器节点， 否则， 则不能是容器节点； 同时可以根据
         * ignoreTextNode 参数的取值决定是否忽略类型为文本节点的祖先节点。
         * @method  getCommonAncestor
         * @param { Boolean } includeSelf 是否允许获取到的公共祖先节点是当前range对象的容器节点
         * @param { Boolean } ignoreTextNode 获取祖先节点的过程中是否忽略类型为文本节点的祖先节点
         * @return { Node } 当前range对象内所有节点的公共祖先节点
         * @see UE.dom.Range:getCommonAncestor()
         * @see UE.dom.Range:getCommonAncestor(Boolean)
         * @example
         * ```html
         * <body>
         *
         *     <!-- 选区示例 -->
         *     <b>xxx<i>xxxx<span>x[x]x</span>xxx</i>xxxxxxx</b>
         *
         *     <script>
         *
         *         var node = range.getCommonAncestor( true, false );
         *
         *         //output: SPAN
         *         console.log( node.tagName );
         *
         *     </script>
         *
         * </body>
         * ```
         */
        getCommonAncestor:function (includeSelf, ignoreTextNode) {
            var me = this,
                start = me.startContainer,
                end = me.endContainer;
            if (start === end) {
                if (includeSelf && selectOneNode(this)) {
                    start = start.childNodes[me.startOffset];
                    if(start.nodeType == 1)
                        return start;
                }
                //只有在上来就相等的情况下才会出现是文本的情况
                return ignoreTextNode && start.nodeType == 3 ? start.parentNode : start;
            }
            return domUtils.getCommonAncestor(start, end);
        },

        /**
         * 调整当前Range的开始和结束边界容器，如果是容器节点是文本节点,就调整到包含该文本节点的父节点上
         * @method trimBoundary
         * @remind 该操作有可能会引起文本节点被切开
         * @return { UE.dom.Range } 当前range对象
         * @example
         * ```html
         *
         * //选区示例
         * <b>xxx<i>[xxxxx]</i>xxx</b>
         *
         * <script>
         *     //未调整前， 选区的开始容器和结束都是文本节点
         *     //执行调整
         *     range.trimBoundary();
         *
         *     //调整之后， 容器节点变成了i节点
         *     //<b>xxx[<i>xxxxx</i>]xxx</b>
         * </script>
         * ```
         */

        /**
         * 调整当前Range的开始和结束边界容器，如果是容器节点是文本节点,就调整到包含该文本节点的父节点上，
         * 可以根据 ignoreEnd 参数的值决定是否调整对结束边界的调整
         * @method trimBoundary
         * @param { Boolean } ignoreEnd 是否忽略对结束边界的调整
         * @return { UE.dom.Range } 当前range对象
         * @example
         * ```html
         *
         * //选区示例
         * <b>xxx<i>[xxxxx]</i>xxx</b>
         *
         * <script>
         *     //未调整前， 选区的开始容器和结束都是文本节点
         *     //执行调整
         *     range.trimBoundary( true );
         *
         *     //调整之后， 开始容器节点变成了i节点
         *     //但是， 结束容器没有发生变化
         *     //<b>xxx[<i>xxxxx]</i>xxx</b>
         * </script>
         * ```
         */
        trimBoundary:function (ignoreEnd) {
            this.txtToElmBoundary();
            var start = this.startContainer,
                offset = this.startOffset,
                collapsed = this.collapsed,
                end = this.endContainer;
            if (start.nodeType == 3) {
                if (offset == 0) {
                    this.setStartBefore(start);
                } else {
                    if (offset >= start.nodeValue.length) {
                        this.setStartAfter(start);
                    } else {
                        var textNode = domUtils.split(start, offset);
                        //跟新结束边界
                        if (start === end) {
                            this.setEnd(textNode, this.endOffset - offset);
                        } else if (start.parentNode === end) {
                            this.endOffset += 1;
                        }
                        this.setStartBefore(textNode);
                    }
                }
                if (collapsed) {
                    return this.collapse(true);
                }
            }
            if (!ignoreEnd) {
                offset = this.endOffset;
                end = this.endContainer;
                if (end.nodeType == 3) {
                    if (offset == 0) {
                        this.setEndBefore(end);
                    } else {
                        offset < end.nodeValue.length && domUtils.split(end, offset);
                        this.setEndAfter(end);
                    }
                }
            }
            return this;
        },

        /**
         * 如果选区在文本的边界上，就扩展选区到文本的父节点上, 如果当前选区是闭合的， 则什么也不做
         * @method txtToElmBoundary
         * @remind 该操作不会修改dom节点
         * @return { UE.dom.Range } 当前range对象
         */

        /**
         * 如果选区在文本的边界上，就扩展选区到文本的父节点上, 如果当前选区是闭合的， 则根据参数项
         * ignoreCollapsed 的值决定是否执行该调整
         * @method txtToElmBoundary
         * @param { Boolean } ignoreCollapsed 是否忽略选区的闭合状态， 如果该参数取值为true， 则
         *                      不论选区是否闭合， 都会执行该操作， 反之， 则不会对闭合的选区执行该操作
         * @return { UE.dom.Range } 当前range对象
         */
        txtToElmBoundary:function (ignoreCollapsed) {
            function adjust(r, c) {
                var container = r[c + 'Container'],
                    offset = r[c + 'Offset'];
                if (container.nodeType == 3) {
                    if (!offset) {
                        r['set' + c.replace(/(\w)/, function (a) {
                            return a.toUpperCase();
                        }) + 'Before'](container);
                    } else if (offset >= container.nodeValue.length) {
                        r['set' + c.replace(/(\w)/, function (a) {
                            return a.toUpperCase();
                        }) + 'After' ](container);
                    }
                }
            }

            if (ignoreCollapsed || !this.collapsed) {
                adjust(this, 'start');
                adjust(this, 'end');
            }
            return this;
        },

        /**
         * 在当前选区的开始位置前插入节点，新插入的节点会被该range包含
         * @method  insertNode
         * @param { Node } node 需要插入的节点
         * @remind 插入的节点可以是一个DocumentFragment依次插入多个节点
         * @return { UE.dom.Range } 当前range对象
         */
        insertNode:function (node) {
            var first = node, length = 1;
            if (node.nodeType == 11) {
                first = node.firstChild;
                length = node.childNodes.length;
            }
            this.trimBoundary(true);
            var start = this.startContainer,
                offset = this.startOffset;
            var nextNode = start.childNodes[ offset ];
            if (nextNode) {
                start.insertBefore(node, nextNode);
            } else {
                start.appendChild(node);
            }
            if (first.parentNode === this.endContainer) {
                this.endOffset = this.endOffset + length;
            }
            return this.setStartBefore(first);
        },

        /**
         * 闭合选区到当前选区的开始位置， 并且定位光标到闭合后的位置
         * @method  setCursor
         * @return { UE.dom.Range } 当前range对象
         * @see UE.dom.Range:collapse()
         */

        /**
         * 闭合选区，可以根据参数toEnd的值控制选区是向前闭合还是向后闭合， 并且定位光标到闭合后的位置。
         * @method  setCursor
         * @param { Boolean } toEnd 是否向后闭合， 如果为true， 则闭合选区时， 将向结束容器方向闭合，
         *                      反之，则向开始容器方向闭合
         * @return { UE.dom.Range } 当前range对象
         * @see UE.dom.Range:collapse(Boolean)
         */
        setCursor:function (toEnd, noFillData) {
            return this.collapse(!toEnd).select(noFillData);
        },

        /**
         * 创建当前range的一个书签，记录下当前range的位置，方便当dom树改变时，还能找回原来的选区位置
         * @method createBookmark
         * @param { Boolean } serialize 控制返回的标记位置是对当前位置的引用还是ID，如果该值为true，则
         *                              返回标记位置的ID， 反之则返回标记位置节点的引用
         * @return { Object } 返回一个书签记录键值对， 其包含的key有： start => 开始标记的ID或者引用，
         *                          end => 结束标记的ID或引用， id => 当前标记的类型， 如果为true，则表示
         *                          返回的记录的类型为ID， 反之则为引用
         */
        createBookmark:function (serialize, same) {
            var endNode,
                startNode = this.document.createElement('span');
            startNode.style.cssText = 'display:none;line-height:0px;';
            startNode.appendChild(this.document.createTextNode('\u200D'));
            startNode.id = '_baidu_bookmark_start_' + (same ? '' : guid++);

            if (!this.collapsed) {
                endNode = startNode.cloneNode(true);
                endNode.id = '_baidu_bookmark_end_' + (same ? '' : guid++);
            }
            this.insertNode(startNode);
            if (endNode) {
                this.collapse().insertNode(endNode).setEndBefore(endNode);
            }
            this.setStartAfter(startNode);
            return {
                start:serialize ? startNode.id : startNode,
                end:endNode ? serialize ? endNode.id : endNode : null,
                id:serialize
            }
        },

        /**
         *  调整当前range的边界到书签位置，并删除该书签对象所标记的位置内的节点
         *  @method  moveToBookmark
         *  @param { BookMark } bookmark createBookmark所创建的标签对象
         *  @return { UE.dom.Range } 当前range对象
         *  @see UE.dom.Range:createBookmark(Boolean)
         */
        moveToBookmark:function (bookmark) {
            var start = bookmark.id ? this.document.getElementById(bookmark.start) : bookmark.start,
                end = bookmark.end && bookmark.id ? this.document.getElementById(bookmark.end) : bookmark.end;
            this.setStartBefore(start);
            domUtils.remove(start);
            if (end) {
                this.setEndBefore(end);
                domUtils.remove(end);
            } else {
                this.collapse(true);
            }
            return this;
        },

        /**
         * 调整range的边界，使其"放大"到最近的父节点
         * @method  enlarge
         * @remind 会引起选区的变化
         * @return { UE.dom.Range } 当前range对象
         */

        /**
         * 调整range的边界，使其"放大"到最近的父节点，根据参数 toBlock 的取值， 可以
         * 要求扩大之后的父节点是block节点
         * @method  enlarge
         * @param { Boolean } toBlock 是否要求扩大之后的父节点必须是block节点
         * @return { UE.dom.Range } 当前range对象
         */
        enlarge:function (toBlock, stopFn) {
            var isBody = domUtils.isBody,
                pre, node, tmp = this.document.createTextNode('');
            if (toBlock) {
                node = this.startContainer;
                if (node.nodeType == 1) {
                    if (node.childNodes[this.startOffset]) {
                        pre = node = node.childNodes[this.startOffset]
                    } else {
                        node.appendChild(tmp);
                        pre = node = tmp;
                    }
                } else {
                    pre = node;
                }
                while (1) {
                    if (domUtils.isBlockElm(node)) {
                        node = pre;
                        while ((pre = node.previousSibling) && !domUtils.isBlockElm(pre)) {
                            node = pre;
                        }
                        this.setStartBefore(node);
                        break;
                    }
                    pre = node;
                    node = node.parentNode;
                }
                node = this.endContainer;
                if (node.nodeType == 1) {
                    if (pre = node.childNodes[this.endOffset]) {
                        node.insertBefore(tmp, pre);
                    } else {
                        node.appendChild(tmp);
                    }
                    pre = node = tmp;
                } else {
                    pre = node;
                }
                while (1) {
                    if (domUtils.isBlockElm(node)) {
                        node = pre;
                        while ((pre = node.nextSibling) && !domUtils.isBlockElm(pre)) {
                            node = pre;
                        }
                        this.setEndAfter(node);
                        break;
                    }
                    pre = node;
                    node = node.parentNode;
                }
                if (tmp.parentNode === this.endContainer) {
                    this.endOffset--;
                }
                domUtils.remove(tmp);
            }

            // 扩展边界到最大
            if (!this.collapsed) {
                while (this.startOffset == 0) {
                    if (stopFn && stopFn(this.startContainer)) {
                        break;
                    }
                    if (isBody(this.startContainer)) {
                        break;
                    }
                    this.setStartBefore(this.startContainer);
                }
                while (this.endOffset == (this.endContainer.nodeType == 1 ? this.endContainer.childNodes.length : this.endContainer.nodeValue.length)) {
                    if (stopFn && stopFn(this.endContainer)) {
                        break;
                    }
                    if (isBody(this.endContainer)) {
                        break;
                    }
                    this.setEndAfter(this.endContainer);
                }
            }
            return this;
        },
        enlargeToBlockElm:function(ignoreEnd){
            while(!domUtils.isBlockElm(this.startContainer)){
                this.setStartBefore(this.startContainer);
            }
            if(!ignoreEnd){
                while(!domUtils.isBlockElm(this.endContainer)){
                    this.setEndAfter(this.endContainer);
                }
            }
            return this;
        },
        /**
         * 调整Range的边界，使其"缩小"到最合适的位置
         * @method adjustmentBoundary
         * @return { UE.dom.Range } 当前range对象
         * @see UE.dom.Range:shrinkBoundary()
         */
        adjustmentBoundary:function () {
            if (!this.collapsed) {
                while (!domUtils.isBody(this.startContainer) &&
                    this.startOffset == this.startContainer[this.startContainer.nodeType == 3 ? 'nodeValue' : 'childNodes'].length &&
                    this.startContainer[this.startContainer.nodeType == 3 ? 'nodeValue' : 'childNodes'].length
                    ) {

                    this.setStartAfter(this.startContainer);
                }
                while (!domUtils.isBody(this.endContainer) && !this.endOffset &&
                    this.endContainer[this.endContainer.nodeType == 3 ? 'nodeValue' : 'childNodes'].length
                    ) {
                    this.setEndBefore(this.endContainer);
                }
            }
            return this;
        },

        /**
         * 给range选区中的内容添加给定的inline标签
         * @method applyInlineStyle
         * @param { String } tagName 需要添加的标签名
         * @example
         * ```html
         * <p>xxxx[xxxx]x</p>  ==>  range.applyInlineStyle("strong")  ==>  <p>xxxx[<strong>xxxx</strong>]x</p>
         * ```
         */

        /**
         * 给range选区中的内容添加给定的inline标签， 并且为标签附加上一些初始化属性。
         * @method applyInlineStyle
         * @param { String } tagName 需要添加的标签名
         * @param { Object } attrs 跟随新添加的标签的属性
         * @return { UE.dom.Range } 当前选区
         * @example
         * ```html
         * <p>xxxx[xxxx]x</p>
         *
         * ==>
         *
         * <!-- 执行操作 -->
         * range.applyInlineStyle("strong",{"style":"font-size:12px"})
         *
         * ==>
         *
         * <p>xxxx[<strong style="font-size:12px">xxxx</strong>]x</p>
         * ```
         */
        applyInlineStyle:function (tagName, attrs, list) {
            if (this.collapsed)return this;
            this.trimBoundary().enlarge(false,
                function (node) {
                    return node.nodeType == 1 && domUtils.isBlockElm(node)
                }).adjustmentBoundary();
            var bookmark = this.createBookmark(),
                end = bookmark.end,
                filterFn = function (node) {
                    return node.nodeType == 1 ? node.tagName.toLowerCase() != 'br' : !domUtils.isWhitespace(node);
                },
                current = domUtils.getNextDomNode(bookmark.start, false, filterFn),
                node,
                pre,
                range = this.cloneRange();
            while (current && (domUtils.getPosition(current, end) & domUtils.POSITION_PRECEDING)) {
                if (current.nodeType == 3 || dtd[tagName][current.tagName]) {
                    range.setStartBefore(current);
                    node = current;
                    while (node && (node.nodeType == 3 || dtd[tagName][node.tagName]) && node !== end) {
                        pre = node;
                        node = domUtils.getNextDomNode(node, node.nodeType == 1, null, function (parent) {
                            return dtd[tagName][parent.tagName];
                        });
                    }
                    var frag = range.setEndAfter(pre).extractContents(), elm;
                    if (list && list.length > 0) {
                        var level, top;
                        top = level = list[0].cloneNode(false);
                        for (var i = 1, ci; ci = list[i++];) {
                            level.appendChild(ci.cloneNode(false));
                            level = level.firstChild;
                        }
                        elm = level;
                    } else {
                        elm = range.document.createElement(tagName);
                    }
                    if (attrs) {
                        domUtils.setAttributes(elm, attrs);
                    }
                    elm.appendChild(frag);
                    range.insertNode(list ? top : elm);
                    //处理下滑线在a上的情况
                    var aNode;
                    if (tagName == 'span' && attrs.style && /text\-decoration/.test(attrs.style) && (aNode = domUtils.findParentByTagName(elm, 'a', true))) {
                        domUtils.setAttributes(aNode, attrs);
                        domUtils.remove(elm, true);
                        elm = aNode;
                    } else {
                        domUtils.mergeSibling(elm);
                        domUtils.clearEmptySibling(elm);
                    }
                    //去除子节点相同的
                    domUtils.mergeChild(elm, attrs);
                    current = domUtils.getNextDomNode(elm, false, filterFn);
                    domUtils.mergeToParent(elm);
                    if (node === end) {
                        break;
                    }
                } else {
                    current = domUtils.getNextDomNode(current, true, filterFn);
                }
            }
            return this.moveToBookmark(bookmark);
        },

        /**
         * 移除当前选区内指定的inline标签，但保留其中的内容
         * @method removeInlineStyle
         * @param { String } tagName 需要移除的标签名
         * @return { UE.dom.Range } 当前的range对象
         * @example
         * ```html
         * xx[x<span>xxx<em>yyy</em>zz]z</span>  => range.removeInlineStyle(["em"])  => xx[x<span>xxxyyyzz]z</span>
         * ```
         */

        /**
         * 移除当前选区内指定的一组inline标签，但保留其中的内容
         * @method removeInlineStyle
         * @param { Array } tagNameArr 需要移除的标签名的数组
         * @return { UE.dom.Range } 当前的range对象
         * @see UE.dom.Range:removeInlineStyle(String)
         */
        removeInlineStyle:function (tagNames) {
            if (this.collapsed)return this;
            tagNames = utils.isArray(tagNames) ? tagNames : [tagNames];
            this.shrinkBoundary().adjustmentBoundary();
            var start = this.startContainer, end = this.endContainer;
            while (1) {
                if (start.nodeType == 1) {
                    if (utils.indexOf(tagNames, start.tagName.toLowerCase()) > -1) {
                        break;
                    }
                    if (start.tagName.toLowerCase() == 'body') {
                        start = null;
                        break;
                    }
                }
                start = start.parentNode;
            }
            while (1) {
                if (end.nodeType == 1) {
                    if (utils.indexOf(tagNames, end.tagName.toLowerCase()) > -1) {
                        break;
                    }
                    if (end.tagName.toLowerCase() == 'body') {
                        end = null;
                        break;
                    }
                }
                end = end.parentNode;
            }
            var bookmark = this.createBookmark(),
                frag,
                tmpRange;
            if (start) {
                tmpRange = this.cloneRange().setEndBefore(bookmark.start).setStartBefore(start);
                frag = tmpRange.extractContents();
                tmpRange.insertNode(frag);
                domUtils.clearEmptySibling(start, true);
                start.parentNode.insertBefore(bookmark.start, start);
            }
            if (end) {
                tmpRange = this.cloneRange().setStartAfter(bookmark.end).setEndAfter(end);
                frag = tmpRange.extractContents();
                tmpRange.insertNode(frag);
                domUtils.clearEmptySibling(end, false, true);
                end.parentNode.insertBefore(bookmark.end, end.nextSibling);
            }
            var current = domUtils.getNextDomNode(bookmark.start, false, function (node) {
                return node.nodeType == 1;
            }), next;
            while (current && current !== bookmark.end) {
                next = domUtils.getNextDomNode(current, true, function (node) {
                    return node.nodeType == 1;
                });
                if (utils.indexOf(tagNames, current.tagName.toLowerCase()) > -1) {
                    domUtils.remove(current, true);
                }
                current = next;
            }
            return this.moveToBookmark(bookmark);
        },

        /**
         * 获取当前选中的自闭合的节点
         * @method  getClosedNode
         * @return { Node | NULL } 如果当前选中的是自闭合节点， 则返回该节点， 否则返回NULL
         */
        getClosedNode:function () {
            var node;
            if (!this.collapsed) {
                var range = this.cloneRange().adjustmentBoundary().shrinkBoundary();
                if (selectOneNode(range)) {
                    var child = range.startContainer.childNodes[range.startOffset];
                    if (child && child.nodeType == 1 && (dtd.$empty[child.tagName] || dtd.$nonChild[child.tagName])) {
                        node = child;
                    }
                }
            }
            return node;
        },

        /**
         * 在页面上高亮range所表示的选区
         * @method select
         * @return { UE.dom.Range } 返回当前Range对象
         */
            //这里不区分ie9以上，trace:3824
        select:browser.ie ? function (noFillData, textRange) {
            var nativeRange;
            if (!this.collapsed)
                this.shrinkBoundary();
            var node = this.getClosedNode();
            if (node && !textRange) {
                try {
                    nativeRange = this.document.body.createControlRange();
                    nativeRange.addElement(node);
                    nativeRange.select();
                } catch (e) {}
                return this;
            }
            var bookmark = this.createBookmark(),
                start = bookmark.start,
                end;
            nativeRange = this.document.body.createTextRange();
            nativeRange.moveToElementText(start);
            nativeRange.moveStart('character', 1);
            if (!this.collapsed) {
                var nativeRangeEnd = this.document.body.createTextRange();
                end = bookmark.end;
                nativeRangeEnd.moveToElementText(end);
                nativeRange.setEndPoint('EndToEnd', nativeRangeEnd);
            } else {
                if (!noFillData && this.startContainer.nodeType != 3) {
                    //使用<span>|x<span>固定住光标
                    var tmpText = this.document.createTextNode(fillChar),
                        tmp = this.document.createElement('span');
                    tmp.appendChild(this.document.createTextNode(fillChar));
                    start.parentNode.insertBefore(tmp, start);
                    start.parentNode.insertBefore(tmpText, start);
                    //当点b,i,u时，不能清除i上边的b
                    removeFillData(this.document, tmpText);
                    fillData = tmpText;
                    mergeSibling(tmp, 'previousSibling');
                    mergeSibling(start, 'nextSibling');
                    nativeRange.moveStart('character', -1);
                    nativeRange.collapse(true);
                }
            }
            this.moveToBookmark(bookmark);
            tmp && domUtils.remove(tmp);
            //IE在隐藏状态下不支持range操作，catch一下
            try {
                nativeRange.select();
            } catch (e) {
            }
            return this;
        } : function (notInsertFillData) {
            function checkOffset(rng){

                function check(node,offset,dir){
                    if(node.nodeType == 3 && node.nodeValue.length < offset){
                        rng[dir + 'Offset'] = node.nodeValue.length
                    }
                }
                check(rng.startContainer,rng.startOffset,'start');
                check(rng.endContainer,rng.endOffset,'end');
            }
            var win = domUtils.getWindow(this.document),
                sel = win.getSelection(),
                txtNode;
            //FF下关闭自动长高时滚动条在关闭dialog时会跳
            //ff下如果不body.focus将不能定位闭合光标到编辑器内
            browser.gecko ? this.document.body.focus() : win.focus();
            if (sel) {
                sel.removeAllRanges();
                // trace:870 chrome/safari后边是br对于闭合得range不能定位 所以去掉了判断
                // this.startContainer.nodeType != 3 &&! ((child = this.startContainer.childNodes[this.startOffset]) && child.nodeType == 1 && child.tagName == 'BR'
                if (this.collapsed && !notInsertFillData) {
//                    //opear如果没有节点接着，原生的不能够定位,不能在body的第一级插入空白节点
//                    if (notInsertFillData && browser.opera && !domUtils.isBody(this.startContainer) && this.startContainer.nodeType == 1) {
//                        var tmp = this.document.createTextNode('');
//                        this.insertNode(tmp).setStart(tmp, 0).collapse(true);
//                    }
//
                    //处理光标落在文本节点的情况
                    //处理以下的情况
                    //<b>|xxxx</b>
                    //<b>xxxx</b>|xxxx
                    //xxxx<b>|</b>
                    var start = this.startContainer,child = start;
                    if(start.nodeType == 1){
                        child = start.childNodes[this.startOffset];

                    }
                    if( !(start.nodeType == 3 && this.startOffset)  &&
                        (child ?
                            (!child.previousSibling || child.previousSibling.nodeType != 3)
                            :
                            (!start.lastChild || start.lastChild.nodeType != 3)
                        )
                    ){
                        txtNode = this.document.createTextNode(fillChar);
                        //跟着前边走
                        this.insertNode(txtNode);
                        removeFillData(this.document, txtNode);
                        mergeSibling(txtNode, 'previousSibling');
                        mergeSibling(txtNode, 'nextSibling');
                        fillData = txtNode;
                        this.setStart(txtNode, browser.webkit ? 1 : 0).collapse(true);
                    }
                }
                var nativeRange = this.document.createRange();
                if(this.collapsed && browser.opera && this.startContainer.nodeType == 1){
                    var child = this.startContainer.childNodes[this.startOffset];
                    if(!child){
                        //往前靠拢
                        child = this.startContainer.lastChild;
                        if( child && domUtils.isBr(child)){
                            this.setStartBefore(child).collapse(true);
                        }
                    }else{
                        //向后靠拢
                        while(child && domUtils.isBlockElm(child)){
                            if(child.nodeType == 1 && child.childNodes[0]){
                                child = child.childNodes[0]
                            }else{
                                break;
                            }
                        }
                        child && this.setStartBefore(child).collapse(true)
                    }

                }
                //是createAddress最后一位算的不准，现在这里进行微调
                checkOffset(this);
                nativeRange.setStart(this.startContainer, this.startOffset);
                nativeRange.setEnd(this.endContainer, this.endOffset);
                sel.addRange(nativeRange);
            }
            return this;
        },

        /**
         * 滚动到当前range开始的位置
         * @method scrollToView
         * @param { Window } win 当前range对象所属的window对象
         * @return { UE.dom.Range } 当前Range对象
         */

        /**
         * 滚动到距离当前range开始位置 offset 的位置处
         * @method scrollToView
         * @param { Window } win 当前range对象所属的window对象
         * @param { Number } offset 距离range开始位置处的偏移量， 如果为正数， 则向下偏移， 反之， 则向上偏移
         * @return { UE.dom.Range } 当前Range对象
         */
        scrollToView:function (win, offset) {
            win = win ? window : domUtils.getWindow(this.document);
            var me = this,
                span = me.document.createElement('span');
            //trace:717
            span.innerHTML = '&nbsp;';
            me.cloneRange().insertNode(span);
            domUtils.scrollToView(span, win, offset);
            domUtils.remove(span);
            return me;
        },

        /**
         * 判断当前选区内容是否占位符
         * @private
         * @method inFillChar
         * @return { Boolean } 如果是占位符返回true，否则返回false
         */
        inFillChar : function(){
            var start = this.startContainer;
            if(this.collapsed && start.nodeType == 3
                && start.nodeValue.replace(new RegExp('^' + domUtils.fillChar),'').length + 1 == start.nodeValue.length
                ){
                return true;
            }
            return false;
        },

        /**
         * 保存
         * @method createAddress
         * @private
         * @return { Boolean } 返回开始和结束的位置
         * @example
         * ```html
         * <body>
         *     <p>
         *         aaaa
         *         <em>
         *             <!-- 选区开始 -->
         *             bbbb
         *             <!-- 选区结束 -->
         *         </em>
         *     </p>
         *
         *     <script>
         *         //output: {startAddress:[0,1,0,0],endAddress:[0,1,0,4]}
         *         console.log( range.createAddress() );
         *     </script>
         * </body>
         * ```
         */
        createAddress : function(ignoreEnd,ignoreTxt){
            var addr = {},me = this;

            function getAddress(isStart){
                var node = isStart ? me.startContainer : me.endContainer;
                var parents = domUtils.findParents(node,true,function(node){return !domUtils.isBody(node)}),
                    addrs = [];
                for(var i = 0,ci;ci = parents[i++];){
                    addrs.push(domUtils.getNodeIndex(ci,ignoreTxt));
                }
                var firstIndex = 0;

                if(ignoreTxt){
                    if(node.nodeType == 3){
                        var tmpNode = node.previousSibling;
                        while(tmpNode && tmpNode.nodeType == 3){
                            firstIndex += tmpNode.nodeValue.replace(fillCharReg,'').length;
                            tmpNode = tmpNode.previousSibling;
                        }
                        firstIndex +=  (isStart ? me.startOffset : me.endOffset)// - (fillCharReg.test(node.nodeValue) ? 1 : 0 )
                    }else{
                        node =  node.childNodes[ isStart ? me.startOffset : me.endOffset];
                        if(node){
                            firstIndex = domUtils.getNodeIndex(node,ignoreTxt);
                        }else{
                            node = isStart ? me.startContainer : me.endContainer;
                            var first = node.firstChild;
                            while(first){
                                if(domUtils.isFillChar(first)){
                                    first = first.nextSibling;
                                    continue;
                                }
                                firstIndex++;
                                if(first.nodeType == 3){
                                    while( first && first.nodeType == 3){
                                        first = first.nextSibling;
                                    }
                                }else{
                                    first = first.nextSibling;
                                }
                            }
                        }
                    }

                }else{
                    firstIndex = isStart ? domUtils.isFillChar(node) ? 0 : me.startOffset  : me.endOffset
                }
                if(firstIndex < 0){
                    firstIndex = 0;
                }
                addrs.push(firstIndex);
                return addrs;
            }
            addr.startAddress = getAddress(true);
            if(!ignoreEnd){
                addr.endAddress = me.collapsed ? [].concat(addr.startAddress) : getAddress();
            }
            return addr;
        },

        /**
         * 保存
         * @method createAddress
         * @private
         * @return { Boolean } 返回开始和结束的位置
         * @example
         * ```html
         * <body>
         *     <p>
         *         aaaa
         *         <em>
         *             <!-- 选区开始 -->
         *             bbbb
         *             <!-- 选区结束 -->
         *         </em>
         *     </p>
         *
         *     <script>
         *         var range = editor.selection.getRange();
         *         range.moveToAddress({startAddress:[0,1,0,0],endAddress:[0,1,0,4]});
         *         range.select();
         *         //output: 'bbbb'
         *         console.log(editor.selection.getText());
         *     </script>
         * </body>
         * ```
         */
        moveToAddress : function(addr,ignoreEnd){
            var me = this;
            function getNode(address,isStart){
                var tmpNode = me.document.body,
                    parentNode,offset;
                for(var i= 0,ci,l=address.length;i<l;i++){
                    ci = address[i];
                    parentNode = tmpNode;
                    tmpNode = tmpNode.childNodes[ci];
                    if(!tmpNode){
                        offset = ci;
                        break;
                    }
                }
                if(isStart){
                    if(tmpNode){
                        me.setStartBefore(tmpNode)
                    }else{
                        me.setStart(parentNode,offset)
                    }
                }else{
                    if(tmpNode){
                        me.setEndBefore(tmpNode)
                    }else{
                        me.setEnd(parentNode,offset)
                    }
                }
            }
            getNode(addr.startAddress,true);
            !ignoreEnd && addr.endAddress &&  getNode(addr.endAddress);
            return me;
        },

        /**
         * 判断给定的Range对象是否和当前Range对象表示的是同一个选区
         * @method equals
         * @param { UE.dom.Range } 需要判断的Range对象
         * @return { Boolean } 如果给定的Range对象与当前Range对象表示的是同一个选区， 则返回true， 否则返回false
         */
        equals : function(rng){
            for(var p in this){
                if(this.hasOwnProperty(p)){
                    if(this[p] !== rng[p])
                        return false
                }
            }
            return true;

        },

        /**
         * 遍历range内的节点。每当遍历一个节点时， 都会执行参数项 doFn 指定的函数， 该函数的接受当前遍历的节点
         * 作为其参数。
         * @method traversal
         * @param { Function }  doFn 对每个遍历的节点要执行的方法， 该方法接受当前遍历的节点作为其参数
         * @return { UE.dom.Range } 当前range对象
         * @example
         * ```html
         *
         * <body>
         *
         *     <!-- 选区开始 -->
         *     <span></span>
         *     <a></a>
         *     <!-- 选区结束 -->
         * </body>
         *
         * <script>
         *
         *     //output: <span></span><a></a>
         *     console.log( range.cloneContents() );
         *
         *     range.traversal( function ( node ) {
         *
         *         if ( node.nodeType === 1 ) {
         *             node.className = "test";
         *         }
         *
         *     } );
         *
         *     //output: <span class="test"></span><a class="test"></a>
         *     console.log( range.cloneContents() );
         *
         * </script>
         * ```
         */

        /**
         * 遍历range内的节点。
         * 每当遍历一个节点时， 都会执行参数项 doFn 指定的函数， 该函数的接受当前遍历的节点
         * 作为其参数。
         * 可以通过参数项 filterFn 来指定一个过滤器， 只有符合该过滤器过滤规则的节点才会触
         * 发doFn函数的执行
         * @method traversal
         * @param { Function } doFn 对每个遍历的节点要执行的方法， 该方法接受当前遍历的节点作为其参数
         * @param { Function } filterFn 过滤器， 该函数接受当前遍历的节点作为参数， 如果该节点满足过滤
         *                      规则， 请返回true， 该节点会触发doFn， 否则， 请返回false， 则该节点不
         *                      会触发doFn。
         * @return { UE.dom.Range } 当前range对象
         * @see UE.dom.Range:traversal(Function)
         * @example
         * ```html
         *
         * <body>
         *
         *     <!-- 选区开始 -->
         *     <span></span>
         *     <a></a>
         *     <!-- 选区结束 -->
         * </body>
         *
         * <script>
         *
         *     //output: <span></span><a></a>
         *     console.log( range.cloneContents() );
         *
         *     range.traversal( function ( node ) {
         *
         *         node.className = "test";
         *
         *     }, function ( node ) {
         *          return node.nodeType === 1;
         *     } );
         *
         *     //output: <span class="test"></span><a class="test"></a>
         *     console.log( range.cloneContents() );
         *
         * </script>
         * ```
         */
        traversal:function(doFn,filterFn){
            if (this.collapsed)
                return this;
            var bookmark = this.createBookmark(),
                end = bookmark.end,
                current = domUtils.getNextDomNode(bookmark.start, false, filterFn);
            while (current && current !== end && (domUtils.getPosition(current, end) & domUtils.POSITION_PRECEDING)) {
                var tmpNode = domUtils.getNextDomNode(current,false,filterFn);
                doFn(current);
                current = tmpNode;
            }
            return this.moveToBookmark(bookmark);
        }
    };
})();

// core/Selection.js
/**
 * 选集
 * @file
 * @module UE.dom
 * @class Selection
 * @since 1.2.6.1
 */

/**
 * 选区集合
 * @unfile
 * @module UE.dom
 * @class Selection
 */
(function () {

    function getBoundaryInformation( range, start ) {
        var getIndex = domUtils.getNodeIndex;
        range = range.duplicate();
        range.collapse( start );
        var parent = range.parentElement();
        //如果节点里没有子节点，直接退出
        if ( !parent.hasChildNodes() ) {
            return  {container:parent, offset:0};
        }
        var siblings = parent.children,
            child,
            testRange = range.duplicate(),
            startIndex = 0, endIndex = siblings.length - 1, index = -1,
            distance;
        while ( startIndex <= endIndex ) {
            index = Math.floor( (startIndex + endIndex) / 2 );
            child = siblings[index];
            testRange.moveToElementText( child );
            var position = testRange.compareEndPoints( 'StartToStart', range );
            if ( position > 0 ) {
                endIndex = index - 1;
            } else if ( position < 0 ) {
                startIndex = index + 1;
            } else {
                //trace:1043
                return  {container:parent, offset:getIndex( child )};
            }
        }
        if ( index == -1 ) {
            testRange.moveToElementText( parent );
            testRange.setEndPoint( 'StartToStart', range );
            distance = testRange.text.replace( /(\r\n|\r)/g, '\n' ).length;
            siblings = parent.childNodes;
            if ( !distance ) {
                child = siblings[siblings.length - 1];
                return  {container:child, offset:child.nodeValue.length};
            }

            var i = siblings.length;
            while ( distance > 0 ){
                distance -= siblings[ --i ].nodeValue.length;
            }
            return {container:siblings[i], offset:-distance};
        }
        testRange.collapse( position > 0 );
        testRange.setEndPoint( position > 0 ? 'StartToStart' : 'EndToStart', range );
        distance = testRange.text.replace( /(\r\n|\r)/g, '\n' ).length;
        if ( !distance ) {
            return  dtd.$empty[child.tagName] || dtd.$nonChild[child.tagName] ?
            {container:parent, offset:getIndex( child ) + (position > 0 ? 0 : 1)} :
            {container:child, offset:position > 0 ? 0 : child.childNodes.length}
        }
        while ( distance > 0 ) {
            try {
                var pre = child;
                child = child[position > 0 ? 'previousSibling' : 'nextSibling'];
                distance -= child.nodeValue.length;
            } catch ( e ) {
                return {container:parent, offset:getIndex( pre )};
            }
        }
        return  {container:child, offset:position > 0 ? -distance : child.nodeValue.length + distance}
    }

    /**
     * 将ieRange转换为Range对象
     * @param {Range}   ieRange    ieRange对象
     * @param {Range}   range      Range对象
     * @return  {Range}  range       返回转换后的Range对象
     */
    function transformIERangeToRange( ieRange, range ) {
        if ( ieRange.item ) {
            range.selectNode( ieRange.item( 0 ) );
        } else {
            var bi = getBoundaryInformation( ieRange, true );
            range.setStart( bi.container, bi.offset );
            if ( ieRange.compareEndPoints( 'StartToEnd', ieRange ) != 0 ) {
                bi = getBoundaryInformation( ieRange, false );
                range.setEnd( bi.container, bi.offset );
            }
        }
        return range;
    }

    /**
     * 获得ieRange
     * @param {Selection} sel    Selection对象
     * @return {ieRange}    得到ieRange
     */
    function _getIERange( sel ) {
        var ieRange;
        //ie下有可能报错
        try {
            ieRange = sel.getNative().createRange();
        } catch ( e ) {
            return null;
        }
        var el = ieRange.item ? ieRange.item( 0 ) : ieRange.parentElement();
        if ( ( el.ownerDocument || el ) === sel.document ) {
            return ieRange;
        }
        return null;
    }

    var Selection = dom.Selection = function ( doc ) {
        var me = this, iframe;
        me.document = doc;
        if ( browser.ie9below ) {
            iframe = domUtils.getWindow( doc ).frameElement;
            domUtils.on( iframe, 'beforedeactivate', function () {
                me._bakIERange = me.getIERange();
            } );
            domUtils.on( iframe, 'activate', function () {
                try {
                    if ( !_getIERange( me ) && me._bakIERange ) {
                        me._bakIERange.select();
                    }
                } catch ( ex ) {
                }
                me._bakIERange = null;
            } );
        }
        iframe = doc = null;
    };

    Selection.prototype = {

        rangeInBody : function(rng,txtRange){
            var node = browser.ie9below || txtRange ? rng.item ? rng.item() : rng.parentElement() : rng.startContainer;

            return node === this.document.body || domUtils.inDoc(node,this.document);
        },

        /**
         * 获取原生seleciton对象
         * @method getNative
         * @return { Object } 获得selection对象
         * @example
         * ```javascript
         * editor.selection.getNative();
         * ```
         */
        getNative:function () {
            var doc = this.document;
            try {
                return !doc ? null : browser.ie9below ? doc.selection : domUtils.getWindow( doc ).getSelection();
            } catch ( e ) {
                return null;
            }
        },

        /**
         * 获得ieRange
         * @method getIERange
         * @return { Object } 返回ie原生的Range
         * @example
         * ```javascript
         * editor.selection.getIERange();
         * ```
         */
        getIERange:function () {
            var ieRange = _getIERange( this );
            if ( !ieRange ) {
                if ( this._bakIERange ) {
                    return this._bakIERange;
                }
            }
            return ieRange;
        },

        /**
         * 缓存当前选区的range和选区的开始节点
         * @method cache
         */
        cache:function () {
            this.clear();
            this._cachedRange = this.getRange();
            this._cachedStartElement = this.getStart();
            this._cachedStartElementPath = this.getStartElementPath();
        },

        /**
         * 获取选区开始位置的父节点到body
         * @method getStartElementPath
         * @return { Array } 返回父节点集合
         * @example
         * ```javascript
         * editor.selection.getStartElementPath();
         * ```
         */
        getStartElementPath:function () {
            if ( this._cachedStartElementPath ) {
                return this._cachedStartElementPath;
            }
            var start = this.getStart();
            if ( start ) {
                return domUtils.findParents( start, true, null, true )
            }
            return [];
        },

        /**
         * 清空缓存
         * @method clear
         */
        clear:function () {
            this._cachedStartElementPath = this._cachedRange = this._cachedStartElement = null;
        },

        /**
         * 编辑器是否得到了选区
         * @method isFocus
         */
        isFocus:function () {
            try {
                if(browser.ie9below){

                    var nativeRange = _getIERange(this);
                    return !!(nativeRange && this.rangeInBody(nativeRange));
                }else{
                    return !!this.getNative().rangeCount;
                }
            } catch ( e ) {
                return false;
            }

        },

        /**
         * 获取选区对应的Range
         * @method getRange
         * @return { Object } 得到Range对象
         * @example
         * ```javascript
         * editor.selection.getRange();
         * ```
         */
        getRange:function () {
            var me = this;
            function optimze( range ) {
                var child = me.document.body.firstChild,
                    collapsed = range.collapsed;
                while ( child && child.firstChild ) {
                    range.setStart( child, 0 );
                    child = child.firstChild;
                }
                if ( !range.startContainer ) {
                    range.setStart( me.document.body, 0 )
                }
                if ( collapsed ) {
                    range.collapse( true );
                }
            }

            if ( me._cachedRange != null ) {
                return this._cachedRange;
            }
            var range = new baidu.editor.dom.Range( me.document );

            if ( browser.ie9below ) {
                var nativeRange = me.getIERange();
                if ( nativeRange ) {
                    //备份的_bakIERange可能已经实效了，dom树发生了变化比如从源码模式切回来，所以try一下，实效就放到body开始位置
                    try{
                        transformIERangeToRange( nativeRange, range );
                    }catch(e){
                        optimze( range );
                    }

                } else {
                    optimze( range );
                }
            } else {
                var sel = me.getNative();
                if ( sel && sel.rangeCount ) {
                    var firstRange = sel.getRangeAt( 0 );
                    var lastRange = sel.getRangeAt( sel.rangeCount - 1 );
                    range.setStart( firstRange.startContainer, firstRange.startOffset ).setEnd( lastRange.endContainer, lastRange.endOffset );
                    if ( range.collapsed && domUtils.isBody( range.startContainer ) && !range.startOffset ) {
                        optimze( range );
                    }
                } else {
                    //trace:1734 有可能已经不在dom树上了，标识的节点
                    if ( this._bakRange && domUtils.inDoc( this._bakRange.startContainer, this.document ) ){
                        return this._bakRange;
                    }
                    optimze( range );
                }
            }
            return this._bakRange = range;
        },

        /**
         * 获取开始元素，用于状态反射
         * @method getStart
         * @return { Element } 获得开始元素
         * @example
         * ```javascript
         * editor.selection.getStart();
         * ```
         */
        getStart:function () {
            if ( this._cachedStartElement ) {
                return this._cachedStartElement;
            }
            var range = browser.ie9below ? this.getIERange() : this.getRange(),
                tmpRange,
                start, tmp, parent;
            if ( browser.ie9below ) {
                if ( !range ) {
                    //todo 给第一个值可能会有问题
                    return this.document.body.firstChild;
                }
                //control元素
                if ( range.item ){
                    return range.item( 0 );
                }
                tmpRange = range.duplicate();
                //修正ie下<b>x</b>[xx] 闭合后 <b>x|</b>xx
                tmpRange.text.length > 0 && tmpRange.moveStart( 'character', 1 );
                tmpRange.collapse( 1 );
                start = tmpRange.parentElement();
                parent = tmp = range.parentElement();
                while ( tmp = tmp.parentNode ) {
                    if ( tmp == start ) {
                        start = parent;
                        break;
                    }
                }
            } else {
                range.shrinkBoundary();
                start = range.startContainer;
                if ( start.nodeType == 1 && start.hasChildNodes() ){
                    start = start.childNodes[Math.min( start.childNodes.length - 1, range.startOffset )];
                }
                if ( start.nodeType == 3 ){
                    return start.parentNode;
                }
            }
            return start;
        },

        /**
         * 得到选区中的文本
         * @method getText
         * @return { String } 选区中包含的文本
         * @example
         * ```javascript
         * editor.selection.getText();
         * ```
         */
        getText:function () {
            var nativeSel, nativeRange;
            if ( this.isFocus() && (nativeSel = this.getNative()) ) {
                nativeRange = browser.ie9below ? nativeSel.createRange() : nativeSel.getRangeAt( 0 );
                return browser.ie9below ? nativeRange.text : nativeRange.toString();
            }
            return '';
        },

        /**
         * 清除选区
         * @method clearRange
         * @example
         * ```javascript
         * editor.selection.clearRange();
         * ```
         */
        clearRange : function(){
            this.getNative()[browser.ie9below ? 'empty' : 'removeAllRanges']();
        }
    };
})();

// core/Editor.js
/**
 * 编辑器主类，包含编辑器提供的大部分公用接口
 * @file
 * @module UE
 * @class Editor
 * @since 1.2.6.1
 */

/**
 * UEditor公用空间，UEditor所有的功能都挂载在该空间下
 * @unfile
 * @module UE
 */

/**
 * UEditor的核心类，为用户提供与编辑器交互的接口。
 * @unfile
 * @module UE
 * @class Editor
 */

(function () {
    var uid = 0, _selectionChangeTimer;

    /**
     * 获取编辑器的html内容，赋值到编辑器所在表单的textarea文本域里面
     * @private
     * @method setValue
     * @param { UE.Editor } editor 编辑器事例
     */
    function setValue(form, editor) {
        var textarea;
        if (editor.textarea) {
            if (utils.isString(editor.textarea)) {
                for (var i = 0, ti, tis = domUtils.getElementsByTagName(form, 'textarea'); ti = tis[i++];) {
                    if (ti.id == 'ueditor_textarea_' + editor.options.textarea) {
                        textarea = ti;
                        break;
                    }
                }
            } else {
                textarea = editor.textarea;
            }
        }
        if (!textarea) {
            form.appendChild(textarea = domUtils.createElement(document, 'textarea', {
                'name': editor.options.textarea,
                'id': 'ueditor_textarea_' + editor.options.textarea,
                'style': "display:none"
            }));
            //不要产生多个textarea
            editor.textarea = textarea;
        }
        !textarea.getAttribute('name') && textarea.setAttribute('name', editor.options.textarea );
        textarea.value = editor.hasContents() ?
            (editor.options.allHtmlEnabled ? editor.getAllHtml() : editor.getContent(null, null, true)) :
            ''
    }
    function loadPlugins(me){
        //初始化插件
        for (var pi in UE.plugins) {
            UE.plugins[pi].call(me);
        }

    }
    function checkCurLang(I18N){
        for(var lang in I18N){
            return lang
        }
    }

    function langReadied(me){
        me.langIsReady = true;

        me.fireEvent("langReady");
    }

    /**
     * 编辑器准备就绪后会触发该事件
     * @module UE
     * @class Editor
     * @event ready
     * @remind render方法执行完成之后,会触发该事件
     * @remind
     * @example
     * ```javascript
     * editor.addListener( 'ready', function( editor ) {
     *     editor.execCommand( 'focus' ); //编辑器家在完成后，让编辑器拿到焦点
     * } );
     * ```
     */
    /**
     * 执行destroy方法,会触发该事件
     * @module UE
     * @class Editor
     * @event destroy
     * @see UE.Editor:destroy()
     */
    /**
     * 执行reset方法,会触发该事件
     * @module UE
     * @class Editor
     * @event reset
     * @see UE.Editor:reset()
     */
    /**
     * 执行focus方法,会触发该事件
     * @module UE
     * @class Editor
     * @event focus
     * @see UE.Editor:focus(Boolean)
     */
    /**
     * 语言加载完成会触发该事件
     * @module UE
     * @class Editor
     * @event langReady
     */
    /**
     * 运行命令之后会触发该命令
     * @module UE
     * @class Editor
     * @event beforeExecCommand
     */
    /**
     * 运行命令之后会触发该命令
     * @module UE
     * @class Editor
     * @event afterExecCommand
     */
    /**
     * 运行命令之前会触发该命令
     * @module UE
     * @class Editor
     * @event firstBeforeExecCommand
     */
    /**
     * 在getContent方法执行之前会触发该事件
     * @module UE
     * @class Editor
     * @event beforeGetContent
     * @see UE.Editor:getContent()
     */
    /**
     * 在getContent方法执行之后会触发该事件
     * @module UE
     * @class Editor
     * @event afterGetContent
     * @see UE.Editor:getContent()
     */
    /**
     * 在getAllHtml方法执行时会触发该事件
     * @module UE
     * @class Editor
     * @event getAllHtml
     * @see UE.Editor:getAllHtml()
     */
    /**
     * 在setContent方法执行之前会触发该事件
     * @module UE
     * @class Editor
     * @event beforeSetContent
     * @see UE.Editor:setContent(String)
     */
    /**
     * 在setContent方法执行之后会触发该事件
     * @module UE
     * @class Editor
     * @event afterSetContent
     * @see UE.Editor:setContent(String)
     */
    /**
     * 每当编辑器内部选区发生改变时，将触发该事件
     * @event selectionchange
     * @warning 该事件的触发非常频繁，不建议在该事件的处理过程中做重量级的处理
     * @example
     * ```javascript
     * editor.addListener( 'selectionchange', function( editor ) {
     *     console.log('选区发生改变');
     * }
     */
    /**
     * 在所有selectionchange的监听函数执行之前，会触发该事件
     * @module UE
     * @class Editor
     * @event beforeSelectionChange
     * @see UE.Editor:selectionchange
     */
    /**
     * 在所有selectionchange的监听函数执行完之后，会触发该事件
     * @module UE
     * @class Editor
     * @event afterSelectionChange
     * @see UE.Editor:selectionchange
     */
    /**
     * 编辑器内容发生改变时会触发该事件
     * @module UE
     * @class Editor
     * @event contentChange
     */


    /**
     * 以默认参数构建一个编辑器实例
     * @constructor
     * @remind 通过 改构造方法实例化的编辑器,不带ui层.需要render到一个容器,编辑器实例才能正常渲染到页面
     * @example
     * ```javascript
     * var editor = new UE.Editor();
     * editor.execCommand('blod');
     * ```
     * @see UE.Config
     */

    /**
     * 以给定的参数集合创建一个编辑器实例，对于未指定的参数，将应用默认参数。
     * @constructor
     * @remind 通过 改构造方法实例化的编辑器,不带ui层.需要render到一个容器,编辑器实例才能正常渲染到页面
     * @param { Object } setting 创建编辑器的参数
     * @example
     * ```javascript
     * var editor = new UE.Editor();
     * editor.execCommand('blod');
     * ```
     * @see UE.Config
     */
    var Editor = UE.Editor = function (options) {
        var me = this;
        me.uid = uid++;
        EventBase.call(me);
        me.commands = {};
        me.options = utils.extend(utils.clone(options || {}), UEDITOR_CONFIG, true);
        me.shortcutkeys = {};
        me.inputRules = [];
        me.outputRules = [];
        //设置默认的常用属性
        me.setOpt(Editor.defaultOptions(me));

        /* 尝试异步加载后台配置 */
        me.loadServerConfig();

        if(!utils.isEmptyObject(UE.I18N)){
            //修改默认的语言类型
            me.options.lang = checkCurLang(UE.I18N);
            UE.plugin.load(me);
            langReadied(me);

        }else{
            utils.loadFile(document, {
                src: me.options.langPath + me.options.lang + "/" + me.options.lang + ".js",
                tag: "script",
                type: "text/javascript",
                defer: "defer"
            }, function () {
                UE.plugin.load(me);
                langReadied(me);
            });
        }

        UE.instants['ueditorInstant' + me.uid] = me;
    };
    Editor.prototype = {
         registerCommand : function(name,obj){
            this.commands[name] = obj;
         },
        /**
         * 编辑器对外提供的监听ready事件的接口， 通过调用该方法，达到的效果与监听ready事件是一致的
         * @method ready
         * @param { Function } fn 编辑器ready之后所执行的回调, 如果在注册事件之前编辑器已经ready，将会
         * 立即触发该回调。
         * @remind 需要等待编辑器加载完成后才能执行的代码,可以使用该方法传入
         * @example
         * ```javascript
         * editor.ready( function( editor ) {
         *     editor.setContent('初始化完毕');
         * } );
         * ```
         * @see UE.Editor.event:ready
         */
        ready: function (fn) {
            var me = this;
            if (fn) {
                me.isReady ? fn.apply(me) : me.addListener('ready', fn);
            }
        },

        /**
         * 该方法是提供给插件里面使用，设置配置项默认值
         * @method setOpt
         * @warning 三处设置配置项的优先级: 实例化时传入参数 > setOpt()设置 > config文件里设置
         * @warning 该方法仅供编辑器插件内部和编辑器初始化时调用，其他地方不能调用。
         * @param { String } key 编辑器的可接受的选项名称
         * @param { * } val  该选项可接受的值
         * @example
         * ```javascript
         * editor.setOpt( 'initContent', '欢迎使用编辑器' );
         * ```
         */

        /**
         * 该方法是提供给插件里面使用，以{key:value}集合的方式设置插件内用到的配置项默认值
         * @method setOpt
         * @warning 三处设置配置项的优先级: 实例化时传入参数 > setOpt()设置 > config文件里设置
         * @warning 该方法仅供编辑器插件内部和编辑器初始化时调用，其他地方不能调用。
         * @param { Object } options 将要设置的选项的键值对对象
         * @example
         * ```javascript
         * editor.setOpt( {
         *     'initContent': '欢迎使用编辑器'
         * } );
         * ```
         */
        setOpt: function (key, val) {
            var obj = {};
            if (utils.isString(key)) {
                obj[key] = val
            } else {
                obj = key;
            }
            utils.extend(this.options, obj, true);
        },
        getOpt:function(key){
            return this.options[key]
        },
        /**
         * 销毁编辑器实例，使用textarea代替
         * @method destroy
         * @example
         * ```javascript
         * editor.destroy();
         * ```
         */
        destroy: function () {

            var me = this;
            me.fireEvent('destroy');
            var container = me.container.parentNode;
            var textarea = me.textarea;
            if (!textarea) {
                textarea = document.createElement('textarea');
                container.parentNode.insertBefore(textarea, container);
            } else {
                textarea.style.display = ''
            }

            textarea.style.width = me.iframe.offsetWidth + 'px';
            textarea.style.height = me.iframe.offsetHeight + 'px';
            textarea.value = me.getContent();
            textarea.id = me.key;
            container.innerHTML = '';
            domUtils.remove(container);
            var key = me.key;
            //trace:2004
            for (var p in me) {
                if (me.hasOwnProperty(p)) {
                    delete this[p];
                }
            }
            UE.delEditor(key);
        },

        /**
         * 渲染编辑器的DOM到指定容器
         * @method render
         * @param { String } containerId 指定一个容器ID
         * @remind 执行该方法,会触发ready事件
         * @warning 必须且只能调用一次
         */

        /**
         * 渲染编辑器的DOM到指定容器
         * @method render
         * @param { Element } containerDom 直接指定容器对象
         * @remind 执行该方法,会触发ready事件
         * @warning 必须且只能调用一次
         */
        render: function (container) {
            var me = this,
                options = me.options,
                getStyleValue=function(attr){
                    return parseInt(domUtils.getComputedStyle(container,attr));
                };
            if (utils.isString(container)) {
                container = document.getElementById(container);
            }
            if (container) {
                if(options.initialFrameWidth){
                    options.minFrameWidth = options.initialFrameWidth
                }else{
                    options.minFrameWidth = options.initialFrameWidth = container.offsetWidth;
                }
                if(options.initialFrameHeight){
                    options.minFrameHeight = options.initialFrameHeight
                }else{
                    options.initialFrameHeight = options.minFrameHeight = container.offsetHeight;
                }

                container.style.width = /%$/.test(options.initialFrameWidth) ?  '100%' : options.initialFrameWidth-
                    getStyleValue("padding-left")- getStyleValue("padding-right") +'px';
                container.style.height = /%$/.test(options.initialFrameHeight) ?  '100%' : options.initialFrameHeight -
                    getStyleValue("padding-top")- getStyleValue("padding-bottom") +'px';

                container.style.zIndex = options.zIndex;

                var html = ( ie && browser.version < 9  ? '' : '<!DOCTYPE html>') +
                    '<html xmlns=\'http://www.w3.org/1999/xhtml\' class=\'view\' ><head>' +
                    '<style type=\'text/css\'>' +
                    //设置四周的留边
                    '.view{padding:0;word-wrap:break-word;cursor:text;height:90%;}\n' +
                    //设置默认字体和字号
                    //font-family不能呢随便改，在safari下fillchar会有解析问题
                    'body{margin:8px;font-family:sans-serif;font-size:16px;}' +
                    //设置段落间距
                    'p{margin:5px 0;}</style>' +
                    ( options.iframeCssUrl ? '<link rel=\'stylesheet\' type=\'text/css\' href=\'' + utils.unhtml(options.iframeCssUrl) + '\'/>' : '' ) +
                    (options.initialStyle ? '<style>' + options.initialStyle + '</style>' : '') +
                    '</head><body class=\'view\' ></body>' +
                    '<script type=\'text/javascript\' ' + (ie ? 'defer=\'defer\'' : '' ) +' id=\'_initialScript\'>' +
                    'setTimeout(function(){editor = window.parent.UE.instants[\'ueditorInstant' + me.uid + '\'];editor._setup(document);},0);' +
                    'var _tmpScript = document.getElementById(\'_initialScript\');_tmpScript.parentNode.removeChild(_tmpScript);</script></html>';
                container.appendChild(domUtils.createElement(document, 'iframe', {
                    id: 'ueditor_' + me.uid,
                    width: "100%",
                    height: "100%",
                    frameborder: "0",
                    //先注释掉了，加的原因忘记了，但开启会直接导致全屏模式下内容多时不会出现滚动条
//                    scrolling :'no',
                    src: 'javascript:void(function(){document.open();' + (options.customDomain && document.domain != location.hostname ?  'document.domain="' + document.domain + '";' : '') +
                        'document.write("' + html + '");document.close();}())'
                }));
                container.style.overflow = 'hidden';
                //解决如果是给定的百分比，会导致高度算不对的问题
                setTimeout(function(){
                    if( /%$/.test(options.initialFrameWidth)){
                        options.minFrameWidth = options.initialFrameWidth = container.offsetWidth;
                        //如果这里给定宽度，会导致ie在拖动窗口大小时，编辑区域不随着变化
//                        container.style.width = options.initialFrameWidth + 'px';
                    }
                    if(/%$/.test(options.initialFrameHeight)){
                        options.minFrameHeight = options.initialFrameHeight = container.offsetHeight;
                        container.style.height = options.initialFrameHeight + 'px';
                    }
                })
            }
        },

        /**
         * 编辑器初始化
         * @method _setup
         * @private
         * @param { Element } doc 编辑器Iframe中的文档对象
         */
        _setup: function (doc) {

            var me = this,
                options = me.options;
            if (ie) {
                doc.body.disabled = true;
                doc.body.contentEditable = true;
                doc.body.disabled = false;
            } else {
                doc.body.contentEditable = true;
            }
            doc.body.spellcheck = false;
            me.document = doc;
            me.window = doc.defaultView || doc.parentWindow;
            me.iframe = me.window.frameElement;
            me.body = doc.body;
            me.selection = new dom.Selection(doc);
            //gecko初始化就能得到range,无法判断isFocus了
            var geckoSel;
            if (browser.gecko && (geckoSel = this.selection.getNative())) {
                geckoSel.removeAllRanges();
            }
            this._initEvents();
            //为form提交提供一个隐藏的textarea
            for (var form = this.iframe.parentNode; !domUtils.isBody(form); form = form.parentNode) {
                if (form.tagName == 'FORM') {
                    me.form = form;
                    if(me.options.autoSyncData){
                        domUtils.on(me.window,'blur',function(){
                            setValue(form,me);
                        });
                    }else{
                        domUtils.on(form, 'submit', function () {
                            setValue(this, me);
                        });
                    }
                    break;
                }
            }
            if (options.initialContent) {
                if (options.autoClearinitialContent) {
                    var oldExecCommand = me.execCommand;
                    me.execCommand = function () {
                        me.fireEvent('firstBeforeExecCommand');
                        return oldExecCommand.apply(me, arguments);
                    };
                    this._setDefaultContent(options.initialContent);
                } else
                    this.setContent(options.initialContent, false, true);
            }

            //编辑器不能为空内容

            if (domUtils.isEmptyNode(me.body)) {
                me.body.innerHTML = '<p>' + (browser.ie ? '' : '<br/>') + '</p>';
            }
            //如果要求focus, 就把光标定位到内容开始
            if (options.focus) {
                setTimeout(function () {
                    me.focus(me.options.focusInEnd);
                    //如果自动清除开着，就不需要做selectionchange;
                    !me.options.autoClearinitialContent && me._selectionChange();
                }, 0);
            }
            if (!me.container) {
                me.container = this.iframe.parentNode;
            }
            if (options.fullscreen && me.ui) {
                me.ui.setFullScreen(true);
            }

            try {
                me.document.execCommand('2D-position', false, false);
            } catch (e) {
            }
            try {
                me.document.execCommand('enableInlineTableEditing', false, false);
            } catch (e) {
            }
            try {
                me.document.execCommand('enableObjectResizing', false, false);
            } catch (e) {
            }

            //挂接快捷键
            me._bindshortcutKeys();
            me.isReady = 1;
            me.fireEvent('ready');
            options.onready && options.onready.call(me);
            if (!browser.ie9below) {
                domUtils.on(me.window, ['blur', 'focus'], function (e) {
                    //chrome下会出现alt+tab切换时，导致选区位置不对
                    if (e.type == 'blur') {
                        me._bakRange = me.selection.getRange();
                        try {
                            me._bakNativeRange = me.selection.getNative().getRangeAt(0);
                            me.selection.getNative().removeAllRanges();
                        } catch (e) {
                            me._bakNativeRange = null;
                        }

                    } else {
                        try {
                            me._bakRange && me._bakRange.select();
                        } catch (e) {
                        }
                    }
                });
            }
            //trace:1518 ff3.6body不够寛，会导致点击空白处无法获得焦点
            if (browser.gecko && browser.version <= 10902) {
                //修复ff3.6初始化进来，不能点击获得焦点
                me.body.contentEditable = false;
                setTimeout(function () {
                    me.body.contentEditable = true;
                }, 100);
                setInterval(function () {
                    me.body.style.height = me.iframe.offsetHeight - 20 + 'px'
                }, 100)
            }

            !options.isShow && me.setHide();
            options.readonly && me.setDisabled();
        },

        /**
         * 同步数据到编辑器所在的form
         * 从编辑器的容器节点向上查找form元素，若找到，就同步编辑内容到找到的form里，为提交数据做准备，主要用于是手动提交的情况
         * 后台取得数据的键值，使用你容器上的name属性，如果没有就使用参数里的textarea项
         * @method sync
         * @example
         * ```javascript
         * editor.sync();
         * form.sumbit(); //form变量已经指向了form元素
         * ```
         */

        /**
         * 根据传入的formId，在页面上查找要同步数据的表单，若找到，就同步编辑内容到找到的form里，为提交数据做准备
         * 后台取得数据的键值，该键值默认使用给定的编辑器容器的name属性，如果没有name属性则使用参数项里给定的“textarea”项
         * @method sync
         * @param { String } formID 指定一个要同步数据的form的id,编辑器的数据会同步到你指定form下
         */
        sync: function (formId) {
            var me = this,
                form = formId ? document.getElementById(formId) :
                    domUtils.findParent(me.iframe.parentNode, function (node) {
                        return node.tagName == 'FORM'
                    }, true);
            form && setValue(form, me);
        },

        /**
         * 设置编辑器高度
         * @method setHeight
         * @remind 当配置项autoHeightEnabled为真时,该方法无效
         * @param { Number } number 设置的高度值，纯数值，不带单位
         * @example
         * ```javascript
         * editor.setHeight(number);
         * ```
         */
        setHeight: function (height,notSetHeight) {
            if (height !== parseInt(this.iframe.parentNode.style.height)) {
                this.iframe.parentNode.style.height = height + 'px';
            }
            !notSetHeight && (this.options.minFrameHeight = this.options.initialFrameHeight = height);
            this.body.style.height = height + 'px';
            !notSetHeight && this.trigger('setHeight')
        },

        /**
         * 为编辑器的编辑命令提供快捷键
         * 这个接口是为插件扩展提供的接口,主要是为新添加的插件，如果需要添加快捷键，所提供的接口
         * @method addshortcutkey
         * @param { Object } keyset 命令名和快捷键键值对对象，多个按钮的快捷键用“＋”分隔
         * @example
         * ```javascript
         * editor.addshortcutkey({
         *     "Bold" : "ctrl+66",//^B
         *     "Italic" : "ctrl+73", //^I
         * });
         * ```
         */
        /**
         * 这个接口是为插件扩展提供的接口,主要是为新添加的插件，如果需要添加快捷键，所提供的接口
         * @method addshortcutkey
         * @param { String } cmd 触发快捷键时，响应的命令
         * @param { String } keys 快捷键的字符串，多个按钮用“＋”分隔
         * @example
         * ```javascript
         * editor.addshortcutkey("Underline", "ctrl+85"); //^U
         * ```
         */
        addshortcutkey: function (cmd, keys) {
            var obj = {};
            if (keys) {
                obj[cmd] = keys
            } else {
                obj = cmd;
            }
            utils.extend(this.shortcutkeys, obj)
        },

        /**
         * 对编辑器设置keydown事件监听，绑定快捷键和命令，当快捷键组合触发成功，会响应对应的命令
         * @method _bindshortcutKeys
         * @private
         */
        _bindshortcutKeys: function () {
            var me = this, shortcutkeys = this.shortcutkeys;
            me.addListener('keydown', function (type, e) {
                var keyCode = e.keyCode || e.which;
                for (var i in shortcutkeys) {
                    var tmp = shortcutkeys[i].split(',');
                    for (var t = 0, ti; ti = tmp[t++];) {
                        ti = ti.split(':');
                        var key = ti[0], param = ti[1];
                        if (/^(ctrl)(\+shift)?\+(\d+)$/.test(key.toLowerCase()) || /^(\d+)$/.test(key)) {
                            if (( (RegExp.$1 == 'ctrl' ? (e.ctrlKey || e.metaKey) : 0)
                                && (RegExp.$2 != "" ? e[RegExp.$2.slice(1) + "Key"] : 1)
                                && keyCode == RegExp.$3
                                ) ||
                                keyCode == RegExp.$1
                                ) {
                                if (me.queryCommandState(i,param) != -1)
                                    me.execCommand(i, param);
                                domUtils.preventDefault(e);
                            }
                        }
                    }

                }
            });
        },

        /**
         * 获取编辑器的内容
         * @method getContent
         * @warning 该方法获取到的是经过编辑器内置的过滤规则进行过滤后得到的内容
         * @return { String } 编辑器的内容字符串, 如果编辑器的内容为空，或者是空的标签内容（如:”&lt;p&gt;&lt;br/&gt;&lt;/p&gt;“）， 则返回空字符串
         * @example
         * ```javascript
         * //编辑器html内容:<p>1<strong>2<em>34</em>5</strong>6</p>
         * var content = editor.getContent(); //返回值:<p>1<strong>2<em>34</em>5</strong>6</p>
         * ```
         */

        /**
         * 获取编辑器的内容。 可以通过参数定义编辑器内置的判空规则
         * @method getContent
         * @param { Function } fn 自定的判空规则， 要求该方法返回一个boolean类型的值，
         *                      代表当前编辑器的内容是否空，
         *                      如果返回true， 则该方法将直接返回空字符串；如果返回false，则编辑器将返回
         *                      经过内置过滤规则处理后的内容。
         * @remind 该方法在处理包含有初始化内容的时候能起到很好的作用。
         * @warning 该方法获取到的是经过编辑器内置的过滤规则进行过滤后得到的内容
         * @return { String } 编辑器的内容字符串
         * @example
         * ```javascript
         * // editor 是一个编辑器的实例
         * var content = editor.getContent( function ( editor ) {
         *      return editor.body.innerHTML === '欢迎使用UEditor'; //返回空字符串
         * } );
         * ```
         */
        getContent: function (cmd, fn,notSetCursor,ignoreBlank,formatter) {
            var me = this;
            if (cmd && utils.isFunction(cmd)) {
                fn = cmd;
                cmd = '';
            }
            if (fn ? !fn() : !this.hasContents()) {
                return '';
            }
            me.fireEvent('beforegetcontent');
            var root = UE.htmlparser(me.body.innerHTML,ignoreBlank);
            me.filterOutputRule(root);
            me.fireEvent('aftergetcontent', cmd,root);
            return  root.toHtml(formatter);
        },

        /**
         * 取得完整的html代码，可以直接显示成完整的html文档
         * @method getAllHtml
         * @return { String } 编辑器的内容html文档字符串
         * @eaxmple
         * ```javascript
         * editor.getAllHtml(); //返回格式大致是: <html><head>...</head><body>...</body></html>
         * ```
         */
        getAllHtml: function () {
            var me = this,
                headHtml = [],
                html = '';
            me.fireEvent('getAllHtml', headHtml);
            if (browser.ie && browser.version > 8) {
                var headHtmlForIE9 = '';
                utils.each(me.document.styleSheets, function (si) {
                    headHtmlForIE9 += ( si.href ? '<link rel="stylesheet" type="text/css" href="' + si.href + '" />' : '<style>' + si.cssText + '</style>');
                });
                utils.each(me.document.getElementsByTagName('script'), function (si) {
                    headHtmlForIE9 += si.outerHTML;
                });

            }
            return '<html><head>' + (me.options.charset ? '<meta http-equiv="Content-Type" content="text/html; charset=' + me.options.charset + '"/>' : '')
                + (headHtmlForIE9 || me.document.getElementsByTagName('head')[0].innerHTML) + headHtml.join('\n') + '</head>'
                + '<body ' + (ie && browser.version < 9 ? 'class="view"' : '') + '>' + me.getContent(null, null, true) + '</body></html>';
        },

        /**
         * 得到编辑器的纯文本内容，但会保留段落格式
         * @method getPlainTxt
         * @return { String } 编辑器带段落格式的纯文本内容字符串
         * @example
         * ```javascript
         * //编辑器html内容:<p><strong>1</strong></p><p><strong>2</strong></p>
         * console.log(editor.getPlainTxt()); //输出:"1\n2\n
         * ```
         */
        getPlainTxt: function () {
            var reg = new RegExp(domUtils.fillChar, 'g'),
                html = this.body.innerHTML.replace(/[\n\r]/g, '');//ie要先去了\n在处理
            html = html.replace(/<(p|div)[^>]*>(<br\/?>|&nbsp;)<\/\1>/gi, '\n')
                .replace(/<br\/?>/gi, '\n')
                .replace(/<[^>/]+>/g, '')
                .replace(/(\n)?<\/([^>]+)>/g, function (a, b, c) {
                    return dtd.$block[c] ? '\n' : b ? b : '';
                });
            //取出来的空格会有c2a0会变成乱码，处理这种情况\u00a0
            return html.replace(reg, '').replace(/\u00a0/g, ' ').replace(/&nbsp;/g, ' ');
        },

        /**
         * 获取编辑器中的纯文本内容,没有段落格式
         * @method getContentTxt
         * @return { String } 编辑器不带段落格式的纯文本内容字符串
         * @example
         * ```javascript
         * //编辑器html内容:<p><strong>1</strong></p><p><strong>2</strong></p>
         * console.log(editor.getPlainTxt()); //输出:"12
         * ```
         */
        getContentTxt: function () {
            var reg = new RegExp(domUtils.fillChar, 'g');
            //取出来的空格会有c2a0会变成乱码，处理这种情况\u00a0
            return this.body[browser.ie ? 'innerText' : 'textContent'].replace(reg, '').replace(/\u00a0/g, ' ');
        },

        /**
         * 设置编辑器的内容，可修改编辑器当前的html内容
         * @method setContent
         * @warning 通过该方法插入的内容，是经过编辑器内置的过滤规则进行过滤后得到的内容
         * @warning 该方法会触发selectionchange事件
         * @param { String } html 要插入的html内容
         * @example
         * ```javascript
         * editor.getContent('<p>test</p>');
         * ```
         */

        /**
         * 设置编辑器的内容，可修改编辑器当前的html内容
         * @method setContent
         * @warning 通过该方法插入的内容，是经过编辑器内置的过滤规则进行过滤后得到的内容
         * @warning 该方法会触发selectionchange事件
         * @param { String } html 要插入的html内容
         * @param { Boolean } isAppendTo 若传入true，不清空原来的内容，在最后插入内容，否则，清空内容再插入
         * @example
         * ```javascript
         * //假设设置前的编辑器内容是 <p>old text</p>
         * editor.setContent('<p>new text</p>', true); //插入的结果是<p>old text</p><p>new text</p>
         * ```
         */
        setContent: function (html, isAppendTo, notFireSelectionchange) {
            var me = this;

            me.fireEvent('beforesetcontent', html);
            var root = UE.htmlparser(html);
            me.filterInputRule(root);
            html = root.toHtml();

            me.body.innerHTML = (isAppendTo ? me.body.innerHTML : '') + html;


            function isCdataDiv(node){
                return  node.tagName == 'DIV' && node.getAttribute('cdata_tag');
            }
            //给文本或者inline节点套p标签
            if (me.options.enterTag == 'p') {

                var child = this.body.firstChild, tmpNode;
                if (!child || child.nodeType == 1 &&
                    (dtd.$cdata[child.tagName] || isCdataDiv(child) ||
                        domUtils.isCustomeNode(child)
                        )
                    && child === this.body.lastChild) {
                    this.body.innerHTML = '<p>' + (browser.ie ? '&nbsp;' : '<br/>') + '</p>' + this.body.innerHTML;

                } else {
                    var p = me.document.createElement('p');
                    while (child) {
                        while (child && (child.nodeType == 3 || child.nodeType == 1 && dtd.p[child.tagName] && !dtd.$cdata[child.tagName])) {
                            tmpNode = child.nextSibling;
                            p.appendChild(child);
                            child = tmpNode;
                        }
                        if (p.firstChild) {
                            if (!child) {
                                me.body.appendChild(p);
                                break;
                            } else {
                                child.parentNode.insertBefore(p, child);
                                p = me.document.createElement('p');
                            }
                        }
                        child = child.nextSibling;
                    }
                }
            }
            me.fireEvent('aftersetcontent');
            me.fireEvent('contentchange');

            !notFireSelectionchange && me._selectionChange();
            //清除保存的选区
            me._bakRange = me._bakIERange = me._bakNativeRange = null;
            //trace:1742 setContent后gecko能得到焦点问题
            var geckoSel;
            if (browser.gecko && (geckoSel = this.selection.getNative())) {
                geckoSel.removeAllRanges();
            }
            if(me.options.autoSyncData){
                me.form && setValue(me.form,me);
            }
        },

        /**
         * 让编辑器获得焦点，默认focus到编辑器头部
         * @method focus
         * @example
         * ```javascript
         * editor.focus()
         * ```
         */

        /**
         * 让编辑器获得焦点，toEnd确定focus位置
         * @method focus
         * @param { Boolean } toEnd 默认focus到编辑器头部，toEnd为true时focus到内容尾部
         * @example
         * ```javascript
         * editor.focus(true)
         * ```
         */
        focus: function (toEnd) {
            try {
                var me = this,
                    rng = me.selection.getRange();
                if (toEnd) {
                    var node = me.body.lastChild;
                    if(node && node.nodeType == 1 && !dtd.$empty[node.tagName]){
                        if(domUtils.isEmptyBlock(node)){
                            rng.setStartAtFirst(node)
                        }else{
                            rng.setStartAtLast(node)
                        }
                        rng.collapse(true);
                    }
                    rng.setCursor(true);
                } else {
                    if(!rng.collapsed && domUtils.isBody(rng.startContainer) && rng.startOffset == 0){

                        var node = me.body.firstChild;
                        if(node && node.nodeType == 1 && !dtd.$empty[node.tagName]){
                            rng.setStartAtFirst(node).collapse(true);
                        }
                    }

                    rng.select(true);

                }
                this.fireEvent('focus selectionchange');
            } catch (e) {
            }

        },
        isFocus:function(){
            return this.selection.isFocus();
        },
        blur:function(){
            var sel = this.selection.getNative();
            if(sel.empty && browser.ie){
                var nativeRng = document.body.createTextRange();
                nativeRng.moveToElementText(document.body);
                nativeRng.collapse(true);
                nativeRng.select();
                sel.empty()
            }else{
                sel.removeAllRanges()
            }

            //this.fireEvent('blur selectionchange');
        },
        /**
         * 初始化UE事件及部分事件代理
         * @method _initEvents
         * @private
         */
        _initEvents: function () {
            var me = this,
                doc = me.document,
                win = me.window;
            me._proxyDomEvent = utils.bind(me._proxyDomEvent, me);
            domUtils.on(doc, ['click', 'contextmenu', 'mousedown', 'keydown', 'keyup', 'keypress', 'mouseup', 'mouseover', 'mouseout', 'selectstart'], me._proxyDomEvent);
            domUtils.on(win, ['focus', 'blur'], me._proxyDomEvent);
            domUtils.on(me.body,'drop',function(e){
                //阻止ff下默认的弹出新页面打开图片
                if(browser.gecko && e.stopPropagation) { e.stopPropagation(); }
                me.fireEvent('contentchange')
            });
            domUtils.on(doc, ['mouseup', 'keydown'], function (evt) {
                //特殊键不触发selectionchange
                if (evt.type == 'keydown' && (evt.ctrlKey || evt.metaKey || evt.shiftKey || evt.altKey)) {
                    return;
                }
                if (evt.button == 2)return;
                me._selectionChange(250, evt);
            });
        },
        /**
         * 触发事件代理
         * @method _proxyDomEvent
         * @private
         * @return { * } fireEvent的返回值
         * @see UE.EventBase:fireEvent(String)
         */
        _proxyDomEvent: function (evt) {
            if(this.fireEvent('before' + evt.type.replace(/^on/, '').toLowerCase()) === false){
                return false;
            }
            if(this.fireEvent(evt.type.replace(/^on/, ''), evt) === false){
                return false;
            }
            return this.fireEvent('after' + evt.type.replace(/^on/, '').toLowerCase())
        },
        /**
         * 变化选区
         * @method _selectionChange
         * @private
         */
        _selectionChange: function (delay, evt) {
            var me = this;
            //有光标才做selectionchange 为了解决未focus时点击source不能触发更改工具栏状态的问题（source命令notNeedUndo=1）
//            if ( !me.selection.isFocus() ){
//                return;
//            }


            var hackForMouseUp = false;
            var mouseX, mouseY;
            if (browser.ie && browser.version < 9 && evt && evt.type == 'mouseup') {
                var range = this.selection.getRange();
                if (!range.collapsed) {
                    hackForMouseUp = true;
                    mouseX = evt.clientX;
                    mouseY = evt.clientY;
                }
            }
            clearTimeout(_selectionChangeTimer);
            _selectionChangeTimer = setTimeout(function () {
                if (!me.selection || !me.selection.getNative()) {
                    return;
                }
                //修复一个IE下的bug: 鼠标点击一段已选择的文本中间时，可能在mouseup后的一段时间内取到的range是在selection的type为None下的错误值.
                //IE下如果用户是拖拽一段已选择文本，则不会触发mouseup事件，所以这里的特殊处理不会对其有影响
                var ieRange;
                if (hackForMouseUp && me.selection.getNative().type == 'None') {
                    ieRange = me.document.body.createTextRange();
                    try {
                        ieRange.moveToPoint(mouseX, mouseY);
                    } catch (ex) {
                        ieRange = null;
                    }
                }
                var bakGetIERange;
                if (ieRange) {
                    bakGetIERange = me.selection.getIERange;
                    me.selection.getIERange = function () {
                        return ieRange;
                    };
                }
                me.selection.cache();
                if (bakGetIERange) {
                    me.selection.getIERange = bakGetIERange;
                }
                if (me.selection._cachedRange && me.selection._cachedStartElement) {
                    me.fireEvent('beforeselectionchange');
                    // 第二个参数causeByUi为true代表由用户交互造成的selectionchange.
                    me.fireEvent('selectionchange', !!evt);
                    me.fireEvent('afterselectionchange');
                    me.selection.clear();
                }
            }, delay || 50);
        },

        /**
         * 执行编辑命令
         * @method _callCmdFn
         * @private
         * @param { String } fnName 函数名称
         * @param { * } args 传给命令函数的参数
         * @return { * } 返回命令函数运行的返回值
         */
        _callCmdFn: function (fnName, args) {
            var cmdName = args[0].toLowerCase(),
                cmd, cmdFn;
            cmd = this.commands[cmdName] || UE.commands[cmdName];
            cmdFn = cmd && cmd[fnName];
            //没有querycommandstate或者没有command的都默认返回0
            if ((!cmd || !cmdFn) && fnName == 'queryCommandState') {
                return 0;
            } else if (cmdFn) {
                return cmdFn.apply(this, args);
            }
        },

        /**
         * 执行编辑命令cmdName，完成富文本编辑效果
         * @method execCommand
         * @param { String } cmdName 需要执行的命令
         * @remind 具体命令的使用请参考<a href="#COMMAND.LIST">命令列表</a>
         * @return { * } 返回命令函数运行的返回值
         * @example
         * ```javascript
         * editor.execCommand(cmdName);
         * ```
         */
        execCommand: function (cmdName) {
            cmdName = cmdName.toLowerCase();
            var me = this,
                result,
                cmd = me.commands[cmdName] || UE.commands[cmdName];
            if (!cmd || !cmd.execCommand) {
                return null;
            }
            if (!cmd.notNeedUndo && !me.__hasEnterExecCommand) {
                me.__hasEnterExecCommand = true;
                if (me.queryCommandState.apply(me,arguments) != -1) {
                    me.fireEvent('saveScene');
                    me.fireEvent.apply(me, ['beforeexeccommand', cmdName].concat(arguments));
                    result = this._callCmdFn('execCommand', arguments);
                    //保存场景时，做了内容对比，再看是否进行contentchange触发，这里多触发了一次，去掉
//                    (!cmd.ignoreContentChange && !me._ignoreContentChange) && me.fireEvent('contentchange');
                    me.fireEvent.apply(me, ['afterexeccommand', cmdName].concat(arguments));
                    me.fireEvent('saveScene');
                }
                me.__hasEnterExecCommand = false;
            } else {
                result = this._callCmdFn('execCommand', arguments);
                (!me.__hasEnterExecCommand && !cmd.ignoreContentChange && !me._ignoreContentChange) && me.fireEvent('contentchange')
            }
            (!me.__hasEnterExecCommand && !cmd.ignoreContentChange && !me._ignoreContentChange) && me._selectionChange();
            return result;
        },

        /**
         * 根据传入的command命令，查选编辑器当前的选区，返回命令的状态
         * @method  queryCommandState
         * @param { String } cmdName 需要查询的命令名称
         * @remind 具体命令的使用请参考<a href="#COMMAND.LIST">命令列表</a>
         * @return { Number } number 返回放前命令的状态，返回值三种情况：(-1|0|1)
         * @example
         * ```javascript
         * editor.queryCommandState(cmdName)  => (-1|0|1)
         * ```
         * @see COMMAND.LIST
         */
        queryCommandState: function (cmdName) {
            return this._callCmdFn('queryCommandState', arguments);
        },

        /**
         * 根据传入的command命令，查选编辑器当前的选区，根据命令返回相关的值
         * @method queryCommandValue
         * @param { String } cmdName 需要查询的命令名称
         * @remind 具体命令的使用请参考<a href="#COMMAND.LIST">命令列表</a>
         * @remind 只有部分插件有此方法
         * @return { * } 返回每个命令特定的当前状态值
         * @grammar editor.queryCommandValue(cmdName)  =>  {*}
         * @see COMMAND.LIST
         */
        queryCommandValue: function (cmdName) {
            return this._callCmdFn('queryCommandValue', arguments);
        },

        /**
         * 检查编辑区域中是否有内容
         * @method  hasContents
         * @remind 默认有文本内容，或者有以下节点都不认为是空
         * table,ul,ol,dl,iframe,area,base,col,hr,img,embed,input,link,meta,param
         * @return { Boolean } 检查有内容返回true，否则返回false
         * @example
         * ```javascript
         * editor.hasContents()
         * ```
         */

        /**
         * 检查编辑区域中是否有内容，若包含参数tags中的节点类型，直接返回true
         * @method  hasContents
         * @param { Array } tags 传入数组判断时用到的节点类型
         * @return { Boolean } 若文档中包含tags数组里对应的tag，返回true，否则返回false
         * @example
         * ```javascript
         * editor.hasContents(['span']);
         * ```
         */
        hasContents: function (tags) {
            if (tags) {
                for (var i = 0, ci; ci = tags[i++];) {
                    if (this.document.getElementsByTagName(ci).length > 0) {
                        return true;
                    }
                }
            }
            if (!domUtils.isEmptyBlock(this.body)) {
                return true
            }
            //随时添加,定义的特殊标签如果存在，不能认为是空
            tags = ['div'];
            for (i = 0; ci = tags[i++];) {
                var nodes = domUtils.getElementsByTagName(this.document, ci);
                for (var n = 0, cn; cn = nodes[n++];) {
                    if (domUtils.isCustomeNode(cn)) {
                        return true;
                    }
                }
            }
            return false;
        },

        /**
         * 重置编辑器，可用来做多个tab使用同一个编辑器实例
         * @method  reset
         * @remind 此方法会清空编辑器内容，清空回退列表，会触发reset事件
         * @example
         * ```javascript
         * editor.reset()
         * ```
         */
        reset: function () {
            this.fireEvent('reset');
        },

        /**
         * 设置当前编辑区域可以编辑
         * @method setEnabled
         * @example
         * ```javascript
         * editor.setEnabled()
         * ```
         */
        setEnabled: function () {
            var me = this, range;
            if (me.body.contentEditable == 'false') {
                me.body.contentEditable = true;
                range = me.selection.getRange();
                //有可能内容丢失了
                try {
                    range.moveToBookmark(me.lastBk);
                    delete me.lastBk
                } catch (e) {
                    range.setStartAtFirst(me.body).collapse(true)
                }
                range.select(true);
                if (me.bkqueryCommandState) {
                    me.queryCommandState = me.bkqueryCommandState;
                    delete me.bkqueryCommandState;
                }
                if (me.bkqueryCommandValue) {
                    me.queryCommandValue = me.bkqueryCommandValue;
                    delete me.bkqueryCommandValue;
                }
                me.fireEvent('selectionchange');
            }
        },
        enable: function () {
            return this.setEnabled();
        },

        /** 设置当前编辑区域不可编辑
         * @method setDisabled
         */

        /** 设置当前编辑区域不可编辑,except中的命令除外
         * @method setDisabled
         * @param { String } except 例外命令的字符串
         * @remind 即使设置了disable，此处配置的例外命令仍然可以执行
         * @example
         * ```javascript
         * editor.setDisabled('bold'); //禁用工具栏中除加粗之外的所有功能
         * ```
         */

        /** 设置当前编辑区域不可编辑,except中的命令除外
         * @method setDisabled
         * @param { Array } except 例外命令的字符串数组，数组中的命令仍然可以执行
         * @remind 即使设置了disable，此处配置的例外命令仍然可以执行
         * @example
         * ```javascript
         * editor.setDisabled(['bold','insertimage']); //禁用工具栏中除加粗和插入图片之外的所有功能
         * ```
         */
        setDisabled: function (except) {
            var me = this;
            except = except ? utils.isArray(except) ? except : [except] : [];
            if (me.body.contentEditable == 'true') {
                if (!me.lastBk) {
                    me.lastBk = me.selection.getRange().createBookmark(true);
                }
                me.body.contentEditable = false;
                me.bkqueryCommandState = me.queryCommandState;
                me.bkqueryCommandValue = me.queryCommandValue;
                me.queryCommandState = function (type) {
                    if (utils.indexOf(except, type) != -1) {
                        return me.bkqueryCommandState.apply(me, arguments);
                    }
                    return -1;
                };
                me.queryCommandValue = function (type) {
                    if (utils.indexOf(except, type) != -1) {
                        return me.bkqueryCommandValue.apply(me, arguments);
                    }
                    return null;
                };
                me.fireEvent('selectionchange');
            }
        },
        disable: function (except) {
            return this.setDisabled(except);
        },

        /**
         * 设置默认内容
         * @method _setDefaultContent
         * @private
         * @param  { String } cont 要存入的内容
         */
        _setDefaultContent: function () {
            function clear() {
                var me = this;
                if (me.document.getElementById('initContent')) {
                    me.body.innerHTML = '<p>' + (ie ? '' : '<br/>') + '</p>';
                    me.removeListener('firstBeforeExecCommand focus', clear);
                    setTimeout(function () {
                        me.focus();
                        me._selectionChange();
                    }, 0)
                }
            }

            return function (cont) {
                var me = this;
                me.body.innerHTML = '<p id="initContent">' + cont + '</p>';

                me.addListener('firstBeforeExecCommand focus', clear);
            }
        }(),

        /**
         * 显示编辑器
         * @method setShow
         * @example
         * ```javascript
         * editor.setShow()
         * ```
         */
        setShow: function () {
            var me = this, range = me.selection.getRange();
            if (me.container.style.display == 'none') {
                //有可能内容丢失了
                try {
                    range.moveToBookmark(me.lastBk);
                    delete me.lastBk
                } catch (e) {
                    range.setStartAtFirst(me.body).collapse(true)
                }
                //ie下focus实效，所以做了个延迟
                setTimeout(function () {
                    range.select(true);
                }, 100);
                me.container.style.display = '';
            }

        },
        show: function () {
            return this.setShow();
        },
        /**
         * 隐藏编辑器
         * @method setHide
         * @example
         * ```javascript
         * editor.setHide()
         * ```
         */
        setHide: function () {
            var me = this;
            if (!me.lastBk) {
                me.lastBk = me.selection.getRange().createBookmark(true);
            }
            me.container.style.display = 'none'
        },
        hide: function () {
            return this.setHide();
        },

        /**
         * 根据指定的路径，获取对应的语言资源
         * @method getLang
         * @param { String } path 路径根据的是lang目录下的语言文件的路径结构
         * @return { Object | String } 根据路径返回语言资源的Json格式对象或者语言字符串
         * @example
         * ```javascript
         * editor.getLang('contextMenu.delete'); //如果当前是中文，那返回是的是'删除'
         * ```
         */
        getLang: function (path) {
            var lang = UE.I18N[this.options.lang];
            if (!lang) {
                throw Error("not import language file");
            }
            path = (path || "").split(".");
            for (var i = 0, ci; ci = path[i++];) {
                lang = lang[ci];
                if (!lang)break;
            }
            return lang;
        },

        /**
         * 计算编辑器html内容字符串的长度
         * @method  getContentLength
         * @return { Number } 返回计算的长度
         * @example
         * ```javascript
         * //编辑器html内容<p><strong>132</strong></p>
         * editor.getContentLength() //返回27
         * ```
         */
        /**
         * 计算编辑器当前纯文本内容的长度
         * @method  getContentLength
         * @param { Boolean } ingoneHtml 传入true时，只按照纯文本来计算
         * @return { Number } 返回计算的长度，内容中有hr/img/iframe标签，长度加1
         * @example
         * ```javascript
         * //编辑器html内容<p><strong>132</strong></p>
         * editor.getContentLength() //返回3
         * ```
         */
        getContentLength: function (ingoneHtml, tagNames) {
            var count = this.getContent(false,false,true).length;
            if (ingoneHtml) {
                tagNames = (tagNames || []).concat([ 'hr', 'img', 'iframe']);
                count = this.getContentTxt().replace(/[\t\r\n]+/g, '').length;
                for (var i = 0, ci; ci = tagNames[i++];) {
                    count += this.document.getElementsByTagName(ci).length;
                }
            }
            return count;
        },

        /**
         * 注册输入过滤规则
         * @method  addInputRule
         * @param { Function } rule 要添加的过滤规则
         * @example
         * ```javascript
         * editor.addInputRule(function(root){
         *   $.each(root.getNodesByTagName('div'),function(i,node){
         *       node.tagName="p";
         *   });
         * });
         * ```
         */
        addInputRule: function (rule) {
            this.inputRules.push(rule);
        },

        /**
         * 执行注册的过滤规则
         * @method  filterInputRule
         * @param { UE.uNode } root 要过滤的uNode节点
         * @remind 执行editor.setContent方法和执行'inserthtml'命令后，会运行该过滤函数
         * @example
         * ```javascript
         * editor.filterInputRule(editor.body);
         * ```
         * @see UE.Editor:addInputRule
         */
        filterInputRule: function (root) {
            for (var i = 0, ci; ci = this.inputRules[i++];) {
                ci.call(this, root)
            }
        },

        /**
         * 注册输出过滤规则
         * @method  addOutputRule
         * @param { Function } rule 要添加的过滤规则
         * @example
         * ```javascript
         * editor.addOutputRule(function(root){
         *   $.each(root.getNodesByTagName('p'),function(i,node){
         *       node.tagName="div";
         *   });
         * });
         * ```
         */
        addOutputRule: function (rule) {
            this.outputRules.push(rule)
        },

        /**
         * 根据输出过滤规则，过滤编辑器内容
         * @method  filterOutputRule
         * @remind 执行editor.getContent方法的时候，会先运行该过滤函数
         * @param { UE.uNode } root 要过滤的uNode节点
         * @example
         * ```javascript
         * editor.filterOutputRule(editor.body);
         * ```
         * @see UE.Editor:addOutputRule
         */
        filterOutputRule: function (root) {
            for (var i = 0, ci; ci = this.outputRules[i++];) {
                ci.call(this, root)
            }
        },

        /**
         * 根据action名称获取请求的路径
         * @method  getActionUrl
         * @remind 假如没有设置serverUrl,会根据imageUrl设置默认的controller路径
         * @param { String } action action名称
         * @example
         * ```javascript
         * editor.getActionUrl('config'); //返回 "/ueditor/php/controller.php?action=config"
         * editor.getActionUrl('image'); //返回 "/ueditor/php/controller.php?action=uplaodimage"
         * editor.getActionUrl('scrawl'); //返回 "/ueditor/php/controller.php?action=uplaodscrawl"
         * editor.getActionUrl('imageManager'); //返回 "/ueditor/php/controller.php?action=listimage"
         * ```
         */
        getActionUrl: function(action){
            var actionName = this.getOpt(action) || action,
                imageUrl = this.getOpt('imageUrl'),
                serverUrl = this.getOpt('serverUrl');

            if(!serverUrl && imageUrl) {
                serverUrl = imageUrl.replace(/^(.*[\/]).+([\.].+)$/, '$1controller$2');
            }

            if(serverUrl) {
                serverUrl = serverUrl + (serverUrl.indexOf('?') == -1 ? '?':'&') + 'action=' + (actionName || '');
                return utils.formatUrl(serverUrl);
            } else {
                return '';
            }
        }
    };
    utils.inherits(Editor, EventBase);
})();


// core/Editor.defaultoptions.js
//维护编辑器一下默认的不在插件中的配置项
UE.Editor.defaultOptions = function(editor){

    var _url = editor.options.UEDITOR_HOME_URL;
    return {
        isShow: true,
        initialContent: '',
        initialStyle:'',
        autoClearinitialContent: false,
        iframeCssUrl: _url + 'themes/iframe.css',
        textarea: 'editorValue',
        focus: false,
        focusInEnd: true,
        autoClearEmptyNode: true,
        fullscreen: false,
        readonly: false,
        zIndex: 999,
        imagePopup: true,
        enterTag: 'p',
        customDomain: false,
        lang: 'zh-cn',
        langPath: _url + 'lang/',
        theme: 'default',
        themePath: _url + 'themes/',
        allHtmlEnabled: false,
        scaleEnabled: false,
        tableNativeEditInFF: false,
        autoSyncData : true,
        fileNameFormat: '{time}{rand:6}'
    }
};

// core/loadconfig.js
(function(){

    UE.Editor.prototype.loadServerConfig = function(){
        var me = this;
        setTimeout(function(){
            try{
                me.options.imageUrl && me.setOpt('serverUrl', me.options.imageUrl.replace(/^(.*[\/]).+([\.].+)$/, '$1controller$2'));

                var configUrl = me.getActionUrl('config'),
                    isJsonp = utils.isCrossDomainUrl(configUrl);

                /* 发出ajax请求 */
                me._serverConfigLoaded = false;

                configUrl && UE.ajax.request(configUrl,{
                    'method': 'GET',
                    'dataType': isJsonp ? 'jsonp':'',
                    'onsuccess':function(r){
                        try {
                            var config = isJsonp ? r:eval("("+r.responseText+")");
                            utils.extend(me.options, config);
                            me.fireEvent('serverConfigLoaded');
                            me._serverConfigLoaded = true;
                        } catch (e) {
                            showErrorMsg(me.getLang('loadconfigFormatError'));
                        }
                    },
                    'onerror':function(){
                        showErrorMsg(me.getLang('loadconfigHttpError'));
                    }
                });
            } catch(e){
                showErrorMsg(me.getLang('loadconfigError'));
            }
        });

        function showErrorMsg(msg) {
            console && console.error(msg);
            //me.fireEvent('showMessage', {
            //    'title': msg,
            //    'type': 'error'
            //});
        }
    };

    UE.Editor.prototype.isServerConfigLoaded = function(){
        var me = this;
        return me._serverConfigLoaded || false;
    };

    UE.Editor.prototype.afterConfigReady = function(handler){
        if (!handler || !utils.isFunction(handler)) return;
        var me = this;
        var readyHandler = function(){
            handler.apply(me, arguments);
            me.removeListener('serverConfigLoaded', readyHandler);
        };

        if (me.isServerConfigLoaded()) {
            handler.call(me, 'serverConfigLoaded');
        } else {
            me.addListener('serverConfigLoaded', readyHandler);
        }
    };

})();


// core/ajax.js
/**
 * @file
 * @module UE.ajax
 * @since 1.2.6.1
 */

/**
 * 提供对ajax请求的支持
 * @module UE.ajax
 */
UE.ajax = function() {

    //创建一个ajaxRequest对象
    var fnStr = 'XMLHttpRequest()';
    try {
        new ActiveXObject("Msxml2.XMLHTTP");
        fnStr = 'ActiveXObject(\'Msxml2.XMLHTTP\')';
    } catch (e) {
        try {
            new ActiveXObject("Microsoft.XMLHTTP");
            fnStr = 'ActiveXObject(\'Microsoft.XMLHTTP\')'
        } catch (e) {
        }
    }
    var creatAjaxRequest = new Function('return new ' + fnStr);


    /**
     * 将json参数转化成适合ajax提交的参数列表
     * @param json
     */
    function json2str(json) {
        var strArr = [];
        for (var i in json) {
            //忽略默认的几个参数
            if(i=="method" || i=="timeout" || i=="async" || i=="dataType" || i=="callback") continue;
            //忽略控制
            if(json[i] == undefined || json[i] == null) continue;
            //传递过来的对象和函数不在提交之列
            if (!((typeof json[i]).toLowerCase() == "function" || (typeof json[i]).toLowerCase() == "object")) {
                strArr.push( encodeURIComponent(i) + "="+encodeURIComponent(json[i]) );
            } else if (utils.isArray(json[i])) {
            //支持传数组内容
                for(var j = 0; j < json[i].length; j++) {
                    strArr.push( encodeURIComponent(i) + "[]="+encodeURIComponent(json[i][j]) );
                }
            }
        }
        return strArr.join("&");
    }

    function doAjax(url, ajaxOptions) {
        var xhr = creatAjaxRequest(),
        //是否超时
            timeIsOut = false,
        //默认参数
            defaultAjaxOptions = {
                method:"POST",
                timeout:5000,
                async:true,
                data:{},//需要传递对象的话只能覆盖
                onsuccess:function() {
                },
                onerror:function() {
                }
            };

        if (typeof url === "object") {
            ajaxOptions = url;
            url = ajaxOptions.url;
        }
        if (!xhr || !url) return;
        var ajaxOpts = ajaxOptions ? utils.extend(defaultAjaxOptions,ajaxOptions) : defaultAjaxOptions;

        var submitStr = json2str(ajaxOpts);  // { name:"Jim",city:"Beijing" } --> "name=Jim&city=Beijing"
        //如果用户直接通过data参数传递json对象过来，则也要将此json对象转化为字符串
        if (!utils.isEmptyObject(ajaxOpts.data)){
            submitStr += (submitStr? "&":"") + json2str(ajaxOpts.data);
        }
        //超时检测
        var timerID = setTimeout(function() {
            if (xhr.readyState != 4) {
                timeIsOut = true;
                xhr.abort();
                clearTimeout(timerID);
            }
        }, ajaxOpts.timeout);

        var method = ajaxOpts.method.toUpperCase();
        var str = url + (url.indexOf("?")==-1?"?":"&") + (method=="POST"?"":submitStr+ "&noCache=" + +new Date);
        xhr.open(method, str, ajaxOpts.async);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                if (!timeIsOut && xhr.status == 200) {
                    ajaxOpts.onsuccess(xhr);
                } else {
                    ajaxOpts.onerror(xhr);
                }
            }
        };
        if (method == "POST") {
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.send(submitStr);
        } else {
            xhr.send(null);
        }
    }

    function doJsonp(url, opts) {

        var successhandler = opts.onsuccess || function(){},
            scr = document.createElement('SCRIPT'),
            options = opts || {},
            charset = options['charset'],
            callbackField = options['jsonp'] || 'callback',
            callbackFnName,
            timeOut = options['timeOut'] || 0,
            timer,
            reg = new RegExp('(\\?|&)' + callbackField + '=([^&]*)'),
            matches;

        if (utils.isFunction(successhandler)) {
            callbackFnName = 'bd__editor__' + Math.floor(Math.random() * 2147483648).toString(36);
            window[callbackFnName] = getCallBack(0);
        } else if(utils.isString(successhandler)){
            callbackFnName = successhandler;
        } else {
            if (matches = reg.exec(url)) {
                callbackFnName = matches[2];
            }
        }

        url = url.replace(reg, '\x241' + callbackField + '=' + callbackFnName);

        if (url.search(reg) < 0) {
            url += (url.indexOf('?') < 0 ? '?' : '&') + callbackField + '=' + callbackFnName;
        }

        var queryStr = json2str(opts);  // { name:"Jim",city:"Beijing" } --> "name=Jim&city=Beijing"
        //如果用户直接通过data参数传递json对象过来，则也要将此json对象转化为字符串
        if (!utils.isEmptyObject(opts.data)){
            queryStr += (queryStr? "&":"") + json2str(opts.data);
        }
        if (queryStr) {
            url = url.replace(/\?/, '?' + queryStr + '&');
        }

        scr.onerror = getCallBack(1);
        if( timeOut ){
            timer = setTimeout(getCallBack(1), timeOut);
        }
        createScriptTag(scr, url, charset);

        function createScriptTag(scr, url, charset) {
            scr.setAttribute('type', 'text/javascript');
            scr.setAttribute('defer', 'defer');
            charset && scr.setAttribute('charset', charset);
            scr.setAttribute('src', url);
            document.getElementsByTagName('head')[0].appendChild(scr);
        }

        function getCallBack(onTimeOut){
            return function(){
                try {
                    if(onTimeOut){
                        options.onerror && options.onerror();
                    }else{
                        try{
                            clearTimeout(timer);
                            successhandler.apply(window, arguments);
                        } catch (e){}
                    }
                } catch (exception) {
                    options.onerror && options.onerror.call(window, exception);
                } finally {
                    options.oncomplete && options.oncomplete.apply(window, arguments);
                    scr.parentNode && scr.parentNode.removeChild(scr);
                    window[callbackFnName] = null;
                    try {
                        delete window[callbackFnName];
                    }catch(e){}
                }
            }
        }
    }

    return {
        /**
         * 根据给定的参数项，向指定的url发起一个ajax请求。 ajax请求完成后，会根据请求结果调用相应回调： 如果请求
         * 成功， 则调用onsuccess回调， 失败则调用 onerror 回调
         * @method request
         * @param { URLString } url ajax请求的url地址
         * @param { Object } ajaxOptions ajax请求选项的键值对，支持的选项如下：
         * @example
         * ```javascript
         * //向sayhello.php发起一个异步的Ajax GET请求, 请求超时时间为10s， 请求完成后执行相应的回调。
         * UE.ajax.requeset( 'sayhello.php', {
         *
         *     //请求方法。可选值： 'GET', 'POST'，默认值是'POST'
         *     method: 'GET',
         *
         *     //超时时间。 默认为5000， 单位是ms
         *     timeout: 10000,
         *
         *     //是否是异步请求。 true为异步请求， false为同步请求
         *     async: true,
         *
         *     //请求携带的数据。如果请求为GET请求， data会经过stringify后附加到请求url之后。
         *     data: {
         *         name: 'ueditor'
         *     },
         *
         *     //请求成功后的回调， 该回调接受当前的XMLHttpRequest对象作为参数。
         *     onsuccess: function ( xhr ) {
         *         console.log( xhr.responseText );
         *     },
         *
         *     //请求失败或者超时后的回调。
         *     onerror: function ( xhr ) {
         *          alert( 'Ajax请求失败' );
         *     }
         *
         * } );
         * ```
         */

        /**
         * 根据给定的参数项发起一个ajax请求， 参数项里必须包含一个url地址。 ajax请求完成后，会根据请求结果调用相应回调： 如果请求
         * 成功， 则调用onsuccess回调， 失败则调用 onerror 回调。
         * @method request
         * @warning 如果在参数项里未提供一个key为“url”的地址值，则该请求将直接退出。
         * @param { Object } ajaxOptions ajax请求选项的键值对，支持的选项如下：
         * @example
         * ```javascript
         *
         * //向sayhello.php发起一个异步的Ajax POST请求, 请求超时时间为5s， 请求完成后不执行任何回调。
         * UE.ajax.requeset( 'sayhello.php', {
         *
         *     //请求的地址， 该项是必须的。
         *     url: 'sayhello.php'
         *
         * } );
         * ```
         */
		request:function(url, opts) {
            if (opts && opts.dataType == 'jsonp') {
                doJsonp(url, opts);
            } else {
                doAjax(url, opts);
            }
		},
        getJSONP:function(url, data, fn) {
            var opts = {
                'data': data,
                'oncomplete': fn
            };
            doJsonp(url, opts);
		}
	};


}();


// core/filterword.js
/**
 * UE过滤word的静态方法
 * @file
 */

/**
 * UEditor公用空间，UEditor所有的功能都挂载在该空间下
 * @module UE
 */


/**
 * 根据传入html字符串过滤word
 * @module UE
 * @since 1.2.6.1
 * @method filterWord
 * @param { String } html html字符串
 * @return { String } 已过滤后的结果字符串
 * @example
 * ```javascript
 * UE.filterWord(html);
 * ```
 */
var filterWord = UE.filterWord = function () {

    //是否是word过来的内容
    function isWordDocument( str ) {
        return /(class="?Mso|style="[^"]*\bmso\-|w:WordDocument|<(v|o):|lang=)/ig.test( str );
    }
    //去掉小数
    function transUnit( v ) {
        v = v.replace( /[\d.]+\w+/g, function ( m ) {
            return utils.transUnitToPx(m);
        } );
        return v;
    }

    function filterPasteWord( str ) {
        return str.replace(/[\t\r\n]+/g,' ')
                .replace( /<!--[\s\S]*?-->/ig, "" )
                //转换图片
                .replace(/<v:shape [^>]*>[\s\S]*?.<\/v:shape>/gi,function(str){
                    //opera能自己解析出image所这里直接返回空
                    if(browser.opera){
                        return '';
                    }
                    try{
                        //有可能是bitmap占为图，无用，直接过滤掉，主要体现在粘贴excel表格中
                        if(/Bitmap/i.test(str)){
                            return '';
                        }
                        var width = str.match(/width:([ \d.]*p[tx])/i)[1],
                            height = str.match(/height:([ \d.]*p[tx])/i)[1],
                            src =  str.match(/src=\s*"([^"]*)"/i)[1];
                        return '<img width="'+ transUnit(width) +'" height="'+transUnit(height) +'" src="' + src + '" />';
                    } catch(e){
                        return '';
                    }
                })
                //针对wps添加的多余标签处理
                .replace(/<\/?div[^>]*>/g,'')
                //去掉多余的属性
                .replace( /v:\w+=(["']?)[^'"]+\1/g, '' )
                .replace( /<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|xml|meta|link|style|\w+:\w+)(?=[\s\/>]))[^>]*>/gi, "" )
                .replace( /<p [^>]*class="?MsoHeading"?[^>]*>(.*?)<\/p>/gi, "<p><strong>$1</strong></p>" )
                //去掉多余的属性
                .replace( /\s+(class|lang|align)\s*=\s*(['"]?)([\w-]+)\2/ig, function(str,name,marks,val){
                    //保留list的标示
                    return name == 'class' && val == 'MsoListParagraph' ? str : ''
                })
                //清除多余的font/span不能匹配&nbsp;有可能是空格
                .replace( /<(font|span)[^>]*>(\s*)<\/\1>/gi, function(a,b,c){
                    return c.replace(/[\t\r\n ]+/g,' ')
                })
                //处理style的问题
                .replace( /(<[a-z][^>]*)\sstyle=(["'])([^\2]*?)\2/gi, function( str, tag, tmp, style ) {
                    var n = [],
                        s = style.replace( /^\s+|\s+$/, '' )
                            .replace(/&#39;/g,'\'')
                            .replace( /&quot;/gi, "'" )
                            .replace(/[\d.]+(cm|pt)/g,function(str){
                                return utils.transUnitToPx(str)
                            })
                            .split( /;\s*/g );

                    for ( var i = 0,v; v = s[i];i++ ) {

                        var name, value,
                            parts = v.split( ":" );

                        if ( parts.length == 2 ) {
                            name = parts[0].toLowerCase();
                            value = parts[1].toLowerCase();
                            if(/^(background)\w*/.test(name) && value.replace(/(initial|\s)/g,'').length == 0
                                ||
                                /^(margin)\w*/.test(name) && /^0\w+$/.test(value)
                            ){
                                continue;
                            }

                            switch ( name ) {
                                case "mso-padding-alt":
                                case "mso-padding-top-alt":
                                case "mso-padding-right-alt":
                                case "mso-padding-bottom-alt":
                                case "mso-padding-left-alt":
                                case "mso-margin-alt":
                                case "mso-margin-top-alt":
                                case "mso-margin-right-alt":
                                case "mso-margin-bottom-alt":
                                case "mso-margin-left-alt":
                                //ie下会出现挤到一起的情况
                               //case "mso-table-layout-alt":
                                case "mso-height":
                                case "mso-width":
                                case "mso-vertical-align-alt":
                                    //trace:1819 ff下会解析出padding在table上
                                    if(!/<table/.test(tag))
                                        n[i] = name.replace( /^mso-|-alt$/g, "" ) + ":" + transUnit( value );
                                    continue;
                                case "horiz-align":
                                    n[i] = "text-align:" + value;
                                    continue;

                                case "vert-align":
                                    n[i] = "vertical-align:" + value;
                                    continue;

                                case "font-color":
                                case "mso-foreground":
                                    n[i] = "color:" + value;
                                    continue;

                                case "mso-background":
                                case "mso-highlight":
                                    n[i] = "background:" + value;
                                    continue;

                                case "mso-default-height":
                                    n[i] = "min-height:" + transUnit( value );
                                    continue;

                                case "mso-default-width":
                                    n[i] = "min-width:" + transUnit( value );
                                    continue;

                                case "mso-padding-between-alt":
                                    n[i] = "border-collapse:separate;border-spacing:" + transUnit( value );
                                    continue;

                                case "text-line-through":
                                    if ( (value == "single") || (value == "double") ) {
                                        n[i] = "text-decoration:line-through";
                                    }
                                    continue;
                                case "mso-zero-height":
                                    if ( value == "yes" ) {
                                        n[i] = "display:none";
                                    }
                                    continue;
//                                case 'background':
//                                    break;
                                case 'margin':
                                    if ( !/[1-9]/.test( value ) ) {
                                        continue;
                                    }

                            }

                            if ( /^(mso|column|font-emph|lang|layout|line-break|list-image|nav|panose|punct|row|ruby|sep|size|src|tab-|table-border|text-(?:decor|trans)|top-bar|version|vnd|word-break)/.test( name )
                                ||
                                /text\-indent|padding|margin/.test(name) && /\-[\d.]+/.test(value)
                            ) {
                                continue;
                            }

                            n[i] = name + ":" + parts[1];
                        }
                    }
                    return tag + (n.length ? ' style="' + n.join( ';').replace(/;{2,}/g,';') + '"' : '');
                })


    }

    return function ( html ) {
        return (isWordDocument( html ) ? filterPasteWord( html ) : html);
    };
}();

// core/node.js
/**
 * 编辑器模拟的节点类
 * @file
 * @module UE
 * @class uNode
 * @since 1.2.6.1
 */

/**
 * UEditor公用空间，UEditor所有的功能都挂载在该空间下
 * @unfile
 * @module UE
 */

(function () {

    /**
     * 编辑器模拟的节点类
     * @unfile
     * @module UE
     * @class uNode
     */

    /**
     * 通过一个键值对，创建一个uNode对象
     * @constructor
     * @param { Object } attr 传入要创建的uNode的初始属性
     * @example
     * ```javascript
     * var node = new uNode({
     *     type:'element',
     *     tagName:'span',
     *     attrs:{style:'font-size:14px;'}
     * }
     * ```
     */
    var uNode = UE.uNode = function (obj) {
        this.type = obj.type;
        this.data = obj.data;
        this.tagName = obj.tagName;
        this.parentNode = obj.parentNode;
        this.attrs = obj.attrs || {};
        this.children = obj.children;
    };

    var notTransAttrs = {
        'href':1,
        'src':1,
        '_src':1,
        '_href':1,
        'cdata_data':1
    };

    var notTransTagName = {
        style:1,
        script:1
    };

    var indentChar = '    ',
        breakChar = '\n';

    function insertLine(arr, current, begin) {
        arr.push(breakChar);
        return current + (begin ? 1 : -1);
    }

    function insertIndent(arr, current) {
        //插入缩进
        for (var i = 0; i < current; i++) {
            arr.push(indentChar);
        }
    }

    //创建uNode的静态方法
    //支持标签和html
    uNode.createElement = function (html) {
        if (/[<>]/.test(html)) {
            return UE.htmlparser(html).children[0]
        } else {
            return new uNode({
                type:'element',
                children:[],
                tagName:html
            })
        }
    };
    uNode.createText = function (data,noTrans) {
        return new UE.uNode({
            type:'text',
            'data':noTrans ? data : utils.unhtml(data || '')
        })
    };
    function nodeToHtml(node, arr, formatter, current) {
        switch (node.type) {
            case 'root':
                for (var i = 0, ci; ci = node.children[i++];) {
                    //插入新行
                    if (formatter && ci.type == 'element' && !dtd.$inlineWithA[ci.tagName] && i > 1) {
                        insertLine(arr, current, true);
                        insertIndent(arr, current)
                    }
                    nodeToHtml(ci, arr, formatter, current)
                }
                break;
            case 'text':
                isText(node, arr);
                break;
            case 'element':
                isElement(node, arr, formatter, current);
                break;
            case 'comment':
                isComment(node, arr, formatter);
        }
        return arr;
    }

    function isText(node, arr) {
        if(node.parentNode.tagName == 'pre'){
            //源码模式下输入html标签，不能做转换处理，直接输出
            arr.push(node.data)
        }else{
            arr.push(notTransTagName[node.parentNode.tagName] ? utils.html(node.data) : node.data.replace(/[ ]{2}/g,' &nbsp;'))
        }

    }

    function isElement(node, arr, formatter, current) {
        var attrhtml = '';
        if (node.attrs) {
            attrhtml = [];
            var attrs = node.attrs;
            for (var a in attrs) {
                //这里就针对
                //<p>'<img src='http://nsclick.baidu.com/u.gif?&asdf=\"sdf&asdfasdfs;asdf'></p>
                //这里边的\"做转换，要不用innerHTML直接被截断了，属性src
                //有可能做的不够
                attrhtml.push(a + (attrs[a] !== undefined ? '="' + (notTransAttrs[a] ? utils.html(attrs[a]).replace(/["]/g, function (a) {
                   return '&quot;'
                }) : utils.unhtml(attrs[a])) + '"' : ''))
            }
            attrhtml = attrhtml.join(' ');
        }
        arr.push('<' + node.tagName +
            (attrhtml ? ' ' + attrhtml  : '') +
            (dtd.$empty[node.tagName] ? '\/' : '' ) + '>'
        );
        //插入新行
        if (formatter  &&  !dtd.$inlineWithA[node.tagName] && node.tagName != 'pre') {
            if(node.children && node.children.length){
                current = insertLine(arr, current, true);
                insertIndent(arr, current)
            }

        }
        if (node.children && node.children.length) {
            for (var i = 0, ci; ci = node.children[i++];) {
                if (formatter && ci.type == 'element' &&  !dtd.$inlineWithA[ci.tagName] && i > 1) {
                    insertLine(arr, current);
                    insertIndent(arr, current)
                }
                nodeToHtml(ci, arr, formatter, current)
            }
        }
        if (!dtd.$empty[node.tagName]) {
            if (formatter && !dtd.$inlineWithA[node.tagName]  && node.tagName != 'pre') {

                if(node.children && node.children.length){
                    current = insertLine(arr, current);
                    insertIndent(arr, current)
                }
            }
            arr.push('<\/' + node.tagName + '>');
        }

    }

    function isComment(node, arr) {
        arr.push('<!--' + node.data + '-->');
    }

    function getNodeById(root, id) {
        var node;
        if (root.type == 'element' && root.getAttr('id') == id) {
            return root;
        }
        if (root.children && root.children.length) {
            for (var i = 0, ci; ci = root.children[i++];) {
                if (node = getNodeById(ci, id)) {
                    return node;
                }
            }
        }
    }

    function getNodesByTagName(node, tagName, arr) {
        if (node.type == 'element' && node.tagName == tagName) {
            arr.push(node);
        }
        if (node.children && node.children.length) {
            for (var i = 0, ci; ci = node.children[i++];) {
                getNodesByTagName(ci, tagName, arr)
            }
        }
    }
    function nodeTraversal(root,fn){
        if(root.children && root.children.length){
            for(var i= 0,ci;ci=root.children[i];){
                nodeTraversal(ci,fn);
                //ci被替换的情况，这里就不再走 fn了
                if(ci.parentNode ){
                    if(ci.children && ci.children.length){
                        fn(ci)
                    }
                    if(ci.parentNode) i++
                }
            }
        }else{
            fn(root)
        }

    }
    uNode.prototype = {

        /**
         * 当前节点对象，转换成html文本
         * @method toHtml
         * @return { String } 返回转换后的html字符串
         * @example
         * ```javascript
         * node.toHtml();
         * ```
         */

        /**
         * 当前节点对象，转换成html文本
         * @method toHtml
         * @param { Boolean } formatter 是否格式化返回值
         * @return { String } 返回转换后的html字符串
         * @example
         * ```javascript
         * node.toHtml( true );
         * ```
         */
        toHtml:function (formatter) {
            var arr = [];
            nodeToHtml(this, arr, formatter, 0);
            return arr.join('')
        },

        /**
         * 获取节点的html内容
         * @method innerHTML
         * @warning 假如节点的type不是'element'，或节点的标签名称不在dtd列表里，直接返回当前节点
         * @return { String } 返回节点的html内容
         * @example
         * ```javascript
         * var htmlstr = node.innerHTML();
         * ```
         */

        /**
         * 设置节点的html内容
         * @method innerHTML
         * @warning 假如节点的type不是'element'，或节点的标签名称不在dtd列表里，直接返回当前节点
         * @param { String } htmlstr 传入要设置的html内容
         * @return { UE.uNode } 返回节点本身
         * @example
         * ```javascript
         * node.innerHTML('<span>text</span>');
         * ```
         */
        innerHTML:function (htmlstr) {
            if (this.type != 'element' || dtd.$empty[this.tagName]) {
                return this;
            }
            if (utils.isString(htmlstr)) {
                if(this.children){
                    for (var i = 0, ci; ci = this.children[i++];) {
                        ci.parentNode = null;
                    }
                }
                this.children = [];
                var tmpRoot = UE.htmlparser(htmlstr);
                for (var i = 0, ci; ci = tmpRoot.children[i++];) {
                    this.children.push(ci);
                    ci.parentNode = this;
                }
                return this;
            } else {
                var tmpRoot = new UE.uNode({
                    type:'root',
                    children:this.children
                });
                return tmpRoot.toHtml();
            }
        },

        /**
         * 获取节点的纯文本内容
         * @method innerText
         * @warning 假如节点的type不是'element'，或节点的标签名称不在dtd列表里，直接返回当前节点
         * @return { String } 返回节点的存文本内容
         * @example
         * ```javascript
         * var textStr = node.innerText();
         * ```
         */

        /**
         * 设置节点的纯文本内容
         * @method innerText
         * @warning 假如节点的type不是'element'，或节点的标签名称不在dtd列表里，直接返回当前节点
         * @param { String } textStr 传入要设置的文本内容
         * @return { UE.uNode } 返回节点本身
         * @example
         * ```javascript
         * node.innerText('<span>text</span>');
         * ```
         */
        innerText:function (textStr,noTrans) {
            if (this.type != 'element' || dtd.$empty[this.tagName]) {
                return this;
            }
            if (textStr) {
                if(this.children){
                    for (var i = 0, ci; ci = this.children[i++];) {
                        ci.parentNode = null;
                    }
                }
                this.children = [];
                this.appendChild(uNode.createText(textStr,noTrans));
                return this;
            } else {
                return this.toHtml().replace(/<[^>]+>/g, '');
            }
        },

        /**
         * 获取当前对象的data属性
         * @method getData
         * @return { Object } 若节点的type值是elemenet，返回空字符串，否则返回节点的data属性
         * @example
         * ```javascript
         * node.getData();
         * ```
         */
        getData:function () {
            if (this.type == 'element')
                return '';
            return this.data
        },

        /**
         * 获取当前节点下的第一个子节点
         * @method firstChild
         * @return { UE.uNode } 返回第一个子节点
         * @example
         * ```javascript
         * node.firstChild(); //返回第一个子节点
         * ```
         */
        firstChild:function () {
//            if (this.type != 'element' || dtd.$empty[this.tagName]) {
//                return this;
//            }
            return this.children ? this.children[0] : null;
        },

        /**
         * 获取当前节点下的最后一个子节点
         * @method lastChild
         * @return { UE.uNode } 返回最后一个子节点
         * @example
         * ```javascript
         * node.lastChild(); //返回最后一个子节点
         * ```
         */
        lastChild:function () {
//            if (this.type != 'element' || dtd.$empty[this.tagName] ) {
//                return this;
//            }
            return this.children ? this.children[this.children.length - 1] : null;
        },

        /**
         * 获取和当前节点有相同父亲节点的前一个节点
         * @method previousSibling
         * @return { UE.uNode } 返回前一个节点
         * @example
         * ```javascript
         * node.children[2].previousSibling(); //返回子节点node.children[1]
         * ```
         */
        previousSibling : function(){
            var parent = this.parentNode;
            for (var i = 0, ci; ci = parent.children[i]; i++) {
                if (ci === this) {
                   return i == 0 ? null : parent.children[i-1];
                }
            }

        },

        /**
         * 获取和当前节点有相同父亲节点的后一个节点
         * @method nextSibling
         * @return { UE.uNode } 返回后一个节点,找不到返回null
         * @example
         * ```javascript
         * node.children[2].nextSibling(); //如果有，返回子节点node.children[3]
         * ```
         */
        nextSibling : function(){
            var parent = this.parentNode;
            for (var i = 0, ci; ci = parent.children[i++];) {
                if (ci === this) {
                    return parent.children[i];
                }
            }
        },

        /**
         * 用新的节点替换当前节点
         * @method replaceChild
         * @param { UE.uNode } target 要替换成该节点参数
         * @param { UE.uNode } source 要被替换掉的节点
         * @return { UE.uNode } 返回替换之后的节点对象
         * @example
         * ```javascript
         * node.replaceChild(newNode, childNode); //用newNode替换childNode,childNode是node的子节点
         * ```
         */
        replaceChild:function (target, source) {
            if (this.children) {
                if(target.parentNode){
                    target.parentNode.removeChild(target);
                }
                for (var i = 0, ci; ci = this.children[i]; i++) {
                    if (ci === source) {
                        this.children.splice(i, 1, target);
                        source.parentNode = null;
                        target.parentNode = this;
                        return target;
                    }
                }
            }
        },

        /**
         * 在节点的子节点列表最后位置插入一个节点
         * @method appendChild
         * @param { UE.uNode } node 要插入的节点
         * @return { UE.uNode } 返回刚插入的子节点
         * @example
         * ```javascript
         * node.appendChild( newNode ); //在node内插入子节点newNode
         * ```
         */
        appendChild:function (node) {
            if (this.type == 'root' || (this.type == 'element' && !dtd.$empty[this.tagName])) {
                if (!this.children) {
                    this.children = []
                }
                if(node.parentNode){
                    node.parentNode.removeChild(node);
                }
                for (var i = 0, ci; ci = this.children[i]; i++) {
                    if (ci === node) {
                        this.children.splice(i, 1);
                        break;
                    }
                }
                this.children.push(node);
                node.parentNode = this;
                return node;
            }


        },

        /**
         * 在传入节点的前面插入一个节点
         * @method insertBefore
         * @param { UE.uNode } target 要插入的节点
         * @param { UE.uNode } source 在该参数节点前面插入
         * @return { UE.uNode } 返回刚插入的子节点
         * @example
         * ```javascript
         * node.parentNode.insertBefore(newNode, node); //在node节点后面插入newNode
         * ```
         */
        insertBefore:function (target, source) {
            if (this.children) {
                if(target.parentNode){
                    target.parentNode.removeChild(target);
                }
                for (var i = 0, ci; ci = this.children[i]; i++) {
                    if (ci === source) {
                        this.children.splice(i, 0, target);
                        target.parentNode = this;
                        return target;
                    }
                }

            }
        },

        /**
         * 在传入节点的后面插入一个节点
         * @method insertAfter
         * @param { UE.uNode } target 要插入的节点
         * @param { UE.uNode } source 在该参数节点后面插入
         * @return { UE.uNode } 返回刚插入的子节点
         * @example
         * ```javascript
         * node.parentNode.insertAfter(newNode, node); //在node节点后面插入newNode
         * ```
         */
        insertAfter:function (target, source) {
            if (this.children) {
                if(target.parentNode){
                    target.parentNode.removeChild(target);
                }
                for (var i = 0, ci; ci = this.children[i]; i++) {
                    if (ci === source) {
                        this.children.splice(i + 1, 0, target);
                        target.parentNode = this;
                        return target;
                    }

                }
            }
        },

        /**
         * 从当前节点的子节点列表中，移除节点
         * @method removeChild
         * @param { UE.uNode } node 要移除的节点引用
         * @param { Boolean } keepChildren 是否保留移除节点的子节点，若传入true，自动把移除节点的子节点插入到移除的位置
         * @return { * } 返回刚移除的子节点
         * @example
         * ```javascript
         * node.removeChild(childNode,true); //在node的子节点列表中移除child节点，并且吧child的子节点插入到移除的位置
         * ```
         */
        removeChild:function (node,keepChildren) {
            if (this.children) {
                for (var i = 0, ci; ci = this.children[i]; i++) {
                    if (ci === node) {
                        this.children.splice(i, 1);
                        ci.parentNode = null;
                        if(keepChildren && ci.children && ci.children.length){
                            for(var j= 0,cj;cj=ci.children[j];j++){
                                this.children.splice(i+j,0,cj);
                                cj.parentNode = this;

                            }
                        }
                        return ci;
                    }
                }
            }
        },

        /**
         * 获取当前节点所代表的元素属性，即获取attrs对象下的属性值
         * @method getAttr
         * @param { String } attrName 要获取的属性名称
         * @return { * } 返回attrs对象下的属性值
         * @example
         * ```javascript
         * node.getAttr('title');
         * ```
         */
        getAttr:function (attrName) {
            return this.attrs && this.attrs[attrName.toLowerCase()]
        },

        /**
         * 设置当前节点所代表的元素属性，即设置attrs对象下的属性值
         * @method setAttr
         * @param { String } attrName 要设置的属性名称
         * @param { * } attrVal 要设置的属性值，类型视设置的属性而定
         * @return { * } 返回attrs对象下的属性值
         * @example
         * ```javascript
         * node.setAttr('title','标题');
         * ```
         */
        setAttr:function (attrName, attrVal) {
            if (!attrName) {
                delete this.attrs;
                return;
            }
            if(!this.attrs){
                this.attrs = {};
            }
            if (utils.isObject(attrName)) {
                for (var a in attrName) {
                    if (!attrName[a]) {
                        delete this.attrs[a]
                    } else {
                        this.attrs[a.toLowerCase()] = attrName[a];
                    }
                }
            } else {
                if (!attrVal) {
                    delete this.attrs[attrName]
                } else {
                    this.attrs[attrName.toLowerCase()] = attrVal;
                }

            }
        },

        /**
         * 获取当前节点在父节点下的位置索引
         * @method getIndex
         * @return { Number } 返回索引数值，如果没有父节点，返回-1
         * @example
         * ```javascript
         * node.getIndex();
         * ```
         */
        getIndex:function(){
            var parent = this.parentNode;
            for(var i= 0,ci;ci=parent.children[i];i++){
                if(ci === this){
                    return i;
                }
            }
            return -1;
        },

        /**
         * 在当前节点下，根据id查找节点
         * @method getNodeById
         * @param { String } id 要查找的id
         * @return { UE.uNode } 返回找到的节点
         * @example
         * ```javascript
         * node.getNodeById('textId');
         * ```
         */
        getNodeById:function (id) {
            var node;
            if (this.children && this.children.length) {
                for (var i = 0, ci; ci = this.children[i++];) {
                    if (node = getNodeById(ci, id)) {
                        return node;
                    }
                }
            }
        },

        /**
         * 在当前节点下，根据元素名称查找节点列表
         * @method getNodesByTagName
         * @param { String } tagNames 要查找的元素名称
         * @return { Array } 返回找到的节点列表
         * @example
         * ```javascript
         * node.getNodesByTagName('span');
         * ```
         */
        getNodesByTagName:function (tagNames) {
            tagNames = utils.trim(tagNames).replace(/[ ]{2,}/g, ' ').split(' ');
            var arr = [], me = this;
            utils.each(tagNames, function (tagName) {
                if (me.children && me.children.length) {
                    for (var i = 0, ci; ci = me.children[i++];) {
                        getNodesByTagName(ci, tagName, arr)
                    }
                }
            });
            return arr;
        },

        /**
         * 根据样式名称，获取节点的样式值
         * @method getStyle
         * @param { String } name 要获取的样式名称
         * @return { String } 返回样式值
         * @example
         * ```javascript
         * node.getStyle('font-size');
         * ```
         */
        getStyle:function (name) {
            var cssStyle = this.getAttr('style');
            if (!cssStyle) {
                return ''
            }
            var reg = new RegExp('(^|;)\\s*' + name + ':([^;]+)','i');
            var match = cssStyle.match(reg);
            if (match && match[0]) {
                return match[2]
            }
            return '';
        },

        /**
         * 给节点设置样式
         * @method setStyle
         * @param { String } name 要设置的的样式名称
         * @param { String } val 要设置的的样值
         * @example
         * ```javascript
         * node.setStyle('font-size', '12px');
         * ```
         */
        setStyle:function (name, val) {
            function exec(name, val) {
                var reg = new RegExp('(^|;)\\s*' + name + ':([^;]+;?)', 'gi');
                cssStyle = cssStyle.replace(reg, '$1');
                if (val) {
                    cssStyle = name + ':' + utils.unhtml(val) + ';' + cssStyle
                }

            }

            var cssStyle = this.getAttr('style');
            if (!cssStyle) {
                cssStyle = '';
            }
            if (utils.isObject(name)) {
                for (var a in name) {
                    exec(a, name[a])
                }
            } else {
                exec(name, val)
            }
            this.setAttr('style', utils.trim(cssStyle))
        },

        /**
         * 传入一个函数，递归遍历当前节点下的所有节点
         * @method traversal
         * @param { Function } fn 遍历到节点的时，传入节点作为参数，运行此函数
         * @example
         * ```javascript
         * traversal(node, function(){
         *     console.log(node.type);
         * });
         * ```
         */
        traversal:function(fn){
            if(this.children && this.children.length){
                nodeTraversal(this,fn);
            }
            return this;
        }
    }
})();


// core/htmlparser.js
/**
 * html字符串转换成uNode节点
 * @file
 * @module UE
 * @since 1.2.6.1
 */

/**
 * UEditor公用空间，UEditor所有的功能都挂载在该空间下
 * @unfile
 * @module UE
 */

/**
 * html字符串转换成uNode节点的静态方法
 * @method htmlparser
 * @param { String } htmlstr 要转换的html代码
 * @param { Boolean } ignoreBlank 若设置为true，转换的时候忽略\n\r\t等空白字符
 * @return { uNode } 给定的html片段转换形成的uNode对象
 * @example
 * ```javascript
 * var root = UE.htmlparser('<p><b>htmlparser</b></p>', true);
 * ```
 */

var htmlparser = UE.htmlparser = function (htmlstr,ignoreBlank) {
    //todo 原来的方式  [^"'<>\/] 有\/就不能配对上 <TD vAlign=top background=../AAA.JPG> 这样的标签了
    //先去掉了，加上的原因忘了，这里先记录
    var re_tag = /<(?:(?:\/([^>]+)>)|(?:!--([\S|\s]*?)-->)|(?:([^\s\/<>]+)\s*((?:(?:"[^"]*")|(?:'[^']*')|[^"'<>])*)\/?>))/g,
        re_attr = /([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g;

    //ie下取得的html可能会有\n存在，要去掉，在处理replace(/[\t\r\n]*/g,'');代码高量的\n不能去除
    var allowEmptyTags = {
        b:1,code:1,i:1,u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,span:1,
        sub:1,img:1,sup:1,font:1,big:1,small:1,iframe:1,a:1,br:1,pre:1
    };
    htmlstr = htmlstr.replace(new RegExp(domUtils.fillChar, 'g'), '');
    if(!ignoreBlank){
        htmlstr = htmlstr.replace(new RegExp('[\\r\\t\\n'+(ignoreBlank?'':' ')+']*<\/?(\\w+)\\s*(?:[^>]*)>[\\r\\t\\n'+(ignoreBlank?'':' ')+']*','g'), function(a,b){
            //br暂时单独处理
            if(b && allowEmptyTags[b.toLowerCase()]){
                return a.replace(/(^[\n\r]+)|([\n\r]+$)/g,'');
            }
            return a.replace(new RegExp('^[\\r\\n'+(ignoreBlank?'':' ')+']+'),'').replace(new RegExp('[\\r\\n'+(ignoreBlank?'':' ')+']+$'),'');
        });
    }

    var notTransAttrs = {
        'href':1,
        'src':1
    };

    var uNode = UE.uNode,
        needParentNode = {
            'td':'tr',
            'tr':['tbody','thead','tfoot'],
            'tbody':'table',
            'th':'tr',
            'thead':'table',
            'tfoot':'table',
            'caption':'table',
            'li':['ul', 'ol'],
            'dt':'dl',
            'dd':'dl',
            'option':'select'
        },
        needChild = {
            'ol':'li',
            'ul':'li'
        };

    function text(parent, data) {

        if(needChild[parent.tagName]){
            var tmpNode = uNode.createElement(needChild[parent.tagName]);
            parent.appendChild(tmpNode);
            tmpNode.appendChild(uNode.createText(data));
            parent = tmpNode;
        }else{

            parent.appendChild(uNode.createText(data));
        }
    }

    function element(parent, tagName, htmlattr) {
        var needParentTag;
        if (needParentTag = needParentNode[tagName]) {
            var tmpParent = parent,hasParent;
            while(tmpParent.type != 'root'){
                if(utils.isArray(needParentTag) ? utils.indexOf(needParentTag, tmpParent.tagName) != -1 : needParentTag == tmpParent.tagName){
                    parent = tmpParent;
                    hasParent = true;
                    break;
                }
                tmpParent = tmpParent.parentNode;
            }
            if(!hasParent){
                parent = element(parent, utils.isArray(needParentTag) ? needParentTag[0] : needParentTag)
            }
        }
        //按dtd处理嵌套
//        if(parent.type != 'root' && !dtd[parent.tagName][tagName])
//            parent = parent.parentNode;
        var elm = new uNode({
            parentNode:parent,
            type:'element',
            tagName:tagName.toLowerCase(),
            //是自闭合的处理一下
            children:dtd.$empty[tagName] ? null : []
        });
        //如果属性存在，处理属性
        if (htmlattr) {
            var attrs = {}, match;
            while (match = re_attr.exec(htmlattr)) {
                attrs[match[1].toLowerCase()] = notTransAttrs[match[1].toLowerCase()] ? (match[2] || match[3] || match[4]) : utils.unhtml(match[2] || match[3] || match[4])
            }
            elm.attrs = attrs;
        }
        //trace:3970
//        //如果parent下不能放elm
//        if(dtd.$inline[parent.tagName] && dtd.$block[elm.tagName] && !dtd[parent.tagName][elm.tagName]){
//            parent = parent.parentNode;
//            elm.parentNode = parent;
//        }
        parent.children.push(elm);
        //如果是自闭合节点返回父亲节点
        return  dtd.$empty[tagName] ? parent : elm
    }

    function comment(parent, data) {
        parent.children.push(new uNode({
            type:'comment',
            data:data,
            parentNode:parent
        }));
    }

    var match, currentIndex = 0, nextIndex = 0;
    //设置根节点
    var root = new uNode({
        type:'root',
        children:[]
    });
    var currentParent = root;

    while (match = re_tag.exec(htmlstr)) {
        currentIndex = match.index;
        try{
            if (currentIndex > nextIndex) {
                //text node
                text(currentParent, htmlstr.slice(nextIndex, currentIndex));
            }
            if (match[3]) {

                if(dtd.$cdata[currentParent.tagName]){
                    text(currentParent, match[0]);
                }else{
                    //start tag
                    currentParent = element(currentParent, match[3].toLowerCase(), match[4]);
                }


            } else if (match[1]) {
                if(currentParent.type != 'root'){
                    if(dtd.$cdata[currentParent.tagName] && !dtd.$cdata[match[1]]){
                        text(currentParent, match[0]);
                    }else{
                        var tmpParent = currentParent;
                        while(currentParent.type == 'element' && currentParent.tagName != match[1].toLowerCase()){
                            currentParent = currentParent.parentNode;
                            if(currentParent.type == 'root'){
                                currentParent = tmpParent;
                                throw 'break'
                            }
                        }
                        //end tag
                        currentParent = currentParent.parentNode;
                    }

                }

            } else if (match[2]) {
                //comment
                comment(currentParent, match[2])
            }
        }catch(e){}

        nextIndex = re_tag.lastIndex;

    }
    //如果结束是文本，就有可能丢掉，所以这里手动判断一下
    //例如 <li>sdfsdfsdf<li>sdfsdfsdfsdf
    if (nextIndex < htmlstr.length) {
        text(currentParent, htmlstr.slice(nextIndex));
    }
    return root;
};


// core/filternode.js
/**
 * UE过滤节点的静态方法
 * @file
 */

/**
 * UEditor公用空间，UEditor所有的功能都挂载在该空间下
 * @module UE
 */


/**
 * 根据传入节点和过滤规则过滤相应节点
 * @module UE
 * @since 1.2.6.1
 * @method filterNode
 * @param { Object } root 指定root节点
 * @param { Object } rules 过滤规则json对象
 * @example
 * ```javascript
 * UE.filterNode(root,editor.options.filterRules);
 * ```
 */
var filterNode = UE.filterNode = function () {
    function filterNode(node,rules){
        switch (node.type) {
            case 'text':
                break;
            case 'element':
                var val;
                if(val = rules[node.tagName]){
                   if(val === '-'){
                       node.parentNode.removeChild(node)
                   }else if(utils.isFunction(val)){
                       var parentNode = node.parentNode,
                           index = node.getIndex();
                       val(node);
                       if(node.parentNode){
                           if(node.children){
                               for(var i = 0,ci;ci=node.children[i];){
                                   filterNode(ci,rules);
                                   if(ci.parentNode){
                                       i++;
                                   }
                               }
                           }
                       }else{
                           for(var i = index,ci;ci=parentNode.children[i];){
                               filterNode(ci,rules);
                               if(ci.parentNode){
                                   i++;
                               }
                           }
                       }


                   }else{
                       var attrs = val['$'];
                       if(attrs && node.attrs){
                           var tmpAttrs = {},tmpVal;
                           for(var a in attrs){
                               tmpVal = node.getAttr(a);
                               //todo 只先对style单独处理
                               if(a == 'style' && utils.isArray(attrs[a])){
                                   var tmpCssStyle = [];
                                   utils.each(attrs[a],function(v){
                                       var tmp;
                                       if(tmp = node.getStyle(v)){
                                           tmpCssStyle.push(v + ':' + tmp);
                                       }
                                   });
                                   tmpVal = tmpCssStyle.join(';')
                               }
                               if(tmpVal){
                                   tmpAttrs[a] = tmpVal;
                               }

                           }
                           node.attrs = tmpAttrs;
                       }
                       if(node.children){
                           for(var i = 0,ci;ci=node.children[i];){
                               filterNode(ci,rules);
                               if(ci.parentNode){
                                   i++;
                               }
                           }
                       }
                   }
                }else{
                    //如果不在名单里扣出子节点并删除该节点,cdata除外
                    if(dtd.$cdata[node.tagName]){
                        node.parentNode.removeChild(node)
                    }else{
                        var parentNode = node.parentNode,
                            index = node.getIndex();
                        node.parentNode.removeChild(node,true);
                        for(var i = index,ci;ci=parentNode.children[i];){
                            filterNode(ci,rules);
                            if(ci.parentNode){
                                i++;
                            }
                        }
                    }
                }
                break;
            case 'comment':
                node.parentNode.removeChild(node)
        }

    }
    return function(root,rules){
        if(utils.isEmptyObject(rules)){
            return root;
        }
        var val;
        if(val = rules['-']){
            utils.each(val.split(' '),function(k){
                rules[k] = '-'
            })
        }
        for(var i= 0,ci;ci=root.children[i];){
            filterNode(ci,rules);
            if(ci.parentNode){
               i++;
            }
        }
        return root;
    }
}();

// core/plugin.js
/**
 * Created with JetBrains PhpStorm.
 * User: campaign
 * Date: 10/8/13
 * Time: 6:15 PM
 * To change this template use File | Settings | File Templates.
 */
UE.plugin = function(){
    var _plugins = {};
    return {
        register : function(pluginName,fn,oldOptionName,afterDisabled){
            if(oldOptionName && utils.isFunction(oldOptionName)){
                afterDisabled = oldOptionName;
                oldOptionName = null
            }
            _plugins[pluginName] = {
                optionName : oldOptionName || pluginName,
                execFn : fn,
                //当插件被禁用时执行
                afterDisabled : afterDisabled
            }
        },
        load : function(editor){
            utils.each(_plugins,function(plugin){
                var _export = plugin.execFn.call(editor);
                if(editor.options[plugin.optionName] !== false){
                    if(_export){
                        //后边需要再做扩展
                        utils.each(_export,function(v,k){
                            switch(k.toLowerCase()){
                                case 'shortcutkey':
                                    editor.addshortcutkey(v);
                                    break;
                                case 'bindevents':
                                    utils.each(v,function(fn,eventName){
                                        editor.addListener(eventName,fn);
                                    });
                                    break;
                                case 'bindmultievents':
                                    utils.each(utils.isArray(v) ? v:[v],function(event){
                                        var types = utils.trim(event.type).split(/\s+/);
                                        utils.each(types,function(eventName){
                                            editor.addListener(eventName, event.handler);
                                        });
                                    });
                                    break;
                                case 'commands':
                                    utils.each(v,function(execFn,execName){
                                        editor.commands[execName] = execFn
                                    });
                                    break;
                                case 'outputrule':
                                    editor.addOutputRule(v);
                                    break;
                                case 'inputrule':
                                    editor.addInputRule(v);
                                    break;
                                case 'defaultoptions':
                                    editor.setOpt(v)
                            }
                        })
                    }

                }else if(plugin.afterDisabled){
                    plugin.afterDisabled.call(editor)
                }

            });
            //向下兼容
            utils.each(UE.plugins,function(plugin){
                plugin.call(editor);
            });
        },
        run : function(pluginName,editor){
            var plugin = _plugins[pluginName];
            if(plugin){
                plugin.exeFn.call(editor)
            }
        }
    }
}();

// core/keymap.js
var keymap = UE.keymap  = {
    'Backspace' : 8,
    'Tab' : 9,
    'Enter' : 13,

    'Shift':16,
    'Control':17,
    'Alt':18,
    'CapsLock':20,

    'Esc':27,

    'Spacebar':32,

    'PageUp':33,
    'PageDown':34,
    'End':35,
    'Home':36,

    'Left':37,
    'Up':38,
    'Right':39,
    'Down':40,

    'Insert':45,

    'Del':46,

    'NumLock':144,

    'Cmd':91,

    '=':187,
    '-':189,

    "b":66,
    'i':73,
    //回退
    'z':90,
    'y':89,
    //粘贴
    'v' : 86,
    'x' : 88,

    's' : 83,

    'n' : 78
};

// core/localstorage.js
//存储媒介封装
var LocalStorage = UE.LocalStorage = (function () {

    var storage = window.localStorage || getUserData() || null,
        LOCAL_FILE = 'localStorage';

    return {

        saveLocalData: function (key, data) {

            if (storage && data) {
                storage.setItem(key, data);
                return true;
            }

            return false;

        },

        getLocalData: function (key) {

            if (storage) {
                return storage.getItem(key);
            }

            return null;

        },

        removeItem: function (key) {

            storage && storage.removeItem(key);

        }

    };

    function getUserData() {

        var container = document.createElement("div");
        container.style.display = "none";

        if (!container.addBehavior) {
            return null;
        }

        container.addBehavior("#default#userdata");

        return {

            getItem: function (key) {

                var result = null;

                try {
                    document.body.appendChild(container);
                    container.load(LOCAL_FILE);
                    result = container.getAttribute(key);
                    document.body.removeChild(container);
                } catch (e) {
                }

                return result;

            },

            setItem: function (key, value) {

                document.body.appendChild(container);
                container.setAttribute(key, value);
                container.save(LOCAL_FILE);
                document.body.removeChild(container);

            },

            //// 暂时没有用到
            //clear: function () {
            //
            //    var expiresTime = new Date();
            //    expiresTime.setFullYear(expiresTime.getFullYear() - 1);
            //    document.body.appendChild(container);
            //    container.expires = expiresTime.toUTCString();
            //    container.save(LOCAL_FILE);
            //    document.body.removeChild(container);
            //
            //},

            removeItem: function (key) {

                document.body.appendChild(container);
                container.removeAttribute(key);
                container.save(LOCAL_FILE);
                document.body.removeChild(container);

            }

        };

    }

})();

(function () {

    var ROOTKEY = 'ueditor_preference';

    UE.Editor.prototype.setPreferences = function(key,value){
        var obj = {};
        if (utils.isString(key)) {
            obj[ key ] = value;
        } else {
            obj = key;
        }
        var data = LocalStorage.getLocalData(ROOTKEY);
        if (data && (data = utils.str2json(data))) {
            utils.extend(data, obj);
        } else {
            data = obj;
        }
        data && LocalStorage.saveLocalData(ROOTKEY, utils.json2str(data));
    };

    UE.Editor.prototype.getPreferences = function(key){
        var data = LocalStorage.getLocalData(ROOTKEY);
        if (data && (data = utils.str2json(data))) {
            return key ? data[key] : data
        }
        return null;
    };

    UE.Editor.prototype.removePreferences = function (key) {
        var data = LocalStorage.getLocalData(ROOTKEY);
        if (data && (data = utils.str2json(data))) {
            data[key] = undefined;
            delete data[key]
        }
        data && LocalStorage.saveLocalData(ROOTKEY, utils.json2str(data));
    };

})();


// plugins/defaultfilter.js
///import core
///plugin 编辑器默认的过滤转换机制

UE.plugins['defaultfilter'] = function () {
    var me = this;
    me.setOpt({
        'allowDivTransToP':true,
        'disabledTableInTable':true
    });
    //默认的过滤处理
    //进入编辑器的内容处理
    me.addInputRule(function (root) {
        var allowDivTransToP = this.options.allowDivTransToP;
        var val;
        function tdParent(node){
            while(node && node.type == 'element'){
                if(node.tagName == 'td'){
                    return true;
                }
                node = node.parentNode;
            }
            return false;
        }
        //进行默认的处理
        root.traversal(function (node) {
            if (node.type == 'element') {
                if (!dtd.$cdata[node.tagName] && me.options.autoClearEmptyNode && dtd.$inline[node.tagName] && !dtd.$empty[node.tagName] && (!node.attrs || utils.isEmptyObject(node.attrs))) {
                    if (!node.firstChild()) node.parentNode.removeChild(node);
                    else if (node.tagName == 'span' && (!node.attrs || utils.isEmptyObject(node.attrs))) {
                        node.parentNode.removeChild(node, true)
                    }
                    return;
                }
                switch (node.tagName) {
                    case 'style':
                    case 'script':
                        node.setAttr({
                            cdata_tag: node.tagName,
                            cdata_data: (node.innerHTML() || ''),
                            '_ue_custom_node_':'true'
                        });
                        node.tagName = 'div';
                        node.innerHTML('');
                        break;
                    case 'a':
                        if (val = node.getAttr('href')) {
                            node.setAttr('_href', val)
                        }
                        break;
                    case 'img':
                        //todo base64暂时去掉，后边做远程图片上传后，干掉这个
                        if (val = node.getAttr('src')) {
                            if (/^data:/.test(val)) {
                                node.parentNode.removeChild(node);
                                break;
                            }
                        }
                        node.setAttr('_src', node.getAttr('src'));
                        break;
                    case 'span':
                        if (browser.webkit && (val = node.getStyle('white-space'))) {
                            if (/nowrap|normal/.test(val)) {
                                node.setStyle('white-space', '');
                                if (me.options.autoClearEmptyNode && utils.isEmptyObject(node.attrs)) {
                                    node.parentNode.removeChild(node, true)
                                }
                            }
                        }
                        val = node.getAttr('id');
                        if(val && /^_baidu_bookmark_/i.test(val)){
                            node.parentNode.removeChild(node)
                        }
                        break;
                    case 'p':
                        if (val = node.getAttr('align')) {
                            node.setAttr('align');
                            node.setStyle('text-align', val)
                        }
                        //trace:3431
//                        var cssStyle = node.getAttr('style');
//                        if (cssStyle) {
//                            cssStyle = cssStyle.replace(/(margin|padding)[^;]+/g, '');
//                            node.setAttr('style', cssStyle)
//
//                        }
                        //p标签不允许嵌套
                        utils.each(node.children,function(n){
                            if(n.type == 'element' && n.tagName == 'p'){
                                var next = n.nextSibling();
                                node.parentNode.insertAfter(n,node);
                                var last = n;
                                while(next){
                                    var tmp = next.nextSibling();
                                    node.parentNode.insertAfter(next,last);
                                    last = next;
                                    next = tmp;
                                }
                                return false;
                            }
                        });
                        if (!node.firstChild()) {
                            node.innerHTML(browser.ie ? '&nbsp;' : '<br/>')
                        }
                        break;
                    case 'div':
                        if(node.getAttr('cdata_tag')){
                            break;
                        }
                        //针对代码这里不处理插入代码的div
                        val = node.getAttr('class');
                        if(val && /^line number\d+/.test(val)){
                            break;
                        }
                        if(!allowDivTransToP){
                            break;
                        }
                        var tmpNode, p = UE.uNode.createElement('p');
                        while (tmpNode = node.firstChild()) {
                            if (tmpNode.type == 'text' || !UE.dom.dtd.$block[tmpNode.tagName]) {
                                p.appendChild(tmpNode);
                            } else {
                                if (p.firstChild()) {
                                    node.parentNode.insertBefore(p, node);
                                    p = UE.uNode.createElement('p');
                                } else {
                                    node.parentNode.insertBefore(tmpNode, node);
                                }
                            }
                        }
                        if (p.firstChild()) {
                            node.parentNode.insertBefore(p, node);
                        }
                        node.parentNode.removeChild(node);
                        break;
                    case 'dl':
                        node.tagName = 'ul';
                        break;
                    case 'dt':
                    case 'dd':
                        node.tagName = 'li';
                        break;
                    case 'li':
                        var className = node.getAttr('class');
                        if (!className || !/list\-/.test(className)) {
                            node.setAttr()
                        }
                        var tmpNodes = node.getNodesByTagName('ol ul');
                        UE.utils.each(tmpNodes, function (n) {
                            node.parentNode.insertAfter(n, node);
                        });
                        break;
                    case 'td':
                    case 'th':
                    case 'caption':
                        if(!node.children || !node.children.length){
                            node.appendChild(browser.ie11below ? UE.uNode.createText(' ') : UE.uNode.createElement('br'))
                        }
                        break;
                    case 'table':
                        if(me.options.disabledTableInTable && tdParent(node)){
                            node.parentNode.insertBefore(UE.uNode.createText(node.innerText()),node);
                            node.parentNode.removeChild(node)
                        }
                }

            }
//            if(node.type == 'comment'){
//                node.parentNode.removeChild(node);
//            }
        })

    });

    //从编辑器出去的内容处理
    me.addOutputRule(function (root) {

        var val;
        root.traversal(function (node) {
            if (node.type == 'element') {

                if (me.options.autoClearEmptyNode && dtd.$inline[node.tagName] && !dtd.$empty[node.tagName] && (!node.attrs || utils.isEmptyObject(node.attrs))) {

                    if (!node.firstChild()) node.parentNode.removeChild(node);
                    else if (node.tagName == 'span' && (!node.attrs || utils.isEmptyObject(node.attrs))) {
                        node.parentNode.removeChild(node, true)
                    }
                    return;
                }
                switch (node.tagName) {
                    case 'div':
                        if (val = node.getAttr('cdata_tag')) {
                            node.tagName = val;
                            node.appendChild(UE.uNode.createText(node.getAttr('cdata_data')));
                            node.setAttr({cdata_tag: '', cdata_data: '','_ue_custom_node_':''});
                        }
                        break;
                    case 'a':
                        if (val = node.getAttr('_href')) {
                            node.setAttr({
                                'href': utils.html(val),
                                '_href': ''
                            })
                        }
                        break;
                        break;
                    case 'span':
                        val = node.getAttr('id');
                        if(val && /^_baidu_bookmark_/i.test(val)){
                            node.parentNode.removeChild(node)
                        }
                        break;
                    case 'img':
                        if (val = node.getAttr('_src')) {
                            node.setAttr({
                                'src': node.getAttr('_src'),
                                '_src': ''
                            })
                        }


                }
            }

        })


    });
};


// plugins/inserthtml.js
/**
 * 插入html字符串插件
 * @file
 * @since 1.2.6.1
 */

/**
 * 插入html代码
 * @command inserthtml
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @param { String } html 插入的html字符串
 * @remaind 插入的标签内容是在当前的选区位置上插入，如果当前是闭合状态，那直接插入内容， 如果当前是选中状态，将先清除当前选中内容后，再做插入
 * @warning 注意:该命令会对当前选区的位置，对插入的内容进行过滤转换处理。 过滤的规则遵循html语意化的原则。
 * @example
 * ```javascript
 * //xxx[BB]xxx 当前选区为非闭合选区，选中BB这两个文本
 * //执行命令，插入<b>CC</b>
 * //插入后的效果 xxx<b>CC</b>xxx
 * //<p>xx|xxx</p> 当前选区为闭合状态
 * //插入<p>CC</p>
 * //结果 <p>xx</p><p>CC</p><p>xxx</p>
 * //<p>xxxx</p>|</p>xxx</p> 当前选区在两个p标签之间
 * //插入 xxxx
 * //结果 <p>xxxx</p><p>xxxx</p></p>xxx</p>
 * ```
 */

UE.commands['inserthtml'] = {
    execCommand: function (command,html,notNeedFilter){
        var me = this,
            range,
            div;
        if(!html){
            return;
        }
        if(me.fireEvent('beforeinserthtml',html) === true){
            return;
        }
        range = me.selection.getRange();
        div = range.document.createElement( 'div' );
        div.style.display = 'inline';

        if (!notNeedFilter) {
            var root = UE.htmlparser(html);
            //如果给了过滤规则就先进行过滤
            if(me.options.filterRules){
                UE.filterNode(root,me.options.filterRules);
            }
            //执行默认的处理
            me.filterInputRule(root);
            html = root.toHtml()
        }
        div.innerHTML = utils.trim( html );

        if ( !range.collapsed ) {
            var tmpNode = range.startContainer;
            if(domUtils.isFillChar(tmpNode)){
                range.setStartBefore(tmpNode)
            }
            tmpNode = range.endContainer;
            if(domUtils.isFillChar(tmpNode)){
                range.setEndAfter(tmpNode)
            }
            range.txtToElmBoundary();
            //结束边界可能放到了br的前边，要把br包含进来
            // x[xxx]<br/>
            if(range.endContainer && range.endContainer.nodeType == 1){
                tmpNode = range.endContainer.childNodes[range.endOffset];
                if(tmpNode && domUtils.isBr(tmpNode)){
                    range.setEndAfter(tmpNode);
                }
            }
            if(range.startOffset == 0){
                tmpNode = range.startContainer;
                if(domUtils.isBoundaryNode(tmpNode,'firstChild') ){
                    tmpNode = range.endContainer;
                    if(range.endOffset == (tmpNode.nodeType == 3 ? tmpNode.nodeValue.length : tmpNode.childNodes.length) && domUtils.isBoundaryNode(tmpNode,'lastChild')){
                        me.body.innerHTML = '<p>'+(browser.ie ? '' : '<br/>')+'</p>';
                        range.setStart(me.body.firstChild,0).collapse(true)

                    }
                }
            }
            !range.collapsed && range.deleteContents();
            if(range.startContainer.nodeType == 1){
                var child = range.startContainer.childNodes[range.startOffset],pre;
                if(child && domUtils.isBlockElm(child) && (pre = child.previousSibling) && domUtils.isBlockElm(pre)){
                    range.setEnd(pre,pre.childNodes.length).collapse();
                    while(child.firstChild){
                        pre.appendChild(child.firstChild);
                    }
                    domUtils.remove(child);
                }
            }

        }


        var child,parent,pre,tmp,hadBreak = 0, nextNode;
        //如果当前位置选中了fillchar要干掉，要不会产生空行
        if(range.inFillChar()){
            child = range.startContainer;
            if(domUtils.isFillChar(child)){
                range.setStartBefore(child).collapse(true);
                domUtils.remove(child);
            }else if(domUtils.isFillChar(child,true)){
                child.nodeValue = child.nodeValue.replace(fillCharReg,'');
                range.startOffset--;
                range.collapsed && range.collapse(true)
            }
        }
        //列表单独处理
        var li = domUtils.findParentByTagName(range.startContainer,'li',true);
        if(li){
            var next,last;
            while(child = div.firstChild){
                //针对hr单独处理一下先
                while(child && (child.nodeType == 3 || !domUtils.isBlockElm(child) || child.tagName=='HR' )){
                    next = child.nextSibling;
                    range.insertNode( child).collapse();
                    last = child;
                    child = next;

                }
                if(child){
                    if(/^(ol|ul)$/i.test(child.tagName)){
                        while(child.firstChild){
                            last = child.firstChild;
                            domUtils.insertAfter(li,child.firstChild);
                            li = li.nextSibling;
                        }
                        domUtils.remove(child)
                    }else{
                        var tmpLi;
                        next = child.nextSibling;
                        tmpLi = me.document.createElement('li');
                        domUtils.insertAfter(li,tmpLi);
                        tmpLi.appendChild(child);
                        last = child;
                        child = next;
                        li = tmpLi;
                    }
                }
            }
            li = domUtils.findParentByTagName(range.startContainer,'li',true);
            if(domUtils.isEmptyBlock(li)){
                domUtils.remove(li)
            }
            if(last){

                range.setStartAfter(last).collapse(true).select(true)
            }
        }else{
            while ( child = div.firstChild ) {
                if(hadBreak){
                    var p = me.document.createElement('p');
                    while(child && (child.nodeType == 3 || !dtd.$block[child.tagName])){
                        nextNode = child.nextSibling;
                        p.appendChild(child);
                        child = nextNode;
                    }
                    if(p.firstChild){

                        child = p
                    }
                }
                range.insertNode( child );
                nextNode = child.nextSibling;
                if ( !hadBreak && child.nodeType == domUtils.NODE_ELEMENT && domUtils.isBlockElm( child ) ){

                    parent = domUtils.findParent( child,function ( node ){ return domUtils.isBlockElm( node ); } );
                    if ( parent && parent.tagName.toLowerCase() != 'body' && !(dtd[parent.tagName][child.nodeName] && child.parentNode === parent)){
                        if(!dtd[parent.tagName][child.nodeName]){
                            pre = parent;
                        }else{
                            tmp = child.parentNode;
                            while (tmp !== parent){
                                pre = tmp;
                                tmp = tmp.parentNode;

                            }
                        }


                        domUtils.breakParent( child, pre || tmp );
                        //去掉break后前一个多余的节点  <p>|<[p> ==> <p></p><div></div><p>|</p>
                        var pre = child.previousSibling;
                        domUtils.trimWhiteTextNode(pre);
                        if(!pre.childNodes.length){
                            domUtils.remove(pre);
                        }
                        //trace:2012,在非ie的情况，切开后剩下的节点有可能不能点入光标添加br占位

                        if(!browser.ie &&
                            (next = child.nextSibling) &&
                            domUtils.isBlockElm(next) &&
                            next.lastChild &&
                            !domUtils.isBr(next.lastChild)){
                            next.appendChild(me.document.createElement('br'));
                        }
                        hadBreak = 1;
                    }
                }
                var next = child.nextSibling;
                if(!div.firstChild && next && domUtils.isBlockElm(next)){

                    range.setStart(next,0).collapse(true);
                    break;
                }
                range.setEndAfter( child ).collapse();

            }

            child = range.startContainer;

            if(nextNode && domUtils.isBr(nextNode)){
                domUtils.remove(nextNode)
            }
            //用chrome可能有空白展位符
            if(domUtils.isBlockElm(child) && domUtils.isEmptyNode(child)){
                if(nextNode = child.nextSibling){
                    domUtils.remove(child);
                    if(nextNode.nodeType == 1 && dtd.$block[nextNode.tagName]){

                        range.setStart(nextNode,0).collapse(true).shrinkBoundary()
                    }
                }else{

                    try{
                        child.innerHTML = browser.ie ? domUtils.fillChar : '<br/>';
                    }catch(e){
                        range.setStartBefore(child);
                        domUtils.remove(child)
                    }

                }

            }
            //加上true因为在删除表情等时会删两次，第一次是删的fillData
            try{
                range.select(true);
            }catch(e){}

        }



        setTimeout(function(){
            range = me.selection.getRange();
            range.scrollToView(me.autoHeightEnabled,me.autoHeightEnabled ? domUtils.getXY(me.iframe).y:0);
            me.fireEvent('afterinserthtml', html);
        },200);
    }
};


// plugins/autotypeset.js
/**
 * 自动排版
 * @file
 * @since 1.2.6.1
 */

/**
 * 对当前编辑器的内容执行自动排版， 排版的行为根据config配置文件里的“autotypeset”选项进行控制。
 * @command autotypeset
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'autotypeset' );
 * ```
 */

UE.plugins['autotypeset'] = function(){

    this.setOpt({'autotypeset': {
        mergeEmptyline: true,           //合并空行
        removeClass: true,              //去掉冗余的class
        removeEmptyline: false,         //去掉空行
        textAlign:"left",               //段落的排版方式，可以是 left,right,center,justify 去掉这个属性表示不执行排版
        imageBlockLine: 'center',       //图片的浮动方式，独占一行剧中,左右浮动，默认: center,left,right,none 去掉这个属性表示不执行排版
        pasteFilter: false,             //根据规则过滤没事粘贴进来的内容
        clearFontSize: false,           //去掉所有的内嵌字号，使用编辑器默认的字号
        clearFontFamily: false,         //去掉所有的内嵌字体，使用编辑器默认的字体
        removeEmptyNode: false,         // 去掉空节点
        //可以去掉的标签
        removeTagNames: utils.extend({div:1},dtd.$removeEmpty),
        indent: false,                  // 行首缩进
        indentValue : '2em',            //行首缩进的大小
        bdc2sb: false,
        tobdc: false
    }});

    var me = this,
        opt = me.options.autotypeset,
        remainClass = {
            'selectTdClass':1,
            'pagebreak':1,
            'anchorclass':1
        },
        remainTag = {
            'li':1
        },
        tags = {
            div:1,
            p:1,
            //trace:2183 这些也认为是行
            blockquote:1,center:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,
            span:1
        },
        highlightCont;
    //升级了版本，但配置项目里没有autotypeset
    if(!opt){
        return;
    }

    readLocalOpts();

    function isLine(node,notEmpty){
        if(!node || node.nodeType == 3)
            return 0;
        if(domUtils.isBr(node))
            return 1;
        if(node && node.parentNode && tags[node.tagName.toLowerCase()]){
            if(highlightCont && highlightCont.contains(node)
                ||
                node.getAttribute('pagebreak')
            ){
                return 0;
            }

            return notEmpty ? !domUtils.isEmptyBlock(node) : domUtils.isEmptyBlock(node,new RegExp('[\\s'+domUtils.fillChar
                +']','g'));
        }
    }

    function removeNotAttributeSpan(node){
        if(!node.style.cssText){
            domUtils.removeAttributes(node,['style']);
            if(node.tagName.toLowerCase() == 'span' && domUtils.hasNoAttributes(node)){
                domUtils.remove(node,true);
            }
        }
    }
    function autotype(type,html){

        var me = this,cont;
        if(html){
            if(!opt.pasteFilter){
                return;
            }
            cont = me.document.createElement('div');
            cont.innerHTML = html.html;
        }else{
            cont = me.document.body;
        }
        var nodes = domUtils.getElementsByTagName(cont,'*');

        // 行首缩进，段落方向，段间距，段内间距
        for(var i=0,ci;ci=nodes[i++];){

            if(me.fireEvent('excludeNodeinautotype',ci) === true){
                continue;
            }
             //font-size
            if(opt.clearFontSize && ci.style.fontSize){
                domUtils.removeStyle(ci,'font-size');

                removeNotAttributeSpan(ci);

            }
            //font-family
            if(opt.clearFontFamily && ci.style.fontFamily){
                domUtils.removeStyle(ci,'font-family');
                removeNotAttributeSpan(ci);
            }

            if(isLine(ci)){
                //合并空行
                if(opt.mergeEmptyline ){
                    var next = ci.nextSibling,tmpNode,isBr = domUtils.isBr(ci);
                    while(isLine(next)){
                        tmpNode = next;
                        next = tmpNode.nextSibling;
                        if(isBr && (!next || next && !domUtils.isBr(next))){
                            break;
                        }
                        domUtils.remove(tmpNode);
                    }

                }
                 //去掉空行，保留占位的空行
                if(opt.removeEmptyline && domUtils.inDoc(ci,cont) && !remainTag[ci.parentNode.tagName.toLowerCase()] ){
                    if(domUtils.isBr(ci)){
                        next = ci.nextSibling;
                        if(next && !domUtils.isBr(next)){
                            continue;
                        }
                    }
                    domUtils.remove(ci);
                    continue;

                }

            }
            if(isLine(ci,true) && ci.tagName != 'SPAN'){
                if(opt.indent){
                    ci.style.textIndent = opt.indentValue;
                }
                if(opt.textAlign){
                    ci.style.textAlign = opt.textAlign;
                }
                // if(opt.lineHeight)
                //     ci.style.lineHeight = opt.lineHeight + 'cm';

            }

            //去掉class,保留的class不去掉
            if(opt.removeClass && ci.className && !remainClass[ci.className.toLowerCase()]){

                if(highlightCont && highlightCont.contains(ci)){
                     continue;
                }
                domUtils.removeAttributes(ci,['class']);
            }

            //表情不处理
            if(opt.imageBlockLine && ci.tagName.toLowerCase() == 'img' && !ci.getAttribute('emotion')){
                if(html){
                    var img = ci;
                    switch (opt.imageBlockLine){
                        case 'left':
                        case 'right':
                        case 'none':
                            var pN = img.parentNode,tmpNode,pre,next;
                            while(dtd.$inline[pN.tagName] || pN.tagName == 'A'){
                                pN = pN.parentNode;
                            }
                            tmpNode = pN;
                            if(tmpNode.tagName == 'P' && domUtils.getStyle(tmpNode,'text-align') == 'center'){
                                if(!domUtils.isBody(tmpNode) && domUtils.getChildCount(tmpNode,function(node){return !domUtils.isBr(node) && !domUtils.isWhitespace(node)}) == 1){
                                    pre = tmpNode.previousSibling;
                                    next = tmpNode.nextSibling;
                                    if(pre && next && pre.nodeType == 1 &&  next.nodeType == 1 && pre.tagName == next.tagName && domUtils.isBlockElm(pre)){
                                        pre.appendChild(tmpNode.firstChild);
                                        while(next.firstChild){
                                            pre.appendChild(next.firstChild);
                                        }
                                        domUtils.remove(tmpNode);
                                        domUtils.remove(next);
                                    }else{
                                        domUtils.setStyle(tmpNode,'text-align','');
                                    }


                                }


                            }
                            domUtils.setStyle(img,'float', opt.imageBlockLine);
                            break;
                        case 'center':
                            if(me.queryCommandValue('imagefloat') != 'center'){
                                pN = img.parentNode;
                                domUtils.setStyle(img,'float','none');
                                tmpNode = img;
                                while(pN && domUtils.getChildCount(pN,function(node){return !domUtils.isBr(node) && !domUtils.isWhitespace(node)}) == 1
                                    && (dtd.$inline[pN.tagName] || pN.tagName == 'A')){
                                    tmpNode = pN;
                                    pN = pN.parentNode;
                                }
                                var pNode = me.document.createElement('p');
                                domUtils.setAttributes(pNode,{

                                    style:'text-align:center'
                                });
                                tmpNode.parentNode.insertBefore(pNode,tmpNode);
                                pNode.appendChild(tmpNode);
                                domUtils.setStyle(tmpNode,'float','');

                            }


                    }
                } else {
                    var range = me.selection.getRange();
                    range.selectNode(ci).select();
                    me.execCommand('imagefloat', opt.imageBlockLine);
                }

            }

            //去掉冗余的标签
            if(opt.removeEmptyNode){
                if(opt.removeTagNames[ci.tagName.toLowerCase()] && domUtils.hasNoAttributes(ci) && domUtils.isEmptyBlock(ci)){
                    domUtils.remove(ci);
                }
            }
        }
        if(opt.tobdc){
            var root = UE.htmlparser(cont.innerHTML);
            root.traversal(function(node){
                if(node.type == 'text'){
                    node.data = ToDBC(node.data)
                }
            });
            cont.innerHTML = root.toHtml()
        }
        if(opt.bdc2sb){
            var root = UE.htmlparser(cont.innerHTML);
            root.traversal(function(node){
                if(node.type == 'text'){
                    node.data = DBC2SB(node.data)
                }
            });
            cont.innerHTML = root.toHtml()
        }
        if(html){
            html.html = cont.innerHTML;
        }
    }
    if(opt.pasteFilter){
        me.addListener('beforepaste',autotype);
    }

    function DBC2SB(str) {
        var result = '';
        for (var i = 0; i < str.length; i++) {
            var code = str.charCodeAt(i); //获取当前字符的unicode编码
            if (code >= 65281 && code <= 65373)//在这个unicode编码范围中的是所有的英文字母已经各种字符
            {
                result += String.fromCharCode(str.charCodeAt(i) - 65248); //把全角字符的unicode编码转换为对应半角字符的unicode码
            } else if (code == 12288)//空格
            {
                result += String.fromCharCode(str.charCodeAt(i) - 12288 + 32);
            } else {
                result += str.charAt(i);
            }
        }
        return result;
    }
    function ToDBC(txtstring) {
        txtstring = utils.html(txtstring);
        var tmp = "";
        var mark = "";/*用于判断,如果是html尖括里的标记,则不进行全角的转换*/
        for (var i = 0; i < txtstring.length; i++) {
            if (txtstring.charCodeAt(i) == 32) {
                tmp = tmp + String.fromCharCode(12288);
            }
            else if (txtstring.charCodeAt(i) < 127) {
                tmp = tmp + String.fromCharCode(txtstring.charCodeAt(i) + 65248);
            }
            else {
                tmp += txtstring.charAt(i);
            }
        }
        return tmp;
    }

    function readLocalOpts() {
        var cookieOpt = me.getPreferences('autotypeset');
        utils.extend(me.options.autotypeset, cookieOpt);
    }

    me.commands['autotypeset'] = {
        execCommand:function () {
            me.removeListener('beforepaste',autotype);
            if(opt.pasteFilter){
                me.addListener('beforepaste',autotype);
            }
            autotype.call(me)
        }

    };

};



// plugins/autosubmit.js
/**
 * 快捷键提交
 * @file
 * @since 1.2.6.1
 */

/**
 * 提交表单
 * @command autosubmit
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'autosubmit' );
 * ```
 */

UE.plugin.register('autosubmit',function(){
    return {
        shortcutkey:{
            "autosubmit":"ctrl+13" //手动提交
        },
        commands:{
            'autosubmit':{
                execCommand:function () {
                    var me=this,
                        form = domUtils.findParentByTagName(me.iframe,"form", false);
                    if (form){
                        if(me.fireEvent("beforesubmit")===false){
                            return;
                        }
                        me.sync();
                        form.submit();
                    }
                }
            }
        }
    }
});

// plugins/background.js
/**
 * 背景插件，为UEditor提供设置背景功能
 * @file
 * @since 1.2.6.1
 */
UE.plugin.register('background', function () {
    var me = this,
        cssRuleId = 'editor_background',
        isSetColored,
        reg = new RegExp('body[\\s]*\\{(.+)\\}', 'i');

    function stringToObj(str) {
        var obj = {}, styles = str.split(';');
        utils.each(styles, function (v) {
            var index = v.indexOf(':'),
                key = utils.trim(v.substr(0, index)).toLowerCase();
            key && (obj[key] = utils.trim(v.substr(index + 1) || ''));
        });
        return obj;
    }

    function setBackground(obj) {
        if (obj) {
            var styles = [];
            for (var name in obj) {
                if (obj.hasOwnProperty(name)) {
                    styles.push(name + ":" + obj[name] + '; ');
                }
            }
            utils.cssRule(cssRuleId, styles.length ? ('body{' + styles.join("") + '}') : '', me.document);
        } else {
            utils.cssRule(cssRuleId, '', me.document)
        }
    }
    //重写editor.hasContent方法

    var orgFn = me.hasContents;
    me.hasContents = function(){
        if(me.queryCommandValue('background')){
            return true
        }
        return orgFn.apply(me,arguments);
    };
    return {
        bindEvents: {
            'getAllHtml': function (type, headHtml) {
                var body = this.body,
                    su = domUtils.getComputedStyle(body, "background-image"),
                    url = "";
                if (su.indexOf(me.options.imagePath) > 0) {
                    url = su.substring(su.indexOf(me.options.imagePath), su.length - 1).replace(/"|\(|\)/ig, "");
                } else {
                    url = su != "none" ? su.replace(/url\("?|"?\)/ig, "") : "";
                }
                var html = '<style type="text/css">body{';
                var bgObj = {
                    "background-color": domUtils.getComputedStyle(body, "background-color") || "#ffffff",
                    'background-image': url ? 'url(' + url + ')' : '',
                    'background-repeat': domUtils.getComputedStyle(body, "background-repeat") || "",
                    'background-position': browser.ie ? (domUtils.getComputedStyle(body, "background-position-x") + " " + domUtils.getComputedStyle(body, "background-position-y")) : domUtils.getComputedStyle(body, "background-position"),
                    'height': domUtils.getComputedStyle(body, "height")
                };
                for (var name in bgObj) {
                    if (bgObj.hasOwnProperty(name)) {
                        html += name + ":" + bgObj[name] + "; ";
                    }
                }
                html += '}</style> ';
                headHtml.push(html);
            },
            'aftersetcontent': function () {
                if(isSetColored == false) setBackground();
            }
        },
        inputRule: function (root) {
            isSetColored = false;
            utils.each(root.getNodesByTagName('p'), function (p) {
                var styles = p.getAttr('data-background');
                if (styles) {
                    isSetColored = true;
                    setBackground(stringToObj(styles));
                    p.parentNode.removeChild(p);
                }
            })
        },
        outputRule: function (root) {
            var me = this,
                styles = (utils.cssRule(cssRuleId, me.document) || '').replace(/[\n\r]+/g, '').match(reg);
            if (styles) {
                root.appendChild(UE.uNode.createElement('<p style="display:none;" data-background="' + utils.trim(styles[1].replace(/"/g, '').replace(/[\s]+/g, ' ')) + '"><br/></p>'));
            }
        },
        commands: {
            'background': {
                execCommand: function (cmd, obj) {
                    setBackground(obj);
                },
                queryCommandValue: function () {
                    var me = this,
                        styles = (utils.cssRule(cssRuleId, me.document) || '').replace(/[\n\r]+/g, '').match(reg);
                    return styles ? stringToObj(styles[1]) : null;
                },
                notNeedUndo: true
            }
        }
    }
});

// plugins/image.js
/**
 * 图片插入、排版插件
 * @file
 * @since 1.2.6.1
 */

/**
 * 图片对齐方式
 * @command imagefloat
 * @method execCommand
 * @remind 值center为独占一行居中
 * @param { String } cmd 命令字符串
 * @param { String } align 对齐方式，可传left、right、none、center
 * @remaind center表示图片独占一行
 * @example
 * ```javascript
 * editor.execCommand( 'imagefloat', 'center' );
 * ```
 */

/**
 * 如果选区所在位置是图片区域
 * @command imagefloat
 * @method queryCommandValue
 * @param { String } cmd 命令字符串
 * @return { String } 返回图片对齐方式
 * @example
 * ```javascript
 * editor.queryCommandValue( 'imagefloat' );
 * ```
 */

UE.commands['imagefloat'] = {
    execCommand:function (cmd, align) {
        var me = this,
            range = me.selection.getRange();
        if (!range.collapsed) {
            var img = range.getClosedNode();
            if (img && img.tagName == 'IMG') {
                switch (align) {
                    case 'left':
                    case 'right':
                    case 'none':
                        var pN = img.parentNode, tmpNode, pre, next;
                        while (dtd.$inline[pN.tagName] || pN.tagName == 'A') {
                            pN = pN.parentNode;
                        }
                        tmpNode = pN;
                        if (tmpNode.tagName == 'P' && domUtils.getStyle(tmpNode, 'text-align') == 'center') {
                            if (!domUtils.isBody(tmpNode) && domUtils.getChildCount(tmpNode, function (node) {
                                return !domUtils.isBr(node) && !domUtils.isWhitespace(node);
                            }) == 1) {
                                pre = tmpNode.previousSibling;
                                next = tmpNode.nextSibling;
                                if (pre && next && pre.nodeType == 1 && next.nodeType == 1 && pre.tagName == next.tagName && domUtils.isBlockElm(pre)) {
                                    pre.appendChild(tmpNode.firstChild);
                                    while (next.firstChild) {
                                        pre.appendChild(next.firstChild);
                                    }
                                    domUtils.remove(tmpNode);
                                    domUtils.remove(next);
                                } else {
                                    domUtils.setStyle(tmpNode, 'text-align', '');
                                }


                            }

                            range.selectNode(img).select();
                        }
                        domUtils.setStyle(img, 'float', align == 'none' ? '' : align);
                        if(align == 'none'){
                            domUtils.removeAttributes(img,'align');
                        }

                        break;
                    case 'center':
                        if (me.queryCommandValue('imagefloat') != 'center') {
                            pN = img.parentNode;
                            domUtils.setStyle(img, 'float', '');
                            domUtils.removeAttributes(img,'align');
                            tmpNode = img;
                            while (pN && domUtils.getChildCount(pN, function (node) {
                                return !domUtils.isBr(node) && !domUtils.isWhitespace(node);
                            }) == 1
                                && (dtd.$inline[pN.tagName] || pN.tagName == 'A')) {
                                tmpNode = pN;
                                pN = pN.parentNode;
                            }
                            range.setStartBefore(tmpNode).setCursor(false);
                            pN = me.document.createElement('div');
                            pN.appendChild(tmpNode);
                            domUtils.setStyle(tmpNode, 'float', '');

                            me.execCommand('insertHtml', '<p id="_img_parent_tmp" style="text-align:center">' + pN.innerHTML + '</p>');

                            tmpNode = me.document.getElementById('_img_parent_tmp');
                            tmpNode.removeAttribute('id');
                            tmpNode = tmpNode.firstChild;
                            range.selectNode(tmpNode).select();
                            //去掉后边多余的元素
                            next = tmpNode.parentNode.nextSibling;
                            if (next && domUtils.isEmptyNode(next)) {
                                domUtils.remove(next);
                            }

                        }

                        break;
                }

            }
        }
    },
    queryCommandValue:function () {
        var range = this.selection.getRange(),
            startNode, floatStyle;
        if (range.collapsed) {
            return 'none';
        }
        startNode = range.getClosedNode();
        if (startNode && startNode.nodeType == 1 && startNode.tagName == 'IMG') {
            floatStyle = domUtils.getComputedStyle(startNode, 'float') || startNode.getAttribute('align');

            if (floatStyle == 'none') {
                floatStyle = domUtils.getComputedStyle(startNode.parentNode, 'text-align') == 'center' ? 'center' : floatStyle;
            }
            return {
                left:1,
                right:1,
                center:1
            }[floatStyle] ? floatStyle : 'none';
        }
        return 'none';


    },
    queryCommandState:function () {
        var range = this.selection.getRange(),
            startNode;

        if (range.collapsed)  return -1;

        startNode = range.getClosedNode();
        if (startNode && startNode.nodeType == 1 && startNode.tagName == 'IMG') {
            return 0;
        }
        return -1;
    }
};


/**
 * 插入图片
 * @command insertimage
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @param { Object } opt 属性键值对，这些属性都将被复制到当前插入图片
 * @remind 该命令第二个参数可接受一个图片配置项对象的数组，可以插入多张图片，
 * 此时数组的每一个元素都是一个Object类型的图片属性集合。
 * @example
 * ```javascript
 * editor.execCommand( 'insertimage', {
 *     src:'a/b/c.jpg',
 *     width:'100',
 *     height:'100'
 * } );
 * ```
 * @example
 * ```javascript
 * editor.execCommand( 'insertimage', [{
 *     src:'a/b/c.jpg',
 *     width:'100',
 *     height:'100'
 * },{
 *     src:'a/b/d.jpg',
 *     width:'100',
 *     height:'100'
 * }] );
 * ```
 */

UE.commands['insertimage'] = {
    execCommand:function (cmd, opt) {

        opt = utils.isArray(opt) ? opt : [opt];
        if (!opt.length) {
            return;
        }
        var me = this,
            range = me.selection.getRange(),
            img = range.getClosedNode();

        if(me.fireEvent('beforeinsertimage', opt) === true){
            return;
        }

        function unhtmlData(imgCi) {

            utils.each('width,height,border,hspace,vspace'.split(','), function (item) {

                if (imgCi[item]) {
                    imgCi[item] = parseInt(imgCi[item], 10) || 0;
                }
            });

            utils.each('src,_src'.split(','), function (item) {

                if (imgCi[item]) {
                    imgCi[item] = utils.unhtmlForUrl(imgCi[item]);
                }
            });
            utils.each('title,alt'.split(','), function (item) {

                if (imgCi[item]) {
                    imgCi[item] = utils.unhtml(imgCi[item]);
                }
            });
        }

        if (img && /img/i.test(img.tagName) && (img.className != "edui-faked-video" || img.className.indexOf("edui-upload-video")!=-1) && !img.getAttribute("word_img")) {
            var first = opt.shift();
            var floatStyle = first['floatStyle'];
            delete first['floatStyle'];
////                img.style.border = (first.border||0) +"px solid #000";
////                img.style.margin = (first.margin||0) +"px";
//                img.style.cssText += ';margin:' + (first.margin||0) +"px;" + 'border:' + (first.border||0) +"px solid #000";
            domUtils.setAttributes(img, first);
            me.execCommand('imagefloat', floatStyle);
            if (opt.length > 0) {
                range.setStartAfter(img).setCursor(false, true);
                me.execCommand('insertimage', opt);
            }

        } else {
            var html = [], str = '', ci;
            ci = opt[0];
            if (opt.length == 1) {
                unhtmlData(ci);

                str = '<img src="' + ci.src + '" ' + (ci._src ? ' _src="' + ci._src + '" ' : '') +
                    (ci.width ? 'width="' + ci.width + '" ' : '') +
                    (ci.height ? ' height="' + ci.height + '" ' : '') +
                    (ci['floatStyle'] == 'left' || ci['floatStyle'] == 'right' ? ' style="float:' + ci['floatStyle'] + ';"' : '') +
                    (ci.title && ci.title != "" ? ' title="' + ci.title + '"' : '') +
                    (ci.border && ci.border != "0" ? ' border="' + ci.border + '"' : '') +
                    (ci.alt && ci.alt != "" ? ' alt="' + ci.alt + '"' : '') +
                    (ci.hspace && ci.hspace != "0" ? ' hspace = "' + ci.hspace + '"' : '') +
                    (ci.vspace && ci.vspace != "0" ? ' vspace = "' + ci.vspace + '"' : '') + '/>';
                if (ci['floatStyle'] == 'center') {
                    str = '<p style="text-align: center">' + str + '</p>';
                }
                html.push(str);

            } else {
                for (var i = 0; ci = opt[i++];) {
                    unhtmlData(ci);
                    str = '<p ' + (ci['floatStyle'] == 'center' ? 'style="text-align: center" ' : '') + '><img src="' + ci.src + '" ' +
                        (ci.width ? 'width="' + ci.width + '" ' : '') + (ci._src ? ' _src="' + ci._src + '" ' : '') +
                        (ci.height ? ' height="' + ci.height + '" ' : '') +
                        ' style="' + (ci['floatStyle'] && ci['floatStyle'] != 'center' ? 'float:' + ci['floatStyle'] + ';' : '') +
                        (ci.border || '') + '" ' +
                        (ci.title ? ' title="' + ci.title + '"' : '') + ' /></p>';
                    html.push(str);
                }
            }

            me.execCommand('insertHtml', html.join(''));
        }

        me.fireEvent('afterinsertimage', opt)
    }
};


// plugins/justify.js
/**
 * 段落格式
 * @file
 * @since 1.2.6.1
 */

/**
 * 段落对齐方式
 * @command justify
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @param { String } align 对齐方式：left => 居左，right => 居右，center => 居中，justify => 两端对齐
 * @example
 * ```javascript
 * editor.execCommand( 'justify', 'center' );
 * ```
 */
/**
 * 如果选区所在位置是段落区域，返回当前段落对齐方式
 * @command justify
 * @method queryCommandValue
 * @param { String } cmd 命令字符串
 * @return { String } 返回段落对齐方式
 * @example
 * ```javascript
 * editor.queryCommandValue( 'justify' );
 * ```
 */

UE.plugins['justify']=function(){
    var me=this,
        block = domUtils.isBlockElm,
        defaultValue = {
            left:1,
            right:1,
            center:1,
            justify:1
        },
        doJustify = function (range, style) {
            var bookmark = range.createBookmark(),
                filterFn = function (node) {
                    return node.nodeType == 1 ? node.tagName.toLowerCase() != 'br' && !domUtils.isBookmarkNode(node) : !domUtils.isWhitespace(node);
                };

            range.enlarge(true);
            var bookmark2 = range.createBookmark(),
                current = domUtils.getNextDomNode(bookmark2.start, false, filterFn),
                tmpRange = range.cloneRange(),
                tmpNode;
            while (current && !(domUtils.getPosition(current, bookmark2.end) & domUtils.POSITION_FOLLOWING)) {
                if (current.nodeType == 3 || !block(current)) {
                    tmpRange.setStartBefore(current);
                    while (current && current !== bookmark2.end && !block(current)) {
                        tmpNode = current;
                        current = domUtils.getNextDomNode(current, false, null, function (node) {
                            return !block(node);
                        });
                    }
                    tmpRange.setEndAfter(tmpNode);
                    var common = tmpRange.getCommonAncestor();
                    if (!domUtils.isBody(common) && block(common)) {
                        domUtils.setStyles(common, utils.isString(style) ? {'text-align':style} : style);
                        current = common;
                    } else {
                        var p = range.document.createElement('p');
                        domUtils.setStyles(p, utils.isString(style) ? {'text-align':style} : style);
                        var frag = tmpRange.extractContents();
                        p.appendChild(frag);
                        tmpRange.insertNode(p);
                        current = p;
                    }
                    current = domUtils.getNextDomNode(current, false, filterFn);
                } else {
                    current = domUtils.getNextDomNode(current, true, filterFn);
                }
            }
            return range.moveToBookmark(bookmark2).moveToBookmark(bookmark);
        };

    UE.commands['justify'] = {
        execCommand:function (cmdName, align) {
            var range = this.selection.getRange(),
                txt;

            //闭合时单独处理
            if (range.collapsed) {
                txt = this.document.createTextNode('p');
                range.insertNode(txt);
            }
            doJustify(range, align);
            if (txt) {
                range.setStartBefore(txt).collapse(true);
                domUtils.remove(txt);
            }

            range.select();


            return true;
        },
        queryCommandValue:function () {
            var startNode = this.selection.getStart(),
                value = domUtils.getComputedStyle(startNode, 'text-align');
            return defaultValue[value] ? value : 'left';
        },
        queryCommandState:function () {
            var start = this.selection.getStart(),
                cell = start && domUtils.findParentByTagName(start, ["td", "th","caption"], true);

            return cell? -1:0;
        }

    };
};


// plugins/font.js
/**
 * 字体颜色,背景色,字号,字体,下划线,删除线
 * @file
 * @since 1.2.6.1
 */

/**
 * 字体颜色
 * @command forecolor
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @param { String } value 色值(必须十六进制)
 * @example
 * ```javascript
 * editor.execCommand( 'forecolor', '#000' );
 * ```
 */
/**
 * 返回选区字体颜色
 * @command forecolor
 * @method queryCommandValue
 * @param { String } cmd 命令字符串
 * @return { String } 返回字体颜色
 * @example
 * ```javascript
 * editor.queryCommandValue( 'forecolor' );
 * ```
 */

/**
 * 字体背景颜色
 * @command backcolor
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @param { String } value 色值(必须十六进制)
 * @example
 * ```javascript
 * editor.execCommand( 'backcolor', '#000' );
 * ```
 */
/**
 * 返回选区字体颜色
 * @command backcolor
 * @method queryCommandValue
 * @param { String } cmd 命令字符串
 * @return { String } 返回字体背景颜色
 * @example
 * ```javascript
 * editor.queryCommandValue( 'backcolor' );
 * ```
 */

/**
 * 字体大小
 * @command fontsize
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @param { String } value 字体大小
 * @example
 * ```javascript
 * editor.execCommand( 'fontsize', '14px' );
 * ```
 */
/**
 * 返回选区字体大小
 * @command fontsize
 * @method queryCommandValue
 * @param { String } cmd 命令字符串
 * @return { String } 返回字体大小
 * @example
 * ```javascript
 * editor.queryCommandValue( 'fontsize' );
 * ```
 */

/**
 * 字体样式
 * @command fontfamily
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @param { String } value 字体样式
 * @example
 * ```javascript
 * editor.execCommand( 'fontfamily', '微软雅黑' );
 * ```
 */
/**
 * 返回选区字体样式
 * @command fontfamily
 * @method queryCommandValue
 * @param { String } cmd 命令字符串
 * @return { String } 返回字体样式
 * @example
 * ```javascript
 * editor.queryCommandValue( 'fontfamily' );
 * ```
 */

/**
 * 字体下划线,与删除线互斥
 * @command underline
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'underline' );
 * ```
 */

/**
 * 字体删除线,与下划线互斥
 * @command strikethrough
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'strikethrough' );
 * ```
 */

/**
 * 字体边框
 * @command fontborder
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'fontborder' );
 * ```
 */

UE.plugins['font'] = function () {
    var me = this,
        fonts = {
            'forecolor': 'color',
            'backcolor': 'background-color',
            'fontsize': 'font-size',
            'fontfamily': 'font-family',
            'underline': 'text-decoration',
            'strikethrough': 'text-decoration',
            'fontborder': 'border'
        },
        needCmd = {'underline': 1, 'strikethrough': 1, 'fontborder': 1},
        needSetChild = {
            'forecolor': 'color',
            'backcolor': 'background-color',
            'fontsize': 'font-size',
            'fontfamily': 'font-family'

        };
    me.setOpt({
        'fontfamily': [
            { name: 'songti', val: '宋体,SimSun'},
            { name: 'yahei', val: '微软雅黑,Microsoft YaHei'},
            { name: 'kaiti', val: '楷体,楷体_GB2312, SimKai'},
            { name: 'heiti', val: '黑体, SimHei'},
            { name: 'lishu', val: '隶书, SimLi'},
            { name: 'andaleMono', val: 'andale mono'},
            { name: 'arial', val: 'arial, helvetica,sans-serif'},
            { name: 'arialBlack', val: 'arial black,avant garde'},
            { name: 'comicSansMs', val: 'comic sans ms'},
            { name: 'impact', val: 'impact,chicago'},
            { name: 'timesNewRoman', val: 'times new roman'}
        ],
        'fontsize': [10, 11, 12, 14, 16, 18, 20, 24, 36]
    });

    function mergeWithParent(node){
        var parent;
        while(parent = node.parentNode){
            if(parent.tagName == 'SPAN' && domUtils.getChildCount(parent,function(child){
                return !domUtils.isBookmarkNode(child) && !domUtils.isBr(child)
            }) == 1) {
                parent.style.cssText += node.style.cssText;
                domUtils.remove(node,true);
                node = parent;

            }else{
                break;
            }
        }

    }
    function mergeChild(rng,cmdName,value){
        if(needSetChild[cmdName]){
            rng.adjustmentBoundary();
            if(!rng.collapsed && rng.startContainer.nodeType == 1){
                var start = rng.startContainer.childNodes[rng.startOffset];
                if(start && domUtils.isTagNode(start,'span')){
                    var bk = rng.createBookmark();
                    utils.each(domUtils.getElementsByTagName(start, 'span'), function (span) {
                        if (!span.parentNode || domUtils.isBookmarkNode(span))return;
                        if(cmdName == 'backcolor' && domUtils.getComputedStyle(span,'background-color').toLowerCase() === value){
                            return;
                        }
                        domUtils.removeStyle(span,needSetChild[cmdName]);
                        if(span.style.cssText.replace(/^\s+$/,'').length == 0){
                            domUtils.remove(span,true)
                        }
                    });
                    rng.moveToBookmark(bk)
                }
            }
        }

    }
    function mergesibling(rng,cmdName,value) {
        var collapsed = rng.collapsed,
            bk = rng.createBookmark(), common;
        if (collapsed) {
            common = bk.start.parentNode;
            while (dtd.$inline[common.tagName]) {
                common = common.parentNode;
            }
        } else {
            common = domUtils.getCommonAncestor(bk.start, bk.end);
        }
        utils.each(domUtils.getElementsByTagName(common, 'span'), function (span) {
            if (!span.parentNode || domUtils.isBookmarkNode(span))return;
            if (/\s*border\s*:\s*none;?\s*/i.test(span.style.cssText)) {
                if(/^\s*border\s*:\s*none;?\s*$/.test(span.style.cssText)){
                    domUtils.remove(span, true);
                }else{
                    domUtils.removeStyle(span,'border');
                }
                return
            }
            if (/border/i.test(span.style.cssText) && span.parentNode.tagName == 'SPAN' && /border/i.test(span.parentNode.style.cssText)) {
                span.style.cssText = span.style.cssText.replace(/border[^:]*:[^;]+;?/gi, '');
            }
            if(!(cmdName=='fontborder' && value=='none')){
                var next = span.nextSibling;
                while (next && next.nodeType == 1 && next.tagName == 'SPAN' ) {
                    if(domUtils.isBookmarkNode(next) && cmdName == 'fontborder') {
                        span.appendChild(next);
                        next = span.nextSibling;
                        continue;
                    }
                    if (next.style.cssText == span.style.cssText) {
                        domUtils.moveChild(next, span);
                        domUtils.remove(next);
                    }
                    if (span.nextSibling === next)
                        break;
                    next = span.nextSibling;
                }
            }


            mergeWithParent(span);
            if(browser.ie && browser.version > 8 ){
                //拷贝父亲们的特别的属性,这里只做背景颜色的处理
                var parent = domUtils.findParent(span,function(n){return n.tagName == 'SPAN' && /background-color/.test(n.style.cssText)});
                if(parent && !/background-color/.test(span.style.cssText)){
                    span.style.backgroundColor = parent.style.backgroundColor;
                }
            }

        });
        rng.moveToBookmark(bk);
        mergeChild(rng,cmdName,value)
    }

    me.addInputRule(function (root) {
        utils.each(root.getNodesByTagName('u s del font strike'), function (node) {
            if (node.tagName == 'font') {
                var cssStyle = [];
                for (var p in node.attrs) {
                    switch (p) {
                        case 'size':
                            cssStyle.push('font-size:' +
                                ({
                                '1':'10',
                                '2':'12',
                                '3':'16',
                                '4':'18',
                                '5':'24',
                                '6':'32',
                                '7':'48'
                            }[node.attrs[p]] || node.attrs[p]) + 'px');
                            break;
                        case 'color':
                            cssStyle.push('color:' + node.attrs[p]);
                            break;
                        case 'face':
                            cssStyle.push('font-family:' + node.attrs[p]);
                            break;
                        case 'style':
                            cssStyle.push(node.attrs[p]);
                    }
                }
                node.attrs = {
                    'style': cssStyle.join(';')
                };
            } else {
                var val = node.tagName == 'u' ? 'underline' : 'line-through';
                node.attrs = {
                    'style': (node.getAttr('style') || '') + 'text-decoration:' + val + ';'
                }
            }
            node.tagName = 'span';
        });
//        utils.each(root.getNodesByTagName('span'), function (node) {
//            var val;
//            if(val = node.getAttr('class')){
//                if(/fontstrikethrough/.test(val)){
//                    node.setStyle('text-decoration','line-through');
//                    if(node.attrs['class']){
//                        node.attrs['class'] = node.attrs['class'].replace(/fontstrikethrough/,'');
//                    }else{
//                        node.setAttr('class')
//                    }
//                }
//                if(/fontborder/.test(val)){
//                    node.setStyle('border','1px solid #000');
//                    if(node.attrs['class']){
//                        node.attrs['class'] = node.attrs['class'].replace(/fontborder/,'');
//                    }else{
//                        node.setAttr('class')
//                    }
//                }
//            }
//        });
    });
//    me.addOutputRule(function(root){
//        utils.each(root.getNodesByTagName('span'), function (node) {
//            var val;
//            if(val = node.getStyle('text-decoration')){
//                if(/line-through/.test(val)){
//                    if(node.attrs['class']){
//                        node.attrs['class'] += ' fontstrikethrough';
//                    }else{
//                        node.setAttr('class','fontstrikethrough')
//                    }
//                }
//
//                node.setStyle('text-decoration')
//            }
//            if(val = node.getStyle('border')){
//                if(/1px/.test(val) && /solid/.test(val)){
//                    if(node.attrs['class']){
//                        node.attrs['class'] += ' fontborder';
//
//                    }else{
//                        node.setAttr('class','fontborder')
//                    }
//                }
//                node.setStyle('border')
//
//            }
//        });
//    });
    for (var p in fonts) {
        (function (cmd, style) {
            UE.commands[cmd] = {
                execCommand: function (cmdName, value) {
                    value = value || (this.queryCommandState(cmdName) ? 'none' : cmdName == 'underline' ? 'underline' :
                        cmdName == 'fontborder' ? '1px solid #000' :
                            'line-through');
                    var me = this,
                        range = this.selection.getRange(),
                        text;

                    if (value == 'default') {

                        if (range.collapsed) {
                            text = me.document.createTextNode('font');
                            range.insertNode(text).select();

                        }
                        me.execCommand('removeFormat', 'span,a', style);
                        if (text) {
                            range.setStartBefore(text).collapse(true);
                            domUtils.remove(text);
                        }
                        mergesibling(range,cmdName,value);
                        range.select()
                    } else {
                        if (!range.collapsed) {
                            if (needCmd[cmd] && me.queryCommandValue(cmd)) {
                                me.execCommand('removeFormat', 'span,a', style);
                            }
                            range = me.selection.getRange();

                            range.applyInlineStyle('span', {'style': style + ':' + value});
                            mergesibling(range, cmdName,value);
                            range.select();
                        } else {

                            var span = domUtils.findParentByTagName(range.startContainer, 'span', true);
                            text = me.document.createTextNode('font');
                            if (span && !span.children.length && !span[browser.ie ? 'innerText' : 'textContent'].replace(fillCharReg, '').length) {
                                //for ie hack when enter
                                range.insertNode(text);
                                if (needCmd[cmd]) {
                                    range.selectNode(text).select();
                                    me.execCommand('removeFormat', 'span,a', style, null);

                                    span = domUtils.findParentByTagName(text, 'span', true);
                                    range.setStartBefore(text);

                                }
                                span && (span.style.cssText += ';' + style + ':' + value);
                                range.collapse(true).select();


                            } else {
                                range.insertNode(text);
                                range.selectNode(text).select();
                                span = range.document.createElement('span');

                                if (needCmd[cmd]) {
                                    //a标签内的不处理跳过
                                    if (domUtils.findParentByTagName(text, 'a', true)) {
                                        range.setStartBefore(text).setCursor();
                                        domUtils.remove(text);
                                        return;
                                    }
                                    me.execCommand('removeFormat', 'span,a', style);
                                }

                                span.style.cssText = style + ':' + value;


                                text.parentNode.insertBefore(span, text);
                                //修复，span套span 但样式不继承的问题
                                if (!browser.ie || browser.ie && browser.version == 9) {
                                    var spanParent = span.parentNode;
                                    while (!domUtils.isBlockElm(spanParent)) {
                                        if (spanParent.tagName == 'SPAN') {
                                            //opera合并style不会加入";"
                                            span.style.cssText = spanParent.style.cssText + ";" + span.style.cssText;
                                        }
                                        spanParent = spanParent.parentNode;
                                    }
                                }


                                if (opera) {
                                    setTimeout(function () {
                                        range.setStart(span, 0).collapse(true);
                                        mergesibling(range, cmdName,value);
                                        range.select();
                                    });
                                } else {
                                    range.setStart(span, 0).collapse(true);
                                    mergesibling(range,cmdName,value);
                                    range.select();
                                }

                                //trace:981
                                //domUtils.mergeToParent(span)
                            }
                            domUtils.remove(text);
                        }


                    }
                    return true;
                },
                queryCommandValue: function (cmdName) {
                    var startNode = this.selection.getStart();

                    //trace:946
                    if (cmdName == 'underline' || cmdName == 'strikethrough') {
                        var tmpNode = startNode, value;
                        while (tmpNode && !domUtils.isBlockElm(tmpNode) && !domUtils.isBody(tmpNode)) {
                            if (tmpNode.nodeType == 1) {
                                value = domUtils.getComputedStyle(tmpNode, style);
                                if (value != 'none') {
                                    return value;
                                }
                            }

                            tmpNode = tmpNode.parentNode;
                        }
                        return 'none';
                    }
                    if (cmdName == 'fontborder') {
                        var tmp = startNode, val;
                        while (tmp && dtd.$inline[tmp.tagName]) {
                            if (val = domUtils.getComputedStyle(tmp, 'border')) {

                                if (/1px/.test(val) && /solid/.test(val)) {
                                    return val;
                                }
                            }
                            tmp = tmp.parentNode;
                        }
                        return ''
                    }

                    if( cmdName == 'FontSize' ) {
                        var styleVal = domUtils.getComputedStyle(startNode, style),
                            tmp = /^([\d\.]+)(\w+)$/.exec( styleVal );

                        if( tmp ) {

                            return Math.floor( tmp[1] ) + tmp[2];

                        }

                        return styleVal;

                    }

                    return  domUtils.getComputedStyle(startNode, style);
                },
                queryCommandState: function (cmdName) {
                    if (!needCmd[cmdName])
                        return 0;
                    var val = this.queryCommandValue(cmdName);
                    if (cmdName == 'fontborder') {
                        return /1px/.test(val) && /solid/.test(val)
                    } else {
                        return  cmdName == 'underline' ? /underline/.test(val) : /line\-through/.test(val);

                    }

                }
            };
        })(p, fonts[p]);
    }
};

// plugins/link.js
/**
 * 超链接
 * @file
 * @since 1.2.6.1
 */

/**
 * 插入超链接
 * @command link
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @param { Object } options   设置自定义属性，例如：url、title、target
 * @example
 * ```javascript
 * editor.execCommand( 'link', '{
 *     url:'ueditor.baidu.com',
 *     title:'ueditor',
 *     target:'_blank'
 * }' );
 * ```
 */
/**
 * 返回当前选中的第一个超链接节点
 * @command link
 * @method queryCommandValue
 * @param { String } cmd 命令字符串
 * @return { Element } 超链接节点
 * @example
 * ```javascript
 * editor.queryCommandValue( 'link' );
 * ```
 */

/**
 * 取消超链接
 * @command unlink
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'unlink');
 * ```
 */

UE.plugins['link'] = function(){
    function optimize( range ) {
        var start = range.startContainer,end = range.endContainer;

        if ( start = domUtils.findParentByTagName( start, 'a', true ) ) {
            range.setStartBefore( start );
        }
        if ( end = domUtils.findParentByTagName( end, 'a', true ) ) {
            range.setEndAfter( end );
        }
    }


    UE.commands['unlink'] = {
        execCommand : function() {
            var range = this.selection.getRange(),
                bookmark;
            if(range.collapsed && !domUtils.findParentByTagName( range.startContainer, 'a', true )){
                return;
            }
            bookmark = range.createBookmark();
            optimize( range );
            range.removeInlineStyle( 'a' ).moveToBookmark( bookmark ).select();
        },
        queryCommandState : function(){
            return !this.highlight && this.queryCommandValue('link') ?  0 : -1;
        }

    };
    function doLink(range,opt,me){
        var rngClone = range.cloneRange(),
            link = me.queryCommandValue('link');
        optimize( range = range.adjustmentBoundary() );
        var start = range.startContainer;
        if(start.nodeType == 1 && link){
            start = start.childNodes[range.startOffset];
            if(start && start.nodeType == 1 && start.tagName == 'A' && /^(?:https?|ftp|file)\s*:\s*\/\//.test(start[browser.ie?'innerText':'textContent'])){
                start[browser.ie ? 'innerText' : 'textContent'] =  utils.html(opt.textValue||opt.href);

            }
        }
        if( !rngClone.collapsed || link){
            range.removeInlineStyle( 'a' );
            rngClone = range.cloneRange();
        }

        if ( rngClone.collapsed ) {
            var a = range.document.createElement( 'a'),
                text = '';
            if(opt.textValue){

                text =   utils.html(opt.textValue);
                delete opt.textValue;
            }else{
                text =   utils.html(opt.href);

            }
            domUtils.setAttributes( a, opt );
            start =  domUtils.findParentByTagName( rngClone.startContainer, 'a', true );
            if(start && domUtils.isInNodeEndBoundary(rngClone,start)){
                range.setStartAfter(start).collapse(true);

            }
            a[browser.ie ? 'innerText' : 'textContent'] = text;
            range.insertNode(a).selectNode( a );
        } else {
            range.applyInlineStyle( 'a', opt );

        }
    }
    UE.commands['link'] = {
        execCommand : function( cmdName, opt ) {
            var range;
            opt._href && (opt._href = utils.unhtml(opt._href,/[<">]/g));
            opt.href && (opt.href = utils.unhtml(opt.href,/[<">]/g));
            opt.textValue && (opt.textValue = utils.unhtml(opt.textValue,/[<">]/g));
            doLink(range=this.selection.getRange(),opt,this);
            //闭合都不加占位符，如果加了会在a后边多个占位符节点，导致a是图片背景组成的列表，出现空白问题
            range.collapse().select(true);

        },
        queryCommandValue : function() {
            var range = this.selection.getRange(),
                node;
            if ( range.collapsed ) {
//                    node = this.selection.getStart();
                //在ie下getstart()取值偏上了
                node = range.startContainer;
                node = node.nodeType == 1 ? node : node.parentNode;

                if ( node && (node = domUtils.findParentByTagName( node, 'a', true )) && ! domUtils.isInNodeEndBoundary(range,node)) {

                    return node;
                }
            } else {
                //trace:1111  如果是<p><a>xx</a></p> startContainer是p就会找不到a
                range.shrinkBoundary();
                var start = range.startContainer.nodeType  == 3 || !range.startContainer.childNodes[range.startOffset] ? range.startContainer : range.startContainer.childNodes[range.startOffset],
                    end =  range.endContainer.nodeType == 3 || range.endOffset == 0 ? range.endContainer : range.endContainer.childNodes[range.endOffset-1],
                    common = range.getCommonAncestor();
                node = domUtils.findParentByTagName( common, 'a', true );
                if ( !node && common.nodeType == 1){

                    var as = common.getElementsByTagName( 'a' ),
                        ps,pe;

                    for ( var i = 0,ci; ci = as[i++]; ) {
                        ps = domUtils.getPosition( ci, start ),pe = domUtils.getPosition( ci,end);
                        if ( (ps & domUtils.POSITION_FOLLOWING || ps & domUtils.POSITION_CONTAINS)
                            &&
                            (pe & domUtils.POSITION_PRECEDING || pe & domUtils.POSITION_CONTAINS)
                            ) {
                            node = ci;
                            break;
                        }
                    }
                }
                return node;
            }

        },
        queryCommandState : function() {
            //判断如果是视频的话连接不可用
            //fix 853
            var img = this.selection.getRange().getClosedNode(),
                flag = img && (img.className == "edui-faked-video" || img.className.indexOf("edui-upload-video")!=-1);
            return flag ? -1 : 0;
        }
    };
};

// plugins/iframe.js
///import core
///import plugins\inserthtml.js
///commands 插入框架
///commandsName  InsertFrame
///commandsTitle  插入Iframe
///commandsDialog  dialogs\insertframe

UE.plugins['insertframe'] = function() {
   var me =this;
    function deleteIframe(){
        me._iframe && delete me._iframe;
    }

    me.addListener("selectionchange",function(){
        deleteIframe();
    });

};



// plugins/scrawl.js
///import core
///commands 涂鸦
///commandsName  Scrawl
///commandsTitle  涂鸦
///commandsDialog  dialogs\scrawl
UE.commands['scrawl'] = {
    queryCommandState : function(){
        return ( browser.ie && browser.version  <= 8 ) ? -1 :0;
    }
};


// plugins/removeformat.js
/**
 * 清除格式
 * @file
 * @since 1.2.6.1
 */

/**
 * 清除文字样式
 * @command removeformat
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @param   {String}   tags     以逗号隔开的标签。如：strong
 * @param   {String}   style    样式如：color
 * @param   {String}   attrs    属性如:width
 * @example
 * ```javascript
 * editor.execCommand( 'removeformat', 'strong','color','width' );
 * ```
 */

UE.plugins['removeformat'] = function(){
    var me = this;
    me.setOpt({
       'removeFormatTags': 'b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var',
       'removeFormatAttributes':'class,style,lang,width,height,align,hspace,valign'
    });
    me.commands['removeformat'] = {
        execCommand : function( cmdName, tags, style, attrs,notIncludeA ) {

            var tagReg = new RegExp( '^(?:' + (tags || this.options.removeFormatTags).replace( /,/g, '|' ) + ')$', 'i' ) ,
                removeFormatAttributes = style ? [] : (attrs || this.options.removeFormatAttributes).split( ',' ),
                range = new dom.Range( this.document ),
                bookmark,node,parent,
                filter = function( node ) {
                    return node.nodeType == 1;
                };

            function isRedundantSpan (node) {
                if (node.nodeType == 3 || node.tagName.toLowerCase() != 'span'){
                    return 0;
                }
                if (browser.ie) {
                    //ie 下判断实效，所以只能简单用style来判断
                    //return node.style.cssText == '' ? 1 : 0;
                    var attrs = node.attributes;
                    if ( attrs.length ) {
                        for ( var i = 0,l = attrs.length; i<l; i++ ) {
                            if ( attrs[i].specified ) {
                                return 0;
                            }
                        }
                        return 1;
                    }
                }
                return !node.attributes.length;
            }
            function doRemove( range ) {

                var bookmark1 = range.createBookmark();
                if ( range.collapsed ) {
                    range.enlarge( true );
                }

                //不能把a标签切了
                if(!notIncludeA){
                    var aNode = domUtils.findParentByTagName(range.startContainer,'a',true);
                    if(aNode){
                        range.setStartBefore(aNode);
                    }

                    aNode = domUtils.findParentByTagName(range.endContainer,'a',true);
                    if(aNode){
                        range.setEndAfter(aNode);
                    }

                }


                bookmark = range.createBookmark();

                node = bookmark.start;

                //切开始
                while ( (parent = node.parentNode) && !domUtils.isBlockElm( parent ) ) {
                    domUtils.breakParent( node, parent );

                    domUtils.clearEmptySibling( node );
                }
                if ( bookmark.end ) {
                    //切结束
                    node = bookmark.end;
                    while ( (parent = node.parentNode) && !domUtils.isBlockElm( parent ) ) {
                        domUtils.breakParent( node, parent );
                        domUtils.clearEmptySibling( node );
                    }

                    //开始去除样式
                    var current = domUtils.getNextDomNode( bookmark.start, false, filter ),
                        next;
                    while ( current ) {
                        if ( current == bookmark.end ) {
                            break;
                        }

                        next = domUtils.getNextDomNode( current, true, filter );

                        if ( !dtd.$empty[current.tagName.toLowerCase()] && !domUtils.isBookmarkNode( current ) ) {
                            if ( tagReg.test( current.tagName ) ) {
                                if ( style ) {
                                    domUtils.removeStyle( current, style );
                                    if ( isRedundantSpan( current ) && style != 'text-decoration'){
                                        domUtils.remove( current, true );
                                    }
                                } else {
                                    domUtils.remove( current, true );
                                }
                            } else {
                                //trace:939  不能把list上的样式去掉
                                if(!dtd.$tableContent[current.tagName] && !dtd.$list[current.tagName]){
                                    domUtils.removeAttributes( current, removeFormatAttributes );
                                    if ( isRedundantSpan( current ) ){
                                        domUtils.remove( current, true );
                                    }
                                }

                            }
                        }
                        current = next;
                    }
                }
                //trace:1035
                //trace:1096 不能把td上的样式去掉，比如边框
                var pN = bookmark.start.parentNode;
                if(domUtils.isBlockElm(pN) && !dtd.$tableContent[pN.tagName] && !dtd.$list[pN.tagName]){
                    domUtils.removeAttributes(  pN,removeFormatAttributes );
                }
                pN = bookmark.end.parentNode;
                if(bookmark.end && domUtils.isBlockElm(pN) && !dtd.$tableContent[pN.tagName]&& !dtd.$list[pN.tagName]){
                    domUtils.removeAttributes(  pN,removeFormatAttributes );
                }
                range.moveToBookmark( bookmark ).moveToBookmark(bookmark1);
                //清除冗余的代码 <b><bookmark></b>
                var node = range.startContainer,
                    tmp,
                    collapsed = range.collapsed;
                while(node.nodeType == 1 && domUtils.isEmptyNode(node) && dtd.$removeEmpty[node.tagName]){
                    tmp = node.parentNode;
                    range.setStartBefore(node);
                    //trace:937
                    //更新结束边界
                    if(range.startContainer === range.endContainer){
                        range.endOffset--;
                    }
                    domUtils.remove(node);
                    node = tmp;
                }

                if(!collapsed){
                    node = range.endContainer;
                    while(node.nodeType == 1 && domUtils.isEmptyNode(node) && dtd.$removeEmpty[node.tagName]){
                        tmp = node.parentNode;
                        range.setEndBefore(node);
                        domUtils.remove(node);

                        node = tmp;
                    }


                }
            }



            range = this.selection.getRange();
            doRemove( range );
            range.select();

        }

    };

};


// plugins/blockquote.js
/**
 * 添加引用
 * @file
 * @since 1.2.6.1
 */

/**
 * 添加引用
 * @command blockquote
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'blockquote' );
 * ```
 */

/**
 * 添加引用
 * @command blockquote
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @param { Object } attrs 节点属性
 * @example
 * ```javascript
 * editor.execCommand( 'blockquote',{
 *     style: "color: red;"
 * } );
 * ```
 */


UE.plugins['blockquote'] = function(){
    var me = this;
    function getObj(editor){
        return domUtils.filterNodeList(editor.selection.getStartElementPath(),'blockquote');
    }
    me.commands['blockquote'] = {
        execCommand : function( cmdName, attrs ) {
            var range = this.selection.getRange(),
                obj = getObj(this),
                blockquote = dtd.blockquote,
                bookmark = range.createBookmark();

            if ( obj ) {

                    var start = range.startContainer,
                        startBlock = domUtils.isBlockElm(start) ? start : domUtils.findParent(start,function(node){return domUtils.isBlockElm(node)}),

                        end = range.endContainer,
                        endBlock = domUtils.isBlockElm(end) ? end :  domUtils.findParent(end,function(node){return domUtils.isBlockElm(node)});

                    //处理一下li
                    startBlock = domUtils.findParentByTagName(startBlock,'li',true) || startBlock;
                    endBlock = domUtils.findParentByTagName(endBlock,'li',true) || endBlock;


                    if(startBlock.tagName == 'LI' || startBlock.tagName == 'TD' || startBlock === obj || domUtils.isBody(startBlock)){
                        domUtils.remove(obj,true);
                    }else{
                        domUtils.breakParent(startBlock,obj);
                    }

                    if(startBlock !== endBlock){
                        obj = domUtils.findParentByTagName(endBlock,'blockquote');
                        if(obj){
                            if(endBlock.tagName == 'LI' || endBlock.tagName == 'TD'|| domUtils.isBody(endBlock)){
                                obj.parentNode && domUtils.remove(obj,true);
                            }else{
                                domUtils.breakParent(endBlock,obj);
                            }

                        }
                    }

                    var blockquotes = domUtils.getElementsByTagName(this.document,'blockquote');
                    for(var i=0,bi;bi=blockquotes[i++];){
                        if(!bi.childNodes.length){
                            domUtils.remove(bi);
                        }else if(domUtils.getPosition(bi,startBlock)&domUtils.POSITION_FOLLOWING && domUtils.getPosition(bi,endBlock)&domUtils.POSITION_PRECEDING){
                            domUtils.remove(bi,true);
                        }
                    }




            } else {

                var tmpRange = range.cloneRange(),
                    node = tmpRange.startContainer.nodeType == 1 ? tmpRange.startContainer : tmpRange.startContainer.parentNode,
                    preNode = node,
                    doEnd = 1;

                //调整开始
                while ( 1 ) {
                    if ( domUtils.isBody(node) ) {
                        if ( preNode !== node ) {
                            if ( range.collapsed ) {
                                tmpRange.selectNode( preNode );
                                doEnd = 0;
                            } else {
                                tmpRange.setStartBefore( preNode );
                            }
                        }else{
                            tmpRange.setStart(node,0);
                        }

                        break;
                    }
                    if ( !blockquote[node.tagName] ) {
                        if ( range.collapsed ) {
                            tmpRange.selectNode( preNode );
                        } else{
                            tmpRange.setStartBefore( preNode);
                        }
                        break;
                    }

                    preNode = node;
                    node = node.parentNode;
                }

                //调整结束
                if ( doEnd ) {
                    preNode = node =  node = tmpRange.endContainer.nodeType == 1 ? tmpRange.endContainer : tmpRange.endContainer.parentNode;
                    while ( 1 ) {

                        if ( domUtils.isBody( node ) ) {
                            if ( preNode !== node ) {

                                tmpRange.setEndAfter( preNode );

                            } else {
                                tmpRange.setEnd( node, node.childNodes.length );
                            }

                            break;
                        }
                        if ( !blockquote[node.tagName] ) {
                            tmpRange.setEndAfter( preNode );
                            break;
                        }

                        preNode = node;
                        node = node.parentNode;
                    }

                }


                node = range.document.createElement( 'blockquote' );
                domUtils.setAttributes( node, attrs );
                node.appendChild( tmpRange.extractContents() );
                tmpRange.insertNode( node );
                //去除重复的
                var childs = domUtils.getElementsByTagName(node,'blockquote');
                for(var i=0,ci;ci=childs[i++];){
                    if(ci.parentNode){
                        domUtils.remove(ci,true);
                    }
                }

            }
            range.moveToBookmark( bookmark ).select();
        },
        queryCommandState : function() {
            return getObj(this) ? 1 : 0;
        }
    };
};



// plugins/convertcase.js
/**
 * 大小写转换
 * @file
 * @since 1.2.6.1
 */

/**
 * 把选区内文本变大写，与“tolowercase”命令互斥
 * @command touppercase
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'touppercase' );
 * ```
 */

/**
 * 把选区内文本变小写，与“touppercase”命令互斥
 * @command tolowercase
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'tolowercase' );
 * ```
 */
UE.commands['touppercase'] =
UE.commands['tolowercase'] = {
    execCommand:function (cmd) {
        var me = this;
        var rng = me.selection.getRange();
        if(rng.collapsed){
            return rng;
        }
        var bk = rng.createBookmark(),
            bkEnd = bk.end,
            filterFn = function( node ) {
                return !domUtils.isBr(node) && !domUtils.isWhitespace( node );
            },
            curNode = domUtils.getNextDomNode( bk.start, false, filterFn );
        while ( curNode && (domUtils.getPosition( curNode, bkEnd ) & domUtils.POSITION_PRECEDING) ) {

            if ( curNode.nodeType == 3 ) {
                curNode.nodeValue = curNode.nodeValue[cmd == 'touppercase' ? 'toUpperCase' : 'toLowerCase']();
            }
            curNode = domUtils.getNextDomNode( curNode, true, filterFn );
            if(curNode === bkEnd){
                break;
            }

        }
        rng.moveToBookmark(bk).select();
    }
};



// plugins/indent.js
/**
 * 首行缩进
 * @file
 * @since 1.2.6.1
 */

/**
 * 缩进
 * @command indent
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'indent' );
 * ```
 */
UE.commands['indent'] = {
    execCommand : function() {
         var me = this,value = me.queryCommandState("indent") ? "0em" : (me.options.indentValue || '2em');
         me.execCommand('Paragraph','p',{style:'text-indent:'+ value});
    },
    queryCommandState : function() {
        var pN = domUtils.filterNodeList(this.selection.getStartElementPath(),'p h1 h2 h3 h4 h5 h6');
        return pN && pN.style.textIndent && parseInt(pN.style.textIndent) ?  1 : 0;
    }

};


// plugins/print.js
/**
 * 打印
 * @file
 * @since 1.2.6.1
 */

/**
 * 打印
 * @command print
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'print' );
 * ```
 */
UE.commands['print'] = {
    execCommand : function(){
        this.window.print();
    },
    notNeedUndo : 1
};



// plugins/preview.js
/**
 * 预览
 * @file
 * @since 1.2.6.1
 */

/**
 * 预览
 * @command preview
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'preview' );
 * ```
 */
UE.commands['preview'] = {
    execCommand : function(){
        var w = window.open('', '_blank', ''),
            d = w.document;
        d.open();
        d.write('<!DOCTYPE html><html><head><meta charset="utf-8"/><script src="'+this.options.UEDITOR_HOME_URL+'ueditor.parse.js"></script><script>' +
            "setTimeout(function(){uParse('div',{rootPath: '"+ this.options.UEDITOR_HOME_URL +"'})},300)" +
            '</script></head><body><div>'+this.getContent(null,null,true)+'</div></body></html>');
        d.close();
    },
    notNeedUndo : 1
};


// plugins/selectall.js
/**
 * 全选
 * @file
 * @since 1.2.6.1
 */

/**
 * 选中所有内容
 * @command selectall
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'selectall' );
 * ```
 */
UE.plugins['selectall'] = function(){
    var me = this;
    me.commands['selectall'] = {
        execCommand : function(){
            //去掉了原生的selectAll,因为会出现报错和当内容为空时，不能出现闭合状态的光标
            var me = this,body = me.body,
                range = me.selection.getRange();
            range.selectNodeContents(body);
            if(domUtils.isEmptyBlock(body)){
                //opera不能自动合并到元素的里边，要手动处理一下
                if(browser.opera && body.firstChild && body.firstChild.nodeType == 1){
                    range.setStartAtFirst(body.firstChild);
                }
                range.collapse(true);
            }
            range.select(true);
        },
        notNeedUndo : 1
    };


    //快捷键
    me.addshortcutkey({
         "selectAll" : "ctrl+65"
    });
};


// plugins/paragraph.js
/**
 * 段落样式
 * @file
 * @since 1.2.6.1
 */

/**
 * 段落格式
 * @command paragraph
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @param {String}   style               标签值为：'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'
 * @param {Object}   attrs               标签的属性
 * @example
 * ```javascript
 * editor.execCommand( 'Paragraph','h1','{
 *     class:'test'
 * }' );
 * ```
 */

/**
 * 返回选区内节点标签名
 * @command paragraph
 * @method queryCommandValue
 * @param { String } cmd 命令字符串
 * @return { String } 节点标签名
 * @example
 * ```javascript
 * editor.queryCommandValue( 'Paragraph' );
 * ```
 */

UE.plugins['paragraph'] = function() {
    var me = this,
        block = domUtils.isBlockElm,
        notExchange = ['TD','LI','PRE'],

        doParagraph = function(range,style,attrs,sourceCmdName){
            var bookmark = range.createBookmark(),
                filterFn = function( node ) {
                    return   node.nodeType == 1 ? node.tagName.toLowerCase() != 'br' &&  !domUtils.isBookmarkNode(node) : !domUtils.isWhitespace( node );
                },
                para;

            range.enlarge( true );
            var bookmark2 = range.createBookmark(),
                current = domUtils.getNextDomNode( bookmark2.start, false, filterFn ),
                tmpRange = range.cloneRange(),
                tmpNode;
            while ( current && !(domUtils.getPosition( current, bookmark2.end ) & domUtils.POSITION_FOLLOWING) ) {
                if ( current.nodeType == 3 || !block( current ) ) {
                    tmpRange.setStartBefore( current );
                    while ( current && current !== bookmark2.end && !block( current ) ) {
                        tmpNode = current;
                        current = domUtils.getNextDomNode( current, false, null, function( node ) {
                            return !block( node );
                        } );
                    }
                    tmpRange.setEndAfter( tmpNode );
                    
                    para = range.document.createElement( style );
                    if(attrs){
                        domUtils.setAttributes(para,attrs);
                        if(sourceCmdName && sourceCmdName == 'customstyle' && attrs.style){
                            para.style.cssText = attrs.style;
                        }
                    }
                    para.appendChild( tmpRange.extractContents() );
                    //需要内容占位
                    if(domUtils.isEmptyNode(para)){
                        domUtils.fillChar(range.document,para);
                        
                    }

                    tmpRange.insertNode( para );

                    var parent = para.parentNode;
                    //如果para上一级是一个block元素且不是body,td就删除它
                    if ( block( parent ) && !domUtils.isBody( para.parentNode ) && utils.indexOf(notExchange,parent.tagName)==-1) {
                        //存储dir,style
                        if(!(sourceCmdName && sourceCmdName == 'customstyle')){
                            parent.getAttribute('dir') && para.setAttribute('dir',parent.getAttribute('dir'));
                            //trace:1070
                            parent.style.cssText && (para.style.cssText = parent.style.cssText + ';' + para.style.cssText);
                            //trace:1030
                            parent.style.textAlign && !para.style.textAlign && (para.style.textAlign = parent.style.textAlign);
                            parent.style.textIndent && !para.style.textIndent && (para.style.textIndent = parent.style.textIndent);
                            parent.style.padding && !para.style.padding && (para.style.padding = parent.style.padding);
                        }

                        //trace:1706 选择的就是h1-6要删除
                        if(attrs && /h\d/i.test(parent.tagName) && !/h\d/i.test(para.tagName) ){
                            domUtils.setAttributes(parent,attrs);
                            if(sourceCmdName && sourceCmdName == 'customstyle' && attrs.style){
                                parent.style.cssText = attrs.style;
                            }
                            domUtils.remove(para,true);
                            para = parent;
                        }else{
                            domUtils.remove( para.parentNode, true );
                        }

                    }
                    if(  utils.indexOf(notExchange,parent.tagName)!=-1){
                        current = parent;
                    }else{
                       current = para;
                    }


                    current = domUtils.getNextDomNode( current, false, filterFn );
                } else {
                    current = domUtils.getNextDomNode( current, true, filterFn );
                }
            }
            return range.moveToBookmark( bookmark2 ).moveToBookmark( bookmark );
        };
    me.setOpt('paragraph',{'p':'', 'h1':'', 'h2':'', 'h3':'', 'h4':'', 'h5':'', 'h6':''});
    me.commands['paragraph'] = {
        execCommand : function( cmdName, style,attrs,sourceCmdName ) {
            var range = this.selection.getRange();
             //闭合时单独处理
            if(range.collapsed){
                var txt = this.document.createTextNode('p');
                range.insertNode(txt);
                //去掉冗余的fillchar
                if(browser.ie){
                    var node = txt.previousSibling;
                    if(node && domUtils.isWhitespace(node)){
                        domUtils.remove(node);
                    }
                    node = txt.nextSibling;
                    if(node && domUtils.isWhitespace(node)){
                        domUtils.remove(node);
                    }
                }

            }
            range = doParagraph(range,style,attrs,sourceCmdName);
            if(txt){
                range.setStartBefore(txt).collapse(true);
                pN = txt.parentNode;

                domUtils.remove(txt);

                if(domUtils.isBlockElm(pN)&&domUtils.isEmptyNode(pN)){
                    domUtils.fillNode(this.document,pN);
                }

            }

            if(browser.gecko && range.collapsed && range.startContainer.nodeType == 1){
                var child = range.startContainer.childNodes[range.startOffset];
                if(child && child.nodeType == 1 && child.tagName.toLowerCase() == style){
                    range.setStart(child,0).collapse(true);
                }
            }
            //trace:1097 原来有true，原因忘了，但去了就不能清除多余的占位符了
            range.select();


            return true;
        },
        queryCommandValue : function() {
            var node = domUtils.filterNodeList(this.selection.getStartElementPath(),'p h1 h2 h3 h4 h5 h6');
            return node ? node.tagName.toLowerCase() : '';
        }
    };
};


// plugins/directionality.js
/**
 * 设置文字输入的方向的插件
 * @file
 * @since 1.2.6.1
 */
(function() {
    var block = domUtils.isBlockElm ,
        getObj = function(editor){
//            var startNode = editor.selection.getStart(),
//                parents;
//            if ( startNode ) {
//                //查找所有的是block的父亲节点
//                parents = domUtils.findParents( startNode, true, block, true );
//                for ( var i = 0,ci; ci = parents[i++]; ) {
//                    if ( ci.getAttribute( 'dir' ) ) {
//                        return ci;
//                    }
//                }
//            }
            return domUtils.filterNodeList(editor.selection.getStartElementPath(),function(n){return n && n.nodeType == 1 && n.getAttribute('dir')});

        },
        doDirectionality = function(range,editor,forward){
            
            var bookmark,
                filterFn = function( node ) {
                    return   node.nodeType == 1 ? !domUtils.isBookmarkNode(node) : !domUtils.isWhitespace(node);
                },

                obj = getObj( editor );

            if ( obj && range.collapsed ) {
                obj.setAttribute( 'dir', forward );
                return range;
            }
            bookmark = range.createBookmark();
            range.enlarge( true );
            var bookmark2 = range.createBookmark(),
                current = domUtils.getNextDomNode( bookmark2.start, false, filterFn ),
                tmpRange = range.cloneRange(),
                tmpNode;
            while ( current &&  !(domUtils.getPosition( current, bookmark2.end ) & domUtils.POSITION_FOLLOWING) ) {
                if ( current.nodeType == 3 || !block( current ) ) {
                    tmpRange.setStartBefore( current );
                    while ( current && current !== bookmark2.end && !block( current ) ) {
                        tmpNode = current;
                        current = domUtils.getNextDomNode( current, false, null, function( node ) {
                            return !block( node );
                        } );
                    }
                    tmpRange.setEndAfter( tmpNode );
                    var common = tmpRange.getCommonAncestor();
                    if ( !domUtils.isBody( common ) && block( common ) ) {
                        //遍历到了block节点
                        common.setAttribute( 'dir', forward );
                        current = common;
                    } else {
                        //没有遍历到，添加一个block节点
                        var p = range.document.createElement( 'p' );
                        p.setAttribute( 'dir', forward );
                        var frag = tmpRange.extractContents();
                        p.appendChild( frag );
                        tmpRange.insertNode( p );
                        current = p;
                    }

                    current = domUtils.getNextDomNode( current, false, filterFn );
                } else {
                    current = domUtils.getNextDomNode( current, true, filterFn );
                }
            }
            return range.moveToBookmark( bookmark2 ).moveToBookmark( bookmark );
        };

    /**
     * 文字输入方向
     * @command directionality
     * @method execCommand
     * @param { String } cmdName 命令字符串
     * @param { String } forward 传入'ltr'表示从左向右输入，传入'rtl'表示从右向左输入
     * @example
     * ```javascript
     * editor.execCommand( 'directionality', 'ltr');
     * ```
     */

    /**
     * 查询当前选区的文字输入方向
     * @command directionality
     * @method queryCommandValue
     * @param { String } cmdName 命令字符串
     * @return { String } 返回'ltr'表示从左向右输入，返回'rtl'表示从右向左输入
     * @example
     * ```javascript
     * editor.queryCommandValue( 'directionality');
     * ```
     */
    UE.commands['directionality'] = {
        execCommand : function( cmdName,forward ) {
            var range = this.selection.getRange();
            //闭合时单独处理
            if(range.collapsed){
                var txt = this.document.createTextNode('d');
                range.insertNode(txt);
            }
            doDirectionality(range,this,forward);
            if(txt){
                range.setStartBefore(txt).collapse(true);
                domUtils.remove(txt);
            }

            range.select();
            return true;
        },
        queryCommandValue : function() {
            var node = getObj(this);
            return node ? node.getAttribute('dir') : 'ltr';
        }
    };
})();



// plugins/horizontal.js
/**
 * 插入分割线插件
 * @file
 * @since 1.2.6.1
 */

/**
 * 插入分割线
 * @command horizontal
 * @method execCommand
 * @param { String } cmdName 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'horizontal' );
 * ```
 */
UE.plugins['horizontal'] = function(){
    var me = this;
    me.commands['horizontal'] = {
        execCommand : function( cmdName ) {
            var me = this;
            if(me.queryCommandState(cmdName)!==-1){
                me.execCommand('insertHtml','<hr>');
                var range = me.selection.getRange(),
                    start = range.startContainer;
                if(start.nodeType == 1 && !start.childNodes[range.startOffset] ){

                    var tmp;
                    if(tmp = start.childNodes[range.startOffset - 1]){
                        if(tmp.nodeType == 1 && tmp.tagName == 'HR'){
                            if(me.options.enterTag == 'p'){
                                tmp = me.document.createElement('p');
                                range.insertNode(tmp);
                                range.setStart(tmp,0).setCursor();

                            }else{
                                tmp = me.document.createElement('br');
                                range.insertNode(tmp);
                                range.setStartBefore(tmp).setCursor();
                            }
                        }
                    }

                }
                return true;
            }

        },
        //边界在table里不能加分隔线
        queryCommandState : function() {
            return domUtils.filterNodeList(this.selection.getStartElementPath(),'table') ? -1 : 0;
        }
    };
//    me.addListener('delkeyup',function(){
//        var rng = this.selection.getRange();
//        if(browser.ie && browser.version > 8){
//            rng.txtToElmBoundary(true);
//            if(domUtils.isStartInblock(rng)){
//                var tmpNode = rng.startContainer;
//                var pre = tmpNode.previousSibling;
//                if(pre && domUtils.isTagNode(pre,'hr')){
//                    domUtils.remove(pre);
//                    rng.select();
//                    return;
//                }
//            }
//        }
//        if(domUtils.isBody(rng.startContainer)){
//            var hr = rng.startContainer.childNodes[rng.startOffset -1];
//            if(hr && hr.nodeName == 'HR'){
//                var next = hr.nextSibling;
//                if(next){
//                    rng.setStart(next,0)
//                }else if(hr.previousSibling){
//                    rng.setStartAtLast(hr.previousSibling)
//                }else{
//                    var p = this.document.createElement('p');
//                    hr.parentNode.insertBefore(p,hr);
//                    domUtils.fillNode(this.document,p);
//                    rng.setStart(p,0);
//                }
//                domUtils.remove(hr);
//                rng.setCursor(false,true);
//            }
//        }
//    })
    me.addListener('delkeydown',function(name,evt){
        var rng = this.selection.getRange();
        rng.txtToElmBoundary(true);
        if(domUtils.isStartInblock(rng)){
            var tmpNode = rng.startContainer;
            var pre = tmpNode.previousSibling;
            if(pre && domUtils.isTagNode(pre,'hr')){
                domUtils.remove(pre);
                rng.select();
                domUtils.preventDefault(evt);
                return true;

            }
        }

    })
};



// plugins/time.js
/**
 * 插入时间和日期
 * @file
 * @since 1.2.6.1
 */

/**
 * 插入时间，默认格式：12:59:59
 * @command time
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'time');
 * ```
 */

/**
 * 插入日期，默认格式：2013-08-30
 * @command date
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'date');
 * ```
 */
UE.commands['time'] = UE.commands["date"] = {
    execCommand : function(cmd, format){
        var date = new Date;

        function formatTime(date, format) {
            var hh = ('0' + date.getHours()).slice(-2),
                ii = ('0' + date.getMinutes()).slice(-2),
                ss = ('0' + date.getSeconds()).slice(-2);
            format = format || 'hh:ii:ss';
            return format.replace(/hh/ig, hh).replace(/ii/ig, ii).replace(/ss/ig, ss);
        }
        function formatDate(date, format) {
            var yyyy = ('000' + date.getFullYear()).slice(-4),
                yy = yyyy.slice(-2),
                mm = ('0' + (date.getMonth()+1)).slice(-2),
                dd = ('0' + date.getDate()).slice(-2);
            format = format || 'yyyy-mm-dd';
            return format.replace(/yyyy/ig, yyyy).replace(/yy/ig, yy).replace(/mm/ig, mm).replace(/dd/ig, dd);
        }

        this.execCommand('insertHtml',cmd == "time" ? formatTime(date, format):formatDate(date, format) );
    }
};


// plugins/rowspacing.js
/**
 * 段前段后间距插件
 * @file
 * @since 1.2.6.1
 */

/**
 * 设置段间距
 * @command rowspacing
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @param { String } value 段间距的值，以px为单位
 * @param { String } dir 间距位置，top或bottom，分别表示段前和段后
 * @example
 * ```javascript
 * editor.execCommand( 'rowspacing', '10', 'top' );
 * ```
 */

UE.plugins['rowspacing'] = function(){
    var me = this;
    me.setOpt({
        'rowspacingtop':['5', '10', '15', '20', '25'],
        'rowspacingbottom':['5', '10', '15', '20', '25']

    });
    me.commands['rowspacing'] =  {
        execCommand : function( cmdName,value,dir ) {
            this.execCommand('paragraph','p',{style:'margin-'+dir+':'+value + 'px'});
            return true;
        },
        queryCommandValue : function(cmdName,dir) {
            var pN = domUtils.filterNodeList(this.selection.getStartElementPath(),function(node){return domUtils.isBlockElm(node) }),
                value;
            //trace:1026
            if(pN){
                value = domUtils.getComputedStyle(pN,'margin-'+dir).replace(/[^\d]/g,'');
                return !value ? 0 : value;
            }
            return 0;

        }
    };
};




// plugins/lineheight.js
/**
 * 设置行内间距
 * @file
 * @since 1.2.6.1
 */
UE.plugins['lineheight'] = function(){
    var me = this;
    me.setOpt({'lineheight':['1', '1.5','1.75','2', '3', '4', '5']});

    /**
     * 行距
     * @command lineheight
     * @method execCommand
     * @param { String } cmdName 命令字符串
     * @param { String } value 传入的行高值， 该值是当前字体的倍数， 例如： 1.5, 1.75
     * @example
     * ```javascript
     * editor.execCommand( 'lineheight', 1.5);
     * ```
     */
    /**
     * 查询当前选区内容的行高大小
     * @command lineheight
     * @method queryCommandValue
     * @param { String } cmd 命令字符串
     * @return { String } 返回当前行高大小
     * @example
     * ```javascript
     * editor.queryCommandValue( 'lineheight' );
     * ```
     */

    me.commands['lineheight'] =  {
        execCommand : function( cmdName,value ) {
            this.execCommand('paragraph','p',{style:'line-height:'+ (value == "1" ? "normal" : value + 'em') });
            return true;
        },
        queryCommandValue : function() {
            var pN = domUtils.filterNodeList(this.selection.getStartElementPath(),function(node){return domUtils.isBlockElm(node)});
            if(pN){
                var value = domUtils.getComputedStyle(pN,'line-height');
                return value == 'normal' ? 1 : value.replace(/[^\d.]*/ig,"");
            }
        }
    };
};




// plugins/insertcode.js
/**
 * 插入代码插件
 * @file
 * @since 1.2.6.1
 */

UE.plugins['insertcode'] = function() {
    var me = this;
    me.ready(function(){
        utils.cssRule('pre','pre{margin:.5em 0;padding:.4em .6em;border-radius:8px;background:#f8f8f8;}',
            me.document)
    });
    me.setOpt('insertcode',{
            'as3':'ActionScript3',
            'bash':'Bash/Shell',
            'cpp':'C/C++',
            'css':'Css',
            'cf':'CodeFunction',
            'c#':'C#',
            'delphi':'Delphi',
            'diff':'Diff',
            'erlang':'Erlang',
            'groovy':'Groovy',
            'html':'Html',
            'java':'Java',
            'jfx':'JavaFx',
            'js':'Javascript',
            'pl':'Perl',
            'php':'Php',
            'plain':'Plain Text',
            'ps':'PowerShell',
            'python':'Python',
            'ruby':'Ruby',
            'scala':'Scala',
            'sql':'Sql',
            'vb':'Vb',
            'xml':'Xml'
    });

    /**
     * 插入代码
     * @command insertcode
     * @method execCommand
     * @param { String } cmd 命令字符串
     * @param { String } lang 插入代码的语言
     * @example
     * ```javascript
     * editor.execCommand( 'insertcode', 'javascript' );
     * ```
     */

    /**
     * 如果选区所在位置是插入插入代码区域，返回代码的语言
     * @command insertcode
     * @method queryCommandValue
     * @param { String } cmd 命令字符串
     * @return { String } 返回代码的语言
     * @example
     * ```javascript
     * editor.queryCommandValue( 'insertcode' );
     * ```
     */

    me.commands['insertcode'] = {
        execCommand : function(cmd,lang){
            var me = this,
                rng = me.selection.getRange(),
                pre = domUtils.findParentByTagName(rng.startContainer,'pre',true);
            if(pre){
                pre.className = 'brush:'+lang+';toolbar:false;';
            }else{
                var code = '';
                if(rng.collapsed){
                    code = browser.ie && browser.ie11below ? (browser.version <= 8 ? '&nbsp;':''):'<br/>';
                }else{
                    var frag = rng.extractContents();
                    var div = me.document.createElement('div');
                    div.appendChild(frag);

                    utils.each(UE.filterNode(UE.htmlparser(div.innerHTML.replace(/[\r\t]/g,'')),me.options.filterTxtRules).children,function(node){
                        if(browser.ie && browser.ie11below && browser.version > 8){

                            if(node.type =='element'){
                                if(node.tagName == 'br'){
                                    code += '\n'
                                }else if(!dtd.$empty[node.tagName]){
                                    utils.each(node.children,function(cn){
                                        if(cn.type =='element'){
                                            if(cn.tagName == 'br'){
                                                code += '\n'
                                            }else if(!dtd.$empty[node.tagName]){
                                                code += cn.innerText();
                                            }
                                        }else{
                                            code += cn.data
                                        }
                                    })
                                    if(!/\n$/.test(code)){
                                        code += '\n';
                                    }
                                }
                            }else{
                                code += node.data + '\n'
                            }
                            if(!node.nextSibling() && /\n$/.test(code)){
                                code = code.replace(/\n$/,'');
                            }
                        }else{
                            if(browser.ie && browser.ie11below){

                                if(node.type =='element'){
                                    if(node.tagName == 'br'){
                                        code += '<br>'
                                    }else if(!dtd.$empty[node.tagName]){
                                        utils.each(node.children,function(cn){
                                            if(cn.type =='element'){
                                                if(cn.tagName == 'br'){
                                                    code += '<br>'
                                                }else if(!dtd.$empty[node.tagName]){
                                                    code += cn.innerText();
                                                }
                                            }else{
                                                code += cn.data
                                            }
                                        });
                                        if(!/br>$/.test(code)){
                                            code += '<br>';
                                        }
                                    }
                                }else{
                                    code += node.data + '<br>'
                                }
                                if(!node.nextSibling() && /<br>$/.test(code)){
                                    code = code.replace(/<br>$/,'');
                                }

                            }else{
                                code += (node.type == 'element' ? (dtd.$empty[node.tagName] ?  '' : node.innerText()) : node.data);
                                if(!/br\/?\s*>$/.test(code)){
                                    if(!node.nextSibling())
                                        return;
                                    code += '<br>'
                                }
                            }

                        }

                    });
                }
                me.execCommand('inserthtml','<pre id="coder"class="brush:'+lang+';toolbar:false">'+code+'</pre>',true);

                pre = me.document.getElementById('coder');
                domUtils.removeAttributes(pre,'id');
                var tmpNode = pre.previousSibling;

                if(tmpNode && (tmpNode.nodeType == 3 && tmpNode.nodeValue.length == 1 && browser.ie && browser.version == 6 ||  domUtils.isEmptyBlock(tmpNode))){

                    domUtils.remove(tmpNode)
                }
                var rng = me.selection.getRange();
                if(domUtils.isEmptyBlock(pre)){
                    rng.setStart(pre,0).setCursor(false,true)
                }else{
                    rng.selectNodeContents(pre).select()
                }
            }



        },
        queryCommandValue : function(){
            var path = this.selection.getStartElementPath();
            var lang = '';
            utils.each(path,function(node){
                if(node.nodeName =='PRE'){
                    var match = node.className.match(/brush:([^;]+)/);
                    lang = match && match[1] ? match[1] : '';
                    return false;
                }
            });
            return lang;
        }
    };

    me.addInputRule(function(root){
       utils.each(root.getNodesByTagName('pre'),function(pre){
           var brs = pre.getNodesByTagName('br');
           if(brs.length){
               browser.ie && browser.ie11below && browser.version > 8 && utils.each(brs,function(br){
                   var txt = UE.uNode.createText('\n');
                   br.parentNode.insertBefore(txt,br);
                   br.parentNode.removeChild(br);
               });
               return;
            }
           if(browser.ie && browser.ie11below && browser.version > 8)
                return;
            var code = pre.innerText().split(/\n/);
            pre.innerHTML('');
            utils.each(code,function(c){
                if(c.length){
                    pre.appendChild(UE.uNode.createText(c));
                }
                pre.appendChild(UE.uNode.createElement('br'))
            })
       })
    });
    me.addOutputRule(function(root){
        utils.each(root.getNodesByTagName('pre'),function(pre){
            var code = '';
            utils.each(pre.children,function(n){
               if(n.type == 'text'){
                   //在ie下文本内容有可能末尾带有\n要去掉
                   //trace:3396
                   code += n.data.replace(/[ ]/g,'&nbsp;').replace(/\n$/,'');
               }else{
                   if(n.tagName == 'br'){
                       code  += '\n'
                   }else{
                       code += (!dtd.$empty[n.tagName] ? '' : n.innerText());
                   }

               }

            });

            pre.innerText(code.replace(/(&nbsp;|\n)+$/,''))
        })
    });
    //不需要判断highlight的command列表
    me.notNeedCodeQuery ={
        help:1,
        undo:1,
        redo:1,
        source:1,
        print:1,
        searchreplace:1,
        fullscreen:1,
        preview:1,
        insertparagraph:1,
        elementpath:1,
        insertcode:1,
        inserthtml:1,
        selectall:1
    };
    //将queyCommamndState重置
    var orgQuery = me.queryCommandState;
    me.queryCommandState = function(cmd){
        var me = this;

        if(!me.notNeedCodeQuery[cmd.toLowerCase()] && me.selection && me.queryCommandValue('insertcode')){
            return -1;
        }
        return UE.Editor.prototype.queryCommandState.apply(this,arguments)
    };
    me.addListener('beforeenterkeydown',function(){
        var rng = me.selection.getRange();
        var pre = domUtils.findParentByTagName(rng.startContainer,'pre',true);
        if(pre){
            me.fireEvent('saveScene');
            if(!rng.collapsed){
               rng.deleteContents();
            }
            if(!browser.ie || browser.ie9above){
                var tmpNode = me.document.createElement('br'),pre;
                rng.insertNode(tmpNode).setStartAfter(tmpNode).collapse(true);
                var next = tmpNode.nextSibling;
                if(!next && (!browser.ie || browser.version > 10)){
                    rng.insertNode(tmpNode.cloneNode(false));
                }else{
                    rng.setStartAfter(tmpNode);
                }
                pre = tmpNode.previousSibling;
                var tmp;
                while(pre ){
                    tmp = pre;
                    pre = pre.previousSibling;
                    if(!pre || pre.nodeName == 'BR'){
                        pre = tmp;
                        break;
                    }
                }
                if(pre){
                    var str = '';
                    while(pre && pre.nodeName != 'BR' &&  new RegExp('^[\\s'+domUtils.fillChar+']*$').test(pre.nodeValue)){
                        str += pre.nodeValue;
                        pre = pre.nextSibling;
                    }
                    if(pre.nodeName != 'BR'){
                        var match = pre.nodeValue.match(new RegExp('^([\\s'+domUtils.fillChar+']+)'));
                        if(match && match[1]){
                            str += match[1]
                        }

                    }
                    if(str){
                        str = me.document.createTextNode(str);
                        rng.insertNode(str).setStartAfter(str);
                    }
                }
                rng.collapse(true).select(true);
            }else{
                if(browser.version > 8){

                    var txt = me.document.createTextNode('\n');
                    var start = rng.startContainer;
                    if(rng.startOffset == 0){
                        var preNode = start.previousSibling;
                        if(preNode){
                            rng.insertNode(txt);
                            var fillchar = me.document.createTextNode(' ');
                            rng.setStartAfter(txt).insertNode(fillchar).setStart(fillchar,0).collapse(true).select(true)
                        }
                    }else{
                        rng.insertNode(txt).setStartAfter(txt);
                        var fillchar = me.document.createTextNode(' ');
                        start = rng.startContainer.childNodes[rng.startOffset];
                        if(start && !/^\n/.test(start.nodeValue)){
                            rng.setStartBefore(txt)
                        }
                        rng.insertNode(fillchar).setStart(fillchar,0).collapse(true).select(true)
                    }

                }else{
                    var tmpNode = me.document.createElement('br');
                    rng.insertNode(tmpNode);
                    rng.insertNode(me.document.createTextNode(domUtils.fillChar));
                    rng.setStartAfter(tmpNode);
                    pre = tmpNode.previousSibling;
                    var tmp;
                    while(pre ){
                        tmp = pre;
                        pre = pre.previousSibling;
                        if(!pre || pre.nodeName == 'BR'){
                            pre = tmp;
                            break;
                        }
                    }
                    if(pre){
                        var str = '';
                        while(pre && pre.nodeName != 'BR' &&  new RegExp('^[ '+domUtils.fillChar+']*$').test(pre.nodeValue)){
                            str += pre.nodeValue;
                            pre = pre.nextSibling;
                        }
                        if(pre.nodeName != 'BR'){
                            var match = pre.nodeValue.match(new RegExp('^([ '+domUtils.fillChar+']+)'));
                            if(match && match[1]){
                                str += match[1]
                            }

                        }

                        str = me.document.createTextNode(str);
                        rng.insertNode(str).setStartAfter(str);
                    }
                    rng.collapse(true).select();
                }


            }
            me.fireEvent('saveScene');
            return true;
        }


    });

    me.addListener('tabkeydown',function(cmd,evt){
        var rng = me.selection.getRange();
        var pre = domUtils.findParentByTagName(rng.startContainer,'pre',true);
        if(pre){
            me.fireEvent('saveScene');
            if(evt.shiftKey){

            }else{
                if(!rng.collapsed){
                    var bk = rng.createBookmark();
                    var start = bk.start.previousSibling;

                    while(start){
                        if(pre.firstChild === start && !domUtils.isBr(start)){
                            pre.insertBefore(me.document.createTextNode('    '),start);

                            break;
                        }
                        if(domUtils.isBr(start)){
                            pre.insertBefore(me.document.createTextNode('    '),start.nextSibling);

                            break;
                        }
                        start = start.previousSibling;
                    }
                    var end = bk.end;
                    start = bk.start.nextSibling;
                    if(pre.firstChild === bk.start){
                        pre.insertBefore(me.document.createTextNode('    '),start.nextSibling)

                    }
                    while(start && start !== end){
                        if(domUtils.isBr(start) && start.nextSibling){
                            if(start.nextSibling === end){
                                break;
                            }
                            pre.insertBefore(me.document.createTextNode('    '),start.nextSibling)
                        }

                        start = start.nextSibling;
                    }
                    rng.moveToBookmark(bk).select();
                }else{
                    var tmpNode = me.document.createTextNode('    ');
                    rng.insertNode(tmpNode).setStartAfter(tmpNode).collapse(true).select(true);
                }
            }


            me.fireEvent('saveScene');
            return true;
        }


    });


    me.addListener('beforeinserthtml',function(evtName,html){
        var me = this,
            rng = me.selection.getRange(),
            pre = domUtils.findParentByTagName(rng.startContainer,'pre',true);
        if(pre){
            if(!rng.collapsed){
                rng.deleteContents()
            }
            var htmlstr = '';
            if(browser.ie && browser.version > 8){

                utils.each(UE.filterNode(UE.htmlparser(html),me.options.filterTxtRules).children,function(node){
                    if(node.type =='element'){
                        if(node.tagName == 'br'){
                            htmlstr += '\n'
                        }else if(!dtd.$empty[node.tagName]){
                            utils.each(node.children,function(cn){
                                if(cn.type =='element'){
                                    if(cn.tagName == 'br'){
                                        htmlstr += '\n'
                                    }else if(!dtd.$empty[node.tagName]){
                                        htmlstr += cn.innerText();
                                    }
                                }else{
                                    htmlstr += cn.data
                                }
                            })
                            if(!/\n$/.test(htmlstr)){
                                htmlstr += '\n';
                            }
                        }
                    }else{
                        htmlstr += node.data + '\n'
                    }
                    if(!node.nextSibling() && /\n$/.test(htmlstr)){
                        htmlstr = htmlstr.replace(/\n$/,'');
                    }
                });
                var tmpNode = me.document.createTextNode(utils.html(htmlstr.replace(/&nbsp;/g,' ')));
                rng.insertNode(tmpNode).selectNode(tmpNode).select();
            }else{
                var frag = me.document.createDocumentFragment();

                utils.each(UE.filterNode(UE.htmlparser(html),me.options.filterTxtRules).children,function(node){
                    if(node.type =='element'){
                        if(node.tagName == 'br'){
                            frag.appendChild(me.document.createElement('br'))
                        }else if(!dtd.$empty[node.tagName]){
                            utils.each(node.children,function(cn){
                                if(cn.type =='element'){
                                    if(cn.tagName == 'br'){

                                        frag.appendChild(me.document.createElement('br'))
                                    }else if(!dtd.$empty[node.tagName]){
                                        frag.appendChild(me.document.createTextNode(utils.html(cn.innerText().replace(/&nbsp;/g,' '))));

                                    }
                                }else{
                                    frag.appendChild(me.document.createTextNode(utils.html( cn.data.replace(/&nbsp;/g,' '))));

                                }
                            })
                            if(frag.lastChild.nodeName != 'BR'){
                                frag.appendChild(me.document.createElement('br'))
                            }
                        }
                    }else{
                        frag.appendChild(me.document.createTextNode(utils.html( node.data.replace(/&nbsp;/g,' '))));
                    }
                    if(!node.nextSibling() && frag.lastChild.nodeName == 'BR'){
                       frag.removeChild(frag.lastChild)
                    }


                });
                rng.insertNode(frag).select();

            }

            return true;
        }
    });
    //方向键的处理
    me.addListener('keydown',function(cmd,evt){
        var me = this,keyCode = evt.keyCode || evt.which;
        if(keyCode == 40){
            var rng = me.selection.getRange(),pre,start = rng.startContainer;
            if(rng.collapsed && (pre = domUtils.findParentByTagName(rng.startContainer,'pre',true)) && !pre.nextSibling){
                var last = pre.lastChild
                while(last && last.nodeName == 'BR'){
                    last = last.previousSibling;
                }
                if(last === start || rng.startContainer === pre && rng.startOffset == pre.childNodes.length){
                    me.execCommand('insertparagraph');
                    domUtils.preventDefault(evt)
                }

            }
        }
    });
    //trace:3395
    me.addListener('delkeydown',function(type,evt){
        var rng = this.selection.getRange();
        rng.txtToElmBoundary(true);
        var start = rng.startContainer;
        if(domUtils.isTagNode(start,'pre') && rng.collapsed && domUtils.isStartInblock(rng)){
            var p = me.document.createElement('p');
            domUtils.fillNode(me.document,p);
            start.parentNode.insertBefore(p,start);
            domUtils.remove(start);
            rng.setStart(p,0).setCursor(false,true);
            domUtils.preventDefault(evt);
            return true;
        }
    })
};


// plugins/cleardoc.js
/**
 * 清空文档插件
 * @file
 * @since 1.2.6.1
 */

/**
 * 清空文档
 * @command cleardoc
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * //editor 是编辑器实例
 * editor.execCommand('cleardoc');
 * ```
 */

UE.commands['cleardoc'] = {
    execCommand : function( cmdName) {
        var me = this,
            enterTag = me.options.enterTag,
            range = me.selection.getRange();
        if(enterTag == "br"){
            me.body.innerHTML = "<br/>";
            range.setStart(me.body,0).setCursor();
        }else{
            me.body.innerHTML = "<p>"+(ie ? "" : "<br/>")+"</p>";
            range.setStart(me.body.firstChild,0).setCursor(false,true);
        }
        setTimeout(function(){
            me.fireEvent("clearDoc");
        },0);

    }
};



// plugins/anchor.js
/**
 * 锚点插件，为UEditor提供插入锚点支持
 * @file
 * @since 1.2.6.1
 */
UE.plugin.register('anchor', function (){

    return {
        bindEvents:{
            'ready':function(){
                utils.cssRule('anchor',
                    '.anchorclass{background: url(\''
                        + this.options.themePath
                        + this.options.theme +'/images/anchor.gif\') no-repeat scroll left center transparent;cursor: auto;display: inline-block;height: 16px;width: 15px;}',
                    this.document);
            }
        },
       outputRule: function(root){
           utils.each(root.getNodesByTagName('img'),function(a){
               var val;
               if(val = a.getAttr('anchorname')){
                   a.tagName = 'a';
                   a.setAttr({
                       anchorname : '',
                       name : val,
                       'class' : ''
                   })
               }
           })
       },
       inputRule:function(root){
           utils.each(root.getNodesByTagName('a'),function(a){
               var val;
               if((val = a.getAttr('name')) && !a.getAttr('href')){
                   a.tagName = 'img';
                   a.setAttr({
                       anchorname :a.getAttr('name'),
                       'class' : 'anchorclass'
                   });
                   a.setAttr('name')

               }
           })

       },
       commands:{
           /**
            * 插入锚点
            * @command anchor
            * @method execCommand
            * @param { String } cmd 命令字符串
            * @param { String } name 锚点名称字符串
            * @example
            * ```javascript
            * //editor 是编辑器实例
            * editor.execCommand('anchor', 'anchor1');
            * ```
            */
           'anchor':{
               execCommand:function (cmd, name) {
                   var range = this.selection.getRange(),img = range.getClosedNode();
                   if (img && img.getAttribute('anchorname')) {
                       if (name) {
                           img.setAttribute('anchorname', name);
                       } else {
                           range.setStartBefore(img).setCursor();
                           domUtils.remove(img);
                       }
                   } else {
                       if (name) {
                           //只在选区的开始插入
                           var anchor = this.document.createElement('img');
                           range.collapse(true);
                           domUtils.setAttributes(anchor,{
                               'anchorname':name,
                               'class':'anchorclass'
                           });
                           range.insertNode(anchor).setStartAfter(anchor).setCursor(false,true);
                       }
                   }
               }
           }
       }
    }
});


// plugins/wordcount.js
///import core
///commands 字数统计
///commandsName  WordCount,wordCount
///commandsTitle  字数统计
/*
 * Created by JetBrains WebStorm.
 * User: taoqili
 * Date: 11-9-7
 * Time: 下午8:18
 * To change this template use File | Settings | File Templates.
 */

UE.plugins['wordcount'] = function(){
    var me = this;
    me.setOpt('wordCount',true);
    me.addListener('contentchange',function(){
        me.fireEvent('wordcount');
    });
    var timer;
    me.addListener('ready',function(){
        var me = this;
        domUtils.on(me.body,"keyup",function(evt){
            var code = evt.keyCode||evt.which,
                //忽略的按键,ctr,alt,shift,方向键
                ignores = {"16":1,"18":1,"20":1,"37":1,"38":1,"39":1,"40":1};
            if(code in ignores) return;
            clearTimeout(timer);
            timer = setTimeout(function(){
                me.fireEvent('wordcount');
            },200)
        })
    });
};


// plugins/pagebreak.js
/**
 * 分页功能插件
 * @file
 * @since 1.2.6.1
 */
UE.plugins['pagebreak'] = function () {
    var me = this,
        notBreakTags = ['td'];
    me.setOpt('pageBreakTag','_ueditor_page_break_tag_');

    function fillNode(node){
        if(domUtils.isEmptyBlock(node)){
            var firstChild = node.firstChild,tmpNode;

            while(firstChild && firstChild.nodeType == 1 && domUtils.isEmptyBlock(firstChild)){
                tmpNode = firstChild;
                firstChild = firstChild.firstChild;
            }
            !tmpNode && (tmpNode = node);
            domUtils.fillNode(me.document,tmpNode);
        }
    }
    //分页符样式添加

    me.ready(function(){
        utils.cssRule('pagebreak','.pagebreak{display:block;clear:both !important;cursor:default !important;width: 100% !important;margin:0;}',me.document);
    });
    function isHr(node){
        return node && node.nodeType == 1 && node.tagName == 'HR' && node.className == 'pagebreak';
    }
    me.addInputRule(function(root){
        root.traversal(function(node){
            if(node.type == 'text' && node.data == me.options.pageBreakTag){
                var hr = UE.uNode.createElement('<hr class="pagebreak" noshade="noshade" size="5" style="-webkit-user-select: none;">');
                node.parentNode.insertBefore(hr,node);
                node.parentNode.removeChild(node)
            }
        })
    });
    me.addOutputRule(function(node){
        utils.each(node.getNodesByTagName('hr'),function(n){
            if(n.getAttr('class') == 'pagebreak'){
                var txt = UE.uNode.createText(me.options.pageBreakTag);
                n.parentNode.insertBefore(txt,n);
                n.parentNode.removeChild(n);
            }
        })

    });

    /**
     * 插入分页符
     * @command pagebreak
     * @method execCommand
     * @param { String } cmd 命令字符串
     * @remind 在表格中插入分页符会把表格切分成两部分
     * @remind 获取编辑器内的数据时， 编辑器会把分页符转换成“_ueditor_page_break_tag_”字符串，
     *          以便于提交数据到服务器端后处理分页。
     * @example
     * ```javascript
     * editor.execCommand( 'pagebreak'); //插入一个hr标签，带有样式类名pagebreak
     * ```
     */

    me.commands['pagebreak'] = {
        execCommand:function () {
            var range = me.selection.getRange(),hr = me.document.createElement('hr');
            domUtils.setAttributes(hr,{
                'class' : 'pagebreak',
                noshade:"noshade",
                size:"5"
            });
            domUtils.unSelectable(hr);
            //table单独处理
            var node = domUtils.findParentByTagName(range.startContainer, notBreakTags, true),

                parents = [], pN;
            if (node) {
                switch (node.tagName) {
                    case 'TD':
                        pN = node.parentNode;
                        if (!pN.previousSibling) {
                            var table = domUtils.findParentByTagName(pN, 'table');
//                            var tableWrapDiv = table.parentNode;
//                            if(tableWrapDiv && tableWrapDiv.nodeType == 1
//                                && tableWrapDiv.tagName == 'DIV'
//                                && tableWrapDiv.getAttribute('dropdrag')
//                                ){
//                                domUtils.remove(tableWrapDiv,true);
//                            }
                            table.parentNode.insertBefore(hr, table);
                            parents = domUtils.findParents(hr, true);

                        } else {
                            pN.parentNode.insertBefore(hr, pN);
                            parents = domUtils.findParents(hr);

                        }
                        pN = parents[1];
                        if (hr !== pN) {
                            domUtils.breakParent(hr, pN);

                        }
                        //table要重写绑定一下拖拽
                        me.fireEvent('afteradjusttable',me.document);
                }

            } else {

                if (!range.collapsed) {
                    range.deleteContents();
                    var start = range.startContainer;
                    while ( !domUtils.isBody(start) && domUtils.isBlockElm(start) && domUtils.isEmptyNode(start)) {
                        range.setStartBefore(start).collapse(true);
                        domUtils.remove(start);
                        start = range.startContainer;
                    }

                }
                range.insertNode(hr);

                var pN = hr.parentNode, nextNode;
                while (!domUtils.isBody(pN)) {
                    domUtils.breakParent(hr, pN);
                    nextNode = hr.nextSibling;
                    if (nextNode && domUtils.isEmptyBlock(nextNode)) {
                        domUtils.remove(nextNode);
                    }
                    pN = hr.parentNode;
                }
                nextNode = hr.nextSibling;
                var pre = hr.previousSibling;
                if(isHr(pre)){
                    domUtils.remove(pre);
                }else{
                    pre && fillNode(pre);
                }

                if(!nextNode){
                    var p = me.document.createElement('p');

                    hr.parentNode.appendChild(p);
                    domUtils.fillNode(me.document,p);
                    range.setStart(p,0).collapse(true);
                }else{
                    if(isHr(nextNode)){
                        domUtils.remove(nextNode);
                    }else{
                        fillNode(nextNode);
                    }
                    range.setEndAfter(hr).collapse(false);
                }

                range.select(true);

            }

        }
    };
};

// plugins/wordimage.js
///import core
///commands 本地图片引导上传
///commandsName  WordImage
///commandsTitle  本地图片引导上传
///commandsDialog  dialogs\wordimage

UE.plugin.register('wordimage',function(){
    var me = this,
        images = [];
    return {
        commands : {
            'wordimage':{
                execCommand:function () {
                    var images = domUtils.getElementsByTagName(me.body, "img");
                    var urlList = [];
                    for (var i = 0, ci; ci = images[i++];) {
                        var url = ci.getAttribute("word_img");
                        url && urlList.push(url);
                    }
                    return urlList;
                },
                queryCommandState:function () {
                    images = domUtils.getElementsByTagName(me.body, "img");
                    for (var i = 0, ci; ci = images[i++];) {
                        if (ci.getAttribute("word_img")) {
                            return 1;
                        }
                    }
                    return -1;
                },
                notNeedUndo:true
            }
        },
        inputRule : function (root) {
            utils.each(root.getNodesByTagName('img'), function (img) {
                var attrs = img.attrs,
                    flag = parseInt(attrs.width) < 128 || parseInt(attrs.height) < 43,
                    opt = me.options,
                    src = opt.UEDITOR_HOME_URL + 'themes/default/images/spacer.gif';
                if (attrs['src'] && /^(?:(file:\/+))/.test(attrs['src'])) {
                    img.setAttr({
                        width:attrs.width,
                        height:attrs.height,
                        alt:attrs.alt,
                        word_img: attrs.src,
                        src:src,
                        'style':'background:url(' + ( flag ? opt.themePath + opt.theme + '/images/word.gif' : opt.langPath + opt.lang + '/images/localimage.png') + ') no-repeat center center;border:1px solid #ddd'
                    })
                }
            })
        }
    }
});

// plugins/dragdrop.js
UE.plugins['dragdrop'] = function (){

    var me = this;
    me.ready(function(){
        domUtils.on(this.body,'dragend',function(){
            var rng = me.selection.getRange();
            var node = rng.getClosedNode()||me.selection.getStart();

            if(node && node.tagName == 'IMG'){

                var pre = node.previousSibling,next;
                while(next = node.nextSibling){
                    if(next.nodeType == 1 && next.tagName == 'SPAN' && !next.firstChild){
                        domUtils.remove(next)
                    }else{
                        break;
                    }
                }


                if((pre && pre.nodeType == 1 && !domUtils.isEmptyBlock(pre) || !pre) && (!next || next && !domUtils.isEmptyBlock(next))){
                    if(pre && pre.tagName == 'P' && !domUtils.isEmptyBlock(pre)){
                        pre.appendChild(node);
                        domUtils.moveChild(next,pre);
                        domUtils.remove(next);
                    }else  if(next && next.tagName == 'P' && !domUtils.isEmptyBlock(next)){
                        next.insertBefore(node,next.firstChild);
                    }

                    if(pre && pre.tagName == 'P' && domUtils.isEmptyBlock(pre)){
                        domUtils.remove(pre)
                    }
                    if(next && next.tagName == 'P' && domUtils.isEmptyBlock(next)){
                        domUtils.remove(next)
                    }
                    rng.selectNode(node).select();
                    me.fireEvent('saveScene');

                }

            }

        })
    });
    me.addListener('keyup', function(type, evt) {
        var keyCode = evt.keyCode || evt.which;
        if (keyCode == 13) {
            var rng = me.selection.getRange(),node;
            if(node = domUtils.findParentByTagName(rng.startContainer,'p',true)){
                if(domUtils.getComputedStyle(node,'text-align') == 'center'){
                    domUtils.removeStyle(node,'text-align')
                }
            }
        }
    })
};


// plugins/undo.js
/**
 * undo redo
 * @file
 * @since 1.2.6.1
 */

/**
 * 撤销上一次执行的命令
 * @command undo
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'undo' );
 * ```
 */

/**
 * 重做上一次执行的命令
 * @command redo
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'redo' );
 * ```
 */

UE.plugins['undo'] = function () {
    var saveSceneTimer;
    var me = this,
        maxUndoCount = me.options.maxUndoCount || 20,
        maxInputCount = me.options.maxInputCount || 20,
        fillchar = new RegExp(domUtils.fillChar + '|<\/hr>', 'gi');// ie会产生多余的</hr>
    var noNeedFillCharTags = {
        ol:1,ul:1,table:1,tbody:1,tr:1,body:1
    };
    var orgState = me.options.autoClearEmptyNode;
    function compareAddr(indexA, indexB) {
        if (indexA.length != indexB.length)
            return 0;
        for (var i = 0, l = indexA.length; i < l; i++) {
            if (indexA[i] != indexB[i])
                return 0
        }
        return 1;
    }

    function compareRangeAddress(rngAddrA, rngAddrB) {
        if (rngAddrA.collapsed != rngAddrB.collapsed) {
            return 0;
        }
        if (!compareAddr(rngAddrA.startAddress, rngAddrB.startAddress) || !compareAddr(rngAddrA.endAddress, rngAddrB.endAddress)) {
            return 0;
        }
        return 1;
    }

    function UndoManager() {
        this.list = [];
        this.index = 0;
        this.hasUndo = false;
        this.hasRedo = false;
        this.undo = function () {
            if (this.hasUndo) {
                if (!this.list[this.index - 1] && this.list.length == 1) {
                    this.reset();
                    return;
                }
                while (this.list[this.index].content == this.list[this.index - 1].content) {
                    this.index--;
                    if (this.index == 0) {
                        return this.restore(0);
                    }
                }
                this.restore(--this.index);
            }
        };
        this.redo = function () {
            if (this.hasRedo) {
                while (this.list[this.index].content == this.list[this.index + 1].content) {
                    this.index++;
                    if (this.index == this.list.length - 1) {
                        return this.restore(this.index);
                    }
                }
                this.restore(++this.index);
            }
        };

        this.restore = function () {
            var me = this.editor;
            var scene = this.list[this.index];
            var root = UE.htmlparser(scene.content.replace(fillchar, ''));
            me.options.autoClearEmptyNode = false;
            me.filterInputRule(root);
            me.options.autoClearEmptyNode = orgState;
            //trace:873
            //去掉展位符
            me.document.body.innerHTML = root.toHtml();
            me.fireEvent('afterscencerestore');
            //处理undo后空格不展位的问题
            if (browser.ie) {
                utils.each(domUtils.getElementsByTagName(me.document,'td th caption p'),function(node){
                    if(domUtils.isEmptyNode(node)){
                        domUtils.fillNode(me.document, node);
                    }
                })
            }

            try{
                var rng = new dom.Range(me.document).moveToAddress(scene.address);
                rng.select(noNeedFillCharTags[rng.startContainer.nodeName.toLowerCase()]);
            }catch(e){}

            this.update();
            this.clearKey();
            //不能把自己reset了
            me.fireEvent('reset', true);
        };

        this.getScene = function () {
            var me = this.editor;
            var rng = me.selection.getRange(),
                rngAddress = rng.createAddress(false,true);
            me.fireEvent('beforegetscene');
            var root = UE.htmlparser(me.body.innerHTML);
            me.options.autoClearEmptyNode = false;
            me.filterOutputRule(root);
            me.options.autoClearEmptyNode = orgState;
            var cont = root.toHtml();
            //trace:3461
            //这个会引起回退时导致空格丢失的情况
//            browser.ie && (cont = cont.replace(/>&nbsp;</g, '><').replace(/\s*</g, '<').replace(/>\s*/g, '>'));
            me.fireEvent('aftergetscene');

            return {
                address:rngAddress,
                content:cont
            }
        };
        this.save = function (notCompareRange,notSetCursor) {
            clearTimeout(saveSceneTimer);
            var currentScene = this.getScene(notSetCursor),
                lastScene = this.list[this.index];

            if(lastScene && lastScene.content != currentScene.content){
                me.trigger('contentchange')
            }
            //内容相同位置相同不存
            if (lastScene && lastScene.content == currentScene.content &&
                ( notCompareRange ? 1 : compareRangeAddress(lastScene.address, currentScene.address) )
                ) {
                return;
            }
            this.list = this.list.slice(0, this.index + 1);
            this.list.push(currentScene);
            //如果大于最大数量了，就把最前的剔除
            if (this.list.length > maxUndoCount) {
                this.list.shift();
            }
            this.index = this.list.length - 1;
            this.clearKey();
            //跟新undo/redo状态
            this.update();

        };
        this.update = function () {
            this.hasRedo = !!this.list[this.index + 1];
            this.hasUndo = !!this.list[this.index - 1];
        };
        this.reset = function () {
            this.list = [];
            this.index = 0;
            this.hasUndo = false;
            this.hasRedo = false;
            this.clearKey();
        };
        this.clearKey = function () {
            keycont = 0;
            lastKeyCode = null;
        };
    }

    me.undoManger = new UndoManager();
    me.undoManger.editor = me;
    function saveScene() {
        this.undoManger.save();
    }

    me.addListener('saveScene', function () {
        var args = Array.prototype.splice.call(arguments,1);
        this.undoManger.save.apply(this.undoManger,args);
    });

//    me.addListener('beforeexeccommand', saveScene);
//    me.addListener('afterexeccommand', saveScene);

    me.addListener('reset', function (type, exclude) {
        if (!exclude) {
            this.undoManger.reset();
        }
    });
    me.commands['redo'] = me.commands['undo'] = {
        execCommand:function (cmdName) {
            this.undoManger[cmdName]();
        },
        queryCommandState:function (cmdName) {
            return this.undoManger['has' + (cmdName.toLowerCase() == 'undo' ? 'Undo' : 'Redo')] ? 0 : -1;
        },
        notNeedUndo:1
    };

    var keys = {
            //  /*Backspace*/ 8:1, /*Delete*/ 46:1,
            /*Shift*/ 16:1, /*Ctrl*/ 17:1, /*Alt*/ 18:1,
            37:1, 38:1, 39:1, 40:1

        },
        keycont = 0,
        lastKeyCode;
    //输入法状态下不计算字符数
    var inputType = false;
    me.addListener('ready', function () {
        domUtils.on(this.body, 'compositionstart', function () {
            inputType = true;
        });
        domUtils.on(this.body, 'compositionend', function () {
            inputType = false;
        })
    });
    //快捷键
    me.addshortcutkey({
        "Undo":"ctrl+90", //undo
        "Redo":"ctrl+89" //redo

    });
    var isCollapsed = true;
    me.addListener('keydown', function (type, evt) {

        var me = this;
        var keyCode = evt.keyCode || evt.which;
        if (!keys[keyCode] && !evt.ctrlKey && !evt.metaKey && !evt.shiftKey && !evt.altKey) {
            if (inputType)
                return;

            if(!me.selection.getRange().collapsed){
                me.undoManger.save(false,true);
                isCollapsed = false;
                return;
            }
            if (me.undoManger.list.length == 0) {
                me.undoManger.save(true);
            }
            clearTimeout(saveSceneTimer);
            function save(cont){
                cont.undoManger.save(false,true);
                cont.fireEvent('selectionchange');
            }
            saveSceneTimer = setTimeout(function(){
                if(inputType){
                    var interalTimer = setInterval(function(){
                        if(!inputType){
                            save(me);
                            clearInterval(interalTimer)
                        }
                    },300)
                    return;
                }
                save(me);
            },200);

            lastKeyCode = keyCode;
            keycont++;
            if (keycont >= maxInputCount ) {
                save(me)
            }
        }
    });
    me.addListener('keyup', function (type, evt) {
        var keyCode = evt.keyCode || evt.which;
        if (!keys[keyCode] && !evt.ctrlKey && !evt.metaKey && !evt.shiftKey && !evt.altKey) {
            if (inputType)
                return;
            if(!isCollapsed){
                this.undoManger.save(false,true);
                isCollapsed = true;
            }
        }
    });
    //扩展实例，添加关闭和开启命令undo
    me.stopCmdUndo = function(){
        me.__hasEnterExecCommand = true;
    };
    me.startCmdUndo = function(){
        me.__hasEnterExecCommand = false;
    }
};


// plugins/copy.js
UE.plugin.register('copy', function () {

    var me = this;

    function initZeroClipboard() {

        ZeroClipboard.config({
            debug: false,
            swfPath: me.options.UEDITOR_HOME_URL + 'third-party/zeroclipboard/ZeroClipboard.swf'
        });

        var client = me.zeroclipboard = new ZeroClipboard();

        // 复制内容
        client.on('copy', function (e) {
            var client = e.client,
                rng = me.selection.getRange(),
                div = document.createElement('div');

            div.appendChild(rng.cloneContents());
            client.setText(div.innerText || div.textContent);
            client.setHtml(div.innerHTML);
            rng.select();
        });
        // hover事件传递到target
        client.on('mouseover mouseout', function (e) {
            var target = e.target;
            if (e.type == 'mouseover') {
                domUtils.addClass(target, 'edui-state-hover');
            } else if (e.type == 'mouseout') {
                domUtils.removeClasses(target, 'edui-state-hover');
            }
        });
        // flash加载不成功
        client.on('wrongflash noflash', function () {
            ZeroClipboard.destroy();
        });
    }

    return {
        bindEvents: {
            'ready': function () {
                if (!browser.ie) {
                    if (window.ZeroClipboard) {
                        initZeroClipboard();
                    } else {
                        utils.loadFile(document, {
                            src: me.options.UEDITOR_HOME_URL + "third-party/zeroclipboard/ZeroClipboard.js",
                            tag: "script",
                            type: "text/javascript",
                            defer: "defer"
                        }, function () {
                            initZeroClipboard();
                        });
                    }
                }
            }
        },
        commands: {
            'copy': {
                execCommand: function (cmd) {
                    if (!me.document.execCommand('copy')) {
                        alert(me.getLang('copymsg'));
                    }
                }
            }
        }
    }
});


// plugins/paste.js
///import core
///import plugins/inserthtml.js
///import plugins/undo.js
///import plugins/serialize.js
///commands 粘贴
///commandsName  PastePlain
///commandsTitle  纯文本粘贴模式
/**
 * @description 粘贴
 * @author zhanyi
 */
UE.plugins['paste'] = function () {
    function getClipboardData(callback) {
        var doc = this.document;
        if (doc.getElementById('baidu_pastebin')) {
            return;
        }
        var range = this.selection.getRange(),
            bk = range.createBookmark(),
        //创建剪贴的容器div
            pastebin = doc.createElement('div');
        pastebin.id = 'baidu_pastebin';
        // Safari 要求div必须有内容，才能粘贴内容进来
        browser.webkit && pastebin.appendChild(doc.createTextNode(domUtils.fillChar + domUtils.fillChar));
        doc.body.appendChild(pastebin);
        //trace:717 隐藏的span不能得到top
        //bk.start.innerHTML = '&nbsp;';
        bk.start.style.display = '';
        pastebin.style.cssText = "position:absolute;width:1px;height:1px;overflow:hidden;left:-1000px;white-space:nowrap;top:" +
            //要在现在光标平行的位置加入，否则会出现跳动的问题
            domUtils.getXY(bk.start).y + 'px';

        range.selectNodeContents(pastebin).select(true);

        setTimeout(function () {
            if (browser.webkit) {
                for (var i = 0, pastebins = doc.querySelectorAll('#baidu_pastebin'), pi; pi = pastebins[i++];) {
                    if (domUtils.isEmptyNode(pi)) {
                        domUtils.remove(pi);
                    } else {
                        pastebin = pi;
                        break;
                    }
                }
            }
            try {
                pastebin.parentNode.removeChild(pastebin);
            } catch (e) {
            }
            range.moveToBookmark(bk).select(true);
            callback(pastebin);
        }, 0);
    }

    var me = this;

    me.setOpt({
        retainOnlyLabelPasted : false
    });

    var txtContent, htmlContent, address;

    function getPureHtml(html){
        return html.replace(/<(\/?)([\w\-]+)([^>]*)>/gi, function (a, b, tagName, attrs) {
            tagName = tagName.toLowerCase();
            if ({img: 1}[tagName]) {
                return a;
            }
            attrs = attrs.replace(/([\w\-]*?)\s*=\s*(("([^"]*)")|('([^']*)')|([^\s>]+))/gi, function (str, atr, val) {
                if ({
                    'src': 1,
                    'href': 1,
                    'name': 1
                }[atr.toLowerCase()]) {
                    return atr + '=' + val + ' '
                }
                return ''
            });
            if ({
                'span': 1,
                'div': 1
            }[tagName]) {
                return ''
            } else {

                return '<' + b + tagName + ' ' + utils.trim(attrs) + '>'
            }

        });
    }
    function filter(div) {
        var html;
        if (div.firstChild) {
            //去掉cut中添加的边界值
            var nodes = domUtils.getElementsByTagName(div, 'span');
            for (var i = 0, ni; ni = nodes[i++];) {
                if (ni.id == '_baidu_cut_start' || ni.id == '_baidu_cut_end') {
                    domUtils.remove(ni);
                }
            }

            if (browser.webkit) {

                var brs = div.querySelectorAll('div br');
                for (var i = 0, bi; bi = brs[i++];) {
                    var pN = bi.parentNode;
                    if (pN.tagName == 'DIV' && pN.childNodes.length == 1) {
                        pN.innerHTML = '<p><br/></p>';
                        domUtils.remove(pN);
                    }
                }
                var divs = div.querySelectorAll('#baidu_pastebin');
                for (var i = 0, di; di = divs[i++];) {
                    var tmpP = me.document.createElement('p');
                    di.parentNode.insertBefore(tmpP, di);
                    while (di.firstChild) {
                        tmpP.appendChild(di.firstChild);
                    }
                    domUtils.remove(di);
                }

                var metas = div.querySelectorAll('meta');
                for (var i = 0, ci; ci = metas[i++];) {
                    domUtils.remove(ci);
                }

                var brs = div.querySelectorAll('br');
                for (i = 0; ci = brs[i++];) {
                    if (/^apple-/i.test(ci.className)) {
                        domUtils.remove(ci);
                    }
                }
            }
            if (browser.gecko) {
                var dirtyNodes = div.querySelectorAll('[_moz_dirty]');
                for (i = 0; ci = dirtyNodes[i++];) {
                    ci.removeAttribute('_moz_dirty');
                }
            }
            if (!browser.ie) {
                var spans = div.querySelectorAll('span.Apple-style-span');
                for (var i = 0, ci; ci = spans[i++];) {
                    domUtils.remove(ci, true);
                }
            }

            //ie下使用innerHTML会产生多余的\r\n字符，也会产生&nbsp;这里过滤掉
            html = div.innerHTML;//.replace(/>(?:(\s|&nbsp;)*?)</g,'><');

            //过滤word粘贴过来的冗余属性
            html = UE.filterWord(html);
            //取消了忽略空白的第二个参数，粘贴过来的有些是有空白的，会被套上相关的标签
            var root = UE.htmlparser(html);
            //如果给了过滤规则就先进行过滤
            if (me.options.filterRules) {
                UE.filterNode(root, me.options.filterRules);
            }
            //执行默认的处理
            me.filterInputRule(root);
            //针对chrome的处理
            if (browser.webkit) {
                var br = root.lastChild();
                if (br && br.type == 'element' && br.tagName == 'br') {
                    root.removeChild(br)
                }
                utils.each(me.body.querySelectorAll('div'), function (node) {
                    if (domUtils.isEmptyBlock(node)) {
                        domUtils.remove(node,true)
                    }
                })
            }
            html = {'html': root.toHtml()};
            me.fireEvent('beforepaste', html, root);
            //抢了默认的粘贴，那后边的内容就不执行了，比如表格粘贴
            if(!html.html){
                return;
            }
            root = UE.htmlparser(html.html,true);
            //如果开启了纯文本模式
            if (me.queryCommandState('pasteplain') === 1) {
                me.execCommand('insertHtml', UE.filterNode(root, me.options.filterTxtRules).toHtml(), true);
            } else {
                //文本模式
                UE.filterNode(root, me.options.filterTxtRules);
                txtContent = root.toHtml();
                //完全模式
                htmlContent = html.html;

                address = me.selection.getRange().createAddress(true);
                me.execCommand('insertHtml', me.getOpt('retainOnlyLabelPasted') === true ?  getPureHtml(htmlContent) : htmlContent, true);
            }
            me.fireEvent("afterpaste", html);
        }
    }

    me.addListener('pasteTransfer', function (cmd, plainType) {

        if (address && txtContent && htmlContent && txtContent != htmlContent) {
            var range = me.selection.getRange();
            range.moveToAddress(address, true);

            if (!range.collapsed) {

                while (!domUtils.isBody(range.startContainer)
                    ) {
                    var start = range.startContainer;
                    if(start.nodeType == 1){
                        start = start.childNodes[range.startOffset];
                        if(!start){
                            range.setStartBefore(range.startContainer);
                            continue;
                        }
                        var pre = start.previousSibling;

                        if(pre && pre.nodeType == 3 && new RegExp('^[\n\r\t '+domUtils.fillChar+']*$').test(pre.nodeValue)){
                            range.setStartBefore(pre)
                        }
                    }
                    if(range.startOffset == 0){
                        range.setStartBefore(range.startContainer);
                    }else{
                        break;
                    }

                }
                while (!domUtils.isBody(range.endContainer)
                    ) {
                    var end = range.endContainer;
                    if(end.nodeType == 1){
                        end = end.childNodes[range.endOffset];
                        if(!end){
                            range.setEndAfter(range.endContainer);
                            continue;
                        }
                        var next = end.nextSibling;
                        if(next && next.nodeType == 3 && new RegExp('^[\n\r\t'+domUtils.fillChar+']*$').test(next.nodeValue)){
                            range.setEndAfter(next)
                        }
                    }
                    if(range.endOffset == range.endContainer[range.endContainer.nodeType == 3 ? 'nodeValue' : 'childNodes'].length){
                        range.setEndAfter(range.endContainer);
                    }else{
                        break;
                    }

                }

            }

            range.deleteContents();
            range.select(true);
            me.__hasEnterExecCommand = true;
            var html = htmlContent;
            if (plainType === 2 ) {
                html = getPureHtml(html);
            } else if (plainType) {
                html = txtContent;
            }
            me.execCommand('inserthtml', html, true);
            me.__hasEnterExecCommand = false;
            var rng = me.selection.getRange();
            while (!domUtils.isBody(rng.startContainer) && !rng.startOffset &&
                rng.startContainer[rng.startContainer.nodeType == 3 ? 'nodeValue' : 'childNodes'].length
                ) {
                rng.setStartBefore(rng.startContainer);
            }
            var tmpAddress = rng.createAddress(true);
            address.endAddress = tmpAddress.startAddress;
        }
    });

    me.addListener('ready', function () {
        domUtils.on(me.body, 'cut', function () {
            var range = me.selection.getRange();
            if (!range.collapsed && me.undoManger) {
                me.undoManger.save();
            }
        });

        //ie下beforepaste在点击右键时也会触发，所以用监控键盘才处理
        domUtils.on(me.body, browser.ie || browser.opera ? 'keydown' : 'paste', function (e) {
            if ((browser.ie || browser.opera) && ((!e.ctrlKey && !e.metaKey) || e.keyCode != '86')) {
                return;
            }
            getClipboardData.call(me, function (div) {
                filter(div);
            });
        });

    });

    me.commands['paste'] = {
        execCommand: function (cmd) {
            if (browser.ie) {
                getClipboardData.call(me, function (div) {
                    filter(div);
                });
                me.document.execCommand('paste');
            } else {
                alert(me.getLang('pastemsg'));
            }
        }
    }
};



// plugins/puretxtpaste.js
/**
 * 纯文本粘贴插件
 * @file
 * @since 1.2.6.1
 */

UE.plugins['pasteplain'] = function(){
    var me = this;
    me.setOpt({
        'pasteplain':false,
        'filterTxtRules' : function(){
            function transP(node){
                node.tagName = 'p';
                node.setStyle();
            }
            function removeNode(node){
                node.parentNode.removeChild(node,true)
            }
            return {
                //直接删除及其字节点内容
                '-' : 'script style object iframe embed input select',
                'p': {$:{}},
                'br':{$:{}},
                div: function (node) {
                    var tmpNode, p = UE.uNode.createElement('p');
                    while (tmpNode = node.firstChild()) {
                        if (tmpNode.type == 'text' || !UE.dom.dtd.$block[tmpNode.tagName]) {
                            p.appendChild(tmpNode);
                        } else {
                            if (p.firstChild()) {
                                node.parentNode.insertBefore(p, node);
                                p = UE.uNode.createElement('p');
                            } else {
                                node.parentNode.insertBefore(tmpNode, node);
                            }
                        }
                    }
                    if (p.firstChild()) {
                        node.parentNode.insertBefore(p, node);
                    }
                    node.parentNode.removeChild(node);
                },
                ol: removeNode,
                ul: removeNode,
                dl:removeNode,
                dt:removeNode,
                dd:removeNode,
                'li':removeNode,
                'caption':transP,
                'th':transP,
                'tr':transP,
                'h1':transP,'h2':transP,'h3':transP,'h4':transP,'h5':transP,'h6':transP,
                'td':function(node){
                        //没有内容的td直接删掉
                        var txt = !!node.innerText();
                        if(txt){
                         node.parentNode.insertAfter(UE.uNode.createText(' &nbsp; &nbsp;'),node);
                    }
                    node.parentNode.removeChild(node,node.innerText())
                }
            }
        }()
    });
    //暂时这里支持一下老版本的属性
    var pasteplain = me.options.pasteplain;

    /**
     * 启用或取消纯文本粘贴模式
     * @command pasteplain
     * @method execCommand
     * @param { String } cmd 命令字符串
     * @example
     * ```javascript
     * editor.queryCommandState( 'pasteplain' );
     * ```
     */

    /**
     * 查询当前是否处于纯文本粘贴模式
     * @command pasteplain
     * @method queryCommandState
     * @param { String } cmd 命令字符串
     * @return { int } 如果处于纯文本模式，返回1，否则，返回0
     * @example
     * ```javascript
     * editor.queryCommandState( 'pasteplain' );
     * ```
     */
    me.commands['pasteplain'] = {
        queryCommandState: function (){
            return pasteplain ? 1 : 0;
        },
        execCommand: function (){
            pasteplain = !pasteplain|0;
        },
        notNeedUndo : 1
    };
};

// plugins/list.js
/**
 * 有序列表,无序列表插件
 * @file
 * @since 1.2.6.1
 */

UE.plugins['list'] = function () {
    var me = this,
        notExchange = {
            'TD':1,
            'PRE':1,
            'BLOCKQUOTE':1
        };
    var customStyle = {
        'cn' : 'cn-1-',
        'cn1' : 'cn-2-',
        'cn2' : 'cn-3-',
        'num':  'num-1-',
        'num1' : 'num-2-',
        'num2' : 'num-3-',
        'dash'  : 'dash',
        'dot':'dot'
    };

    me.setOpt( {
        'autoTransWordToList':false,
        'insertorderedlist':{
            'num':'',
            'num1':'',
            'num2':'',
            'cn':'',
            'cn1':'',
            'cn2':'',
            'decimal':'',
            'lower-alpha':'',
            'lower-roman':'',
            'upper-alpha':'',
            'upper-roman':''
        },
        'insertunorderedlist':{
            'circle':'',
            'disc':'',
            'square':'',
            'dash' : '',
            'dot':''
        },
        listDefaultPaddingLeft : '30',
        listiconpath : 'http://bs.baidu.com/listicon/',
        maxListLevel : -1,//-1不限制
        disablePInList:false
    } );
    function listToArray(list){
        var arr = [];
        for(var p in list){
            arr.push(p)
        }
        return arr;
    }
    var listStyle = {
        'OL':listToArray(me.options.insertorderedlist),
        'UL':listToArray(me.options.insertunorderedlist)
    };
    var liiconpath = me.options.listiconpath;

    //根据用户配置，调整customStyle
    for(var s in customStyle){
        if(!me.options.insertorderedlist.hasOwnProperty(s) && !me.options.insertunorderedlist.hasOwnProperty(s)){
            delete customStyle[s];
        }
    }

    me.ready(function () {
        var customCss = [];
        for(var p in customStyle){
            if(p == 'dash' || p == 'dot'){
                customCss.push('li.list-' + customStyle[p] + '{background-image:url(' + liiconpath +customStyle[p]+'.gif)}');
                customCss.push('ul.custom_'+p+'{list-style:none;}ul.custom_'+p+' li{background-position:0 3px;background-repeat:no-repeat}');
            }else{
                for(var i= 0;i<99;i++){
                    customCss.push('li.list-' + customStyle[p] + i + '{background-image:url(' + liiconpath + 'list-'+customStyle[p] + i + '.gif)}')
                }
                customCss.push('ol.custom_'+p+'{list-style:none;}ol.custom_'+p+' li{background-position:0 3px;background-repeat:no-repeat}');
            }
            switch(p){
                case 'cn':
                    customCss.push('li.list-'+p+'-paddingleft-1{padding-left:25px}');
                    customCss.push('li.list-'+p+'-paddingleft-2{padding-left:40px}');
                    customCss.push('li.list-'+p+'-paddingleft-3{padding-left:55px}');
                    break;
                case 'cn1':
                    customCss.push('li.list-'+p+'-paddingleft-1{padding-left:30px}');
                    customCss.push('li.list-'+p+'-paddingleft-2{padding-left:40px}');
                    customCss.push('li.list-'+p+'-paddingleft-3{padding-left:55px}');
                    break;
                case 'cn2':
                    customCss.push('li.list-'+p+'-paddingleft-1{padding-left:40px}');
                    customCss.push('li.list-'+p+'-paddingleft-2{padding-left:55px}');
                    customCss.push('li.list-'+p+'-paddingleft-3{padding-left:68px}');
                    break;
                case 'num':
                case 'num1':
                    customCss.push('li.list-'+p+'-paddingleft-1{padding-left:25px}');
                    break;
                case 'num2':
                    customCss.push('li.list-'+p+'-paddingleft-1{padding-left:35px}');
                    customCss.push('li.list-'+p+'-paddingleft-2{padding-left:40px}');
                    break;
                case 'dash':
                    customCss.push('li.list-'+p+'-paddingleft{padding-left:35px}');
                    break;
                case 'dot':
                    customCss.push('li.list-'+p+'-paddingleft{padding-left:20px}');
            }
        }
        customCss.push('.list-paddingleft-1{padding-left:0}');
        customCss.push('.list-paddingleft-2{padding-left:'+me.options.listDefaultPaddingLeft+'px}');
        customCss.push('.list-paddingleft-3{padding-left:'+me.options.listDefaultPaddingLeft*2+'px}');
        //如果不给宽度会在自定应样式里出现滚动条
        utils.cssRule('list', 'ol,ul{margin:0;pading:0;'+(browser.ie ? '' : 'width:95%')+'}li{clear:both;}'+customCss.join('\n'), me.document);
    });
    //单独处理剪切的问题
    me.ready(function(){
        domUtils.on(me.body,'cut',function(){
            setTimeout(function(){
                var rng = me.selection.getRange(),li;
                //trace:3416
                if(!rng.collapsed){
                    if(li = domUtils.findParentByTagName(rng.startContainer,'li',true)){
                        if(!li.nextSibling && domUtils.isEmptyBlock(li)){
                            var pn = li.parentNode,node;
                            if(node = pn.previousSibling){
                                domUtils.remove(pn);
                                rng.setStartAtLast(node).collapse(true);
                                rng.select(true);
                            }else if(node = pn.nextSibling){
                                domUtils.remove(pn);
                                rng.setStartAtFirst(node).collapse(true);
                                rng.select(true);
                            }else{
                                var tmpNode = me.document.createElement('p');
                                domUtils.fillNode(me.document,tmpNode);
                                pn.parentNode.insertBefore(tmpNode,pn);
                                domUtils.remove(pn);
                                rng.setStart(tmpNode,0).collapse(true);
                                rng.select(true);
                            }
                        }
                    }
                }

            })
        })
    });

    function getStyle(node){
        var cls = node.className;
        if(domUtils.hasClass(node,/custom_/)){
            return cls.match(/custom_(\w+)/)[1]
        }
        return domUtils.getStyle(node, 'list-style-type')

    }

    me.addListener('beforepaste',function(type,html){
        var me = this,
            rng = me.selection.getRange(),li;
        var root = UE.htmlparser(html.html,true);
        if(li = domUtils.findParentByTagName(rng.startContainer,'li',true)){
            var list = li.parentNode,tagName = list.tagName == 'OL' ? 'ul':'ol';
            utils.each(root.getNodesByTagName(tagName),function(n){
                n.tagName = list.tagName;
                n.setAttr();
                if(n.parentNode === root){
                    type = getStyle(list) || (list.tagName == 'OL' ? 'decimal' : 'disc')
                }else{
                    var className = n.parentNode.getAttr('class');
                    if(className && /custom_/.test(className)){
                        type = className.match(/custom_(\w+)/)[1]
                    }else{
                        type = n.parentNode.getStyle('list-style-type');
                    }
                    if(!type){
                        type = list.tagName == 'OL' ? 'decimal' : 'disc';
                    }
                }
                var index = utils.indexOf(listStyle[list.tagName], type);
                if(n.parentNode !== root)
                    index = index + 1 == listStyle[list.tagName].length ? 0 : index + 1;
                var currentStyle = listStyle[list.tagName][index];
                if(customStyle[currentStyle]){
                    n.setAttr('class', 'custom_' + currentStyle)

                }else{
                    n.setStyle('list-style-type',currentStyle)
                }
            })

        }

        html.html = root.toHtml();
    });
    //导出时，去掉p标签
    me.getOpt('disablePInList') === true && me.addOutputRule(function(root){
        utils.each(root.getNodesByTagName('li'),function(li){
            var newChildrens = [],index=0;
            utils.each(li.children,function(n){
                if(n.tagName == 'p'){
                    var tmpNode;
                    while(tmpNode = n.children.pop()) {
                        newChildrens.splice(index,0,tmpNode);
                        tmpNode.parentNode = li;
                        lastNode = tmpNode;
                    }
                    tmpNode = newChildrens[newChildrens.length-1];
                    if(!tmpNode || tmpNode.type != 'element' || tmpNode.tagName != 'br'){
                        var br = UE.uNode.createElement('br');
                        br.parentNode = li;
                        newChildrens.push(br);
                    }

                    index = newChildrens.length;
                }
            });
            if(newChildrens.length){
                li.children = newChildrens;
            }
        });
    });
    //进入编辑器的li要套p标签
    me.addInputRule(function(root){
        utils.each(root.getNodesByTagName('li'),function(li){
            var tmpP = UE.uNode.createElement('p');
            for(var i= 0,ci;ci=li.children[i];){
                if(ci.type == 'text' || dtd.p[ci.tagName]){
                    tmpP.appendChild(ci);
                }else{
                    if(tmpP.firstChild()){
                        li.insertBefore(tmpP,ci);
                        tmpP = UE.uNode.createElement('p');
                        i = i + 2;
                    }else{
                        i++;
                    }

                }
            }
            if(tmpP.firstChild() && !tmpP.parentNode || !li.firstChild()){
                li.appendChild(tmpP);
            }
            //trace:3357
            //p不能为空
            if (!tmpP.firstChild()) {
                tmpP.innerHTML(browser.ie ? '&nbsp;' : '<br/>')
            }
            //去掉末尾的空白
            var p = li.firstChild();
            var lastChild = p.lastChild();
            if(lastChild && lastChild.type == 'text' && /^\s*$/.test(lastChild.data)){
                p.removeChild(lastChild)
            }
        });
        if(me.options.autoTransWordToList){
            var orderlisttype = {
                    'num1':/^\d+\)/,
                    'decimal':/^\d+\./,
                    'lower-alpha':/^[a-z]+\)/,
                    'upper-alpha':/^[A-Z]+\./,
                    'cn':/^[\u4E00\u4E8C\u4E09\u56DB\u516d\u4e94\u4e03\u516b\u4e5d]+[\u3001]/,
                    'cn2':/^\([\u4E00\u4E8C\u4E09\u56DB\u516d\u4e94\u4e03\u516b\u4e5d]+\)/
                },
                unorderlisttype = {
                    'square':'n'
                };
            function checkListType(content,container){
                var span = container.firstChild();
                if(span &&  span.type == 'element' && span.tagName == 'span' && /Wingdings|Symbol/.test(span.getStyle('font-family'))){
                    for(var p in unorderlisttype){
                        if(unorderlisttype[p] == span.data){
                            return p
                        }
                    }
                    return 'disc'
                }
                for(var p in orderlisttype){
                    if(orderlisttype[p].test(content)){
                        return p;
                    }
                }

            }
            utils.each(root.getNodesByTagName('p'),function(node){
                if(node.getAttr('class') != 'MsoListParagraph'){
                    return
                }

                //word粘贴过来的会带有margin要去掉,但这样也可能会误命中一些央视
                node.setStyle('margin','');
                node.setStyle('margin-left','');
                node.setAttr('class','');

                function appendLi(list,p,type){
                    if(list.tagName == 'ol'){
                        if(browser.ie){
                            var first = p.firstChild();
                            if(first.type =='element' && first.tagName == 'span' && orderlisttype[type].test(first.innerText())){
                                p.removeChild(first);
                            }
                        }else{
                            p.innerHTML(p.innerHTML().replace(orderlisttype[type],''));
                        }
                    }else{
                        p.removeChild(p.firstChild())
                    }

                    var li = UE.uNode.createElement('li');
                    li.appendChild(p);
                    list.appendChild(li);
                }
                var tmp = node,type,cacheNode = node;

                if(node.parentNode.tagName != 'li' && (type = checkListType(node.innerText(),node))){

                    var list = UE.uNode.createElement(me.options.insertorderedlist.hasOwnProperty(type) ? 'ol' : 'ul');
                    if(customStyle[type]){
                        list.setAttr('class','custom_'+type)
                    }else{
                        list.setStyle('list-style-type',type)
                    }
                    while(node && node.parentNode.tagName != 'li' && checkListType(node.innerText(),node)){
                        tmp = node.nextSibling();
                        if(!tmp){
                            node.parentNode.insertBefore(list,node)
                        }
                        appendLi(list,node,type);
                        node = tmp;
                    }
                    if(!list.parentNode && node && node.parentNode){
                        node.parentNode.insertBefore(list,node)
                    }
                }
                var span = cacheNode.firstChild();
                if(span && span.type == 'element' && span.tagName == 'span' && /^\s*(&nbsp;)+\s*$/.test(span.innerText())){
                    span.parentNode.removeChild(span)
                }
            })
        }

    });

    //调整索引标签
    me.addListener('contentchange',function(){
        adjustListStyle(me.document)
    });

    function adjustListStyle(doc,ignore){
        utils.each(domUtils.getElementsByTagName(doc,'ol ul'),function(node){

            if(!domUtils.inDoc(node,doc))
                return;

            var parent = node.parentNode;
            if(parent.tagName == node.tagName){
                var nodeStyleType = getStyle(node) || (node.tagName == 'OL' ? 'decimal' : 'disc'),
                    parentStyleType = getStyle(parent) || (parent.tagName == 'OL' ? 'decimal' : 'disc');
                if(nodeStyleType == parentStyleType){
                    var styleIndex = utils.indexOf(listStyle[node.tagName], nodeStyleType);
                    styleIndex = styleIndex + 1 == listStyle[node.tagName].length ? 0 : styleIndex + 1;
                    setListStyle(node,listStyle[node.tagName][styleIndex])
                }

            }
            var index = 0,type = 2;
            if( domUtils.hasClass(node,/custom_/)){
                if(!(/[ou]l/i.test(parent.tagName) && domUtils.hasClass(parent,/custom_/))){
                    type = 1;
                }
            }else{
                if(/[ou]l/i.test(parent.tagName) && domUtils.hasClass(parent,/custom_/)){
                    type = 3;
                }
            }

            var style = domUtils.getStyle(node, 'list-style-type');
            style && (node.style.cssText = 'list-style-type:' + style);
            node.className = utils.trim(node.className.replace(/list-paddingleft-\w+/,'')) + ' list-paddingleft-' + type;
            utils.each(domUtils.getElementsByTagName(node,'li'),function(li){
                li.style.cssText && (li.style.cssText = '');
                if(!li.firstChild){
                    domUtils.remove(li);
                    return;
                }
                if(li.parentNode !== node){
                    return;
                }
                index++;
                if(domUtils.hasClass(node,/custom_/) ){
                    var paddingLeft = 1,currentStyle = getStyle(node);
                    if(node.tagName == 'OL'){
                        if(currentStyle){
                            switch(currentStyle){
                                case 'cn' :
                                case 'cn1':
                                case 'cn2':
                                    if(index > 10 && (index % 10 == 0 || index > 10 && index < 20)){
                                        paddingLeft = 2
                                    }else if(index > 20){
                                        paddingLeft = 3
                                    }
                                    break;
                                case 'num2' :
                                    if(index > 9){
                                        paddingLeft = 2
                                    }
                            }
                        }
                        li.className = 'list-'+customStyle[currentStyle]+ index + ' ' + 'list-'+currentStyle+'-paddingleft-' + paddingLeft;
                    }else{
                        li.className = 'list-'+customStyle[currentStyle]  + ' ' + 'list-'+currentStyle+'-paddingleft';
                    }
                }else{
                    li.className = li.className.replace(/list-[\w\-]+/gi,'');
                }
                var className = li.getAttribute('class');
                if(className !== null && !className.replace(/\s/g,'')){
                    domUtils.removeAttributes(li,'class')
                }
            });
            !ignore && adjustList(node,node.tagName.toLowerCase(),getStyle(node)||domUtils.getStyle(node, 'list-style-type'),true);
        })
    }
    function adjustList(list, tag, style,ignoreEmpty) {
        var nextList = list.nextSibling;
        if (nextList && nextList.nodeType == 1 && nextList.tagName.toLowerCase() == tag && (getStyle(nextList) || domUtils.getStyle(nextList, 'list-style-type') || (tag == 'ol' ? 'decimal' : 'disc')) == style) {
            domUtils.moveChild(nextList, list);
            if (nextList.childNodes.length == 0) {
                domUtils.remove(nextList);
            }
        }
        if(nextList && domUtils.isFillChar(nextList)){
            domUtils.remove(nextList);
        }
        var preList = list.previousSibling;
        if (preList && preList.nodeType == 1 && preList.tagName.toLowerCase() == tag && (getStyle(preList) || domUtils.getStyle(preList, 'list-style-type') || (tag == 'ol' ? 'decimal' : 'disc')) == style) {
            domUtils.moveChild(list, preList);
        }
        if(preList && domUtils.isFillChar(preList)){
            domUtils.remove(preList);
        }
        !ignoreEmpty && domUtils.isEmptyBlock(list) && domUtils.remove(list);
        if(getStyle(list)){
            adjustListStyle(list.ownerDocument,true)
        }
    }

    function setListStyle(list,style){
        if(customStyle[style]){
            list.className = 'custom_' + style;
        }
        try{
            domUtils.setStyle(list, 'list-style-type', style);
        }catch(e){}
    }
    function clearEmptySibling(node) {
        var tmpNode = node.previousSibling;
        if (tmpNode && domUtils.isEmptyBlock(tmpNode)) {
            domUtils.remove(tmpNode);
        }
        tmpNode = node.nextSibling;
        if (tmpNode && domUtils.isEmptyBlock(tmpNode)) {
            domUtils.remove(tmpNode);
        }
    }

    me.addListener('keydown', function (type, evt) {
        function preventAndSave() {
            evt.preventDefault ? evt.preventDefault() : (evt.returnValue = false);
            me.fireEvent('contentchange');
            me.undoManger && me.undoManger.save();
        }
        function findList(node,filterFn){
            while(node && !domUtils.isBody(node)){
                if(filterFn(node)){
                    return null
                }
                if(node.nodeType == 1 && /[ou]l/i.test(node.tagName)){
                    return node;
                }
                node = node.parentNode;
            }
            return null;
        }
        var keyCode = evt.keyCode || evt.which;
        if (keyCode == 13 && !evt.shiftKey) {//回车
            var rng = me.selection.getRange(),
                parent = domUtils.findParent(rng.startContainer,function(node){return domUtils.isBlockElm(node)},true),
                li = domUtils.findParentByTagName(rng.startContainer,'li',true);
            if(parent && parent.tagName != 'PRE' && !li){
                var html = parent.innerHTML.replace(new RegExp(domUtils.fillChar, 'g'),'');
                if(/^\s*1\s*\.[^\d]/.test(html)){
                    parent.innerHTML = html.replace(/^\s*1\s*\./,'');
                    rng.setStartAtLast(parent).collapse(true).select();
                    me.__hasEnterExecCommand = true;
                    me.execCommand('insertorderedlist');
                    me.__hasEnterExecCommand = false;
                }
            }
            var range = me.selection.getRange(),
                start = findList(range.startContainer,function (node) {
                    return node.tagName == 'TABLE';
                }),
                end = range.collapsed ? start : findList(range.endContainer,function (node) {
                    return node.tagName == 'TABLE';
                });

            if (start && end && start === end) {

                if (!range.collapsed) {
                    start = domUtils.findParentByTagName(range.startContainer, 'li', true);
                    end = domUtils.findParentByTagName(range.endContainer, 'li', true);
                    if (start && end && start === end) {
                        range.deleteContents();
                        li = domUtils.findParentByTagName(range.startContainer, 'li', true);
                        if (li && domUtils.isEmptyBlock(li)) {

                            pre = li.previousSibling;
                            next = li.nextSibling;
                            p = me.document.createElement('p');

                            domUtils.fillNode(me.document, p);
                            parentList = li.parentNode;
                            if (pre && next) {
                                range.setStart(next, 0).collapse(true).select(true);
                                domUtils.remove(li);

                            } else {
                                if (!pre && !next || !pre) {

                                    parentList.parentNode.insertBefore(p, parentList);


                                } else {
                                    li.parentNode.parentNode.insertBefore(p, parentList.nextSibling);
                                }
                                domUtils.remove(li);
                                if (!parentList.firstChild) {
                                    domUtils.remove(parentList);
                                }
                                range.setStart(p, 0).setCursor();


                            }
                            preventAndSave();
                            return;

                        }
                    } else {
                        var tmpRange = range.cloneRange(),
                            bk = tmpRange.collapse(false).createBookmark();

                        range.deleteContents();
                        tmpRange.moveToBookmark(bk);
                        var li = domUtils.findParentByTagName(tmpRange.startContainer, 'li', true);

                        clearEmptySibling(li);
                        tmpRange.select();
                        preventAndSave();
                        return;
                    }
                }


                li = domUtils.findParentByTagName(range.startContainer, 'li', true);

                if (li) {
                    if (domUtils.isEmptyBlock(li)) {
                        bk = range.createBookmark();
                        var parentList = li.parentNode;
                        if (li !== parentList.lastChild) {
                            domUtils.breakParent(li, parentList);
                            clearEmptySibling(li);
                        } else {

                            parentList.parentNode.insertBefore(li, parentList.nextSibling);
                            if (domUtils.isEmptyNode(parentList)) {
                                domUtils.remove(parentList);
                            }
                        }
                        //嵌套不处理
                        if (!dtd.$list[li.parentNode.tagName]) {

                            if (!domUtils.isBlockElm(li.firstChild)) {
                                p = me.document.createElement('p');
                                li.parentNode.insertBefore(p, li);
                                while (li.firstChild) {
                                    p.appendChild(li.firstChild);
                                }
                                domUtils.remove(li);
                            } else {
                                domUtils.remove(li, true);
                            }
                        }
                        range.moveToBookmark(bk).select();


                    } else {
                        var first = li.firstChild;
                        if (!first || !domUtils.isBlockElm(first)) {
                            var p = me.document.createElement('p');

                            !li.firstChild && domUtils.fillNode(me.document, p);
                            while (li.firstChild) {

                                p.appendChild(li.firstChild);
                            }
                            li.appendChild(p);
                            first = p;
                        }

                        var span = me.document.createElement('span');

                        range.insertNode(span);
                        domUtils.breakParent(span, li);

                        var nextLi = span.nextSibling;
                        first = nextLi.firstChild;

                        if (!first) {
                            p = me.document.createElement('p');

                            domUtils.fillNode(me.document, p);
                            nextLi.appendChild(p);
                            first = p;
                        }
                        if (domUtils.isEmptyNode(first)) {
                            first.innerHTML = '';
                            domUtils.fillNode(me.document, first);
                        }

                        range.setStart(first, 0).collapse(true).shrinkBoundary().select();
                        domUtils.remove(span);
                        var pre = nextLi.previousSibling;
                        if (pre && domUtils.isEmptyBlock(pre)) {
                            pre.innerHTML = '<p></p>';
                            domUtils.fillNode(me.document, pre.firstChild);
                        }

                    }
//                        }
                    preventAndSave();
                }


            }


        }
        if (keyCode == 8) {
            //修中ie中li下的问题
            range = me.selection.getRange();
            if (range.collapsed && domUtils.isStartInblock(range)) {
                tmpRange = range.cloneRange().trimBoundary();
                li = domUtils.findParentByTagName(range.startContainer, 'li', true);
                //要在li的最左边，才能处理
                if (li && domUtils.isStartInblock(tmpRange)) {
                    start = domUtils.findParentByTagName(range.startContainer, 'p', true);
                    if (start && start !== li.firstChild) {
                        var parentList = domUtils.findParentByTagName(start,['ol','ul']);
                        domUtils.breakParent(start,parentList);
                        clearEmptySibling(start);
                        me.fireEvent('contentchange');
                        range.setStart(start,0).setCursor(false,true);
                        me.fireEvent('saveScene');
                        domUtils.preventDefault(evt);
                        return;
                    }

                    if (li && (pre = li.previousSibling)) {
                        if (keyCode == 46 && li.childNodes.length) {
                            return;
                        }
                        //有可能上边的兄弟节点是个2级菜单，要追加到2级菜单的最后的li
                        if (dtd.$list[pre.tagName]) {
                            pre = pre.lastChild;
                        }
                        me.undoManger && me.undoManger.save();
                        first = li.firstChild;
                        if (domUtils.isBlockElm(first)) {
                            if (domUtils.isEmptyNode(first)) {
//                                    range.setEnd(pre, pre.childNodes.length).shrinkBoundary().collapse().select(true);
                                pre.appendChild(first);
                                range.setStart(first, 0).setCursor(false, true);
                                //first不是唯一的节点
                                while (li.firstChild) {
                                    pre.appendChild(li.firstChild);
                                }
                            } else {

                                span = me.document.createElement('span');
                                range.insertNode(span);
                                //判断pre是否是空的节点,如果是<p><br/></p>类型的空节点，干掉p标签防止它占位
                                if (domUtils.isEmptyBlock(pre)) {
                                    pre.innerHTML = '';
                                }
                                domUtils.moveChild(li, pre);
                                range.setStartBefore(span).collapse(true).select(true);

                                domUtils.remove(span);

                            }
                        } else {
                            if (domUtils.isEmptyNode(li)) {
                                var p = me.document.createElement('p');
                                pre.appendChild(p);
                                range.setStart(p, 0).setCursor();
//                                    range.setEnd(pre, pre.childNodes.length).shrinkBoundary().collapse().select(true);
                            } else {
                                range.setEnd(pre, pre.childNodes.length).collapse().select(true);
                                while (li.firstChild) {
                                    pre.appendChild(li.firstChild);
                                }
                            }
                        }
                        domUtils.remove(li);
                        me.fireEvent('contentchange');
                        me.fireEvent('saveScene');
                        domUtils.preventDefault(evt);
                        return;

                    }
                    //trace:980

                    if (li && !li.previousSibling) {
                        var parentList = li.parentNode;
                        var bk = range.createBookmark();
                        if(domUtils.isTagNode(parentList.parentNode,'ol ul')){
                            parentList.parentNode.insertBefore(li,parentList);
                            if(domUtils.isEmptyNode(parentList)){
                                domUtils.remove(parentList)
                            }
                        }else{

                            while(li.firstChild){
                                parentList.parentNode.insertBefore(li.firstChild,parentList);
                            }

                            domUtils.remove(li);
                            if(domUtils.isEmptyNode(parentList)){
                                domUtils.remove(parentList)
                            }

                        }
                        range.moveToBookmark(bk).setCursor(false,true);
                        me.fireEvent('contentchange');
                        me.fireEvent('saveScene');
                        domUtils.preventDefault(evt);
                        return;

                    }


                }


            }

        }
    });

    me.addListener('keyup',function(type, evt){
        var keyCode = evt.keyCode || evt.which;
        if (keyCode == 8) {
            var rng = me.selection.getRange(),list;
            if(list = domUtils.findParentByTagName(rng.startContainer,['ol', 'ul'],true)){
                adjustList(list,list.tagName.toLowerCase(),getStyle(list)||domUtils.getComputedStyle(list,'list-style-type'),true)
            }
        }
    });
    //处理tab键
    me.addListener('tabkeydown',function(){

        var range = me.selection.getRange();

        //控制级数
        function checkLevel(li){
            if(me.options.maxListLevel != -1){
                var level = li.parentNode,levelNum = 0;
                while(/[ou]l/i.test(level.tagName)){
                    levelNum++;
                    level = level.parentNode;
                }
                if(levelNum >= me.options.maxListLevel){
                    return true;
                }
            }
        }
        //只以开始为准
        //todo 后续改进
        var li = domUtils.findParentByTagName(range.startContainer, 'li', true);
        if(li){

            var bk;
            if(range.collapsed){
                if(checkLevel(li))
                    return true;
                var parentLi = li.parentNode,
                    list = me.document.createElement(parentLi.tagName),
                    index = utils.indexOf(listStyle[list.tagName], getStyle(parentLi)||domUtils.getComputedStyle(parentLi, 'list-style-type'));
                index = index + 1 == listStyle[list.tagName].length ? 0 : index + 1;
                var currentStyle = listStyle[list.tagName][index];
                setListStyle(list,currentStyle);
                if(domUtils.isStartInblock(range)){
                    me.fireEvent('saveScene');
                    bk = range.createBookmark();
                    parentLi.insertBefore(list, li);
                    list.appendChild(li);
                    adjustList(list,list.tagName.toLowerCase(),currentStyle);
                    me.fireEvent('contentchange');
                    range.moveToBookmark(bk).select(true);
                    return true;
                }
            }else{
                me.fireEvent('saveScene');
                bk = range.createBookmark();
                for(var i= 0,closeList,parents = domUtils.findParents(li),ci;ci=parents[i++];){
                    if(domUtils.isTagNode(ci,'ol ul')){
                        closeList = ci;
                        break;
                    }
                }
                var current = li;
                if(bk.end){
                    while(current && !(domUtils.getPosition(current, bk.end) & domUtils.POSITION_FOLLOWING)){
                        if(checkLevel(current)){
                            current = domUtils.getNextDomNode(current,false,null,function(node){return node !== closeList});
                            continue;
                        }
                        var parentLi = current.parentNode,
                            list = me.document.createElement(parentLi.tagName),
                            index = utils.indexOf(listStyle[list.tagName], getStyle(parentLi)||domUtils.getComputedStyle(parentLi, 'list-style-type'));
                        var currentIndex = index + 1 == listStyle[list.tagName].length ? 0 : index + 1;
                        var currentStyle = listStyle[list.tagName][currentIndex];
                        setListStyle(list,currentStyle);
                        parentLi.insertBefore(list, current);
                        while(current && !(domUtils.getPosition(current, bk.end) & domUtils.POSITION_FOLLOWING)){
                            li = current.nextSibling;
                            list.appendChild(current);
                            if(!li || domUtils.isTagNode(li,'ol ul')){
                                if(li){
                                    while(li = li.firstChild){
                                        if(li.tagName == 'LI'){
                                            break;
                                        }
                                    }
                                }else{
                                    li = domUtils.getNextDomNode(current,false,null,function(node){return node !== closeList});
                                }
                                break;
                            }
                            current = li;
                        }
                        adjustList(list,list.tagName.toLowerCase(),currentStyle);
                        current = li;
                    }
                }
                me.fireEvent('contentchange');
                range.moveToBookmark(bk).select();
                return true;
            }
        }

    });
    function getLi(start){
        while(start && !domUtils.isBody(start)){
            if(start.nodeName == 'TABLE'){
                return null;
            }
            if(start.nodeName == 'LI'){
                return start
            }
            start = start.parentNode;
        }
    }

    /**
     * 有序列表，与“insertunorderedlist”命令互斥
     * @command insertorderedlist
     * @method execCommand
     * @param { String } command 命令字符串
     * @param { String } style 插入的有序列表类型，值为：decimal,lower-alpha,lower-roman,upper-alpha,upper-roman,cn,cn1,cn2,num,num1,num2
     * @example
     * ```javascript
     * editor.execCommand( 'insertorderedlist','decimal');
     * ```
     */
    /**
     * 查询当前选区内容是否有序列表
     * @command insertorderedlist
     * @method queryCommandState
     * @param { String } cmd 命令字符串
     * @return { int } 如果当前选区是有序列表返回1，否则返回0
     * @example
     * ```javascript
     * editor.queryCommandState( 'insertorderedlist' );
     * ```
     */
    /**
     * 查询当前选区内容是否有序列表
     * @command insertorderedlist
     * @method queryCommandValue
     * @param { String } cmd 命令字符串
     * @return { String } 返回当前有序列表的类型，值为null或decimal,lower-alpha,lower-roman,upper-alpha,upper-roman,cn,cn1,cn2,num,num1,num2
     * @example
     * ```javascript
     * editor.queryCommandValue( 'insertorderedlist' );
     * ```
     */

    /**
     * 无序列表，与“insertorderedlist”命令互斥
     * @command insertunorderedlist
     * @method execCommand
     * @param { String } command 命令字符串
     * @param { String } style 插入的无序列表类型，值为：circle,disc,square,dash,dot
     * @example
     * ```javascript
     * editor.execCommand( 'insertunorderedlist','circle');
     * ```
     */
    /**
     * 查询当前是否有word文档粘贴进来的图片
     * @command insertunorderedlist
     * @method insertunorderedlist
     * @param { String } command 命令字符串
     * @return { int } 如果当前选区是无序列表返回1，否则返回0
     * @example
     * ```javascript
     * editor.queryCommandState( 'insertunorderedlist' );
     * ```
     */
    /**
     * 查询当前选区内容是否有序列表
     * @command insertunorderedlist
     * @method queryCommandValue
     * @param { String } command 命令字符串
     * @return { String } 返回当前无序列表的类型，值为null或circle,disc,square,dash,dot
     * @example
     * ```javascript
     * editor.queryCommandValue( 'insertunorderedlist' );
     * ```
     */

    me.commands['insertorderedlist'] =
    me.commands['insertunorderedlist'] = {
            execCommand:function (command, style) {

                if (!style) {
                    style = command.toLowerCase() == 'insertorderedlist' ? 'decimal' : 'disc';
                }
                var me = this,
                    range = this.selection.getRange(),
                    filterFn = function (node) {
                        return   node.nodeType == 1 ? node.tagName.toLowerCase() != 'br' : !domUtils.isWhitespace(node);
                    },
                    tag = command.toLowerCase() == 'insertorderedlist' ? 'ol' : 'ul',
                    frag = me.document.createDocumentFragment();
                //去掉是因为会出现选到末尾，导致adjustmentBoundary缩到ol/ul的位置
                //range.shrinkBoundary();//.adjustmentBoundary();
                range.adjustmentBoundary().shrinkBoundary();
                var bko = range.createBookmark(true),
                    start = getLi(me.document.getElementById(bko.start)),
                    modifyStart = 0,
                    end =  getLi(me.document.getElementById(bko.end)),
                    modifyEnd = 0,
                    startParent, endParent,
                    list, tmp;

                if (start || end) {
                    start && (startParent = start.parentNode);
                    if (!bko.end) {
                        end = start;
                    }
                    end && (endParent = end.parentNode);

                    if (startParent === endParent) {
                        while (start !== end) {
                            tmp = start;
                            start = start.nextSibling;
                            if (!domUtils.isBlockElm(tmp.firstChild)) {
                                var p = me.document.createElement('p');
                                while (tmp.firstChild) {
                                    p.appendChild(tmp.firstChild);
                                }
                                tmp.appendChild(p);
                            }
                            frag.appendChild(tmp);
                        }
                        tmp = me.document.createElement('span');
                        startParent.insertBefore(tmp, end);
                        if (!domUtils.isBlockElm(end.firstChild)) {
                            p = me.document.createElement('p');
                            while (end.firstChild) {
                                p.appendChild(end.firstChild);
                            }
                            end.appendChild(p);
                        }
                        frag.appendChild(end);
                        domUtils.breakParent(tmp, startParent);
                        if (domUtils.isEmptyNode(tmp.previousSibling)) {
                            domUtils.remove(tmp.previousSibling);
                        }
                        if (domUtils.isEmptyNode(tmp.nextSibling)) {
                            domUtils.remove(tmp.nextSibling)
                        }
                        var nodeStyle = getStyle(startParent) || domUtils.getComputedStyle(startParent, 'list-style-type') || (command.toLowerCase() == 'insertorderedlist' ? 'decimal' : 'disc');
                        if (startParent.tagName.toLowerCase() == tag && nodeStyle == style) {
                            for (var i = 0, ci, tmpFrag = me.document.createDocumentFragment(); ci = frag.firstChild;) {
                                if(domUtils.isTagNode(ci,'ol ul')){
//                                  删除时，子列表不处理
//                                  utils.each(domUtils.getElementsByTagName(ci,'li'),function(li){
//                                        while(li.firstChild){
//                                            tmpFrag.appendChild(li.firstChild);
//                                        }
//
//                                    });
                                    tmpFrag.appendChild(ci);
                                }else{
                                    while (ci.firstChild) {

                                        tmpFrag.appendChild(ci.firstChild);
                                        domUtils.remove(ci);
                                    }
                                }

                            }
                            tmp.parentNode.insertBefore(tmpFrag, tmp);
                        } else {
                            list = me.document.createElement(tag);
                            setListStyle(list,style);
                            list.appendChild(frag);
                            tmp.parentNode.insertBefore(list, tmp);
                        }

                        domUtils.remove(tmp);
                        list && adjustList(list, tag, style);
                        range.moveToBookmark(bko).select();
                        return;
                    }
                    //开始
                    if (start) {
                        while (start) {
                            tmp = start.nextSibling;
                            if (domUtils.isTagNode(start, 'ol ul')) {
                                frag.appendChild(start);
                            } else {
                                var tmpfrag = me.document.createDocumentFragment(),
                                    hasBlock = 0;
                                while (start.firstChild) {
                                    if (domUtils.isBlockElm(start.firstChild)) {
                                        hasBlock = 1;
                                    }
                                    tmpfrag.appendChild(start.firstChild);
                                }
                                if (!hasBlock) {
                                    var tmpP = me.document.createElement('p');
                                    tmpP.appendChild(tmpfrag);
                                    frag.appendChild(tmpP);
                                } else {
                                    frag.appendChild(tmpfrag);
                                }
                                domUtils.remove(start);
                            }

                            start = tmp;
                        }
                        startParent.parentNode.insertBefore(frag, startParent.nextSibling);
                        if (domUtils.isEmptyNode(startParent)) {
                            range.setStartBefore(startParent);
                            domUtils.remove(startParent);
                        } else {
                            range.setStartAfter(startParent);
                        }
                        modifyStart = 1;
                    }

                    if (end && domUtils.inDoc(endParent, me.document)) {
                        //结束
                        start = endParent.firstChild;
                        while (start && start !== end) {
                            tmp = start.nextSibling;
                            if (domUtils.isTagNode(start, 'ol ul')) {
                                frag.appendChild(start);
                            } else {
                                tmpfrag = me.document.createDocumentFragment();
                                hasBlock = 0;
                                while (start.firstChild) {
                                    if (domUtils.isBlockElm(start.firstChild)) {
                                        hasBlock = 1;
                                    }
                                    tmpfrag.appendChild(start.firstChild);
                                }
                                if (!hasBlock) {
                                    tmpP = me.document.createElement('p');
                                    tmpP.appendChild(tmpfrag);
                                    frag.appendChild(tmpP);
                                } else {
                                    frag.appendChild(tmpfrag);
                                }
                                domUtils.remove(start);
                            }
                            start = tmp;
                        }
                        var tmpDiv = domUtils.createElement(me.document, 'div', {
                            'tmpDiv':1
                        });
                        domUtils.moveChild(end, tmpDiv);

                        frag.appendChild(tmpDiv);
                        domUtils.remove(end);
                        endParent.parentNode.insertBefore(frag, endParent);
                        range.setEndBefore(endParent);
                        if (domUtils.isEmptyNode(endParent)) {
                            domUtils.remove(endParent);
                        }

                        modifyEnd = 1;
                    }


                }

                if (!modifyStart) {
                    range.setStartBefore(me.document.getElementById(bko.start));
                }
                if (bko.end && !modifyEnd) {
                    range.setEndAfter(me.document.getElementById(bko.end));
                }
                range.enlarge(true, function (node) {
                    return notExchange[node.tagName];
                });

                frag = me.document.createDocumentFragment();

                var bk = range.createBookmark(),
                    current = domUtils.getNextDomNode(bk.start, false, filterFn),
                    tmpRange = range.cloneRange(),
                    tmpNode,
                    block = domUtils.isBlockElm;

                while (current && current !== bk.end && (domUtils.getPosition(current, bk.end) & domUtils.POSITION_PRECEDING)) {

                    if (current.nodeType == 3 || dtd.li[current.tagName]) {
                        if (current.nodeType == 1 && dtd.$list[current.tagName]) {
                            while (current.firstChild) {
                                frag.appendChild(current.firstChild);
                            }
                            tmpNode = domUtils.getNextDomNode(current, false, filterFn);
                            domUtils.remove(current);
                            current = tmpNode;
                            continue;

                        }
                        tmpNode = current;
                        tmpRange.setStartBefore(current);

                        while (current && current !== bk.end && (!block(current) || domUtils.isBookmarkNode(current) )) {
                            tmpNode = current;
                            current = domUtils.getNextDomNode(current, false, null, function (node) {
                                return !notExchange[node.tagName];
                            });
                        }

                        if (current && block(current)) {
                            tmp = domUtils.getNextDomNode(tmpNode, false, filterFn);
                            if (tmp && domUtils.isBookmarkNode(tmp)) {
                                current = domUtils.getNextDomNode(tmp, false, filterFn);
                                tmpNode = tmp;
                            }
                        }
                        tmpRange.setEndAfter(tmpNode);

                        current = domUtils.getNextDomNode(tmpNode, false, filterFn);

                        var li = range.document.createElement('li');

                        li.appendChild(tmpRange.extractContents());
                        if(domUtils.isEmptyNode(li)){
                            var tmpNode = range.document.createElement('p');
                            while(li.firstChild){
                                tmpNode.appendChild(li.firstChild)
                            }
                            li.appendChild(tmpNode);
                        }
                        frag.appendChild(li);
                    } else {
                        current = domUtils.getNextDomNode(current, true, filterFn);
                    }
                }
                range.moveToBookmark(bk).collapse(true);
                list = me.document.createElement(tag);
                setListStyle(list,style);
                list.appendChild(frag);
                range.insertNode(list);
                //当前list上下看能否合并
                adjustList(list, tag, style);
                //去掉冗余的tmpDiv
                for (var i = 0, ci, tmpDivs = domUtils.getElementsByTagName(list, 'div'); ci = tmpDivs[i++];) {
                    if (ci.getAttribute('tmpDiv')) {
                        domUtils.remove(ci, true)
                    }
                }
                range.moveToBookmark(bko).select();

            },
            queryCommandState:function (command) {
                var tag = command.toLowerCase() == 'insertorderedlist' ? 'ol' : 'ul';
                var path = this.selection.getStartElementPath();
                for(var i= 0,ci;ci = path[i++];){
                    if(ci.nodeName == 'TABLE'){
                        return 0
                    }
                    if(tag == ci.nodeName.toLowerCase()){
                        return 1
                    };
                }
                return 0;

            },
            queryCommandValue:function (command) {
                var tag = command.toLowerCase() == 'insertorderedlist' ? 'ol' : 'ul';
                var path = this.selection.getStartElementPath(),
                    node;
                for(var i= 0,ci;ci = path[i++];){
                    if(ci.nodeName == 'TABLE'){
                        node = null;
                        break;
                    }
                    if(tag == ci.nodeName.toLowerCase()){
                        node = ci;
                        break;
                    };
                }
                return node ? getStyle(node) || domUtils.getComputedStyle(node, 'list-style-type') : null;
            }
        };
};



// plugins/source.js
/**
 * 源码编辑插件
 * @file
 * @since 1.2.6.1
 */

(function (){
    var sourceEditors = {
        textarea: function (editor, holder){
            var textarea = holder.ownerDocument.createElement('textarea');
            textarea.style.cssText = 'position:absolute;resize:none;width:100%;height:100%;border:0;padding:0;margin:0;overflow-y:auto;';
            // todo: IE下只有onresize属性可用... 很纠结
            if (browser.ie && browser.version < 8) {
                textarea.style.width = holder.offsetWidth + 'px';
                textarea.style.height = holder.offsetHeight + 'px';
                holder.onresize = function (){
                    textarea.style.width = holder.offsetWidth + 'px';
                    textarea.style.height = holder.offsetHeight + 'px';
                };
            }
            holder.appendChild(textarea);
            return {
                setContent: function (content){
                    textarea.value = content;
                },
                getContent: function (){
                    return textarea.value;
                },
                select: function (){
                    var range;
                    if (browser.ie) {
                        range = textarea.createTextRange();
                        range.collapse(true);
                        range.select();
                    } else {
                        //todo: chrome下无法设置焦点
                        textarea.setSelectionRange(0, 0);
                        textarea.focus();
                    }
                },
                dispose: function (){
                    holder.removeChild(textarea);
                    // todo
                    holder.onresize = null;
                    textarea = null;
                    holder = null;
                }
            };
        },
        codemirror: function (editor, holder){

            var codeEditor = window.CodeMirror(holder, {
                mode: "text/html",
                tabMode: "indent",
                lineNumbers: true,
                lineWrapping:true
            });
            var dom = codeEditor.getWrapperElement();
            dom.style.cssText = 'position:absolute;left:0;top:0;width:100%;height:100%;font-family:consolas,"Courier new",monospace;font-size:13px;';
            codeEditor.getScrollerElement().style.cssText = 'position:absolute;left:0;top:0;width:100%;height:100%;';
            codeEditor.refresh();
            return {
                getCodeMirror:function(){
                    return codeEditor;
                },
                setContent: function (content){
                    codeEditor.setValue(content);
                },
                getContent: function (){
                    return codeEditor.getValue();
                },
                select: function (){
                    codeEditor.focus();
                },
                dispose: function (){
                    holder.removeChild(dom);
                    dom = null;
                    codeEditor = null;
                }
            };
        }
    };

    UE.plugins['source'] = function (){
        var me = this;
        var opt = this.options;
        var sourceMode = false;
        var sourceEditor;
        var orgSetContent;
        opt.sourceEditor = browser.ie  ? 'textarea' : (opt.sourceEditor || 'codemirror');

        me.setOpt({
            sourceEditorFirst:false
        });
        function createSourceEditor(holder){
            return sourceEditors[opt.sourceEditor == 'codemirror' && window.CodeMirror ? 'codemirror' : 'textarea'](me, holder);
        }

        var bakCssText;
        //解决在源码模式下getContent不能得到最新的内容问题
        var oldGetContent,
            bakAddress;

        /**
         * 切换源码模式和编辑模式
         * @command source
         * @method execCommand
         * @param { String } cmd 命令字符串
         * @example
         * ```javascript
         * editor.execCommand( 'source');
         * ```
         */

        /**
         * 查询当前编辑区域的状态是源码模式还是可视化模式
         * @command source
         * @method queryCommandState
         * @param { String } cmd 命令字符串
         * @return { int } 如果当前是源码编辑模式，返回1，否则返回0
         * @example
         * ```javascript
         * editor.queryCommandState( 'source' );
         * ```
         */

        me.commands['source'] = {
            execCommand: function (){

                sourceMode = !sourceMode;
                if (sourceMode) {
                    bakAddress = me.selection.getRange().createAddress(false,true);
                    me.undoManger && me.undoManger.save(true);
                    if(browser.gecko){
                        me.body.contentEditable = false;
                    }

                    bakCssText = me.iframe.style.cssText;
                    me.iframe.style.cssText += 'position:absolute;left:-32768px;top:-32768px;';


                    me.fireEvent('beforegetcontent');
                    var root = UE.htmlparser(me.body.innerHTML);
                    me.filterOutputRule(root);
                    root.traversal(function (node) {
                        if (node.type == 'element') {
                            switch (node.tagName) {
                                case 'td':
                                case 'th':
                                case 'caption':
                                if(node.children && node.children.length == 1){
                                    if(node.firstChild().tagName == 'br' ){
                                        node.removeChild(node.firstChild())
                                    }
                                };
                                break;
                                case 'pre':
                                    node.innerText(node.innerText().replace(/&nbsp;/g,' '))

                            }
                        }
                    });

                    me.fireEvent('aftergetcontent');

                    var content = root.toHtml(true);

                    sourceEditor = createSourceEditor(me.iframe.parentNode);

                    sourceEditor.setContent(content);

                    orgSetContent = me.setContent;

                    me.setContent = function(html){
                        //这里暂时不触发事件，防止报错
                        var root = UE.htmlparser(html);
                        me.filterInputRule(root);
                        html = root.toHtml();
                        sourceEditor.setContent(html);
                    };

                    setTimeout(function (){
                        sourceEditor.select();
                        me.addListener('fullscreenchanged', function(){
                            try{
                                sourceEditor.getCodeMirror().refresh()
                            }catch(e){}
                        });
                    });

                    //重置getContent，源码模式下取值也能是最新的数据
                    oldGetContent = me.getContent;
                    me.getContent = function (){
                        return sourceEditor.getContent() || '<p>' + (browser.ie ? '' : '<br/>')+'</p>';
                    };
                } else {
                    me.iframe.style.cssText = bakCssText;
                    var cont = sourceEditor.getContent() || '<p>' + (browser.ie ? '' : '<br/>')+'</p>';
                    //处理掉block节点前后的空格,有可能会误命中，暂时不考虑
                    cont = cont.replace(new RegExp('[\\r\\t\\n ]*<\/?(\\w+)\\s*(?:[^>]*)>','g'), function(a,b){
                        if(b && !dtd.$inlineWithA[b.toLowerCase()]){
                            return a.replace(/(^[\n\r\t ]*)|([\n\r\t ]*$)/g,'');
                        }
                        return a.replace(/(^[\n\r\t]*)|([\n\r\t]*$)/g,'')
                    });

                    me.setContent = orgSetContent;

                    me.setContent(cont);
                    sourceEditor.dispose();
                    sourceEditor = null;
                    //还原getContent方法
                    me.getContent = oldGetContent;
                    var first = me.body.firstChild;
                    //trace:1106 都删除空了，下边会报错，所以补充一个p占位
                    if(!first){
                        me.body.innerHTML = '<p>'+(browser.ie?'':'<br/>')+'</p>';
                        first = me.body.firstChild;
                    }


                    //要在ifm为显示时ff才能取到selection,否则报错
                    //这里不能比较位置了
                    me.undoManger && me.undoManger.save(true);

                    if(browser.gecko){

                        var input = document.createElement('input');
                        input.style.cssText = 'position:absolute;left:0;top:-32768px';

                        document.body.appendChild(input);

                        me.body.contentEditable = false;
                        setTimeout(function(){
                            domUtils.setViewportOffset(input, { left: -32768, top: 0 });
                            input.focus();
                            setTimeout(function(){
                                me.body.contentEditable = true;
                                me.selection.getRange().moveToAddress(bakAddress).select(true);
                                domUtils.remove(input);
                            });

                        });
                    }else{
                        //ie下有可能报错，比如在代码顶头的情况
                        try{
                            me.selection.getRange().moveToAddress(bakAddress).select(true);
                        }catch(e){}

                    }
                }
                this.fireEvent('sourcemodechanged', sourceMode);
            },
            queryCommandState: function (){
                return sourceMode|0;
            },
            notNeedUndo : 1
        };
        var oldQueryCommandState = me.queryCommandState;

        me.queryCommandState = function (cmdName){
            cmdName = cmdName.toLowerCase();
            if (sourceMode) {
                //源码模式下可以开启的命令
                return cmdName in {
                    'source' : 1,
                    'fullscreen' : 1
                } ? 1 : -1
            }
            return oldQueryCommandState.apply(this, arguments);
        };

        if(opt.sourceEditor == "codemirror"){

            me.addListener("ready",function(){
                utils.loadFile(document,{
                    src : opt.codeMirrorJsUrl || opt.UEDITOR_HOME_URL + "third-party/codemirror/codemirror.js",
                    tag : "script",
                    type : "text/javascript",
                    defer : "defer"
                },function(){
                    if(opt.sourceEditorFirst){
                        setTimeout(function(){
                            me.execCommand("source");
                        },0);
                    }
                });
                utils.loadFile(document,{
                    tag : "link",
                    rel : "stylesheet",
                    type : "text/css",
                    href : opt.codeMirrorCssUrl || opt.UEDITOR_HOME_URL + "third-party/codemirror/codemirror.css"
                });

            });
        }

    };

})();

// plugins/enterkey.js
///import core
///import plugins/undo.js
///commands 设置回车标签p或br
///commandsName  EnterKey
///commandsTitle  设置回车标签p或br
/**
 * @description 处理回车
 * @author zhanyi
 */
UE.plugins['enterkey'] = function() {
    var hTag,
        me = this,
        tag = me.options.enterTag;
    me.addListener('keyup', function(type, evt) {

        var keyCode = evt.keyCode || evt.which;
        if (keyCode == 13) {
            var range = me.selection.getRange(),
                start = range.startContainer,
                doSave;

            //修正在h1-h6里边回车后不能嵌套p的问题
            if (!browser.ie) {

                if (/h\d/i.test(hTag)) {
                    if (browser.gecko) {
                        var h = domUtils.findParentByTagName(start, [ 'h1', 'h2', 'h3', 'h4', 'h5', 'h6','blockquote','caption','table'], true);
                        if (!h) {
                            me.document.execCommand('formatBlock', false, '<p>');
                            doSave = 1;
                        }
                    } else {
                        //chrome remove div
                        if (start.nodeType == 1) {
                            var tmp = me.document.createTextNode(''),div;
                            range.insertNode(tmp);
                            div = domUtils.findParentByTagName(tmp, 'div', true);
                            if (div) {
                                var p = me.document.createElement('p');
                                while (div.firstChild) {
                                    p.appendChild(div.firstChild);
                                }
                                div.parentNode.insertBefore(p, div);
                                domUtils.remove(div);
                                range.setStartBefore(tmp).setCursor();
                                doSave = 1;
                            }
                            domUtils.remove(tmp);

                        }
                    }

                    if (me.undoManger && doSave) {
                        me.undoManger.save();
                    }
                }
                //没有站位符，会出现多行的问题
                browser.opera &&  range.select();
            }else{
                me.fireEvent('saveScene',true,true)
            }
        }
    });

    me.addListener('keydown', function(type, evt) {
        var keyCode = evt.keyCode || evt.which;
        if (keyCode == 13) {//回车
            if(me.fireEvent('beforeenterkeydown')){
                domUtils.preventDefault(evt);
                return;
            }
            me.fireEvent('saveScene',true,true);
            hTag = '';


            var range = me.selection.getRange();

            if (!range.collapsed) {
                //跨td不能删
                var start = range.startContainer,
                    end = range.endContainer,
                    startTd = domUtils.findParentByTagName(start, 'td', true),
                    endTd = domUtils.findParentByTagName(end, 'td', true);
                if (startTd && endTd && startTd !== endTd || !startTd && endTd || startTd && !endTd) {
                    evt.preventDefault ? evt.preventDefault() : ( evt.returnValue = false);
                    return;
                }
            }
            if (tag == 'p') {


                if (!browser.ie) {

                    start = domUtils.findParentByTagName(range.startContainer, ['ol','ul','p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6','blockquote','caption'], true);

                    //opera下执行formatblock会在table的场景下有问题，回车在opera原生支持很好，所以暂时在opera去掉调用这个原生的command
                    //trace:2431
                    if (!start && !browser.opera) {

                        me.document.execCommand('formatBlock', false, '<p>');

                        if (browser.gecko) {
                            range = me.selection.getRange();
                            start = domUtils.findParentByTagName(range.startContainer, 'p', true);
                            start && domUtils.removeDirtyAttr(start);
                        }


                    } else {
                        hTag = start.tagName;
                        start.tagName.toLowerCase() == 'p' && browser.gecko && domUtils.removeDirtyAttr(start);
                    }

                }

            } else {
                evt.preventDefault ? evt.preventDefault() : ( evt.returnValue = false);

                if (!range.collapsed) {
                    range.deleteContents();
                    start = range.startContainer;
                    if (start.nodeType == 1 && (start = start.childNodes[range.startOffset])) {
                        while (start.nodeType == 1) {
                            if (dtd.$empty[start.tagName]) {
                                range.setStartBefore(start).setCursor();
                                if (me.undoManger) {
                                    me.undoManger.save();
                                }
                                return false;
                            }
                            if (!start.firstChild) {
                                var br = range.document.createElement('br');
                                start.appendChild(br);
                                range.setStart(start, 0).setCursor();
                                if (me.undoManger) {
                                    me.undoManger.save();
                                }
                                return false;
                            }
                            start = start.firstChild;
                        }
                        if (start === range.startContainer.childNodes[range.startOffset]) {
                            br = range.document.createElement('br');
                            range.insertNode(br).setCursor();

                        } else {
                            range.setStart(start, 0).setCursor();
                        }


                    } else {
                        br = range.document.createElement('br');
                        range.insertNode(br).setStartAfter(br).setCursor();
                    }


                } else {
                    br = range.document.createElement('br');
                    range.insertNode(br);
                    var parent = br.parentNode;
                    if (parent.lastChild === br) {
                        br.parentNode.insertBefore(br.cloneNode(true), br);
                        range.setStartBefore(br);
                    } else {
                        range.setStartAfter(br);
                    }
                    range.setCursor();

                }

            }

        }
    });
};


// plugins/keystrokes.js
/* 处理特殊键的兼容性问题 */
UE.plugins['keystrokes'] = function() {
    var me = this;
    var collapsed = true;
    me.addListener('keydown', function(type, evt) {
        var keyCode = evt.keyCode || evt.which,
            rng = me.selection.getRange();

        //处理全选的情况
        if(!rng.collapsed && !(evt.ctrlKey || evt.shiftKey || evt.altKey || evt.metaKey) && (keyCode >= 65 && keyCode <=90
            || keyCode >= 48 && keyCode <= 57 ||
            keyCode >= 96 && keyCode <= 111 || {
                    13:1,
                    8:1,
                    46:1
                }[keyCode])
            ){

            var tmpNode = rng.startContainer;
            if(domUtils.isFillChar(tmpNode)){
                rng.setStartBefore(tmpNode)
            }
            tmpNode = rng.endContainer;
            if(domUtils.isFillChar(tmpNode)){
                rng.setEndAfter(tmpNode)
            }
            rng.txtToElmBoundary();
            //结束边界可能放到了br的前边，要把br包含进来
            // x[xxx]<br/>
            if(rng.endContainer && rng.endContainer.nodeType == 1){
                tmpNode = rng.endContainer.childNodes[rng.endOffset];
                if(tmpNode && domUtils.isBr(tmpNode)){
                    rng.setEndAfter(tmpNode);
                }
            }
            if(rng.startOffset == 0){
                tmpNode = rng.startContainer;
                if(domUtils.isBoundaryNode(tmpNode,'firstChild') ){
                    tmpNode = rng.endContainer;
                    if(rng.endOffset == (tmpNode.nodeType == 3 ? tmpNode.nodeValue.length : tmpNode.childNodes.length) && domUtils.isBoundaryNode(tmpNode,'lastChild')){
                        me.fireEvent('saveScene');
                        me.body.innerHTML = '<p>'+(browser.ie ? '' : '<br/>')+'</p>';
                        rng.setStart(me.body.firstChild,0).setCursor(false,true);
                        me._selectionChange();
                        return;
                    }
                }
            }
        }

        //处理backspace
        if (keyCode == keymap.Backspace) {
            rng = me.selection.getRange();
            collapsed = rng.collapsed;
            if(me.fireEvent('delkeydown',evt)){
                return;
            }
            var start,end;
            //避免按两次删除才能生效的问题
            if(rng.collapsed && rng.inFillChar()){
                start = rng.startContainer;

                if(domUtils.isFillChar(start)){
                    rng.setStartBefore(start).shrinkBoundary(true).collapse(true);
                    domUtils.remove(start)
                }else{
                    start.nodeValue = start.nodeValue.replace(new RegExp('^' + domUtils.fillChar ),'');
                    rng.startOffset--;
                    rng.collapse(true).select(true)
                }
            }

            //解决选中control元素不能删除的问题
            if (start = rng.getClosedNode()) {
                me.fireEvent('saveScene');
                rng.setStartBefore(start);
                domUtils.remove(start);
                rng.setCursor();
                me.fireEvent('saveScene');
                domUtils.preventDefault(evt);
                return;
            }
            //阻止在table上的删除
            if (!browser.ie) {
                start = domUtils.findParentByTagName(rng.startContainer, 'table', true);
                end = domUtils.findParentByTagName(rng.endContainer, 'table', true);
                if (start && !end || !start && end || start !== end) {
                    evt.preventDefault();
                    return;
                }
            }

        }
        //处理tab键的逻辑
        if (keyCode == keymap.Tab) {
            //不处理以下标签
            var excludeTagNameForTabKey = {
                'ol' : 1,
                'ul' : 1,
                'table':1
            };
            //处理组件里的tab按下事件
            if(me.fireEvent('tabkeydown',evt)){
                domUtils.preventDefault(evt);
                return;
            }
            var range = me.selection.getRange();
            me.fireEvent('saveScene');
            for (var i = 0,txt = '',tabSize = me.options.tabSize|| 4,tabNode =  me.options.tabNode || '&nbsp;'; i < tabSize; i++) {
                txt += tabNode;
            }
            var span = me.document.createElement('span');
            span.innerHTML = txt + domUtils.fillChar;
            if (range.collapsed) {
                range.insertNode(span.cloneNode(true).firstChild).setCursor(true);
            } else {
                var filterFn = function(node) {
                    return domUtils.isBlockElm(node) && !excludeTagNameForTabKey[node.tagName.toLowerCase()]

                };
                //普通的情况
                start = domUtils.findParent(range.startContainer, filterFn,true);
                end = domUtils.findParent(range.endContainer, filterFn,true);
                if (start && end && start === end) {
                    range.deleteContents();
                    range.insertNode(span.cloneNode(true).firstChild).setCursor(true);
                } else {
                    var bookmark = range.createBookmark();
                    range.enlarge(true);
                    var bookmark2 = range.createBookmark(),
                        current = domUtils.getNextDomNode(bookmark2.start, false, filterFn);
                    while (current && !(domUtils.getPosition(current, bookmark2.end) & domUtils.POSITION_FOLLOWING)) {
                        current.insertBefore(span.cloneNode(true).firstChild, current.firstChild);
                        current = domUtils.getNextDomNode(current, false, filterFn);
                    }
                    range.moveToBookmark(bookmark2).moveToBookmark(bookmark).select();
                }
            }
            domUtils.preventDefault(evt)
        }
        //trace:1634
        //ff的del键在容器空的时候，也会删除
        if(browser.gecko && keyCode == 46){
            range = me.selection.getRange();
            if(range.collapsed){
                start = range.startContainer;
                if(domUtils.isEmptyBlock(start)){
                    var parent = start.parentNode;
                    while(domUtils.getChildCount(parent) == 1 && !domUtils.isBody(parent)){
                        start = parent;
                        parent = parent.parentNode;
                    }
                    if(start === parent.lastChild)
                        evt.preventDefault();
                    return;
                }
            }
        }
    });
    me.addListener('keyup', function(type, evt) {
        var keyCode = evt.keyCode || evt.which,
            rng,me = this;
        if(keyCode == keymap.Backspace){
            if(me.fireEvent('delkeyup')){
                return;
            }
            rng = me.selection.getRange();
            if(rng.collapsed){
                var tmpNode,
                    autoClearTagName = ['h1','h2','h3','h4','h5','h6'];
                if(tmpNode = domUtils.findParentByTagName(rng.startContainer,autoClearTagName,true)){
                    if(domUtils.isEmptyBlock(tmpNode)){
                        var pre = tmpNode.previousSibling;
                        if(pre && pre.nodeName != 'TABLE'){
                            domUtils.remove(tmpNode);
                            rng.setStartAtLast(pre).setCursor(false,true);
                            return;
                        }else{
                            var next = tmpNode.nextSibling;
                            if(next && next.nodeName != 'TABLE'){
                                domUtils.remove(tmpNode);
                                rng.setStartAtFirst(next).setCursor(false,true);
                                return;
                            }
                        }
                    }
                }
                //处理当删除到body时，要重新给p标签展位
                if(domUtils.isBody(rng.startContainer)){
                    var tmpNode = domUtils.createElement(me.document,'p',{
                        'innerHTML' : browser.ie ? domUtils.fillChar : '<br/>'
                    });
                    rng.insertNode(tmpNode).setStart(tmpNode,0).setCursor(false,true);
                }
            }


            //chrome下如果删除了inline标签，浏览器会有记忆，在输入文字还是会套上刚才删除的标签，所以这里再选一次就不会了
            if( !collapsed && (rng.startContainer.nodeType == 3 || rng.startContainer.nodeType == 1 && domUtils.isEmptyBlock(rng.startContainer))){
                if(browser.ie){
                    var span = rng.document.createElement('span');
                    rng.insertNode(span).setStartBefore(span).collapse(true);
                    rng.select();
                    domUtils.remove(span)
                }else{
                    rng.select()
                }

            }
        }


    })
};

// plugins/fiximgclick.js
///import core
///commands 修复chrome下图片不能点击的问题，出现八个角可改变大小
///commandsName  FixImgClick
///commandsTitle  修复chrome下图片不能点击的问题，出现八个角可改变大小
//修复chrome下图片不能点击的问题，出现八个角可改变大小

UE.plugins['fiximgclick'] = (function () {

    var elementUpdated = false;
    function Scale() {
        this.editor = null;
        this.resizer = null;
        this.cover = null;
        this.doc = document;
        this.prePos = {x: 0, y: 0};
        this.startPos = {x: 0, y: 0};
    }

    (function () {
        var rect = [
            //[left, top, width, height]
            [0, 0, -1, -1],
            [0, 0, 0, -1],
            [0, 0, 1, -1],
            [0, 0, -1, 0],
            [0, 0, 1, 0],
            [0, 0, -1, 1],
            [0, 0, 0, 1],
            [0, 0, 1, 1]
        ];

        Scale.prototype = {
            init: function (editor) {
                var me = this;
                me.editor = editor;
                me.startPos = this.prePos = {x: 0, y: 0};
                me.dragId = -1;

                var hands = [],
                    cover = me.cover = document.createElement('div'),
                    resizer = me.resizer = document.createElement('div');

                cover.id = me.editor.ui.id + '_imagescale_cover';
                cover.style.cssText = 'position:absolute;display:none;z-index:' + (me.editor.options.zIndex) + ';filter:alpha(opacity=0); opacity:0;background:#CCC;';
                domUtils.on(cover, 'mousedown click', function () {
                    me.hide();
                });

                for (i = 0; i < 8; i++) {
                    hands.push('<span class="edui-editor-imagescale-hand' + i + '"></span>');
                }
                resizer.id = me.editor.ui.id + '_imagescale';
                resizer.className = 'edui-editor-imagescale';
                resizer.innerHTML = hands.join('');
                resizer.style.cssText += ';display:none;border:1px solid #3b77ff;z-index:' + (me.editor.options.zIndex) + ';';

                me.editor.ui.getDom().appendChild(cover);
                me.editor.ui.getDom().appendChild(resizer);

                me.initStyle();
                me.initEvents();
            },
            initStyle: function () {
                utils.cssRule('imagescale', '.edui-editor-imagescale{display:none;position:absolute;border:1px solid #38B2CE;cursor:hand;-webkit-box-sizing: content-box;-moz-box-sizing: content-box;box-sizing: content-box;}' +
                    '.edui-editor-imagescale span{position:absolute;width:6px;height:6px;overflow:hidden;font-size:0px;display:block;background-color:#3C9DD0;}'
                    + '.edui-editor-imagescale .edui-editor-imagescale-hand0{cursor:nw-resize;top:0;margin-top:-4px;left:0;margin-left:-4px;}'
                    + '.edui-editor-imagescale .edui-editor-imagescale-hand1{cursor:n-resize;top:0;margin-top:-4px;left:50%;margin-left:-4px;}'
                    + '.edui-editor-imagescale .edui-editor-imagescale-hand2{cursor:ne-resize;top:0;margin-top:-4px;left:100%;margin-left:-3px;}'
                    + '.edui-editor-imagescale .edui-editor-imagescale-hand3{cursor:w-resize;top:50%;margin-top:-4px;left:0;margin-left:-4px;}'
                    + '.edui-editor-imagescale .edui-editor-imagescale-hand4{cursor:e-resize;top:50%;margin-top:-4px;left:100%;margin-left:-3px;}'
                    + '.edui-editor-imagescale .edui-editor-imagescale-hand5{cursor:sw-resize;top:100%;margin-top:-3px;left:0;margin-left:-4px;}'
                    + '.edui-editor-imagescale .edui-editor-imagescale-hand6{cursor:s-resize;top:100%;margin-top:-3px;left:50%;margin-left:-4px;}'
                    + '.edui-editor-imagescale .edui-editor-imagescale-hand7{cursor:se-resize;top:100%;margin-top:-3px;left:100%;margin-left:-3px;}');
            },
            initEvents: function () {
                var me = this;

                me.startPos.x = me.startPos.y = 0;
                me.isDraging = false;
            },
            _eventHandler: function (e) {
                var me = this;
                switch (e.type) {
                    case 'mousedown':
                        var hand = e.target || e.srcElement, hand;
                        if (hand.className.indexOf('edui-editor-imagescale-hand') != -1 && me.dragId == -1) {
                            me.dragId = hand.className.slice(-1);
                            me.startPos.x = me.prePos.x = e.clientX;
                            me.startPos.y = me.prePos.y = e.clientY;
                            domUtils.on(me.doc,'mousemove', me.proxy(me._eventHandler, me));
                        }
                        break;
                    case 'mousemove':
                        if (me.dragId != -1) {
                            me.updateContainerStyle(me.dragId, {x: e.clientX - me.prePos.x, y: e.clientY - me.prePos.y});
                            me.prePos.x = e.clientX;
                            me.prePos.y = e.clientY;
                            elementUpdated = true;
                            me.updateTargetElement();

                        }
                        break;
                    case 'mouseup':
                        if (me.dragId != -1) {
                            me.updateContainerStyle(me.dragId, {x: e.clientX - me.prePos.x, y: e.clientY - me.prePos.y});
                            me.updateTargetElement();
                            if (me.target.parentNode) me.attachTo(me.target);
                            me.dragId = -1;
                        }
                        domUtils.un(me.doc,'mousemove', me.proxy(me._eventHandler, me));
                        //修复只是点击挪动点，但没有改变大小，不应该触发contentchange
                        if(elementUpdated){
                            elementUpdated = false;
                            me.editor.fireEvent('contentchange');
                        }

                        break;
                    default:
                        break;
                }
            },
            updateTargetElement: function () {
                var me = this;
                domUtils.setStyles(me.target, {
                    'width': me.resizer.style.width,
                    'height': me.resizer.style.height
                });
                me.target.width = parseInt(me.resizer.style.width);
                me.target.height = parseInt(me.resizer.style.height);
                me.attachTo(me.target);
            },
            updateContainerStyle: function (dir, offset) {
                var me = this,
                    dom = me.resizer, tmp;

                if (rect[dir][0] != 0) {
                    tmp = parseInt(dom.style.left) + offset.x;
                    dom.style.left = me._validScaledProp('left', tmp) + 'px';
                }
                if (rect[dir][1] != 0) {
                    tmp = parseInt(dom.style.top) + offset.y;
                    dom.style.top = me._validScaledProp('top', tmp) + 'px';
                }
                if (rect[dir][2] != 0) {
                    tmp = dom.clientWidth + rect[dir][2] * offset.x;
                    dom.style.width = me._validScaledProp('width', tmp) + 'px';
                }
                if (rect[dir][3] != 0) {
                    tmp = dom.clientHeight + rect[dir][3] * offset.y;
                    dom.style.height = me._validScaledProp('height', tmp) + 'px';
                }
            },
            _validScaledProp: function (prop, value) {
                var ele = this.resizer,
                    wrap = document;

                value = isNaN(value) ? 0 : value;
                switch (prop) {
                    case 'left':
                        return value < 0 ? 0 : (value + ele.clientWidth) > wrap.clientWidth ? wrap.clientWidth - ele.clientWidth : value;
                    case 'top':
                        return value < 0 ? 0 : (value + ele.clientHeight) > wrap.clientHeight ? wrap.clientHeight - ele.clientHeight : value;
                    case 'width':
                        return value <= 0 ? 1 : (value + ele.offsetLeft) > wrap.clientWidth ? wrap.clientWidth - ele.offsetLeft : value;
                    case 'height':
                        return value <= 0 ? 1 : (value + ele.offsetTop) > wrap.clientHeight ? wrap.clientHeight - ele.offsetTop : value;
                }
            },
            hideCover: function () {
                this.cover.style.display = 'none';
            },
            showCover: function () {
                var me = this,
                    editorPos = domUtils.getXY(me.editor.ui.getDom()),
                    iframePos = domUtils.getXY(me.editor.iframe);

                domUtils.setStyles(me.cover, {
                    'width': me.editor.iframe.offsetWidth + 'px',
                    'height': me.editor.iframe.offsetHeight + 'px',
                    'top': iframePos.y - editorPos.y + 'px',
                    'left': iframePos.x - editorPos.x + 'px',
                    'position': 'absolute',
                    'display': ''
                })
            },
            show: function (targetObj) {
                var me = this;
                me.resizer.style.display = 'block';
                if(targetObj) me.attachTo(targetObj);

                domUtils.on(this.resizer, 'mousedown', me.proxy(me._eventHandler, me));
                domUtils.on(me.doc, 'mouseup', me.proxy(me._eventHandler, me));

                me.showCover();
                me.editor.fireEvent('afterscaleshow', me);
                me.editor.fireEvent('saveScene');
            },
            hide: function () {
                var me = this;
                me.hideCover();
                me.resizer.style.display = 'none';

                domUtils.un(me.resizer, 'mousedown', me.proxy(me._eventHandler, me));
                domUtils.un(me.doc, 'mouseup', me.proxy(me._eventHandler, me));
                me.editor.fireEvent('afterscalehide', me);
            },
            proxy: function( fn, context ) {
                return function(e) {
                    return fn.apply( context || this, arguments);
                };
            },
            attachTo: function (targetObj) {
                var me = this,
                    target = me.target = targetObj,
                    resizer = this.resizer,
                    imgPos = domUtils.getXY(target),
                    iframePos = domUtils.getXY(me.editor.iframe),
                    editorPos = domUtils.getXY(resizer.parentNode);

                domUtils.setStyles(resizer, {
                    'width': target.width + 'px',
                    'height': target.height + 'px',
                    'left': iframePos.x + imgPos.x - me.editor.document.body.scrollLeft - editorPos.x - parseInt(resizer.style.borderLeftWidth) + 'px',
                    'top': iframePos.y + imgPos.y - me.editor.document.body.scrollTop - editorPos.y - parseInt(resizer.style.borderTopWidth) + 'px'
                });
            }
        }
    })();

    return function () {
        var me = this,
            imageScale;

        me.setOpt('imageScaleEnabled', true);

        if ( !browser.ie && me.options.imageScaleEnabled) {
            me.addListener('click', function (type, e) {

                var range = me.selection.getRange(),
                    img = range.getClosedNode();

                if (img && img.tagName == 'IMG' && me.body.contentEditable!="false") {

                    if (img.className.indexOf("edui-faked-music") != -1 ||
                        img.getAttribute("anchorname") ||
                        domUtils.hasClass(img, 'loadingclass') ||
                        domUtils.hasClass(img, 'loaderrorclass')) { return }

                    if (!imageScale) {
                        imageScale = new Scale();
                        imageScale.init(me);
                        me.ui.getDom().appendChild(imageScale.resizer);

                        var _keyDownHandler = function (e) {
                            imageScale.hide();
                            if(imageScale.target) me.selection.getRange().selectNode(imageScale.target).select();
                        }, _mouseDownHandler = function (e) {
                            var ele = e.target || e.srcElement;
                            if (ele && (ele.className===undefined || ele.className.indexOf('edui-editor-imagescale') == -1)) {
                                _keyDownHandler(e);
                            }
                        }, timer;

                        me.addListener('afterscaleshow', function (e) {
                            me.addListener('beforekeydown', _keyDownHandler);
                            me.addListener('beforemousedown', _mouseDownHandler);
                            domUtils.on(document, 'keydown', _keyDownHandler);
                            domUtils.on(document,'mousedown', _mouseDownHandler);
                            me.selection.getNative().removeAllRanges();
                        });
                        me.addListener('afterscalehide', function (e) {
                            me.removeListener('beforekeydown', _keyDownHandler);
                            me.removeListener('beforemousedown', _mouseDownHandler);
                            domUtils.un(document, 'keydown', _keyDownHandler);
                            domUtils.un(document,'mousedown', _mouseDownHandler);
                            var target = imageScale.target;
                            if (target.parentNode) {
                                me.selection.getRange().selectNode(target).select();
                            }
                        });
                        //TODO 有iframe的情况，mousedown不能往下传。。
                        domUtils.on(imageScale.resizer, 'mousedown', function (e) {
                            me.selection.getNative().removeAllRanges();
                            var ele = e.target || e.srcElement;
                            if (ele && ele.className.indexOf('edui-editor-imagescale-hand') == -1) {
                                timer = setTimeout(function () {
                                    imageScale.hide();
                                    if(imageScale.target) me.selection.getRange().selectNode(ele).select();
                                }, 200);
                            }
                        });
                        domUtils.on(imageScale.resizer, 'mouseup', function (e) {
                            var ele = e.target || e.srcElement;
                            if (ele && ele.className.indexOf('edui-editor-imagescale-hand') == -1) {
                                clearTimeout(timer);
                            }
                        });
                    }
                    imageScale.show(img);
                } else {
                    if (imageScale && imageScale.resizer.style.display != 'none') imageScale.hide();
                }
            });
        }

        if (browser.webkit) {
            me.addListener('click', function (type, e) {
                if (e.target.tagName == 'IMG' && me.body.contentEditable!="false") {
                    var range = new dom.Range(me.document);
                    range.selectNode(e.target).select();
                }
            });
        }
    }
})();

// plugins/autolink.js
///import core
///commands 为非ie浏览器自动添加a标签
///commandsName  AutoLink
///commandsTitle  自动增加链接
/**
 * @description 为非ie浏览器自动添加a标签
 * @author zhanyi
 */

UE.plugin.register('autolink',function(){
    var cont = 0;

    return !browser.ie ? {

            bindEvents:{
                'reset' : function(){
                    cont = 0;
                },
                'keydown':function(type, evt) {
                    var me = this;
                    var keyCode = evt.keyCode || evt.which;

                    if (keyCode == 32 || keyCode == 13) {

                        var sel = me.selection.getNative(),
                            range = sel.getRangeAt(0).cloneRange(),
                            offset,
                            charCode;

                        var start = range.startContainer;
                        while (start.nodeType == 1 && range.startOffset > 0) {
                            start = range.startContainer.childNodes[range.startOffset - 1];
                            if (!start){
                                break;
                            }
                            range.setStart(start, start.nodeType == 1 ? start.childNodes.length : start.nodeValue.length);
                            range.collapse(true);
                            start = range.startContainer;
                        }

                        do{
                            if (range.startOffset == 0) {
                                start = range.startContainer.previousSibling;

                                while (start && start.nodeType == 1) {
                                    start = start.lastChild;
                                }
                                if (!start || domUtils.isFillChar(start)){
                                    break;
                                }
                                offset = start.nodeValue.length;
                            } else {
                                start = range.startContainer;
                                offset = range.startOffset;
                            }
                            range.setStart(start, offset - 1);
                            charCode = range.toString().charCodeAt(0);
                        } while (charCode != 160 && charCode != 32);

                        if (range.toString().replace(new RegExp(domUtils.fillChar, 'g'), '').match(/(?:https?:\/\/|ssh:\/\/|ftp:\/\/|file:\/|www\.)/i)) {
                            while(range.toString().length){
                                if(/^(?:https?:\/\/|ssh:\/\/|ftp:\/\/|file:\/|www\.)/i.test(range.toString())){
                                    break;
                                }
                                try{
                                    range.setStart(range.startContainer,range.startOffset+1);
                                }catch(e){
                                    //trace:2121
                                    var start = range.startContainer;
                                    while(!(next = start.nextSibling)){
                                        if(domUtils.isBody(start)){
                                            return;
                                        }
                                        start = start.parentNode;

                                    }
                                    range.setStart(next,0);

                                }

                            }
                            //range的开始边界已经在a标签里的不再处理
                            if(domUtils.findParentByTagName(range.startContainer,'a',true)){
                                return;
                            }
                            var a = me.document.createElement('a'),text = me.document.createTextNode(' '),href;

                            me.undoManger && me.undoManger.save();
                            a.appendChild(range.extractContents());
                            a.href = a.innerHTML = a.innerHTML.replace(/<[^>]+>/g,'');
                            href = a.getAttribute("href").replace(new RegExp(domUtils.fillChar,'g'),'');
                            href = /^(?:https?:\/\/)/ig.test(href) ? href : "http://"+ href;
                            a.setAttribute('_src',utils.html(href));
                            a.href = utils.html(href);

                            range.insertNode(a);
                            a.parentNode.insertBefore(text, a.nextSibling);
                            range.setStart(text, 0);
                            range.collapse(true);
                            sel.removeAllRanges();
                            sel.addRange(range);
                            me.undoManger && me.undoManger.save();
                        }
                    }
                }
            }
        }:{}
    },function(){
        var keyCodes = {
            37:1, 38:1, 39:1, 40:1,
            13:1,32:1
        };
        function checkIsCludeLink(node){
            if(node.nodeType == 3){
                return null
            }
            if(node.nodeName == 'A'){
                return node;
            }
            var lastChild = node.lastChild;

            while(lastChild){
                if(lastChild.nodeName == 'A'){
                    return lastChild;
                }
                if(lastChild.nodeType == 3){
                    if(domUtils.isWhitespace(lastChild)){
                        lastChild = lastChild.previousSibling;
                        continue;
                    }
                    return null
                }
                lastChild = lastChild.lastChild;
            }
        }
        browser.ie && this.addListener('keyup',function(cmd,evt){
            var me = this,keyCode = evt.keyCode;
            if(keyCodes[keyCode]){
                var rng = me.selection.getRange();
                var start = rng.startContainer;

                if(keyCode == 13){
                    while(start && !domUtils.isBody(start) && !domUtils.isBlockElm(start)){
                        start = start.parentNode;
                    }
                    if(start && !domUtils.isBody(start) && start.nodeName == 'P'){
                        var pre = start.previousSibling;
                        if(pre && pre.nodeType == 1){
                            var pre = checkIsCludeLink(pre);
                            if(pre && !pre.getAttribute('_href')){
                                domUtils.remove(pre,true);
                            }
                        }
                    }
                }else if(keyCode == 32 ){
                    if(start.nodeType == 3 && /^\s$/.test(start.nodeValue)){
                        start = start.previousSibling;
                        if(start && start.nodeName == 'A' && !start.getAttribute('_href')){
                            domUtils.remove(start,true);
                        }
                    }
                }else {
                    start = domUtils.findParentByTagName(start,'a',true);
                    if(start && !start.getAttribute('_href')){
                        var bk = rng.createBookmark();

                        domUtils.remove(start,true);
                        rng.moveToBookmark(bk).select(true)
                    }
                }

            }


        });
    }
);

// plugins/autoheight.js
///import core
///commands 当输入内容超过编辑器高度时，编辑器自动增高
///commandsName  AutoHeight,autoHeightEnabled
///commandsTitle  自动增高
/**
 * @description 自动伸展
 * @author zhanyi
 */
UE.plugins['autoheight'] = function () {
    var me = this;
    //提供开关，就算加载也可以关闭
    me.autoHeightEnabled = me.options.autoHeightEnabled !== false;
    if (!me.autoHeightEnabled) {
        return;
    }

    var bakOverflow,
        lastHeight = 0,
        options = me.options,
        currentHeight,
        timer;

    function adjustHeight() {
        var me = this;
        clearTimeout(timer);
        if(isFullscreen)return;
        if (!me.queryCommandState || me.queryCommandState && me.queryCommandState('source') != 1) {
            timer = setTimeout(function(){

                var node = me.body.lastChild;
                while(node && node.nodeType != 1){
                    node = node.previousSibling;
                }
                if(node && node.nodeType == 1){
                    node.style.clear = 'both';
                    currentHeight = Math.max(domUtils.getXY(node).y + node.offsetHeight + 25 ,Math.max(options.minFrameHeight, options.initialFrameHeight)) ;
                    if (currentHeight != lastHeight) {
                        if (currentHeight !== parseInt(me.iframe.parentNode.style.height)) {
                            me.iframe.parentNode.style.height = currentHeight + 'px';
                        }
                        me.body.style.height = currentHeight + 'px';
                        lastHeight = currentHeight;
                    }
                    domUtils.removeStyle(node,'clear');
                }


            },50)
        }
    }
    var isFullscreen;
    me.addListener('fullscreenchanged',function(cmd,f){
        isFullscreen = f
    });
    me.addListener('destroy', function () {
        me.removeListener('contentchange afterinserthtml keyup mouseup',adjustHeight)
    });
    me.enableAutoHeight = function () {
        var me = this;
        if (!me.autoHeightEnabled) {
            return;
        }
        var doc = me.document;
        me.autoHeightEnabled = true;
        bakOverflow = doc.body.style.overflowY;
        doc.body.style.overflowY = 'hidden';
        me.addListener('contentchange afterinserthtml keyup mouseup',adjustHeight);
        //ff不给事件算得不对

        setTimeout(function () {
            adjustHeight.call(me);
        }, browser.gecko ? 100 : 0);
        me.fireEvent('autoheightchanged', me.autoHeightEnabled);
    };
    me.disableAutoHeight = function () {

        me.body.style.overflowY = bakOverflow || '';

        me.removeListener('contentchange', adjustHeight);
        me.removeListener('keyup', adjustHeight);
        me.removeListener('mouseup', adjustHeight);
        me.autoHeightEnabled = false;
        me.fireEvent('autoheightchanged', me.autoHeightEnabled);
    };

    me.on('setHeight',function(){
        me.disableAutoHeight()
    });
    me.addListener('ready', function () {
        me.enableAutoHeight();
        //trace:1764
        var timer;
        domUtils.on(browser.ie ? me.body : me.document, browser.webkit ? 'dragover' : 'drop', function () {
            clearTimeout(timer);
            timer = setTimeout(function () {
                //trace:3681
                adjustHeight.call(me);
            }, 100);

        });
        //修复内容过多时，回到顶部，顶部内容被工具栏遮挡问题
        var lastScrollY;
        window.onscroll = function(){
            if(lastScrollY === null){
                lastScrollY = this.scrollY
            }else if(this.scrollY == 0 && lastScrollY != 0){
                me.window.scrollTo(0,0);
                lastScrollY = null;
            }
        }
    });


};



// plugins/autofloat.js
///import core
///commands 悬浮工具栏
///commandsName  AutoFloat,autoFloatEnabled
///commandsTitle  悬浮工具栏
/**
 *  modified by chengchao01
 *  注意： 引入此功能后，在IE6下会将body的背景图片覆盖掉！
 */
UE.plugins['autofloat'] = function() {
    var me = this,
        lang = me.getLang();
    me.setOpt({
        topOffset:0
    });
    var optsAutoFloatEnabled = me.options.autoFloatEnabled !== false,
        topOffset = me.options.topOffset;


    //如果不固定toolbar的位置，则直接退出
    if(!optsAutoFloatEnabled){
        return;
    }
    var uiUtils = UE.ui.uiUtils,
        LteIE6 = browser.ie && browser.version <= 6,
        quirks = browser.quirks;

    function checkHasUI(){
        if(!UE.ui){
            alert(lang.autofloatMsg);
            return 0;
        }
        return 1;
    }
    function fixIE6FixedPos(){
        var docStyle = document.body.style;
        docStyle.backgroundImage = 'url("about:blank")';
        docStyle.backgroundAttachment = 'fixed';
    }
    var	bakCssText,
        placeHolder = document.createElement('div'),
        toolbarBox,orgTop,
        getPosition,
        flag =true;   //ie7模式下需要偏移
    function setFloating(){
        var toobarBoxPos = domUtils.getXY(toolbarBox),
            origalFloat = domUtils.getComputedStyle(toolbarBox,'position'),
            origalLeft = domUtils.getComputedStyle(toolbarBox,'left');
        toolbarBox.style.width = toolbarBox.offsetWidth + 'px';
        toolbarBox.style.zIndex = me.options.zIndex * 1 + 1;
        toolbarBox.parentNode.insertBefore(placeHolder, toolbarBox);
        if (LteIE6 || (quirks && browser.ie)) {
            if(toolbarBox.style.position != 'absolute'){
                toolbarBox.style.position = 'absolute';
            }
            toolbarBox.style.top = (document.body.scrollTop||document.documentElement.scrollTop) - orgTop + topOffset  + 'px';
        } else {
            if (browser.ie7Compat && flag) {
                flag = false;
                toolbarBox.style.left =  domUtils.getXY(toolbarBox).x - document.documentElement.getBoundingClientRect().left+2  + 'px';
            }
            if(toolbarBox.style.position != 'fixed'){
                toolbarBox.style.position = 'fixed';
                toolbarBox.style.top = topOffset +"px";
                ((origalFloat == 'absolute' || origalFloat == 'relative') && parseFloat(origalLeft)) && (toolbarBox.style.left = toobarBoxPos.x + 'px');
            }
        }
    }
    function unsetFloating(){
        flag = true;
        if(placeHolder.parentNode){
            placeHolder.parentNode.removeChild(placeHolder);
        }

        toolbarBox.style.cssText = bakCssText;
    }

    function updateFloating(){
        var rect3 = getPosition(me.container);
        var offset=me.options.toolbarTopOffset||0;
        if (rect3.top < 0 && rect3.bottom - toolbarBox.offsetHeight > offset) {
            setFloating();
        }else{
            unsetFloating();
        }
    }
    var defer_updateFloating = utils.defer(function(){
        updateFloating();
    },browser.ie ? 200 : 100,true);

    me.addListener('destroy',function(){
        domUtils.un(window, ['scroll','resize'], updateFloating);
        me.removeListener('keydown', defer_updateFloating);
    });

    me.addListener('ready', function(){
        if(checkHasUI(me)){
            //加载了ui组件，但在new时，没有加载ui，导致编辑器实例上没有ui类，所以这里做判断
            if(!me.ui){
                return;
            }
            getPosition = uiUtils.getClientRect;
            toolbarBox = me.ui.getDom('toolbarbox');
            orgTop = getPosition(toolbarBox).top;
            bakCssText = toolbarBox.style.cssText;
            placeHolder.style.height = toolbarBox.offsetHeight + 'px';
            if(LteIE6){
                fixIE6FixedPos();
            }
            domUtils.on(window, ['scroll','resize'], updateFloating);
            me.addListener('keydown', defer_updateFloating);

            me.addListener('beforefullscreenchange', function (t, enabled){
                if (enabled) {
                    unsetFloating();
                }
            });
            me.addListener('fullscreenchanged', function (t, enabled){
                if (!enabled) {
                    updateFloating();
                }
            });
            me.addListener('sourcemodechanged', function (t, enabled){
                setTimeout(function (){
                    updateFloating();
                },0);
            });
            me.addListener("clearDoc",function(){
                setTimeout(function(){
                    updateFloating();
                },0);

            })
        }
    });
};


// plugins/video.js
/**
 * video插件， 为UEditor提供视频插入支持
 * @file
 * @since 1.2.6.1
 */

UE.plugins['video'] = function (){
    var me =this;

    /**
     * 创建插入视频字符窜
     * @param url 视频地址
     * @param width 视频宽度
     * @param height 视频高度
     * @param align 视频对齐
     * @param toEmbed 是否以flash代替显示
     * @param addParagraph  是否需要添加P 标签
     */
    function creatInsertStr(url,width,height,id,align,classname,type){

        url = utils.unhtmlForUrl(url);
        align = utils.unhtml(align);
        classname = utils.unhtml(classname);

        width = parseInt(width, 10) || 0;
        height = parseInt(height, 10) || 0;

        var str;
        switch (type){
            case 'image':
                str = '<img ' + (id ? 'id="' + id+'"' : '') + ' width="'+ width +'" height="' + height + '" _url="'+url+'" class="' + classname.replace(/\bvideo-js\b/, '') + '"'  +
                    ' src="' + me.options.UEDITOR_HOME_URL+'themes/default/images/spacer.gif" style="background:url('+me.options.UEDITOR_HOME_URL+'themes/default/images/videologo.gif) no-repeat center center; border:1px solid gray;'+(align ? 'float:' + align + ';': '')+'" />'
                break;
            case 'embed':
                str = '<embed type="application/x-shockwave-flash" class="' + classname + '" pluginspage="http://www.macromedia.com/go/getflashplayer"' +
                    ' src="' +  utils.html(url) + '" width="' + width  + '" height="' + height  + '"'  + (align ? ' style="float:' + align + '"': '') +
                    ' wmode="transparent" play="true" loop="false" menu="false" allowscriptaccess="never" allowfullscreen="true" >';
                break;
            case 'video':
                var ext = url.substr(url.lastIndexOf('.') + 1);
                if(ext == 'ogv') ext = 'ogg';
                str = '<video' + (id ? ' id="' + id + '"' : '') + ' class="' + classname + ' video-js" ' + (align ? ' style="float:' + align + '"': '') +
                    ' controls preload="none" width="' + width + '" height="' + height + '" src="' + url + '" data-setup="{}">' +
                    '<source src="' + url + '" type="video/' + ext + '" /></video>';
                break;
        }
        return str;
    }

    function switchImgAndVideo(root,img2video){
        utils.each(root.getNodesByTagName(img2video ? 'img' : 'embed video'),function(node){
            var className = node.getAttr('class');
            if(className && className.indexOf('edui-faked-video') != -1){
                var html = creatInsertStr( img2video ? node.getAttr('_url') : node.getAttr('src'),node.getAttr('width'),node.getAttr('height'),null,node.getStyle('float') || '',className,img2video ? 'embed':'image');
                node.parentNode.replaceChild(UE.uNode.createElement(html),node);
            }
            if(className && className.indexOf('edui-upload-video') != -1){
                var html = creatInsertStr( img2video ? node.getAttr('_url') : node.getAttr('src'),node.getAttr('width'),node.getAttr('height'),null,node.getStyle('float') || '',className,img2video ? 'video':'image');
                node.parentNode.replaceChild(UE.uNode.createElement(html),node);
            }
        })
    }

    me.addOutputRule(function(root){
        switchImgAndVideo(root,true)
    });
    me.addInputRule(function(root){
        switchImgAndVideo(root)
    });

    /**
     * 插入视频
     * @command insertvideo
     * @method execCommand
     * @param { String } cmd 命令字符串
     * @param { Object } videoAttr 键值对对象， 描述一个视频的所有属性
     * @example
     * ```javascript
     *
     * var videoAttr = {
     *      //视频地址
     *      url: 'http://www.youku.com/xxx',
     *      //视频宽高值， 单位px
     *      width: 200,
     *      height: 100
     * };
     *
     * //editor 是编辑器实例
     * //向编辑器插入单个视频
     * editor.execCommand( 'insertvideo', videoAttr );
     * ```
     */

    /**
     * 插入视频
     * @command insertvideo
     * @method execCommand
     * @param { String } cmd 命令字符串
     * @param { Array } videoArr 需要插入的视频的数组， 其中的每一个元素都是一个键值对对象， 描述了一个视频的所有属性
     * @example
     * ```javascript
     *
     * var videoAttr1 = {
     *      //视频地址
     *      url: 'http://www.youku.com/xxx',
     *      //视频宽高值， 单位px
     *      width: 200,
     *      height: 100
     * },
     * videoAttr2 = {
     *      //视频地址
     *      url: 'http://www.youku.com/xxx',
     *      //视频宽高值， 单位px
     *      width: 200,
     *      height: 100
     * }
     *
     * //editor 是编辑器实例
     * //该方法将会向编辑器内插入两个视频
     * editor.execCommand( 'insertvideo', [ videoAttr1, videoAttr2 ] );
     * ```
     */

    /**
     * 查询当前光标所在处是否是一个视频
     * @command insertvideo
     * @method queryCommandState
     * @param { String } cmd 需要查询的命令字符串
     * @return { int } 如果当前光标所在处的元素是一个视频对象， 则返回1，否则返回0
     * @example
     * ```javascript
     *
     * //editor 是编辑器实例
     * editor.queryCommandState( 'insertvideo' );
     * ```
     */
    me.commands["insertvideo"] = {
        execCommand: function (cmd, videoObjs, type){
            videoObjs = utils.isArray(videoObjs)?videoObjs:[videoObjs];
            var html = [],id = 'tmpVedio', cl;
            for(var i=0,vi,len = videoObjs.length;i<len;i++){
                vi = videoObjs[i];
                cl = (type == 'upload' ? 'edui-upload-video video-js vjs-default-skin':'edui-faked-video');
                html.push(creatInsertStr( vi.url, vi.width || 420,  vi.height || 280, id + i, null, cl, 'image'));
            }
            me.execCommand("inserthtml",html.join(""),true);
            var rng = this.selection.getRange();
            for(var i= 0,len=videoObjs.length;i<len;i++){
                var img = this.document.getElementById('tmpVedio'+i);
                domUtils.removeAttributes(img,'id');
                rng.selectNode(img).select();
                me.execCommand('imagefloat',videoObjs[i].align)
            }
        },
        queryCommandState : function(){
            var img = me.selection.getRange().getClosedNode(),
                flag = img && (img.className == "edui-faked-video" || img.className.indexOf("edui-upload-video")!=-1);
            return flag ? 1 : 0;
        }
    };
};


// plugins/table.core.js
/**
 * Created with JetBrains WebStorm.
 * User: taoqili
 * Date: 13-1-18
 * Time: 上午11:09
 * To change this template use File | Settings | File Templates.
 */
/**
 * UE表格操作类
 * @param table
 * @constructor
 */
(function () {
    var UETable = UE.UETable = function (table) {
        this.table = table;
        this.indexTable = [];
        this.selectedTds = [];
        this.cellsRange = {};
        this.update(table);
    };

    //===以下为静态工具方法===
    UETable.removeSelectedClass = function (cells) {
        utils.each(cells, function (cell) {
            domUtils.removeClasses(cell, "selectTdClass");
        })
    };
    UETable.addSelectedClass = function (cells) {
        utils.each(cells, function (cell) {
            domUtils.addClass(cell, "selectTdClass");
        })
    };
    UETable.isEmptyBlock = function (node) {
        var reg = new RegExp(domUtils.fillChar, 'g');
        if (node[browser.ie ? 'innerText' : 'textContent'].replace(/^\s*$/, '').replace(reg, '').length > 0) {
            return 0;
        }
        for (var i in dtd.$isNotEmpty) if (dtd.$isNotEmpty.hasOwnProperty(i)) {
            if (node.getElementsByTagName(i).length) {
                return 0;
            }
        }
        return 1;
    };
    UETable.getWidth = function (cell) {
        if (!cell)return 0;
        return parseInt(domUtils.getComputedStyle(cell, "width"), 10);
    };

    /**
     * 获取单元格或者单元格组的“对齐”状态。 如果当前的检测对象是一个单元格组， 只有在满足所有单元格的 水平和竖直 对齐属性都相同的
     * 条件时才会返回其状态值，否则将返回null； 如果当前只检测了一个单元格， 则直接返回当前单元格的对齐状态；
     * @param table cell or table cells , 支持单个单元格dom对象 或者 单元格dom对象数组
     * @return { align: 'left' || 'right' || 'center', valign: 'top' || 'middle' || 'bottom' } 或者 null
     */
    UETable.getTableCellAlignState = function ( cells ) {

        !utils.isArray( cells ) && ( cells = [cells] );

        var result = {},
            status = ['align', 'valign'],
            tempStatus = null,
            isSame = true;//状态是否相同

        utils.each( cells, function( cellNode ){

            utils.each( status, function( currentState ){

                tempStatus = cellNode.getAttribute( currentState );

                if( !result[ currentState ] && tempStatus ) {
                    result[ currentState ] = tempStatus;
                } else if( !result[ currentState ] || ( tempStatus !== result[ currentState ] ) ) {
                    isSame = false;
                    return false;
                }

            } );

            return isSame;

        });

        return isSame ? result : null;

    };

    /**
     * 根据当前选区获取相关的table信息
     * @return {Object}
     */
    UETable.getTableItemsByRange = function (editor) {
        var start = editor.selection.getStart();

        //ff下会选中bookmark
        if( start && start.id && start.id.indexOf('_baidu_bookmark_start_') === 0 && start.nextSibling) {
            start = start.nextSibling;
        }

        //在table或者td边缘有可能存在选中tr的情况
        var cell = start && domUtils.findParentByTagName(start, ["td", "th"], true),
            tr = cell && cell.parentNode,
            caption = start && domUtils.findParentByTagName(start, 'caption', true),
            table = caption ? caption.parentNode : tr && tr.parentNode.parentNode;

        return {
            cell:cell,
            tr:tr,
            table:table,
            caption:caption
        }
    };
    UETable.getUETableBySelected = function (editor) {
        var table = UETable.getTableItemsByRange(editor).table;
        if (table && table.ueTable && table.ueTable.selectedTds.length) {
            return table.ueTable;
        }
        return null;
    };

    UETable.getDefaultValue = function (editor, table) {
        var borderMap = {
                thin:'0px',
                medium:'1px',
                thick:'2px'
            },
            tableBorder, tdPadding, tdBorder, tmpValue;
        if (!table) {
            table = editor.document.createElement('table');
            table.insertRow(0).insertCell(0).innerHTML = 'xxx';
            editor.body.appendChild(table);
            var td = table.getElementsByTagName('td')[0];
            tmpValue = domUtils.getComputedStyle(table, 'border-left-width');
            tableBorder = parseInt(borderMap[tmpValue] || tmpValue, 10);
            tmpValue = domUtils.getComputedStyle(td, 'padding-left');
            tdPadding = parseInt(borderMap[tmpValue] || tmpValue, 10);
            tmpValue = domUtils.getComputedStyle(td, 'border-left-width');
            tdBorder = parseInt(borderMap[tmpValue] || tmpValue, 10);
            domUtils.remove(table);
            return {
                tableBorder:tableBorder,
                tdPadding:tdPadding,
                tdBorder:tdBorder
            };
        } else {
            td = table.getElementsByTagName('td')[0];
            tmpValue = domUtils.getComputedStyle(table, 'border-left-width');
            tableBorder = parseInt(borderMap[tmpValue] || tmpValue, 10);
            tmpValue = domUtils.getComputedStyle(td, 'padding-left');
            tdPadding = parseInt(borderMap[tmpValue] || tmpValue, 10);
            tmpValue = domUtils.getComputedStyle(td, 'border-left-width');
            tdBorder = parseInt(borderMap[tmpValue] || tmpValue, 10);
            return {
                tableBorder:tableBorder,
                tdPadding:tdPadding,
                tdBorder:tdBorder
            };
        }
    };
    /**
     * 根据当前点击的td或者table获取索引对象
     * @param tdOrTable
     */
    UETable.getUETable = function (tdOrTable) {
        var tag = tdOrTable.tagName.toLowerCase();
        tdOrTable = (tag == "td" || tag == "th" || tag == 'caption') ? domUtils.findParentByTagName(tdOrTable, "table", true) : tdOrTable;
        if (!tdOrTable.ueTable) {
            tdOrTable.ueTable = new UETable(tdOrTable);
        }
        return tdOrTable.ueTable;
    };

    UETable.cloneCell = function(cell,ignoreMerge,keepPro){
        if (!cell || utils.isString(cell)) {
            return this.table.ownerDocument.createElement(cell || 'td');
        }
        var flag = domUtils.hasClass(cell, "selectTdClass");
        flag && domUtils.removeClasses(cell, "selectTdClass");
        var tmpCell = cell.cloneNode(true);
        if (ignoreMerge) {
            tmpCell.rowSpan = tmpCell.colSpan = 1;
        }
        //去掉宽高
        !keepPro && domUtils.removeAttributes(tmpCell,'width height');
        !keepPro && domUtils.removeAttributes(tmpCell,'style');

        tmpCell.style.borderLeftStyle = "";
        tmpCell.style.borderTopStyle = "";
        tmpCell.style.borderLeftColor = cell.style.borderRightColor;
        tmpCell.style.borderLeftWidth = cell.style.borderRightWidth;
        tmpCell.style.borderTopColor = cell.style.borderBottomColor;
        tmpCell.style.borderTopWidth = cell.style.borderBottomWidth;
        flag && domUtils.addClass(cell, "selectTdClass");
        return tmpCell;
    }

    UETable.prototype = {
        getMaxRows:function () {
            var rows = this.table.rows, maxLen = 1;
            for (var i = 0, row; row = rows[i]; i++) {
                var currentMax = 1;
                for (var j = 0, cj; cj = row.cells[j++];) {
                    currentMax = Math.max(cj.rowSpan || 1, currentMax);
                }
                maxLen = Math.max(currentMax + i, maxLen);
            }
            return maxLen;
        },
        /**
         * 获取当前表格的最大列数
         */
        getMaxCols:function () {
            var rows = this.table.rows, maxLen = 0, cellRows = {};
            for (var i = 0, row; row = rows[i]; i++) {
                var cellsNum = 0;
                for (var j = 0, cj; cj = row.cells[j++];) {
                    cellsNum += (cj.colSpan || 1);
                    if (cj.rowSpan && cj.rowSpan > 1) {
                        for (var k = 1; k < cj.rowSpan; k++) {
                            if (!cellRows['row_' + (i + k)]) {
                                cellRows['row_' + (i + k)] = (cj.colSpan || 1);
                            } else {
                                cellRows['row_' + (i + k)]++
                            }
                        }

                    }
                }
                cellsNum += cellRows['row_' + i] || 0;
                maxLen = Math.max(cellsNum, maxLen);
            }
            return maxLen;
        },
        getCellColIndex:function (cell) {

        },
        /**
         * 获取当前cell旁边的单元格，
         * @param cell
         * @param right
         */
        getHSideCell:function (cell, right) {
            try {
                var cellInfo = this.getCellInfo(cell),
                    previewRowIndex, previewColIndex;
                var len = this.selectedTds.length,
                    range = this.cellsRange;
                //首行或者首列没有前置单元格
                if ((!right && (!len ? !cellInfo.colIndex : !range.beginColIndex)) || (right && (!len ? (cellInfo.colIndex == (this.colsNum - 1)) : (range.endColIndex == this.colsNum - 1)))) return null;

                previewRowIndex = !len ? cellInfo.rowIndex : range.beginRowIndex;
                previewColIndex = !right ? ( !len ? (cellInfo.colIndex < 1 ? 0 : (cellInfo.colIndex - 1)) : range.beginColIndex - 1)
                    : ( !len ? cellInfo.colIndex + 1 : range.endColIndex + 1);
                return this.getCell(this.indexTable[previewRowIndex][previewColIndex].rowIndex, this.indexTable[previewRowIndex][previewColIndex].cellIndex);
            } catch (e) {
                showError(e);
            }
        },
        getTabNextCell:function (cell, preRowIndex) {
            var cellInfo = this.getCellInfo(cell),
                rowIndex = preRowIndex || cellInfo.rowIndex,
                colIndex = cellInfo.colIndex + 1 + (cellInfo.colSpan - 1),
                nextCell;
            try {
                nextCell = this.getCell(this.indexTable[rowIndex][colIndex].rowIndex, this.indexTable[rowIndex][colIndex].cellIndex);
            } catch (e) {
                try {
                    rowIndex = rowIndex * 1 + 1;
                    colIndex = 0;
                    nextCell = this.getCell(this.indexTable[rowIndex][colIndex].rowIndex, this.indexTable[rowIndex][colIndex].cellIndex);
                } catch (e) {
                }
            }
            return nextCell;

        },
        /**
         * 获取视觉上的后置单元格
         * @param cell
         * @param bottom
         */
        getVSideCell:function (cell, bottom, ignoreRange) {
            try {
                var cellInfo = this.getCellInfo(cell),
                    nextRowIndex, nextColIndex;
                var len = this.selectedTds.length && !ignoreRange,
                    range = this.cellsRange;
                //末行或者末列没有后置单元格
                if ((!bottom && (cellInfo.rowIndex == 0)) || (bottom && (!len ? (cellInfo.rowIndex + cellInfo.rowSpan > this.rowsNum - 1) : (range.endRowIndex == this.rowsNum - 1)))) return null;

                nextRowIndex = !bottom ? ( !len ? cellInfo.rowIndex - 1 : range.beginRowIndex - 1)
                    : ( !len ? (cellInfo.rowIndex + cellInfo.rowSpan) : range.endRowIndex + 1);
                nextColIndex = !len ? cellInfo.colIndex : range.beginColIndex;
                return this.getCell(this.indexTable[nextRowIndex][nextColIndex].rowIndex, this.indexTable[nextRowIndex][nextColIndex].cellIndex);
            } catch (e) {
                showError(e);
            }
        },
        /**
         * 获取相同结束位置的单元格，xOrY指代了是获取x轴相同还是y轴相同
         */
        getSameEndPosCells:function (cell, xOrY) {
            try {
                var flag = (xOrY.toLowerCase() === "x"),
                    end = domUtils.getXY(cell)[flag ? 'x' : 'y'] + cell["offset" + (flag ? 'Width' : 'Height')],
                    rows = this.table.rows,
                    cells = null, returns = [];
                for (var i = 0; i < this.rowsNum; i++) {
                    cells = rows[i].cells;
                    for (var j = 0, tmpCell; tmpCell = cells[j++];) {
                        var tmpEnd = domUtils.getXY(tmpCell)[flag ? 'x' : 'y'] + tmpCell["offset" + (flag ? 'Width' : 'Height')];
                        //对应行的td已经被上面行rowSpan了
                        if (tmpEnd > end && flag) break;
                        if (cell == tmpCell || end == tmpEnd) {
                            //只获取单一的单元格
                            //todo 仅获取单一单元格在特定情况下会造成returns为空，从而影响后续的拖拽实现，修正这个。需考虑性能
                            if (tmpCell[flag ? "colSpan" : "rowSpan"] == 1) {
                                returns.push(tmpCell);
                            }
                            if (flag) break;
                        }
                    }
                }
                return returns;
            } catch (e) {
                showError(e);
            }
        },
        setCellContent:function (cell, content) {
            cell.innerHTML = content || (browser.ie ? domUtils.fillChar : "<br />");
        },
        cloneCell:UETable.cloneCell,
        /**
         * 获取跟当前单元格的右边竖线为左边的所有未合并单元格
         */
        getSameStartPosXCells:function (cell) {
            try {
                var start = domUtils.getXY(cell).x + cell.offsetWidth,
                    rows = this.table.rows, cells , returns = [];
                for (var i = 0; i < this.rowsNum; i++) {
                    cells = rows[i].cells;
                    for (var j = 0, tmpCell; tmpCell = cells[j++];) {
                        var tmpStart = domUtils.getXY(tmpCell).x;
                        if (tmpStart > start) break;
                        if (tmpStart == start && tmpCell.colSpan == 1) {
                            returns.push(tmpCell);
                            break;
                        }
                    }
                }
                return returns;
            } catch (e) {
                showError(e);
            }
        },
        /**
         * 更新table对应的索引表
         */
        update:function (table) {
            this.table = table || this.table;
            this.selectedTds = [];
            this.cellsRange = {};
            this.indexTable = [];
            var rows = this.table.rows,
                rowsNum = this.getMaxRows(),
                dNum = rowsNum - rows.length,
                colsNum = this.getMaxCols();
            while (dNum--) {
                this.table.insertRow(rows.length);
            }
            this.rowsNum = rowsNum;
            this.colsNum = colsNum;
            for (var i = 0, len = rows.length; i < len; i++) {
                this.indexTable[i] = new Array(colsNum);
            }
            //填充索引表
            for (var rowIndex = 0, row; row = rows[rowIndex]; rowIndex++) {
                for (var cellIndex = 0, cell, cells = row.cells; cell = cells[cellIndex]; cellIndex++) {
                    //修正整行被rowSpan时导致的行数计算错误
                    if (cell.rowSpan > rowsNum) {
                        cell.rowSpan = rowsNum;
                    }
                    var colIndex = cellIndex,
                        rowSpan = cell.rowSpan || 1,
                        colSpan = cell.colSpan || 1;
                    //当已经被上一行rowSpan或者被前一列colSpan了，则跳到下一个单元格进行
                    while (this.indexTable[rowIndex][colIndex]) colIndex++;
                    for (var j = 0; j < rowSpan; j++) {
                        for (var k = 0; k < colSpan; k++) {
                            this.indexTable[rowIndex + j][colIndex + k] = {
                                rowIndex:rowIndex,
                                cellIndex:cellIndex,
                                colIndex:colIndex,
                                rowSpan:rowSpan,
                                colSpan:colSpan
                            }
                        }
                    }
                }
            }
            //修复残缺td
            for (j = 0; j < rowsNum; j++) {
                for (k = 0; k < colsNum; k++) {
                    if (this.indexTable[j][k] === undefined) {
                        row = rows[j];
                        cell = row.cells[row.cells.length - 1];
                        cell = cell ? cell.cloneNode(true) : this.table.ownerDocument.createElement("td");
                        this.setCellContent(cell);
                        if (cell.colSpan !== 1)cell.colSpan = 1;
                        if (cell.rowSpan !== 1)cell.rowSpan = 1;
                        row.appendChild(cell);
                        this.indexTable[j][k] = {
                            rowIndex:j,
                            cellIndex:cell.cellIndex,
                            colIndex:k,
                            rowSpan:1,
                            colSpan:1
                        }
                    }
                }
            }
            //当框选后删除行或者列后撤销，需要重建选区。
            var tds = domUtils.getElementsByTagName(this.table, "td"),
                selectTds = [];
            utils.each(tds, function (td) {
                if (domUtils.hasClass(td, "selectTdClass")) {
                    selectTds.push(td);
                }
            });
            if (selectTds.length) {
                var start = selectTds[0],
                    end = selectTds[selectTds.length - 1],
                    startInfo = this.getCellInfo(start),
                    endInfo = this.getCellInfo(end);
                this.selectedTds = selectTds;
                this.cellsRange = {
                    beginRowIndex:startInfo.rowIndex,
                    beginColIndex:startInfo.colIndex,
                    endRowIndex:endInfo.rowIndex + endInfo.rowSpan - 1,
                    endColIndex:endInfo.colIndex + endInfo.colSpan - 1
                };
            }
            //给第一行设置firstRow的样式名称,在排序图标的样式上使用到
            if(!domUtils.hasClass(this.table.rows[0], "firstRow")) {
                domUtils.addClass(this.table.rows[0], "firstRow");
                for(var i = 1; i< this.table.rows.length; i++) {
                    domUtils.removeClasses(this.table.rows[i], "firstRow");
                }
            }
        },
        /**
         * 获取单元格的索引信息
         */
        getCellInfo:function (cell) {
            if (!cell) return;
            var cellIndex = cell.cellIndex,
                rowIndex = cell.parentNode.rowIndex,
                rowInfo = this.indexTable[rowIndex],
                numCols = this.colsNum;
            for (var colIndex = cellIndex; colIndex < numCols; colIndex++) {
                var cellInfo = rowInfo[colIndex];
                if (cellInfo.rowIndex === rowIndex && cellInfo.cellIndex === cellIndex) {
                    return cellInfo;
                }
            }
        },
        /**
         * 根据行列号获取单元格
         */
        getCell:function (rowIndex, cellIndex) {
            return rowIndex < this.rowsNum && this.table.rows[rowIndex].cells[cellIndex] || null;
        },
        /**
         * 删除单元格
         */
        deleteCell:function (cell, rowIndex) {
            rowIndex = typeof rowIndex == 'number' ? rowIndex : cell.parentNode.rowIndex;
            var row = this.table.rows[rowIndex];
            row.deleteCell(cell.cellIndex);
        },
        /**
         * 根据始末两个单元格获取被框选的所有单元格范围
         */
        getCellsRange:function (cellA, cellB) {
            function checkRange(beginRowIndex, beginColIndex, endRowIndex, endColIndex) {
                var tmpBeginRowIndex = beginRowIndex,
                    tmpBeginColIndex = beginColIndex,
                    tmpEndRowIndex = endRowIndex,
                    tmpEndColIndex = endColIndex,
                    cellInfo, colIndex, rowIndex;
                // 通过indexTable检查是否存在超出TableRange上边界的情况
                if (beginRowIndex > 0) {
                    for (colIndex = beginColIndex; colIndex < endColIndex; colIndex++) {
                        cellInfo = me.indexTable[beginRowIndex][colIndex];
                        rowIndex = cellInfo.rowIndex;
                        if (rowIndex < beginRowIndex) {
                            tmpBeginRowIndex = Math.min(rowIndex, tmpBeginRowIndex);
                        }
                    }
                }
                // 通过indexTable检查是否存在超出TableRange右边界的情况
                if (endColIndex < me.colsNum) {
                    for (rowIndex = beginRowIndex; rowIndex < endRowIndex; rowIndex++) {
                        cellInfo = me.indexTable[rowIndex][endColIndex];
                        colIndex = cellInfo.colIndex + cellInfo.colSpan - 1;
                        if (colIndex > endColIndex) {
                            tmpEndColIndex = Math.max(colIndex, tmpEndColIndex);
                        }
                    }
                }
                // 检查是否有超出TableRange下边界的情况
                if (endRowIndex < me.rowsNum) {
                    for (colIndex = beginColIndex; colIndex < endColIndex; colIndex++) {
                        cellInfo = me.indexTable[endRowIndex][colIndex];
                        rowIndex = cellInfo.rowIndex + cellInfo.rowSpan - 1;
                        if (rowIndex > endRowIndex) {
                            tmpEndRowIndex = Math.max(rowIndex, tmpEndRowIndex);
                        }
                    }
                }
                // 检查是否有超出TableRange左边界的情况
                if (beginColIndex > 0) {
                    for (rowIndex = beginRowIndex; rowIndex < endRowIndex; rowIndex++) {
                        cellInfo = me.indexTable[rowIndex][beginColIndex];
                        colIndex = cellInfo.colIndex;
                        if (colIndex < beginColIndex) {
                            tmpBeginColIndex = Math.min(cellInfo.colIndex, tmpBeginColIndex);
                        }
                    }
                }
                //递归调用直至所有完成所有框选单元格的扩展
                if (tmpBeginRowIndex != beginRowIndex || tmpBeginColIndex != beginColIndex || tmpEndRowIndex != endRowIndex || tmpEndColIndex != endColIndex) {
                    return checkRange(tmpBeginRowIndex, tmpBeginColIndex, tmpEndRowIndex, tmpEndColIndex);
                } else {
                    // 不需要扩展TableRange的情况
                    return {
                        beginRowIndex:beginRowIndex,
                        beginColIndex:beginColIndex,
                        endRowIndex:endRowIndex,
                        endColIndex:endColIndex
                    };
                }
            }

            try {
                var me = this,
                    cellAInfo = me.getCellInfo(cellA);
                if (cellA === cellB) {
                    return {
                        beginRowIndex:cellAInfo.rowIndex,
                        beginColIndex:cellAInfo.colIndex,
                        endRowIndex:cellAInfo.rowIndex + cellAInfo.rowSpan - 1,
                        endColIndex:cellAInfo.colIndex + cellAInfo.colSpan - 1
                    };
                }
                var cellBInfo = me.getCellInfo(cellB);
                // 计算TableRange的四个边
                var beginRowIndex = Math.min(cellAInfo.rowIndex, cellBInfo.rowIndex),
                    beginColIndex = Math.min(cellAInfo.colIndex, cellBInfo.colIndex),
                    endRowIndex = Math.max(cellAInfo.rowIndex + cellAInfo.rowSpan - 1, cellBInfo.rowIndex + cellBInfo.rowSpan - 1),
                    endColIndex = Math.max(cellAInfo.colIndex + cellAInfo.colSpan - 1, cellBInfo.colIndex + cellBInfo.colSpan - 1);

                return checkRange(beginRowIndex, beginColIndex, endRowIndex, endColIndex);
            } catch (e) {
                //throw e;
            }
        },
        /**
         * 依据cellsRange获取对应的单元格集合
         */
        getCells:function (range) {
            //每次获取cells之前必须先清除上次的选择，否则会对后续获取操作造成影响
            this.clearSelected();
            var beginRowIndex = range.beginRowIndex,
                beginColIndex = range.beginColIndex,
                endRowIndex = range.endRowIndex,
                endColIndex = range.endColIndex,
                cellInfo, rowIndex, colIndex, tdHash = {}, returnTds = [];
            for (var i = beginRowIndex; i <= endRowIndex; i++) {
                for (var j = beginColIndex; j <= endColIndex; j++) {
                    cellInfo = this.indexTable[i][j];
                    rowIndex = cellInfo.rowIndex;
                    colIndex = cellInfo.colIndex;
                    // 如果Cells里已经包含了此Cell则跳过
                    var key = rowIndex + '|' + colIndex;
                    if (tdHash[key]) continue;
                    tdHash[key] = 1;
                    if (rowIndex < i || colIndex < j || rowIndex + cellInfo.rowSpan - 1 > endRowIndex || colIndex + cellInfo.colSpan - 1 > endColIndex) {
                        return null;
                    }
                    returnTds.push(this.getCell(rowIndex, cellInfo.cellIndex));
                }
            }
            return returnTds;
        },
        /**
         * 清理已经选中的单元格
         */
        clearSelected:function () {
            UETable.removeSelectedClass(this.selectedTds);
            this.selectedTds = [];
            this.cellsRange = {};
        },
        /**
         * 根据range设置已经选中的单元格
         */
        setSelected:function (range) {
            var cells = this.getCells(range);
            UETable.addSelectedClass(cells);
            this.selectedTds = cells;
            this.cellsRange = range;
        },
        isFullRow:function () {
            var range = this.cellsRange;
            return (range.endColIndex - range.beginColIndex + 1) == this.colsNum;
        },
        isFullCol:function () {
            var range = this.cellsRange,
                table = this.table,
                ths = table.getElementsByTagName("th"),
                rows = range.endRowIndex - range.beginRowIndex + 1;
            return  !ths.length ? rows == this.rowsNum : rows == this.rowsNum || (rows == this.rowsNum - 1);

        },
        /**
         * 获取视觉上的前置单元格，默认是左边，top传入时
         * @param cell
         * @param top
         */
        getNextCell:function (cell, bottom, ignoreRange) {
            try {
                var cellInfo = this.getCellInfo(cell),
                    nextRowIndex, nextColIndex;
                var len = this.selectedTds.length && !ignoreRange,
                    range = this.cellsRange;
                //末行或者末列没有后置单元格
                if ((!bottom && (cellInfo.rowIndex == 0)) || (bottom && (!len ? (cellInfo.rowIndex + cellInfo.rowSpan > this.rowsNum - 1) : (range.endRowIndex == this.rowsNum - 1)))) return null;

                nextRowIndex = !bottom ? ( !len ? cellInfo.rowIndex - 1 : range.beginRowIndex - 1)
                    : ( !len ? (cellInfo.rowIndex + cellInfo.rowSpan) : range.endRowIndex + 1);
                nextColIndex = !len ? cellInfo.colIndex : range.beginColIndex;
                return this.getCell(this.indexTable[nextRowIndex][nextColIndex].rowIndex, this.indexTable[nextRowIndex][nextColIndex].cellIndex);
            } catch (e) {
                showError(e);
            }
        },
        getPreviewCell:function (cell, top) {
            try {
                var cellInfo = this.getCellInfo(cell),
                    previewRowIndex, previewColIndex;
                var len = this.selectedTds.length,
                    range = this.cellsRange;
                //首行或者首列没有前置单元格
                if ((!top && (!len ? !cellInfo.colIndex : !range.beginColIndex)) || (top && (!len ? (cellInfo.rowIndex > (this.colsNum - 1)) : (range.endColIndex == this.colsNum - 1)))) return null;

                previewRowIndex = !top ? ( !len ? cellInfo.rowIndex : range.beginRowIndex )
                    : ( !len ? (cellInfo.rowIndex < 1 ? 0 : (cellInfo.rowIndex - 1)) : range.beginRowIndex);
                previewColIndex = !top ? ( !len ? (cellInfo.colIndex < 1 ? 0 : (cellInfo.colIndex - 1)) : range.beginColIndex - 1)
                    : ( !len ? cellInfo.colIndex : range.endColIndex + 1);
                return this.getCell(this.indexTable[previewRowIndex][previewColIndex].rowIndex, this.indexTable[previewRowIndex][previewColIndex].cellIndex);
            } catch (e) {
                showError(e);
            }
        },
        /**
         * 移动单元格中的内容
         */
        moveContent:function (cellTo, cellFrom) {
            if (UETable.isEmptyBlock(cellFrom)) return;
            if (UETable.isEmptyBlock(cellTo)) {
                cellTo.innerHTML = cellFrom.innerHTML;
                return;
            }
            var child = cellTo.lastChild;
            if (child.nodeType == 3 || !dtd.$block[child.tagName]) {
                cellTo.appendChild(cellTo.ownerDocument.createElement('br'))
            }
            while (child = cellFrom.firstChild) {
                cellTo.appendChild(child);
            }
        },
        /**
         * 向右合并单元格
         */
        mergeRight:function (cell) {
            var cellInfo = this.getCellInfo(cell),
                rightColIndex = cellInfo.colIndex + cellInfo.colSpan,
                rightCellInfo = this.indexTable[cellInfo.rowIndex][rightColIndex],
                rightCell = this.getCell(rightCellInfo.rowIndex, rightCellInfo.cellIndex);
            //合并
            cell.colSpan = cellInfo.colSpan + rightCellInfo.colSpan;
            //被合并的单元格不应存在宽度属性
            cell.removeAttribute("width");
            //移动内容
            this.moveContent(cell, rightCell);
            //删掉被合并的Cell
            this.deleteCell(rightCell, rightCellInfo.rowIndex);
            this.update();
        },
        /**
         * 向下合并单元格
         */
        mergeDown:function (cell) {
            var cellInfo = this.getCellInfo(cell),
                downRowIndex = cellInfo.rowIndex + cellInfo.rowSpan,
                downCellInfo = this.indexTable[downRowIndex][cellInfo.colIndex],
                downCell = this.getCell(downCellInfo.rowIndex, downCellInfo.cellIndex);
            cell.rowSpan = cellInfo.rowSpan + downCellInfo.rowSpan;
            cell.removeAttribute("height");
            this.moveContent(cell, downCell);
            this.deleteCell(downCell, downCellInfo.rowIndex);
            this.update();
        },
        /**
         * 合并整个range中的内容
         */
        mergeRange:function () {
            //由于合并操作可以在任意时刻进行，所以无法通过鼠标位置等信息实时生成range，只能通过缓存实例中的cellsRange对象来访问
            var range = this.cellsRange,
                leftTopCell = this.getCell(range.beginRowIndex, this.indexTable[range.beginRowIndex][range.beginColIndex].cellIndex);

            if (leftTopCell.tagName == "TH" && range.endRowIndex !== range.beginRowIndex) {
                var index = this.indexTable,
                    info = this.getCellInfo(leftTopCell);
                leftTopCell = this.getCell(1, index[1][info.colIndex].cellIndex);
                range = this.getCellsRange(leftTopCell, this.getCell(index[this.rowsNum - 1][info.colIndex].rowIndex, index[this.rowsNum - 1][info.colIndex].cellIndex));
            }

            // 删除剩余的Cells
            var cells = this.getCells(range);
            for(var i= 0,ci;ci=cells[i++];){
                if (ci !== leftTopCell) {
                    this.moveContent(leftTopCell, ci);
                    this.deleteCell(ci);
                }
            }
            // 修改左上角Cell的rowSpan和colSpan，并调整宽度属性设置
            leftTopCell.rowSpan = range.endRowIndex - range.beginRowIndex + 1;
            leftTopCell.rowSpan > 1 && leftTopCell.removeAttribute("height");
            leftTopCell.colSpan = range.endColIndex - range.beginColIndex + 1;
            leftTopCell.colSpan > 1 && leftTopCell.removeAttribute("width");
            if (leftTopCell.rowSpan == this.rowsNum && leftTopCell.colSpan != 1) {
                leftTopCell.colSpan = 1;
            }

            if (leftTopCell.colSpan == this.colsNum && leftTopCell.rowSpan != 1) {
                var rowIndex = leftTopCell.parentNode.rowIndex;
                //解决IE下的表格操作问题
                if( this.table.deleteRow ) {
                    for (var i = rowIndex+ 1, curIndex=rowIndex+ 1, len=leftTopCell.rowSpan; i < len; i++) {
                        this.table.deleteRow(curIndex);
                    }
                } else {
                    for (var i = 0, len=leftTopCell.rowSpan - 1; i < len; i++) {
                        var row = this.table.rows[rowIndex + 1];
                        row.parentNode.removeChild(row);
                    }
                }
                leftTopCell.rowSpan = 1;
            }
            this.update();
        },
        /**
         * 插入一行单元格
         */
        insertRow:function (rowIndex, sourceCell) {
            var numCols = this.colsNum,
                table = this.table,
                row = table.insertRow(rowIndex), cell,
                isInsertTitle = typeof sourceCell == 'string' && sourceCell.toUpperCase() == 'TH';

            function replaceTdToTh(colIndex, cell, tableRow) {
                if (colIndex == 0) {
                    var tr = tableRow.nextSibling || tableRow.previousSibling,
                        th = tr.cells[colIndex];
                    if (th.tagName == 'TH') {
                        th = cell.ownerDocument.createElement("th");
                        th.appendChild(cell.firstChild);
                        tableRow.insertBefore(th, cell);
                        domUtils.remove(cell)
                    }
                }else{
                    if (cell.tagName == 'TH') {
                        var td = cell.ownerDocument.createElement("td");
                        td.appendChild(cell.firstChild);
                        tableRow.insertBefore(td, cell);
                        domUtils.remove(cell)
                    }
                }
            }

            //首行直接插入,无需考虑部分单元格被rowspan的情况
            if (rowIndex == 0 || rowIndex == this.rowsNum) {
                for (var colIndex = 0; colIndex < numCols; colIndex++) {
                    cell = this.cloneCell(sourceCell, true);
                    this.setCellContent(cell);
                    cell.getAttribute('vAlign') && cell.setAttribute('vAlign', cell.getAttribute('vAlign'));
                    row.appendChild(cell);
                    if(!isInsertTitle) replaceTdToTh(colIndex, cell, row);
                }
            } else {
                var infoRow = this.indexTable[rowIndex],
                    cellIndex = 0;
                for (colIndex = 0; colIndex < numCols; colIndex++) {
                    var cellInfo = infoRow[colIndex];
                    //如果存在某个单元格的rowspan穿过待插入行的位置，则修改该单元格的rowspan即可，无需插入单元格
                    if (cellInfo.rowIndex < rowIndex) {
                        cell = this.getCell(cellInfo.rowIndex, cellInfo.cellIndex);
                        cell.rowSpan = cellInfo.rowSpan + 1;
                    } else {
                        cell = this.cloneCell(sourceCell, true);
                        this.setCellContent(cell);
                        row.appendChild(cell);
                    }
                    if(!isInsertTitle) replaceTdToTh(colIndex, cell, row);
                }
            }
            //框选时插入不触发contentchange，需要手动更新索引。
            this.update();
            return row;
        },
        /**
         * 删除一行单元格
         * @param rowIndex
         */
        deleteRow:function (rowIndex) {
            var row = this.table.rows[rowIndex],
                infoRow = this.indexTable[rowIndex],
                colsNum = this.colsNum,
                count = 0;     //处理计数
            for (var colIndex = 0; colIndex < colsNum;) {
                var cellInfo = infoRow[colIndex],
                    cell = this.getCell(cellInfo.rowIndex, cellInfo.cellIndex);
                if (cell.rowSpan > 1) {
                    if (cellInfo.rowIndex == rowIndex) {
                        var clone = cell.cloneNode(true);
                        clone.rowSpan = cell.rowSpan - 1;
                        clone.innerHTML = "";
                        cell.rowSpan = 1;
                        var nextRowIndex = rowIndex + 1,
                            nextRow = this.table.rows[nextRowIndex],
                            insertCellIndex,
                            preMerged = this.getPreviewMergedCellsNum(nextRowIndex, colIndex) - count;
                        if (preMerged < colIndex) {
                            insertCellIndex = colIndex - preMerged - 1;
                            //nextRow.insertCell(insertCellIndex);
                            domUtils.insertAfter(nextRow.cells[insertCellIndex], clone);
                        } else {
                            if (nextRow.cells.length) nextRow.insertBefore(clone, nextRow.cells[0])
                        }
                        count += 1;
                        //cell.parentNode.removeChild(cell);
                    }
                }
                colIndex += cell.colSpan || 1;
            }
            var deleteTds = [], cacheMap = {};
            for (colIndex = 0; colIndex < colsNum; colIndex++) {
                var tmpRowIndex = infoRow[colIndex].rowIndex,
                    tmpCellIndex = infoRow[colIndex].cellIndex,
                    key = tmpRowIndex + "_" + tmpCellIndex;
                if (cacheMap[key])continue;
                cacheMap[key] = 1;
                cell = this.getCell(tmpRowIndex, tmpCellIndex);
                deleteTds.push(cell);
            }
            var mergeTds = [];
            utils.each(deleteTds, function (td) {
                if (td.rowSpan == 1) {
                    td.parentNode.removeChild(td);
                } else {
                    mergeTds.push(td);
                }
            });
            utils.each(mergeTds, function (td) {
                td.rowSpan--;
            });
            row.parentNode.removeChild(row);
            //浏览器方法本身存在bug,采用自定义方法删除
            //this.table.deleteRow(rowIndex);
            this.update();
        },
        insertCol:function (colIndex, sourceCell, defaultValue) {
            var rowsNum = this.rowsNum,
                rowIndex = 0,
                tableRow, cell,
                backWidth = parseInt((this.table.offsetWidth - (this.colsNum + 1) * 20 - (this.colsNum + 1)) / (this.colsNum + 1), 10),
                isInsertTitleCol = typeof sourceCell == 'string' && sourceCell.toUpperCase() == 'TH';

            function replaceTdToTh(rowIndex, cell, tableRow) {
                if (rowIndex == 0) {
                    var th = cell.nextSibling || cell.previousSibling;
                    if (th.tagName == 'TH') {
                        th = cell.ownerDocument.createElement("th");
                        th.appendChild(cell.firstChild);
                        tableRow.insertBefore(th, cell);
                        domUtils.remove(cell)
                    }
                }else{
                    if (cell.tagName == 'TH') {
                        var td = cell.ownerDocument.createElement("td");
                        td.appendChild(cell.firstChild);
                        tableRow.insertBefore(td, cell);
                        domUtils.remove(cell)
                    }
                }
            }

            var preCell;
            if (colIndex == 0 || colIndex == this.colsNum) {
                for (; rowIndex < rowsNum; rowIndex++) {
                    tableRow = this.table.rows[rowIndex];
                    preCell = tableRow.cells[colIndex == 0 ? colIndex : tableRow.cells.length];
                    cell = this.cloneCell(sourceCell, true); //tableRow.insertCell(colIndex == 0 ? colIndex : tableRow.cells.length);
                    this.setCellContent(cell);
                    cell.setAttribute('vAlign', cell.getAttribute('vAlign'));
                    preCell && cell.setAttribute('width', preCell.getAttribute('width'));
                    if (!colIndex) {
                        tableRow.insertBefore(cell, tableRow.cells[0]);
                    } else {
                        domUtils.insertAfter(tableRow.cells[tableRow.cells.length - 1], cell);
                    }
                    if(!isInsertTitleCol) replaceTdToTh(rowIndex, cell, tableRow)
                }
            } else {
                for (; rowIndex < rowsNum; rowIndex++) {
                    var cellInfo = this.indexTable[rowIndex][colIndex];
                    if (cellInfo.colIndex < colIndex) {
                        cell = this.getCell(cellInfo.rowIndex, cellInfo.cellIndex);
                        cell.colSpan = cellInfo.colSpan + 1;
                    } else {
                        tableRow = this.table.rows[rowIndex];
                        preCell = tableRow.cells[cellInfo.cellIndex];

                        cell = this.cloneCell(sourceCell, true);//tableRow.insertCell(cellInfo.cellIndex);
                        this.setCellContent(cell);
                        cell.setAttribute('vAlign', cell.getAttribute('vAlign'));
                        preCell && cell.setAttribute('width', preCell.getAttribute('width'));
                        //防止IE下报错
                        preCell ? tableRow.insertBefore(cell, preCell) : tableRow.appendChild(cell);
                    }
                    if(!isInsertTitleCol) replaceTdToTh(rowIndex, cell, tableRow);
                }
            }
            //框选时插入不触发contentchange，需要手动更新索引
            this.update();
            this.updateWidth(backWidth, defaultValue || {tdPadding:10, tdBorder:1});
        },
        updateWidth:function (width, defaultValue) {
            var table = this.table,
                tmpWidth = UETable.getWidth(table) - defaultValue.tdPadding * 2 - defaultValue.tdBorder + width;
            if (tmpWidth < table.ownerDocument.body.offsetWidth) {
                table.setAttribute("width", tmpWidth);
                return;
            }
            var tds = domUtils.getElementsByTagName(this.table, "td th");
            utils.each(tds, function (td) {
                td.setAttribute("width", width);
            })
        },
        deleteCol:function (colIndex) {
            var indexTable = this.indexTable,
                tableRows = this.table.rows,
                backTableWidth = this.table.getAttribute("width"),
                backTdWidth = 0,
                rowsNum = this.rowsNum,
                cacheMap = {};
            for (var rowIndex = 0; rowIndex < rowsNum;) {
                var infoRow = indexTable[rowIndex],
                    cellInfo = infoRow[colIndex],
                    key = cellInfo.rowIndex + '_' + cellInfo.colIndex;
                // 跳过已经处理过的Cell
                if (cacheMap[key])continue;
                cacheMap[key] = 1;
                var cell = this.getCell(cellInfo.rowIndex, cellInfo.cellIndex);
                if (!backTdWidth) backTdWidth = cell && parseInt(cell.offsetWidth / cell.colSpan, 10).toFixed(0);
                // 如果Cell的colSpan大于1, 就修改colSpan, 否则就删掉这个Cell
                if (cell.colSpan > 1) {
                    cell.colSpan--;
                } else {
                    tableRows[rowIndex].deleteCell(cellInfo.cellIndex);
                }
                rowIndex += cellInfo.rowSpan || 1;
            }
            this.table.setAttribute("width", backTableWidth - backTdWidth);
            this.update();
        },
        splitToCells:function (cell) {
            var me = this,
                cells = this.splitToRows(cell);
            utils.each(cells, function (cell) {
                me.splitToCols(cell);
            })
        },
        splitToRows:function (cell) {
            var cellInfo = this.getCellInfo(cell),
                rowIndex = cellInfo.rowIndex,
                colIndex = cellInfo.colIndex,
                results = [];
            // 修改Cell的rowSpan
            cell.rowSpan = 1;
            results.push(cell);
            // 补齐单元格
            for (var i = rowIndex, endRow = rowIndex + cellInfo.rowSpan; i < endRow; i++) {
                if (i == rowIndex)continue;
                var tableRow = this.table.rows[i],
                    tmpCell = tableRow.insertCell(colIndex - this.getPreviewMergedCellsNum(i, colIndex));
                tmpCell.colSpan = cellInfo.colSpan;
                this.setCellContent(tmpCell);
                tmpCell.setAttribute('vAlign', cell.getAttribute('vAlign'));
                tmpCell.setAttribute('align', cell.getAttribute('align'));
                if (cell.style.cssText) {
                    tmpCell.style.cssText = cell.style.cssText;
                }
                results.push(tmpCell);
            }
            this.update();
            return results;
        },
        getPreviewMergedCellsNum:function (rowIndex, colIndex) {
            var indexRow = this.indexTable[rowIndex],
                num = 0;
            for (var i = 0; i < colIndex;) {
                var colSpan = indexRow[i].colSpan,
                    tmpRowIndex = indexRow[i].rowIndex;
                num += (colSpan - (tmpRowIndex == rowIndex ? 1 : 0));
                i += colSpan;
            }
            return num;
        },
        splitToCols:function (cell) {
            var backWidth = (cell.offsetWidth / cell.colSpan - 22).toFixed(0),

                cellInfo = this.getCellInfo(cell),
                rowIndex = cellInfo.rowIndex,
                colIndex = cellInfo.colIndex,
                results = [];
            // 修改Cell的rowSpan
            cell.colSpan = 1;
            cell.setAttribute("width", backWidth);
            results.push(cell);
            // 补齐单元格
            for (var j = colIndex, endCol = colIndex + cellInfo.colSpan; j < endCol; j++) {
                if (j == colIndex)continue;
                var tableRow = this.table.rows[rowIndex],
                    tmpCell = tableRow.insertCell(this.indexTable[rowIndex][j].cellIndex + 1);
                tmpCell.rowSpan = cellInfo.rowSpan;
                this.setCellContent(tmpCell);
                tmpCell.setAttribute('vAlign', cell.getAttribute('vAlign'));
                tmpCell.setAttribute('align', cell.getAttribute('align'));
                tmpCell.setAttribute('width', backWidth);
                if (cell.style.cssText) {
                    tmpCell.style.cssText = cell.style.cssText;
                }
                //处理th的情况
                if (cell.tagName == 'TH') {
                    var th = cell.ownerDocument.createElement('th');
                    th.appendChild(tmpCell.firstChild);
                    th.setAttribute('vAlign', cell.getAttribute('vAlign'));
                    th.rowSpan = tmpCell.rowSpan;
                    tableRow.insertBefore(th, tmpCell);
                    domUtils.remove(tmpCell);
                }
                results.push(tmpCell);
            }
            this.update();
            return results;
        },
        isLastCell:function (cell, rowsNum, colsNum) {
            rowsNum = rowsNum || this.rowsNum;
            colsNum = colsNum || this.colsNum;
            var cellInfo = this.getCellInfo(cell);
            return ((cellInfo.rowIndex + cellInfo.rowSpan) == rowsNum) &&
                ((cellInfo.colIndex + cellInfo.colSpan) == colsNum);
        },
        getLastCell:function (cells) {
            cells = cells || this.table.getElementsByTagName("td");
            var firstInfo = this.getCellInfo(cells[0]);
            var me = this, last = cells[0],
                tr = last.parentNode,
                cellsNum = 0, cols = 0, rows;
            utils.each(cells, function (cell) {
                if (cell.parentNode == tr)cols += cell.colSpan || 1;
                cellsNum += cell.rowSpan * cell.colSpan || 1;
            });
            rows = cellsNum / cols;
            utils.each(cells, function (cell) {
                if (me.isLastCell(cell, rows, cols)) {
                    last = cell;
                    return false;
                }
            });
            return last;

        },
        selectRow:function (rowIndex) {
            var indexRow = this.indexTable[rowIndex],
                start = this.getCell(indexRow[0].rowIndex, indexRow[0].cellIndex),
                end = this.getCell(indexRow[this.colsNum - 1].rowIndex, indexRow[this.colsNum - 1].cellIndex),
                range = this.getCellsRange(start, end);
            this.setSelected(range);
        },
        selectTable:function () {
            var tds = this.table.getElementsByTagName("td"),
                range = this.getCellsRange(tds[0], tds[tds.length - 1]);
            this.setSelected(range);
        },
        setBackground:function (cells, value) {
            if (typeof value === "string") {
                utils.each(cells, function (cell) {
                    cell.style.backgroundColor = value;
                })
            } else if (typeof value === "object") {
                value = utils.extend({
                    repeat:true,
                    colorList:["#ddd", "#fff"]
                }, value);
                var rowIndex = this.getCellInfo(cells[0]).rowIndex,
                    count = 0,
                    colors = value.colorList,
                    getColor = function (list, index, repeat) {
                        return list[index] ? list[index] : repeat ? list[index % list.length] : "";
                    };
                for (var i = 0, cell; cell = cells[i++];) {
                    var cellInfo = this.getCellInfo(cell);
                    cell.style.backgroundColor = getColor(colors, ((rowIndex + count) == cellInfo.rowIndex) ? count : ++count, value.repeat);
                }
            }
        },
        removeBackground:function (cells) {
            utils.each(cells, function (cell) {
                cell.style.backgroundColor = "";
            })
        }


    };
    function showError(e) {
    }
})();

// plugins/table.cmds.js
/**
 * Created with JetBrains PhpStorm.
 * User: taoqili
 * Date: 13-2-20
 * Time: 下午6:25
 * To change this template use File | Settings | File Templates.
 */
;
(function () {
    var UT = UE.UETable,
        getTableItemsByRange = function (editor) {
            return UT.getTableItemsByRange(editor);
        },
        getUETableBySelected = function (editor) {
            return UT.getUETableBySelected(editor)
        },
        getDefaultValue = function (editor, table) {
            return UT.getDefaultValue(editor, table);
        },
        getUETable = function (tdOrTable) {
            return UT.getUETable(tdOrTable);
        };


    UE.commands['inserttable'] = {
        queryCommandState: function () {
            return getTableItemsByRange(this).table ? -1 : 0;
        },
        execCommand: function (cmd, opt) {
            function createTable(opt, tdWidth) {
                var html = [],
                    rowsNum = opt.numRows,
                    colsNum = opt.numCols;
                for (var r = 0; r < rowsNum; r++) {
                    html.push('<tr' + (r == 0 ? ' class="firstRow"':'') + '>');
                    for (var c = 0; c < colsNum; c++) {
                        html.push('<td width="' + tdWidth + '"  vAlign="' + opt.tdvalign + '" >' + (browser.ie && browser.version < 11 ? domUtils.fillChar : '<br/>') + '</td>')
                    }
                    html.push('</tr>')
                }
                //禁止指定table-width
                return '<table><tbody>' + html.join('') + '</tbody></table>'
            }

            if (!opt) {
                opt = utils.extend({}, {
                    numCols: this.options.defaultCols,
                    numRows: this.options.defaultRows,
                    tdvalign: this.options.tdvalign
                })
            }
            var me = this;
            var range = this.selection.getRange(),
                start = range.startContainer,
                firstParentBlock = domUtils.findParent(start, function (node) {
                    return domUtils.isBlockElm(node);
                }, true) || me.body;

            var defaultValue = getDefaultValue(me),
                tableWidth = firstParentBlock.offsetWidth,
                tdWidth = Math.floor(tableWidth / opt.numCols - defaultValue.tdPadding * 2 - defaultValue.tdBorder);

            //todo其他属性
            !opt.tdvalign && (opt.tdvalign = me.options.tdvalign);
            me.execCommand("inserthtml", createTable(opt, tdWidth));
        }
    };

    UE.commands['insertparagraphbeforetable'] = {
        queryCommandState: function () {
            return getTableItemsByRange(this).cell ? 0 : -1;
        },
        execCommand: function () {
            var table = getTableItemsByRange(this).table;
            if (table) {
                var p = this.document.createElement("p");
                p.innerHTML = browser.ie ? '&nbsp;' : '<br />';
                table.parentNode.insertBefore(p, table);
                this.selection.getRange().setStart(p, 0).setCursor();
            }
        }
    };

    UE.commands['deletetable'] = {
        queryCommandState: function () {
            var rng = this.selection.getRange();
            return domUtils.findParentByTagName(rng.startContainer, 'table', true) ? 0 : -1;
        },
        execCommand: function (cmd, table) {
            var rng = this.selection.getRange();
            table = table || domUtils.findParentByTagName(rng.startContainer, 'table', true);
            if (table) {
                var next = table.nextSibling;
                if (!next) {
                    next = domUtils.createElement(this.document, 'p', {
                        'innerHTML': browser.ie ? domUtils.fillChar : '<br/>'
                    });
                    table.parentNode.insertBefore(next, table);
                }
                domUtils.remove(table);
                rng = this.selection.getRange();
                if (next.nodeType == 3) {
                    rng.setStartBefore(next)
                } else {
                    rng.setStart(next, 0)
                }
                rng.setCursor(false, true)
                this.fireEvent("tablehasdeleted")

            }

        }
    };
    UE.commands['cellalign'] = {
        queryCommandState: function () {
            return getSelectedArr(this).length ? 0 : -1
        },
        execCommand: function (cmd, align) {
            var selectedTds = getSelectedArr(this);
            if (selectedTds.length) {
                for (var i = 0, ci; ci = selectedTds[i++];) {
                    ci.setAttribute('align', align);
                }
            }
        }
    };
    UE.commands['cellvalign'] = {
        queryCommandState: function () {
            return getSelectedArr(this).length ? 0 : -1;
        },
        execCommand: function (cmd, valign) {
            var selectedTds = getSelectedArr(this);
            if (selectedTds.length) {
                for (var i = 0, ci; ci = selectedTds[i++];) {
                    ci.setAttribute('vAlign', valign);
                }
            }
        }
    };
    UE.commands['insertcaption'] = {
        queryCommandState: function () {
            var table = getTableItemsByRange(this).table;
            if (table) {
                return table.getElementsByTagName('caption').length == 0 ? 1 : -1;
            }
            return -1;
        },
        execCommand: function () {
            var table = getTableItemsByRange(this).table;
            if (table) {
                var caption = this.document.createElement('caption');
                caption.innerHTML = browser.ie ? domUtils.fillChar : '<br/>';
                table.insertBefore(caption, table.firstChild);
                var range = this.selection.getRange();
                range.setStart(caption, 0).setCursor();
            }

        }
    };
    UE.commands['deletecaption'] = {
        queryCommandState: function () {
            var rng = this.selection.getRange(),
                table = domUtils.findParentByTagName(rng.startContainer, 'table');
            if (table) {
                return table.getElementsByTagName('caption').length == 0 ? -1 : 1;
            }
            return -1;
        },
        execCommand: function () {
            var rng = this.selection.getRange(),
                table = domUtils.findParentByTagName(rng.startContainer, 'table');
            if (table) {
                domUtils.remove(table.getElementsByTagName('caption')[0]);
                var range = this.selection.getRange();
                range.setStart(table.rows[0].cells[0], 0).setCursor();
            }

        }
    };
    UE.commands['inserttitle'] = {
        queryCommandState: function () {
            var table = getTableItemsByRange(this).table;
            if (table) {
                var firstRow = table.rows[0];
                return firstRow.cells[firstRow.cells.length-1].tagName.toLowerCase() != 'th' ? 0 : -1
            }
            return -1;
        },
        execCommand: function () {
            var table = getTableItemsByRange(this).table;
            if (table) {
                getUETable(table).insertRow(0, 'th');
            }
            var th = table.getElementsByTagName('th')[0];
            this.selection.getRange().setStart(th, 0).setCursor(false, true);
        }
    };
    UE.commands['deletetitle'] = {
        queryCommandState: function () {
            var table = getTableItemsByRange(this).table;
            if (table) {
                var firstRow = table.rows[0];
                return firstRow.cells[firstRow.cells.length-1].tagName.toLowerCase() == 'th' ? 0 : -1
            }
            return -1;
        },
        execCommand: function () {
            var table = getTableItemsByRange(this).table;
            if (table) {
                domUtils.remove(table.rows[0])
            }
            var td = table.getElementsByTagName('td')[0];
            this.selection.getRange().setStart(td, 0).setCursor(false, true);
        }
    };
    UE.commands['inserttitlecol'] = {
        queryCommandState: function () {
            var table = getTableItemsByRange(this).table;
            if (table) {
                var lastRow = table.rows[table.rows.length-1];
                return lastRow.getElementsByTagName('th').length ? -1 : 0;
            }
            return -1;
        },
        execCommand: function (cmd) {
            var table = getTableItemsByRange(this).table;
            if (table) {
                getUETable(table).insertCol(0, 'th');
            }
            resetTdWidth(table, this);
            var th = table.getElementsByTagName('th')[0];
            this.selection.getRange().setStart(th, 0).setCursor(false, true);
        }
    };
    UE.commands['deletetitlecol'] = {
        queryCommandState: function () {
            var table = getTableItemsByRange(this).table;
            if (table) {
                var lastRow = table.rows[table.rows.length-1];
                return lastRow.getElementsByTagName('th').length ? 0 : -1;
            }
            return -1;
        },
        execCommand: function () {
            var table = getTableItemsByRange(this).table;
            if (table) {
                for(var i = 0; i< table.rows.length; i++ ){
                    domUtils.remove(table.rows[i].children[0])
                }
            }
            resetTdWidth(table, this);
            var td = table.getElementsByTagName('td')[0];
            this.selection.getRange().setStart(td, 0).setCursor(false, true);
        }
    };

    UE.commands["mergeright"] = {
        queryCommandState: function (cmd) {
            var tableItems = getTableItemsByRange(this),
                table = tableItems.table,
                cell = tableItems.cell;

            if (!table || !cell) return -1;
            var ut = getUETable(table);
            if (ut.selectedTds.length) return -1;

            var cellInfo = ut.getCellInfo(cell),
                rightColIndex = cellInfo.colIndex + cellInfo.colSpan;
            if (rightColIndex >= ut.colsNum) return -1; // 如果处于最右边则不能向右合并

            var rightCellInfo = ut.indexTable[cellInfo.rowIndex][rightColIndex],
                rightCell = table.rows[rightCellInfo.rowIndex].cells[rightCellInfo.cellIndex];
            if (!rightCell || cell.tagName != rightCell.tagName) return -1; // TH和TD不能相互合并

            // 当且仅当两个Cell的开始列号和结束列号一致时能进行合并
            return (rightCellInfo.rowIndex == cellInfo.rowIndex && rightCellInfo.rowSpan == cellInfo.rowSpan) ? 0 : -1;
        },
        execCommand: function (cmd) {
            var rng = this.selection.getRange(),
                bk = rng.createBookmark(true);
            var cell = getTableItemsByRange(this).cell,
                ut = getUETable(cell);
            ut.mergeRight(cell);
            rng.moveToBookmark(bk).select();
        }
    };
    UE.commands["mergedown"] = {
        queryCommandState: function (cmd) {
            var tableItems = getTableItemsByRange(this),
                table = tableItems.table,
                cell = tableItems.cell;

            if (!table || !cell) return -1;
            var ut = getUETable(table);
            if (ut.selectedTds.length)return -1;

            var cellInfo = ut.getCellInfo(cell),
                downRowIndex = cellInfo.rowIndex + cellInfo.rowSpan;
            if (downRowIndex >= ut.rowsNum) return -1; // 如果处于最下边则不能向下合并

            var downCellInfo = ut.indexTable[downRowIndex][cellInfo.colIndex],
                downCell = table.rows[downCellInfo.rowIndex].cells[downCellInfo.cellIndex];
            if (!downCell || cell.tagName != downCell.tagName) return -1; // TH和TD不能相互合并

            // 当且仅当两个Cell的开始列号和结束列号一致时能进行合并
            return (downCellInfo.colIndex == cellInfo.colIndex && downCellInfo.colSpan == cellInfo.colSpan) ? 0 : -1;
        },
        execCommand: function () {
            var rng = this.selection.getRange(),
                bk = rng.createBookmark(true);
            var cell = getTableItemsByRange(this).cell,
                ut = getUETable(cell);
            ut.mergeDown(cell);
            rng.moveToBookmark(bk).select();
        }
    };
    UE.commands["mergecells"] = {
        queryCommandState: function () {
            return getUETableBySelected(this) ? 0 : -1;
        },
        execCommand: function () {
            var ut = getUETableBySelected(this);
            if (ut && ut.selectedTds.length) {
                var cell = ut.selectedTds[0];
                ut.mergeRange();
                var rng = this.selection.getRange();
                if (domUtils.isEmptyBlock(cell)) {
                    rng.setStart(cell, 0).collapse(true)
                } else {
                    rng.selectNodeContents(cell)
                }
                rng.select();
            }


        }
    };
    UE.commands["insertrow"] = {
        queryCommandState: function () {
            var tableItems = getTableItemsByRange(this),
                cell = tableItems.cell;
            return cell && (cell.tagName == "TD" || (cell.tagName == 'TH' && tableItems.tr !== tableItems.table.rows[0])) &&
                getUETable(tableItems.table).rowsNum < this.options.maxRowNum ? 0 : -1;
        },
        execCommand: function () {
            var rng = this.selection.getRange(),
                bk = rng.createBookmark(true);
            var tableItems = getTableItemsByRange(this),
                cell = tableItems.cell,
                table = tableItems.table,
                ut = getUETable(table),
                cellInfo = ut.getCellInfo(cell);
            //ut.insertRow(!ut.selectedTds.length ? cellInfo.rowIndex:ut.cellsRange.beginRowIndex,'');
            if (!ut.selectedTds.length) {
                ut.insertRow(cellInfo.rowIndex, cell);
            } else {
                var range = ut.cellsRange;
                for (var i = 0, len = range.endRowIndex - range.beginRowIndex + 1; i < len; i++) {
                    ut.insertRow(range.beginRowIndex, cell);
                }
            }
            rng.moveToBookmark(bk).select();
            if (table.getAttribute("interlaced") === "enabled")this.fireEvent("interlacetable", table);
        }
    };
    //后插入行
    UE.commands["insertrownext"] = {
        queryCommandState: function () {
            var tableItems = getTableItemsByRange(this),
                cell = tableItems.cell;
            return cell && (cell.tagName == "TD") && getUETable(tableItems.table).rowsNum < this.options.maxRowNum ? 0 : -1;
        },
        execCommand: function () {
            var rng = this.selection.getRange(),
                bk = rng.createBookmark(true);
            var tableItems = getTableItemsByRange(this),
                cell = tableItems.cell,
                table = tableItems.table,
                ut = getUETable(table),
                cellInfo = ut.getCellInfo(cell);
            //ut.insertRow(!ut.selectedTds.length? cellInfo.rowIndex + cellInfo.rowSpan : ut.cellsRange.endRowIndex + 1,'');
            if (!ut.selectedTds.length) {
                ut.insertRow(cellInfo.rowIndex + cellInfo.rowSpan, cell);
            } else {
                var range = ut.cellsRange;
                for (var i = 0, len = range.endRowIndex - range.beginRowIndex + 1; i < len; i++) {
                    ut.insertRow(range.endRowIndex + 1, cell);
                }
            }
            rng.moveToBookmark(bk).select();
            if (table.getAttribute("interlaced") === "enabled")this.fireEvent("interlacetable", table);
        }
    };
    UE.commands["deleterow"] = {
        queryCommandState: function () {
            var tableItems = getTableItemsByRange(this);
            return tableItems.cell ? 0 : -1;
        },
        execCommand: function () {
            var cell = getTableItemsByRange(this).cell,
                ut = getUETable(cell),
                cellsRange = ut.cellsRange,
                cellInfo = ut.getCellInfo(cell),
                preCell = ut.getVSideCell(cell),
                nextCell = ut.getVSideCell(cell, true),
                rng = this.selection.getRange();
            if (utils.isEmptyObject(cellsRange)) {
                ut.deleteRow(cellInfo.rowIndex);
            } else {
                for (var i = cellsRange.beginRowIndex; i < cellsRange.endRowIndex + 1; i++) {
                    ut.deleteRow(cellsRange.beginRowIndex);
                }
            }
            var table = ut.table;
            if (!table.getElementsByTagName('td').length) {
                var nextSibling = table.nextSibling;
                domUtils.remove(table);
                if (nextSibling) {
                    rng.setStart(nextSibling, 0).setCursor(false, true);
                }
            } else {
                if (cellInfo.rowSpan == 1 || cellInfo.rowSpan == cellsRange.endRowIndex - cellsRange.beginRowIndex + 1) {
                    if (nextCell || preCell) rng.selectNodeContents(nextCell || preCell).setCursor(false, true);
                } else {
                    var newCell = ut.getCell(cellInfo.rowIndex, ut.indexTable[cellInfo.rowIndex][cellInfo.colIndex].cellIndex);
                    if (newCell) rng.selectNodeContents(newCell).setCursor(false, true);
                }
            }
            if (table.getAttribute("interlaced") === "enabled")this.fireEvent("interlacetable", table);
        }
    };
    UE.commands["insertcol"] = {
        queryCommandState: function (cmd) {
            var tableItems = getTableItemsByRange(this),
                cell = tableItems.cell;
            return cell && (cell.tagName == "TD" || (cell.tagName == 'TH' && cell !== tableItems.tr.cells[0])) &&
                getUETable(tableItems.table).colsNum < this.options.maxColNum ? 0 : -1;
        },
        execCommand: function (cmd) {
            var rng = this.selection.getRange(),
                bk = rng.createBookmark(true);
            if (this.queryCommandState(cmd) == -1)return;
            var cell = getTableItemsByRange(this).cell,
                ut = getUETable(cell),
                cellInfo = ut.getCellInfo(cell);

            //ut.insertCol(!ut.selectedTds.length ? cellInfo.colIndex:ut.cellsRange.beginColIndex);
            if (!ut.selectedTds.length) {
                ut.insertCol(cellInfo.colIndex, cell);
            } else {
                var range = ut.cellsRange;
                for (var i = 0, len = range.endColIndex - range.beginColIndex + 1; i < len; i++) {
                    ut.insertCol(range.beginColIndex, cell);
                }
            }
            rng.moveToBookmark(bk).select(true);
        }
    };
    UE.commands["insertcolnext"] = {
        queryCommandState: function () {
            var tableItems = getTableItemsByRange(this),
                cell = tableItems.cell;
            return cell && getUETable(tableItems.table).colsNum < this.options.maxColNum ? 0 : -1;
        },
        execCommand: function () {
            var rng = this.selection.getRange(),
                bk = rng.createBookmark(true);
            var cell = getTableItemsByRange(this).cell,
                ut = getUETable(cell),
                cellInfo = ut.getCellInfo(cell);
            //ut.insertCol(!ut.selectedTds.length ? cellInfo.colIndex + cellInfo.colSpan:ut.cellsRange.endColIndex +1);
            if (!ut.selectedTds.length) {
                ut.insertCol(cellInfo.colIndex + cellInfo.colSpan, cell);
            } else {
                var range = ut.cellsRange;
                for (var i = 0, len = range.endColIndex - range.beginColIndex + 1; i < len; i++) {
                    ut.insertCol(range.endColIndex + 1, cell);
                }
            }
            rng.moveToBookmark(bk).select();
        }
    };

    UE.commands["deletecol"] = {
        queryCommandState: function () {
            var tableItems = getTableItemsByRange(this);
            return tableItems.cell ? 0 : -1;
        },
        execCommand: function () {
            var cell = getTableItemsByRange(this).cell,
                ut = getUETable(cell),
                range = ut.cellsRange,
                cellInfo = ut.getCellInfo(cell),
                preCell = ut.getHSideCell(cell),
                nextCell = ut.getHSideCell(cell, true);
            if (utils.isEmptyObject(range)) {
                ut.deleteCol(cellInfo.colIndex);
            } else {
                for (var i = range.beginColIndex; i < range.endColIndex + 1; i++) {
                    ut.deleteCol(range.beginColIndex);
                }
            }
            var table = ut.table,
                rng = this.selection.getRange();

            if (!table.getElementsByTagName('td').length) {
                var nextSibling = table.nextSibling;
                domUtils.remove(table);
                if (nextSibling) {
                    rng.setStart(nextSibling, 0).setCursor(false, true);
                }
            } else {
                if (domUtils.inDoc(cell, this.document)) {
                    rng.setStart(cell, 0).setCursor(false, true);
                } else {
                    if (nextCell && domUtils.inDoc(nextCell, this.document)) {
                        rng.selectNodeContents(nextCell).setCursor(false, true);
                    } else {
                        if (preCell && domUtils.inDoc(preCell, this.document)) {
                            rng.selectNodeContents(preCell).setCursor(true, true);
                        }
                    }
                }
            }
        }
    };
    UE.commands["splittocells"] = {
        queryCommandState: function () {
            var tableItems = getTableItemsByRange(this),
                cell = tableItems.cell;
            if (!cell) return -1;
            var ut = getUETable(tableItems.table);
            if (ut.selectedTds.length > 0) return -1;
            return cell && (cell.colSpan > 1 || cell.rowSpan > 1) ? 0 : -1;
        },
        execCommand: function () {
            var rng = this.selection.getRange(),
                bk = rng.createBookmark(true);
            var cell = getTableItemsByRange(this).cell,
                ut = getUETable(cell);
            ut.splitToCells(cell);
            rng.moveToBookmark(bk).select();
        }
    };
    UE.commands["splittorows"] = {
        queryCommandState: function () {
            var tableItems = getTableItemsByRange(this),
                cell = tableItems.cell;
            if (!cell) return -1;
            var ut = getUETable(tableItems.table);
            if (ut.selectedTds.length > 0) return -1;
            return cell && cell.rowSpan > 1 ? 0 : -1;
        },
        execCommand: function () {
            var rng = this.selection.getRange(),
                bk = rng.createBookmark(true);
            var cell = getTableItemsByRange(this).cell,
                ut = getUETable(cell);
            ut.splitToRows(cell);
            rng.moveToBookmark(bk).select();
        }
    };
    UE.commands["splittocols"] = {
        queryCommandState: function () {
            var tableItems = getTableItemsByRange(this),
                cell = tableItems.cell;
            if (!cell) return -1;
            var ut = getUETable(tableItems.table);
            if (ut.selectedTds.length > 0) return -1;
            return cell && cell.colSpan > 1 ? 0 : -1;
        },
        execCommand: function () {
            var rng = this.selection.getRange(),
                bk = rng.createBookmark(true);
            var cell = getTableItemsByRange(this).cell,
                ut = getUETable(cell);
            ut.splitToCols(cell);
            rng.moveToBookmark(bk).select();

        }
    };

    UE.commands["adaptbytext"] =
        UE.commands["adaptbywindow"] = {
            queryCommandState: function () {
                return getTableItemsByRange(this).table ? 0 : -1
            },
            execCommand: function (cmd) {
                var tableItems = getTableItemsByRange(this),
                    table = tableItems.table;
                if (table) {
                    if (cmd == 'adaptbywindow') {
                        resetTdWidth(table, this);
                    } else {
                        var cells = domUtils.getElementsByTagName(table, "td th");
                        utils.each(cells, function (cell) {
                            cell.removeAttribute("width");
                        });
                        table.removeAttribute("width");
                    }
                }
            }
        };

    //平均分配各列
    UE.commands['averagedistributecol'] = {
        queryCommandState: function () {
            var ut = getUETableBySelected(this);
            if (!ut) return -1;
            return ut.isFullRow() || ut.isFullCol() ? 0 : -1;
        },
        execCommand: function (cmd) {
            var me = this,
                ut = getUETableBySelected(me);

            function getAverageWidth() {
                var tb = ut.table,
                    averageWidth, sumWidth = 0, colsNum = 0,
                    tbAttr = getDefaultValue(me, tb);

                if (ut.isFullRow()) {
                    sumWidth = tb.offsetWidth;
                    colsNum = ut.colsNum;
                } else {
                    var begin = ut.cellsRange.beginColIndex,
                        end = ut.cellsRange.endColIndex,
                        node;
                    for (var i = begin; i <= end;) {
                        node = ut.selectedTds[i];
                        sumWidth += node.offsetWidth;
                        i += node.colSpan;
                        colsNum += 1;
                    }
                }
                averageWidth = Math.ceil(sumWidth / colsNum) - tbAttr.tdBorder * 2 - tbAttr.tdPadding * 2;
                return averageWidth;
            }

            function setAverageWidth(averageWidth) {
                utils.each(domUtils.getElementsByTagName(ut.table, "th"), function (node) {
                    node.setAttribute("width", "");
                });
                var cells = ut.isFullRow() ? domUtils.getElementsByTagName(ut.table, "td") : ut.selectedTds;

                utils.each(cells, function (node) {
                    if (node.colSpan == 1) {
                        node.setAttribute("width", averageWidth);
                    }
                });
            }

            if (ut && ut.selectedTds.length) {
                setAverageWidth(getAverageWidth());
            }
        }
    };
    //平均分配各行
    UE.commands['averagedistributerow'] = {
        queryCommandState: function () {
            var ut = getUETableBySelected(this);
            if (!ut) return -1;
            if (ut.selectedTds && /th/ig.test(ut.selectedTds[0].tagName)) return -1;
            return ut.isFullRow() || ut.isFullCol() ? 0 : -1;
        },
        execCommand: function (cmd) {
            var me = this,
                ut = getUETableBySelected(me);

            function getAverageHeight() {
                var averageHeight, rowNum, sumHeight = 0,
                    tb = ut.table,
                    tbAttr = getDefaultValue(me, tb),
                    tdpadding = parseInt(domUtils.getComputedStyle(tb.getElementsByTagName('td')[0], "padding-top"));

                if (ut.isFullCol()) {
                    var captionArr = domUtils.getElementsByTagName(tb, "caption"),
                        thArr = domUtils.getElementsByTagName(tb, "th"),
                        captionHeight, thHeight;

                    if (captionArr.length > 0) {
                        captionHeight = captionArr[0].offsetHeight;
                    }
                    if (thArr.length > 0) {
                        thHeight = thArr[0].offsetHeight;
                    }

                    sumHeight = tb.offsetHeight - (captionHeight || 0) - (thHeight || 0);
                    rowNum = thArr.length == 0 ? ut.rowsNum : (ut.rowsNum - 1);
                } else {
                    var begin = ut.cellsRange.beginRowIndex,
                        end = ut.cellsRange.endRowIndex,
                        count = 0,
                        trs = domUtils.getElementsByTagName(tb, "tr");
                    for (var i = begin; i <= end; i++) {
                        sumHeight += trs[i].offsetHeight;
                        count += 1;
                    }
                    rowNum = count;
                }
                //ie8下是混杂模式
                if (browser.ie && browser.version < 9) {
                    averageHeight = Math.ceil(sumHeight / rowNum);
                } else {
                    averageHeight = Math.ceil(sumHeight / rowNum) - tbAttr.tdBorder * 2 - tdpadding * 2;
                }
                return averageHeight;
            }

            function setAverageHeight(averageHeight) {
                var cells = ut.isFullCol() ? domUtils.getElementsByTagName(ut.table, "td") : ut.selectedTds;
                utils.each(cells, function (node) {
                    if (node.rowSpan == 1) {
                        node.setAttribute("height", averageHeight);
                    }
                });
            }

            if (ut && ut.selectedTds.length) {
                setAverageHeight(getAverageHeight());
            }
        }
    };

    //单元格对齐方式
    UE.commands['cellalignment'] = {
        queryCommandState: function () {
            return getTableItemsByRange(this).table ? 0 : -1
        },
        execCommand: function (cmd, data) {
            var me = this,
                ut = getUETableBySelected(me);

            if (!ut) {
                var start = me.selection.getStart(),
                    cell = start && domUtils.findParentByTagName(start, ["td", "th", "caption"], true);
                if (!/caption/ig.test(cell.tagName)) {
                    domUtils.setAttributes(cell, data);
                } else {
                    cell.style.textAlign = data.align;
                    cell.style.verticalAlign = data.vAlign;
                }
                me.selection.getRange().setCursor(true);
            } else {
                utils.each(ut.selectedTds, function (cell) {
                    domUtils.setAttributes(cell, data);
                });
            }
        },
        /**
         * 查询当前点击的单元格的对齐状态， 如果当前已经选择了多个单元格， 则会返回所有单元格经过统一协调过后的状态
         * @see UE.UETable.getTableCellAlignState
         */
        queryCommandValue: function (cmd) {

            var activeMenuCell = getTableItemsByRange( this).cell;

            if( !activeMenuCell ) {
                activeMenuCell = getSelectedArr(this)[0];
            }

            if (!activeMenuCell) {

                return null;

            } else {

                //获取同时选中的其他单元格
                var cells = UE.UETable.getUETable(activeMenuCell).selectedTds;

                !cells.length && ( cells = activeMenuCell );

                return UE.UETable.getTableCellAlignState(cells);

            }

        }
    };
    //表格对齐方式
    UE.commands['tablealignment'] = {
        queryCommandState: function () {
            if (browser.ie && browser.version < 8) {
                return -1;
            }
            return getTableItemsByRange(this).table ? 0 : -1
        },
        execCommand: function (cmd, value) {
            var me = this,
                start = me.selection.getStart(),
                table = start && domUtils.findParentByTagName(start, ["table"], true);

            if (table) {
                table.setAttribute("align",value);
            }
        }
    };

    //表格属性
    UE.commands['edittable'] = {
        queryCommandState: function () {
            return getTableItemsByRange(this).table ? 0 : -1
        },
        execCommand: function (cmd, color) {
            var rng = this.selection.getRange(),
                table = domUtils.findParentByTagName(rng.startContainer, 'table');
            if (table) {
                var arr = domUtils.getElementsByTagName(table, "td").concat(
                    domUtils.getElementsByTagName(table, "th"),
                    domUtils.getElementsByTagName(table, "caption")
                );
                utils.each(arr, function (node) {
                    node.style.borderColor = color;
                });
            }
        }
    };
    //单元格属性
    UE.commands['edittd'] = {
        queryCommandState: function () {
            return getTableItemsByRange(this).table ? 0 : -1
        },
        execCommand: function (cmd, bkColor) {
            var me = this,
                ut = getUETableBySelected(me);

            if (!ut) {
                var start = me.selection.getStart(),
                    cell = start && domUtils.findParentByTagName(start, ["td", "th", "caption"], true);
                if (cell) {
                    cell.style.backgroundColor = bkColor;
                }
            } else {
                utils.each(ut.selectedTds, function (cell) {
                    cell.style.backgroundColor = bkColor;
                });
            }
        }
    };

    UE.commands["settablebackground"] = {
        queryCommandState: function () {
            return getSelectedArr(this).length > 1 ? 0 : -1;
        },
        execCommand: function (cmd, value) {
            var cells, ut;
            cells = getSelectedArr(this);
            ut = getUETable(cells[0]);
            ut.setBackground(cells, value);
        }
    };

    UE.commands["cleartablebackground"] = {
        queryCommandState: function () {
            var cells = getSelectedArr(this);
            if (!cells.length)return -1;
            for (var i = 0, cell; cell = cells[i++];) {
                if (cell.style.backgroundColor !== "") return 0;
            }
            return -1;
        },
        execCommand: function () {
            var cells = getSelectedArr(this),
                ut = getUETable(cells[0]);
            ut.removeBackground(cells);
        }
    };

    UE.commands["interlacetable"] = UE.commands["uninterlacetable"] = {
        queryCommandState: function (cmd) {
            var table = getTableItemsByRange(this).table;
            if (!table) return -1;
            var interlaced = table.getAttribute("interlaced");
            if (cmd == "interlacetable") {
                //TODO 待定
                //是否需要待定，如果设置，则命令只能单次执行成功，但反射具备toggle效果；否则可以覆盖前次命令，但反射将不存在toggle效果
                return (interlaced === "enabled") ? -1 : 0;
            } else {
                return (!interlaced || interlaced === "disabled") ? -1 : 0;
            }
        },
        execCommand: function (cmd, classList) {
            var table = getTableItemsByRange(this).table;
            if (cmd == "interlacetable") {
                table.setAttribute("interlaced", "enabled");
                this.fireEvent("interlacetable", table, classList);
            } else {
                table.setAttribute("interlaced", "disabled");
                this.fireEvent("uninterlacetable", table);
            }
        }
    };
    UE.commands["setbordervisible"] = {
        queryCommandState: function (cmd) {
            var table = getTableItemsByRange(this).table;
            if (!table) return -1;
            return 0;
        },
        execCommand: function () {
            var table = getTableItemsByRange(this).table;
            utils.each(domUtils.getElementsByTagName(table,'td'),function(td){
                td.style.borderWidth = '1px';
                td.style.borderStyle = 'solid';
            })
        }
    };
    function resetTdWidth(table, editor) {
        var tds = domUtils.getElementsByTagName(table,'td th');
        utils.each(tds, function (td) {
            td.removeAttribute("width");
        });
        table.setAttribute('width', getTableWidth(editor, true, getDefaultValue(editor, table)));
        var tdsWidths = [];
        setTimeout(function () {
            utils.each(tds, function (td) {
                (td.colSpan == 1) && tdsWidths.push(td.offsetWidth)
            })
            utils.each(tds, function (td,i) {
                (td.colSpan == 1) && td.setAttribute("width", tdsWidths[i] + "");
            })
        }, 0);
    }

    function getTableWidth(editor, needIEHack, defaultValue) {
        var body = editor.body;
        return body.offsetWidth - (needIEHack ? parseInt(domUtils.getComputedStyle(body, 'margin-left'), 10) * 2 : 0) - defaultValue.tableBorder * 2 - (editor.options.offsetWidth || 0);
    }

    function getSelectedArr(editor) {
        var cell = getTableItemsByRange(editor).cell;
        if (cell) {
            var ut = getUETable(cell);
            return ut.selectedTds.length ? ut.selectedTds : [cell];
        } else {
            return [];
        }
    }
})();


// plugins/table.action.js
/**
 * Created with JetBrains PhpStorm.
 * User: taoqili
 * Date: 12-10-12
 * Time: 上午10:05
 * To change this template use File | Settings | File Templates.
 */
UE.plugins['table'] = function () {
    var me = this,
        tabTimer = null,
        //拖动计时器
        tableDragTimer = null,
        //双击计时器
        tableResizeTimer = null,
        //单元格最小宽度
        cellMinWidth = 5,
        isInResizeBuffer = false,
        //单元格边框大小
        cellBorderWidth = 5,
        //鼠标偏移距离
        offsetOfTableCell = 10,
        //记录在有限时间内的点击状态， 共有3个取值， 0, 1, 2。 0代表未初始化， 1代表单击了1次，2代表2次
        singleClickState = 0,
        userActionStatus = null,
        //双击允许的时间范围
        dblclickTime = 360,
        UT = UE.UETable,
        getUETable = function (tdOrTable) {
            return UT.getUETable(tdOrTable);
        },
        getUETableBySelected = function (editor) {
            return UT.getUETableBySelected(editor);
        },
        getDefaultValue = function (editor, table) {
            return UT.getDefaultValue(editor, table);
        },
        removeSelectedClass = function (cells) {
            return UT.removeSelectedClass(cells);
        };

    function showError(e) {
//        throw e;
    }
    me.ready(function(){
        var me = this;
        var orgGetText = me.selection.getText;
        me.selection.getText = function(){
            var table = getUETableBySelected(me);
            if(table){
                var str = '';
                utils.each(table.selectedTds,function(td){
                    str += td[browser.ie?'innerText':'textContent'];
                })
                return str;
            }else{
                return orgGetText.call(me.selection)
            }

        }
    })

    //处理拖动及框选相关方法
    var startTd = null, //鼠标按下时的锚点td
        currentTd = null, //当前鼠标经过时的td
        onDrag = "", //指示当前拖动状态，其值可为"","h","v" ,分别表示未拖动状态，横向拖动状态，纵向拖动状态，用于鼠标移动过程中的判断
        onBorder = false, //检测鼠标按下时是否处在单元格边缘位置
        dragButton = null,
        dragOver = false,
        dragLine = null, //模拟的拖动线
        dragTd = null;    //发生拖动的目标td

    var mousedown = false,
    //todo 判断混乱模式
        needIEHack = true;

    me.setOpt({
        'maxColNum':20,
        'maxRowNum':100,
        'defaultCols':5,
        'defaultRows':5,
        'tdvalign':'top',
        'cursorpath':me.options.UEDITOR_HOME_URL + "themes/default/images/cursor_",
        'tableDragable':false,
        'classList':["ue-table-interlace-color-single","ue-table-interlace-color-double"]
    });
    me.getUETable = getUETable;
    var commands = {
        'deletetable':1,
        'inserttable':1,
        'cellvalign':1,
        'insertcaption':1,
        'deletecaption':1,
        'inserttitle':1,
        'deletetitle':1,
        "mergeright":1,
        "mergedown":1,
        "mergecells":1,
        "insertrow":1,
        "insertrownext":1,
        "deleterow":1,
        "insertcol":1,
        "insertcolnext":1,
        "deletecol":1,
        "splittocells":1,
        "splittorows":1,
        "splittocols":1,
        "adaptbytext":1,
        "adaptbywindow":1,
        "adaptbycustomer":1,
        "insertparagraph":1,
        "insertparagraphbeforetable":1,
        "averagedistributecol":1,
        "averagedistributerow":1
    };
    me.ready(function () {
        utils.cssRule('table',
            //选中的td上的样式
            '.selectTdClass{background-color:#edf5fa !important}' +
                'table.noBorderTable td,table.noBorderTable th,table.noBorderTable caption{border:1px dashed #ddd !important}' +
                //插入的表格的默认样式
                'table{margin-bottom:10px;border-collapse:collapse;display:table;}' +
                'td,th{padding: 5px 10px;border: 1px solid #DDD;}' +
                'caption{border:1px dashed #DDD;border-bottom:0;padding:3px;text-align:center;}' +
                'th{border-top:1px solid #BBB;background-color:#F7F7F7;}' +
                'table tr.firstRow th{border-top-width:2px;}' +
                '.ue-table-interlace-color-single{ background-color: #fcfcfc; } .ue-table-interlace-color-double{ background-color: #f7faff; }' +
                'td p{margin:0;padding:0;}', me.document);

        var tableCopyList, isFullCol, isFullRow;
        //注册del/backspace事件
        me.addListener('keydown', function (cmd, evt) {
            var me = this;
            var keyCode = evt.keyCode || evt.which;

            if (keyCode == 8) {

                var ut = getUETableBySelected(me);
                if (ut && ut.selectedTds.length) {

                    if (ut.isFullCol()) {
                        me.execCommand('deletecol')
                    } else if (ut.isFullRow()) {
                        me.execCommand('deleterow')
                    } else {
                        me.fireEvent('delcells');
                    }
                    domUtils.preventDefault(evt);
                }

                var caption = domUtils.findParentByTagName(me.selection.getStart(), 'caption', true),
                    range = me.selection.getRange();
                if (range.collapsed && caption && isEmptyBlock(caption)) {
                    me.fireEvent('saveScene');
                    var table = caption.parentNode;
                    domUtils.remove(caption);
                    if (table) {
                        range.setStart(table.rows[0].cells[0], 0).setCursor(false, true);
                    }
                    me.fireEvent('saveScene');
                }

            }

            if (keyCode == 46) {

                ut = getUETableBySelected(me);
                if (ut) {
                    me.fireEvent('saveScene');
                    for (var i = 0, ci; ci = ut.selectedTds[i++];) {
                        domUtils.fillNode(me.document, ci)
                    }
                    me.fireEvent('saveScene');
                    domUtils.preventDefault(evt);

                }

            }
            if (keyCode == 13) {

                var rng = me.selection.getRange(),
                    caption = domUtils.findParentByTagName(rng.startContainer, 'caption', true);
                if (caption) {
                    var table = domUtils.findParentByTagName(caption, 'table');
                    if (!rng.collapsed) {

                        rng.deleteContents();
                        me.fireEvent('saveScene');
                    } else {
                        if (caption) {
                            rng.setStart(table.rows[0].cells[0], 0).setCursor(false, true);
                        }
                    }
                    domUtils.preventDefault(evt);
                    return;
                }
                if (rng.collapsed) {
                    var table = domUtils.findParentByTagName(rng.startContainer, 'table');
                    if (table) {
                        var cell = table.rows[0].cells[0],
                            start = domUtils.findParentByTagName(me.selection.getStart(), ['td', 'th'], true),
                            preNode = table.previousSibling;
                        if (cell === start && (!preNode || preNode.nodeType == 1 && preNode.tagName == 'TABLE' ) && domUtils.isStartInblock(rng)) {
                            var first = domUtils.findParent(me.selection.getStart(), function(n){return domUtils.isBlockElm(n)}, true);
                            if(first && ( /t(h|d)/i.test(first.tagName) || first ===  start.firstChild )){
                                me.execCommand('insertparagraphbeforetable');
                                domUtils.preventDefault(evt);
                            }

                        }
                    }
                }
            }

            if ((evt.ctrlKey || evt.metaKey) && evt.keyCode == '67') {
                tableCopyList = null;
                var ut = getUETableBySelected(me);
                if (ut) {
                    var tds = ut.selectedTds;
                    isFullCol = ut.isFullCol();
                    isFullRow = ut.isFullRow();
                    tableCopyList = [
                        [ut.cloneCell(tds[0],null,true)]
                    ];
                    for (var i = 1, ci; ci = tds[i]; i++) {
                        if (ci.parentNode !== tds[i - 1].parentNode) {
                            tableCopyList.push([ut.cloneCell(ci,null,true)]);
                        } else {
                            tableCopyList[tableCopyList.length - 1].push(ut.cloneCell(ci,null,true));
                        }

                    }
                }
            }
        });
        me.addListener("tablehasdeleted",function(){
            toggleDraggableState(this, false, "", null);
            if (dragButton)domUtils.remove(dragButton);
        });

        me.addListener('beforepaste', function (cmd, html) {
            var me = this;
            var rng = me.selection.getRange();
            if (domUtils.findParentByTagName(rng.startContainer, 'caption', true)) {
                var div = me.document.createElement("div");
                div.innerHTML = html.html;
                //trace:3729
                html.html = div[browser.ie9below ? 'innerText' : 'textContent'];
                return;
            }
            var table = getUETableBySelected(me);
            if (tableCopyList) {
                me.fireEvent('saveScene');
                var rng = me.selection.getRange();
                var td = domUtils.findParentByTagName(rng.startContainer, ['td', 'th'], true), tmpNode, preNode;
                if (td) {
                    var ut = getUETable(td);
                    if (isFullRow) {
                        var rowIndex = ut.getCellInfo(td).rowIndex;
                        if (td.tagName == 'TH') {
                            rowIndex++;
                        }
                        for (var i = 0, ci; ci = tableCopyList[i++];) {
                            var tr = ut.insertRow(rowIndex++, "td");
                            for (var j = 0, cj; cj = ci[j]; j++) {
                                var cell = tr.cells[j];
                                if (!cell) {
                                    cell = tr.insertCell(j)
                                }
                                cell.innerHTML = cj.innerHTML;
                                cj.getAttribute('width') && cell.setAttribute('width', cj.getAttribute('width'));
                                cj.getAttribute('vAlign') && cell.setAttribute('vAlign', cj.getAttribute('vAlign'));
                                cj.getAttribute('align') && cell.setAttribute('align', cj.getAttribute('align'));
                                cj.style.cssText && (cell.style.cssText = cj.style.cssText)
                            }
                            for (var j = 0, cj; cj = tr.cells[j]; j++) {
                                if (!ci[j])
                                    break;
                                cj.innerHTML = ci[j].innerHTML;
                                ci[j].getAttribute('width') && cj.setAttribute('width', ci[j].getAttribute('width'));
                                ci[j].getAttribute('vAlign') && cj.setAttribute('vAlign', ci[j].getAttribute('vAlign'));
                                ci[j].getAttribute('align') && cj.setAttribute('align', ci[j].getAttribute('align'));
                                ci[j].style.cssText && (cj.style.cssText = ci[j].style.cssText)
                            }
                        }
                    } else {
                        if (isFullCol) {
                            cellInfo = ut.getCellInfo(td);
                            var maxColNum = 0;
                            for (var j = 0, ci = tableCopyList[0], cj; cj = ci[j++];) {
                                maxColNum += cj.colSpan || 1;
                            }
                            me.__hasEnterExecCommand = true;
                            for (i = 0; i < maxColNum; i++) {
                                me.execCommand('insertcol');
                            }
                            me.__hasEnterExecCommand = false;
                            td = ut.table.rows[0].cells[cellInfo.cellIndex];
                            if (td.tagName == 'TH') {
                                td = ut.table.rows[1].cells[cellInfo.cellIndex];
                            }
                        }
                        for (var i = 0, ci; ci = tableCopyList[i++];) {
                            tmpNode = td;
                            for (var j = 0, cj; cj = ci[j++];) {
                                if (td) {
                                    td.innerHTML = cj.innerHTML;
                                    //todo 定制处理
                                    cj.getAttribute('width') && td.setAttribute('width', cj.getAttribute('width'));
                                    cj.getAttribute('vAlign') && td.setAttribute('vAlign', cj.getAttribute('vAlign'));
                                    cj.getAttribute('align') && td.setAttribute('align', cj.getAttribute('align'));
                                    cj.style.cssText && (td.style.cssText = cj.style.cssText);
                                    preNode = td;
                                    td = td.nextSibling;
                                } else {
                                    var cloneTd = cj.cloneNode(true);
                                    domUtils.removeAttributes(cloneTd, ['class', 'rowSpan', 'colSpan']);

                                    preNode.parentNode.appendChild(cloneTd)
                                }
                            }
                            td = ut.getNextCell(tmpNode, true, true);
                            if (!tableCopyList[i])
                                break;
                            if (!td) {
                                var cellInfo = ut.getCellInfo(tmpNode);
                                ut.table.insertRow(ut.table.rows.length);
                                ut.update();
                                td = ut.getVSideCell(tmpNode, true);
                            }
                        }
                    }
                    ut.update();
                } else {
                    table = me.document.createElement('table');
                    for (var i = 0, ci; ci = tableCopyList[i++];) {
                        var tr = table.insertRow(table.rows.length);
                        for (var j = 0, cj; cj = ci[j++];) {
                            cloneTd = UT.cloneCell(cj,null,true);
                            domUtils.removeAttributes(cloneTd, ['class']);
                            tr.appendChild(cloneTd)
                        }
                        if (j == 2 && cloneTd.rowSpan > 1) {
                            cloneTd.rowSpan = 1;
                        }
                    }

                    var defaultValue = getDefaultValue(me),
                        width = me.body.offsetWidth -
                            (needIEHack ? parseInt(domUtils.getComputedStyle(me.body, 'margin-left'), 10) * 2 : 0) - defaultValue.tableBorder * 2 - (me.options.offsetWidth || 0);
                    me.execCommand('insertHTML', '<table  ' +
                        ( isFullCol && isFullRow ? 'width="' + width + '"' : '') +
                        '>' + table.innerHTML.replace(/>\s*</g, '><').replace(/\bth\b/gi, "td") + '</table>')
                }
                me.fireEvent('contentchange');
                me.fireEvent('saveScene');
                html.html = '';
                return true;
            } else {
                var div = me.document.createElement("div"), tables;
                div.innerHTML = html.html;
                tables = div.getElementsByTagName("table");
                if (domUtils.findParentByTagName(me.selection.getStart(), 'table')) {
                    utils.each(tables, function (t) {
                        domUtils.remove(t)
                    });
                    if (domUtils.findParentByTagName(me.selection.getStart(), 'caption', true)) {
                        div.innerHTML = div[browser.ie ? 'innerText' : 'textContent'];
                    }
                } else {
                    utils.each(tables, function (table) {
                        removeStyleSize(table, true);
                        domUtils.removeAttributes(table, ['style', 'border']);
                        utils.each(domUtils.getElementsByTagName(table, "td"), function (td) {
                            if (isEmptyBlock(td)) {
                                domUtils.fillNode(me.document, td);
                            }
                            removeStyleSize(td, true);
//                            domUtils.removeAttributes(td, ['style'])
                        });
                    });
                }
                html.html = div.innerHTML;
            }
        });

        me.addListener('afterpaste', function () {
            utils.each(domUtils.getElementsByTagName(me.body, "table"), function (table) {
                if (table.offsetWidth > me.body.offsetWidth) {
                    var defaultValue = getDefaultValue(me, table);
                    table.style.width = me.body.offsetWidth - (needIEHack ? parseInt(domUtils.getComputedStyle(me.body, 'margin-left'), 10) * 2 : 0) - defaultValue.tableBorder * 2 - (me.options.offsetWidth || 0) + 'px'
                }
            })
        });
        me.addListener('blur', function () {
            tableCopyList = null;
        });
        var timer;
        me.addListener('keydown', function () {
            clearTimeout(timer);
            timer = setTimeout(function () {
                var rng = me.selection.getRange(),
                    cell = domUtils.findParentByTagName(rng.startContainer, ['th', 'td'], true);
                if (cell) {
                    var table = cell.parentNode.parentNode.parentNode;
                    if (table.offsetWidth > table.getAttribute("width")) {
                        cell.style.wordBreak = "break-all";
                    }
                }

            }, 100);
        });
        me.addListener("selectionchange", function () {
            toggleDraggableState(me, false, "", null);
        });


        //内容变化时触发索引更新
        //todo 可否考虑标记检测，如果不涉及表格的变化就不进行索引重建和更新
        me.addListener("contentchange", function () {
            var me = this;
            //尽可能排除一些不需要更新的状况
            hideDragLine(me);
            if (getUETableBySelected(me))return;
            var rng = me.selection.getRange();
            var start = rng.startContainer;
            start = domUtils.findParentByTagName(start, ['td', 'th'], true);
            utils.each(domUtils.getElementsByTagName(me.document, 'table'), function (table) {
                if (me.fireEvent("excludetable", table) === true) return;
                table.ueTable = new UT(table);
                //trace:3742
//                utils.each(domUtils.getElementsByTagName(me.document, 'td'), function (td) {
//
//                    if (domUtils.isEmptyBlock(td) && td !== start) {
//                        domUtils.fillNode(me.document, td);
//                        if (browser.ie && browser.version == 6) {
//                            td.innerHTML = '&nbsp;'
//                        }
//                    }
//                });
//                utils.each(domUtils.getElementsByTagName(me.document, 'th'), function (th) {
//                    if (domUtils.isEmptyBlock(th) && th !== start) {
//                        domUtils.fillNode(me.document, th);
//                        if (browser.ie && browser.version == 6) {
//                            th.innerHTML = '&nbsp;'
//                        }
//                    }
//                });
                table.onmouseover = function () {
                    me.fireEvent('tablemouseover', table);
                };
                table.onmousemove = function () {
                    me.fireEvent('tablemousemove', table);
                    me.options.tableDragable && toggleDragButton(true, this, me);
                    utils.defer(function(){
                        me.fireEvent('contentchange',50)
                    },true)
                };
                table.onmouseout = function () {
                    me.fireEvent('tablemouseout', table);
                    toggleDraggableState(me, false, "", null);
                    hideDragLine(me);
                };
                table.onclick = function (evt) {
                    evt = me.window.event || evt;
                    var target = getParentTdOrTh(evt.target || evt.srcElement);
                    if (!target)return;
                    var ut = getUETable(target),
                        table = ut.table,
                        cellInfo = ut.getCellInfo(target),
                        cellsRange,
                        rng = me.selection.getRange();
//                    if ("topLeft" == inPosition(table, mouseCoords(evt))) {
//                        cellsRange = ut.getCellsRange(ut.table.rows[0].cells[0], ut.getLastCell());
//                        ut.setSelected(cellsRange);
//                        return;
//                    }
//                    if ("bottomRight" == inPosition(table, mouseCoords(evt))) {
//
//                        return;
//                    }
                    if (inTableSide(table, target, evt, true)) {
                        var endTdCol = ut.getCell(ut.indexTable[ut.rowsNum - 1][cellInfo.colIndex].rowIndex, ut.indexTable[ut.rowsNum - 1][cellInfo.colIndex].cellIndex);
                        if (evt.shiftKey && ut.selectedTds.length) {
                            if (ut.selectedTds[0] !== endTdCol) {
                                cellsRange = ut.getCellsRange(ut.selectedTds[0], endTdCol);
                                ut.setSelected(cellsRange);
                            } else {
                                rng && rng.selectNodeContents(endTdCol).select();
                            }
                        } else {
                            if (target !== endTdCol) {
                                cellsRange = ut.getCellsRange(target, endTdCol);
                                ut.setSelected(cellsRange);
                            } else {
                                rng && rng.selectNodeContents(endTdCol).select();
                            }
                        }
                        return;
                    }
                    if (inTableSide(table, target, evt)) {
                        var endTdRow = ut.getCell(ut.indexTable[cellInfo.rowIndex][ut.colsNum - 1].rowIndex, ut.indexTable[cellInfo.rowIndex][ut.colsNum - 1].cellIndex);
                        if (evt.shiftKey && ut.selectedTds.length) {
                            if (ut.selectedTds[0] !== endTdRow) {
                                cellsRange = ut.getCellsRange(ut.selectedTds[0], endTdRow);
                                ut.setSelected(cellsRange);
                            } else {
                                rng && rng.selectNodeContents(endTdRow).select();
                            }
                        } else {
                            if (target !== endTdRow) {
                                cellsRange = ut.getCellsRange(target, endTdRow);
                                ut.setSelected(cellsRange);
                            } else {
                                rng && rng.selectNodeContents(endTdRow).select();
                            }
                        }
                    }
                };
            });

            switchBorderColor(me, true);
        });

        domUtils.on(me.document, "mousemove", mouseMoveEvent);

        domUtils.on(me.document, "mouseout", function (evt) {
            var target = evt.target || evt.srcElement;
            if (target.tagName == "TABLE") {
                toggleDraggableState(me, false, "", null);
            }
        });
        /**
         * 表格隔行变色
         */
        me.addListener("interlacetable",function(type,table,classList){
            if(!table) return;
            var me = this,
                rows = table.rows,
                len = rows.length,
                getClass = function(list,index,repeat){
                    return list[index] ? list[index] : repeat ? list[index % list.length]: "";
                };
            for(var i = 0;i<len;i++){
                rows[i].className = getClass( classList|| me.options.classList,i,true);
            }
        });
        me.addListener("uninterlacetable",function(type,table){
            if(!table) return;
            var me = this,
                rows = table.rows,
                classList = me.options.classList,
                len = rows.length;
            for(var i = 0;i<len;i++){
                domUtils.removeClasses( rows[i], classList );
            }
        });

        me.addListener("mousedown", mouseDownEvent);
        me.addListener("mouseup", mouseUpEvent);
        //拖动的时候触发mouseup
        domUtils.on( me.body, 'dragstart', function( evt ){
            mouseUpEvent.call( me, 'dragstart', evt );
        });
        me.addOutputRule(function(root){
            utils.each(root.getNodesByTagName('div'),function(n){
                if (n.getAttr('id') == 'ue_tableDragLine') {
                    n.parentNode.removeChild(n);
                }
            });
        });

        var currentRowIndex = 0;
        me.addListener("mousedown", function () {
            currentRowIndex = 0;
        });
        me.addListener('tabkeydown', function () {
            var range = this.selection.getRange(),
                common = range.getCommonAncestor(true, true),
                table = domUtils.findParentByTagName(common, 'table');
            if (table) {
                if (domUtils.findParentByTagName(common, 'caption', true)) {
                    var cell = domUtils.getElementsByTagName(table, 'th td');
                    if (cell && cell.length) {
                        range.setStart(cell[0], 0).setCursor(false, true)
                    }
                } else {
                    var cell = domUtils.findParentByTagName(common, ['td', 'th'], true),
                        ua = getUETable(cell);
                    currentRowIndex = cell.rowSpan > 1 ? currentRowIndex : ua.getCellInfo(cell).rowIndex;
                    var nextCell = ua.getTabNextCell(cell, currentRowIndex);
                    if (nextCell) {
                        if (isEmptyBlock(nextCell)) {
                            range.setStart(nextCell, 0).setCursor(false, true)
                        } else {
                            range.selectNodeContents(nextCell).select()
                        }
                    } else {
                        me.fireEvent('saveScene');
                        me.__hasEnterExecCommand = true;
                        this.execCommand('insertrownext');
                        me.__hasEnterExecCommand = false;
                        range = this.selection.getRange();
                        range.setStart(table.rows[table.rows.length - 1].cells[0], 0).setCursor();
                        me.fireEvent('saveScene');
                    }
                }
                return true;
            }

        });
        browser.ie && me.addListener('selectionchange', function () {
            toggleDraggableState(this, false, "", null);
        });
        me.addListener("keydown", function (type, evt) {
            var me = this;
            //处理在表格的最后一个输入tab产生新的表格
            var keyCode = evt.keyCode || evt.which;
            if (keyCode == 8 || keyCode == 46) {
                return;
            }
            var notCtrlKey = !evt.ctrlKey && !evt.metaKey && !evt.shiftKey && !evt.altKey;
            notCtrlKey && removeSelectedClass(domUtils.getElementsByTagName(me.body, "td"));
            var ut = getUETableBySelected(me);
            if (!ut) return;
            notCtrlKey && ut.clearSelected();
        });

        me.addListener("beforegetcontent", function () {
            switchBorderColor(this, false);
            browser.ie && utils.each(this.document.getElementsByTagName('caption'), function (ci) {
                if (domUtils.isEmptyNode(ci)) {
                    ci.innerHTML = '&nbsp;'
                }
            });
        });
        me.addListener("aftergetcontent", function () {
            switchBorderColor(this, true);
        });
        me.addListener("getAllHtml", function () {
            removeSelectedClass(me.document.getElementsByTagName("td"));
        });
        //修正全屏状态下插入的表格宽度在非全屏状态下撑开编辑器的情况
        me.addListener("fullscreenchanged", function (type, fullscreen) {
            if (!fullscreen) {
                var ratio = this.body.offsetWidth / document.body.offsetWidth,
                    tables = domUtils.getElementsByTagName(this.body, "table");
                utils.each(tables, function (table) {
                    if (table.offsetWidth < me.body.offsetWidth) return false;
                    var tds = domUtils.getElementsByTagName(table, "td"),
                        backWidths = [];
                    utils.each(tds, function (td) {
                        backWidths.push(td.offsetWidth);
                    });
                    for (var i = 0, td; td = tds[i]; i++) {
                        td.setAttribute("width", Math.floor(backWidths[i] * ratio));
                    }
                    table.setAttribute("width", Math.floor(getTableWidth(me, needIEHack, getDefaultValue(me))))
                });
            }
        });

        //重写execCommand命令，用于处理框选时的处理
        var oldExecCommand = me.execCommand;
        me.execCommand = function (cmd, datatat) {

            var me = this,
                args = arguments;

            cmd = cmd.toLowerCase();
            var ut = getUETableBySelected(me), tds,
                range = new dom.Range(me.document),
                cmdFun = me.commands[cmd] || UE.commands[cmd],
                result;
            if (!cmdFun) return;
            if (ut && !commands[cmd] && !cmdFun.notNeedUndo && !me.__hasEnterExecCommand) {
                me.__hasEnterExecCommand = true;
                me.fireEvent("beforeexeccommand", cmd);
                tds = ut.selectedTds;
                var lastState = -2, lastValue = -2, value, state;
                for (var i = 0, td; td = tds[i]; i++) {
                    if (isEmptyBlock(td)) {
                        range.setStart(td, 0).setCursor(false, true)
                    } else {
                        range.selectNode(td).select(true);
                    }
                    state = me.queryCommandState(cmd);
                    value = me.queryCommandValue(cmd);
                    if (state != -1) {
                        if (lastState !== state || lastValue !== value) {
                            me._ignoreContentChange = true;
                            result = oldExecCommand.apply(me, arguments);
                            me._ignoreContentChange = false;

                        }
                        lastState = me.queryCommandState(cmd);
                        lastValue = me.queryCommandValue(cmd);
                        if (domUtils.isEmptyBlock(td)) {
                            domUtils.fillNode(me.document, td)
                        }
                    }
                }
                range.setStart(tds[0], 0).shrinkBoundary(true).setCursor(false, true);
                me.fireEvent('contentchange');
                me.fireEvent("afterexeccommand", cmd);
                me.__hasEnterExecCommand = false;
                me._selectionChange();
            } else {
                result = oldExecCommand.apply(me, arguments);
            }
            return result;
        };


    });
    /**
     * 删除obj的宽高style，改成属性宽高
     * @param obj
     * @param replaceToProperty
     */
    function removeStyleSize(obj, replaceToProperty) {
        removeStyle(obj, "width", true);
        removeStyle(obj, "height", true);
    }

    function removeStyle(obj, styleName, replaceToProperty) {
        if (obj.style[styleName]) {
            replaceToProperty && obj.setAttribute(styleName, parseInt(obj.style[styleName], 10));
            obj.style[styleName] = "";
        }
    }

    function getParentTdOrTh(ele) {
        if (ele.tagName == "TD" || ele.tagName == "TH") return ele;
        var td;
        if (td = domUtils.findParentByTagName(ele, "td", true) || domUtils.findParentByTagName(ele, "th", true)) return td;
        return null;
    }

    function isEmptyBlock(node) {
        var reg = new RegExp(domUtils.fillChar, 'g');
        if (node[browser.ie ? 'innerText' : 'textContent'].replace(/^\s*$/, '').replace(reg, '').length > 0) {
            return 0;
        }
        for (var n in dtd.$isNotEmpty) {
            if (node.getElementsByTagName(n).length) {
                return 0;
            }
        }
        return 1;
    }


    function mouseCoords(evt) {
        if (evt.pageX || evt.pageY) {
            return { x:evt.pageX, y:evt.pageY };
        }
        return {
            x:evt.clientX + me.document.body.scrollLeft - me.document.body.clientLeft,
            y:evt.clientY + me.document.body.scrollTop - me.document.body.clientTop
        };
    }

    function mouseMoveEvent(evt) {

        if( isEditorDisabled() ) {
            return;
        }

        try {

            //普通状态下鼠标移动
            var target = getParentTdOrTh(evt.target || evt.srcElement),
                pos;

            //区分用户的行为是拖动还是双击
            if( isInResizeBuffer  ) {

                me.body.style.webkitUserSelect = 'none';

                if( Math.abs( userActionStatus.x - evt.clientX ) > offsetOfTableCell || Math.abs( userActionStatus.y - evt.clientY ) > offsetOfTableCell ) {
                    clearTableDragTimer();
                    isInResizeBuffer = false;
                    singleClickState = 0;
                    //drag action
                    tableBorderDrag(evt);
                }
            }

            //修改单元格大小时的鼠标移动
            if (onDrag && dragTd) {
                singleClickState = 0;
                me.body.style.webkitUserSelect = 'none';
                me.selection.getNative()[browser.ie9below ? 'empty' : 'removeAllRanges']();
                pos = mouseCoords(evt);
                toggleDraggableState(me, true, onDrag, pos, target);
                if (onDrag == "h") {
                    dragLine.style.left = getPermissionX(dragTd, evt) + "px";
                } else if (onDrag == "v") {
                    dragLine.style.top = getPermissionY(dragTd, evt) + "px";
                }
                return;
            }
            //当鼠标处于table上时，修改移动过程中的光标状态
            if (target) {
                //针对使用table作为容器的组件不触发拖拽效果
                if (me.fireEvent('excludetable', target) === true)
                    return;
                pos = mouseCoords(evt);
                var state = getRelation(target, pos),
                    table = domUtils.findParentByTagName(target, "table", true);

                if (inTableSide(table, target, evt, true)) {
                    if (me.fireEvent("excludetable", table) === true) return;
                    me.body.style.cursor = "url(" + me.options.cursorpath + "h.png),pointer";
                } else if (inTableSide(table, target, evt)) {
                    if (me.fireEvent("excludetable", table) === true) return;
                    me.body.style.cursor = "url(" + me.options.cursorpath + "v.png),pointer";
                } else {
                    me.body.style.cursor = "text";
                    var curCell = target;
                    if (/\d/.test(state)) {
                        state = state.replace(/\d/, '');
                        target = getUETable(target).getPreviewCell(target, state == "v");
                    }
                    //位于第一行的顶部或者第一列的左边时不可拖动
                    toggleDraggableState(me, target ? !!state : false, target ? state : '', pos, target);

                }
            } else {
                toggleDragButton(false, table, me);
            }

        } catch (e) {
            showError(e);
        }
    }

    var dragButtonTimer;

    function toggleDragButton(show, table, editor) {
        if (!show) {
            if (dragOver)return;
            dragButtonTimer = setTimeout(function () {
                !dragOver && dragButton && dragButton.parentNode && dragButton.parentNode.removeChild(dragButton);
            }, 2000);
        } else {
            createDragButton(table, editor);
        }
    }

    function createDragButton(table, editor) {
        var pos = domUtils.getXY(table),
            doc = table.ownerDocument;
        if (dragButton && dragButton.parentNode)return dragButton;
        dragButton = doc.createElement("div");
        dragButton.contentEditable = false;
        dragButton.innerHTML = "";
        dragButton.style.cssText = "width:15px;height:15px;background-image:url(" + editor.options.UEDITOR_HOME_URL + "dialogs/table/dragicon.png);position: absolute;cursor:move;top:" + (pos.y - 15) + "px;left:" + (pos.x) + "px;";
        domUtils.unSelectable(dragButton);
        dragButton.onmouseover = function (evt) {
            dragOver = true;
        };
        dragButton.onmouseout = function (evt) {
            dragOver = false;
        };
        domUtils.on(dragButton, 'click', function (type, evt) {
            doClick(evt, this);
        });
        domUtils.on(dragButton, 'dblclick', function (type, evt) {
            doDblClick(evt);
        });
        domUtils.on(dragButton, 'dragstart', function (type, evt) {
            domUtils.preventDefault(evt);
        });
        var timer;

        function doClick(evt, button) {
            // 部分浏览器下需要清理
            clearTimeout(timer);
            timer = setTimeout(function () {
                editor.fireEvent("tableClicked", table, button);
            }, 300);
        }

        function doDblClick(evt) {
            clearTimeout(timer);
            var ut = getUETable(table),
                start = table.rows[0].cells[0],
                end = ut.getLastCell(),
                range = ut.getCellsRange(start, end);
            editor.selection.getRange().setStart(start, 0).setCursor(false, true);
            ut.setSelected(range);
        }

        doc.body.appendChild(dragButton);
    }


//    function inPosition(table, pos) {
//        var tablePos = domUtils.getXY(table),
//            width = table.offsetWidth,
//            height = table.offsetHeight;
//        if (pos.x - tablePos.x < 5 && pos.y - tablePos.y < 5) {
//            return "topLeft";
//        } else if (tablePos.x + width - pos.x < 5 && tablePos.y + height - pos.y < 5) {
//            return "bottomRight";
//        }
//    }

    function inTableSide(table, cell, evt, top) {
        var pos = mouseCoords(evt),
            state = getRelation(cell, pos);

        if (top) {
            var caption = table.getElementsByTagName("caption")[0],
                capHeight = caption ? caption.offsetHeight : 0;
            return (state == "v1") && ((pos.y - domUtils.getXY(table).y - capHeight) < 8);
        } else {
            return (state == "h1") && ((pos.x - domUtils.getXY(table).x) < 8);
        }
    }

    /**
     * 获取拖动时允许的X轴坐标
     * @param dragTd
     * @param evt
     */
    function getPermissionX(dragTd, evt) {
        var ut = getUETable(dragTd);
        if (ut) {
            var preTd = ut.getSameEndPosCells(dragTd, "x")[0],
                nextTd = ut.getSameStartPosXCells(dragTd)[0],
                mouseX = mouseCoords(evt).x,
                left = (preTd ? domUtils.getXY(preTd).x : domUtils.getXY(ut.table).x) + 20 ,
                right = nextTd ? domUtils.getXY(nextTd).x + nextTd.offsetWidth - 20 : (me.body.offsetWidth + 5 || parseInt(domUtils.getComputedStyle(me.body, "width"), 10));

            left += cellMinWidth;
            right -= cellMinWidth;

            return mouseX < left ? left : mouseX > right ? right : mouseX;
        }
    }

    /**
     * 获取拖动时允许的Y轴坐标
     */
    function getPermissionY(dragTd, evt) {
        try {
            var top = domUtils.getXY(dragTd).y,
                mousePosY = mouseCoords(evt).y;
            return mousePosY < top ? top : mousePosY;
        } catch (e) {
            showError(e);
        }
    }

    /**
     * 移动状态切换
     */
    function toggleDraggableState(editor, draggable, dir, mousePos, cell) {
        try {
            editor.body.style.cursor = dir == "h" ? "col-resize" : dir == "v" ? "row-resize" : "text";
            if (browser.ie) {
                if (dir && !mousedown && !getUETableBySelected(editor)) {
                    getDragLine(editor, editor.document);
                    showDragLineAt(dir, cell);
                } else {
                    hideDragLine(editor)
                }
            }
            onBorder = draggable;
        } catch (e) {
            showError(e);
        }
    }

    /**
     * 获取与UETable相关的resize line
     * @param uetable UETable对象
     */
    function getResizeLineByUETable() {

        var lineId = '_UETableResizeLine',
            line = this.document.getElementById( lineId );

        if( !line ) {
            line = this.document.createElement("div");
            line.id = lineId;
            line.contnetEditable = false;
            line.setAttribute("unselectable", "on");

            var styles = {
                width: 2*cellBorderWidth + 1 + 'px',
                position: 'absolute',
                'z-index': 100000,
                cursor: 'col-resize',
                background: 'red',
                display: 'none'
            };

            //切换状态
            line.onmouseout = function(){
                this.style.display = 'none';
            };

            utils.extend( line.style, styles );

            this.document.body.appendChild( line );

        }

        return line;

    }

    /**
     * 更新resize-line
     */
    function updateResizeLine( cell, uetable ) {

        var line = getResizeLineByUETable.call( this ),
            table = uetable.table,
            styles = {
                top: domUtils.getXY( table ).y + 'px',
                left: domUtils.getXY( cell).x + cell.offsetWidth - cellBorderWidth + 'px',
                display: 'block',
                height: table.offsetHeight + 'px'
            };

        utils.extend( line.style, styles );

    }

    /**
     * 显示resize-line
     */
    function showResizeLine( cell ) {

        var uetable = getUETable( cell );

        updateResizeLine.call( this, cell, uetable );

    }

    /**
     * 获取鼠标与当前单元格的相对位置
     * @param ele
     * @param mousePos
     */
    function getRelation(ele, mousePos) {
        var elePos = domUtils.getXY(ele);

        if( !elePos ) {
            return '';
        }

        if (elePos.x + ele.offsetWidth - mousePos.x < cellBorderWidth) {
            return "h";
        }
        if (mousePos.x - elePos.x < cellBorderWidth) {
            return 'h1'
        }
        if (elePos.y + ele.offsetHeight - mousePos.y < cellBorderWidth) {
            return "v";
        }
        if (mousePos.y - elePos.y < cellBorderWidth) {
            return 'v1'
        }
        return '';
    }

    function mouseDownEvent(type, evt) {

        if( isEditorDisabled() ) {
            return ;
        }

        userActionStatus = {
            x: evt.clientX,
            y: evt.clientY
        };

        //右键菜单单独处理
        if (evt.button == 2) {
            var ut = getUETableBySelected(me),
                flag = false;

            if (ut) {
                var td = getTargetTd(me, evt);
                utils.each(ut.selectedTds, function (ti) {
                    if (ti === td) {
                        flag = true;
                    }
                });
                if (!flag) {
                    removeSelectedClass(domUtils.getElementsByTagName(me.body, "th td"));
                    ut.clearSelected()
                } else {
                    td = ut.selectedTds[0];
                    setTimeout(function () {
                        me.selection.getRange().setStart(td, 0).setCursor(false, true);
                    }, 0);

                }
            }
        } else {
            tableClickHander( evt );
        }

    }

    //清除表格的计时器
    function clearTableTimer() {
        tabTimer && clearTimeout( tabTimer );
        tabTimer = null;
    }

    //双击收缩
    function tableDbclickHandler(evt) {
        singleClickState = 0;
        evt = evt || me.window.event;
        var target = getParentTdOrTh(evt.target || evt.srcElement);
        if (target) {
            var h;
            if (h = getRelation(target, mouseCoords(evt))) {

                hideDragLine( me );

                if (h == 'h1') {
                    h = 'h';
                    if (inTableSide(domUtils.findParentByTagName(target, "table"), target, evt)) {
                        me.execCommand('adaptbywindow');
                    } else {
                        target = getUETable(target).getPreviewCell(target);
                        if (target) {
                            var rng = me.selection.getRange();
                            rng.selectNodeContents(target).setCursor(true, true)
                        }
                    }
                }
                if (h == 'h') {
                    var ut = getUETable(target),
                        table = ut.table,
                        cells = getCellsByMoveBorder( target, table, true );

                    cells = extractArray( cells, 'left' );

                    ut.width = ut.offsetWidth;

                    var oldWidth = [],
                        newWidth = [];

                    utils.each( cells, function( cell ){

                        oldWidth.push( cell.offsetWidth );

                    } );

                    utils.each( cells, function( cell ){

                        cell.removeAttribute("width");

                    } );

                    window.setTimeout( function(){

                        //是否允许改变
                        var changeable = true;

                        utils.each( cells, function( cell, index ){

                            var width = cell.offsetWidth;

                            if( width > oldWidth[index] ) {
                                changeable = false;
                                return false;
                            }

                            newWidth.push( width );

                        } );

                        var change = changeable ? newWidth : oldWidth;

                        utils.each( cells, function( cell, index ){

                            cell.width = change[index] - getTabcellSpace();

                        } );


                    }, 0 );

//                    minWidth -= cellMinWidth;
//
//                    table.removeAttribute("width");
//                    utils.each(cells, function (cell) {
//                        cell.style.width = "";
//                        cell.width -= minWidth;
//                    });

                }
            }
        }
    }

    function tableClickHander( evt ) {

        removeSelectedClass(domUtils.getElementsByTagName(me.body, "td th"));
        //trace:3113
        //选中单元格，点击table外部，不会清掉table上挂的ueTable,会引起getUETableBySelected方法返回值
        utils.each(me.document.getElementsByTagName('table'), function (t) {
            t.ueTable = null;
        });
        startTd = getTargetTd(me, evt);
        if( !startTd ) return;
        var table = domUtils.findParentByTagName(startTd, "table", true);
        ut = getUETable(table);
        ut && ut.clearSelected();

        //判断当前鼠标状态
        if (!onBorder) {
            me.document.body.style.webkitUserSelect = '';
            mousedown = true;
            me.addListener('mouseover', mouseOverEvent);
        } else {
            //边框上的动作处理
            borderActionHandler( evt );
        }


    }

    //处理表格边框上的动作, 这里做延时处理，避免两种动作互相影响
    function borderActionHandler( evt ) {

        if ( browser.ie ) {
            evt = reconstruct(evt );
        }

        clearTableDragTimer();

        //是否正在等待resize的缓冲中
        isInResizeBuffer = true;

        tableDragTimer = setTimeout(function(){
            tableBorderDrag( evt );
        }, dblclickTime);

    }

    function extractArray( originArr, key ) {

        var result = [],
            tmp = null;

        for( var i = 0, len = originArr.length; i<len; i++ ) {

            tmp = originArr[ i ][ key ];

            if( tmp ) {
                result.push( tmp );
            }

        }

        return result;

    }

    function clearTableDragTimer() {
        tableDragTimer && clearTimeout(tableDragTimer);
        tableDragTimer = null;
    }

    function reconstruct( obj ) {

        var attrs = ['pageX', 'pageY', 'clientX', 'clientY', 'srcElement', 'target'],
            newObj = {};

        if( obj ) {

            for( var i = 0, key, val; key = attrs[i]; i++ ) {
                val=obj[ key ];
                val && (newObj[ key ] = val);
            }

        }

        return newObj;

    }

    //边框拖动
    function tableBorderDrag( evt ) {

        isInResizeBuffer = false;

        startTd = evt.target || evt.srcElement;
        if( !startTd ) return;
        var state = getRelation(startTd, mouseCoords(evt));
        if (/\d/.test(state)) {
            state = state.replace(/\d/, '');
            startTd = getUETable(startTd).getPreviewCell(startTd, state == 'v');
        }
        hideDragLine(me);
        getDragLine(me, me.document);
        me.fireEvent('saveScene');
        showDragLineAt(state, startTd);
        mousedown = true;
        //拖动开始
        onDrag = state;
        dragTd = startTd;
    }

    function mouseUpEvent(type, evt) {

        if( isEditorDisabled() ) {
            return ;
        }

        clearTableDragTimer();

        isInResizeBuffer = false;

        if( onBorder ) {
            singleClickState = ++singleClickState % 3;

            userActionStatus = {
                x: evt.clientX,
                y: evt.clientY
            };

            tableResizeTimer = setTimeout(function(){
                singleClickState > 0 && singleClickState--;
            }, dblclickTime );

            if( singleClickState === 2 ) {

                singleClickState = 0;
                tableDbclickHandler(evt);
                return;

            }

        }

        if (evt.button == 2)return;
        var me = this;
        //清除表格上原生跨选问题
        var range = me.selection.getRange(),
            start = domUtils.findParentByTagName(range.startContainer, 'table', true),
            end = domUtils.findParentByTagName(range.endContainer, 'table', true);

        if (start || end) {
            if (start === end) {
                start = domUtils.findParentByTagName(range.startContainer, ['td', 'th', 'caption'], true);
                end = domUtils.findParentByTagName(range.endContainer, ['td', 'th', 'caption'], true);
                if (start !== end) {
                    me.selection.clearRange()
                }
            } else {
                me.selection.clearRange()
            }
        }
        mousedown = false;
        me.document.body.style.webkitUserSelect = '';
        //拖拽状态下的mouseUP
        if ( onDrag && dragTd ) {

            me.selection.getNative()[browser.ie9below ? 'empty' : 'removeAllRanges']();

            singleClickState = 0;
            dragLine = me.document.getElementById('ue_tableDragLine');

            // trace 3973
            if (dragLine) {
                var dragTdPos = domUtils.getXY(dragTd),
                    dragLinePos = domUtils.getXY(dragLine);

                switch (onDrag) {
                    case "h":
                        changeColWidth(dragTd, dragLinePos.x - dragTdPos.x);
                        break;
                    case "v":
                        changeRowHeight(dragTd, dragLinePos.y - dragTdPos.y - dragTd.offsetHeight);
                        break;
                    default:
                }
                onDrag = "";
                dragTd = null;

                hideDragLine(me);
                me.fireEvent('saveScene');
                return;
            }
        }
        //正常状态下的mouseup
        if (!startTd) {
            var target = domUtils.findParentByTagName(evt.target || evt.srcElement, "td", true);
            if (!target) target = domUtils.findParentByTagName(evt.target || evt.srcElement, "th", true);
            if (target && (target.tagName == "TD" || target.tagName == "TH")) {
                if (me.fireEvent("excludetable", target) === true) return;
                range = new dom.Range(me.document);
                range.setStart(target, 0).setCursor(false, true);
            }
        } else {
            var ut = getUETable(startTd),
                cell = ut ? ut.selectedTds[0] : null;
            if (cell) {
                range = new dom.Range(me.document);
                if (domUtils.isEmptyBlock(cell)) {
                    range.setStart(cell, 0).setCursor(false, true);
                } else {
                    range.selectNodeContents(cell).shrinkBoundary().setCursor(false, true);
                }
            } else {
                range = me.selection.getRange().shrinkBoundary();
                if (!range.collapsed) {
                    var start = domUtils.findParentByTagName(range.startContainer, ['td', 'th'], true),
                        end = domUtils.findParentByTagName(range.endContainer, ['td', 'th'], true);
                    //在table里边的不能清除
                    if (start && !end || !start && end || start && end && start !== end) {
                        range.setCursor(false, true);
                    }
                }
            }
            startTd = null;
            me.removeListener('mouseover', mouseOverEvent);
        }
        me._selectionChange(250, evt);
    }

    function mouseOverEvent(type, evt) {

        if( isEditorDisabled() ) {
            return;
        }

        var me = this,
            tar = evt.target || evt.srcElement;
        currentTd = domUtils.findParentByTagName(tar, "td", true) || domUtils.findParentByTagName(tar, "th", true);
        //需要判断两个TD是否位于同一个表格内
        if (startTd && currentTd &&
            ((startTd.tagName == "TD" && currentTd.tagName == "TD") || (startTd.tagName == "TH" && currentTd.tagName == "TH")) &&
            domUtils.findParentByTagName(startTd, 'table') == domUtils.findParentByTagName(currentTd, 'table')) {
            var ut = getUETable(currentTd);
            if (startTd != currentTd) {
                me.document.body.style.webkitUserSelect = 'none';
                me.selection.getNative()[browser.ie9below ? 'empty' : 'removeAllRanges']();
                var range = ut.getCellsRange(startTd, currentTd);
                ut.setSelected(range);
            } else {
                me.document.body.style.webkitUserSelect = '';
                ut.clearSelected();
            }

        }
        evt.preventDefault ? evt.preventDefault() : (evt.returnValue = false);
    }

    function setCellHeight(cell, height, backHeight) {
        var lineHight = parseInt(domUtils.getComputedStyle(cell, "line-height"), 10),
            tmpHeight = backHeight + height;
        height = tmpHeight < lineHight ? lineHight : tmpHeight;
        if (cell.style.height) cell.style.height = "";
        cell.rowSpan == 1 ? cell.setAttribute("height", height) : (cell.removeAttribute && cell.removeAttribute("height"));
    }

    function getWidth(cell) {
        if (!cell)return 0;
        return parseInt(domUtils.getComputedStyle(cell, "width"), 10);
    }

    function changeColWidth(cell, changeValue) {

        var ut = getUETable(cell);
        if (ut) {

            //根据当前移动的边框获取相关的单元格
            var table = ut.table,
                cells = getCellsByMoveBorder( cell, table );

            table.style.width = "";
            table.removeAttribute("width");

            //修正改变量
            changeValue = correctChangeValue( changeValue, cell, cells );

            if (cell.nextSibling) {

                var i=0;

                utils.each( cells, function( cellGroup ){

                    cellGroup.left.width = (+cellGroup.left.width)+changeValue;
                    cellGroup.right && ( cellGroup.right.width = (+cellGroup.right.width)-changeValue );

                } );

            } else {

                utils.each( cells, function( cellGroup ){
                    cellGroup.left.width -= -changeValue;
                } );

            }
        }

    }

    function isEditorDisabled() {
        return me.body.contentEditable === "false";
    }

    function changeRowHeight(td, changeValue) {
        if (Math.abs(changeValue) < 10) return;
        var ut = getUETable(td);
        if (ut) {
            var cells = ut.getSameEndPosCells(td, "y"),
            //备份需要连带变化的td的原始高度，否则后期无法获取正确的值
                backHeight = cells[0] ? cells[0].offsetHeight : 0;
            for (var i = 0, cell; cell = cells[i++];) {
                setCellHeight(cell, changeValue, backHeight);
            }
        }

    }

    /**
     * 获取调整单元格大小的相关单元格
     * @isContainMergeCell 返回的结果中是否包含发生合并后的单元格
     */
    function getCellsByMoveBorder( cell, table, isContainMergeCell ) {

        if( !table ) {
            table = domUtils.findParentByTagName( cell, 'table' );
        }

        if( !table ) {
            return null;
        }

        //获取到该单元格所在行的序列号
        var index = domUtils.getNodeIndex( cell ),
            temp = cell,
            rows = table.rows,
            colIndex = 0;

        while( temp ) {
            //获取到当前单元格在未发生单元格合并时的序列
            if( temp.nodeType === 1 ) {
                colIndex += (temp.colSpan || 1);
            }
            temp = temp.previousSibling;
        }

        temp = null;

        //记录想关的单元格
        var borderCells = [];

        utils.each(rows, function( tabRow ){

            var cells = tabRow.cells,
                currIndex = 0;

            utils.each( cells, function( tabCell ){

                currIndex += (tabCell.colSpan || 1);

                if( currIndex === colIndex ) {

                    borderCells.push({
                        left: tabCell,
                        right: tabCell.nextSibling || null
                    });

                    return false;

                } else if( currIndex > colIndex ) {

                    if( isContainMergeCell ) {
                        borderCells.push({
                            left: tabCell
                        });
                    }

                    return false;
                }


            } );

        });

        return borderCells;

    }


    /**
     * 通过给定的单元格集合获取最小的单元格width
     */
    function getMinWidthByTableCells( cells ) {

        var minWidth = Number.MAX_VALUE;

        for( var i = 0, curCell; curCell = cells[ i ] ; i++ ) {

            minWidth = Math.min( minWidth, curCell.width || getTableCellWidth( curCell ) );

        }

        return minWidth;

    }

    function correctChangeValue( changeValue, relatedCell, cells ) {

        //为单元格的paading预留空间
        changeValue -= getTabcellSpace();

        if( changeValue < 0 ) {
            return 0;
        }

        changeValue -= getTableCellWidth( relatedCell );

        //确定方向
        var direction = changeValue < 0 ? 'left':'right';

        changeValue = Math.abs(changeValue);

        //只关心非最后一个单元格就可以
        utils.each( cells, function( cellGroup ){

            var curCell = cellGroup[direction];

            //为单元格保留最小空间
            if( curCell ) {
                changeValue = Math.min( changeValue, getTableCellWidth( curCell )-cellMinWidth );
            }


        } );


        //修正越界
        changeValue = changeValue < 0 ? 0 : changeValue;

        return direction === 'left' ? -changeValue : changeValue;

    }

    function getTableCellWidth( cell ) {

        var width = 0,
            //偏移纠正量
            offset = 0,
            width = cell.offsetWidth - getTabcellSpace();

        //最后一个节点纠正一下
        if( !cell.nextSibling ) {

            width -= getTableCellOffset( cell );

        }

        width = width < 0 ? 0 : width;

        try {
            cell.width = width;
        } catch(e) {
        }

        return width;

    }

    /**
     * 获取单元格所在表格的最末单元格的偏移量
     */
    function getTableCellOffset( cell ) {

        tab = domUtils.findParentByTagName( cell, "table", false);

        if( tab.offsetVal === undefined ) {

            var prev = cell.previousSibling;

            if( prev ) {

                //最后一个单元格和前一个单元格的width diff结果 如果恰好为一个border width， 则条件成立
                tab.offsetVal = cell.offsetWidth - prev.offsetWidth === UT.borderWidth ? UT.borderWidth : 0;

            } else {
                tab.offsetVal = 0;
            }

        }

        return tab.offsetVal;

    }

    function getTabcellSpace() {

        if( UT.tabcellSpace === undefined ) {

            var cell = null,
                tab = me.document.createElement("table"),
                tbody = me.document.createElement("tbody"),
                trow = me.document.createElement("tr"),
                tabcell = me.document.createElement("td"),
                mirror = null;

            tabcell.style.cssText = 'border: 0;';
            tabcell.width = 1;

            trow.appendChild( tabcell );
            trow.appendChild( mirror = tabcell.cloneNode( false ) );

            tbody.appendChild( trow );

            tab.appendChild( tbody );

            tab.style.cssText = "visibility: hidden;";

            me.body.appendChild( tab );

            UT.paddingSpace = tabcell.offsetWidth - 1;

            var tmpTabWidth = tab.offsetWidth;

            tabcell.style.cssText = '';
            mirror.style.cssText = '';

            UT.borderWidth = ( tab.offsetWidth - tmpTabWidth ) / 3;

            UT.tabcellSpace = UT.paddingSpace + UT.borderWidth;

            me.body.removeChild( tab );

        }

        getTabcellSpace = function(){ return UT.tabcellSpace; };

        return UT.tabcellSpace;

    }

    function getDragLine(editor, doc) {
        if (mousedown)return;
        dragLine = editor.document.createElement("div");
        domUtils.setAttributes(dragLine, {
            id:"ue_tableDragLine",
            unselectable:'on',
            contenteditable:false,
            'onresizestart':'return false',
            'ondragstart':'return false',
            'onselectstart':'return false',
            style:"background-color:blue;position:absolute;padding:0;margin:0;background-image:none;border:0px none;opacity:0;filter:alpha(opacity=0)"
        });
        editor.body.appendChild(dragLine);
    }

    function hideDragLine(editor) {
        if (mousedown)return;
        var line;
        while (line = editor.document.getElementById('ue_tableDragLine')) {
            domUtils.remove(line)
        }
    }

    /**
     * 依据state（v|h）在cell位置显示横线
     * @param state
     * @param cell
     */
    function showDragLineAt(state, cell) {
        if (!cell) return;
        var table = domUtils.findParentByTagName(cell, "table"),
            caption = table.getElementsByTagName('caption'),
            width = table.offsetWidth,
            height = table.offsetHeight - (caption.length > 0 ? caption[0].offsetHeight : 0),
            tablePos = domUtils.getXY(table),
            cellPos = domUtils.getXY(cell), css;
        switch (state) {
            case "h":
                css = 'height:' + height + 'px;top:' + (tablePos.y + (caption.length > 0 ? caption[0].offsetHeight : 0)) + 'px;left:' + (cellPos.x + cell.offsetWidth);
                dragLine.style.cssText = css + 'px;position: absolute;display:block;background-color:blue;width:1px;border:0; color:blue;opacity:.3;filter:alpha(opacity=30)';
                break;
            case "v":
                css = 'width:' + width + 'px;left:' + tablePos.x + 'px;top:' + (cellPos.y + cell.offsetHeight );
                //必须加上border:0和color:blue，否则低版ie不支持背景色显示
                dragLine.style.cssText = css + 'px;overflow:hidden;position: absolute;display:block;background-color:blue;height:1px;border:0;color:blue;opacity:.2;filter:alpha(opacity=20)';
                break;
            default:
        }
    }

    /**
     * 当表格边框颜色为白色时设置为虚线,true为添加虚线
     * @param editor
     * @param flag
     */
    function switchBorderColor(editor, flag) {
        var tableArr = domUtils.getElementsByTagName(editor.body, "table"), color;
        for (var i = 0, node; node = tableArr[i++];) {
            var td = domUtils.getElementsByTagName(node, "td");
            if (td[0]) {
                if (flag) {
                    color = (td[0].style.borderColor).replace(/\s/g, "");
                    if (/(#ffffff)|(rgb\(255,255,255\))/ig.test(color))
                        domUtils.addClass(node, "noBorderTable")
                } else {
                    domUtils.removeClasses(node, "noBorderTable")
                }
            }

        }
    }

    function getTableWidth(editor, needIEHack, defaultValue) {
        var body = editor.body;
        return body.offsetWidth - (needIEHack ? parseInt(domUtils.getComputedStyle(body, 'margin-left'), 10) * 2 : 0) - defaultValue.tableBorder * 2 - (editor.options.offsetWidth || 0);
    }

    /**
     * 获取当前拖动的单元格
     */
    function getTargetTd(editor, evt) {

        var target = domUtils.findParentByTagName(evt.target || evt.srcElement, ["td", "th"], true),
            dir = null;

        if( !target ) {
            return null;
        }

        dir = getRelation( target, mouseCoords( evt ) );

        //如果有前一个节点， 需要做一个修正， 否则可能会得到一个错误的td

        if( !target ) {
            return null;
        }

        if( dir === 'h1' && target.previousSibling ) {

            var position = domUtils.getXY( target),
                cellWidth = target.offsetWidth;

            if( Math.abs( position.x + cellWidth - evt.clientX ) > cellWidth / 3 ) {
                target = target.previousSibling;
            }

        } else if( dir === 'v1' && target.parentNode.previousSibling ) {

            var position = domUtils.getXY( target),
                cellHeight = target.offsetHeight;

            if( Math.abs( position.y + cellHeight - evt.clientY ) > cellHeight / 3 ) {
                target = target.parentNode.previousSibling.firstChild;
            }

        }


        //排除了非td内部以及用于代码高亮部分的td
        return target && !(editor.fireEvent("excludetable", target) === true) ? target : null;
    }

};


// plugins/table.sort.js
/**
 * Created with JetBrains PhpStorm.
 * User: Jinqn
 * Date: 13-10-12
 * Time: 上午10:20
 * To change this template use File | Settings | File Templates.
 */

UE.UETable.prototype.sortTable = function (sortByCellIndex, compareFn) {
    var table = this.table,
        rows = table.rows,
        trArray = [],
        flag = rows[0].cells[0].tagName === "TH",
        lastRowIndex = 0;
    if(this.selectedTds.length){
        var range = this.cellsRange,
            len = range.endRowIndex + 1;
        for (var i = range.beginRowIndex; i < len; i++) {
            trArray[i] = rows[i];
        }
        trArray.splice(0,range.beginRowIndex);
        lastRowIndex = (range.endRowIndex +1) === this.rowsNum ? 0 : range.endRowIndex +1;
    }else{
        for (var i = 0,len = rows.length; i < len; i++) {
            trArray[i] = rows[i];
        }
    }

    var Fn = {
        'reversecurrent': function(td1,td2){
            return 1;
        },
        'orderbyasc': function(td1,td2){
            var value1 = td1.innerText||td1.textContent,
                value2 = td2.innerText||td2.textContent;
            return value1.localeCompare(value2);
        },
        'reversebyasc': function(td1,td2){
            var value1 = td1.innerHTML,
                value2 = td2.innerHTML;
            return value2.localeCompare(value1);
        },
        'orderbynum': function(td1,td2){
            var value1 = td1[browser.ie ? 'innerText':'textContent'].match(/\d+/),
                value2 = td2[browser.ie ? 'innerText':'textContent'].match(/\d+/);
            if(value1) value1 = +value1[0];
            if(value2) value2 = +value2[0];
            return (value1||0) - (value2||0);
        },
        'reversebynum': function(td1,td2){
            var value1 = td1[browser.ie ? 'innerText':'textContent'].match(/\d+/),
                value2 = td2[browser.ie ? 'innerText':'textContent'].match(/\d+/);
            if(value1) value1 = +value1[0];
            if(value2) value2 = +value2[0];
            return (value2||0) - (value1||0);
        }
    };

    //对表格设置排序的标记data-sort-type
    table.setAttribute('data-sort-type', compareFn && typeof compareFn === "string" && Fn[compareFn] ? compareFn:'');

    //th不参与排序
    flag && trArray.splice(0, 1);
    trArray = utils.sort(trArray,function (tr1, tr2) {
        var result;
        if (compareFn && typeof compareFn === "function") {
            result = compareFn.call(this, tr1.cells[sortByCellIndex], tr2.cells[sortByCellIndex]);
        } else if (compareFn && typeof compareFn === "number") {
            result = 1;
        } else if (compareFn && typeof compareFn === "string" && Fn[compareFn]) {
            result = Fn[compareFn].call(this, tr1.cells[sortByCellIndex], tr2.cells[sortByCellIndex]);
        } else {
            result = Fn['orderbyasc'].call(this, tr1.cells[sortByCellIndex], tr2.cells[sortByCellIndex]);
        }
        return result;
    });
    var fragment = table.ownerDocument.createDocumentFragment();
    for (var j = 0, len = trArray.length; j < len; j++) {
        fragment.appendChild(trArray[j]);
    }
    var tbody = table.getElementsByTagName("tbody")[0];
    if(!lastRowIndex){
        tbody.appendChild(fragment);
    }else{
        tbody.insertBefore(fragment,rows[lastRowIndex- range.endRowIndex + range.beginRowIndex - 1])
    }
};

UE.plugins['tablesort'] = function () {
    var me = this,
        UT = UE.UETable,
        getUETable = function (tdOrTable) {
            return UT.getUETable(tdOrTable);
        },
        getTableItemsByRange = function (editor) {
            return UT.getTableItemsByRange(editor);
        };


    me.ready(function () {
        //添加表格可排序的样式
        utils.cssRule('tablesort',
            'table.sortEnabled tr.firstRow th,table.sortEnabled tr.firstRow td{padding-right:20px;background-repeat: no-repeat;background-position: center right;' +
                '   background-image:url(' + me.options.themePath + me.options.theme + '/images/sortable.png);}',
            me.document);

        //做单元格合并操作时,清除可排序标识
        me.addListener("afterexeccommand", function (type, cmd) {
            if( cmd == 'mergeright' || cmd == 'mergedown' || cmd == 'mergecells') {
                this.execCommand('disablesort');
            }
        });
    });



    //表格排序
    UE.commands['sorttable'] = {
        queryCommandState: function () {
            var me = this,
                tableItems = getTableItemsByRange(me);
            if (!tableItems.cell) return -1;
            var table = tableItems.table,
                cells = table.getElementsByTagName("td");
            for (var i = 0, cell; cell = cells[i++];) {
                if (cell.rowSpan != 1 || cell.colSpan != 1) return -1;
            }
            return 0;
        },
        execCommand: function (cmd, fn) {
            var me = this,
                range = me.selection.getRange(),
                bk = range.createBookmark(true),
                tableItems = getTableItemsByRange(me),
                cell = tableItems.cell,
                ut = getUETable(tableItems.table),
                cellInfo = ut.getCellInfo(cell);
            ut.sortTable(cellInfo.cellIndex, fn);
            range.moveToBookmark(bk);
            try{
                range.select();
            }catch(e){}
        }
    };

    //设置表格可排序,清除表格可排序
    UE.commands["enablesort"] = UE.commands["disablesort"] = {
        queryCommandState: function (cmd) {
            var table = getTableItemsByRange(this).table;
            if(table && cmd=='enablesort') {
                var cells = domUtils.getElementsByTagName(table, 'th td');
                for(var i = 0; i<cells.length; i++) {
                    if(cells[i].getAttribute('colspan')>1 || cells[i].getAttribute('rowspan')>1) return -1;
                }
            }

            return !table ? -1: cmd=='enablesort' ^ table.getAttribute('data-sort')!='sortEnabled' ? -1:0;
        },
        execCommand: function (cmd) {
            var table = getTableItemsByRange(this).table;
            table.setAttribute("data-sort", cmd == "enablesort" ? "sortEnabled" : "sortDisabled");
            cmd == "enablesort" ? domUtils.addClass(table,"sortEnabled"):domUtils.removeClasses(table,"sortEnabled");
        }
    };
};


// plugins/contextmenu.js
///import core
///commands 右键菜单
///commandsName  ContextMenu
///commandsTitle  右键菜单
/**
 * 右键菜单
 * @function
 * @name baidu.editor.plugins.contextmenu
 * @author zhanyi
 */

UE.plugins['contextmenu'] = function () {
    var me = this;
    me.setOpt('enableContextMenu',true);
    if(me.getOpt('enableContextMenu') === false){
        return;
    }
    var lang = me.getLang( "contextMenu" ),
            menu,
            items = me.options.contextMenu || [
                {label:lang['selectall'], cmdName:'selectall'},
                {
                    label:lang.cleardoc,
                    cmdName:'cleardoc',
                    exec:function () {
                        if ( confirm( lang.confirmclear ) ) {
                            this.execCommand( 'cleardoc' );
                        }
                    }
                },
                '-',
                {
                    label:lang.unlink,
                    cmdName:'unlink'
                },
                '-',
                {
                    group:lang.paragraph,
                    icon:'justifyjustify',
                    subMenu:[
                        {
                            label:lang.justifyleft,
                            cmdName:'justify',
                            value:'left'
                        },
                        {
                            label:lang.justifyright,
                            cmdName:'justify',
                            value:'right'
                        },
                        {
                            label:lang.justifycenter,
                            cmdName:'justify',
                            value:'center'
                        },
                        {
                            label:lang.justifyjustify,
                            cmdName:'justify',
                            value:'justify'
                        }
                    ]
                },
                '-',
                {
                    group:lang.table,
                    icon:'table',
                    subMenu:[
                        {
                            label:lang.inserttable,
                            cmdName:'inserttable'
                        },
                        {
                            label:lang.deletetable,
                            cmdName:'deletetable'
                        },
                        '-',
                        {
                            label:lang.deleterow,
                            cmdName:'deleterow'
                        },
                        {
                            label:lang.deletecol,
                            cmdName:'deletecol'
                        },
                        {
                            label:lang.insertcol,
                            cmdName:'insertcol'
                        },
                        {
                            label:lang.insertcolnext,
                            cmdName:'insertcolnext'
                        },
                        {
                            label:lang.insertrow,
                            cmdName:'insertrow'
                        },
                        {
                            label:lang.insertrownext,
                            cmdName:'insertrownext'
                        },
                        '-',
                        {
                            label:lang.insertcaption,
                            cmdName:'insertcaption'
                        },
                        {
                            label:lang.deletecaption,
                            cmdName:'deletecaption'
                        },
                        {
                            label:lang.inserttitle,
                            cmdName:'inserttitle'
                        },
                        {
                            label:lang.deletetitle,
                            cmdName:'deletetitle'
                        },
                        {
                            label:lang.inserttitlecol,
                            cmdName:'inserttitlecol'
                        },
                        {
                            label:lang.deletetitlecol,
                            cmdName:'deletetitlecol'
                        },
                        '-',
                        {
                            label:lang.mergecells,
                            cmdName:'mergecells'
                        },
                        {
                            label:lang.mergeright,
                            cmdName:'mergeright'
                        },
                        {
                            label:lang.mergedown,
                            cmdName:'mergedown'
                        },
                        '-',
                        {
                            label:lang.splittorows,
                            cmdName:'splittorows'
                        },
                        {
                            label:lang.splittocols,
                            cmdName:'splittocols'
                        },
                        {
                            label:lang.splittocells,
                            cmdName:'splittocells'
                        },
                        '-',
                        {
                            label:lang.averageDiseRow,
                            cmdName:'averagedistributerow'
                        },
                        {
                            label:lang.averageDisCol,
                            cmdName:'averagedistributecol'
                        },
                        '-',
                        {
                            label:lang.edittd,
                            cmdName:'edittd',
                            exec:function () {
                                if ( UE.ui['edittd'] ) {
                                    new UE.ui['edittd']( this );
                                }
                                this.getDialog('edittd').open();
                            }
                        },
                        {
                            label:lang.edittable,
                            cmdName:'edittable',
                            exec:function () {
                                if ( UE.ui['edittable'] ) {
                                    new UE.ui['edittable']( this );
                                }
                                this.getDialog('edittable').open();
                            }
                        },
                        {
                            label:lang.setbordervisible,
                            cmdName:'setbordervisible'
                        }
                    ]
                },
                {
                    group:lang.tablesort,
                    icon:'tablesort',
                    subMenu:[
                        {
                            label:lang.enablesort,
                            cmdName:'enablesort'
                        },
                        {
                            label:lang.disablesort,
                            cmdName:'disablesort'
                        },
                        '-',
                        {
                            label:lang.reversecurrent,
                            cmdName:'sorttable',
                            value:'reversecurrent'
                        },
                        {
                            label:lang.orderbyasc,
                            cmdName:'sorttable',
                            value:'orderbyasc'
                        },
                        {
                            label:lang.reversebyasc,
                            cmdName:'sorttable',
                            value:'reversebyasc'
                        },
                        {
                            label:lang.orderbynum,
                            cmdName:'sorttable',
                            value:'orderbynum'
                        },
                        {
                            label:lang.reversebynum,
                            cmdName:'sorttable',
                            value:'reversebynum'
                        }
                    ]
                },
                {
                    group:lang.borderbk,
                    icon:'borderBack',
                    subMenu:[
                        {
                            label:lang.setcolor,
                            cmdName:"interlacetable",
                            exec:function(){
                                this.execCommand("interlacetable");
                            }
                        },
                        {
                            label:lang.unsetcolor,
                            cmdName:"uninterlacetable",
                            exec:function(){
                                this.execCommand("uninterlacetable");
                            }
                        },
                        {
                            label:lang.setbackground,
                            cmdName:"settablebackground",
                            exec:function(){
                                this.execCommand("settablebackground",{repeat:true,colorList:["#bbb","#ccc"]});
                            }
                        },
                        {
                            label:lang.unsetbackground,
                            cmdName:"cleartablebackground",
                            exec:function(){
                                this.execCommand("cleartablebackground");
                            }
                        },
                        {
                            label:lang.redandblue,
                            cmdName:"settablebackground",
                            exec:function(){
                                this.execCommand("settablebackground",{repeat:true,colorList:["red","blue"]});
                            }
                        },
                        {
                            label:lang.threecolorgradient,
                            cmdName:"settablebackground",
                            exec:function(){
                                this.execCommand("settablebackground",{repeat:true,colorList:["#aaa","#bbb","#ccc"]});
                            }
                        }
                    ]
                },
                {
                    group:lang.aligntd,
                    icon:'aligntd',
                    subMenu:[
                        {
                            cmdName:'cellalignment',
                            value:{align:'left',vAlign:'top'}
                        },
                        {
                            cmdName:'cellalignment',
                            value:{align:'center',vAlign:'top'}
                        },
                        {
                            cmdName:'cellalignment',
                            value:{align:'right',vAlign:'top'}
                        },
                        {
                            cmdName:'cellalignment',
                            value:{align:'left',vAlign:'middle'}
                        },
                        {
                            cmdName:'cellalignment',
                            value:{align:'center',vAlign:'middle'}
                        },
                        {
                            cmdName:'cellalignment',
                            value:{align:'right',vAlign:'middle'}
                        },
                        {
                            cmdName:'cellalignment',
                            value:{align:'left',vAlign:'bottom'}
                        },
                        {
                            cmdName:'cellalignment',
                            value:{align:'center',vAlign:'bottom'}
                        },
                        {
                            cmdName:'cellalignment',
                            value:{align:'right',vAlign:'bottom'}
                        }
                    ]
                },
                {
                    group:lang.aligntable,
                    icon:'aligntable',
                    subMenu:[
                        {
                            cmdName:'tablealignment',
                            className: 'left',
                            label:lang.tableleft,
                            value:"left"
                        },
                        {
                            cmdName:'tablealignment',
                            className: 'center',
                            label:lang.tablecenter,
                            value:"center"
                        },
                        {
                            cmdName:'tablealignment',
                            className: 'right',
                            label:lang.tableright,
                            value:"right"
                        }
                    ]
                },
                '-',
                {
                    label:lang.insertparagraphbefore,
                    cmdName:'insertparagraph',
                    value:true
                },
                {
                    label:lang.insertparagraphafter,
                    cmdName:'insertparagraph'
                },
                {
                    label:lang['copy'],
                    cmdName:'copy'
                },
                {
                    label:lang['paste'],
                    cmdName:'paste'
                }
            ];
    if ( !items.length ) {
        return;
    }
    var uiUtils = UE.ui.uiUtils;

    me.addListener( 'contextmenu', function ( type, evt ) {

        var offset = uiUtils.getViewportOffsetByEvent( evt );
        me.fireEvent( 'beforeselectionchange' );
        if ( menu ) {
            menu.destroy();
        }
        for ( var i = 0, ti, contextItems = []; ti = items[i]; i++ ) {
            var last;
            (function ( item ) {
                if ( item == '-' ) {
                    if ( (last = contextItems[contextItems.length - 1 ] ) && last !== '-' ) {
                        contextItems.push( '-' );
                    }
                } else if ( item.hasOwnProperty( "group" ) ) {
                    for ( var j = 0, cj, subMenu = []; cj = item.subMenu[j]; j++ ) {
                        (function ( subItem ) {
                            if ( subItem == '-' ) {
                                if ( (last = subMenu[subMenu.length - 1 ] ) && last !== '-' ) {
                                    subMenu.push( '-' );
                                }else{
                                    subMenu.splice(subMenu.length-1);
                                }
                            } else {
                                if ( (me.commands[subItem.cmdName] || UE.commands[subItem.cmdName] || subItem.query) &&
                                        (subItem.query ? subItem.query() : me.queryCommandState( subItem.cmdName )) > -1 ) {
                                    subMenu.push( {
                                        'label':subItem.label || me.getLang( "contextMenu." + subItem.cmdName + (subItem.value || '') )||"",
                                        'className':'edui-for-' +subItem.cmdName + ( subItem.className ? ( ' edui-for-' + subItem.cmdName + '-' + subItem.className ) : '' ),
                                        onclick:subItem.exec ? function () {
                                                subItem.exec.call( me );
                                        } : function () {
                                            me.execCommand( subItem.cmdName, subItem.value );
                                        }
                                    } );
                                }
                            }
                        })( cj );
                    }
                    if ( subMenu.length ) {
                        function getLabel(){
                            switch (item.icon){
                                case "table":
                                    return me.getLang( "contextMenu.table" );
                                case "justifyjustify":
                                    return me.getLang( "contextMenu.paragraph" );
                                case "aligntd":
                                    return me.getLang("contextMenu.aligntd");
                                case "aligntable":
                                    return me.getLang("contextMenu.aligntable");
                                case "tablesort":
                                    return lang.tablesort;
                                case "borderBack":
                                    return lang.borderbk;
                                default :
                                    return '';
                            }
                        }
                        contextItems.push( {
                            //todo 修正成自动获取方式
                            'label':getLabel(),
                            className:'edui-for-' + item.icon,
                            'subMenu':{
                                items:subMenu,
                                editor:me
                            }
                        } );
                    }

                } else {
                    //有可能commmand没有加载右键不能出来，或者没有command也想能展示出来添加query方法
                    if ( (me.commands[item.cmdName] || UE.commands[item.cmdName] || item.query) &&
                            (item.query ? item.query.call(me) : me.queryCommandState( item.cmdName )) > -1 ) {

                        contextItems.push( {
                            'label':item.label || me.getLang( "contextMenu." + item.cmdName ),
                            className:'edui-for-' + (item.icon ? item.icon : item.cmdName + (item.value || '')),
                            onclick:item.exec ? function () {
                                item.exec.call( me );
                            } : function () {
                                me.execCommand( item.cmdName, item.value );
                            }
                        } );
                    }

                }

            })( ti );
        }
        if ( contextItems[contextItems.length - 1] == '-' ) {
            contextItems.pop();
        }

        menu = new UE.ui.Menu( {
            items:contextItems,
            className:"edui-contextmenu",
            editor:me
        } );
        menu.render();
        menu.showAt( offset );

        me.fireEvent("aftershowcontextmenu",menu);

        domUtils.preventDefault( evt );
        if ( browser.ie ) {
            var ieRange;
            try {
                ieRange = me.selection.getNative().createRange();
            } catch ( e ) {
                return;
            }
            if ( ieRange.item ) {
                var range = new dom.Range( me.document );
                range.selectNode( ieRange.item( 0 ) ).select( true, true );
            }
        }
    });

    // 添加复制的flash按钮
    me.addListener('aftershowcontextmenu', function(type, menu) {
        if (me.zeroclipboard) {
            var items = menu.items;
            for (var key in items) {
                if (items[key].className == 'edui-for-copy') {
                    me.zeroclipboard.clip(items[key].getDom());
                }
            }
        }
    });

};


// plugins/shortcutmenu.js
///import core
///commands       弹出菜单
// commandsName  popupmenu
///commandsTitle  弹出菜单
/**
 * 弹出菜单
 * @function
 * @name baidu.editor.plugins.popupmenu
 * @author xuheng
 */

UE.plugins['shortcutmenu'] = function () {
    var me = this,
        menu,
        items = me.options.shortcutMenu || [];

    if (!items.length) {
        return;
    }

    me.addListener ('contextmenu mouseup' , function (type , e) {
        var me = this,
            customEvt = {
                type : type ,
                target : e.target || e.srcElement ,
                screenX : e.screenX ,
                screenY : e.screenY ,
                clientX : e.clientX ,
                clientY : e.clientY
            };

        setTimeout (function () {
            var rng = me.selection.getRange ();
            if (rng.collapsed === false || type == "contextmenu") {

                if (!menu) {
                    menu = new baidu.editor.ui.ShortCutMenu ({
                        editor : me ,
                        items : items ,
                        theme : me.options.theme ,
                        className : 'edui-shortcutmenu'
                    });

                    menu.render ();
                    me.fireEvent ("afterrendershortcutmenu" , menu);
                }

                menu.show (customEvt , !!UE.plugins['contextmenu']);
            }
        });

        if (type == 'contextmenu') {
            domUtils.preventDefault (e);
            if (browser.ie9below) {
                var ieRange;
                try {
                    ieRange = me.selection.getNative().createRange();
                } catch (e) {
                    return;
                }
                if (ieRange.item) {
                    var range = new dom.Range (me.document);
                    range.selectNode (ieRange.item (0)).select (true , true);

                }
            }
        }
    });

    me.addListener ('keydown' , function (type) {
        if (type == "keydown") {
            menu && !menu.isHidden && menu.hide ();
        }

    });

};




// plugins/basestyle.js
/**
 * B、I、sub、super命令支持
 * @file
 * @since 1.2.6.1
 */

UE.plugins['basestyle'] = function(){

    /**
     * 字体加粗
     * @command bold
     * @param { String } cmd 命令字符串
     * @remind 对已加粗的文本内容执行该命令， 将取消加粗
     * @method execCommand
     * @example
     * ```javascript
     * //editor是编辑器实例
     * //对当前选中的文本内容执行加粗操作
     * //第一次执行， 文本内容加粗
     * editor.execCommand( 'bold' );
     *
     * //第二次执行， 文本内容取消加粗
     * editor.execCommand( 'bold' );
     * ```
     */


    /**
     * 字体倾斜
     * @command italic
     * @method execCommand
     * @param { String } cmd 命令字符串
     * @remind 对已倾斜的文本内容执行该命令， 将取消倾斜
     * @example
     * ```javascript
     * //editor是编辑器实例
     * //对当前选中的文本内容执行斜体操作
     * //第一次操作， 文本内容将变成斜体
     * editor.execCommand( 'italic' );
     *
     * //再次对同一文本内容执行， 则文本内容将恢复正常
     * editor.execCommand( 'italic' );
     * ```
     */

    /**
     * 下标文本，与“superscript”命令互斥
     * @command subscript
     * @method execCommand
     * @remind  把选中的文本内容切换成下标文本， 如果当前选中的文本已经是下标， 则该操作会把文本内容还原成正常文本
     * @param { String } cmd 命令字符串
     * @example
     * ```javascript
     * //editor是编辑器实例
     * //对当前选中的文本内容执行下标操作
     * //第一次操作， 文本内容将变成下标文本
     * editor.execCommand( 'subscript' );
     *
     * //再次对同一文本内容执行， 则文本内容将恢复正常
     * editor.execCommand( 'subscript' );
     * ```
     */

    /**
     * 上标文本，与“subscript”命令互斥
     * @command superscript
     * @method execCommand
     * @remind 把选中的文本内容切换成上标文本， 如果当前选中的文本已经是上标， 则该操作会把文本内容还原成正常文本
     * @param { String } cmd 命令字符串
     * @example
     * ```javascript
     * //editor是编辑器实例
     * //对当前选中的文本内容执行上标操作
     * //第一次操作， 文本内容将变成上标文本
     * editor.execCommand( 'superscript' );
     *
     * //再次对同一文本内容执行， 则文本内容将恢复正常
     * editor.execCommand( 'superscript' );
     * ```
     */
    var basestyles = {
            'bold':['strong','b'],
            'italic':['em','i'],
            'subscript':['sub'],
            'superscript':['sup']
        },
        getObj = function(editor,tagNames){
            return domUtils.filterNodeList(editor.selection.getStartElementPath(),tagNames);
        },
        me = this;
    //添加快捷键
    me.addshortcutkey({
        "Bold" : "ctrl+66",//^B
        "Italic" : "ctrl+73", //^I
        "Underline" : "ctrl+85"//^U
    });
    me.addInputRule(function(root){
        utils.each(root.getNodesByTagName('b i'),function(node){
            switch (node.tagName){
                case 'b':
                    node.tagName = 'strong';
                    break;
                case 'i':
                    node.tagName = 'em';
            }
        });
    });
    for ( var style in basestyles ) {
        (function( cmd, tagNames ) {
            me.commands[cmd] = {
                execCommand : function( cmdName ) {
                    var range = me.selection.getRange(),obj = getObj(this,tagNames);
                    if ( range.collapsed ) {
                        if ( obj ) {
                            var tmpText =  me.document.createTextNode('');
                            range.insertNode( tmpText ).removeInlineStyle( tagNames );
                            range.setStartBefore(tmpText);
                            domUtils.remove(tmpText);
                        } else {
                            var tmpNode = range.document.createElement( tagNames[0] );
                            if(cmdName == 'superscript' || cmdName == 'subscript'){
                                tmpText = me.document.createTextNode('');
                                range.insertNode(tmpText)
                                    .removeInlineStyle(['sub','sup'])
                                    .setStartBefore(tmpText)
                                    .collapse(true);
                            }
                            range.insertNode( tmpNode ).setStart( tmpNode, 0 );
                        }
                        range.collapse( true );
                    } else {
                        if(cmdName == 'superscript' || cmdName == 'subscript'){
                            if(!obj || obj.tagName.toLowerCase() != cmdName){
                                range.removeInlineStyle(['sub','sup']);
                            }
                        }
                        obj ? range.removeInlineStyle( tagNames ) : range.applyInlineStyle( tagNames[0] );
                    }
                    range.select();
                },
                queryCommandState : function() {
                   return getObj(this,tagNames) ? 1 : 0;
                }
            };
        })( style, basestyles[style] );
    }
};



// plugins/elementpath.js
/**
 * 选取路径命令
 * @file
 */
UE.plugins['elementpath'] = function(){
    var currentLevel,
        tagNames,
        me = this;
    me.setOpt('elementPathEnabled',true);
    if(!me.options.elementPathEnabled){
        return;
    }
    me.commands['elementpath'] = {
        execCommand : function( cmdName, level ) {
            var start = tagNames[level],
                range = me.selection.getRange();
            currentLevel = level*1;
            range.selectNode(start).select();
        },
        queryCommandValue : function() {
            //产生一个副本，不能修改原来的startElementPath;
            var parents = [].concat(this.selection.getStartElementPath()).reverse(),
                names = [];
            tagNames = parents;
            for(var i=0,ci;ci=parents[i];i++){
                if(ci.nodeType == 3) {
                    continue;
                }
                var name = ci.tagName.toLowerCase();
                if(name == 'img' && ci.getAttribute('anchorname')){
                    name = 'anchor';
                }
                names[i] = name;
                if(currentLevel == i){
                   currentLevel = -1;
                    break;
                }
            }
            return names;
        }
    };
};



// plugins/formatmatch.js
/**
 * 格式刷，只格式inline的
 * @file
 * @since 1.2.6.1
 */

/**
 * 格式刷
 * @command formatmatch
 * @method execCommand
 * @remind 该操作不能复制段落格式
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * //editor是编辑器实例
 * //获取格式刷
 * editor.execCommand( 'formatmatch' );
 * ```
 */
UE.plugins['formatmatch'] = function(){

    var me = this,
        list = [],img,
        flag = 0;

     me.addListener('reset',function(){
         list = [];
         flag = 0;
     });

    function addList(type,evt){
        
        if(browser.webkit){
            var target = evt.target.tagName == 'IMG' ? evt.target : null;
        }

        function addFormat(range){

            if(text){
                range.selectNode(text);
            }
            return range.applyInlineStyle(list[list.length-1].tagName,null,list);

        }

        me.undoManger && me.undoManger.save();

        var range = me.selection.getRange(),
            imgT = target || range.getClosedNode();
        if(img && imgT && imgT.tagName == 'IMG'){
            //trace:964

            imgT.style.cssText += ';float:' + (img.style.cssFloat || img.style.styleFloat ||'none') + ';display:' + (img.style.display||'inline');

            img = null;
        }else{
            if(!img){
                var collapsed = range.collapsed;
                if(collapsed){
                    var text = me.document.createTextNode('match');
                    range.insertNode(text).select();


                }
                me.__hasEnterExecCommand = true;
                //不能把block上的属性干掉
                //trace:1553
                var removeFormatAttributes = me.options.removeFormatAttributes;
                me.options.removeFormatAttributes = '';
                me.execCommand('removeformat');
                me.options.removeFormatAttributes = removeFormatAttributes;
                me.__hasEnterExecCommand = false;
                //trace:969
                range = me.selection.getRange();
                if(list.length){
                    addFormat(range);
                }
                if(text){
                    range.setStartBefore(text).collapse(true);

                }
                range.select();
                text && domUtils.remove(text);
            }

        }




        me.undoManger && me.undoManger.save();
        me.removeListener('mouseup',addList);
        flag = 0;
    }

    me.commands['formatmatch'] = {
        execCommand : function( cmdName ) {
          
            if(flag){
                flag = 0;
                list = [];
                 me.removeListener('mouseup',addList);
                return;
            }


              
            var range = me.selection.getRange();
            img = range.getClosedNode();
            if(!img || img.tagName != 'IMG'){
               range.collapse(true).shrinkBoundary();
               var start = range.startContainer;
               list = domUtils.findParents(start,true,function(node){
                   return !domUtils.isBlockElm(node) && node.nodeType == 1;
               });
               //a不能加入格式刷, 并且克隆节点
               for(var i=0,ci;ci=list[i];i++){
                   if(ci.tagName == 'A'){
                       list.splice(i,1);
                       break;
                   }
               }

            }

            me.addListener('mouseup',addList);
            flag = 1;


        },
        queryCommandState : function() {
            return flag;
        },
        notNeedUndo : 1
    };
};



// plugins/searchreplace.js
///import core
///commands 查找替换
///commandsName  SearchReplace
///commandsTitle  查询替换
///commandsDialog  dialogs\searchreplace
/**
 * @description 查找替换
 * @author zhanyi
 */

UE.plugin.register('searchreplace',function(){
    var me = this;

    var _blockElm = {'table':1,'tbody':1,'tr':1,'ol':1,'ul':1};

    function findTextInString(textContent,opt,currentIndex){
        var str = opt.searchStr;
        if(opt.dir == -1){
            textContent = textContent.split('').reverse().join('');
            str = str.split('').reverse().join('');
            currentIndex = textContent.length - currentIndex;

        }
        var reg = new RegExp(str,'g' + (opt.casesensitive ? '' : 'i')),match;

        while(match = reg.exec(textContent)){
            if(match.index >= currentIndex){
                return opt.dir == -1 ? textContent.length - match.index - opt.searchStr.length : match.index;
            }
        }
        return  -1
    }
    function findTextBlockElm(node,currentIndex,opt){
        var textContent,index,methodName = opt.all || opt.dir == 1 ? 'getNextDomNode' : 'getPreDomNode';
        if(domUtils.isBody(node)){
            node = node.firstChild;
        }
        var first = 1;
        while(node){
            textContent = node.nodeType == 3 ? node.nodeValue : node[browser.ie ? 'innerText' : 'textContent'];
            index = findTextInString(textContent,opt,currentIndex );
            first = 0;
            if(index!=-1){
                return {
                    'node':node,
                    'index':index
                }
            }
            node = domUtils[methodName](node);
            while(node && _blockElm[node.nodeName.toLowerCase()]){
                node = domUtils[methodName](node,true);
            }
            if(node){
                currentIndex = opt.dir == -1 ? (node.nodeType == 3 ? node.nodeValue : node[browser.ie ? 'innerText' : 'textContent']).length : 0;
            }

        }
    }
    function findNTextInBlockElm(node,index,str){
        var currentIndex = 0,
            currentNode = node.firstChild,
            currentNodeLength = 0,
            result;
        while(currentNode){
            if(currentNode.nodeType == 3){
                currentNodeLength = currentNode.nodeValue.replace(/(^[\t\r\n]+)|([\t\r\n]+$)/,'').length;
                currentIndex += currentNodeLength;
                if(currentIndex >= index){
                    return {
                        'node':currentNode,
                        'index': currentNodeLength - (currentIndex - index)
                    }
                }
            }else if(!dtd.$empty[currentNode.tagName]){
                currentNodeLength = currentNode[browser.ie ? 'innerText' : 'textContent'].replace(/(^[\t\r\n]+)|([\t\r\n]+$)/,'').length
                currentIndex += currentNodeLength;
                if(currentIndex >= index){
                    result = findNTextInBlockElm(currentNode,currentNodeLength - (currentIndex - index),str);
                    if(result){
                        return result;
                    }
                }
            }
            currentNode = domUtils.getNextDomNode(currentNode);

        }
    }

    function searchReplace(me,opt){

        var rng = me.selection.getRange(),
            startBlockNode,
            searchStr = opt.searchStr,
            span = me.document.createElement('span');
        span.innerHTML = '$$ueditor_searchreplace_key$$';

        rng.shrinkBoundary(true);

        //判断是不是第一次选中
        if(!rng.collapsed){
            rng.select();
            var rngText = me.selection.getText();
            if(new RegExp('^' + opt.searchStr + '$',(opt.casesensitive ? '' : 'i')).test(rngText)){
                if(opt.replaceStr != undefined){
                    replaceText(rng,opt.replaceStr);
                    rng.select();
                    return true;
                }else{
                    rng.collapse(opt.dir == -1)
                }

            }
        }


        rng.insertNode(span);
        rng.enlargeToBlockElm(true);
        startBlockNode = rng.startContainer;
        var currentIndex = startBlockNode[browser.ie ? 'innerText' : 'textContent'].indexOf('$$ueditor_searchreplace_key$$');
        rng.setStartBefore(span);
        domUtils.remove(span);
        var result = findTextBlockElm(startBlockNode,currentIndex,opt);
        if(result){
            var rngStart = findNTextInBlockElm(result.node,result.index,searchStr);
            var rngEnd = findNTextInBlockElm(result.node,result.index + searchStr.length,searchStr);
            rng.setStart(rngStart.node,rngStart.index).setEnd(rngEnd.node,rngEnd.index);

            if(opt.replaceStr !== undefined){
                replaceText(rng,opt.replaceStr)
            }
            rng.select();
            return true;
        }else{
            rng.setCursor()
        }

    }
    function replaceText(rng,str){

        str = me.document.createTextNode(str);
        rng.deleteContents().insertNode(str);

    }
    return {
        commands:{
            'searchreplace':{
                execCommand:function(cmdName,opt){
                    utils.extend(opt,{
                        all : false,
                        casesensitive : false,
                        dir : 1
                    },true);
                    var num = 0;
                    if(opt.all){

                        var rng = me.selection.getRange(),
                            first = me.body.firstChild;
                        if(first && first.nodeType == 1){
                            rng.setStart(first,0);
                            rng.shrinkBoundary(true);
                        }else if(first.nodeType == 3){
                            rng.setStartBefore(first)
                        }
                        rng.collapse(true).select(true);
                        if(opt.replaceStr !== undefined){
                            me.fireEvent('saveScene');
                        }
                        while(searchReplace(this,opt)){
                            num++;
                        }
                        if(num){
                            me.fireEvent('saveScene');
                        }
                    }else{
                        if(opt.replaceStr !== undefined){
                            me.fireEvent('saveScene');
                        }
                        if(searchReplace(this,opt)){
                            num++
                        }
                        if(num){
                            me.fireEvent('saveScene');
                        }

                    }

                    return num;
                },
                notNeedUndo:1
            }
        }
    }
});

// plugins/customstyle.js
/**
 * 自定义样式
 * @file
 * @since 1.2.6.1
 */

/**
 * 根据config配置文件里“customstyle”选项的值对匹配的标签执行样式替换。
 * @command customstyle
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * editor.execCommand( 'customstyle' );
 * ```
 */
UE.plugins['customstyle'] = function() {
    var me = this;
    me.setOpt({ 'customstyle':[
        {tag:'h1',name:'tc', style:'font-size:32px;font-weight:bold;border-bottom:#ccc 2px solid;padding:0 4px 0 0;text-align:center;margin:0 0 20px 0;'},
        {tag:'h1',name:'tl', style:'font-size:32px;font-weight:bold;border-bottom:#ccc 2px solid;padding:0 4px 0 0;text-align:left;margin:0 0 10px 0;'},
        {tag:'span',name:'im', style:'font-size:16px;font-style:italic;font-weight:bold;line-height:18px;'},
        {tag:'span',name:'hi', style:'font-size:16px;font-style:italic;font-weight:bold;color:rgb(51, 153, 204);line-height:18px;'}
    ]});
    me.commands['customstyle'] = {
        execCommand : function(cmdName, obj) {
            var me = this,
                    tagName = obj.tag,
                    node = domUtils.findParent(me.selection.getStart(), function(node) {
                        return node.getAttribute('label');
                    }, true),
                    range,bk,tmpObj = {};
            for (var p in obj) {
               if(obj[p]!==undefined)
                    tmpObj[p] = obj[p];
            }
            delete tmpObj.tag;
            if (node && node.getAttribute('label') == obj.label) {
                range = this.selection.getRange();
                bk = range.createBookmark();
                if (range.collapsed) {
                    //trace:1732 删掉自定义标签，要有p来回填站位
                    if(dtd.$block[node.tagName]){
                        var fillNode = me.document.createElement('p');
                        domUtils.moveChild(node, fillNode);
                        node.parentNode.insertBefore(fillNode, node);
                        domUtils.remove(node);
                    }else{
                        domUtils.remove(node,true);
                    }

                } else {

                    var common = domUtils.getCommonAncestor(bk.start, bk.end),
                            nodes = domUtils.getElementsByTagName(common, tagName);
                    if(new RegExp(tagName,'i').test(common.tagName)){
                        nodes.push(common);
                    }
                    for (var i = 0,ni; ni = nodes[i++];) {
                        if (ni.getAttribute('label') == obj.label) {
                            var ps = domUtils.getPosition(ni, bk.start),pe = domUtils.getPosition(ni, bk.end);
                            if ((ps & domUtils.POSITION_FOLLOWING || ps & domUtils.POSITION_CONTAINS)
                                    &&
                                    (pe & domUtils.POSITION_PRECEDING || pe & domUtils.POSITION_CONTAINS)
                                    )
                                if (dtd.$block[tagName]) {
                                    var fillNode = me.document.createElement('p');
                                    domUtils.moveChild(ni, fillNode);
                                    ni.parentNode.insertBefore(fillNode, ni);
                                }
                            domUtils.remove(ni, true);
                        }
                    }
                    node = domUtils.findParent(common, function(node) {
                        return node.getAttribute('label') == obj.label;
                    }, true);
                    if (node) {

                        domUtils.remove(node, true);

                    }

                }
                range.moveToBookmark(bk).select();
            } else {
                if (dtd.$block[tagName]) {
                    this.execCommand('paragraph', tagName, tmpObj,'customstyle');
                    range = me.selection.getRange();
                    if (!range.collapsed) {
                        range.collapse();
                        node = domUtils.findParent(me.selection.getStart(), function(node) {
                            return node.getAttribute('label') == obj.label;
                        }, true);
                        var pNode = me.document.createElement('p');
                        domUtils.insertAfter(node, pNode);
                        domUtils.fillNode(me.document, pNode);
                        range.setStart(pNode, 0).setCursor();
                    }
                } else {

                    range = me.selection.getRange();
                    if (range.collapsed) {
                        node = me.document.createElement(tagName);
                        domUtils.setAttributes(node, tmpObj);
                        range.insertNode(node).setStart(node, 0).setCursor();

                        return;
                    }

                    bk = range.createBookmark();
                    range.applyInlineStyle(tagName, tmpObj).moveToBookmark(bk).select();
                }
            }

        },
        queryCommandValue : function() {
            var parent = domUtils.filterNodeList(
                this.selection.getStartElementPath(),
                function(node){return node.getAttribute('label')}
            );
            return  parent ? parent.getAttribute('label') : '';
        }
    };
    //当去掉customstyle是，如果是块元素，用p代替
    me.addListener('keyup', function(type, evt) {
        var keyCode = evt.keyCode || evt.which;

        if (keyCode == 32 || keyCode == 13) {
            var range = me.selection.getRange();
            if (range.collapsed) {
                var node = domUtils.findParent(me.selection.getStart(), function(node) {
                    return node.getAttribute('label');
                }, true);
                if (node && dtd.$block[node.tagName] && domUtils.isEmptyNode(node)) {
                        var p = me.document.createElement('p');
                        domUtils.insertAfter(node, p);
                        domUtils.fillNode(me.document, p);
                        domUtils.remove(node);
                        range.setStart(p, 0).setCursor();


                }
            }
        }
    });
};

// plugins/catchremoteimage.js
///import core
///commands 远程图片抓取
///commandsName  catchRemoteImage,catchremoteimageenable
///commandsTitle  远程图片抓取
/**
 * 远程图片抓取,当开启本插件时所有不符合本地域名的图片都将被抓取成为本地服务器上的图片
 */
UE.plugins['catchremoteimage'] = function () {
    var me = this,
        ajax = UE.ajax;

    /* 设置默认值 */
    if (me.options.catchRemoteImageEnable === false) return;
    me.setOpt({
        catchRemoteImageEnable: false
    });

    me.addListener("afterpaste", function () {
        me.fireEvent("catchRemoteImage");
    });

    me.addListener("catchRemoteImage", function () {

        var catcherLocalDomain = me.getOpt('catcherLocalDomain'),
            catcherActionUrl = me.getActionUrl(me.getOpt('catcherActionName')),
            catcherUrlPrefix = me.getOpt('catcherUrlPrefix'),
            catcherFieldName = me.getOpt('catcherFieldName');

        var remoteImages = [],
            imgs = domUtils.getElementsByTagName(me.document, "img"),
            test = function (src, urls) {
                if (src.indexOf(location.host) != -1 || /(^\.)|(^\/)/.test(src)) {
                    return true;
                }
                if (urls) {
                    for (var j = 0, url; url = urls[j++];) {
                        if (src.indexOf(url) !== -1) {
                            return true;
                        }
                    }
                }
                return false;
            };

        for (var i = 0, ci; ci = imgs[i++];) {
            if (ci.getAttribute("word_img")) {
                continue;
            }
            var src = ci.getAttribute("_src") || ci.src || "";
            if (/^(https?|ftp):/i.test(src) && !test(src, catcherLocalDomain)) {
                remoteImages.push(src);
            }
        }

        if (remoteImages.length) {
            catchremoteimage(remoteImages, {
                //成功抓取
                success: function (r) {
                    try {
                        var info = r.state !== undefined ? r:eval("(" + r.responseText + ")");
                    } catch (e) {
                        return;
                    }

                    /* 获取源路径和新路径 */
                    var i, j, ci, cj, oldSrc, newSrc, list = info.list;

                    for (i = 0; ci = imgs[i++];) {
                        oldSrc = ci.getAttribute("_src") || ci.src || "";
                        for (j = 0; cj = list[j++];) {
                            if (oldSrc == cj.source && cj.state == "SUCCESS") {  //抓取失败时不做替换处理
                                newSrc = catcherUrlPrefix + cj.url;
                                domUtils.setAttributes(ci, {
                                    "src": newSrc,
                                    "_src": newSrc
                                });
                                break;
                            }
                        }
                    }
                    me.fireEvent('catchremotesuccess')
                },
                //回调失败，本次请求超时
                error: function () {
                    me.fireEvent("catchremoteerror");
                }
            });
        }

        function catchremoteimage(imgs, callbacks) {
            var params = utils.serializeParam(me.queryCommandValue('serverparam')) || '',
                url = utils.formatUrl(catcherActionUrl + (catcherActionUrl.indexOf('?') == -1 ? '?':'&') + params),
                isJsonp = utils.isCrossDomainUrl(url),
                opt = {
                    'method': 'POST',
                    'dataType': isJsonp ? 'jsonp':'',
                    'timeout': 60000, //单位：毫秒，回调请求超时设置。目标用户如果网速不是很快的话此处建议设置一个较大的数值
                    'onsuccess': callbacks["success"],
                    'onerror': callbacks["error"]
                };
            opt[catcherFieldName] = imgs;
            ajax.request(url, opt);
        }

    });
};

// plugins/snapscreen.js
/**
 * 截屏插件，为UEditor提供插入支持
 * @file
 * @since 1.4.2
 */
UE.plugin.register('snapscreen', function (){

    var me = this;
    var snapplugin;

    function getLocation(url){
        var search,
            a = document.createElement('a'),
            params = utils.serializeParam(me.queryCommandValue('serverparam')) || '';

        a.href = url;
        if (browser.ie) {
            a.href = a.href;
        }


        search = a.search;
        if (params) {
            search = search + (search.indexOf('?') == -1 ? '?':'&')+ params;
            search = search.replace(/[&]+/ig, '&');
        }
        return {
            'port': a.port,
            'hostname': a.hostname,
            'path': a.pathname + search ||  + a.hash
        }
    }

    return {
        commands:{
            /**
             * 字体背景颜色
             * @command snapscreen
             * @method execCommand
             * @param { String } cmd 命令字符串
             * @example
             * ```javascript
             * editor.execCommand('snapscreen');
             * ```
             */
            'snapscreen':{
                execCommand:function (cmd) {
                    var url, local, res;
                    var lang = me.getLang("snapScreen_plugin");

                    if(!snapplugin){
                        var container = me.container;
                        var doc = me.container.ownerDocument || me.container.document;
                        snapplugin = doc.createElement("object");
                        try{snapplugin.type = "application/x-pluginbaidusnap";}catch(e){
                            return;
                        }
                        snapplugin.style.cssText = "position:absolute;left:-9999px;width:0;height:0;";
                        snapplugin.setAttribute("width","0");
                        snapplugin.setAttribute("height","0");
                        container.appendChild(snapplugin);
                    }

                    function onSuccess(rs){
                        try{
                            rs = eval("("+ rs +")");
                            if(rs.state == 'SUCCESS'){
                                var opt = me.options;
                                me.execCommand('insertimage', {
                                    src: opt.snapscreenUrlPrefix + rs.url,
                                    _src: opt.snapscreenUrlPrefix + rs.url,
                                    alt: rs.title || '',
                                    floatStyle: opt.snapscreenImgAlign
                                });
                            } else {
                                alert(rs.state);
                            }
                        }catch(e){
                            alert(lang.callBackErrorMsg);
                        }
                    }
                    url = me.getActionUrl(me.getOpt('snapscreenActionName'));
                    local = getLocation(url);
                    setTimeout(function () {
                        try{
                            res =snapplugin.saveSnapshot(local.hostname, local.path, local.port);
                        }catch(e){
                            me.ui._dialogs['snapscreenDialog'].open();
                            return;
                        }

                        onSuccess(res);
                    }, 50);
                },
                queryCommandState: function(){
                    return (navigator.userAgent.indexOf("Windows",0) != -1) ? 0:-1;
                }
            }
        }
    }
});


// plugins/insertparagraph.js
/**
 * 插入段落
 * @file
 * @since 1.2.6.1
 */


/**
 * 插入段落
 * @command insertparagraph
 * @method execCommand
 * @param { String } cmd 命令字符串
 * @example
 * ```javascript
 * //editor是编辑器实例
 * editor.execCommand( 'insertparagraph' );
 * ```
 */

UE.commands['insertparagraph'] = {
    execCommand : function( cmdName,front) {
        var me = this,
            range = me.selection.getRange(),
            start = range.startContainer,tmpNode;
        while(start ){
            if(domUtils.isBody(start)){
                break;
            }
            tmpNode = start;
            start = start.parentNode;
        }
        if(tmpNode){
            var p = me.document.createElement('p');
            if(front){
                tmpNode.parentNode.insertBefore(p,tmpNode)
            }else{
                tmpNode.parentNode.insertBefore(p,tmpNode.nextSibling)
            }
            domUtils.fillNode(me.document,p);
            range.setStart(p,0).setCursor(false,true);
        }
    }
};



// plugins/webapp.js
/**
 * 百度应用
 * @file
 * @since 1.2.6.1
 */


/**
 * 插入百度应用
 * @command webapp
 * @method execCommand
 * @remind 需要百度APPKey
 * @remind 百度应用主页： <a href="http://app.baidu.com/" target="_blank">http://app.baidu.com/</a>
 * @param { Object } appOptions 应用所需的参数项， 支持的key有： title=>应用标题， width=>应用容器宽度，
 * height=>应用容器高度，logo=>应用logo，url=>应用地址
 * @example
 * ```javascript
 * //editor是编辑器实例
 * //在编辑器里插入一个“植物大战僵尸”的APP
 * editor.execCommand( 'webapp' , {
 *     title: '植物大战僵尸',
 *     width: 560,
 *     height: 465,
 *     logo: '应用展示的图片',
 *     url: '百度应用的地址'
 * } );
 * ```
 */

//UE.plugins['webapp'] = function () {
//    var me = this;
//    function createInsertStr( obj, toIframe, addParagraph ) {
//        return !toIframe ?
//                (addParagraph ? '<p>' : '') + '<img title="'+obj.title+'" width="' + obj.width + '" height="' + obj.height + '"' +
//                        ' src="' + me.options.UEDITOR_HOME_URL + 'themes/default/images/spacer.gif" style="background:url(' + obj.logo+') no-repeat center center; border:1px solid gray;" class="edui-faked-webapp" _url="' + obj.url + '" />' +
//                        (addParagraph ? '</p>' : '')
//                :
//                '<iframe class="edui-faked-webapp" title="'+obj.title+'" width="' + obj.width + '" height="' + obj.height + '"  scrolling="no" frameborder="0" src="' + obj.url + '" logo_url = '+obj.logo+'></iframe>';
//    }
//
//    function switchImgAndIframe( img2frame ) {
//        var tmpdiv,
//                nodes = domUtils.getElementsByTagName( me.document, !img2frame ? "iframe" : "img" );
//        for ( var i = 0, node; node = nodes[i++]; ) {
//            if ( node.className != "edui-faked-webapp" ){
//                continue;
//            }
//            tmpdiv = me.document.createElement( "div" );
//            tmpdiv.innerHTML = createInsertStr( img2frame ? {url:node.getAttribute( "_url" ), width:node.width, height:node.height,title:node.title,logo:node.style.backgroundImage.replace("url(","").replace(")","")} : {url:node.getAttribute( "src", 2 ),title:node.title, width:node.width, height:node.height,logo:node.getAttribute("logo_url")}, img2frame ? true : false,false );
//            node.parentNode.replaceChild( tmpdiv.firstChild, node );
//        }
//    }
//
//    me.addListener( "beforegetcontent", function () {
//        switchImgAndIframe( true );
//    } );
//    me.addListener( 'aftersetcontent', function () {
//        switchImgAndIframe( false );
//    } );
//    me.addListener( 'aftergetcontent', function ( cmdName ) {
//        if ( cmdName == 'aftergetcontent' && me.queryCommandState( 'source' ) ){
//            return;
//        }
//        switchImgAndIframe( false );
//    } );
//
//    me.commands['webapp'] = {
//        execCommand:function ( cmd, obj ) {
//            me.execCommand( "inserthtml", createInsertStr( obj, false,true ) );
//        }
//    };
//};

UE.plugin.register('webapp', function (){
    var me = this;
    function createInsertStr(obj,toEmbed){
        return  !toEmbed ?
            '<img title="'+obj.title+'" width="' + obj.width + '" height="' + obj.height + '"' +
                ' src="' + me.options.UEDITOR_HOME_URL + 'themes/default/images/spacer.gif" _logo_url="'+obj.logo+'" style="background:url(' + obj.logo
                +') no-repeat center center; border:1px solid gray;" class="edui-faked-webapp" _url="' + obj.url + '" ' +
                (obj.align && !obj.cssfloat? 'align="' + obj.align + '"' : '') +
                (obj.cssfloat ? 'style="float:' + obj.cssfloat + '"' : '') +
                '/>'
            :
            '<iframe class="edui-faked-webapp" title="'+obj.title+'" ' +
                (obj.align && !obj.cssfloat? 'align="' + obj.align + '"' : '') +
                (obj.cssfloat ? 'style="float:' + obj.cssfloat + '"' : '') +
                'width="' + obj.width + '" height="' + obj.height + '"  scrolling="no" frameborder="0" src="' + obj.url + '" logo_url = "'+obj.logo+'"></iframe>'

    }
    return {
        outputRule: function(root){
            utils.each(root.getNodesByTagName('img'),function(node){
                var html;
                if(node.getAttr('class') == 'edui-faked-webapp'){
                    html =  createInsertStr({
                        title:node.getAttr('title'),
                        'width':node.getAttr('width'),
                        'height':node.getAttr('height'),
                        'align':node.getAttr('align'),
                        'cssfloat':node.getStyle('float'),
                        'url':node.getAttr("_url"),
                        'logo':node.getAttr('_logo_url')
                    },true);
                    var embed = UE.uNode.createElement(html);
                    node.parentNode.replaceChild(embed,node);
                }
            })
        },
        inputRule:function(root){
            utils.each(root.getNodesByTagName('iframe'),function(node){
                if(node.getAttr('class') == 'edui-faked-webapp'){
                    var img = UE.uNode.createElement(createInsertStr({
                        title:node.getAttr('title'),
                        'width':node.getAttr('width'),
                        'height':node.getAttr('height'),
                        'align':node.getAttr('align'),
                        'cssfloat':node.getStyle('float'),
                        'url':node.getAttr("src"),
                        'logo':node.getAttr('logo_url')
                    }));
                    node.parentNode.replaceChild(img,node);
                }
            })

        },
        commands:{
            /**
             * 插入百度应用
             * @command webapp
             * @method execCommand
             * @remind 需要百度APPKey
             * @remind 百度应用主页： <a href="http://app.baidu.com/" target="_blank">http://app.baidu.com/</a>
             * @param { Object } appOptions 应用所需的参数项， 支持的key有： title=>应用标题， width=>应用容器宽度，
             * height=>应用容器高度，logo=>应用logo，url=>应用地址
             * @example
             * ```javascript
             * //editor是编辑器实例
             * //在编辑器里插入一个“植物大战僵尸”的APP
             * editor.execCommand( 'webapp' , {
             *     title: '植物大战僵尸',
             *     width: 560,
             *     height: 465,
             *     logo: '应用展示的图片',
             *     url: '百度应用的地址'
             * } );
             * ```
             */
            'webapp':{
                execCommand:function (cmd, obj) {

                    var me = this,
                        str = createInsertStr(utils.extend(obj,{
                            align:'none'
                        }), false);
                    me.execCommand("inserthtml",str);
                },
                queryCommandState:function () {
                    var me = this,
                        img = me.selection.getRange().getClosedNode(),
                        flag = img && (img.className == "edui-faked-webapp");
                    return flag ? 1 : 0;
                }
            }
        }
    }
});

// plugins/template.js
///import core
///import plugins\inserthtml.js
///import plugins\cleardoc.js
///commands 模板
///commandsName  template
///commandsTitle  模板
///commandsDialog  dialogs\template
UE.plugins['template'] = function () {
    UE.commands['template'] = {
        execCommand:function (cmd, obj) {
            obj.html && this.execCommand("inserthtml", obj.html);
        }
    };
    this.addListener("click", function (type, evt) {
        var el = evt.target || evt.srcElement,
            range = this.selection.getRange();
        var tnode = domUtils.findParent(el, function (node) {
            if (node.className && domUtils.hasClass(node, "ue_t")) {
                return node;
            }
        }, true);
        tnode && range.selectNode(tnode).shrinkBoundary().select();
    });
    this.addListener("keydown", function (type, evt) {
        var range = this.selection.getRange();
        if (!range.collapsed) {
            if (!evt.ctrlKey && !evt.metaKey && !evt.shiftKey && !evt.altKey) {
                var tnode = domUtils.findParent(range.startContainer, function (node) {
                    if (node.className && domUtils.hasClass(node, "ue_t")) {
                        return node;
                    }
                }, true);
                if (tnode) {
                    domUtils.removeClasses(tnode, ["ue_t"]);
                }
            }
        }
    });
};


// plugins/music.js
/**
 * 插入音乐命令
 * @file
 */
UE.plugin.register('music', function (){
    var me = this;
    function creatInsertStr(url,width,height,align,cssfloat,toEmbed){
        return  !toEmbed ?
                '<img ' +
                    (align && !cssfloat? 'align="' + align + '"' : '') +
                    (cssfloat ? 'style="float:' + cssfloat + '"' : '') +
                    ' width="'+ width +'" height="' + height + '" _url="'+url+'" class="edui-faked-music"' +
                    ' src="'+me.options.langPath+me.options.lang+'/images/music.png" />'
            :
            '<embed type="application/x-shockwave-flash" class="edui-faked-music" pluginspage="http://www.macromedia.com/go/getflashplayer"' +
                ' src="' + url + '" width="' + width  + '" height="' + height  + '" '+ (align && !cssfloat? 'align="' + align + '"' : '') +
                (cssfloat ? 'style="float:' + cssfloat + '"' : '') +
                ' wmode="transparent" play="true" loop="false" menu="false" allowscriptaccess="never" allowfullscreen="true" >';
    }
    return {
        outputRule: function(root){
            utils.each(root.getNodesByTagName('img'),function(node){
                var html;
                if(node.getAttr('class') == 'edui-faked-music'){
                    var cssfloat = node.getStyle('float');
                    var align = node.getAttr('align');
                    html =  creatInsertStr(node.getAttr("_url"), node.getAttr('width'), node.getAttr('height'), align, cssfloat, true);
                    var embed = UE.uNode.createElement(html);
                    node.parentNode.replaceChild(embed,node);
                }
            })
        },
        inputRule:function(root){
            utils.each(root.getNodesByTagName('embed'),function(node){
                if(node.getAttr('class') == 'edui-faked-music'){
                    var cssfloat = node.getStyle('float');
                    var align = node.getAttr('align');
                    html =  creatInsertStr(node.getAttr("src"), node.getAttr('width'), node.getAttr('height'), align, cssfloat,false);
                    var img = UE.uNode.createElement(html);
                    node.parentNode.replaceChild(img,node);
                }
            })

        },
        commands:{
            /**
             * 插入音乐
             * @command music
             * @method execCommand
             * @param { Object } musicOptions 插入音乐的参数项， 支持的key有： url=>音乐地址；
             * width=>音乐容器宽度；height=>音乐容器高度；align=>音乐文件的对齐方式， 可选值有: left, center, right, none
             * @example
             * ```javascript
             * //editor是编辑器实例
             * //在编辑器里插入一个“植物大战僵尸”的APP
             * editor.execCommand( 'music' , {
             *     width: 400,
             *     height: 95,
             *     align: "center",
             *     url: "音乐地址"
             * } );
             * ```
             */
            'music':{
                execCommand:function (cmd, musicObj) {
                    var me = this,
                        str = creatInsertStr(musicObj.url, musicObj.width || 400, musicObj.height || 95, "none", false);
                    me.execCommand("inserthtml",str);
                },
                queryCommandState:function () {
                    var me = this,
                        img = me.selection.getRange().getClosedNode(),
                        flag = img && (img.className == "edui-faked-music");
                    return flag ? 1 : 0;
                }
            }
        }
    }
});

// plugins/autoupload.js
/**
 * @description
 * 1.拖放文件到编辑区域，自动上传并插入到选区
 * 2.插入粘贴板的图片，自动上传并插入到选区
 * @author Jinqn
 * @date 2013-10-14
 */
UE.plugin.register('autoupload', function (){

    function sendAndInsertFile(file, editor) {
        var me  = editor;
        //模拟数据
        var fieldName, urlPrefix, maxSize, allowFiles, actionUrl,
            loadingHtml, errorHandler, successHandler,
            filetype = /image\/\w+/i.test(file.type) ? 'image':'file',
            loadingId = 'loading_' + (+new Date()).toString(36);

        fieldName = me.getOpt(filetype + 'FieldName');
        urlPrefix = me.getOpt(filetype + 'UrlPrefix');
        maxSize = me.getOpt(filetype + 'MaxSize');
        allowFiles = me.getOpt(filetype + 'AllowFiles');
        actionUrl = me.getActionUrl(me.getOpt(filetype + 'ActionName'));
        errorHandler = function(title) {
            var loader = me.document.getElementById(loadingId);
            loader && domUtils.remove(loader);
            me.fireEvent('showmessage', {
                'id': loadingId,
                'content': title,
                'type': 'error',
                'timeout': 4000
            });
        };

        if (filetype == 'image') {
            loadingHtml = '<img class="loadingclass" id="' + loadingId + '" src="' +
                me.options.themePath + me.options.theme +
                '/images/spacer.gif" title="' + (me.getLang('autoupload.loading') || '') + '" >';
            successHandler = function(data) {
                var link = urlPrefix + data.url,
                    loader = me.document.getElementById(loadingId);
                if (loader) {
                    loader.setAttribute('src', link);
                    loader.setAttribute('_src', link);
                    loader.setAttribute('title', data.title || '');
                    loader.setAttribute('alt', data.original || '');
                    loader.removeAttribute('id');
                    domUtils.removeClasses(loader, 'loadingclass');
                }
            };
        } else {
            loadingHtml = '<p>' +
                '<img class="loadingclass" id="' + loadingId + '" src="' +
                me.options.themePath + me.options.theme +
                '/images/spacer.gif" title="' + (me.getLang('autoupload.loading') || '') + '" >' +
                '</p>';
            successHandler = function(data) {
                var link = urlPrefix + data.url,
                    loader = me.document.getElementById(loadingId);

                var rng = me.selection.getRange(),
                    bk = rng.createBookmark();
                rng.selectNode(loader).select();
                me.execCommand('insertfile', {'url': link});
                rng.moveToBookmark(bk).select();
            };
        }

        /* 插入loading的占位符 */
        me.execCommand('inserthtml', loadingHtml);

        /* 判断后端配置是否没有加载成功 */
        if (!me.getOpt(filetype + 'ActionName')) {
            errorHandler(me.getLang('autoupload.errorLoadConfig'));
            return;
        }
        /* 判断文件大小是否超出限制 */
        if(file.size > maxSize) {
            errorHandler(me.getLang('autoupload.exceedSizeError'));
            return;
        }
        /* 判断文件格式是否超出允许 */
        var fileext = file.name ? file.name.substr(file.name.lastIndexOf('.')):'';
        if ((fileext && filetype != 'image') || (allowFiles && (allowFiles.join('') + '.').indexOf(fileext.toLowerCase() + '.') == -1)) {
            errorHandler(me.getLang('autoupload.exceedTypeError'));
            return;
        }

        /* 创建Ajax并提交 */
        var xhr = new XMLHttpRequest(),
            fd = new FormData(),
            params = utils.serializeParam(me.queryCommandValue('serverparam')) || '',
            url = utils.formatUrl(actionUrl + (actionUrl.indexOf('?') == -1 ? '?':'&') + params);

        fd.append(fieldName, file, file.name || ('blob.' + file.type.substr('image/'.length)));
        fd.append('type', 'ajax');
        xhr.open("post", url, true);
        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xhr.addEventListener('load', function (e) {
            try{
                var json = (new Function("return " + utils.trim(e.target.response)))();
                if (json.state == 'SUCCESS' && json.url) {
                    successHandler(json);
                } else {
                    errorHandler(json.state);
                }
            }catch(er){
                errorHandler(me.getLang('autoupload.loadError'));
            }
        });
        xhr.send(fd);
    }

    function getPasteImage(e){
        return e.clipboardData && e.clipboardData.items && e.clipboardData.items.length == 1 && /^image\//.test(e.clipboardData.items[0].type) ? e.clipboardData.items:null;
    }
    function getDropImage(e){
        return  e.dataTransfer && e.dataTransfer.files ? e.dataTransfer.files:null;
    }

    return {
        outputRule: function(root){
            utils.each(root.getNodesByTagName('img'),function(n){
                if (/\b(loaderrorclass)|(bloaderrorclass)\b/.test(n.getAttr('class'))) {
                    n.parentNode.removeChild(n);
                }
            });
            utils.each(root.getNodesByTagName('p'),function(n){
                if (/\bloadpara\b/.test(n.getAttr('class'))) {
                    n.parentNode.removeChild(n);
                }
            });
        },
        bindEvents:{
            //插入粘贴板的图片，拖放插入图片
            'ready':function(e){
                var me = this;
                if(window.FormData && window.FileReader) {
                    domUtils.on(me.body, 'paste drop', function(e){
                        var hasImg = false,
                            items;
                        //获取粘贴板文件列表或者拖放文件列表
                        items = e.type == 'paste' ? getPasteImage(e):getDropImage(e);
                        if(items){
                            var len = items.length,
                                file;
                            while (len--){
                                file = items[len];
                                if(file.getAsFile) file = file.getAsFile();
                                if(file && file.size > 0) {
                                    sendAndInsertFile(file, me);
                                    hasImg = true;
                                }
                            }
                            hasImg && e.preventDefault();
                        }

                    });
                    //取消拖放图片时出现的文字光标位置提示
                    domUtils.on(me.body, 'dragover', function (e) {
                        if(e.dataTransfer.types[0] == 'Files') {
                            e.preventDefault();
                        }
                    });

                    //设置loading的样式
                    utils.cssRule('loading',
                        '.loadingclass{display:inline-block;cursor:default;background: url(\''
                            + this.options.themePath
                            + this.options.theme +'/images/loading.gif\') no-repeat center center transparent;border:1px solid #cccccc;margin-left:1px;height: 22px;width: 22px;}\n' +
                            '.loaderrorclass{display:inline-block;cursor:default;background: url(\''
                            + this.options.themePath
                            + this.options.theme +'/images/loaderror.png\') no-repeat center center transparent;border:1px solid #cccccc;margin-right:1px;height: 22px;width: 22px;' +
                            '}',
                        this.document);
                }
            }
        }
    }
});

// plugins/autosave.js
UE.plugin.register('autosave', function (){

    var me = this,
        //无限循环保护
        lastSaveTime = new Date(),
        //最小保存间隔时间
        MIN_TIME = 20,
        //auto save key
        saveKey = null;

    function save ( editor ) {

        var saveData;

        if ( new Date() - lastSaveTime < MIN_TIME ) {
            return;
        }

        if ( !editor.hasContents() ) {
            //这里不能调用命令来删除， 会造成事件死循环
            saveKey && me.removePreferences( saveKey );
            return;
        }

        lastSaveTime = new Date();

        editor._saveFlag = null;

        saveData = me.body.innerHTML;

        if ( editor.fireEvent( "beforeautosave", {
            content: saveData
        } ) === false ) {
            return;
        }

        me.setPreferences( saveKey, saveData );

        editor.fireEvent( "afterautosave", {
            content: saveData
        } );

    }

    return {
        defaultOptions: {
            //默认间隔时间
            saveInterval: 500
        },
        bindEvents:{
            'ready':function(){

                var _suffix = "-drafts-data",
                    key = null;

                if ( me.key ) {
                    key = me.key + _suffix;
                } else {
                    key = ( me.container.parentNode.id || 'ue-common' ) + _suffix;
                }

                //页面地址+编辑器ID 保持唯一
                saveKey = ( location.protocol + location.host + location.pathname ).replace( /[.:\/]/g, '_' ) + key;

            },

            'contentchange': function () {

                if ( !saveKey ) {
                    return;
                }

                if ( me._saveFlag ) {
                    window.clearTimeout( me._saveFlag );
                }

                if ( me.options.saveInterval > 0 ) {

                    me._saveFlag = window.setTimeout( function () {

                        save( me );

                    }, me.options.saveInterval );

                } else {

                    save(me);

                }


            }
        },
        commands:{
            'clearlocaldata':{
                execCommand:function (cmd, name) {
                    if ( saveKey && me.getPreferences( saveKey ) ) {
                        me.removePreferences( saveKey )
                    }
                },
                notNeedUndo: true,
                ignoreContentChange:true
            },

            'getlocaldata':{
                execCommand:function (cmd, name) {
                    return saveKey ? me.getPreferences( saveKey ) || '' : '';
                },
                notNeedUndo: true,
                ignoreContentChange:true
            },

            'drafts':{
                execCommand:function (cmd, name) {
                    if ( saveKey ) {
                        me.body.innerHTML = me.getPreferences( saveKey ) || '<p>'+domUtils.fillHtml+'</p>';
                        me.focus(true);
                    }
                },
                queryCommandState: function () {
                    return saveKey ? ( me.getPreferences( saveKey ) === null ? -1 : 0 ) : -1;
                },
                notNeedUndo: true,
                ignoreContentChange:true
            }
        }
    }

});

// plugins/charts.js
UE.plugin.register('charts', function (){

    var me = this;

    return {
        bindEvents: {
            'chartserror': function () {
            }
        },
        commands:{
            'charts': {
                execCommand: function ( cmd, data ) {

                    var tableNode = domUtils.findParentByTagName(this.selection.getRange().startContainer, 'table', true),
                        flagText = [],
                        config = {};

                    if ( !tableNode ) {
                        return false;
                    }

                    if ( !validData( tableNode ) ) {
                        me.fireEvent( "chartserror" );
                        return false;
                    }

                    config.title = data.title || '';
                    config.subTitle = data.subTitle || '';
                    config.xTitle = data.xTitle || '';
                    config.yTitle = data.yTitle || '';
                    config.suffix = data.suffix || '';
                    config.tip = data.tip || '';
                    //数据对齐方式
                    config.dataFormat = data.tableDataFormat || '';
                    //图表类型
                    config.chartType = data.chartType || 0;

                    for ( var key in config ) {

                        if ( !config.hasOwnProperty( key ) ) {
                            continue;
                        }

                        flagText.push( key+":"+config[ key ] );

                    }

                    tableNode.setAttribute( "data-chart", flagText.join( ";" ) );
                    domUtils.addClass( tableNode, "edui-charts-table" );



                },
                queryCommandState: function ( cmd, name ) {

                    var tableNode = domUtils.findParentByTagName(this.selection.getRange().startContainer, 'table', true);
                    return tableNode && validData( tableNode ) ? 0 : -1;

                }
            }
        },
        inputRule:function(root){
            utils.each(root.getNodesByTagName('table'),function( tableNode ){

                if ( tableNode.getAttr("data-chart") !== undefined ) {
                    tableNode.setAttr("style");
                }

            })

        },
        outputRule:function(root){
            utils.each(root.getNodesByTagName('table'),function( tableNode ){

                if ( tableNode.getAttr("data-chart") !== undefined ) {
                    tableNode.setAttr("style", "display: none;");
                }

            })

        }
    }

    function validData ( table ) {

        var firstRows = null,
            cellCount = 0;

        //行数不够
        if ( table.rows.length < 2 ) {
            return false;
        }

        //列数不够
        if ( table.rows[0].cells.length < 2 ) {
            return false;
        }

        //第一行所有cell必须是th
        firstRows = table.rows[ 0 ].cells;
        cellCount = firstRows.length;

        for ( var i = 0, cell; cell = firstRows[ i ]; i++ ) {

            if ( cell.tagName.toLowerCase() !== 'th' ) {
                return false;
            }

        }

        for ( var i = 1, row; row = table.rows[ i ]; i++ ) {

            //每行单元格数不匹配， 返回false
            if ( row.cells.length != cellCount ) {
                return false;
            }

            //第一列不是th也返回false
            if ( row.cells[0].tagName.toLowerCase() !== 'th' ) {
                return false;
            }

            for ( var j = 1, cell; cell = row.cells[ j ]; j++ ) {

                var value = utils.trim( ( cell.innerText || cell.textContent || '' ) );

                value = value.replace( new RegExp( UE.dom.domUtils.fillChar, 'g' ), '' ).replace( /^\s+|\s+$/g, '' );

                //必须是数字
                if ( !/^\d*\.?\d+$/.test( value ) ) {
                    return false;
                }

            }

        }

        return true;

    }

});

// plugins/section.js
/**
 * 目录大纲支持插件
 * @file
 * @since 1.3.0
 */
UE.plugin.register('section', function (){
    /* 目录节点对象 */
    function Section(option){
        this.tag = '';
        this.level = -1,
            this.dom = null;
        this.nextSection = null;
        this.previousSection = null;
        this.parentSection = null;
        this.startAddress = [];
        this.endAddress = [];
        this.children = [];
    }
    function getSection(option) {
        var section = new Section();
        return utils.extend(section, option);
    }
    function getNodeFromAddress(startAddress, root) {
        var current = root;
        for(var i = 0;i < startAddress.length; i++) {
            if(!current.childNodes) return null;
            current = current.childNodes[startAddress[i]];
        }
        return current;
    }

    var me = this;

    return {
        bindMultiEvents:{
            type: 'aftersetcontent afterscencerestore',
            handler: function(){
                me.fireEvent('updateSections');
            }
        },
        bindEvents:{
            /* 初始化、拖拽、粘贴、执行setcontent之后 */
            'ready': function (){
                me.fireEvent('updateSections');
                domUtils.on(me.body, 'drop paste', function(){
                    me.fireEvent('updateSections');
                });
            },
            /* 执行paragraph命令之后 */
            'afterexeccommand': function (type, cmd) {
                if(cmd == 'paragraph') {
                    me.fireEvent('updateSections');
                }
            },
            /* 部分键盘操作，触发updateSections事件 */
            'keyup': function (type, e) {
                var me = this,
                    range = me.selection.getRange();
                if(range.collapsed != true) {
                    me.fireEvent('updateSections');
                } else {
                    var keyCode = e.keyCode || e.which;
                    if(keyCode == 13 || keyCode == 8 || keyCode == 46) {
                        me.fireEvent('updateSections');
                    }
                }
            }
        },
        commands:{
            'getsections': {
                execCommand: function (cmd, levels) {
                    var levelFn = levels || ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'];

                    for (var i = 0; i < levelFn.length; i++) {
                        if (typeof levelFn[i] == 'string') {
                            levelFn[i] = function(fn){
                                return function(node){
                                    return node.tagName == fn.toUpperCase()
                                };
                            }(levelFn[i]);
                        } else if (typeof levelFn[i] != 'function') {
                            levelFn[i] = function (node) {
                                return null;
                            }
                        }
                    }
                    function getSectionLevel(node) {
                        for (var i = 0; i < levelFn.length; i++) {
                            if (levelFn[i](node)) return i;
                        }
                        return -1;
                    }

                    var me = this,
                        Directory = getSection({'level':-1, 'title':'root'}),
                        previous = Directory;

                    function traversal(node, Directory) {
                        var level,
                            tmpSection = null,
                            parent,
                            child,
                            children = node.childNodes;
                        for (var i = 0, len = children.length; i < len; i++) {
                            child = children[i];
                            level = getSectionLevel(child);
                            if (level >= 0) {
                                var address = me.selection.getRange().selectNode(child).createAddress(true).startAddress,
                                    current = getSection({
                                        'tag': child.tagName,
                                        'title': child.innerText || child.textContent || '',
                                        'level': level,
                                        'dom': child,
                                        'startAddress': utils.clone(address, []),
                                        'endAddress': utils.clone(address, []),
                                        'children': []
                                    });
                                previous.nextSection = current;
                                current.previousSection = previous;
                                parent = previous;
                                while(level <= parent.level){
                                    parent = parent.parentSection;
                                }
                                current.parentSection = parent;
                                parent.children.push(current);
                                tmpSection = previous = current;
                            } else {
                                child.nodeType === 1 && traversal(child, Directory);
                                tmpSection && tmpSection.endAddress[tmpSection.endAddress.length - 1] ++;
                            }
                        }
                    }
                    traversal(me.body, Directory);
                    return Directory;
                },
                notNeedUndo: true
            },
            'movesection': {
                execCommand: function (cmd, sourceSection, targetSection, isAfter) {

                    var me = this,
                        targetAddress,
                        target;

                    if(!sourceSection || !targetSection || targetSection.level == -1) return;

                    targetAddress = isAfter ? targetSection.endAddress:targetSection.startAddress;
                    target = getNodeFromAddress(targetAddress, me.body);

                    /* 判断目标地址是否被源章节包含 */
                    if(!targetAddress || !target || isContainsAddress(sourceSection.startAddress, sourceSection.endAddress, targetAddress)) return;

                    var startNode = getNodeFromAddress(sourceSection.startAddress, me.body),
                        endNode = getNodeFromAddress(sourceSection.endAddress, me.body),
                        current,
                        nextNode;

                    if(isAfter) {
                        current = endNode;
                        while ( current && !(domUtils.getPosition( startNode, current ) & domUtils.POSITION_FOLLOWING) ) {
                            nextNode = current.previousSibling;
                            domUtils.insertAfter(target, current);
                            if(current == startNode) break;
                            current = nextNode;
                        }
                    } else {
                        current = startNode;
                        while ( current && !(domUtils.getPosition( current, endNode ) & domUtils.POSITION_FOLLOWING) ) {
                            nextNode = current.nextSibling;
                            target.parentNode.insertBefore(current, target);
                            if(current == endNode) break;
                            current = nextNode;
                        }
                    }

                    me.fireEvent('updateSections');

                    /* 获取地址的包含关系 */
                    function isContainsAddress(startAddress, endAddress, addressTarget){
                        var isAfterStartAddress = false,
                            isBeforeEndAddress = false;
                        for(var i = 0; i< startAddress.length; i++){
                            if(i >= addressTarget.length) break;
                            if(addressTarget[i] > startAddress[i]) {
                                isAfterStartAddress = true;
                                break;
                            } else if(addressTarget[i] < startAddress[i]) {
                                break;
                            }
                        }
                        for(var i = 0; i< endAddress.length; i++){
                            if(i >= addressTarget.length) break;
                            if(addressTarget[i] < startAddress[i]) {
                                isBeforeEndAddress = true;
                                break;
                            } else if(addressTarget[i] > startAddress[i]) {
                                break;
                            }
                        }
                        return isAfterStartAddress && isBeforeEndAddress;
                    }
                }
            },
            'deletesection': {
                execCommand: function (cmd, section, keepChildren) {
                    var me = this;

                    if(!section) return;

                    function getNodeFromAddress(startAddress) {
                        var current = me.body;
                        for(var i = 0;i < startAddress.length; i++) {
                            if(!current.childNodes) return null;
                            current = current.childNodes[startAddress[i]];
                        }
                        return current;
                    }

                    var startNode = getNodeFromAddress(section.startAddress),
                        endNode = getNodeFromAddress(section.endAddress),
                        current = startNode,
                        nextNode;

                    if(!keepChildren) {
                        while ( current && domUtils.inDoc(endNode, me.document) && !(domUtils.getPosition( current, endNode ) & domUtils.POSITION_FOLLOWING) ) {
                            nextNode = current.nextSibling;
                            domUtils.remove(current);
                            current = nextNode;
                        }
                    } else {
                        domUtils.remove(current);
                    }

                    me.fireEvent('updateSections');
                }
            },
            'selectsection': {
                execCommand: function (cmd, section) {
                    if(!section && !section.dom) return false;
                    var me = this,
                        range = me.selection.getRange(),
                        address = {
                            'startAddress':utils.clone(section.startAddress, []),
                            'endAddress':utils.clone(section.endAddress, [])
                        };
                    address.endAddress[address.endAddress.length - 1]++;
                    range.moveToAddress(address).select().scrollToView();
                    return true;
                },
                notNeedUndo: true
            },
            'scrolltosection': {
                execCommand: function (cmd, section) {
                    if(!section && !section.dom) return false;
                    var me = this,
                        range = me.selection.getRange(),
                        address = {
                            'startAddress':section.startAddress,
                            'endAddress':section.endAddress
                        };
                    address.endAddress[address.endAddress.length - 1]++;
                    range.moveToAddress(address).scrollToView();
                    return true;
                },
                notNeedUndo: true
            }
        }
    }
});

// plugins/simpleupload.js
/**
 * @description
 * 简单上传:点击按钮,直接选择文件上传
 * @author Jinqn
 * @date 2014-03-31
 */
UE.plugin.register('simpleupload', function (){
    var me = this,
        isLoaded = false,
        containerBtn;

    function initUploadBtn(){
        var w = containerBtn.offsetWidth || 20,
            h = containerBtn.offsetHeight || 20,
            btnIframe = document.createElement('iframe'),
            btnStyle = 'display:block;width:' + w + 'px;height:' + h + 'px;overflow:hidden;border:0;margin:0;padding:0;position:absolute;top:0;left:0;filter:alpha(opacity=0);-moz-opacity:0;-khtml-opacity: 0;opacity: 0;cursor:pointer;';

        domUtils.on(btnIframe, 'load', function(){

            var timestrap = (+new Date()).toString(36),
                wrapper,
                btnIframeDoc,
                btnIframeBody;

            btnIframeDoc = (btnIframe.contentDocument || btnIframe.contentWindow.document);
            btnIframeBody = btnIframeDoc.body;
            wrapper = btnIframeDoc.createElement('div');

            wrapper.innerHTML = '<form id="edui_form_' + timestrap + '" target="edui_iframe_' + timestrap + '" method="POST" enctype="multipart/form-data" action="' + me.getOpt('serverUrl') + '" ' +
            'style="' + btnStyle + '">' +
            '<input id="edui_input_' + timestrap + '" type="file" accept="image/*" name="' + me.options.imageFieldName + '" ' +
            'style="' + btnStyle + '">' +
            '</form>' +
            '<iframe id="edui_iframe_' + timestrap + '" name="edui_iframe_' + timestrap + '" style="display:none;width:0;height:0;border:0;margin:0;padding:0;position:absolute;"></iframe>';

            wrapper.className = 'edui-' + me.options.theme;
            wrapper.id = me.ui.id + '_iframeupload';
            btnIframeBody.style.cssText = btnStyle;
            btnIframeBody.style.width = w + 'px';
            btnIframeBody.style.height = h + 'px';
            btnIframeBody.appendChild(wrapper);

            if (btnIframeBody.parentNode) {
                btnIframeBody.parentNode.style.width = w + 'px';
                btnIframeBody.parentNode.style.height = w + 'px';
            }

            var form = btnIframeDoc.getElementById('edui_form_' + timestrap);
            var input = btnIframeDoc.getElementById('edui_input_' + timestrap);
            var iframe = btnIframeDoc.getElementById('edui_iframe_' + timestrap);

            domUtils.on(input, 'change', function(){
                if(!input.value) return;
                var loadingId = 'loading_' + (+new Date()).toString(36);
                var params = utils.serializeParam(me.queryCommandValue('serverparam')) || '';

                var imageActionUrl = me.getActionUrl(me.getOpt('imageActionName'));
                var allowFiles = me.getOpt('imageAllowFiles');

                me.focus();
                me.execCommand('inserthtml', '<img class="loadingclass" id="' + loadingId + '" src="' + me.options.themePath + me.options.theme +'/images/spacer.gif" title="' + (me.getLang('simpleupload.loading') || '') + '" >');

                function callback(){
                    try{
                        var link, json, loader,
                            body = (iframe.contentDocument || iframe.contentWindow.document).body,
                            result = body.innerText || body.textContent || '';
                        json = (new Function("return " + result))();
                        link = me.options.imageUrlPrefix + json.url;
                        if(json.state == 'SUCCESS' && json.url) {
                            loader = me.document.getElementById(loadingId);
                            loader.setAttribute('src', link);
                            loader.setAttribute('_src', link);
                            loader.setAttribute('title', json.title || '');
                            loader.setAttribute('alt', json.original || '');
                            loader.removeAttribute('id');
                            domUtils.removeClasses(loader, 'loadingclass');
                        } else {
                            showErrorLoader && showErrorLoader(json.state);
                        }
                    }catch(er){
                        showErrorLoader && showErrorLoader(me.getLang('simpleupload.loadError'));
                    }
                    form.reset();
                    domUtils.un(iframe, 'load', callback);
                }
                function showErrorLoader(title){
                    if(loadingId) {
                        var loader = me.document.getElementById(loadingId);
                        loader && domUtils.remove(loader);
                        me.fireEvent('showmessage', {
                            'id': loadingId,
                            'content': title,
                            'type': 'error',
                            'timeout': 4000
                        });
                    }
                }

                /* 判断后端配置是否没有加载成功 */
                if (!me.getOpt('imageActionName')) {
                    errorHandler(me.getLang('autoupload.errorLoadConfig'));
                    return;
                }
                // 判断文件格式是否错误
                var filename = input.value,
                    fileext = filename ? filename.substr(filename.lastIndexOf('.')):'';
                if (!fileext || (allowFiles && (allowFiles.join('') + '.').indexOf(fileext.toLowerCase() + '.') == -1)) {
                    showErrorLoader(me.getLang('simpleupload.exceedTypeError'));
                    return;
                }

                domUtils.on(iframe, 'load', callback);
                form.action = utils.formatUrl(imageActionUrl + (imageActionUrl.indexOf('?') == -1 ? '?':'&') + params);
                form.submit();
            });

            var stateTimer;
            me.addListener('selectionchange', function () {
                clearTimeout(stateTimer);
                stateTimer = setTimeout(function() {
                    var state = me.queryCommandState('simpleupload');
                    if (state == -1) {
                        input.disabled = 'disabled';
                    } else {
                        input.disabled = false;
                    }
                }, 400);
            });
            isLoaded = true;
        });

        btnIframe.style.cssText = btnStyle;
        containerBtn.appendChild(btnIframe);
    }

    return {
        bindEvents:{
            'ready': function() {
                //设置loading的样式
                utils.cssRule('loading',
                    '.loadingclass{display:inline-block;cursor:default;background: url(\''
                    + this.options.themePath
                    + this.options.theme +'/images/loading.gif\') no-repeat center center transparent;border:1px solid #cccccc;margin-right:1px;height: 22px;width: 22px;}\n' +
                    '.loaderrorclass{display:inline-block;cursor:default;background: url(\''
                    + this.options.themePath
                    + this.options.theme +'/images/loaderror.png\') no-repeat center center transparent;border:1px solid #cccccc;margin-right:1px;height: 22px;width: 22px;' +
                    '}',
                    this.document);
            },
            /* 初始化简单上传按钮 */
            'simpleuploadbtnready': function(type, container) {
                containerBtn = container;
                me.afterConfigReady(initUploadBtn);
            }
        },
        outputRule: function(root){
            utils.each(root.getNodesByTagName('img'),function(n){
                if (/\b(loaderrorclass)|(bloaderrorclass)\b/.test(n.getAttr('class'))) {
                    n.parentNode.removeChild(n);
                }
            });
        },
        commands: {
            'simpleupload': {
                queryCommandState: function () {
                    return isLoaded ? 0:-1;
                }
            }
        }
    }
});

// plugins/serverparam.js
/**
 * 服务器提交的额外参数列表设置插件
 * @file
 * @since 1.2.6.1
 */
UE.plugin.register('serverparam', function (){

    var me = this,
        serverParam = {};

    return {
        commands:{
            /**
             * 修改服务器提交的额外参数列表,清除所有项
             * @command serverparam
             * @method execCommand
             * @param { String } cmd 命令字符串
             * @example
             * ```javascript
             * editor.execCommand('serverparam');
             * editor.queryCommandValue('serverparam'); //返回空
             * ```
             */
            /**
             * 修改服务器提交的额外参数列表,删除指定项
             * @command serverparam
             * @method execCommand
             * @param { String } cmd 命令字符串
             * @param { String } key 要清除的属性
             * @example
             * ```javascript
             * editor.execCommand('serverparam', 'name'); //删除属性name
             * ```
             */
            /**
             * 修改服务器提交的额外参数列表,使用键值添加项
             * @command serverparam
             * @method execCommand
             * @param { String } cmd 命令字符串
             * @param { String } key 要添加的属性
             * @param { String } value 要添加属性的值
             * @example
             * ```javascript
             * editor.execCommand('serverparam', 'name', 'hello');
             * editor.queryCommandValue('serverparam'); //返回对象 {'name': 'hello'}
             * ```
             */
            /**
             * 修改服务器提交的额外参数列表,传入键值对对象添加多项
             * @command serverparam
             * @method execCommand
             * @param { String } cmd 命令字符串
             * @param { Object } key 传入的键值对对象
             * @example
             * ```javascript
             * editor.execCommand('serverparam', {'name': 'hello'});
             * editor.queryCommandValue('serverparam'); //返回对象 {'name': 'hello'}
             * ```
             */
            /**
             * 修改服务器提交的额外参数列表,使用自定义函数添加多项
             * @command serverparam
             * @method execCommand
             * @param { String } cmd 命令字符串
             * @param { Function } key 自定义获取参数的函数
             * @example
             * ```javascript
             * editor.execCommand('serverparam', function(editor){
             *     return {'key': 'value'};
             * });
             * editor.queryCommandValue('serverparam'); //返回对象 {'key': 'value'}
             * ```
             */

            /**
             * 获取服务器提交的额外参数列表
             * @command serverparam
             * @method queryCommandValue
             * @param { String } cmd 命令字符串
             * @example
             * ```javascript
             * editor.queryCommandValue( 'serverparam' ); //返回对象 {'key': 'value'}
             * ```
             */
            'serverparam':{
                execCommand:function (cmd, key, value) {
                    if (key === undefined || key === null) { //不传参数,清空列表
                        serverParam = {};
                    } else if (utils.isString(key)) { //传入键值
                        if(value === undefined || value === null) {
                            delete serverParam[key];
                        } else {
                            serverParam[key] = value;
                        }
                    } else if (utils.isObject(key)) { //传入对象,覆盖列表项
                        utils.extend(serverParam, key, true);
                    } else if (utils.isFunction(key)){ //传入函数,添加列表项
                        utils.extend(serverParam, key(), true);
                    }
                },
                queryCommandValue: function(){
                    return serverParam || {};
                }
            }
        }
    }
});


// plugins/insertfile.js
/**
 * 插入附件
 */
UE.plugin.register('insertfile', function (){

    var me = this;

    function getFileIcon(url){
        var ext = url.substr(url.lastIndexOf('.') + 1).toLowerCase(),
            maps = {
                "rar":"icon_rar.gif",
                "zip":"icon_rar.gif",
                "tar":"icon_rar.gif",
                "gz":"icon_rar.gif",
                "bz2":"icon_rar.gif",
                "doc":"icon_doc.gif",
                "docx":"icon_doc.gif",
                "pdf":"icon_pdf.gif",
                "mp3":"icon_mp3.gif",
                "xls":"icon_xls.gif",
                "chm":"icon_chm.gif",
                "ppt":"icon_ppt.gif",
                "pptx":"icon_ppt.gif",
                "avi":"icon_mv.gif",
                "rmvb":"icon_mv.gif",
                "wmv":"icon_mv.gif",
                "flv":"icon_mv.gif",
                "swf":"icon_mv.gif",
                "rm":"icon_mv.gif",
                "exe":"icon_exe.gif",
                "psd":"icon_psd.gif",
                "txt":"icon_txt.gif",
                "jpg":"icon_jpg.gif",
                "png":"icon_jpg.gif",
                "jpeg":"icon_jpg.gif",
                "gif":"icon_jpg.gif",
                "ico":"icon_jpg.gif",
                "bmp":"icon_jpg.gif"
            };
        return maps[ext] ? maps[ext]:maps['txt'];
    }

    return {
        commands:{
            'insertfile': {
                execCommand: function (command, filelist){
                    filelist = utils.isArray(filelist) ? filelist : [filelist];

                    var i, item, icon, title,
                        html = '',
                        URL = me.getOpt('UEDITOR_HOME_URL'),
                        iconDir = URL + (URL.substr(URL.length - 1) == '/' ? '':'/') + 'dialogs/attachment/fileTypeImages/';
                    for (i = 0; i < filelist.length; i++) {
                        item = filelist[i];
                        icon = iconDir + getFileIcon(item.url);
                        title = item.title || item.url.substr(item.url.lastIndexOf('/') + 1);
                        html += '<p style="line-height: 16px;">' +
                            '<img style="vertical-align: middle; margin-right: 2px;" src="'+ icon + '" _src="' + icon + '" />' +
                            '<a style="font-size:12px; color:#0066cc;" href="' + item.url +'" title="' + title + '">' + title + '</a>' +
                            '</p>';
                    }
                    me.execCommand('insertHtml', html);
                }
            }
        }
    }
});




// plugins/xssFilter.js
/**
 * @file xssFilter.js
 * @desc xss过滤器
 * @author robbenmu
 */

UE.plugins.xssFilter = function() {

	var config = UEDITOR_CONFIG;
	var whitList = config.whitList;

	function filter(node) {

		var tagName = node.tagName;
		var attrs = node.attrs;

		if (!whitList.hasOwnProperty(tagName)) {
			node.parentNode.removeChild(node);
			return false;
		}

		UE.utils.each(attrs, function (val, key) {

			if (whitList[tagName].indexOf(key) === -1) {
				node.setAttr(key);
			}
		});
	}

	// 添加inserthtml\paste等操作用的过滤规则
	if (whitList && config.xssFilterRules) {
		this.options.filterRules = function () {

			var result = {};

			UE.utils.each(whitList, function(val, key) {
				result[key] = function (node) {
					return filter(node);
				};
			});

			return result;
		}();
	}

	var tagList = [];

	UE.utils.each(whitList, function (val, key) {
		tagList.push(key);
	});

	// 添加input过滤规则
	//
	if (whitList && config.inputXssFilter) {
		this.addInputRule(function (root) {

			root.traversal(function(node) {
				if (node.type !== 'element') {
					return false;
				}
				filter(node);
			});
		});
	}
	// 添加output过滤规则
	//
	if (whitList && config.outputXssFilter) {
		this.addOutputRule(function (root) {

			root.traversal(function(node) {
				if (node.type !== 'element') {
					return false;
				}
				filter(node);
			});
		});
	}

};


// ui/ui.js
var baidu = baidu || {};
baidu.editor = baidu.editor || {};
UE.ui = baidu.editor.ui = {};

// ui/uiutils.js
(function (){
    var browser = baidu.editor.browser,
        domUtils = baidu.editor.dom.domUtils;

    var magic = '$EDITORUI';
    var root = window[magic] = {};
    var uidMagic = 'ID' + magic;
    var uidCount = 0;

    var uiUtils = baidu.editor.ui.uiUtils = {
        uid: function (obj){
            return (obj ? obj[uidMagic] || (obj[uidMagic] = ++ uidCount) : ++ uidCount);
        },
        hook: function ( fn, callback ) {
            var dg;
            if (fn && fn._callbacks) {
                dg = fn;
            } else {
                dg = function (){
                    var q;
                    if (fn) {
                        q = fn.apply(this, arguments);
                    }
                    var callbacks = dg._callbacks;
                    var k = callbacks.length;
                    while (k --) {
                        var r = callbacks[k].apply(this, arguments);
                        if (q === undefined) {
                            q = r;
                        }
                    }
                    return q;
                };
                dg._callbacks = [];
            }
            dg._callbacks.push(callback);
            return dg;
        },
        createElementByHtml: function (html){
            var el = document.createElement('div');
            el.innerHTML = html;
            el = el.firstChild;
            el.parentNode.removeChild(el);
            return el;
        },
        getViewportElement: function (){
            return (browser.ie && browser.quirks) ?
                document.body : document.documentElement;
        },
        getClientRect: function (element){
            var bcr;
            //trace  IE6下在控制编辑器显隐时可能会报错，catch一下
            try{
                bcr = element.getBoundingClientRect();
            }catch(e){
                bcr={left:0,top:0,height:0,width:0}
            }
            var rect = {
                left: Math.round(bcr.left),
                top: Math.round(bcr.top),
                height: Math.round(bcr.bottom - bcr.top),
                width: Math.round(bcr.right - bcr.left)
            };
            var doc;
            while ((doc = element.ownerDocument) !== document &&
                (element = domUtils.getWindow(doc).frameElement)) {
                bcr = element.getBoundingClientRect();
                rect.left += bcr.left;
                rect.top += bcr.top;
            }
            rect.bottom = rect.top + rect.height;
            rect.right = rect.left + rect.width;
            return rect;
        },
        getViewportRect: function (){
            var viewportEl = uiUtils.getViewportElement();
            var width = (window.innerWidth || viewportEl.clientWidth) | 0;
            var height = (window.innerHeight ||viewportEl.clientHeight) | 0;
            return {
                left: 0,
                top: 0,
                height: height,
                width: width,
                bottom: height,
                right: width
            };
        },
        setViewportOffset: function (element, offset){
            var rect;
            var fixedLayer = uiUtils.getFixedLayer();
            if (element.parentNode === fixedLayer) {
                element.style.left = offset.left + 'px';
                element.style.top = offset.top + 'px';
            } else {
                domUtils.setViewportOffset(element, offset);
            }
        },
        getEventOffset: function (evt){
            var el = evt.target || evt.srcElement;
            var rect = uiUtils.getClientRect(el);
            var offset = uiUtils.getViewportOffsetByEvent(evt);
            return {
                left: offset.left - rect.left,
                top: offset.top - rect.top
            };
        },
        getViewportOffsetByEvent: function (evt){
            var el = evt.target || evt.srcElement;
            var frameEl = domUtils.getWindow(el).frameElement;
            var offset = {
                left: evt.clientX,
                top: evt.clientY
            };
            if (frameEl && el.ownerDocument !== document) {
                var rect = uiUtils.getClientRect(frameEl);
                offset.left += rect.left;
                offset.top += rect.top;
            }
            return offset;
        },
        setGlobal: function (id, obj){
            root[id] = obj;
            return magic + '["' + id  + '"]';
        },
        unsetGlobal: function (id){
            delete root[id];
        },
        copyAttributes: function (tgt, src){
            var attributes = src.attributes;
            var k = attributes.length;
            while (k --) {
                var attrNode = attributes[k];
                if ( attrNode.nodeName != 'style' && attrNode.nodeName != 'class' && (!browser.ie || attrNode.specified) ) {
                    tgt.setAttribute(attrNode.nodeName, attrNode.nodeValue);
                }
            }
            if (src.className) {
                domUtils.addClass(tgt,src.className);
            }
            if (src.style.cssText) {
                tgt.style.cssText += ';' + src.style.cssText;
            }
        },
        removeStyle: function (el, styleName){
            if (el.style.removeProperty) {
                el.style.removeProperty(styleName);
            } else if (el.style.removeAttribute) {
                el.style.removeAttribute(styleName);
            } else throw '';
        },
        contains: function (elA, elB){
            return elA && elB && (elA === elB ? false : (
                elA.contains ? elA.contains(elB) :
                    elA.compareDocumentPosition(elB) & 16
                ));
        },
        startDrag: function (evt, callbacks,doc){
            var doc = doc || document;
            var startX = evt.clientX;
            var startY = evt.clientY;
            function handleMouseMove(evt){
                var x = evt.clientX - startX;
                var y = evt.clientY - startY;
                callbacks.ondragmove(x, y,evt);
                if (evt.stopPropagation) {
                    evt.stopPropagation();
                } else {
                    evt.cancelBubble = true;
                }
            }
            if (doc.addEventListener) {
                function handleMouseUp(evt){
                    doc.removeEventListener('mousemove', handleMouseMove, true);
                    doc.removeEventListener('mouseup', handleMouseUp, true);
                    window.removeEventListener('mouseup', handleMouseUp, true);
                    callbacks.ondragstop();
                }
                doc.addEventListener('mousemove', handleMouseMove, true);
                doc.addEventListener('mouseup', handleMouseUp, true);
                window.addEventListener('mouseup', handleMouseUp, true);

                evt.preventDefault();
            } else {
                var elm = evt.srcElement;
                elm.setCapture();
                function releaseCaptrue(){
                    elm.releaseCapture();
                    elm.detachEvent('onmousemove', handleMouseMove);
                    elm.detachEvent('onmouseup', releaseCaptrue);
                    elm.detachEvent('onlosecaptrue', releaseCaptrue);
                    callbacks.ondragstop();
                }
                elm.attachEvent('onmousemove', handleMouseMove);
                elm.attachEvent('onmouseup', releaseCaptrue);
                elm.attachEvent('onlosecaptrue', releaseCaptrue);
                evt.returnValue = false;
            }
            callbacks.ondragstart();
        },
        getFixedLayer: function (){
            var layer = document.getElementById('edui_fixedlayer');
            if (layer == null) {
                layer = document.createElement('div');
                layer.id = 'edui_fixedlayer';
                document.body.appendChild(layer);
                if (browser.ie && browser.version <= 8) {
                    layer.style.position = 'absolute';
                    bindFixedLayer();
                    setTimeout(updateFixedOffset);
                } else {
                    layer.style.position = 'fixed';
                }
                layer.style.left = '0';
                layer.style.top = '0';
                layer.style.width = '0';
                layer.style.height = '0';
            }
            return layer;
        },
        makeUnselectable: function (element){
            if (browser.opera || (browser.ie && browser.version < 9)) {
                element.unselectable = 'on';
                if (element.hasChildNodes()) {
                    for (var i=0; i<element.childNodes.length; i++) {
                        if (element.childNodes[i].nodeType == 1) {
                            uiUtils.makeUnselectable(element.childNodes[i]);
                        }
                    }
                }
            } else {
                if (element.style.MozUserSelect !== undefined) {
                    element.style.MozUserSelect = 'none';
                } else if (element.style.WebkitUserSelect !== undefined) {
                    element.style.WebkitUserSelect = 'none';
                } else if (element.style.KhtmlUserSelect !== undefined) {
                    element.style.KhtmlUserSelect = 'none';
                }
            }
        }
    };
    function updateFixedOffset(){
        var layer = document.getElementById('edui_fixedlayer');
        uiUtils.setViewportOffset(layer, {
            left: 0,
            top: 0
        });
//        layer.style.display = 'none';
//        layer.style.display = 'block';

        //#trace: 1354
//        setTimeout(updateFixedOffset);
    }
    function bindFixedLayer(adjOffset){
        domUtils.on(window, 'scroll', updateFixedOffset);
        domUtils.on(window, 'resize', baidu.editor.utils.defer(updateFixedOffset, 0, true));
    }
})();


// ui/uibase.js
(function () {
    var utils = baidu.editor.utils,
        uiUtils = baidu.editor.ui.uiUtils,
        EventBase = baidu.editor.EventBase,
        UIBase = baidu.editor.ui.UIBase = function () {
        };

    UIBase.prototype = {
        className:'',
        uiName:'',
        initOptions:function (options) {
            var me = this;
            for (var k in options) {
                me[k] = options[k];
            }
            this.id = this.id || 'edui' + uiUtils.uid();
        },
        initUIBase:function () {
            this._globalKey = utils.unhtml(uiUtils.setGlobal(this.id, this));
        },
        render:function (holder) {
            var html = this.renderHtml();
            var el = uiUtils.createElementByHtml(html);

            //by xuheng 给每个node添加class
            var list = domUtils.getElementsByTagName(el, "*");
            var theme = "edui-" + (this.theme || this.editor.options.theme);
            var layer = document.getElementById('edui_fixedlayer');
            for (var i = 0, node; node = list[i++];) {
                domUtils.addClass(node, theme);
            }
            domUtils.addClass(el, theme);
            if(layer){
                layer.className="";
                domUtils.addClass(layer,theme);
            }

            var seatEl = this.getDom();
            if (seatEl != null) {
                seatEl.parentNode.replaceChild(el, seatEl);
                uiUtils.copyAttributes(el, seatEl);
            } else {
                if (typeof holder == 'string') {
                    holder = document.getElementById(holder);
                }
                holder = holder || uiUtils.getFixedLayer();
                domUtils.addClass(holder, theme);
                holder.appendChild(el);
            }
            this.postRender();
        },
        getDom:function (name) {
            if (!name) {
                return document.getElementById(this.id);
            } else {
                return document.getElementById(this.id + '_' + name);
            }
        },
        postRender:function () {
            this.fireEvent('postrender');
        },
        getHtmlTpl:function () {
            return '';
        },
        formatHtml:function (tpl) {
            var prefix = 'edui-' + this.uiName;
            return (tpl
                .replace(/##/g, this.id)
                .replace(/%%-/g, this.uiName ? prefix + '-' : '')
                .replace(/%%/g, (this.uiName ? prefix : '') + ' ' + this.className)
                .replace(/\$\$/g, this._globalKey));
        },
        renderHtml:function () {
            return this.formatHtml(this.getHtmlTpl());
        },
        dispose:function () {
            var box = this.getDom();
            if (box) baidu.editor.dom.domUtils.remove(box);
            uiUtils.unsetGlobal(this.id);
        }
    };
    utils.inherits(UIBase, EventBase);
})();


// ui/separator.js
(function (){
    var utils = baidu.editor.utils,
        UIBase = baidu.editor.ui.UIBase,
        Separator = baidu.editor.ui.Separator = function (options){
            this.initOptions(options);
            this.initSeparator();
        };
    Separator.prototype = {
        uiName: 'separator',
        initSeparator: function (){
            this.initUIBase();
        },
        getHtmlTpl: function (){
            return '<div id="##" class="edui-box %%"></div>';
        }
    };
    utils.inherits(Separator, UIBase);

})();


// ui/mask.js
///import core
///import uicore
(function (){
    var utils = baidu.editor.utils,
        domUtils = baidu.editor.dom.domUtils,
        UIBase = baidu.editor.ui.UIBase,
        uiUtils = baidu.editor.ui.uiUtils;
    
    var Mask = baidu.editor.ui.Mask = function (options){
        this.initOptions(options);
        this.initUIBase();
    };
    Mask.prototype = {
        getHtmlTpl: function (){
            return '<div id="##" class="edui-mask %%" onclick="return $$._onClick(event, this);" onmousedown="return $$._onMouseDown(event, this);"></div>';
        },
        postRender: function (){
            var me = this;
            domUtils.on(window, 'resize', function (){
                setTimeout(function (){
                    if (!me.isHidden()) {
                        me._fill();
                    }
                });
            });
        },
        show: function (zIndex){
            this._fill();
            this.getDom().style.display = '';
            this.getDom().style.zIndex = zIndex;
        },
        hide: function (){
            this.getDom().style.display = 'none';
            this.getDom().style.zIndex = '';
        },
        isHidden: function (){
            return this.getDom().style.display == 'none';
        },
        _onMouseDown: function (){
            return false;
        },
        _onClick: function (e, target){
            this.fireEvent('click', e, target);
        },
        _fill: function (){
            var el = this.getDom();
            var vpRect = uiUtils.getViewportRect();
            el.style.width = vpRect.width + 'px';
            el.style.height = vpRect.height + 'px';
        }
    };
    utils.inherits(Mask, UIBase);
})();


// ui/popup.js
///import core
///import uicore
(function () {
    var utils = baidu.editor.utils,
        uiUtils = baidu.editor.ui.uiUtils,
        domUtils = baidu.editor.dom.domUtils,
        UIBase = baidu.editor.ui.UIBase,
        Popup = baidu.editor.ui.Popup = function (options){
            this.initOptions(options);
            this.initPopup();
        };

    var allPopups = [];
    function closeAllPopup( evt,el ){
        for ( var i = 0; i < allPopups.length; i++ ) {
            var pop = allPopups[i];
            if (!pop.isHidden()) {
                if (pop.queryAutoHide(el) !== false) {
                    if(evt&&/scroll/ig.test(evt.type)&&pop.className=="edui-wordpastepop")   return;
                    pop.hide();
                }
            }
        }

        if(allPopups.length)
            pop.editor.fireEvent("afterhidepop");
    }

    Popup.postHide = closeAllPopup;

    var ANCHOR_CLASSES = ['edui-anchor-topleft','edui-anchor-topright',
        'edui-anchor-bottomleft','edui-anchor-bottomright'];
    Popup.prototype = {
        SHADOW_RADIUS: 5,
        content: null,
        _hidden: false,
        autoRender: true,
        canSideLeft: true,
        canSideUp: true,
        initPopup: function (){
            this.initUIBase();
            allPopups.push( this );
        },
        getHtmlTpl: function (){
            return '<div id="##" class="edui-popup %%" onmousedown="return false;">' +
                ' <div id="##_body" class="edui-popup-body">' +
                ' <iframe style="position:absolute;z-index:-1;left:0;top:0;background-color: transparent;" frameborder="0" width="100%" height="100%" src="about:blank"></iframe>' +
                ' <div class="edui-shadow"></div>' +
                ' <div id="##_content" class="edui-popup-content">' +
                this.getContentHtmlTpl() +
                '  </div>' +
                ' </div>' +
                '</div>';
        },
        getContentHtmlTpl: function (){
            if(this.content){
                if (typeof this.content == 'string') {
                    return this.content;
                }
                return this.content.renderHtml();
            }else{
                return ''
            }

        },
        _UIBase_postRender: UIBase.prototype.postRender,
        postRender: function (){


            if (this.content instanceof UIBase) {
                this.content.postRender();
            }

            //捕获鼠标滚轮
            if( this.captureWheel && !this.captured ) {

                this.captured = true;

                var winHeight = ( document.documentElement.clientHeight || document.body.clientHeight )  - 80,
                    _height = this.getDom().offsetHeight,
                    _top = uiUtils.getClientRect( this.combox.getDom() ).top,
                    content = this.getDom('content'),
                    ifr = this.getDom('body').getElementsByTagName('iframe'),
                    me = this;

                ifr.length && ( ifr = ifr[0] );

                while( _top + _height > winHeight ) {
                    _height -= 30;
                }
                content.style.height = _height + 'px';
                //同步更改iframe高度
                ifr && ( ifr.style.height = _height + 'px' );

                //阻止在combox上的鼠标滚轮事件, 防止用户的正常操作被误解
                if( window.XMLHttpRequest ) {

                    domUtils.on( content, ( 'onmousewheel' in document.body ) ? 'mousewheel' :'DOMMouseScroll' , function(e){

                        if(e.preventDefault) {
                            e.preventDefault();
                        } else {
                            e.returnValue = false;
                        }

                        if( e.wheelDelta ) {

                            content.scrollTop -= ( e.wheelDelta / 120 )*60;

                        } else {

                            content.scrollTop -= ( e.detail / -3 )*60;

                        }

                    });

                } else {

                    //ie6
                    domUtils.on( this.getDom(), 'mousewheel' , function(e){

                        e.returnValue = false;

                        me.getDom('content').scrollTop -= ( e.wheelDelta / 120 )*60;

                    });

                }

            }
            this.fireEvent('postRenderAfter');
            this.hide(true);
            this._UIBase_postRender();
        },
        _doAutoRender: function (){
            if (!this.getDom() && this.autoRender) {
                this.render();
            }
        },
        mesureSize: function (){
            var box = this.getDom('content');
            return uiUtils.getClientRect(box);
        },
        fitSize: function (){
            if( this.captureWheel && this.sized ) {
                return this.__size;
            }
            this.sized = true;
            var popBodyEl = this.getDom('body');
            popBodyEl.style.width = '';
            popBodyEl.style.height = '';
            var size = this.mesureSize();
            if( this.captureWheel ) {
                popBodyEl.style.width =  -(-20 -size.width) + 'px';
                var height = parseInt( this.getDom('content').style.height, 10 );
                !window.isNaN( height ) && ( size.height = height );
            } else {
                popBodyEl.style.width =  size.width + 'px';
            }
            popBodyEl.style.height = size.height + 'px';
            this.__size = size;
            this.captureWheel && (this.getDom('content').style.overflow = 'auto');
            return size;
        },
        showAnchor: function ( element, hoz ){
            this.showAnchorRect( uiUtils.getClientRect( element ), hoz );
        },
        showAnchorRect: function ( rect, hoz, adj ){
            this._doAutoRender();
            var vpRect = uiUtils.getViewportRect();
            this.getDom().style.visibility = 'hidden';
            this._show();
            var popSize = this.fitSize();

            var sideLeft, sideUp, left, top;
            if (hoz) {
                sideLeft = this.canSideLeft && (rect.right + popSize.width > vpRect.right && rect.left > popSize.width);
                sideUp = this.canSideUp && (rect.top + popSize.height > vpRect.bottom && rect.bottom > popSize.height);
                left = (sideLeft ? rect.left - popSize.width : rect.right);
                top = (sideUp ? rect.bottom - popSize.height : rect.top);
            } else {
                sideLeft = this.canSideLeft && (rect.right + popSize.width > vpRect.right && rect.left > popSize.width);
                sideUp = this.canSideUp && (rect.top + popSize.height > vpRect.bottom && rect.bottom > popSize.height);
                left = (sideLeft ? rect.right - popSize.width : rect.left);
                top = (sideUp ? rect.top - popSize.height : rect.bottom);
            }

            var popEl = this.getDom();
            uiUtils.setViewportOffset(popEl, {
                left: left,
                top: top
            });
            domUtils.removeClasses(popEl, ANCHOR_CLASSES);
            popEl.className += ' ' + ANCHOR_CLASSES[(sideUp ? 1 : 0) * 2 + (sideLeft ? 1 : 0)];
            if(this.editor){
                popEl.style.zIndex = this.editor.container.style.zIndex * 1 + 10;
                baidu.editor.ui.uiUtils.getFixedLayer().style.zIndex = popEl.style.zIndex - 1;
            }
            this.getDom().style.visibility = 'visible';

        },
        showAt: function (offset) {
            var left = offset.left;
            var top = offset.top;
            var rect = {
                left: left,
                top: top,
                right: left,
                bottom: top,
                height: 0,
                width: 0
            };
            this.showAnchorRect(rect, false, true);
        },
        _show: function (){
            if (this._hidden) {
                var box = this.getDom();
                box.style.display = '';
                this._hidden = false;
//                if (box.setActive) {
//                    box.setActive();
//                }
                this.fireEvent('show');
            }
        },
        isHidden: function (){
            return this._hidden;
        },
        show: function (){
            this._doAutoRender();
            this._show();
        },
        hide: function (notNofity){
            if (!this._hidden && this.getDom()) {
                this.getDom().style.display = 'none';
                this._hidden = true;
                if (!notNofity) {
                    this.fireEvent('hide');
                }
            }
        },
        queryAutoHide: function (el){
            return !el || !uiUtils.contains(this.getDom(), el);
        }
    };
    utils.inherits(Popup, UIBase);
    
    domUtils.on( document, 'mousedown', function ( evt ) {
        var el = evt.target || evt.srcElement;
        closeAllPopup( evt,el );
    } );
    domUtils.on( window, 'scroll', function (evt,el) {
        closeAllPopup( evt,el );
    } );

})();


// ui/colorpicker.js
///import core
///import uicore
(function (){
    var utils = baidu.editor.utils,
        UIBase = baidu.editor.ui.UIBase,
        ColorPicker = baidu.editor.ui.ColorPicker = function (options){
            this.initOptions(options);
            this.noColorText = this.noColorText || this.editor.getLang("clearColor");
            this.initUIBase();
        };

    ColorPicker.prototype = {
        getHtmlTpl: function (){
            return genColorPicker(this.noColorText,this.editor);
        },
        _onTableClick: function (evt){
            var tgt = evt.target || evt.srcElement;
            var color = tgt.getAttribute('data-color');
            if (color) {
                this.fireEvent('pickcolor', color);
            }
        },
        _onTableOver: function (evt){
            var tgt = evt.target || evt.srcElement;
            var color = tgt.getAttribute('data-color');
            if (color) {
                this.getDom('preview').style.backgroundColor = color;
            }
        },
        _onTableOut: function (){
            this.getDom('preview').style.backgroundColor = '';
        },
        _onPickNoColor: function (){
            this.fireEvent('picknocolor');
        }
    };
    utils.inherits(ColorPicker, UIBase);

    var COLORS = (
        'ffffff,000000,eeece1,1f497d,4f81bd,c0504d,9bbb59,8064a2,4bacc6,f79646,' +
            'f2f2f2,7f7f7f,ddd9c3,c6d9f0,dbe5f1,f2dcdb,ebf1dd,e5e0ec,dbeef3,fdeada,' +
            'd8d8d8,595959,c4bd97,8db3e2,b8cce4,e5b9b7,d7e3bc,ccc1d9,b7dde8,fbd5b5,' +
            'bfbfbf,3f3f3f,938953,548dd4,95b3d7,d99694,c3d69b,b2a2c7,92cddc,fac08f,' +
            'a5a5a5,262626,494429,17365d,366092,953734,76923c,5f497a,31859b,e36c09,' +
            '7f7f7f,0c0c0c,1d1b10,0f243e,244061,632423,4f6128,3f3151,205867,974806,' +
            'c00000,ff0000,ffc000,ffff00,92d050,00b050,00b0f0,0070c0,002060,7030a0,').split(',');

    function genColorPicker(noColorText,editor){
        var html = '<div id="##" class="edui-colorpicker %%">' +
            '<div class="edui-colorpicker-topbar edui-clearfix">' +
            '<div unselectable="on" id="##_preview" class="edui-colorpicker-preview"></div>' +
            '<div unselectable="on" class="edui-colorpicker-nocolor" onclick="$$._onPickNoColor(event, this);">'+ noColorText +'</div>' +
            '</div>' +
            '<table  class="edui-box" style="border-collapse: collapse;" onmouseover="$$._onTableOver(event, this);" onmouseout="$$._onTableOut(event, this);" onclick="return $$._onTableClick(event, this);" cellspacing="0" cellpadding="0">' +
            '<tr style="border-bottom: 1px solid #ddd;font-size: 13px;line-height: 25px;color:#39C;padding-top: 2px"><td colspan="10">'+editor.getLang("themeColor")+'</td> </tr>'+
            '<tr class="edui-colorpicker-tablefirstrow" >';
        for (var i=0; i<COLORS.length; i++) {
            if (i && i%10 === 0) {
                html += '</tr>'+(i==60?'<tr style="border-bottom: 1px solid #ddd;font-size: 13px;line-height: 25px;color:#39C;"><td colspan="10">'+editor.getLang("standardColor")+'</td></tr>':'')+'<tr'+(i==60?' class="edui-colorpicker-tablefirstrow"':'')+'>';
            }
            html += i<70 ? '<td style="padding: 0 2px;"><a hidefocus title="'+COLORS[i]+'" onclick="return false;" href="javascript:" unselectable="on" class="edui-box edui-colorpicker-colorcell"' +
                ' data-color="#'+ COLORS[i] +'"'+
                ' style="background-color:#'+ COLORS[i] +';border:solid #ccc;'+
                (i<10 || i>=60?'border-width:1px;':
                    i>=10&&i<20?'border-width:1px 1px 0 1px;':

                        'border-width:0 1px 0 1px;')+
                '"' +
                '></a></td>':'';
        }
        html += '</tr></table></div>';
        return html;
    }
})();


// ui/tablepicker.js
///import core
///import uicore
(function (){
    var utils = baidu.editor.utils,
        uiUtils = baidu.editor.ui.uiUtils,
        UIBase = baidu.editor.ui.UIBase;
    
    var TablePicker = baidu.editor.ui.TablePicker = function (options){
        this.initOptions(options);
        this.initTablePicker();
    };
    TablePicker.prototype = {
        defaultNumRows: 10,
        defaultNumCols: 10,
        maxNumRows: 20,
        maxNumCols: 20,
        numRows: 10,
        numCols: 10,
        lengthOfCellSide: 22,
        initTablePicker: function (){
            this.initUIBase();
        },
        getHtmlTpl: function (){
            var me = this;
            return '<div id="##" class="edui-tablepicker %%">' +
                 '<div class="edui-tablepicker-body">' +
                  '<div class="edui-infoarea">' +
                   '<span id="##_label" class="edui-label"></span>' +
                  '</div>' +
                  '<div class="edui-pickarea"' +
                   ' onmousemove="$$._onMouseMove(event, this);"' +
                   ' onmouseover="$$._onMouseOver(event, this);"' +
                   ' onmouseout="$$._onMouseOut(event, this);"' +
                   ' onclick="$$._onClick(event, this);"' +
                  '>' +
                    '<div id="##_overlay" class="edui-overlay"></div>' +
                  '</div>' +
                 '</div>' +
                '</div>';
        },
        _UIBase_render: UIBase.prototype.render,
        render: function (holder){
            this._UIBase_render(holder);
            this.getDom('label').innerHTML = '0'+this.editor.getLang("t_row")+' x 0'+this.editor.getLang("t_col");
        },
        _track: function (numCols, numRows){
            var style = this.getDom('overlay').style;
            var sideLen = this.lengthOfCellSide;
            style.width = numCols * sideLen + 'px';
            style.height = numRows * sideLen + 'px';
            var label = this.getDom('label');
            label.innerHTML = numCols +this.editor.getLang("t_col")+' x ' + numRows + this.editor.getLang("t_row");
            this.numCols = numCols;
            this.numRows = numRows;
        },
        _onMouseOver: function (evt, el){
            var rel = evt.relatedTarget || evt.fromElement;
            if (!uiUtils.contains(el, rel) && el !== rel) {
                this.getDom('label').innerHTML = '0'+this.editor.getLang("t_col")+' x 0'+this.editor.getLang("t_row");
                this.getDom('overlay').style.visibility = '';
            }
        },
        _onMouseOut: function (evt, el){
            var rel = evt.relatedTarget || evt.toElement;
            if (!uiUtils.contains(el, rel) && el !== rel) {
                this.getDom('label').innerHTML = '0'+this.editor.getLang("t_col")+' x 0'+this.editor.getLang("t_row");
                this.getDom('overlay').style.visibility = 'hidden';
            }
        },
        _onMouseMove: function (evt, el){
            var style = this.getDom('overlay').style;
            var offset = uiUtils.getEventOffset(evt);
            var sideLen = this.lengthOfCellSide;
            var numCols = Math.ceil(offset.left / sideLen);
            var numRows = Math.ceil(offset.top / sideLen);
            this._track(numCols, numRows);
        },
        _onClick: function (){
            this.fireEvent('picktable', this.numCols, this.numRows);
        }
    };
    utils.inherits(TablePicker, UIBase);
})();


// ui/stateful.js
(function (){
    var browser = baidu.editor.browser,
        domUtils = baidu.editor.dom.domUtils,
        uiUtils = baidu.editor.ui.uiUtils;
    
    var TPL_STATEFUL = 'onmousedown="$$.Stateful_onMouseDown(event, this);"' +
        ' onmouseup="$$.Stateful_onMouseUp(event, this);"' +
        ( browser.ie ? (
        ' onmouseenter="$$.Stateful_onMouseEnter(event, this);"' +
        ' onmouseleave="$$.Stateful_onMouseLeave(event, this);"' )
        : (
        ' onmouseover="$$.Stateful_onMouseOver(event, this);"' +
        ' onmouseout="$$.Stateful_onMouseOut(event, this);"' ));
    
    baidu.editor.ui.Stateful = {
        alwalysHoverable: false,
        target:null,//目标元素和this指向dom不一样
        Stateful_init: function (){
            this._Stateful_dGetHtmlTpl = this.getHtmlTpl;
            this.getHtmlTpl = this.Stateful_getHtmlTpl;
        },
        Stateful_getHtmlTpl: function (){
            var tpl = this._Stateful_dGetHtmlTpl();
            // 使用function避免$转义
            return tpl.replace(/stateful/g, function (){ return TPL_STATEFUL; });
        },
        Stateful_onMouseEnter: function (evt, el){
            this.target=el;
            if (!this.isDisabled() || this.alwalysHoverable) {
                this.addState('hover');
                this.fireEvent('over');
            }
        },
        Stateful_onMouseLeave: function (evt, el){
            if (!this.isDisabled() || this.alwalysHoverable) {
                this.removeState('hover');
                this.removeState('active');
                this.fireEvent('out');
            }
        },
        Stateful_onMouseOver: function (evt, el){
            var rel = evt.relatedTarget;
            if (!uiUtils.contains(el, rel) && el !== rel) {
                this.Stateful_onMouseEnter(evt, el);
            }
        },
        Stateful_onMouseOut: function (evt, el){
            var rel = evt.relatedTarget;
            if (!uiUtils.contains(el, rel) && el !== rel) {
                this.Stateful_onMouseLeave(evt, el);
            }
        },
        Stateful_onMouseDown: function (evt, el){
            if (!this.isDisabled()) {
                this.addState('active');
            }
        },
        Stateful_onMouseUp: function (evt, el){
            if (!this.isDisabled()) {
                this.removeState('active');
            }
        },
        Stateful_postRender: function (){
            if (this.disabled && !this.hasState('disabled')) {
                this.addState('disabled');
            }
        },
        hasState: function (state){
            return domUtils.hasClass(this.getStateDom(), 'edui-state-' + state);
        },
        addState: function (state){
            if (!this.hasState(state)) {
                this.getStateDom().className += ' edui-state-' + state;
            }
        },
        removeState: function (state){
            if (this.hasState(state)) {
                domUtils.removeClasses(this.getStateDom(), ['edui-state-' + state]);
            }
        },
        getStateDom: function (){
            return this.getDom('state');
        },
        isChecked: function (){
            return this.hasState('checked');
        },
        setChecked: function (checked){
            if (!this.isDisabled() && checked) {
                this.addState('checked');
            } else {
                this.removeState('checked');
            }
        },
        isDisabled: function (){
            return this.hasState('disabled');
        },
        setDisabled: function (disabled){
            if (disabled) {
                this.removeState('hover');
                this.removeState('checked');
                this.removeState('active');
                this.addState('disabled');
            } else {
                this.removeState('disabled');
            }
        }
    };
})();


// ui/button.js
///import core
///import uicore
///import ui/stateful.js
(function (){
    var utils = baidu.editor.utils,
        UIBase = baidu.editor.ui.UIBase,
        Stateful = baidu.editor.ui.Stateful,
        Button = baidu.editor.ui.Button = function (options){
            if(options.name){
                var btnName = options.name;
                var cssRules = options.cssRules;
                if(!options.className){
                    options.className =  'edui-for-' + btnName;
                }
                options.cssRules = '.edui-default  .edui-for-'+ btnName +' .edui-icon {'+ cssRules +'}'
            }
            this.initOptions(options);
            this.initButton();
        };
    Button.prototype = {
        uiName: 'button',
        label: '',
        title: '',
        showIcon: true,
        showText: true,
        cssRules:'',
        initButton: function (){
            this.initUIBase();
            this.Stateful_init();
            if(this.cssRules){
                utils.cssRule('edui-customize-'+this.name+'-style',this.cssRules);
            }
        },
        getHtmlTpl: function (){
            return '<div id="##" class="edui-box %%">' +
                '<div id="##_state" stateful>' +
                 '<div class="%%-wrap"><div id="##_body" unselectable="on" ' + (this.title ? 'title="' + this.title + '"' : '') +
                 ' class="%%-body" onmousedown="return $$._onMouseDown(event, this);" onclick="return $$._onClick(event, this);">' +
                  (this.showIcon ? '<div class="edui-box edui-icon"></div>' : '') +
                  (this.showText ? '<div class="edui-box edui-label">' + this.label + '</div>' : '') +
                 '</div>' +
                '</div>' +
                '</div></div>';
        },
        postRender: function (){
            this.Stateful_postRender();
            this.setDisabled(this.disabled)
        },
        _onMouseDown: function (e){
            var target = e.target || e.srcElement,
                tagName = target && target.tagName && target.tagName.toLowerCase();
            if (tagName == 'input' || tagName == 'object' || tagName == 'object') {
                return false;
            }
        },
        _onClick: function (){
            if (!this.isDisabled()) {
                this.fireEvent('click');
            }
        },
        setTitle: function(text){
            var label = this.getDom('label');
            label.innerHTML = text;
        }
    };
    utils.inherits(Button, UIBase);
    utils.extend(Button.prototype, Stateful);

})();


// ui/splitbutton.js
///import core
///import uicore
///import ui/stateful.js
(function (){
    var utils = baidu.editor.utils,
        uiUtils = baidu.editor.ui.uiUtils,
        domUtils = baidu.editor.dom.domUtils,
        UIBase = baidu.editor.ui.UIBase,
        Stateful = baidu.editor.ui.Stateful,
        SplitButton = baidu.editor.ui.SplitButton = function (options){
            this.initOptions(options);
            this.initSplitButton();
        };
    SplitButton.prototype = {
        popup: null,
        uiName: 'splitbutton',
        title: '',
        initSplitButton: function (){
            this.initUIBase();
            this.Stateful_init();
            var me = this;
            if (this.popup != null) {
                var popup = this.popup;
                this.popup = null;
                this.setPopup(popup);
            }
        },
        _UIBase_postRender: UIBase.prototype.postRender,
        postRender: function (){
            this.Stateful_postRender();
            this._UIBase_postRender();
        },
        setPopup: function (popup){
            if (this.popup === popup) return;
            if (this.popup != null) {
                this.popup.dispose();
            }
            popup.addListener('show', utils.bind(this._onPopupShow, this));
            popup.addListener('hide', utils.bind(this._onPopupHide, this));
            popup.addListener('postrender', utils.bind(function (){
                popup.getDom('body').appendChild(
                    uiUtils.createElementByHtml('<div id="' +
                        this.popup.id + '_bordereraser" class="edui-bordereraser edui-background" style="width:' +
                        (uiUtils.getClientRect(this.getDom()).width + 20) + 'px"></div>')
                    );
                popup.getDom().className += ' ' + this.className;
            }, this));
            this.popup = popup;
        },
        _onPopupShow: function (){
            this.addState('opened');
        },
        _onPopupHide: function (){
            this.removeState('opened');
        },
        getHtmlTpl: function (){
            return '<div id="##" class="edui-box %%">' +
                '<div '+ (this.title ? 'title="' + this.title + '"' : '') +' id="##_state" stateful><div class="%%-body">' +
                '<div id="##_button_body" class="edui-box edui-button-body" onclick="$$._onButtonClick(event, this);">' +
                '<div class="edui-box edui-icon"></div>' +
                '</div>' +
                '<div class="edui-box edui-splitborder"></div>' +
                '<div class="edui-box edui-arrow" onclick="$$._onArrowClick();"></div>' +
                '</div></div></div>';
        },
        showPopup: function (){
            // 当popup往上弹出的时候，做特殊处理
            var rect = uiUtils.getClientRect(this.getDom());
            rect.top -= this.popup.SHADOW_RADIUS;
            rect.height += this.popup.SHADOW_RADIUS;
            this.popup.showAnchorRect(rect);
        },
        _onArrowClick: function (event, el){
            if (!this.isDisabled()) {
                this.showPopup();
            }
        },
        _onButtonClick: function (){
            if (!this.isDisabled()) {
                this.fireEvent('buttonclick');
            }
        }
    };
    utils.inherits(SplitButton, UIBase);
    utils.extend(SplitButton.prototype, Stateful, true);

})();


// ui/colorbutton.js
///import core
///import uicore
///import ui/colorpicker.js
///import ui/popup.js
///import ui/splitbutton.js
(function (){
    var utils = baidu.editor.utils,
        uiUtils = baidu.editor.ui.uiUtils,
        ColorPicker = baidu.editor.ui.ColorPicker,
        Popup = baidu.editor.ui.Popup,
        SplitButton = baidu.editor.ui.SplitButton,
        ColorButton = baidu.editor.ui.ColorButton = function (options){
            this.initOptions(options);
            this.initColorButton();
        };
    ColorButton.prototype = {
        initColorButton: function (){
            var me = this;
            this.popup = new Popup({
                content: new ColorPicker({
                    noColorText: me.editor.getLang("clearColor"),
                    editor:me.editor,
                    onpickcolor: function (t, color){
                        me._onPickColor(color);
                    },
                    onpicknocolor: function (t, color){
                        me._onPickNoColor(color);
                    }
                }),
                editor:me.editor
            });
            this.initSplitButton();
        },
        _SplitButton_postRender: SplitButton.prototype.postRender,
        postRender: function (){
            this._SplitButton_postRender();
            this.getDom('button_body').appendChild(
                uiUtils.createElementByHtml('<div id="' + this.id + '_colorlump" class="edui-colorlump"></div>')
            );
            this.getDom().className += ' edui-colorbutton';
        },
        setColor: function (color){
            this.getDom('colorlump').style.backgroundColor = color;
            this.color = color;
        },
        _onPickColor: function (color){
            if (this.fireEvent('pickcolor', color) !== false) {
                this.setColor(color);
                this.popup.hide();
            }
        },
        _onPickNoColor: function (color){
            if (this.fireEvent('picknocolor') !== false) {
                this.popup.hide();
            }
        }
    };
    utils.inherits(ColorButton, SplitButton);

})();


// ui/tablebutton.js
///import core
///import uicore
///import ui/popup.js
///import ui/tablepicker.js
///import ui/splitbutton.js
(function (){
    var utils = baidu.editor.utils,
        Popup = baidu.editor.ui.Popup,
        TablePicker = baidu.editor.ui.TablePicker,
        SplitButton = baidu.editor.ui.SplitButton,
        TableButton = baidu.editor.ui.TableButton = function (options){
            this.initOptions(options);
            this.initTableButton();
        };
    TableButton.prototype = {
        initTableButton: function (){
            var me = this;
            this.popup = new Popup({
                content: new TablePicker({
                    editor:me.editor,
                    onpicktable: function (t, numCols, numRows){
                        me._onPickTable(numCols, numRows);
                    }
                }),
                'editor':me.editor
            });
            this.initSplitButton();
        },
        _onPickTable: function (numCols, numRows){
            if (this.fireEvent('picktable', numCols, numRows) !== false) {
                this.popup.hide();
            }
        }
    };
    utils.inherits(TableButton, SplitButton);

})();


// ui/autotypesetpicker.js
///import core
///import uicore
(function () {
    var utils = baidu.editor.utils,
        UIBase = baidu.editor.ui.UIBase;

    var AutoTypeSetPicker = baidu.editor.ui.AutoTypeSetPicker = function (options) {
        this.initOptions(options);
        this.initAutoTypeSetPicker();
    };
    AutoTypeSetPicker.prototype = {
        initAutoTypeSetPicker:function () {
            this.initUIBase();
        },
        getHtmlTpl:function () {
            var me = this.editor,
                opt = me.options.autotypeset,
                lang = me.getLang("autoTypeSet");

            var textAlignInputName = 'textAlignValue' + me.uid,
                imageBlockInputName = 'imageBlockLineValue' + me.uid,
                symbolConverInputName = 'symbolConverValue' + me.uid;

            return '<div id="##" class="edui-autotypesetpicker %%">' +
                '<div class="edui-autotypesetpicker-body">' +
                '<table >' +
                '<tr><td nowrap><input type="checkbox" name="mergeEmptyline" ' + (opt["mergeEmptyline"] ? "checked" : "" ) + '>' + lang.mergeLine + '</td><td colspan="2"><input type="checkbox" name="removeEmptyline" ' + (opt["removeEmptyline"] ? "checked" : "" ) + '>' + lang.delLine + '</td></tr>' +
                '<tr><td nowrap><input type="checkbox" name="removeClass" ' + (opt["removeClass"] ? "checked" : "" ) + '>' + lang.removeFormat + '</td><td colspan="2"><input type="checkbox" name="indent" ' + (opt["indent"] ? "checked" : "" ) + '>' + lang.indent + '</td></tr>' +
                '<tr>' +
                '<td nowrap><input type="checkbox" name="textAlign" ' + (opt["textAlign"] ? "checked" : "" ) + '>' + lang.alignment + '</td>' +
                '<td colspan="2" id="' + textAlignInputName + '">' +
                '<input type="radio" name="'+ textAlignInputName +'" value="left" ' + ((opt["textAlign"] && opt["textAlign"] == "left") ? "checked" : "") + '>' + me.getLang("justifyleft") +
                '<input type="radio" name="'+ textAlignInputName +'" value="center" ' + ((opt["textAlign"] && opt["textAlign"] == "center") ? "checked" : "") + '>' + me.getLang("justifycenter") +
                '<input type="radio" name="'+ textAlignInputName +'" value="right" ' + ((opt["textAlign"] && opt["textAlign"] == "right") ? "checked" : "") + '>' + me.getLang("justifyright") +
                '</td>' +
                '</tr>' +
                '<tr>' +
                '<td nowrap><input type="checkbox" name="imageBlockLine" ' + (opt["imageBlockLine"] ? "checked" : "" ) + '>' + lang.imageFloat + '</td>' +
                '<td nowrap id="'+ imageBlockInputName +'">' +
                '<input type="radio" name="'+ imageBlockInputName +'" value="none" ' + ((opt["imageBlockLine"] && opt["imageBlockLine"] == "none") ? "checked" : "") + '>' + me.getLang("default") +
                '<input type="radio" name="'+ imageBlockInputName +'" value="left" ' + ((opt["imageBlockLine"] && opt["imageBlockLine"] == "left") ? "checked" : "") + '>' + me.getLang("justifyleft") +
                '<input type="radio" name="'+ imageBlockInputName +'" value="center" ' + ((opt["imageBlockLine"] && opt["imageBlockLine"] == "center") ? "checked" : "") + '>' + me.getLang("justifycenter") +
                '<input type="radio" name="'+ imageBlockInputName +'" value="right" ' + ((opt["imageBlockLine"] && opt["imageBlockLine"] == "right") ? "checked" : "") + '>' + me.getLang("justifyright") +
                '</td>' +
                '</tr>' +
                '<tr><td nowrap><input type="checkbox" name="clearFontSize" ' + (opt["clearFontSize"] ? "checked" : "" ) + '>' + lang.removeFontsize + '</td><td colspan="2"><input type="checkbox" name="clearFontFamily" ' + (opt["clearFontFamily"] ? "checked" : "" ) + '>' + lang.removeFontFamily + '</td></tr>' +
                '<tr><td nowrap colspan="3"><input type="checkbox" name="removeEmptyNode" ' + (opt["removeEmptyNode"] ? "checked" : "" ) + '>' + lang.removeHtml + '</td></tr>' +
                '<tr><td nowrap colspan="3"><input type="checkbox" name="pasteFilter" ' + (opt["pasteFilter"] ? "checked" : "" ) + '>' + lang.pasteFilter + '</td></tr>' +
                '<tr>' +
                '<td nowrap><input type="checkbox" name="symbolConver" ' + (opt["bdc2sb"] || opt["tobdc"] ? "checked" : "" ) + '>' + lang.symbol + '</td>' +
                '<td id="' + symbolConverInputName + '">' +
                '<input type="radio" name="bdc" value="bdc2sb" ' + (opt["bdc2sb"] ? "checked" : "" ) + '>' + lang.bdc2sb +
                '<input type="radio" name="bdc" value="tobdc" ' + (opt["tobdc"] ? "checked" : "" ) + '>' + lang.tobdc + '' +
                '</td>' +
                '<td nowrap align="right"><button >' + lang.run + '</button></td>' +
                '</tr>' +
                '</table>' +
                '</div>' +
                '</div>';


        },
        _UIBase_render:UIBase.prototype.render
    };
    utils.inherits(AutoTypeSetPicker, UIBase);
})();


// ui/autotypesetbutton.js
///import core
///import uicore
///import ui/popup.js
///import ui/autotypesetpicker.js
///import ui/splitbutton.js
(function (){
    var utils = baidu.editor.utils,
        Popup = baidu.editor.ui.Popup,
        AutoTypeSetPicker = baidu.editor.ui.AutoTypeSetPicker,
        SplitButton = baidu.editor.ui.SplitButton,
        AutoTypeSetButton = baidu.editor.ui.AutoTypeSetButton = function (options){
            this.initOptions(options);
            this.initAutoTypeSetButton();
        };
    function getPara(me){

        var opt = {},
            cont = me.getDom(),
            editorId = me.editor.uid,
            inputType = null,
            attrName = null,
            ipts = domUtils.getElementsByTagName(cont,"input");
        for(var i=ipts.length-1,ipt;ipt=ipts[i--];){
            inputType = ipt.getAttribute("type");
            if(inputType=="checkbox"){
                attrName = ipt.getAttribute("name");
                opt[attrName] && delete opt[attrName];
                if(ipt.checked){
                    var attrValue = document.getElementById( attrName + "Value" + editorId );
                    if(attrValue){
                        if(/input/ig.test(attrValue.tagName)){
                            opt[attrName] = attrValue.value;
                        } else {
                            var iptChilds = attrValue.getElementsByTagName("input");
                            for(var j=iptChilds.length-1,iptchild;iptchild=iptChilds[j--];){
                                if(iptchild.checked){
                                    opt[attrName] = iptchild.value;
                                    break;
                                }
                            }
                        }
                    } else {
                        opt[attrName] = true;
                    }
                } else {
                    opt[attrName] = false;
                }
            } else {
                opt[ipt.getAttribute("value")] = ipt.checked;
            }

        }

        var selects = domUtils.getElementsByTagName(cont,"select");
        for(var i=0,si;si=selects[i++];){
            var attr = si.getAttribute('name');
            opt[attr] = opt[attr] ? si.value : '';
        }

        utils.extend(me.editor.options.autotypeset,opt);

        me.editor.setPreferences('autotypeset', opt);
    }

    AutoTypeSetButton.prototype = {
        initAutoTypeSetButton: function (){

            var me = this;
            this.popup = new Popup({
                //传入配置参数
                content: new AutoTypeSetPicker({editor:me.editor}),
                'editor':me.editor,
                hide : function(){
                    if (!this._hidden && this.getDom()) {
                        getPara(this);
                        this.getDom().style.display = 'none';
                        this._hidden = true;
                        this.fireEvent('hide');
                    }
                }
            });
            var flag = 0;
            this.popup.addListener('postRenderAfter',function(){
                var popupUI = this;
                if(flag)return;
                var cont = this.getDom(),
                    btn = cont.getElementsByTagName('button')[0];

                btn.onclick = function(){
                    getPara(popupUI);
                    me.editor.execCommand('autotypeset');
                    popupUI.hide()
                };

                domUtils.on(cont, 'click', function(e) {
                    var target = e.target || e.srcElement,
                        editorId = me.editor.uid;
                    if (target && target.tagName == 'INPUT') {

                        // 点击图片浮动的checkbox,去除对应的radio
                        if (target.name == 'imageBlockLine' || target.name == 'textAlign' || target.name == 'symbolConver') {
                            var checked = target.checked,
                                radioTd = document.getElementById( target.name + 'Value' + editorId),
                                radios = radioTd.getElementsByTagName('input'),
                                defalutSelect = {
                                    'imageBlockLine': 'none',
                                    'textAlign': 'left',
                                    'symbolConver': 'tobdc'
                                };

                            for (var i = 0; i < radios.length; i++) {
                                if (checked) {
                                    if (radios[i].value == defalutSelect[target.name]) {
                                        radios[i].checked = 'checked';
                                    }
                                } else {
                                    radios[i].checked = false;
                                }
                            }
                        }
                        // 点击radio,选中对应的checkbox
                        if (target.name == ('imageBlockLineValue' + editorId) || target.name == ('textAlignValue' + editorId) || target.name == 'bdc') {
                            var checkboxs = target.parentNode.previousSibling.getElementsByTagName('input');
                            checkboxs && (checkboxs[0].checked = true);
                        }

                        getPara(popupUI);
                    }
                });

                flag = 1;
            });
            this.initSplitButton();
        }
    };
    utils.inherits(AutoTypeSetButton, SplitButton);

})();


// ui/cellalignpicker.js
///import core
///import uicore
(function () {
    var utils = baidu.editor.utils,
        Popup = baidu.editor.ui.Popup,
        Stateful = baidu.editor.ui.Stateful,
        UIBase = baidu.editor.ui.UIBase;

    /**
     * 该参数将新增一个参数： selected， 参数类型为一个Object， 形如{ 'align': 'center', 'valign': 'top' }， 表示单元格的初始
     * 对齐状态为： 竖直居上，水平居中; 其中 align的取值为：'center', 'left', 'right'; valign的取值为: 'top', 'middle', 'bottom'
     * @update 2013/4/2 hancong03@baidu.com
     */
    var CellAlignPicker = baidu.editor.ui.CellAlignPicker = function (options) {
        this.initOptions(options);
        this.initSelected();
        this.initCellAlignPicker();
    };
    CellAlignPicker.prototype = {
        //初始化选中状态， 该方法将根据传递进来的参数获取到应该选中的对齐方式图标的索引
        initSelected: function(){

            var status = {

                valign: {
                    top: 0,
                    middle: 1,
                    bottom: 2
                },
                align: {
                    left: 0,
                    center: 1,
                    right: 2
                },
                count: 3

                },
                result = -1;

            if( this.selected ) {
                this.selectedIndex = status.valign[ this.selected.valign ] * status.count + status.align[ this.selected.align ];
            }

        },
        initCellAlignPicker:function () {
            this.initUIBase();
            this.Stateful_init();
        },
        getHtmlTpl:function () {

            var alignType = [ 'left', 'center', 'right' ],
                COUNT = 9,
                tempClassName = null,
                tempIndex = -1,
                tmpl = [];


            for( var i= 0; i<COUNT; i++ ) {

                tempClassName = this.selectedIndex === i ? ' class="edui-cellalign-selected" ' : '';
                tempIndex = i % 3;

                tempIndex === 0 && tmpl.push('<tr>');

                tmpl.push( '<td index="'+ i +'" ' + tempClassName + ' stateful><div class="edui-icon edui-'+ alignType[ tempIndex ] +'"></div></td>' );

                tempIndex === 2 && tmpl.push('</tr>');

            }

            return '<div id="##" class="edui-cellalignpicker %%">' +
                '<div class="edui-cellalignpicker-body">' +
                '<table onclick="$$._onClick(event);">' +
                tmpl.join('') +
                '</table>' +
                '</div>' +
                '</div>';
        },
        getStateDom: function (){
            return this.target;
        },
        _onClick: function (evt){
            var target= evt.target || evt.srcElement;
            if(/icon/.test(target.className)){
                this.items[target.parentNode.getAttribute("index")].onclick();
                Popup.postHide(evt);
            }
        },
        _UIBase_render:UIBase.prototype.render
    };
    utils.inherits(CellAlignPicker, UIBase);
    utils.extend(CellAlignPicker.prototype, Stateful,true);
})();





// ui/pastepicker.js
///import core
///import uicore
(function () {
    var utils = baidu.editor.utils,
        Stateful = baidu.editor.ui.Stateful,
        uiUtils = baidu.editor.ui.uiUtils,
        UIBase = baidu.editor.ui.UIBase;

    var PastePicker = baidu.editor.ui.PastePicker = function (options) {
        this.initOptions(options);
        this.initPastePicker();
    };
    PastePicker.prototype = {
        initPastePicker:function () {
            this.initUIBase();
            this.Stateful_init();
        },
        getHtmlTpl:function () {
            return '<div class="edui-pasteicon" onclick="$$._onClick(this)"></div>' +
                '<div class="edui-pastecontainer">' +
                '<div class="edui-title">' + this.editor.getLang("pasteOpt") + '</div>' +
                '<div class="edui-button">' +
                '<div title="' + this.editor.getLang("pasteSourceFormat") + '" onclick="$$.format(false)" stateful>' +
                '<div class="edui-richtxticon"></div></div>' +
                '<div title="' + this.editor.getLang("tagFormat") + '" onclick="$$.format(2)" stateful>' +
                '<div class="edui-tagicon"></div></div>' +
                '<div title="' + this.editor.getLang("pasteTextFormat") + '" onclick="$$.format(true)" stateful>' +
                '<div class="edui-plaintxticon"></div></div>' +
                '</div>' +
                '</div>' +
                '</div>'
        },
        getStateDom:function () {
            return this.target;
        },
        format:function (param) {
            this.editor.ui._isTransfer = true;
            this.editor.fireEvent('pasteTransfer', param);
        },
        _onClick:function (cur) {
            var node = domUtils.getNextDomNode(cur),
                screenHt = uiUtils.getViewportRect().height,
                subPop = uiUtils.getClientRect(node);

            if ((subPop.top + subPop.height) > screenHt)
                node.style.top = (-subPop.height - cur.offsetHeight) + "px";
            else
                node.style.top = "";

            if (/hidden/ig.test(domUtils.getComputedStyle(node, "visibility"))) {
                node.style.visibility = "visible";
                domUtils.addClass(cur, "edui-state-opened");
            } else {
                node.style.visibility = "hidden";
                domUtils.removeClasses(cur, "edui-state-opened")
            }
        },
        _UIBase_render:UIBase.prototype.render
    };
    utils.inherits(PastePicker, UIBase);
    utils.extend(PastePicker.prototype, Stateful, true);
})();






// ui/toolbar.js
(function (){
    var utils = baidu.editor.utils,
        uiUtils = baidu.editor.ui.uiUtils,
        UIBase = baidu.editor.ui.UIBase,
        Toolbar = baidu.editor.ui.Toolbar = function (options){
            this.initOptions(options);
            this.initToolbar();
        };
    Toolbar.prototype = {
        items: null,
        initToolbar: function (){
            this.items = this.items || [];
            this.initUIBase();
        },
        add: function (item,index){
            if(index === undefined){
                this.items.push(item);
            }else{
                this.items.splice(index,0,item)
            }

        },
        getHtmlTpl: function (){
            var buff = [];
            for (var i=0; i<this.items.length; i++) {
                buff[i] = this.items[i].renderHtml();
            }
            return '<div id="##" class="edui-toolbar %%" onselectstart="return false;" onmousedown="return $$._onMouseDown(event, this);">' +
                buff.join('') +
                '</div>'
        },
        postRender: function (){
            var box = this.getDom();
            for (var i=0; i<this.items.length; i++) {
                this.items[i].postRender();
            }
            uiUtils.makeUnselectable(box);
        },
        _onMouseDown: function (e){
            var target = e.target || e.srcElement,
                tagName = target && target.tagName && target.tagName.toLowerCase();
            if (tagName == 'input' || tagName == 'object' || tagName == 'object') {
                return false;
            }
        }
    };
    utils.inherits(Toolbar, UIBase);

})();


// ui/menu.js
///import core
///import uicore
///import ui\popup.js
///import ui\stateful.js
(function () {
    var utils = baidu.editor.utils,
        domUtils = baidu.editor.dom.domUtils,
        uiUtils = baidu.editor.ui.uiUtils,
        UIBase = baidu.editor.ui.UIBase,
        Popup = baidu.editor.ui.Popup,
        Stateful = baidu.editor.ui.Stateful,
        CellAlignPicker = baidu.editor.ui.CellAlignPicker,

        Menu = baidu.editor.ui.Menu = function (options) {
            this.initOptions(options);
            this.initMenu();
        };

    var menuSeparator = {
        renderHtml:function () {
            return '<div class="edui-menuitem edui-menuseparator"><div class="edui-menuseparator-inner"></div></div>';
        },
        postRender:function () {
        },
        queryAutoHide:function () {
            return true;
        }
    };
    Menu.prototype = {
        items:null,
        uiName:'menu',
        initMenu:function () {
            this.items = this.items || [];
            this.initPopup();
            this.initItems();
        },
        initItems:function () {
            for (var i = 0; i < this.items.length; i++) {
                var item = this.items[i];
                if (item == '-') {
                    this.items[i] = this.getSeparator();
                } else if (!(item instanceof MenuItem)) {
                    item.editor = this.editor;
                    item.theme = this.editor.options.theme;
                    this.items[i] = this.createItem(item);
                }
            }
        },
        getSeparator:function () {
            return menuSeparator;
        },
        createItem:function (item) {
            //新增一个参数menu, 该参数存储了menuItem所对应的menu引用
            item.menu = this;
            return new MenuItem(item);
        },
        _Popup_getContentHtmlTpl:Popup.prototype.getContentHtmlTpl,
        getContentHtmlTpl:function () {
            if (this.items.length == 0) {
                return this._Popup_getContentHtmlTpl();
            }
            var buff = [];
            for (var i = 0; i < this.items.length; i++) {
                var item = this.items[i];
                buff[i] = item.renderHtml();
            }
            return ('<div class="%%-body">' + buff.join('') + '</div>');
        },
        _Popup_postRender:Popup.prototype.postRender,
        postRender:function () {
            var me = this;
            for (var i = 0; i < this.items.length; i++) {
                var item = this.items[i];
                item.ownerMenu = this;
                item.postRender();
            }
            domUtils.on(this.getDom(), 'mouseover', function (evt) {
                evt = evt || event;
                var rel = evt.relatedTarget || evt.fromElement;
                var el = me.getDom();
                if (!uiUtils.contains(el, rel) && el !== rel) {
                    me.fireEvent('over');
                }
            });
            this._Popup_postRender();
        },
        queryAutoHide:function (el) {
            if (el) {
                if (uiUtils.contains(this.getDom(), el)) {
                    return false;
                }
                for (var i = 0; i < this.items.length; i++) {
                    var item = this.items[i];
                    if (item.queryAutoHide(el) === false) {
                        return false;
                    }
                }
            }
        },
        clearItems:function () {
            for (var i = 0; i < this.items.length; i++) {
                var item = this.items[i];
                clearTimeout(item._showingTimer);
                clearTimeout(item._closingTimer);
                if (item.subMenu) {
                    item.subMenu.destroy();
                }
            }
            this.items = [];
        },
        destroy:function () {
            if (this.getDom()) {
                domUtils.remove(this.getDom());
            }
            this.clearItems();
        },
        dispose:function () {
            this.destroy();
        }
    };
    utils.inherits(Menu, Popup);

    /**
     * @update 2013/04/03 hancong03 新增一个参数menu, 该参数存储了menuItem所对应的menu引用
     * @type {Function}
     */
    var MenuItem = baidu.editor.ui.MenuItem = function (options) {
        this.initOptions(options);
        this.initUIBase();
        this.Stateful_init();
        if (this.subMenu && !(this.subMenu instanceof Menu)) {
            if (options.className && options.className.indexOf("aligntd") != -1) {
                var me = this;

                //获取单元格对齐初始状态
                this.subMenu.selected = this.editor.queryCommandValue( 'cellalignment' );

                this.subMenu = new Popup({
                    content:new CellAlignPicker(this.subMenu),
                    parentMenu:me,
                    editor:me.editor,
                    destroy:function () {
                        if (this.getDom()) {
                            domUtils.remove(this.getDom());
                        }
                    }
                });
                this.subMenu.addListener("postRenderAfter", function () {
                    domUtils.on(this.getDom(), "mouseover", function () {
                        me.addState('opened');
                    });
                });
            } else {
                this.subMenu = new Menu(this.subMenu);
            }
        }
    };
    MenuItem.prototype = {
        label:'',
        subMenu:null,
        ownerMenu:null,
        uiName:'menuitem',
        alwalysHoverable:true,
        getHtmlTpl:function () {
            return '<div id="##" class="%%" stateful onclick="$$._onClick(event, this);">' +
                '<div class="%%-body">' +
                this.renderLabelHtml() +
                '</div>' +
                '</div>';
        },
        postRender:function () {
            var me = this;
            this.addListener('over', function () {
                me.ownerMenu.fireEvent('submenuover', me);
                if (me.subMenu) {
                    me.delayShowSubMenu();
                }
            });
            if (this.subMenu) {
                this.getDom().className += ' edui-hassubmenu';
                this.subMenu.render();
                this.addListener('out', function () {
                    me.delayHideSubMenu();
                });
                this.subMenu.addListener('over', function () {
                    clearTimeout(me._closingTimer);
                    me._closingTimer = null;
                    me.addState('opened');
                });
                this.ownerMenu.addListener('hide', function () {
                    me.hideSubMenu();
                });
                this.ownerMenu.addListener('submenuover', function (t, subMenu) {
                    if (subMenu !== me) {
                        me.delayHideSubMenu();
                    }
                });
                this.subMenu._bakQueryAutoHide = this.subMenu.queryAutoHide;
                this.subMenu.queryAutoHide = function (el) {
                    if (el && uiUtils.contains(me.getDom(), el)) {
                        return false;
                    }
                    return this._bakQueryAutoHide(el);
                };
            }
            this.getDom().style.tabIndex = '-1';
            uiUtils.makeUnselectable(this.getDom());
            this.Stateful_postRender();
        },
        delayShowSubMenu:function () {
            var me = this;
            if (!me.isDisabled()) {
                me.addState('opened');
                clearTimeout(me._showingTimer);
                clearTimeout(me._closingTimer);
                me._closingTimer = null;
                me._showingTimer = setTimeout(function () {
                    me.showSubMenu();
                }, 250);
            }
        },
        delayHideSubMenu:function () {
            var me = this;
            if (!me.isDisabled()) {
                me.removeState('opened');
                clearTimeout(me._showingTimer);
                if (!me._closingTimer) {
                    me._closingTimer = setTimeout(function () {
                        if (!me.hasState('opened')) {
                            me.hideSubMenu();
                        }
                        me._closingTimer = null;
                    }, 400);
                }
            }
        },
        renderLabelHtml:function () {
            return '<div class="edui-arrow"></div>' +
                '<div class="edui-box edui-icon"></div>' +
                '<div class="edui-box edui-label %%-label">' + (this.label || '') + '</div>';
        },
        getStateDom:function () {
            return this.getDom();
        },
        queryAutoHide:function (el) {
            if (this.subMenu && this.hasState('opened')) {
                return this.subMenu.queryAutoHide(el);
            }
        },
        _onClick:function (event, this_) {
            if (this.hasState('disabled')) return;
            if (this.fireEvent('click', event, this_) !== false) {
                if (this.subMenu) {
                    this.showSubMenu();
                } else {
                    Popup.postHide(event);
                }
            }
        },
        showSubMenu:function () {
            var rect = uiUtils.getClientRect(this.getDom());
            rect.right -= 5;
            rect.left += 2;
            rect.width -= 7;
            rect.top -= 4;
            rect.bottom += 4;
            rect.height += 8;
            this.subMenu.showAnchorRect(rect, true, true);
        },
        hideSubMenu:function () {
            this.subMenu.hide();
        }
    };
    utils.inherits(MenuItem, UIBase);
    utils.extend(MenuItem.prototype, Stateful, true);
})();


// ui/combox.js
///import core
///import uicore
///import ui/menu.js
///import ui/splitbutton.js
(function (){
    // todo: menu和item提成通用list
    var utils = baidu.editor.utils,
        uiUtils = baidu.editor.ui.uiUtils,
        Menu = baidu.editor.ui.Menu,
        SplitButton = baidu.editor.ui.SplitButton,
        Combox = baidu.editor.ui.Combox = function (options){
            this.initOptions(options);
            this.initCombox();
        };
    Combox.prototype = {
        uiName: 'combox',
        onbuttonclick:function () {
            this.showPopup();
        },
        initCombox: function (){
            var me = this;
            this.items = this.items || [];
            for (var i=0; i<this.items.length; i++) {
                var item = this.items[i];
                item.uiName = 'listitem';
                item.index = i;
                item.onclick = function (){
                    me.selectByIndex(this.index);
                };
            }
            this.popup = new Menu({
                items: this.items,
                uiName: 'list',
                editor:this.editor,
                captureWheel: true,
                combox: this
            });

            this.initSplitButton();
        },
        _SplitButton_postRender: SplitButton.prototype.postRender,
        postRender: function (){
            this._SplitButton_postRender();
            this.setLabel(this.label || '');
            this.setValue(this.initValue || '');
        },
        showPopup: function (){
            var rect = uiUtils.getClientRect(this.getDom());
            rect.top += 1;
            rect.bottom -= 1;
            rect.height -= 2;
            this.popup.showAnchorRect(rect);
        },
        getValue: function (){
            return this.value;
        },
        setValue: function (value){
            var index = this.indexByValue(value);
            if (index != -1) {
                this.selectedIndex = index;
                this.setLabel(this.items[index].label);
                this.value = this.items[index].value;
            } else {
                this.selectedIndex = -1;
                this.setLabel(this.getLabelForUnknowValue(value));
                this.value = value;
            }
        },
        setLabel: function (label){
            this.getDom('button_body').innerHTML = label;
            this.label = label;
        },
        getLabelForUnknowValue: function (value){
            return value;
        },
        indexByValue: function (value){
            for (var i=0; i<this.items.length; i++) {
                if (value == this.items[i].value) {
                    return i;
                }
            }
            return -1;
        },
        getItem: function (index){
            return this.items[index];
        },
        selectByIndex: function (index){
            if (index < this.items.length && this.fireEvent('select', index) !== false) {
                this.selectedIndex = index;
                this.value = this.items[index].value;
                this.setLabel(this.items[index].label);
            }
        }
    };
    utils.inherits(Combox, SplitButton);
})();


// ui/dialog.js
///import core
///import uicore
///import ui/mask.js
///import ui/button.js
(function (){
    var utils = baidu.editor.utils,
        domUtils = baidu.editor.dom.domUtils,
        uiUtils = baidu.editor.ui.uiUtils,
        Mask = baidu.editor.ui.Mask,
        UIBase = baidu.editor.ui.UIBase,
        Button = baidu.editor.ui.Button,
        Dialog = baidu.editor.ui.Dialog = function (options){
            if(options.name){
                var name = options.name;
                var cssRules = options.cssRules;
                if(!options.className){
                    options.className =  'edui-for-' + name;
                }
                if(cssRules){
                    options.cssRules = '.edui-default .edui-for-'+ name +' .edui-dialog-content  {'+ cssRules +'}'
                }
            }
            this.initOptions(utils.extend({
                autoReset: true,
                draggable: true,
                onok: function (){},
                oncancel: function (){},
                onclose: function (t, ok){
                    return ok ? this.onok() : this.oncancel();
                },
                //是否控制dialog中的scroll事件， 默认为不阻止
                holdScroll: false
            },options));
            this.initDialog();
        };
    var modalMask;
    var dragMask;
    var activeDialog;
    Dialog.prototype = {
        draggable: false,
        uiName: 'dialog',
        initDialog: function (){
            var me = this,
                theme=this.editor.options.theme;
            if(this.cssRules){
                utils.cssRule('edui-customize-'+this.name+'-style',this.cssRules);
            }
            this.initUIBase();
            this.modalMask = (modalMask || (modalMask = new Mask({
                className: 'edui-dialog-modalmask',
                theme:theme,
                onclick: function (){
                    activeDialog && activeDialog.close(false);
                }
            })));
            this.dragMask = (dragMask || (dragMask = new Mask({
                className: 'edui-dialog-dragmask',
                theme:theme
            })));
            this.closeButton = new Button({
                className: 'edui-dialog-closebutton',
                title: me.closeDialog,
                theme:theme,
                onclick: function (){
                    me.close(false);
                }
            });

            this.fullscreen && this.initResizeEvent();

            if (this.buttons) {
                for (var i=0; i<this.buttons.length; i++) {
                    if (!(this.buttons[i] instanceof Button)) {
                        this.buttons[i] = new Button(utils.extend(this.buttons[i],{
                            editor : this.editor
                        },true));
                    }
                }
            }
        },
        initResizeEvent: function () {

            var me = this;

            domUtils.on( window, "resize", function () {

                if ( me._hidden || me._hidden === undefined ) {
                    return;
                }

                if ( me.__resizeTimer ) {
                    window.clearTimeout( me.__resizeTimer );
                }

                me.__resizeTimer = window.setTimeout( function () {

                    me.__resizeTimer = null;

                    var dialogWrapNode = me.getDom(),
                        contentNode = me.getDom('content'),
                        wrapRect = UE.ui.uiUtils.getClientRect( dialogWrapNode ),
                        contentRect = UE.ui.uiUtils.getClientRect( contentNode ),
                        vpRect = uiUtils.getViewportRect();

                    contentNode.style.width = ( vpRect.width - wrapRect.width + contentRect.width ) + "px";
                    contentNode.style.height = ( vpRect.height - wrapRect.height + contentRect.height ) + "px";

                    dialogWrapNode.style.width = vpRect.width + "px";
                    dialogWrapNode.style.height = vpRect.height + "px";

                    me.fireEvent( "resize" );

                }, 100 );

            } );

        },
        fitSize: function (){
            var popBodyEl = this.getDom('body');
//            if (!(baidu.editor.browser.ie && baidu.editor.browser.version == 7)) {
//                uiUtils.removeStyle(popBodyEl, 'width');
//                uiUtils.removeStyle(popBodyEl, 'height');
//            }
            var size = this.mesureSize();
            popBodyEl.style.width = size.width + 'px';
            popBodyEl.style.height = size.height + 'px';
            return size;
        },
        safeSetOffset: function (offset){
            var me = this;
            var el = me.getDom();
            var vpRect = uiUtils.getViewportRect();
            var rect = uiUtils.getClientRect(el);
            var left = offset.left;
            if (left + rect.width > vpRect.right) {
                left = vpRect.right - rect.width;
            }
            var top = offset.top;
            if (top + rect.height > vpRect.bottom) {
                top = vpRect.bottom - rect.height;
            }
            el.style.left = Math.max(left, 0) + 'px';
            el.style.top = Math.max(top, 0) + 'px';
        },
        showAtCenter: function (){

            var vpRect = uiUtils.getViewportRect();

            if ( !this.fullscreen ) {
                this.getDom().style.display = '';
                var popSize = this.fitSize();
                var titleHeight = this.getDom('titlebar').offsetHeight | 0;
                var left = vpRect.width / 2 - popSize.width / 2;
                var top = vpRect.height / 2 - (popSize.height - titleHeight) / 2 - titleHeight;
                var popEl = this.getDom();
                this.safeSetOffset({
                    left: Math.max(left | 0, 0),
                    top: Math.max(top | 0, 0)
                });
                if (!domUtils.hasClass(popEl, 'edui-state-centered')) {
                    popEl.className += ' edui-state-centered';
                }
            } else {
                var dialogWrapNode = this.getDom(),
                    contentNode = this.getDom('content');

                dialogWrapNode.style.display = "block";

                var wrapRect = UE.ui.uiUtils.getClientRect( dialogWrapNode ),
                    contentRect = UE.ui.uiUtils.getClientRect( contentNode );
                dialogWrapNode.style.left = "-100000px";

                contentNode.style.width = ( vpRect.width - wrapRect.width + contentRect.width ) + "px";
                contentNode.style.height = ( vpRect.height - wrapRect.height + contentRect.height ) + "px";

                dialogWrapNode.style.width = vpRect.width + "px";
                dialogWrapNode.style.height = vpRect.height + "px";
                dialogWrapNode.style.left = 0;

                //保存环境的overflow值
                this._originalContext = {
                    html: {
                        overflowX: document.documentElement.style.overflowX,
                        overflowY: document.documentElement.style.overflowY
                    },
                    body: {
                        overflowX: document.body.style.overflowX,
                        overflowY: document.body.style.overflowY
                    }
                };

                document.documentElement.style.overflowX = 'hidden';
                document.documentElement.style.overflowY = 'hidden';
                document.body.style.overflowX = 'hidden';
                document.body.style.overflowY = 'hidden';

            }

            this._show();
        },
        getContentHtml: function (){
            var contentHtml = '';
            if (typeof this.content == 'string') {
                contentHtml = this.content;
            } else if (this.iframeUrl) {
                contentHtml = '<span id="'+ this.id +'_contmask" class="dialogcontmask"></span><iframe id="'+ this.id +
                    '_iframe" class="%%-iframe" height="100%" width="100%" frameborder="0" src="'+ this.iframeUrl +'"></iframe>';
            }
            return contentHtml;
        },
        getHtmlTpl: function (){
            var footHtml = '';

            if (this.buttons) {
                var buff = [];
                for (var i=0; i<this.buttons.length; i++) {
                    buff[i] = this.buttons[i].renderHtml();
                }
                footHtml = '<div class="%%-foot">' +
                     '<div id="##_buttons" class="%%-buttons">' + buff.join('') + '</div>' +
                    '</div>';
            }

            return '<div id="##" class="%%"><div '+ ( !this.fullscreen ? 'class="%%"' : 'class="%%-wrap edui-dialog-fullscreen-flag"' ) +'><div id="##_body" class="%%-body">' +
                '<div class="%%-shadow"></div>' +
                '<div id="##_titlebar" class="%%-titlebar">' +
                '<div class="%%-draghandle" onmousedown="$$._onTitlebarMouseDown(event, this);">' +
                 '<span class="%%-caption">' + (this.title || '') + '</span>' +
                '</div>' +
                this.closeButton.renderHtml() +
                '</div>' +
                '<div id="##_content" class="%%-content">'+ ( this.autoReset ? '' : this.getContentHtml()) +'</div>' +
                footHtml +
                '</div></div></div>';
        },
        postRender: function (){
            // todo: 保持居中/记住上次关闭位置选项
            if (!this.modalMask.getDom()) {
                this.modalMask.render();
                this.modalMask.hide();
            }
            if (!this.dragMask.getDom()) {
                this.dragMask.render();
                this.dragMask.hide();
            }
            var me = this;
            this.addListener('show', function (){
                me.modalMask.show(this.getDom().style.zIndex - 2);
            });
            this.addListener('hide', function (){
                me.modalMask.hide();
            });
            if (this.buttons) {
                for (var i=0; i<this.buttons.length; i++) {
                    this.buttons[i].postRender();
                }
            }
            domUtils.on(window, 'resize', function (){
                setTimeout(function (){
                    if (!me.isHidden()) {
                        me.safeSetOffset(uiUtils.getClientRect(me.getDom()));
                    }
                });
            });

            //hold住scroll事件，防止dialog的滚动影响页面
//            if( this.holdScroll ) {
//
//                if( !me.iframeUrl ) {
//                    domUtils.on( document.getElementById( me.id + "_iframe"), !browser.gecko ? "mousewheel" : "DOMMouseScroll", function(e){
//                        domUtils.preventDefault(e);
//                    } );
//                } else {
//                    me.addListener('dialogafterreset', function(){
//                        window.setTimeout(function(){
//                            var iframeWindow = document.getElementById( me.id + "_iframe").contentWindow;
//
//                            if( browser.ie ) {
//
//                                var timer = window.setInterval(function(){
//
//                                    if( iframeWindow.document && iframeWindow.document.body ) {
//                                        window.clearInterval( timer );
//                                        timer = null;
//                                        domUtils.on( iframeWindow.document.body, !browser.gecko ? "mousewheel" : "DOMMouseScroll", function(e){
//                                            domUtils.preventDefault(e);
//                                        } );
//                                    }
//
//                                }, 100);
//
//                            } else {
//                                domUtils.on( iframeWindow, !browser.gecko ? "mousewheel" : "DOMMouseScroll", function(e){
//                                    domUtils.preventDefault(e);
//                                } );
//                            }
//
//                        }, 1);
//                    });
//                }
//
//            }
            this._hide();
        },
        mesureSize: function (){
            var body = this.getDom('body');
            var width = uiUtils.getClientRect(this.getDom('content')).width;
            var dialogBodyStyle = body.style;
            dialogBodyStyle.width = width;
            return uiUtils.getClientRect(body);
        },
        _onTitlebarMouseDown: function (evt, el){
            if (this.draggable) {
                var rect;
                var vpRect = uiUtils.getViewportRect();
                var me = this;
                uiUtils.startDrag(evt, {
                    ondragstart: function (){
                        rect = uiUtils.getClientRect(me.getDom());
                        me.getDom('contmask').style.visibility = 'visible';
                        me.dragMask.show(me.getDom().style.zIndex - 1);
                    },
                    ondragmove: function (x, y){
                        var left = rect.left + x;
                        var top = rect.top + y;
                        me.safeSetOffset({
                            left: left,
                            top: top
                        });
                    },
                    ondragstop: function (){
                        me.getDom('contmask').style.visibility = 'hidden';
                        domUtils.removeClasses(me.getDom(), ['edui-state-centered']);
                        me.dragMask.hide();
                    }
                });
            }
        },
        reset: function (){
            this.getDom('content').innerHTML = this.getContentHtml();
            this.fireEvent('dialogafterreset');
        },
        _show: function (){
            if (this._hidden) {
                this.getDom().style.display = '';

                //要高过编辑器的zindxe
                this.editor.container.style.zIndex && (this.getDom().style.zIndex = this.editor.container.style.zIndex * 1 + 10);
                this._hidden = false;
                this.fireEvent('show');
                baidu.editor.ui.uiUtils.getFixedLayer().style.zIndex = this.getDom().style.zIndex - 4;
            }
        },
        isHidden: function (){
            return this._hidden;
        },
        _hide: function (){
            if (!this._hidden) {
                var wrapNode = this.getDom();
                wrapNode.style.display = 'none';
                wrapNode.style.zIndex = '';
                wrapNode.style.width = '';
                wrapNode.style.height = '';
                this._hidden = true;
                this.fireEvent('hide');
            }
        },
        open: function (){
            if (this.autoReset) {
                //有可能还没有渲染
                try{
                    this.reset();
                }catch(e){
                    this.render();
                    this.open()
                }
            }
            this.showAtCenter();
            if (this.iframeUrl) {
                try {
                    this.getDom('iframe').focus();
                } catch(ex){}
            }
            activeDialog = this;
        },
        _onCloseButtonClick: function (evt, el){
            this.close(false);
        },
        close: function (ok){
            if (this.fireEvent('close', ok) !== false) {
                //还原环境
                if ( this.fullscreen ) {

                    document.documentElement.style.overflowX = this._originalContext.html.overflowX;
                    document.documentElement.style.overflowY = this._originalContext.html.overflowY;
                    document.body.style.overflowX = this._originalContext.body.overflowX;
                    document.body.style.overflowY = this._originalContext.body.overflowY;
                    delete this._originalContext;

                }
                this._hide();

                //销毁content
                var content = this.getDom('content');
                var iframe = this.getDom('iframe');
                if (content && iframe) {
                    var doc = iframe.contentDocument || iframe.contentWindow.document;
                    doc && (doc.body.innerHTML = '');
                    domUtils.remove(content);
                }
            }
        }
    };
    utils.inherits(Dialog, UIBase);
})();


// ui/menubutton.js
///import core
///import uicore
///import ui/menu.js
///import ui/splitbutton.js
(function (){
    var utils = baidu.editor.utils,
        Menu = baidu.editor.ui.Menu,
        SplitButton = baidu.editor.ui.SplitButton,
        MenuButton = baidu.editor.ui.MenuButton = function (options){
            this.initOptions(options);
            this.initMenuButton();
        };
    MenuButton.prototype = {
        initMenuButton: function (){
            var me = this;
            this.uiName = "menubutton";
            this.popup = new Menu({
                items: me.items,
                className: me.className,
                editor:me.editor
            });
            this.popup.addListener('show', function (){
                var list = this;
                for (var i=0; i<list.items.length; i++) {
                    list.items[i].removeState('checked');
                    if (list.items[i].value == me._value) {
                        list.items[i].addState('checked');
                        this.value = me._value;
                    }
                }
            });
            this.initSplitButton();
        },
        setValue : function(value){
            this._value = value;
        }
        
    };
    utils.inherits(MenuButton, SplitButton);
})();

// ui/multiMenu.js
///import core
///import uicore
 ///commands 表情
(function(){
    var utils = baidu.editor.utils,
        Popup = baidu.editor.ui.Popup,
        SplitButton = baidu.editor.ui.SplitButton,
        MultiMenuPop = baidu.editor.ui.MultiMenuPop = function(options){
            this.initOptions(options);
            this.initMultiMenu();
        };

    MultiMenuPop.prototype = {
        initMultiMenu: function (){
            var me = this;
            this.popup = new Popup({
                content: '',
                editor : me.editor,
                iframe_rendered: false,
                onshow: function (){
                    if (!this.iframe_rendered) {
                        this.iframe_rendered = true;
                        this.getDom('content').innerHTML = '<iframe id="'+me.id+'_iframe" src="'+ me.iframeUrl +'" frameborder="0"></iframe>';
                        me.editor.container.style.zIndex && (this.getDom().style.zIndex = me.editor.container.style.zIndex * 1 + 1);
                    }
                }
               // canSideUp:false,
               // canSideLeft:false
            });
            this.onbuttonclick = function(){
                this.showPopup();
            };
            this.initSplitButton();
        }

    };

    utils.inherits(MultiMenuPop, SplitButton);
})();


// ui/shortcutmenu.js
(function () {
    var UI = baidu.editor.ui,
        UIBase = UI.UIBase,
        uiUtils = UI.uiUtils,
        utils = baidu.editor.utils,
        domUtils = baidu.editor.dom.domUtils;

    var allMenus = [],//存储所有快捷菜单
        timeID,
        isSubMenuShow = false;//是否有子pop显示

    var ShortCutMenu = UI.ShortCutMenu = function (options) {
        this.initOptions (options);
        this.initShortCutMenu ();
    };

    ShortCutMenu.postHide = hideAllMenu;

    ShortCutMenu.prototype = {
        isHidden : true ,
        SPACE : 5 ,
        initShortCutMenu : function () {
            this.items = this.items || [];
            this.initUIBase ();
            this.initItems ();
            this.initEvent ();
            allMenus.push (this);
        } ,
        initEvent : function () {
            var me = this,
                doc = me.editor.document;

            domUtils.on (doc , "mousemove" , function (e) {
                if (me.isHidden === false) {
                    //有pop显示就不隐藏快捷菜单
                    if (me.getSubMenuMark () || me.eventType == "contextmenu")   return;


                    var flag = true,
                        el = me.getDom (),
                        wt = el.offsetWidth,
                        ht = el.offsetHeight,
                        distanceX = wt / 2 + me.SPACE,//距离中心X标准
                        distanceY = ht / 2,//距离中心Y标准
                        x = Math.abs (e.screenX - me.left),//离中心距离横坐标
                        y = Math.abs (e.screenY - me.top);//离中心距离纵坐标

                    clearTimeout (timeID);
                    timeID = setTimeout (function () {
                        if (y > 0 && y < distanceY) {
                            me.setOpacity (el , "1");
                        } else if (y > distanceY && y < distanceY + 70) {
                            me.setOpacity (el , "0.5");
                            flag = false;
                        } else if (y > distanceY + 70 && y < distanceY + 140) {
                            me.hide ();
                        }

                        if (flag && x > 0 && x < distanceX) {
                            me.setOpacity (el , "1")
                        } else if (x > distanceX && x < distanceX + 70) {
                            me.setOpacity (el , "0.5")
                        } else if (x > distanceX + 70 && x < distanceX + 140) {
                            me.hide ();
                        }
                    });
                }
            });

            //ie\ff下 mouseout不准
            if (browser.chrome) {
                domUtils.on (doc , "mouseout" , function (e) {
                    var relatedTgt = e.relatedTarget || e.toElement;

                    if (relatedTgt == null || relatedTgt.tagName == "HTML") {
                        me.hide ();
                    }
                });
            }

            me.editor.addListener ("afterhidepop" , function () {
                if (!me.isHidden) {
                    isSubMenuShow = true;
                }
            });

        } ,
        initItems : function () {
            if (utils.isArray (this.items)) {
                for (var i = 0, len = this.items.length ; i < len ; i++) {
                    var item = this.items[i].toLowerCase ();

                    if (UI[item]) {
                        this.items[i] = new UI[item] (this.editor);
                        this.items[i].className += " edui-shortcutsubmenu ";
                    }
                }
            }
        } ,
        setOpacity : function (el , value) {
            if (browser.ie && browser.version < 9) {
                el.style.filter = "alpha(opacity = " + parseFloat (value) * 100 + ");"
            } else {
                el.style.opacity = value;
            }
        } ,
        getSubMenuMark : function () {
            isSubMenuShow = false;
            var layerEle = uiUtils.getFixedLayer ();
            var list = domUtils.getElementsByTagName (layerEle , "div" , function (node) {
                return domUtils.hasClass (node , "edui-shortcutsubmenu edui-popup")
            });

            for (var i = 0, node ; node = list[i++] ;) {
                if (node.style.display != "none") {
                    isSubMenuShow = true;
                }
            }
            return isSubMenuShow;
        } ,
        show : function (e , hasContextmenu) {
            var me = this,
                offset = {},
                el = this.getDom (),
                fixedlayer = uiUtils.getFixedLayer ();

            function setPos (offset) {
                if (offset.left < 0) {
                    offset.left = 0;
                }
                if (offset.top < 0) {
                    offset.top = 0;
                }
                el.style.cssText = "position:absolute;left:" + offset.left + "px;top:" + offset.top + "px;";
            }

            function setPosByCxtMenu (menu) {
                if (!menu.tagName) {
                    menu = menu.getDom ();
                }
                offset.left = parseInt (menu.style.left);
                offset.top = parseInt (menu.style.top);
                offset.top -= el.offsetHeight + 15;
                setPos (offset);
            }


            me.eventType = e.type;
            el.style.cssText = "display:block;left:-9999px";

            if (e.type == "contextmenu" && hasContextmenu) {
                var menu = domUtils.getElementsByTagName (fixedlayer , "div" , "edui-contextmenu")[0];
                if (menu) {
                    setPosByCxtMenu (menu)
                } else {
                    me.editor.addListener ("aftershowcontextmenu" , function (type , menu) {
                        setPosByCxtMenu (menu);
                    });
                }
            } else {
                offset = uiUtils.getViewportOffsetByEvent (e);
                offset.top -= el.offsetHeight + me.SPACE;
                offset.left += me.SPACE + 20;
                setPos (offset);
                me.setOpacity (el , 0.2);
            }


            me.isHidden = false;
            me.left = e.screenX + el.offsetWidth / 2 - me.SPACE;
            me.top = e.screenY - (el.offsetHeight / 2) - me.SPACE;

            if (me.editor) {
                el.style.zIndex = me.editor.container.style.zIndex * 1 + 10;
                fixedlayer.style.zIndex = el.style.zIndex - 1;
            }
        } ,
        hide : function () {
            if (this.getDom ()) {
                this.getDom ().style.display = "none";
            }
            this.isHidden = true;
        } ,
        postRender : function () {
            if (utils.isArray (this.items)) {
                for (var i = 0, item ; item = this.items[i++] ;) {
                    item.postRender ();
                }
            }
        } ,
        getHtmlTpl : function () {
            var buff;
            if (utils.isArray (this.items)) {
                buff = [];
                for (var i = 0 ; i < this.items.length ; i++) {
                    buff[i] = this.items[i].renderHtml ();
                }
                buff = buff.join ("");
            } else {
                buff = this.items;
            }

            return '<div id="##" class="%% edui-toolbar" data-src="shortcutmenu" onmousedown="return false;" onselectstart="return false;" >' +
                buff +
                '</div>';
        }
    };

    utils.inherits (ShortCutMenu , UIBase);

    function hideAllMenu (e) {
        var tgt = e.target || e.srcElement,
            cur = domUtils.findParent (tgt , function (node) {
                return domUtils.hasClass (node , "edui-shortcutmenu") || domUtils.hasClass (node , "edui-popup");
            } , true);

        if (!cur) {
            for (var i = 0, menu ; menu = allMenus[i++] ;) {
                menu.hide ()
            }
        }
    }

    domUtils.on (document , 'mousedown' , function (e) {
        hideAllMenu (e);
    });

    domUtils.on (window , 'scroll' , function (e) {
        hideAllMenu (e);
    });

}) ();


// ui/breakline.js
(function (){
    var utils = baidu.editor.utils,
        UIBase = baidu.editor.ui.UIBase,
        Breakline = baidu.editor.ui.Breakline = function (options){
            this.initOptions(options);
            this.initSeparator();
        };
    Breakline.prototype = {
        uiName: 'Breakline',
        initSeparator: function (){
            this.initUIBase();
        },
        getHtmlTpl: function (){
            return '<br/>';
        }
    };
    utils.inherits(Breakline, UIBase);

})();


// ui/message.js
///import core
///import uicore
(function () {
    var utils = baidu.editor.utils,
        domUtils = baidu.editor.dom.domUtils,
        UIBase = baidu.editor.ui.UIBase,
        Message = baidu.editor.ui.Message = function (options){
            this.initOptions(options);
            this.initMessage();
        };

    Message.prototype = {
        initMessage: function (){
            this.initUIBase();
        },
        getHtmlTpl: function (){
            return '<div id="##" class="edui-message %%">' +
            ' <div id="##_closer" class="edui-message-closer">×</div>' +
            ' <div id="##_body" class="edui-message-body edui-message-type-info">' +
            ' <iframe style="position:absolute;z-index:-1;left:0;top:0;background-color: transparent;" frameborder="0" width="100%" height="100%" src="about:blank"></iframe>' +
            ' <div class="edui-shadow"></div>' +
            ' <div id="##_content" class="edui-message-content">' +
            '  </div>' +
            ' </div>' +
            '</div>';
        },
        reset: function(opt){
            var me = this;
            if (!opt.keepshow) {
                clearTimeout(this.timer);
                me.timer = setTimeout(function(){
                    me.hide();
                }, opt.timeout || 4000);
            }

            opt.content !== undefined && me.setContent(opt.content);
            opt.type !== undefined && me.setType(opt.type);

            me.show();
        },
        postRender: function(){
            var me = this,
                closer = this.getDom('closer');
            closer && domUtils.on(closer, 'click', function(){
                me.hide();
            });
        },
        setContent: function(content){
            this.getDom('content').innerHTML = content;
        },
        setType: function(type){
            type = type || 'info';
            var body = this.getDom('body');
            body.className = body.className.replace(/edui-message-type-[\w-]+/, 'edui-message-type-' + type);
        },
        getContent: function(){
            return this.getDom('content').innerHTML;
        },
        getType: function(){
            var arr = this.getDom('body').match(/edui-message-type-([\w-]+)/);
            return arr ? arr[1]:'';
        },
        show: function (){
            this.getDom().style.display = 'block';
        },
        hide: function (){
            var dom = this.getDom();
            if (dom) {
                dom.style.display = 'none';
                dom.parentNode && dom.parentNode.removeChild(dom);
            }
        }
    };

    utils.inherits(Message, UIBase);

})();


// adapter/editorui.js
//ui跟编辑器的适配層
//那个按钮弹出是dialog，是下拉筐等都是在这个js中配置
//自己写的ui也要在这里配置，放到baidu.editor.ui下边，当编辑器实例化的时候会根据ueditor.config中的toolbars找到相应的进行实例化
(function () {
    var utils = baidu.editor.utils;
    var editorui = baidu.editor.ui;
    var _Dialog = editorui.Dialog;
    editorui.buttons = {};

    editorui.Dialog = function (options) {
        var dialog = new _Dialog(options);
        dialog.addListener('hide', function () {

            if (dialog.editor) {
                var editor = dialog.editor;
                try {
                    if (browser.gecko) {
                        var y = editor.window.scrollY,
                            x = editor.window.scrollX;
                        editor.body.focus();
                        editor.window.scrollTo(x, y);
                    } else {
                        editor.focus();
                    }


                } catch (ex) {
                }
            }
        });
        return dialog;
    };

    var iframeUrlMap = {
        'anchor':'~/dialogs/anchor/anchor.html',
        'insertimage':'~/dialogs/image/image.html',
        'link':'~/dialogs/link/link.html',
        'spechars':'~/dialogs/spechars/spechars.html',
        'searchreplace':'~/dialogs/searchreplace/searchreplace.html',
        'map':'~/dialogs/map/map.html',
        'gmap':'~/dialogs/gmap/gmap.html',
        'insertvideo':'~/dialogs/video/video.html',
        'help':'~/dialogs/help/help.html',
        'preview':'~/dialogs/preview/preview.html',
        'emotion':'~/dialogs/emotion/emotion.html',
        'wordimage':'~/dialogs/wordimage/wordimage.html',
        'attachment':'~/dialogs/attachment/attachment.html',
        'insertframe':'~/dialogs/insertframe/insertframe.html',
        'edittip':'~/dialogs/table/edittip.html',
        'edittable':'~/dialogs/table/edittable.html',
        'edittd':'~/dialogs/table/edittd.html',
        'webapp':'~/dialogs/webapp/webapp.html',
        'snapscreen':'~/dialogs/snapscreen/snapscreen.html',
        'scrawl':'~/dialogs/scrawl/scrawl.html',
        'music':'~/dialogs/music/music.html',
        'template':'~/dialogs/template/template.html',
        'background':'~/dialogs/background/background.html',
        'charts': '~/dialogs/charts/charts.html'
    };
    //为工具栏添加按钮，以下都是统一的按钮触发命令，所以写在一起
    var btnCmds = ['undo', 'redo', 'formatmatch',
        'bold', 'italic', 'underline', 'fontborder', 'touppercase', 'tolowercase',
        'strikethrough', 'subscript', 'superscript', 'source', 'indent', 'outdent',
        'blockquote', 'pasteplain', 'pagebreak',
        'selectall', 'print','horizontal', 'removeformat', 'time', 'date', 'unlink',
        'insertparagraphbeforetable', 'insertrow', 'insertcol', 'mergeright', 'mergedown', 'deleterow',
        'deletecol', 'splittorows', 'splittocols', 'splittocells', 'mergecells', 'deletetable', 'drafts'];

    for (var i = 0, ci; ci = btnCmds[i++];) {
        ci = ci.toLowerCase();
        editorui[ci] = function (cmd) {
            return function (editor) {
                var ui = new editorui.Button({
                    className:'edui-for-' + cmd,
                    title:editor.options.labelMap[cmd] || editor.getLang("labelMap." + cmd) || '',
                    onclick:function () {
                        editor.execCommand(cmd);
                    },
                    theme:editor.options.theme,
                    showText:false
                });
                editorui.buttons[cmd] = ui;
                editor.addListener('selectionchange', function (type, causeByUi, uiReady) {
                    var state = editor.queryCommandState(cmd);
                    if (state == -1) {
                        ui.setDisabled(true);
                        ui.setChecked(false);
                    } else {
                        if (!uiReady) {
                            ui.setDisabled(false);
                            ui.setChecked(state);
                        }
                    }
                });
                return ui;
            };
        }(ci);
    }

    //清除文档
    editorui.cleardoc = function (editor) {
        var ui = new editorui.Button({
            className:'edui-for-cleardoc',
            title:editor.options.labelMap.cleardoc || editor.getLang("labelMap.cleardoc") || '',
            theme:editor.options.theme,
            onclick:function () {
                if (confirm(editor.getLang("confirmClear"))) {
                    editor.execCommand('cleardoc');
                }
            }
        });
        editorui.buttons["cleardoc"] = ui;
        editor.addListener('selectionchange', function () {
            ui.setDisabled(editor.queryCommandState('cleardoc') == -1);
        });
        return ui;
    };

    //排版，图片排版，文字方向
    var typeset = {
        'justify':['left', 'right', 'center', 'justify'],
        'imagefloat':['none', 'left', 'center', 'right'],
        'directionality':['ltr', 'rtl']
    };

    for (var p in typeset) {

        (function (cmd, val) {
            for (var i = 0, ci; ci = val[i++];) {
                (function (cmd2) {
                    editorui[cmd.replace('float', '') + cmd2] = function (editor) {
                        var ui = new editorui.Button({
                            className:'edui-for-' + cmd.replace('float', '') + cmd2,
                            title:editor.options.labelMap[cmd.replace('float', '') + cmd2] || editor.getLang("labelMap." + cmd.replace('float', '') + cmd2) || '',
                            theme:editor.options.theme,
                            onclick:function () {
                                editor.execCommand(cmd, cmd2);
                            }
                        });
                        editorui.buttons[cmd] = ui;
                        editor.addListener('selectionchange', function (type, causeByUi, uiReady) {
                            ui.setDisabled(editor.queryCommandState(cmd) == -1);
                            ui.setChecked(editor.queryCommandValue(cmd) == cmd2 && !uiReady);
                        });
                        return ui;
                    };
                })(ci)
            }
        })(p, typeset[p])
    }

    //字体颜色和背景颜色
    for (var i = 0, ci; ci = ['backcolor', 'forecolor'][i++];) {
        editorui[ci] = function (cmd) {
            return function (editor) {
                var ui = new editorui.ColorButton({
                    className:'edui-for-' + cmd,
                    color:'default',
                    title:editor.options.labelMap[cmd] || editor.getLang("labelMap." + cmd) || '',
                    editor:editor,
                    onpickcolor:function (t, color) {
                        editor.execCommand(cmd, color);
                    },
                    onpicknocolor:function () {
                        editor.execCommand(cmd, 'default');
                        this.setColor('transparent');
                        this.color = 'default';
                    },
                    onbuttonclick:function () {
                        editor.execCommand(cmd, this.color);
                    }
                });
                editorui.buttons[cmd] = ui;
                editor.addListener('selectionchange', function () {
                    ui.setDisabled(editor.queryCommandState(cmd) == -1);
                });
                return ui;
            };
        }(ci);
    }


    var dialogBtns = {
        noOk:['searchreplace', 'help', 'spechars', 'webapp','preview'],
        ok:['attachment', 'anchor', 'link', 'insertimage', 'map', 'gmap', 'insertframe', 'wordimage',
            'insertvideo', 'insertframe', 'edittip', 'edittable', 'edittd', 'scrawl', 'template', 'music', 'background', 'charts']
    };

    for (var p in dialogBtns) {
        (function (type, vals) {
            for (var i = 0, ci; ci = vals[i++];) {
                //todo opera下存在问题
                if (browser.opera && ci === "searchreplace") {
                    continue;
                }
                (function (cmd) {
                    editorui[cmd] = function (editor, iframeUrl, title) {
                        iframeUrl = iframeUrl || (editor.options.iframeUrlMap || {})[cmd] || iframeUrlMap[cmd];
                        title = editor.options.labelMap[cmd] || editor.getLang("labelMap." + cmd) || '';

                        var dialog;
                        //没有iframeUrl不创建dialog
                        if (iframeUrl) {
                            dialog = new editorui.Dialog(utils.extend({
                                iframeUrl:editor.ui.mapUrl(iframeUrl),
                                editor:editor,
                                className:'edui-for-' + cmd,
                                title:title,
                                holdScroll: cmd === 'insertimage',
                                fullscreen: /charts|preview/.test(cmd),
                                closeDialog:editor.getLang("closeDialog")
                            }, type == 'ok' ? {
                                buttons:[
                                    {
                                        className:'edui-okbutton',
                                        label:editor.getLang("ok"),
                                        editor:editor,
                                        onclick:function () {
                                            dialog.close(true);
                                        }
                                    },
                                    {
                                        className:'edui-cancelbutton',
                                        label:editor.getLang("cancel"),
                                        editor:editor,
                                        onclick:function () {
                                            dialog.close(false);
                                        }
                                    }
                                ]
                            } : {}));

                            editor.ui._dialogs[cmd + "Dialog"] = dialog;
                        }

                        var ui = new editorui.Button({
                            className:'edui-for-' + cmd,
                            title:title,
                            onclick:function () {
                                if (dialog) {
                                    switch (cmd) {
                                        case "wordimage":
                                            var images = editor.execCommand("wordimage");
                                            if (images && images.length) {
                                                dialog.render();
                                                dialog.open();
                                            }
                                            break;
                                        case "scrawl":
                                            if (editor.queryCommandState("scrawl") != -1) {
                                                dialog.render();
                                                dialog.open();
                                            }

                                            break;
                                        default:
                                            dialog.render();
                                            dialog.open();
                                    }
                                }
                            },
                            theme:editor.options.theme,
                            disabled:(cmd == 'scrawl' && editor.queryCommandState("scrawl") == -1) || ( cmd == 'charts' )
                        });
                        editorui.buttons[cmd] = ui;
                        editor.addListener('selectionchange', function () {
                            //只存在于右键菜单而无工具栏按钮的ui不需要检测状态
                            var unNeedCheckState = {'edittable':1};
                            if (cmd in unNeedCheckState)return;

                            var state = editor.queryCommandState(cmd);
                            if (ui.getDom()) {
                                ui.setDisabled(state == -1);
                                ui.setChecked(state);
                            }

                        });

                        return ui;
                    };
                })(ci.toLowerCase())
            }
        })(p, dialogBtns[p]);
    }

    editorui.snapscreen = function (editor, iframeUrl, title) {
        title = editor.options.labelMap['snapscreen'] || editor.getLang("labelMap.snapscreen") || '';
        var ui = new editorui.Button({
            className:'edui-for-snapscreen',
            title:title,
            onclick:function () {
                editor.execCommand("snapscreen");
            },
            theme:editor.options.theme

        });
        editorui.buttons['snapscreen'] = ui;
        iframeUrl = iframeUrl || (editor.options.iframeUrlMap || {})["snapscreen"] || iframeUrlMap["snapscreen"];
        if (iframeUrl) {
            var dialog = new editorui.Dialog({
                iframeUrl:editor.ui.mapUrl(iframeUrl),
                editor:editor,
                className:'edui-for-snapscreen',
                title:title,
                buttons:[
                    {
                        className:'edui-okbutton',
                        label:editor.getLang("ok"),
                        editor:editor,
                        onclick:function () {
                            dialog.close(true);
                        }
                    },
                    {
                        className:'edui-cancelbutton',
                        label:editor.getLang("cancel"),
                        editor:editor,
                        onclick:function () {
                            dialog.close(false);
                        }
                    }
                ]

            });
            dialog.render();
            editor.ui._dialogs["snapscreenDialog"] = dialog;
        }
        editor.addListener('selectionchange', function () {
            ui.setDisabled(editor.queryCommandState('snapscreen') == -1);
        });
        return ui;
    };

    editorui.insertcode = function (editor, list, title) {
        list = editor.options['insertcode'] || [];
        title = editor.options.labelMap['insertcode'] || editor.getLang("labelMap.insertcode") || '';
       // if (!list.length) return;
        var items = [];
        utils.each(list,function(key,val){
            items.push({
                label:key,
                value:val,
                theme:editor.options.theme,
                renderLabelHtml:function () {
                    return '<div class="edui-label %%-label" >' + (this.label || '') + '</div>';
                }
            });
        });

        var ui = new editorui.Combox({
            editor:editor,
            items:items,
            onselect:function (t, index) {
                editor.execCommand('insertcode', this.items[index].value);
            },
            onbuttonclick:function () {
                this.showPopup();
            },
            title:title,
            initValue:title,
            className:'edui-for-insertcode',
            indexByValue:function (value) {
                if (value) {
                    for (var i = 0, ci; ci = this.items[i]; i++) {
                        if (ci.value.indexOf(value) != -1)
                            return i;
                    }
                }

                return -1;
            }
        });
        editorui.buttons['insertcode'] = ui;
        editor.addListener('selectionchange', function (type, causeByUi, uiReady) {
            if (!uiReady) {
                var state = editor.queryCommandState('insertcode');
                if (state == -1) {
                    ui.setDisabled(true);
                } else {
                    ui.setDisabled(false);
                    var value = editor.queryCommandValue('insertcode');
                    if(!value){
                        ui.setValue(title);
                        return;
                    }
                    //trace:1871 ie下从源码模式切换回来时，字体会带单引号，而且会有逗号
                    value && (value = value.replace(/['"]/g, '').split(',')[0]);
                    ui.setValue(value);

                }
            }

        });
        return ui;
    };
    editorui.fontfamily = function (editor, list, title) {

        list = editor.options['fontfamily'] || [];
        title = editor.options.labelMap['fontfamily'] || editor.getLang("labelMap.fontfamily") || '';
        if (!list.length) return;
        for (var i = 0, ci, items = []; ci = list[i]; i++) {
            var langLabel = editor.getLang('fontfamily')[ci.name] || "";
            (function (key, val) {
                items.push({
                    label:key,
                    value:val,
                    theme:editor.options.theme,
                    renderLabelHtml:function () {
                        return '<div class="edui-label %%-label" style="font-family:' +
                            utils.unhtml(this.value) + '">' + (this.label || '') + '</div>';
                    }
                });
            })(ci.label || langLabel, ci.val)
        }
        var ui = new editorui.Combox({
            editor:editor,
            items:items,
            onselect:function (t, index) {
                editor.execCommand('FontFamily', this.items[index].value);
            },
            onbuttonclick:function () {
                this.showPopup();
            },
            title:title,
            initValue:title,
            className:'edui-for-fontfamily',
            indexByValue:function (value) {
                if (value) {
                    for (var i = 0, ci; ci = this.items[i]; i++) {
                        if (ci.value.indexOf(value) != -1)
                            return i;
                    }
                }

                return -1;
            }
        });
        editorui.buttons['fontfamily'] = ui;
        editor.addListener('selectionchange', function (type, causeByUi, uiReady) {
            if (!uiReady) {
                var state = editor.queryCommandState('FontFamily');
                if (state == -1) {
                    ui.setDisabled(true);
                } else {
                    ui.setDisabled(false);
                    var value = editor.queryCommandValue('FontFamily');
                    //trace:1871 ie下从源码模式切换回来时，字体会带单引号，而且会有逗号
                    value && (value = value.replace(/['"]/g, '').split(',')[0]);
                    ui.setValue(value);

                }
            }

        });
        return ui;
    };

    editorui.fontsize = function (editor, list, title) {
        title = editor.options.labelMap['fontsize'] || editor.getLang("labelMap.fontsize") || '';
        list = list || editor.options['fontsize'] || [];
        if (!list.length) return;
        var items = [];
        for (var i = 0; i < list.length; i++) {
            var size = list[i] + 'px';
            items.push({
                label:size,
                value:size,
                theme:editor.options.theme,
                renderLabelHtml:function () {
                    return '<div class="edui-label %%-label" style="line-height:1;font-size:' +
                        this.value + '">' + (this.label || '') + '</div>';
                }
            });
        }
        var ui = new editorui.Combox({
            editor:editor,
            items:items,
            title:title,
            initValue:title,
            onselect:function (t, index) {
                editor.execCommand('FontSize', this.items[index].value);
            },
            onbuttonclick:function () {
                this.showPopup();
            },
            className:'edui-for-fontsize'
        });
        editorui.buttons['fontsize'] = ui;
        editor.addListener('selectionchange', function (type, causeByUi, uiReady) {
            if (!uiReady) {
                var state = editor.queryCommandState('FontSize');
                if (state == -1) {
                    ui.setDisabled(true);
                } else {
                    ui.setDisabled(false);
                    ui.setValue(editor.queryCommandValue('FontSize'));
                }
            }

        });
        return ui;
    };

    editorui.paragraph = function (editor, list, title) {
        title = editor.options.labelMap['paragraph'] || editor.getLang("labelMap.paragraph") || '';
        list = editor.options['paragraph'] || [];
        if (utils.isEmptyObject(list)) return;
        var items = [];
        for (var i in list) {
            items.push({
                value:i,
                label:list[i] || editor.getLang("paragraph")[i],
                theme:editor.options.theme,
                renderLabelHtml:function () {
                    return '<div class="edui-label %%-label"><span class="edui-for-' + this.value + '">' + (this.label || '') + '</span></div>';
                }
            })
        }
        var ui = new editorui.Combox({
            editor:editor,
            items:items,
            title:title,
            initValue:title,
            className:'edui-for-paragraph',
            onselect:function (t, index) {
                editor.execCommand('Paragraph', this.items[index].value);
            },
            onbuttonclick:function () {
                this.showPopup();
            }
        });
        editorui.buttons['paragraph'] = ui;
        editor.addListener('selectionchange', function (type, causeByUi, uiReady) {
            if (!uiReady) {
                var state = editor.queryCommandState('Paragraph');
                if (state == -1) {
                    ui.setDisabled(true);
                } else {
                    ui.setDisabled(false);
                    var value = editor.queryCommandValue('Paragraph');
                    var index = ui.indexByValue(value);
                    if (index != -1) {
                        ui.setValue(value);
                    } else {
                        ui.setValue(ui.initValue);
                    }
                }
            }

        });
        return ui;
    };


    //自定义标题
    editorui.customstyle = function (editor) {
        var list = editor.options['customstyle'] || [],
            title = editor.options.labelMap['customstyle'] || editor.getLang("labelMap.customstyle") || '';
        if (!list.length)return;
        var langCs = editor.getLang('customstyle');
        for (var i = 0, items = [], t; t = list[i++];) {
            (function (t) {
                var ck = {};
                ck.label = t.label ? t.label : langCs[t.name];
                ck.style = t.style;
                ck.className = t.className;
                ck.tag = t.tag;
                items.push({
                    label:ck.label,
                    value:ck,
                    theme:editor.options.theme,
                    renderLabelHtml:function () {
                        return '<div class="edui-label %%-label">' + '<' + ck.tag + ' ' + (ck.className ? ' class="' + ck.className + '"' : "")
                            + (ck.style ? ' style="' + ck.style + '"' : "") + '>' + ck.label + "<\/" + ck.tag + ">"
                            + '</div>';
                    }
                });
            })(t);
        }

        var ui = new editorui.Combox({
            editor:editor,
            items:items,
            title:title,
            initValue:title,
            className:'edui-for-customstyle',
            onselect:function (t, index) {
                editor.execCommand('customstyle', this.items[index].value);
            },
            onbuttonclick:function () {
                this.showPopup();
            },
            indexByValue:function (value) {
                for (var i = 0, ti; ti = this.items[i++];) {
                    if (ti.label == value) {
                        return i - 1
                    }
                }
                return -1;
            }
        });
        editorui.buttons['customstyle'] = ui;
        editor.addListener('selectionchange', function (type, causeByUi, uiReady) {
            if (!uiReady) {
                var state = editor.queryCommandState('customstyle');
                if (state == -1) {
                    ui.setDisabled(true);
                } else {
                    ui.setDisabled(false);
                    var value = editor.queryCommandValue('customstyle');
                    var index = ui.indexByValue(value);
                    if (index != -1) {
                        ui.setValue(value);
                    } else {
                        ui.setValue(ui.initValue);
                    }
                }
            }

        });
        return ui;
    };
    editorui.inserttable = function (editor, iframeUrl, title) {
        title = editor.options.labelMap['inserttable'] || editor.getLang("labelMap.inserttable") || '';
        var ui = new editorui.TableButton({
            editor:editor,
            title:title,
            className:'edui-for-inserttable',
            onpicktable:function (t, numCols, numRows) {
                editor.execCommand('InsertTable', {numRows:numRows, numCols:numCols, border:1});
            },
            onbuttonclick:function () {
                this.showPopup();
            }
        });
        editorui.buttons['inserttable'] = ui;
        editor.addListener('selectionchange', function () {
            ui.setDisabled(editor.queryCommandState('inserttable') == -1);
        });
        return ui;
    };

    editorui.lineheight = function (editor) {
        var val = editor.options.lineheight || [];
        if (!val.length)return;
        for (var i = 0, ci, items = []; ci = val[i++];) {
            items.push({
                //todo:写死了
                label:ci,
                value:ci,
                theme:editor.options.theme,
                onclick:function () {
                    editor.execCommand("lineheight", this.value);
                }
            })
        }
        var ui = new editorui.MenuButton({
            editor:editor,
            className:'edui-for-lineheight',
            title:editor.options.labelMap['lineheight'] || editor.getLang("labelMap.lineheight") || '',
            items:items,
            onbuttonclick:function () {
                var value = editor.queryCommandValue('LineHeight') || this.value;
                editor.execCommand("LineHeight", value);
            }
        });
        editorui.buttons['lineheight'] = ui;
        editor.addListener('selectionchange', function () {
            var state = editor.queryCommandState('LineHeight');
            if (state == -1) {
                ui.setDisabled(true);
            } else {
                ui.setDisabled(false);
                var value = editor.queryCommandValue('LineHeight');
                value && ui.setValue((value + '').replace(/cm/, ''));
                ui.setChecked(state)
            }
        });
        return ui;
    };

    var rowspacings = ['top', 'bottom'];
    for (var r = 0, ri; ri = rowspacings[r++];) {
        (function (cmd) {
            editorui['rowspacing' + cmd] = function (editor) {
                var val = editor.options['rowspacing' + cmd] || [];
                if (!val.length) return null;
                for (var i = 0, ci, items = []; ci = val[i++];) {
                    items.push({
                        label:ci,
                        value:ci,
                        theme:editor.options.theme,
                        onclick:function () {
                            editor.execCommand("rowspacing", this.value, cmd);
                        }
                    })
                }
                var ui = new editorui.MenuButton({
                    editor:editor,
                    className:'edui-for-rowspacing' + cmd,
                    title:editor.options.labelMap['rowspacing' + cmd] || editor.getLang("labelMap.rowspacing" + cmd) || '',
                    items:items,
                    onbuttonclick:function () {
                        var value = editor.queryCommandValue('rowspacing', cmd) || this.value;
                        editor.execCommand("rowspacing", value, cmd);
                    }
                });
                editorui.buttons[cmd] = ui;
                editor.addListener('selectionchange', function () {
                    var state = editor.queryCommandState('rowspacing', cmd);
                    if (state == -1) {
                        ui.setDisabled(true);
                    } else {
                        ui.setDisabled(false);
                        var value = editor.queryCommandValue('rowspacing', cmd);
                        value && ui.setValue((value + '').replace(/%/, ''));
                        ui.setChecked(state)
                    }
                });
                return ui;
            }
        })(ri)
    }
    //有序，无序列表
    var lists = ['insertorderedlist', 'insertunorderedlist'];
    for (var l = 0, cl; cl = lists[l++];) {
        (function (cmd) {
            editorui[cmd] = function (editor) {
                var vals = editor.options[cmd],
                    _onMenuClick = function () {
                        editor.execCommand(cmd, this.value);
                    }, items = [];
                for (var i in vals) {
                    items.push({
                        label:vals[i] || editor.getLang()[cmd][i] || "",
                        value:i,
                        theme:editor.options.theme,
                        onclick:_onMenuClick
                    })
                }
                var ui = new editorui.MenuButton({
                    editor:editor,
                    className:'edui-for-' + cmd,
                    title:editor.getLang("labelMap." + cmd) || '',
                    'items':items,
                    onbuttonclick:function () {
                        var value = editor.queryCommandValue(cmd) || this.value;
                        editor.execCommand(cmd, value);
                    }
                });
                editorui.buttons[cmd] = ui;
                editor.addListener('selectionchange', function () {
                    var state = editor.queryCommandState(cmd);
                    if (state == -1) {
                        ui.setDisabled(true);
                    } else {
                        ui.setDisabled(false);
                        var value = editor.queryCommandValue(cmd);
                        ui.setValue(value);
                        ui.setChecked(state)
                    }
                });
                return ui;
            };
        })(cl)
    }

    editorui.fullscreen = function (editor, title) {
        title = editor.options.labelMap['fullscreen'] || editor.getLang("labelMap.fullscreen") || '';
        var ui = new editorui.Button({
            className:'edui-for-fullscreen',
            title:title,
            theme:editor.options.theme,
            onclick:function () {
                if (editor.ui) {
                    editor.ui.setFullScreen(!editor.ui.isFullScreen());
                }
                this.setChecked(editor.ui.isFullScreen());
            }
        });
        editorui.buttons['fullscreen'] = ui;
        editor.addListener('selectionchange', function () {
            var state = editor.queryCommandState('fullscreen');
            ui.setDisabled(state == -1);
            ui.setChecked(editor.ui.isFullScreen());
        });
        return ui;
    };

    // 表情
    editorui["emotion"] = function (editor, iframeUrl) {
        var cmd = "emotion";
        var ui = new editorui.MultiMenuPop({
            title:editor.options.labelMap[cmd] || editor.getLang("labelMap." + cmd + "") || '',
            editor:editor,
            className:'edui-for-' + cmd,
            iframeUrl:editor.ui.mapUrl(iframeUrl || (editor.options.iframeUrlMap || {})[cmd] || iframeUrlMap[cmd])
        });
        editorui.buttons[cmd] = ui;

        editor.addListener('selectionchange', function () {
            ui.setDisabled(editor.queryCommandState(cmd) == -1)
        });
        return ui;
    };

    editorui.autotypeset = function (editor) {
        var ui = new editorui.AutoTypeSetButton({
            editor:editor,
            title:editor.options.labelMap['autotypeset'] || editor.getLang("labelMap.autotypeset") || '',
            className:'edui-for-autotypeset',
            onbuttonclick:function () {
                editor.execCommand('autotypeset')
            }
        });
        editorui.buttons['autotypeset'] = ui;
        editor.addListener('selectionchange', function () {
            ui.setDisabled(editor.queryCommandState('autotypeset') == -1);
        });
        return ui;
    };

    /* 简单上传插件 */
    editorui["simpleupload"] = function (editor) {
        var name = 'simpleupload',
            ui = new editorui.Button({
                className:'edui-for-' + name,
                title:editor.options.labelMap[name] || editor.getLang("labelMap." + name) || '',
                onclick:function () {},
                theme:editor.options.theme,
                showText:false
            });
        editorui.buttons[name] = ui;
        editor.addListener('ready', function() {
            var b = ui.getDom('body'),
                iconSpan = b.children[0];
            editor.fireEvent('simpleuploadbtnready', iconSpan);
        });
        editor.addListener('selectionchange', function (type, causeByUi, uiReady) {
            var state = editor.queryCommandState(name);
            if (state == -1) {
                ui.setDisabled(true);
                ui.setChecked(false);
            } else {
                if (!uiReady) {
                    ui.setDisabled(false);
                    ui.setChecked(state);
                }
            }
        });
        return ui;
    };

})();


// adapter/editor.js
///import core
///commands 全屏
///commandsName FullScreen
///commandsTitle  全屏
(function () {
    var utils = baidu.editor.utils,
        uiUtils = baidu.editor.ui.uiUtils,
        UIBase = baidu.editor.ui.UIBase,
        domUtils = baidu.editor.dom.domUtils;
    var nodeStack = [];

    function EditorUI(options) {
        this.initOptions(options);
        this.initEditorUI();
    }

    EditorUI.prototype = {
        uiName:'editor',
        initEditorUI:function () {
            this.editor.ui = this;
            this._dialogs = {};
            this.initUIBase();
            this._initToolbars();
            var editor = this.editor,
                me = this;

            editor.addListener('ready', function () {
                //提供getDialog方法
                editor.getDialog = function (name) {
                    return editor.ui._dialogs[name + "Dialog"];
                };
                domUtils.on(editor.window, 'scroll', function (evt) {
                    baidu.editor.ui.Popup.postHide(evt);
                });
                //提供编辑器实时宽高(全屏时宽高不变化)
                editor.ui._actualFrameWidth = editor.options.initialFrameWidth;

                UE.browser.ie && UE.browser.version === 6 && editor.container.ownerDocument.execCommand("BackgroundImageCache", false, true);

                //display bottom-bar label based on config
                if (editor.options.elementPathEnabled) {
                    editor.ui.getDom('elementpath').innerHTML = '<div class="edui-editor-breadcrumb">' + editor.getLang("elementPathTip") + ':</div>';
                }
                if (editor.options.wordCount) {
                    function countFn() {
                        setCount(editor,me);
                        domUtils.un(editor.document, "click", arguments.callee);
                    }
                    domUtils.on(editor.document, "click", countFn);
                    editor.ui.getDom('wordcount').innerHTML = editor.getLang("wordCountTip");
                }
                editor.ui._scale();
                if (editor.options.scaleEnabled) {
                    if (editor.autoHeightEnabled) {
                        editor.disableAutoHeight();
                    }
                    me.enableScale();
                } else {
                    me.disableScale();
                }
                if (!editor.options.elementPathEnabled && !editor.options.wordCount && !editor.options.scaleEnabled) {
                    editor.ui.getDom('elementpath').style.display = "none";
                    editor.ui.getDom('wordcount').style.display = "none";
                    editor.ui.getDom('scale').style.display = "none";
                }

                if (!editor.selection.isFocus())return;
                editor.fireEvent('selectionchange', false, true);


            });

            editor.addListener('mousedown', function (t, evt) {
                var el = evt.target || evt.srcElement;
                baidu.editor.ui.Popup.postHide(evt, el);
                baidu.editor.ui.ShortCutMenu.postHide(evt);

            });
            editor.addListener("delcells", function () {
                if (UE.ui['edittip']) {
                    new UE.ui['edittip'](editor);
                }
                editor.getDialog('edittip').open();
            });

            var pastePop, isPaste = false, timer;
            editor.addListener("afterpaste", function () {
                if(editor.queryCommandState('pasteplain'))
                    return;
                if(baidu.editor.ui.PastePicker){
                    pastePop = new baidu.editor.ui.Popup({
                        content:new baidu.editor.ui.PastePicker({editor:editor}),
                        editor:editor,
                        className:'edui-wordpastepop'
                    });
                    pastePop.render();
                }
                isPaste = true;
            });

            editor.addListener("afterinserthtml", function () {
                clearTimeout(timer);
                timer = setTimeout(function () {
                    if (pastePop && (isPaste || editor.ui._isTransfer)) {
                        if(pastePop.isHidden()){
                            var span = domUtils.createElement(editor.document, 'span', {
                                    'style':"line-height:0px;",
                                    'innerHTML':'\ufeff'
                                }),
                                range = editor.selection.getRange();
                            range.insertNode(span);
                            var tmp= getDomNode(span, 'firstChild', 'previousSibling');
                            tmp && pastePop.showAnchor(tmp.nodeType == 3 ? tmp.parentNode : tmp);
                            domUtils.remove(span);
                        }else{
                            pastePop.show();
                        }
                        delete editor.ui._isTransfer;
                        isPaste = false;
                    }
                }, 200)
            });
            editor.addListener('contextmenu', function (t, evt) {
                baidu.editor.ui.Popup.postHide(evt);
            });
            editor.addListener('keydown', function (t, evt) {
                if (pastePop)    pastePop.dispose(evt);
                var keyCode = evt.keyCode || evt.which;
                if(evt.altKey&&keyCode==90){
                    UE.ui.buttons['fullscreen'].onclick();
                }
            });
            editor.addListener('wordcount', function (type) {
                setCount(this,me);
            });
            function setCount(editor,ui) {
                editor.setOpt({
                    wordCount:true,
                    maximumWords:10000,
                    wordCountMsg:editor.options.wordCountMsg || editor.getLang("wordCountMsg"),
                    wordOverFlowMsg:editor.options.wordOverFlowMsg || editor.getLang("wordOverFlowMsg")
                });
                var opt = editor.options,
                    max = opt.maximumWords,
                    msg = opt.wordCountMsg ,
                    errMsg = opt.wordOverFlowMsg,
                    countDom = ui.getDom('wordcount');
                if (!opt.wordCount) {
                    return;
                }
                var count = editor.getContentLength(true);
                if (count > max) {
                    countDom.innerHTML = errMsg;
                    editor.fireEvent("wordcountoverflow");
                } else {
                    countDom.innerHTML = msg.replace("{#leave}", max - count).replace("{#count}", count);
                }
            }

            editor.addListener('selectionchange', function () {
                if (editor.options.elementPathEnabled) {
                    me[(editor.queryCommandState('elementpath') == -1 ? 'dis' : 'en') + 'ableElementPath']()
                }
                if (editor.options.scaleEnabled) {
                    me[(editor.queryCommandState('scale') == -1 ? 'dis' : 'en') + 'ableScale']();

                }
            });
            var popup = new baidu.editor.ui.Popup({
                editor:editor,
                content:'',
                className:'edui-bubble',
                _onEditButtonClick:function () {
                    this.hide();
                    editor.ui._dialogs.linkDialog.open();
                },
                _onImgEditButtonClick:function (name) {
                    this.hide();
                    editor.ui._dialogs[name] && editor.ui._dialogs[name].open();

                },
                _onImgSetFloat:function (value) {
                    this.hide();
                    editor.execCommand("imagefloat", value);

                },
                _setIframeAlign:function (value) {
                    var frame = popup.anchorEl;
                    var newFrame = frame.cloneNode(true);
                    switch (value) {
                        case -2:
                            newFrame.setAttribute("align", "");
                            break;
                        case -1:
                            newFrame.setAttribute("align", "left");
                            break;
                        case 1:
                            newFrame.setAttribute("align", "right");
                            break;
                    }
                    frame.parentNode.insertBefore(newFrame, frame);
                    domUtils.remove(frame);
                    popup.anchorEl = newFrame;
                    popup.showAnchor(popup.anchorEl);
                },
                _updateIframe:function () {
                    var frame = editor._iframe = popup.anchorEl;
                    if(domUtils.hasClass(frame, 'ueditor_baidumap')) {
                        editor.selection.getRange().selectNode(frame).select();
                        editor.ui._dialogs.mapDialog.open();
                        popup.hide();
                    } else {
                        editor.ui._dialogs.insertframeDialog.open();
                        popup.hide();
                    }
                },
                _onRemoveButtonClick:function (cmdName) {
                    editor.execCommand(cmdName);
                    this.hide();
                },
                queryAutoHide:function (el) {
                    if (el && el.ownerDocument == editor.document) {
                        if (el.tagName.toLowerCase() == 'img' || domUtils.findParentByTagName(el, 'a', true)) {
                            return el !== popup.anchorEl;
                        }
                    }
                    return baidu.editor.ui.Popup.prototype.queryAutoHide.call(this, el);
                }
            });
            popup.render();
            if (editor.options.imagePopup) {
                editor.addListener('mouseover', function (t, evt) {
                    evt = evt || window.event;
                    var el = evt.target || evt.srcElement;
                    if (editor.ui._dialogs.insertframeDialog && /iframe/ig.test(el.tagName)) {
                        var html = popup.formatHtml(
                            '<nobr>' + editor.getLang("property") + ': <span onclick=$$._setIframeAlign(-2) class="edui-clickable">' + editor.getLang("default") + '</span>&nbsp;&nbsp;<span onclick=$$._setIframeAlign(-1) class="edui-clickable">' + editor.getLang("justifyleft") + '</span>&nbsp;&nbsp;<span onclick=$$._setIframeAlign(1) class="edui-clickable">' + editor.getLang("justifyright") + '</span>&nbsp;&nbsp;' +
                                ' <span onclick="$$._updateIframe( this);" class="edui-clickable">' + editor.getLang("modify") + '</span></nobr>');
                        if (html) {
                            popup.getDom('content').innerHTML = html;
                            popup.anchorEl = el;
                            popup.showAnchor(popup.anchorEl);
                        } else {
                            popup.hide();
                        }
                    }
                });
                editor.addListener('selectionchange', function (t, causeByUi) {
                    if (!causeByUi) return;
                    var html = '', str = "",
                        img = editor.selection.getRange().getClosedNode(),
                        dialogs = editor.ui._dialogs;
                    if (img && img.tagName == 'IMG') {
                        var dialogName = 'insertimageDialog';
                        if (img.className.indexOf("edui-faked-video") != -1 || img.className.indexOf("edui-upload-video") != -1) {
                            dialogName = "insertvideoDialog"
                        }
                        if (img.className.indexOf("edui-faked-webapp") != -1) {
                            dialogName = "webappDialog"
                        }
                        if (img.src.indexOf("http://api.map.baidu.com") != -1) {
                            dialogName = "mapDialog"
                        }
                        if (img.className.indexOf("edui-faked-music") != -1) {
                            dialogName = "musicDialog"
                        }
                        if (img.src.indexOf("http://maps.google.com/maps/api/staticmap") != -1) {
                            dialogName = "gmapDialog"
                        }
                        if (img.getAttribute("anchorname")) {
                            dialogName = "anchorDialog";
                            html = popup.formatHtml(
                                '<nobr>' + editor.getLang("property") + ': <span onclick=$$._onImgEditButtonClick("anchorDialog") class="edui-clickable">' + editor.getLang("modify") + '</span>&nbsp;&nbsp;' +
                                    '<span onclick=$$._onRemoveButtonClick(\'anchor\') class="edui-clickable">' + editor.getLang("delete") + '</span></nobr>');
                        }
                        if (img.getAttribute("word_img")) {
                            //todo 放到dialog去做查询
                            editor.word_img = [img.getAttribute("word_img")];
                            dialogName = "wordimageDialog"
                        }
                        if(domUtils.hasClass(img, 'loadingclass') || domUtils.hasClass(img, 'loaderrorclass')) {
                            dialogName = "";
                        }
                        if (!dialogs[dialogName]) {
                            return;
                        }
                        str = '<nobr>' + editor.getLang("property") + ': '+
                            '<span onclick=$$._onImgSetFloat("none") class="edui-clickable">' + editor.getLang("default") + '</span>&nbsp;&nbsp;' +
                            '<span onclick=$$._onImgSetFloat("left") class="edui-clickable">' + editor.getLang("justifyleft") + '</span>&nbsp;&nbsp;' +
                            '<span onclick=$$._onImgSetFloat("right") class="edui-clickable">' + editor.getLang("justifyright") + '</span>&nbsp;&nbsp;' +
                            '<span onclick=$$._onImgSetFloat("center") class="edui-clickable">' + editor.getLang("justifycenter") + '</span>&nbsp;&nbsp;'+
                            '<span onclick="$$._onImgEditButtonClick(\'' + dialogName + '\');" class="edui-clickable">' + editor.getLang("modify") + '</span></nobr>';

                        !html && (html = popup.formatHtml(str))

                    }
                    if (editor.ui._dialogs.linkDialog) {
                        var link = editor.queryCommandValue('link');
                        var url;
                        if (link && (url = (link.getAttribute('_href') || link.getAttribute('href', 2)))) {
                            var txt = url;
                            if (url.length > 30) {
                                txt = url.substring(0, 20) + "...";
                            }
                            if (html) {
                                html += '<div style="height:5px;"></div>'
                            }
                            html += popup.formatHtml(
                                '<nobr>' + editor.getLang("anthorMsg") + ': <a target="_blank" href="' + url + '" title="' + url + '" >' + txt + '</a>' +
                                    ' <span class="edui-clickable" onclick="$$._onEditButtonClick();">' + editor.getLang("modify") + '</span>' +
                                    ' <span class="edui-clickable" onclick="$$._onRemoveButtonClick(\'unlink\');"> ' + editor.getLang("clear") + '</span></nobr>');
                            popup.showAnchor(link);
                        }
                    }

                    if (html) {
                        popup.getDom('content').innerHTML = html;
                        popup.anchorEl = img || link;
                        popup.showAnchor(popup.anchorEl);
                    } else {
                        popup.hide();
                    }
                });
            }

        },
        _initToolbars:function () {
            var editor = this.editor;
            var toolbars = this.toolbars || [];
            var toolbarUis = [];
            for (var i = 0; i < toolbars.length; i++) {
                var toolbar = toolbars[i];
                var toolbarUi = new baidu.editor.ui.Toolbar({theme:editor.options.theme});
                for (var j = 0; j < toolbar.length; j++) {
                    var toolbarItem = toolbar[j];
                    var toolbarItemUi = null;
                    if (typeof toolbarItem == 'string') {
                        toolbarItem = toolbarItem.toLowerCase();
                        if (toolbarItem == '|') {
                            toolbarItem = 'Separator';
                        }
                        if(toolbarItem == '||'){
                            toolbarItem = 'Breakline';
                        }
                        if (baidu.editor.ui[toolbarItem]) {
                            toolbarItemUi = new baidu.editor.ui[toolbarItem](editor);
                        }

                        //fullscreen这里单独处理一下，放到首行去
                        if (toolbarItem == 'fullscreen') {
                            if (toolbarUis && toolbarUis[0]) {
                                toolbarUis[0].items.splice(0, 0, toolbarItemUi);
                            } else {
                                toolbarItemUi && toolbarUi.items.splice(0, 0, toolbarItemUi);
                            }

                            continue;


                        }
                    } else {
                        toolbarItemUi = toolbarItem;
                    }
                    if (toolbarItemUi && toolbarItemUi.id) {

                        toolbarUi.add(toolbarItemUi);
                    }
                }
                toolbarUis[i] = toolbarUi;
            }

            //接受外部定制的UI

            utils.each(UE._customizeUI,function(obj,key){
                var itemUI,index;
                if(obj.id && obj.id != editor.key){
                   return false;
                }
                itemUI = obj.execFn.call(editor,editor,key);
                if(itemUI){
                    index = obj.index;
                    if(index === undefined){
                        index = toolbarUi.items.length;
                    }
                    toolbarUi.add(itemUI,index)
                }
            });

            this.toolbars = toolbarUis;
        },
        getHtmlTpl:function () {
            return '<div id="##" class="%%">' +
                '<div id="##_toolbarbox" class="%%-toolbarbox">' +
                (this.toolbars.length ?
                    '<div id="##_toolbarboxouter" class="%%-toolbarboxouter"><div class="%%-toolbarboxinner">' +
                        this.renderToolbarBoxHtml() +
                        '</div></div>' : '') +
                '<div id="##_toolbarmsg" class="%%-toolbarmsg" style="display:none;">' +
                '<div id = "##_upload_dialog" class="%%-toolbarmsg-upload" onclick="$$.showWordImageDialog();">' + this.editor.getLang("clickToUpload") + '</div>' +
                '<div class="%%-toolbarmsg-close" onclick="$$.hideToolbarMsg();">x</div>' +
                '<div id="##_toolbarmsg_label" class="%%-toolbarmsg-label"></div>' +
                '<div style="height:0;overflow:hidden;clear:both;"></div>' +
                '</div>' +
                '<div id="##_message_holder" class="%%-messageholder"></div>' +
                '</div>' +
                '<div id="##_iframeholder" class="%%-iframeholder">' +
                '</div>' +
                //modify wdcount by matao
                '<div id="##_bottombar" class="%%-bottomContainer"><table><tr>' +
                '<td id="##_elementpath" class="%%-bottombar"></td>' +
                '<td id="##_wordcount" class="%%-wordcount"></td>' +
                '<td id="##_scale" class="%%-scale"><div class="%%-icon"></div></td>' +
                '</tr></table></div>' +
                '<div id="##_scalelayer"></div>' +
                '</div>';
        },
        showWordImageDialog:function () {
            this._dialogs['wordimageDialog'].open();
        },
        renderToolbarBoxHtml:function () {
            var buff = [];
            for (var i = 0; i < this.toolbars.length; i++) {
                buff.push(this.toolbars[i].renderHtml());
            }
            return buff.join('');
        },
        setFullScreen:function (fullscreen) {

            var editor = this.editor,
                container = editor.container.parentNode.parentNode;
            if (this._fullscreen != fullscreen) {
                this._fullscreen = fullscreen;
                this.editor.fireEvent('beforefullscreenchange', fullscreen);
                if (baidu.editor.browser.gecko) {
                    var bk = editor.selection.getRange().createBookmark();
                }
                if (fullscreen) {
                    while (container.tagName != "BODY") {
                        var position = baidu.editor.dom.domUtils.getComputedStyle(container, "position");
                        nodeStack.push(position);
                        container.style.position = "static";
                        container = container.parentNode;
                    }
                    this._bakHtmlOverflow = document.documentElement.style.overflow;
                    this._bakBodyOverflow = document.body.style.overflow;
                    this._bakAutoHeight = this.editor.autoHeightEnabled;
                    this._bakScrollTop = Math.max(document.documentElement.scrollTop, document.body.scrollTop);

                    this._bakEditorContaninerWidth = editor.iframe.parentNode.offsetWidth;
                    if (this._bakAutoHeight) {
                        //当全屏时不能执行自动长高
                        editor.autoHeightEnabled = false;
                        this.editor.disableAutoHeight();
                    }

                    document.documentElement.style.overflow = 'hidden';
                    //修复，滚动条不收起的问题

                    window.scrollTo(0,window.scrollY);
                    this._bakCssText = this.getDom().style.cssText;
                    this._bakCssText1 = this.getDom('iframeholder').style.cssText;
                    editor.iframe.parentNode.style.width = '';
                    this._updateFullScreen();
                } else {
                    while (container.tagName != "BODY") {
                        container.style.position = nodeStack.shift();
                        container = container.parentNode;
                    }
                    this.getDom().style.cssText = this._bakCssText;
                    this.getDom('iframeholder').style.cssText = this._bakCssText1;
                    if (this._bakAutoHeight) {
                        editor.autoHeightEnabled = true;
                        this.editor.enableAutoHeight();
                    }

                    document.documentElement.style.overflow = this._bakHtmlOverflow;
                    document.body.style.overflow = this._bakBodyOverflow;
                    editor.iframe.parentNode.style.width = this._bakEditorContaninerWidth + 'px';
                    window.scrollTo(0, this._bakScrollTop);
                }
                if (browser.gecko && editor.body.contentEditable === 'true') {
                    var input = document.createElement('input');
                    document.body.appendChild(input);
                    editor.body.contentEditable = false;
                    setTimeout(function () {
                        input.focus();
                        setTimeout(function () {
                            editor.body.contentEditable = true;
                            editor.fireEvent('fullscreenchanged', fullscreen);
                            editor.selection.getRange().moveToBookmark(bk).select(true);
                            baidu.editor.dom.domUtils.remove(input);
                            fullscreen && window.scroll(0, 0);
                        }, 0)
                    }, 0)
                }

                if(editor.body.contentEditable === 'true'){
                    this.editor.fireEvent('fullscreenchanged', fullscreen);
                    this.triggerLayout();
                }

            }
        },
        _updateFullScreen:function () {
            if (this._fullscreen) {
                var vpRect = uiUtils.getViewportRect();
                this.getDom().style.cssText = 'border:0;position:absolute;left:0;top:' + (this.editor.options.topOffset || 0) + 'px;width:' + vpRect.width + 'px;height:' + vpRect.height + 'px;z-index:' + (this.getDom().style.zIndex * 1 + 100);
                uiUtils.setViewportOffset(this.getDom(), { left:0, top:this.editor.options.topOffset || 0 });
                this.editor.setHeight(vpRect.height - this.getDom('toolbarbox').offsetHeight - this.getDom('bottombar').offsetHeight - (this.editor.options.topOffset || 0),true);
                //不手动调一下，会导致全屏失效
                if(browser.gecko){
                    try{
                        window.onresize();
                    }catch(e){

                    }

                }
            }
        },
        _updateElementPath:function () {
            var bottom = this.getDom('elementpath'), list;
            if (this.elementPathEnabled && (list = this.editor.queryCommandValue('elementpath'))) {

                var buff = [];
                for (var i = 0, ci; ci = list[i]; i++) {
                    buff[i] = this.formatHtml('<span unselectable="on" onclick="$$.editor.execCommand(&quot;elementpath&quot;, &quot;' + i + '&quot;);">' + ci + '</span>');
                }
                bottom.innerHTML = '<div class="edui-editor-breadcrumb" onmousedown="return false;">' + this.editor.getLang("elementPathTip") + ': ' + buff.join(' &gt; ') + '</div>';

            } else {
                bottom.style.display = 'none'
            }
        },
        disableElementPath:function () {
            var bottom = this.getDom('elementpath');
            bottom.innerHTML = '';
            bottom.style.display = 'none';
            this.elementPathEnabled = false;

        },
        enableElementPath:function () {
            var bottom = this.getDom('elementpath');
            bottom.style.display = '';
            this.elementPathEnabled = true;
            this._updateElementPath();
        },
        _scale:function () {
            var doc = document,
                editor = this.editor,
                editorHolder = editor.container,
                editorDocument = editor.document,
                toolbarBox = this.getDom("toolbarbox"),
                bottombar = this.getDom("bottombar"),
                scale = this.getDom("scale"),
                scalelayer = this.getDom("scalelayer");

            var isMouseMove = false,
                position = null,
                minEditorHeight = 0,
                minEditorWidth = editor.options.minFrameWidth,
                pageX = 0,
                pageY = 0,
                scaleWidth = 0,
                scaleHeight = 0;

            function down() {
                position = domUtils.getXY(editorHolder);

                if (!minEditorHeight) {
                    minEditorHeight = editor.options.minFrameHeight + toolbarBox.offsetHeight + bottombar.offsetHeight;
                }

                scalelayer.style.cssText = "position:absolute;left:0;display:;top:0;background-color:#41ABFF;opacity:0.4;filter: Alpha(opacity=40);width:" + editorHolder.offsetWidth + "px;height:"
                    + editorHolder.offsetHeight + "px;z-index:" + (editor.options.zIndex + 1);

                domUtils.on(doc, "mousemove", move);
                domUtils.on(editorDocument, "mouseup", up);
                domUtils.on(doc, "mouseup", up);
            }

            var me = this;
            //by xuheng 全屏时关掉缩放
            this.editor.addListener('fullscreenchanged', function (e, fullScreen) {
                if (fullScreen) {
                    me.disableScale();

                } else {
                    if (me.editor.options.scaleEnabled) {
                        me.enableScale();
                        var tmpNode = me.editor.document.createElement('span');
                        me.editor.body.appendChild(tmpNode);
                        me.editor.body.style.height = Math.max(domUtils.getXY(tmpNode).y, me.editor.iframe.offsetHeight - 20) + 'px';
                        domUtils.remove(tmpNode)
                    }
                }
            });
            function move(event) {
                clearSelection();
                var e = event || window.event;
                pageX = e.pageX || (doc.documentElement.scrollLeft + e.clientX);
                pageY = e.pageY || (doc.documentElement.scrollTop + e.clientY);
                scaleWidth = pageX - position.x;
                scaleHeight = pageY - position.y;

                if (scaleWidth >= minEditorWidth) {
                    isMouseMove = true;
                    scalelayer.style.width = scaleWidth + 'px';
                }
                if (scaleHeight >= minEditorHeight) {
                    isMouseMove = true;
                    scalelayer.style.height = scaleHeight + "px";
                }
            }

            function up() {
                if (isMouseMove) {
                    isMouseMove = false;
                    editor.ui._actualFrameWidth = scalelayer.offsetWidth - 2;
                    editorHolder.style.width = editor.ui._actualFrameWidth + 'px';

                    editor.setHeight(scalelayer.offsetHeight - bottombar.offsetHeight - toolbarBox.offsetHeight - 2,true);
                }
                if (scalelayer) {
                    scalelayer.style.display = "none";
                }
                clearSelection();
                domUtils.un(doc, "mousemove", move);
                domUtils.un(editorDocument, "mouseup", up);
                domUtils.un(doc, "mouseup", up);
            }

            function clearSelection() {
                if (browser.ie)
                    doc.selection.clear();
                else
                    window.getSelection().removeAllRanges();
            }

            this.enableScale = function () {
                //trace:2868
                if (editor.queryCommandState("source") == 1)    return;
                scale.style.display = "";
                this.scaleEnabled = true;
                domUtils.on(scale, "mousedown", down);
            };
            this.disableScale = function () {
                scale.style.display = "none";
                this.scaleEnabled = false;
                domUtils.un(scale, "mousedown", down);
            };
        },
        isFullScreen:function () {
            return this._fullscreen;
        },
        postRender:function () {
            UIBase.prototype.postRender.call(this);
            for (var i = 0; i < this.toolbars.length; i++) {
                this.toolbars[i].postRender();
            }
            var me = this;
            var timerId,
                domUtils = baidu.editor.dom.domUtils,
                updateFullScreenTime = function () {
                    clearTimeout(timerId);
                    timerId = setTimeout(function () {
                        me._updateFullScreen();
                    });
                };
            domUtils.on(window, 'resize', updateFullScreenTime);

            me.addListener('destroy', function () {
                domUtils.un(window, 'resize', updateFullScreenTime);
                clearTimeout(timerId);
            })
        },
        showToolbarMsg:function (msg, flag) {
            this.getDom('toolbarmsg_label').innerHTML = msg;
            this.getDom('toolbarmsg').style.display = '';
            //
            if (!flag) {
                var w = this.getDom('upload_dialog');
                w.style.display = 'none';
            }
        },
        hideToolbarMsg:function () {
            this.getDom('toolbarmsg').style.display = 'none';
        },
        mapUrl:function (url) {
            return url ? url.replace('~/', this.editor.options.UEDITOR_HOME_URL || '') : ''
        },
        triggerLayout:function () {
            var dom = this.getDom();
            if (dom.style.zoom == '1') {
                dom.style.zoom = '100%';
            } else {
                dom.style.zoom = '1';
            }
        }
    };
    utils.inherits(EditorUI, baidu.editor.ui.UIBase);


    var instances = {};


    UE.ui.Editor = function (options) {
        var editor = new UE.Editor(options);
        editor.options.editor = editor;
        utils.loadFile(document, {
            href:editor.options.themePath + editor.options.theme + "/css/ueditor.css",
            tag:"link",
            type:"text/css",
            rel:"stylesheet"
        });

        var oldRender = editor.render;
        editor.render = function (holder) {
            if (holder.constructor === String) {
                editor.key = holder;
                instances[holder] = editor;
            }
            utils.domReady(function () {
                editor.langIsReady ? renderUI() : editor.addListener("langReady", renderUI);
                function renderUI() {
                    editor.setOpt({
                        labelMap:editor.options.labelMap || editor.getLang('labelMap')
                    });
                    new EditorUI(editor.options);
                    if (holder) {
                        if (holder.constructor === String) {
                            holder = document.getElementById(holder);
                        }
                        holder && holder.getAttribute('name') && ( editor.options.textarea = holder.getAttribute('name'));
                        if (holder && /script|textarea/ig.test(holder.tagName)) {
                            var newDiv = document.createElement('div');
                            holder.parentNode.insertBefore(newDiv, holder);
                            var cont = holder.value || holder.innerHTML;
                            editor.options.initialContent = /^[\t\r\n ]*$/.test(cont) ? editor.options.initialContent :
                                cont.replace(/>[\n\r\t]+([ ]{4})+/g, '>')
                                    .replace(/[\n\r\t]+([ ]{4})+</g, '<')
                                    .replace(/>[\n\r\t]+</g, '><');
                            holder.className && (newDiv.className = holder.className);
                            holder.style.cssText && (newDiv.style.cssText = holder.style.cssText);
                            if (/textarea/i.test(holder.tagName)) {
                                editor.textarea = holder;
                                editor.textarea.style.display = 'none';


                            } else {
                                holder.parentNode.removeChild(holder);


                            }
                            if(holder.id){
                                newDiv.id = holder.id;
                                domUtils.removeAttributes(holder,'id');
                            }
                            holder = newDiv;
                            holder.innerHTML = '';
                        }

                    }
                    domUtils.addClass(holder, "edui-" + editor.options.theme);
                    editor.ui.render(holder);
                    var opt = editor.options;
                    //给实例添加一个编辑器的容器引用
                    editor.container = editor.ui.getDom();
                    var parents = domUtils.findParents(holder,true);
                    var displays = [];
                    for(var i = 0 ,ci;ci=parents[i];i++){
                        displays[i] = ci.style.display;
                        ci.style.display = 'block'
                    }
                    if (opt.initialFrameWidth) {
                        opt.minFrameWidth = opt.initialFrameWidth;
                    } else {
                        opt.minFrameWidth = opt.initialFrameWidth = holder.offsetWidth;
                        var styleWidth = holder.style.width;
                        if(/%$/.test(styleWidth)) {
                            opt.initialFrameWidth = styleWidth;
                        }
                    }
                    if (opt.initialFrameHeight) {
                        opt.minFrameHeight = opt.initialFrameHeight;
                    } else {
                        opt.initialFrameHeight = opt.minFrameHeight = holder.offsetHeight;
                    }
                    for(var i = 0 ,ci;ci=parents[i];i++){
                        ci.style.display =  displays[i]
                    }
                    //编辑器最外容器设置了高度，会导致，编辑器不占位
                    //todo 先去掉，没有找到原因
                    if(holder.style.height){
                        holder.style.height = ''
                    }
                    editor.container.style.width = opt.initialFrameWidth + (/%$/.test(opt.initialFrameWidth) ? '' : 'px');
                    editor.container.style.zIndex = opt.zIndex;
                    oldRender.call(editor, editor.ui.getDom('iframeholder'));
                    editor.fireEvent("afteruiready");
                }
            })
        };
        return editor;
    };


    /**
     * @file
     * @name UE
     * @short UE
     * @desc UEditor的顶部命名空间
     */
    /**
     * @name getEditor
     * @since 1.2.4+
     * @grammar UE.getEditor(id,[opt])  =>  Editor实例
     * @desc 提供一个全局的方法得到编辑器实例
     *
     * * ''id''  放置编辑器的容器id, 如果容器下的编辑器已经存在，就直接返回
     * * ''opt'' 编辑器的可选参数
     * @example
     *  UE.getEditor('containerId',{onready:function(){//创建一个编辑器实例
     *      this.setContent('hello')
     *  }});
     *  UE.getEditor('containerId'); //返回刚创建的实例
     *
     */
  /*  UE.getEditor = function (id, opt) {
        var editor = instances[id];
        if (!editor) {
            editor = instances[id] = new UE.ui.Editor(opt);
            editor.render(id);
        }
        return editor;
    };*/
    UE.getEditor = function (id, opt) {

    	UE.delEditor(id);
    	var editor = new UE.ui.Editor(opt);
    	editor.render(id);
    	return editor;
    	};

    UE.delEditor = function (id) {
        var editor;
        if (editor = instances[id]) {
            editor.key && editor.destroy();
            delete instances[id]
        }
    };

    UE.registerUI = function(uiName,fn,index,editorId){
        utils.each(uiName.split(/\s+/), function (name) {
            UE._customizeUI[name] = {
                id : editorId,
                execFn:fn,
                index:index
            };
        })

    }

})();

// adapter/message.js
UE.registerUI('message', function(editor) {

    var editorui = baidu.editor.ui;
    var Message = editorui.Message;
    var holder;
    var _messageItems = [];
    var me = editor;

    me.addListener('ready', function(){
        holder = document.getElementById(me.ui.id + '_message_holder');
        updateHolderPos();
        setTimeout(function(){
            updateHolderPos();
        }, 500);
    });

    me.addListener('showmessage', function(type, opt){
        opt = utils.isString(opt) ? {
            'content': opt
        } : opt;
        var message = new Message({
                'timeout': opt.timeout,
                'type': opt.type,
                'content': opt.content,
                'keepshow': opt.keepshow,
                'editor': me
            }),
            mid = opt.id || ('msg_' + (+new Date()).toString(36));
        message.render(holder);
        _messageItems[mid] = message;
        message.reset(opt);
        updateHolderPos();
        return mid;
    });

    me.addListener('updatemessage',function(type, id, opt){
        opt = utils.isString(opt) ? {
            'content': opt
        } : opt;
        var message = _messageItems[id];
        message.render(holder);
        message && message.reset(opt);
    });

    me.addListener('hidemessage',function(type, id){
        var message = _messageItems[id];
        message && message.hide();
    });

    function updateHolderPos(){
        var toolbarbox = me.ui.getDom('toolbarbox');
        if (toolbarbox) {
            holder.style.top = toolbarbox.offsetHeight + 3 + 'px';
        }
        holder.style.zIndex = Math.max(me.options.zIndex, me.iframe.style.zIndex) + 1;
    }

});


// adapter/autosave.js
UE.registerUI('autosave', function(editor) {
    var timer = null,uid = null;
    editor.on('afterautosave',function(){
        clearTimeout(timer);

        timer = setTimeout(function(){
            if(uid){
                editor.trigger('hidemessage',uid);
            }
            uid = editor.trigger('showmessage',{
                content : editor.getLang('autosave.success'),
                timeout : 2000
            });

        },2000)
    })

});



})();

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJwbHVnaW5zL3VlZGl0b3IvdWVkaXRvci5hbGwuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBVRWRpdG9yXG4gKiB2ZXJzaW9uOiB1ZWRpdG9yXG4gKiBidWlsZDogV2VkIEF1ZyAxMCAyMDE2IDExOjA2OjE2IEdNVCswODAwIChDU1QpXG4gKi9cblxuKGZ1bmN0aW9uKCl7XG5cbi8vIGVkaXRvci5qc1xuVUVESVRPUl9DT05GSUcgPSB3aW5kb3cuVUVESVRPUl9DT05GSUcgfHwge307XHJcblxyXG52YXIgYmFpZHUgPSB3aW5kb3cuYmFpZHUgfHwge307XHJcblxyXG53aW5kb3cuYmFpZHUgPSBiYWlkdTtcclxuXHJcbndpbmRvdy5VRSA9IGJhaWR1LmVkaXRvciA9ICB3aW5kb3cuVUUgfHwge307XHJcblxyXG5VRS5wbHVnaW5zID0ge307XHJcblxyXG5VRS5jb21tYW5kcyA9IHt9O1xyXG5cclxuVUUuaW5zdGFudHMgPSB7fTtcclxuXHJcblVFLkkxOE4gPSB7fTtcclxuXHJcblVFLl9jdXN0b21pemVVSSA9IHt9O1xyXG5cclxuVUUudmVyc2lvbiA9IFwiMS40LjNcIjtcclxuXHJcbnZhciBkb20gPSBVRS5kb20gPSB7fTtcblxuLy8gY29yZS9icm93c2VyLmpzXG4vKipcclxuICog5rWP6KeI5Zmo5Yik5pat5qih5Z2XXHJcbiAqIEBmaWxlXHJcbiAqIEBtb2R1bGUgVUUuYnJvd3NlclxyXG4gKiBAc2luY2UgMS4yLjYuMVxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiDmj5DkvpvmtY/op4jlmajmo4DmtYvnmoTmqKHlnZdcclxuICogQHVuZmlsZVxyXG4gKiBAbW9kdWxlIFVFLmJyb3dzZXJcclxuICovXHJcbnZhciBicm93c2VyID0gVUUuYnJvd3NlciA9IGZ1bmN0aW9uKCl7XHJcbiAgICB2YXIgYWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCksXHJcbiAgICAgICAgb3BlcmEgPSB3aW5kb3cub3BlcmEsXHJcbiAgICAgICAgYnJvd3NlciA9IHtcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGllIOajgOa1i+W9k+WJjea1j+iniOWZqOaYr+WQpuS4uklFXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogaWYgKCBVRS5icm93c2VyLmllICkge1xyXG4gICAgICAgICAqICAgICBjb25zb2xlLmxvZyggJ+W9k+WJjea1j+iniOWZqOaYr0lFJyApO1xyXG4gICAgICAgICAqIH1cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICBpZVx0XHQ6ICAvKG1zaWVcXHN8dHJpZGVudC4qcnY6KShbXFx3Ll0rKS8udGVzdChhZ2VudCksXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gb3BlcmEg5qOA5rWL5b2T5YmN5rWP6KeI5Zmo5piv5ZCm5Li6T3BlcmFcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBpZiAoIFVFLmJyb3dzZXIub3BlcmEgKSB7XHJcbiAgICAgICAgICogICAgIGNvbnNvbGUubG9nKCAn5b2T5YmN5rWP6KeI5Zmo5pivT3BlcmEnICk7XHJcbiAgICAgICAgICogfVxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIG9wZXJhXHQ6ICggISFvcGVyYSAmJiBvcGVyYS52ZXJzaW9uICksXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gd2Via2l0IOajgOa1i+W9k+WJjea1j+iniOWZqOaYr+WQpuaYr3dlYmtpdOWGheaguOeahOa1j+iniOWZqFxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGlmICggVUUuYnJvd3Nlci53ZWJraXQgKSB7XHJcbiAgICAgICAgICogICAgIGNvbnNvbGUubG9nKCAn5b2T5YmN5rWP6KeI5Zmo5pivd2Via2l05YaF5qC45rWP6KeI5ZmoJyApO1xyXG4gICAgICAgICAqIH1cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICB3ZWJraXRcdDogKCBhZ2VudC5pbmRleE9mKCAnIGFwcGxld2Via2l0LycgKSA+IC0xICksXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbWFjIOajgOa1i+W9k+WJjea1j+iniOWZqOaYr+WQpuaYr+i/kOihjOWcqG1hY+W5s+WPsOS4i1xyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGlmICggVUUuYnJvd3Nlci5tYWMgKSB7XHJcbiAgICAgICAgICogICAgIGNvbnNvbGUubG9nKCAn5b2T5YmN5rWP6KeI5Zmo6L+Q6KGM5ZyobWFj5bmz5Y+w5LiLJyApO1xyXG4gICAgICAgICAqIH1cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICBtYWNcdDogKCBhZ2VudC5pbmRleE9mKCAnbWFjaW50b3NoJyApID4gLTEgKSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogQHByb3BlcnR5IHtib29sZWFufSBxdWlya3Mg5qOA5rWL5b2T5YmN5rWP6KeI5Zmo5piv5ZCm5aSE5LqO4oCc5oCq5byC5qih5byP4oCd5LiLXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogaWYgKCBVRS5icm93c2VyLnF1aXJrcyApIHtcclxuICAgICAgICAgKiAgICAgY29uc29sZS5sb2coICflvZPliY3mtY/op4jlmajov5DooYzlpITkuo7igJzmgKrlvILmqKHlvI/igJ0nICk7XHJcbiAgICAgICAgICogfVxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHF1aXJrcyA6ICggZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAnQmFja0NvbXBhdCcgKVxyXG4gICAgfTtcclxuXHJcbiAgICAvKipcclxuICAgICogQHByb3BlcnR5IHtib29sZWFufSBnZWNrbyDmo4DmtYvlvZPliY3mtY/op4jlmajlhoXmoLjmmK/lkKbmmK9nZWNrb+WGheaguFxyXG4gICAgKiBAZXhhbXBsZVxyXG4gICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAqIGlmICggVUUuYnJvd3Nlci5nZWNrbyApIHtcclxuICAgICogICAgIGNvbnNvbGUubG9nKCAn5b2T5YmN5rWP6KeI5Zmo5YaF5qC45pivZ2Vja2/lhoXmoLgnICk7XHJcbiAgICAqIH1cclxuICAgICogYGBgXHJcbiAgICAqL1xyXG4gICAgYnJvd3Nlci5nZWNrbyA9KCBuYXZpZ2F0b3IucHJvZHVjdCA9PSAnR2Vja28nICYmICFicm93c2VyLndlYmtpdCAmJiAhYnJvd3Nlci5vcGVyYSAmJiAhYnJvd3Nlci5pZSk7XHJcblxyXG4gICAgdmFyIHZlcnNpb24gPSAwO1xyXG5cclxuICAgIC8vIEludGVybmV0IEV4cGxvcmVyIDYuMCtcclxuICAgIGlmICggYnJvd3Nlci5pZSApe1xyXG5cclxuICAgICAgICB2YXIgdjEgPSAgYWdlbnQubWF0Y2goLyg/Om1zaWVcXHMoW1xcdy5dKykpLyk7XHJcbiAgICAgICAgdmFyIHYyID0gYWdlbnQubWF0Y2goLyg/OnRyaWRlbnQuKnJ2OihbXFx3Ll0rKSkvKTtcclxuICAgICAgICBpZih2MSAmJiB2MiAmJiB2MVsxXSAmJiB2MlsxXSl7XHJcbiAgICAgICAgICAgIHZlcnNpb24gPSBNYXRoLm1heCh2MVsxXSoxLHYyWzFdKjEpO1xyXG4gICAgICAgIH1lbHNlIGlmKHYxICYmIHYxWzFdKXtcclxuICAgICAgICAgICAgdmVyc2lvbiA9IHYxWzFdKjE7XHJcbiAgICAgICAgfWVsc2UgaWYodjIgJiYgdjJbMV0pe1xyXG4gICAgICAgICAgICB2ZXJzaW9uID0gdjJbMV0qMTtcclxuICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgdmVyc2lvbiA9IDA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBicm93c2VyLmllMTFDb21wYXQgPSBkb2N1bWVudC5kb2N1bWVudE1vZGUgPT0gMTE7XHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogQHByb3BlcnR5IHsgYm9vbGVhbiB9IGllOUNvbXBhdCDmo4DmtYvmtY/op4jlmajmqKHlvI/mmK/lkKbkuLogSUU5IOWFvOWuueaooeW8j1xyXG4gICAgICAgICAqIEB3YXJuaW5nIOWmguaenOa1j+iniOWZqOS4jeaYr0lF77yMIOWImeivpeWAvOS4unVuZGVmaW5lZFxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGlmICggVUUuYnJvd3Nlci5pZTlDb21wYXQgKSB7XHJcbiAgICAgICAgICogICAgIGNvbnNvbGUubG9nKCAn5b2T5YmN5rWP6KeI5Zmo6L+Q6KGM5ZyoSUU55YW85a655qih5byP5LiLJyApO1xyXG4gICAgICAgICAqIH1cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICBicm93c2VyLmllOUNvbXBhdCA9IGRvY3VtZW50LmRvY3VtZW50TW9kZSA9PSA5O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBAcHJvcGVydHkgeyBib29sZWFuIH0gaWU4IOajgOa1i+a1j+iniOWZqOaYr+WQpuaYr0lFOOa1j+iniOWZqFxyXG4gICAgICAgICAqIEB3YXJuaW5nIOWmguaenOa1j+iniOWZqOS4jeaYr0lF77yMIOWImeivpeWAvOS4unVuZGVmaW5lZFxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGlmICggVUUuYnJvd3Nlci5pZTggKSB7XHJcbiAgICAgICAgICogICAgIGNvbnNvbGUubG9nKCAn5b2T5YmN5rWP6KeI5Zmo5pivSUU45rWP6KeI5ZmoJyApO1xyXG4gICAgICAgICAqIH1cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICBicm93c2VyLmllOCA9ICEhZG9jdW1lbnQuZG9jdW1lbnRNb2RlO1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBAcHJvcGVydHkgeyBib29sZWFuIH0gaWU4Q29tcGF0IOajgOa1i+a1j+iniOWZqOaooeW8j+aYr+WQpuS4uiBJRTgg5YW85a655qih5byPXHJcbiAgICAgICAgICogQHdhcm5pbmcg5aaC5p6c5rWP6KeI5Zmo5LiN5pivSUXvvIwg5YiZ6K+l5YC85Li6dW5kZWZpbmVkXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogaWYgKCBVRS5icm93c2VyLmllOENvbXBhdCApIHtcclxuICAgICAgICAgKiAgICAgY29uc29sZS5sb2coICflvZPliY3mtY/op4jlmajov5DooYzlnKhJRTjlhbzlrrnmqKHlvI/kuIsnICk7XHJcbiAgICAgICAgICogfVxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGJyb3dzZXIuaWU4Q29tcGF0ID0gZG9jdW1lbnQuZG9jdW1lbnRNb2RlID09IDg7XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIEBwcm9wZXJ0eSB7IGJvb2xlYW4gfSBpZTdDb21wYXQg5qOA5rWL5rWP6KeI5Zmo5qih5byP5piv5ZCm5Li6IElFNyDlhbzlrrnmqKHlvI9cclxuICAgICAgICAgKiBAd2FybmluZyDlpoLmnpzmtY/op4jlmajkuI3mmK9JRe+8jCDliJnor6XlgLzkuLp1bmRlZmluZWRcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBpZiAoIFVFLmJyb3dzZXIuaWU3Q29tcGF0ICkge1xyXG4gICAgICAgICAqICAgICBjb25zb2xlLmxvZyggJ+W9k+WJjea1j+iniOWZqOi/kOihjOWcqElFN+WFvOWuueaooeW8j+S4iycgKTtcclxuICAgICAgICAgKiB9XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgYnJvd3Nlci5pZTdDb21wYXQgPSAoICggdmVyc2lvbiA9PSA3ICYmICFkb2N1bWVudC5kb2N1bWVudE1vZGUgKVxyXG4gICAgICAgICAgICAgICAgfHwgZG9jdW1lbnQuZG9jdW1lbnRNb2RlID09IDcgKTtcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogQHByb3BlcnR5IHsgYm9vbGVhbiB9IGllNkNvbXBhdCDmo4DmtYvmtY/op4jlmajmqKHlvI/mmK/lkKbkuLogSUU2IOaooeW8jyDmiJbogIXmgKrlvILmqKHlvI9cclxuICAgICAgICAgKiBAd2FybmluZyDlpoLmnpzmtY/op4jlmajkuI3mmK9JRe+8jCDliJnor6XlgLzkuLp1bmRlZmluZWRcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBpZiAoIFVFLmJyb3dzZXIuaWU2Q29tcGF0ICkge1xyXG4gICAgICAgICAqICAgICBjb25zb2xlLmxvZyggJ+W9k+WJjea1j+iniOWZqOi/kOihjOWcqElFNuaooeW8j+aIluiAheaAquW8guaooeW8j+S4iycgKTtcclxuICAgICAgICAgKiB9XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgYnJvd3Nlci5pZTZDb21wYXQgPSAoIHZlcnNpb24gPCA3IHx8IGJyb3dzZXIucXVpcmtzICk7XHJcblxyXG4gICAgICAgIGJyb3dzZXIuaWU5YWJvdmUgPSB2ZXJzaW9uID4gODtcclxuXHJcbiAgICAgICAgYnJvd3Nlci5pZTliZWxvdyA9IHZlcnNpb24gPCA5O1xyXG5cclxuICAgICAgICBicm93c2VyLmllMTFhYm92ZSA9IHZlcnNpb24gPiAxMDtcclxuXHJcbiAgICAgICAgYnJvd3Nlci5pZTExYmVsb3cgPSB2ZXJzaW9uIDwgMTE7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8vIEdlY2tvLlxyXG4gICAgaWYgKCBicm93c2VyLmdlY2tvICl7XHJcbiAgICAgICAgdmFyIGdlY2tvUmVsZWFzZSA9IGFnZW50Lm1hdGNoKCAvcnY6KFtcXGRcXC5dKykvICk7XHJcbiAgICAgICAgaWYgKCBnZWNrb1JlbGVhc2UgKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgZ2Vja29SZWxlYXNlID0gZ2Vja29SZWxlYXNlWzFdLnNwbGl0KCAnLicgKTtcclxuICAgICAgICAgICAgdmVyc2lvbiA9IGdlY2tvUmVsZWFzZVswXSAqIDEwMDAwICsgKCBnZWNrb1JlbGVhc2VbMV0gfHwgMCApICogMTAwICsgKCBnZWNrb1JlbGVhc2VbMl0gfHwgMCApICogMTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAcHJvcGVydHkgeyBOdW1iZXIgfSBjaHJvbWUg5qOA5rWL5b2T5YmN5rWP6KeI5Zmo5piv5ZCm5Li6Q2hyb21lLCDlpoLmnpzmmK/vvIzliJnov5Tlm55DaHJvbWXnmoTlpKfniYjmnKzlj7dcclxuICAgICAqIEB3YXJuaW5nIOWmguaenOa1j+iniOWZqOS4jeaYr2Nocm9tZe+8jCDliJnor6XlgLzkuLp1bmRlZmluZWRcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiBpZiAoIFVFLmJyb3dzZXIuY2hyb21lICkge1xyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCAn5b2T5YmN5rWP6KeI5Zmo5pivQ2hyb21lJyApO1xyXG4gICAgICogfVxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIGlmICgvY2hyb21lXFwvKFxcZCtcXC5cXGQpL2kudGVzdChhZ2VudCkpIHtcclxuICAgICAgICBicm93c2VyLmNocm9tZSA9ICsgUmVnRXhwWydcXHgyNDEnXTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBwcm9wZXJ0eSB7IE51bWJlciB9IHNhZmFyaSDmo4DmtYvlvZPliY3mtY/op4jlmajmmK/lkKbkuLpTYWZhcmksIOWmguaenOaYr++8jOWImei/lOWbnlNhZmFyaeeahOWkp+eJiOacrOWPt1xyXG4gICAgICogQHdhcm5pbmcg5aaC5p6c5rWP6KeI5Zmo5LiN5pivc2FmYXJp77yMIOWImeivpeWAvOS4unVuZGVmaW5lZFxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIGlmICggVUUuYnJvd3Nlci5zYWZhcmkgKSB7XHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coICflvZPliY3mtY/op4jlmajmmK9TYWZhcmknICk7XHJcbiAgICAgKiB9XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgaWYoLyhcXGQrXFwuXFxkKT8oPzpcXC5cXGQpP1xccytzYWZhcmlcXC8/KFxcZCtcXC5cXGQrKT8vaS50ZXN0KGFnZW50KSAmJiAhL2Nocm9tZS9pLnRlc3QoYWdlbnQpKXtcclxuICAgIFx0YnJvd3Nlci5zYWZhcmkgPSArIChSZWdFeHBbJ1xceDI0MSddIHx8IFJlZ0V4cFsnXFx4MjQyJ10pO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICAvLyBPcGVyYSA5LjUwK1xyXG4gICAgaWYgKCBicm93c2VyLm9wZXJhIClcclxuICAgICAgICB2ZXJzaW9uID0gcGFyc2VGbG9hdCggb3BlcmEudmVyc2lvbigpICk7XHJcblxyXG4gICAgLy8gV2ViS2l0IDUyMisgKFNhZmFyaSAzKylcclxuICAgIGlmICggYnJvd3Nlci53ZWJraXQgKVxyXG4gICAgICAgIHZlcnNpb24gPSBwYXJzZUZsb2F0KCBhZ2VudC5tYXRjaCggLyBhcHBsZXdlYmtpdFxcLyhcXGQrKS8gKVsxXSApO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogQHByb3BlcnR5IHsgTnVtYmVyIH0gdmVyc2lvbiDmo4DmtYvlvZPliY3mtY/op4jlmajniYjmnKzlj7dcclxuICAgICAqIEByZW1pbmRcclxuICAgICAqIDx1bD5cclxuICAgICAqICAgICA8bGk+SUXns7vliJfov5Tlm57lgLzkuLo1LDYsNyw4LDksMTDnrYk8L2xpPlxyXG4gICAgICogICAgIDxsaT5nZWNrb+ezu+WIl+S8mui/lOWbnjEwOTAw77yMMTU4OTAw562JPC9saT5cclxuICAgICAqICAgICA8bGk+d2Via2l057O75YiX5Lya6L+U5Zue5YW2YnVpbGTlj7cgKOWmgiA1MjLnrYkpPC9saT5cclxuICAgICAqIDwvdWw+XHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogY29uc29sZS5sb2coICflvZPliY3mtY/op4jlmajniYjmnKzlj7fmmK/vvJogJyArIFVFLmJyb3dzZXIudmVyc2lvbiApO1xyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIGJyb3dzZXIudmVyc2lvbiA9IHZlcnNpb247XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAcHJvcGVydHkgeyBib29sZWFuIH0gaXNDb21wYXRpYmxlIOajgOa1i+W9k+WJjea1j+iniOWZqOaYr+WQpuiDveWkn+S4jlVFZGl0b3Loia/lpb3lhbzlrrlcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiBpZiAoIFVFLmJyb3dzZXIuaXNDb21wYXRpYmxlICkge1xyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCAn5rWP6KeI5Zmo5LiOVUVkaXRvcuiDveWkn+iJr+WlveWFvOWuuScgKTtcclxuICAgICAqIH1cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBicm93c2VyLmlzQ29tcGF0aWJsZSA9XHJcbiAgICAgICAgIWJyb3dzZXIubW9iaWxlICYmIChcclxuICAgICAgICAoIGJyb3dzZXIuaWUgJiYgdmVyc2lvbiA+PSA2ICkgfHxcclxuICAgICAgICAoIGJyb3dzZXIuZ2Vja28gJiYgdmVyc2lvbiA+PSAxMDgwMSApIHx8XHJcbiAgICAgICAgKCBicm93c2VyLm9wZXJhICYmIHZlcnNpb24gPj0gOS41ICkgfHxcclxuICAgICAgICAoIGJyb3dzZXIuYWlyICYmIHZlcnNpb24gPj0gMSApIHx8XHJcbiAgICAgICAgKCBicm93c2VyLndlYmtpdCAmJiB2ZXJzaW9uID49IDUyMiApIHx8XHJcbiAgICAgICAgZmFsc2UgKTtcclxuICAgIHJldHVybiBicm93c2VyO1xyXG59KCk7XHJcbi8v5b+r5o235pa55byPXHJcbnZhciBpZSA9IGJyb3dzZXIuaWUsXHJcbiAgICB3ZWJraXQgPSBicm93c2VyLndlYmtpdCxcclxuICAgIGdlY2tvID0gYnJvd3Nlci5nZWNrbyxcclxuICAgIG9wZXJhID0gYnJvd3Nlci5vcGVyYTtcblxuLy8gY29yZS91dGlscy5qc1xuLyoqXHJcbiAqIOW3peWFt+WHveaVsOWMhVxyXG4gKiBAZmlsZVxyXG4gKiBAbW9kdWxlIFVFLnV0aWxzXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIFVFZGl0b3LlsIHoo4Xkvb/nlKjnmoTpnZnmgIHlt6Xlhbflh73mlbBcclxuICogQG1vZHVsZSBVRS51dGlsc1xyXG4gKiBAdW5maWxlXHJcbiAqL1xyXG5cclxudmFyIHV0aWxzID0gVUUudXRpbHMgPSB7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnlKjnu5nlrprnmoTov63ku6PlmajpgY3ljoblr7nosaFcclxuICAgICAqIEBtZXRob2QgZWFjaFxyXG4gICAgICogQHBhcmFtIHsgT2JqZWN0IH0gb2JqIOmcgOimgemBjeWOhueahOWvueixoVxyXG4gICAgICogQHBhcmFtIHsgRnVuY3Rpb24gfSBpdGVyYXRvciDov63ku6PlmajvvIwg6K+l5pa55rOV5o6l5Y+X5Lik5Liq5Y+C5pWw77yMIOesrOS4gOS4quWPguaVsOaYr+W9k+WJjeaJgOWkhOeQhueahHZhbHVl77yMIOesrOS6jOS4quWPguaVsOaYr+W9k+WJjemBjeWOhuWvueixoeeahGtleVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIHZhciBkZW1vT2JqID0ge1xyXG4gICAgICogICAgIGtleTE6IDEsXHJcbiAgICAgKiAgICAga2V5MjogMlxyXG4gICAgICogfTtcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDoga2V5MTogMSwga2V5MjogMlxyXG4gICAgICogVUUudXRpbHMuZWFjaCggZGVtb09iaiwgZnVuY2l0b24gKCB2YWx1ZSwga2V5ICkge1xyXG4gICAgICpcclxuICAgICAqICAgICBjb25zb2xlLmxvZygga2V5ICsgXCI6XCIgKyB2YWx1ZSApO1xyXG4gICAgICpcclxuICAgICAqIH0gKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnlKjnu5nlrprnmoTov63ku6PlmajpgY3ljobmlbDnu4TmiJbnsbvmlbDnu4Tlr7nosaFcclxuICAgICAqIEBtZXRob2QgZWFjaFxyXG4gICAgICogQHBhcmFtIHsgQXJyYXkgfSBhcnJheSDpnIDopoHpgY3ljobnmoTmlbDnu4TmiJbogIXnsbvmlbDnu4RcclxuICAgICAqIEBwYXJhbSB7IEZ1bmN0aW9uIH0gaXRlcmF0b3Ig6L+t5Luj5Zmo77yMIOivpeaWueazleaOpeWPl+S4pOS4quWPguaVsO+8jCDnrKzkuIDkuKrlj4LmlbDmmK/lvZPliY3miYDlpITnkIbnmoR2YWx1Ze+8jCDnrKzkuozkuKrlj4LmlbDmmK/lvZPliY3pgY3ljoblr7nosaHnmoRrZXlcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiB2YXIgZGl2cyA9IGRvY3VtZW50LmdldEVsbWVudEJ5VGFnTmFtZXMoIFwiZGl2XCIgKTtcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogMDogRElWLCAxOiBESVYgLi4uXHJcbiAgICAgKiBVRS51dGlscy5lYWNoKCBkaXZzLCBmdW5jaXRvbiAoIHZhbHVlLCBrZXkgKSB7XHJcbiAgICAgKlxyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCBrZXkgKyBcIjpcIiArIHZhbHVlLnRhZ05hbWUgKTtcclxuICAgICAqXHJcbiAgICAgKiB9ICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgZWFjaCA6IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHtcclxuICAgICAgICBpZiAob2JqID09IG51bGwpIHJldHVybjtcclxuICAgICAgICBpZiAob2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGgpIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBvYmoubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBpZihpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtpXSwgaSwgb2JqKSA9PT0gZmFsc2UpXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG9iaikge1xyXG4gICAgICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5LCBvYmopID09PSBmYWxzZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOS7pee7meWumuWvueixoeS9nOS4uuWOn+Wei+WIm+W7uuS4gOS4quaWsOWvueixoVxyXG4gICAgICogQG1ldGhvZCBtYWtlSW5zdGFuY2VcclxuICAgICAqIEBwYXJhbSB7IE9iamVjdCB9IHByb3RvT2JqZWN0IOivpeWvueixoeWwhuS9nOS4uuaWsOWIm+W7uuWvueixoeeahOWOn+Wei1xyXG4gICAgICogQHJldHVybiB7IE9iamVjdCB9IOaWsOeahOWvueixoe+8jCDor6Xlr7nosaHnmoTljp/lnovmmK/nu5nlrprnmoRwcm90b09iamVjdOWvueixoVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqXHJcbiAgICAgKiB2YXIgcHJvdG9PYmplY3QgPSB7IHNheUhlbGxvOiBmdW5jdGlvbiAoKSB7IGNvbnNvbGUubG9nKCdIZWxsbyBVRWRpdG9yIScpOyB9IH07XHJcbiAgICAgKlxyXG4gICAgICogdmFyIG5ld09iamVjdCA9IFVFLnV0aWxzLm1ha2VJbnN0YW5jZSggcHJvdG9PYmplY3QgKTtcclxuICAgICAqIC8vb3V0cHV0OiBIZWxsbyBVRWRpdG9yIVxyXG4gICAgICogbmV3T2JqZWN0LnNheUhlbGxvKCk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgbWFrZUluc3RhbmNlOmZ1bmN0aW9uIChvYmopIHtcclxuICAgICAgICB2YXIgbm9vcCA9IG5ldyBGdW5jdGlvbigpO1xyXG4gICAgICAgIG5vb3AucHJvdG90eXBlID0gb2JqO1xyXG4gICAgICAgIG9iaiA9IG5ldyBub29wO1xyXG4gICAgICAgIG5vb3AucHJvdG90eXBlID0gbnVsbDtcclxuICAgICAgICByZXR1cm4gb2JqO1xyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWwhnNvdXJjZeWvueixoeS4reeahOWxnuaAp+aJqeWxleWIsHRhcmdldOWvueixoeS4ilxyXG4gICAgICogQG1ldGhvZCBleHRlbmRcclxuICAgICAqIEByZW1pbmQg6K+l5pa55rOV5bCG5by65Yi25oqKc291cmNl5a+56LGh5LiK55qE5bGe5oCn5aSN5Yi25YiwdGFyZ2V05a+56LGh5LiKXHJcbiAgICAgKiBAc2VlIFVFLnV0aWxzLmV4dGVuZChPYmplY3QsT2JqZWN0LEJvb2xlYW4pXHJcbiAgICAgKiBAcGFyYW0geyBPYmplY3QgfSB0YXJnZXQg55uu5qCH5a+56LGh77yMIOaWsOeahOWxnuaAp+WwhumZhOWKoOWIsOivpeWvueixoeS4ilxyXG4gICAgICogQHBhcmFtIHsgT2JqZWN0IH0gc291cmNlIOa6kOWvueixoe+8jCDor6Xlr7nosaHnmoTlsZ7mgKfkvJrooqvpmYTliqDliLB0YXJnZXTlr7nosaHkuIpcclxuICAgICAqIEByZXR1cm4geyBPYmplY3QgfSDov5Tlm550YXJnZXTlr7nosaFcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKlxyXG4gICAgICogdmFyIHRhcmdldCA9IHsgbmFtZTogJ3RhcmdldCcsIHNleDogMSB9LFxyXG4gICAgICogICAgICBzb3VyY2UgPSB7IG5hbWU6ICdzb3VyY2UnLCBhZ2U6IDE3IH07XHJcbiAgICAgKlxyXG4gICAgICogVUUudXRpbHMuZXh0ZW5kKCB0YXJnZXQsIHNvdXJjZSApO1xyXG4gICAgICpcclxuICAgICAqIC8vb3V0cHV0OiB7IG5hbWU6ICdzb3VyY2UnLCBzZXg6IDEsIGFnZTogMTcgfVxyXG4gICAgICogY29uc29sZS5sb2coIHRhcmdldCApO1xyXG4gICAgICpcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlsIZzb3VyY2Xlr7nosaHkuK3nmoTlsZ7mgKfmianlsZXliLB0YXJnZXTlr7nosaHkuIrvvIwg5qC55o2u5oyH5a6a55qEaXNLZWVwVGFyZ2V05YC85Yaz5a6a5piv5ZCm5L+d55WZ55uu5qCH5a+56LGh5Lit5LiOXHJcbiAgICAgKiDmupDlr7nosaHlsZ7mgKflkI3nm7jlkIznmoTlsZ7mgKflgLzjgIJcclxuICAgICAqIEBtZXRob2QgZXh0ZW5kXHJcbiAgICAgKiBAcGFyYW0geyBPYmplY3QgfSB0YXJnZXQg55uu5qCH5a+56LGh77yMIOaWsOeahOWxnuaAp+WwhumZhOWKoOWIsOivpeWvueixoeS4ilxyXG4gICAgICogQHBhcmFtIHsgT2JqZWN0IH0gc291cmNlIOa6kOWvueixoe+8jCDor6Xlr7nosaHnmoTlsZ7mgKfkvJrooqvpmYTliqDliLB0YXJnZXTlr7nosaHkuIpcclxuICAgICAqIEBwYXJhbSB7IEJvb2xlYW4gfSBpc0tlZXBUYXJnZXQg5piv5ZCm5L+d55WZ55uu5qCH5a+56LGh5Lit5LiO5rqQ5a+56LGh5Lit5bGe5oCn5ZCN55u45ZCM55qE5bGe5oCnXHJcbiAgICAgKiBAcmV0dXJuIHsgT2JqZWN0IH0g6L+U5ZuedGFyZ2V05a+56LGhXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICpcclxuICAgICAqIHZhciB0YXJnZXQgPSB7IG5hbWU6ICd0YXJnZXQnLCBzZXg6IDEgfSxcclxuICAgICAqICAgICAgc291cmNlID0geyBuYW1lOiAnc291cmNlJywgYWdlOiAxNyB9O1xyXG4gICAgICpcclxuICAgICAqIFVFLnV0aWxzLmV4dGVuZCggdGFyZ2V0LCBzb3VyY2UsIHRydWUgKTtcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogeyBuYW1lOiAndGFyZ2V0Jywgc2V4OiAxLCBhZ2U6IDE3IH1cclxuICAgICAqIGNvbnNvbGUubG9nKCB0YXJnZXQgKTtcclxuICAgICAqXHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgZXh0ZW5kOmZ1bmN0aW9uICh0LCBzLCBiKSB7XHJcbiAgICAgICAgaWYgKHMpIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgayBpbiBzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWIgfHwgIXQuaGFzT3duUHJvcGVydHkoaykpIHtcclxuICAgICAgICAgICAgICAgICAgICB0W2tdID0gc1trXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdDtcclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlsIbnu5nlrprnmoTlpJrkuKrlr7nosaHnmoTlsZ7mgKflpI3liLbliLDnm67moIflr7nosaF0YXJnZXTkuIpcclxuICAgICAqIEBtZXRob2QgZXh0ZW5kMlxyXG4gICAgICogQHJlbWluZCDor6Xmlrnms5XlsIblvLrliLbmiormupDlr7nosaHkuIrnmoTlsZ7mgKflpI3liLbliLB0YXJnZXTlr7nosaHkuIpcclxuICAgICAqIEByZW1pbmQg6K+l5pa55rOV5pSv5oyB5Lik5Liq5Y+K5Lul5LiK55qE5Y+C5pWw77yMIOS7juesrOS6jOS4quWPguaVsOW8gOWni++8jCDlhbblsZ7mgKfpg73kvJrooqvlpI3liLbliLDnrKzkuIDkuKrlj4LmlbDkuIrjgIIg5aaC5p6c6YGH5Yiw5ZCM5ZCN55qE5bGe5oCn77yMXHJcbiAgICAgKiAgICAgICAgICDlsIbkvJropobnm5bmjonkuYvliY3nmoTlgLzjgIJcclxuICAgICAqIEBwYXJhbSB7IE9iamVjdCB9IHRhcmdldCDnm67moIflr7nosaHvvIwg5paw55qE5bGe5oCn5bCG6ZmE5Yqg5Yiw6K+l5a+56LGh5LiKXHJcbiAgICAgKiBAcGFyYW0geyBPYmplY3QuLi4gfSBzb3VyY2Ug5rqQ5a+56LGh77yMIOaUr+aMgeWkmuS4quWvueixoe+8jCDor6Xlr7nosaHnmoTlsZ7mgKfkvJrooqvpmYTliqDliLB0YXJnZXTlr7nosaHkuIpcclxuICAgICAqIEByZXR1cm4geyBPYmplY3QgfSDov5Tlm550YXJnZXTlr7nosaFcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKlxyXG4gICAgICogdmFyIHRhcmdldCA9IHt9LFxyXG4gICAgICogICAgIHNvdXJjZTEgPSB7IG5hbWU6ICdzb3VyY2UnLCBhZ2U6IDE3IH0sXHJcbiAgICAgKiAgICAgc291cmNlMiA9IHsgdGl0bGU6ICdkZXYnIH07XHJcbiAgICAgKlxyXG4gICAgICogVUUudXRpbHMuZXh0ZW5kMiggdGFyZ2V0LCBzb3VyY2UxLCBzb3VyY2UyICk7XHJcbiAgICAgKlxyXG4gICAgICogLy9vdXRwdXQ6IHsgbmFtZTogJ3NvdXJjZScsIGFnZTogMTcsIHRpdGxlOiAnZGV2JyB9XHJcbiAgICAgKiBjb25zb2xlLmxvZyggdGFyZ2V0ICk7XHJcbiAgICAgKlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIGV4dGVuZDI6ZnVuY3Rpb24gKHQpIHtcclxuICAgICAgICB2YXIgYSA9IGFyZ3VtZW50cztcclxuICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGEubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgdmFyIHggPSBhW2ldO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBrIGluIHgpIHtcclxuICAgICAgICAgICAgICAgIGlmICghdC5oYXNPd25Qcm9wZXJ0eShrKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRba10gPSB4W2tdO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0O1xyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOaooeaLn+e7p+aJv+acuuWItu+8jCDkvb/lvpdzdWJDbGFzc+e7p+aJv+iHqnN1cGVyQ2xhc3NcclxuICAgICAqIEBtZXRob2QgaW5oZXJpdHNcclxuICAgICAqIEBwYXJhbSB7IE9iamVjdCB9IHN1YkNsYXNzIOWtkOexu+WvueixoVxyXG4gICAgICogQHBhcmFtIHsgT2JqZWN0IH0gc3VwZXJDbGFzcyDotoXnsbvlr7nosaFcclxuICAgICAqIEB3YXJuaW5nIOivpeaWueazleWPquiDveiuqXN1YkNsYXNz57un5om/6LaF57G755qE5Y6f5Z6L77yMIHN1YkNsYXNz5a+56LGh6Ieq6Lqr55qE5bGe5oCn5ZKM5pa55rOV5LiN5Lya6KKr57un5om/XHJcbiAgICAgKiBAcmV0dXJuIHsgT2JqZWN0IH0g57un5om/c3VwZXJDbGFzc+WQjueahOWtkOexu+WvueixoVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIGZ1bmN0aW9uIFN1cGVyQ2xhc3MoKXtcclxuICAgICAqICAgICB0aGlzLm5hbWUgPSBcIuWwj+adjlwiO1xyXG4gICAgICogfVxyXG4gICAgICpcclxuICAgICAqIFN1cGVyQ2xhc3MucHJvdG90eXBlID0ge1xyXG4gICAgICogICAgIGhlbGxvOmZ1bmN0aW9uKHN0cil7XHJcbiAgICAgKiAgICAgICAgIGNvbnNvbGUubG9nKHRoaXMubmFtZSArIHN0cik7XHJcbiAgICAgKiAgICAgfVxyXG4gICAgICogfVxyXG4gICAgICpcclxuICAgICAqIGZ1bmN0aW9uIFN1YkNsYXNzKCl7XHJcbiAgICAgKiAgICAgdGhpcy5uYW1lID0gXCLlsI/lvKBcIjtcclxuICAgICAqIH1cclxuICAgICAqXHJcbiAgICAgKiBVRS51dGlscy5pbmhlcml0cyhTdWJDbGFzcyxTdXBlckNsYXNzKTtcclxuICAgICAqXHJcbiAgICAgKiB2YXIgc3ViID0gbmV3IFN1YkNsYXNzKCk7XHJcbiAgICAgKiAvL291dHB1dDogJ+Wwj+W8oOaXqeS4iuWlvSFcclxuICAgICAqIHN1Yi5oZWxsbyhcIuaXqeS4iuWlvSFcIik7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgaW5oZXJpdHM6ZnVuY3Rpb24gKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7XHJcbiAgICAgICAgdmFyIG9sZFAgPSBzdWJDbGFzcy5wcm90b3R5cGUsXHJcbiAgICAgICAgICAgIG5ld1AgPSB1dGlscy5tYWtlSW5zdGFuY2Uoc3VwZXJDbGFzcy5wcm90b3R5cGUpO1xyXG4gICAgICAgIHV0aWxzLmV4dGVuZChuZXdQLCBvbGRQLCB0cnVlKTtcclxuICAgICAgICBzdWJDbGFzcy5wcm90b3R5cGUgPSBuZXdQO1xyXG4gICAgICAgIHJldHVybiAobmV3UC5jb25zdHJ1Y3RvciA9IHN1YkNsYXNzKTtcclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnlKjmjIflrprnmoRjb250ZXh05a+56LGh5L2c5Li65Ye95pWwZm7nmoTkuIrkuIvmlodcclxuICAgICAqIEBtZXRob2QgYmluZFxyXG4gICAgICogQHBhcmFtIHsgRnVuY3Rpb24gfSBmbiDpnIDopoHnu5HlrprkuIrkuIvmlofnmoTlh73mlbDlr7nosaFcclxuICAgICAqIEBwYXJhbSB7IE9iamVjdCB9IGNvbnRlbnQg5Ye95pWwZm7mlrDnmoTkuIrkuIvmloflr7nosaFcclxuICAgICAqIEByZXR1cm4geyBGdW5jdGlvbiB9IOS4gOS4quaWsOeahOWHveaVsO+8jCDor6Xlh73mlbDkvZzkuLrljp/lp4vlh73mlbBmbueahOS7o+eQhu+8jCDlsIblrozmiJBmbueahOS4iuS4i+aWh+iwg+aNouW3peS9nOOAglxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqXHJcbiAgICAgKiB2YXIgbmFtZSA9ICd3aW5kb3cnLFxyXG4gICAgICogICAgIG5ld1Rlc3QgPSBudWxsO1xyXG4gICAgICpcclxuICAgICAqIGZ1bmN0aW9uIHRlc3QgKCkge1xyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCB0aGlzLm5hbWUgKTtcclxuICAgICAqIH1cclxuICAgICAqXHJcbiAgICAgKiBuZXdUZXN0ID0gVUUudXRpbHMuYmluZCggdGVzdCwgeyBuYW1lOiAnb2JqZWN0JyB9ICk7XHJcbiAgICAgKlxyXG4gICAgICogLy9vdXRwdXQ6IG9iamVjdFxyXG4gICAgICogbmV3VGVzdCgpO1xyXG4gICAgICpcclxuICAgICAqIC8vb3V0cHV0OiB3aW5kb3dcclxuICAgICAqIHRlc3QoKTtcclxuICAgICAqXHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgYmluZDpmdW5jdGlvbiAoZm4sIGNvbnRleHQpIHtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkoY29udGV4dCwgYXJndW1lbnRzKTtcclxuICAgICAgICB9O1xyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWIm+W7uuW7tui/n+aMh+WumuaXtumXtOWQjuaJp+ihjOeahOWHveaVsGZuXHJcbiAgICAgKiBAbWV0aG9kIGRlZmVyXHJcbiAgICAgKiBAcGFyYW0geyBGdW5jdGlvbiB9IGZuIOmcgOimgeW7tui/n+aJp+ihjOeahOWHveaVsOWvueixoVxyXG4gICAgICogQHBhcmFtIHsgaW50IH0gZGVsYXkg5bu26L+f55qE5pe26Ze077yMIOWNleS9jeaYr+avq+enklxyXG4gICAgICogQHdhcm5pbmcg6K+l5pa55rOV55qE5pe26Ze05o6n5Yi25piv5LiN57K+56Gu55qE77yM5LuF5LuF5Y+q6IO95L+d6K+B5Ye95pWw55qE5omn6KGM5piv5Zyo57uZ5a6a55qE5pe26Ze05LmL5ZCO77yMXHJcbiAgICAgKiAgICAgICAgICAg6ICM5LiN6IO95L+d6K+B5Yia5aW95Yiw6L6+5bu26L+f5pe26Ze05pe25omn6KGM44CCXHJcbiAgICAgKiBAcmV0dXJuIHsgRnVuY3Rpb24gfSDnm67moIflh73mlbBmbueahOS7o+eQhuWHveaVsO+8jCDlj6rmnInmiafooYzor6Xlh73mlbDmiY3og73otbfliLDlu7bml7bmlYjmnpxcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiB2YXIgc3RhcnQgPSAwO1xyXG4gICAgICpcclxuICAgICAqIGZ1bmN0aW9uIHRlc3QoKXtcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggbmV3IERhdGUoKSAtIHN0YXJ0ICk7XHJcbiAgICAgKiB9XHJcbiAgICAgKlxyXG4gICAgICogdmFyIHRlc3REZWZlciA9IFVFLnV0aWxzLmRlZmVyKCB0ZXN0LCAxMDAwICk7XHJcbiAgICAgKiAvL1xyXG4gICAgICogc3RhcnQgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICogLy9vdXRwdXQ6ICjlpKfnuqblnKgxMDAw5q+r56eS5LmL5ZCO6L6T5Ye6KSAxMDAwXHJcbiAgICAgKiB0ZXN0RGVmZXIoKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDliJvlu7rlu7bov5/mjIflrprml7bpl7TlkI7miafooYznmoTlh73mlbBmbiwg5aaC5p6c5Zyo5bu26L+f5pe26Ze05YaF5YaN5qyh5omn6KGM6K+l5pa55rOV77yMIOWwhuS8muagueaNruaMh+WumueahGV4Y2x1c2lvbueahOWAvO+8jFxyXG4gICAgICog5Yaz5a6a5piv5ZCm5Y+W5raI5YmN5LiA5qyh5Ye95pWw55qE5omn6KGM77yMIOWmguaenGV4Y2x1c2lvbueahOWAvOS4unRydWXvvIwg5YiZ5Y+W5raI5omn6KGM77yM5Y+N5LmL77yM5bCG57un57ut5omn6KGM5YmN5LiA5Liq5pa55rOV44CCXHJcbiAgICAgKiBAbWV0aG9kIGRlZmVyXHJcbiAgICAgKiBAcGFyYW0geyBGdW5jdGlvbiB9IGZuIOmcgOimgeW7tui/n+aJp+ihjOeahOWHveaVsOWvueixoVxyXG4gICAgICogQHBhcmFtIHsgaW50IH0gZGVsYXkg5bu26L+f55qE5pe26Ze077yMIOWNleS9jeaYr+avq+enklxyXG4gICAgICogQHBhcmFtIHsgQm9vbGVhbiB9IGV4Y2x1c2lvbiDlpoLmnpzlnKjlu7bov5/ml7bpl7TlhoXlho3mrKHmiafooYzor6Xlh73mlbDvvIzor6XlgLzlsIblhrPlrprmmK/lkKblj5bmtojmiafooYzliY3kuIDmrKHlh73mlbDnmoTmiafooYzvvIxcclxuICAgICAqICAgICAgICAgICAgICAgICAgICAg5YC85Li6dHJ1ZeihqOekuuWPlua2iOaJp+ihjO+8jCDlj43kuYvliJnlsIblnKjmiafooYzliY3kuIDmrKHlh73mlbDkuYvlkI7miY3miafooYzmnKzmrKHlh73mlbDosIPnlKjjgIJcclxuICAgICAqIEB3YXJuaW5nIOivpeaWueazleeahOaXtumXtOaOp+WItuaYr+S4jeeyvuehrueahO+8jOS7heS7heWPquiDveS/neivgeWHveaVsOeahOaJp+ihjOaYr+WcqOe7meWumueahOaXtumXtOS5i+WQju+8jFxyXG4gICAgICogICAgICAgICAgIOiAjOS4jeiDveS/neivgeWImuWlveWIsOi+vuW7tui/n+aXtumXtOaXtuaJp+ihjOOAglxyXG4gICAgICogQHJldHVybiB7IEZ1bmN0aW9uIH0g55uu5qCH5Ye95pWwZm7nmoTku6PnkIblh73mlbDvvIwg5Y+q5pyJ5omn6KGM6K+l5Ye95pWw5omN6IO96LW35Yiw5bu25pe25pWI5p6cXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICpcclxuICAgICAqIGZ1bmN0aW9uIHRlc3QoKXtcclxuICAgICAqICAgICBjb25zb2xlLmxvZygxKTtcclxuICAgICAqIH1cclxuICAgICAqXHJcbiAgICAgKiB2YXIgdGVzdERlZmVyID0gVUUudXRpbHMuZGVmZXIoIHRlc3QsIDEwMDAsIHRydWUgKTtcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogKOS4pOasoeiwg+eUqOS7heacieS4gOasoei+k+WHuikgMVxyXG4gICAgICogdGVzdERlZmVyKCk7XHJcbiAgICAgKiB0ZXN0RGVmZXIoKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBkZWZlcjpmdW5jdGlvbiAoZm4sIGRlbGF5LCBleGNsdXNpb24pIHtcclxuICAgICAgICB2YXIgdGltZXJJRDtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAoZXhjbHVzaW9uKSB7XHJcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXJJRCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGltZXJJRCA9IHNldFRpbWVvdXQoZm4sIGRlbGF5KTtcclxuICAgICAgICB9O1xyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluWFg+e0oGl0ZW3lnKjmlbDnu4RhcnJheeS4remmluasoeWHuueOsOeahOS9jee9riwg5aaC5p6c5pyq5om+5YiwaXRlbe+8jCDliJnov5Tlm54tMVxyXG4gICAgICogQG1ldGhvZCBpbmRleE9mXHJcbiAgICAgKiBAcmVtaW5kIOivpeaWueazleeahOWMuemFjei/h+eoi+S9v+eUqOeahOaYr+aBkuetieKAnD09PeKAnVxyXG4gICAgICogQHBhcmFtIHsgQXJyYXkgfSBhcnJheSDpnIDopoHmn6Xmib7nmoTmlbDnu4Tlr7nosaFcclxuICAgICAqIEBwYXJhbSB7ICogfSBpdGVtIOmcgOimgeWcqOebruagh+aVsOe7hOS4reafpeaJvueahOWAvFxyXG4gICAgICogQHJldHVybiB7IGludCB9IOi/lOWbnml0ZW3lnKjnm67moIfmlbDnu4RhcnJheeS4remmluasoeWHuueOsOeahOS9jee9ru+8jCDlpoLmnpzlnKjmlbDnu4TkuK3mnKrmib7liLBpdGVt77yMIOWImei/lOWbni0xXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogdmFyIGl0ZW0gPSAxLFxyXG4gICAgICogICAgIGFyciA9IFsgMywgNCwgNiwgOCwgMSwgMSwgMiBdO1xyXG4gICAgICpcclxuICAgICAqIC8vb3V0cHV0OiA0XHJcbiAgICAgKiBjb25zb2xlLmxvZyggVUUudXRpbHMuaW5kZXhPZiggYXJyLCBpdGVtICkgKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDojrflj5blhYPntKBpdGVt5pWw57uEYXJyYXnkuK3pppbmrKHlh7rnjrDnmoTkvY3nva4sIOWmguaenOacquaJvuWIsGl0ZW3vvIwg5YiZ6L+U5ZueLTHjgILpgJrov4dzdGFydOeahOWAvOWPr+S7peaMh+WumuaQnOe0oueahOi1t+Wni+S9jee9ruOAglxyXG4gICAgICogQG1ldGhvZCBpbmRleE9mXHJcbiAgICAgKiBAcmVtaW5kIOivpeaWueazleeahOWMuemFjei/h+eoi+S9v+eUqOeahOaYr+aBkuetieKAnD09PeKAnVxyXG4gICAgICogQHBhcmFtIHsgQXJyYXkgfSBhcnJheSDpnIDopoHmn6Xmib7nmoTmlbDnu4Tlr7nosaFcclxuICAgICAqIEBwYXJhbSB7ICogfSBpdGVtIOmcgOimgeWcqOebruagh+aVsOe7hOS4reafpeaJvueahOWAvFxyXG4gICAgICogQHBhcmFtIHsgaW50IH0gc3RhcnQg5pCc57Si55qE6LW35aeL5L2N572uXHJcbiAgICAgKiBAcmV0dXJuIHsgaW50IH0g6L+U5ZueaXRlbeWcqOebruagh+aVsOe7hGFycmF55Lit55qEc3RhcnTkvY3nva7kuYvlkI7pppbmrKHlh7rnjrDnmoTkvY3nva7vvIwg5aaC5p6c5Zyo5pWw57uE5Lit5pyq5om+5YiwaXRlbe+8jCDliJnov5Tlm54tMVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIHZhciBpdGVtID0gMSxcclxuICAgICAqICAgICBhcnIgPSBbIDMsIDQsIDYsIDgsIDEsIDIsIDgsIDMsIDIsIDEsIDEsIDQgXTtcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogOVxyXG4gICAgICogY29uc29sZS5sb2coIFVFLnV0aWxzLmluZGV4T2YoIGFyciwgaXRlbSwgNSApICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgaW5kZXhPZjpmdW5jdGlvbiAoYXJyYXksIGl0ZW0sIHN0YXJ0KSB7XHJcbiAgICAgICAgdmFyIGluZGV4ID0gLTE7XHJcbiAgICAgICAgc3RhcnQgPSB0aGlzLmlzTnVtYmVyKHN0YXJ0KSA/IHN0YXJ0IDogMDtcclxuICAgICAgICB0aGlzLmVhY2goYXJyYXksIGZ1bmN0aW9uICh2LCBpKSB7XHJcbiAgICAgICAgICAgIGlmIChpID49IHN0YXJ0ICYmIHYgPT09IGl0ZW0pIHtcclxuICAgICAgICAgICAgICAgIGluZGV4ID0gaTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBpbmRleDtcclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnp7vpmaTmlbDnu4RhcnJheeS4reaJgOacieeahOWFg+e0oGl0ZW1cclxuICAgICAqIEBtZXRob2QgcmVtb3ZlSXRlbVxyXG4gICAgICogQHBhcmFtIHsgQXJyYXkgfSBhcnJheSDopoHnp7vpmaTlhYPntKDnmoTnm67moIfmlbDnu4RcclxuICAgICAqIEBwYXJhbSB7ICogfSBpdGVtIOWwhuimgeiiq+enu+mZpOeahOWFg+e0oFxyXG4gICAgICogQHJlbWluZCDor6Xmlrnms5XnmoTljLnphY3ov4fnqIvkvb/nlKjnmoTmmK/mgZLnrYnigJw9PT3igJ1cclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiB2YXIgYXJyID0gWyA0LCA1LCA3LCAxLCAzLCA0LCA2IF07XHJcbiAgICAgKlxyXG4gICAgICogVUUudXRpbHMucmVtb3ZlSXRlbSggYXJyLCA0ICk7XHJcbiAgICAgKiAvL291dHB1dDogWyA1LCA3LCAxLCAzLCA2IF1cclxuICAgICAqIGNvbnNvbGUubG9nKCBhcnIgKTtcclxuICAgICAqXHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgcmVtb3ZlSXRlbTpmdW5jdGlvbiAoYXJyYXksIGl0ZW0pIHtcclxuICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICAgICAgICBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pIHtcclxuICAgICAgICAgICAgICAgIGFycmF5LnNwbGljZShpLCAxKTtcclxuICAgICAgICAgICAgICAgIGktLTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDliKDpmaTlrZfnrKbkuLJzdHLnmoTpppblsL7nqbrmoLxcclxuICAgICAqIEBtZXRob2QgdHJpbVxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gc3RyIOmcgOimgeWIoOmZpOmmluWwvuepuuagvOeahOWtl+espuS4slxyXG4gICAgICogQHJldHVybiB7IFN0cmluZyB9IOWIoOmZpOS6hummluWwvueahOepuuagvOWQjueahOWtl+espuS4slxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqXHJcbiAgICAgKiB2YXIgc3RyID0gXCIgVUVkdGlvciBcIjtcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogOVxyXG4gICAgICogY29uc29sZS5sb2coIHN0ci5sZW5ndGggKTtcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogN1xyXG4gICAgICogY29uc29sZS5sb2coIFVFLnV0aWxzLnRyaW0oIFwiIFVFZHRpb3IgXCIgKS5sZW5ndGggKTtcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogOVxyXG4gICAgICogY29uc29sZS5sb2coIHN0ci5sZW5ndGggKTtcclxuICAgICAqXHJcbiAgICAgKiAgYGBgXHJcbiAgICAgKi9cclxuICAgIHRyaW06ZnVuY3Rpb24gKHN0cikge1xyXG4gICAgICAgIHJldHVybiBzdHIucmVwbGFjZSgvKF5bIFxcdFxcblxccl0rKXwoWyBcXHRcXG5cXHJdKyQpL2csICcnKTtcclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlsIblrZfnrKbkuLJzdHLku6UnLCfliIbpmpTmiJDmlbDnu4TlkI7vvIzlsIbor6XmlbDnu4TovazmjaLmiJDlk4jluIzlr7nosaHvvIwg5YW255Sf5oiQ55qEaGFzaOWvueixoeeahGtleeS4uuaVsOe7hOS4reeahOWFg+e0oO+8jCB2YWx1ZeS4ujFcclxuICAgICAqIEBtZXRob2QgbGlzdFRvTWFwXHJcbiAgICAgKiBAd2FybmluZyDor6Xmlrnms5XlnKjnlJ/miJDnmoRoYXNo5a+56LGh5Lit77yM5Lya5Li65q+P5LiA5Liqa2V55ZCM5pe255Sf5oiQ5LiA5Liq5Y+m5LiA5Liq5YWo5aSn5YaZ55qEa2V544CCXHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBzdHIg6K+l5a2X56ym5Liy5bCG6KKr5LulJywn5YiG5Ymy5Li65pWw57uE77yMIOeEtuWQjui/m+ihjOi9rOWMllxyXG4gICAgICogQHJldHVybiB7IE9iamVjdCB9IOi9rOWMluS5i+WQjueahGhhc2jlr7nosaFcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKlxyXG4gICAgICogLy9vdXRwdXQ6IE9iamVjdCB7VUVkdGlvcjogMSwgVUVEVElPUjogMSwgSGVsbG86IDEsIEhFTExPOiAxfVxyXG4gICAgICogY29uc29sZS5sb2coIFVFLnV0aWxzLmxpc3RUb01hcCggJ1VFZHRpb3IsSGVsbG8nICkgKTtcclxuICAgICAqXHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5bCG5a2X56ym5Liy5pWw57uE6L2s5o2i5oiQ5ZOI5biM5a+56LGh77yMIOWFtueUn+aIkOeahGhhc2jlr7nosaHnmoRrZXnkuLrmlbDnu4TkuK3nmoTlhYPntKDvvIwgdmFsdWXkuLoxXHJcbiAgICAgKiBAbWV0aG9kIGxpc3RUb01hcFxyXG4gICAgICogQHdhcm5pbmcg6K+l5pa55rOV5Zyo55Sf5oiQ55qEaGFzaOWvueixoeS4re+8jOS8muS4uuavj+S4gOS4qmtleeWQjOaXtueUn+aIkOS4gOS4quWPpuS4gOS4quWFqOWkp+WGmeeahGtleeOAglxyXG4gICAgICogQHBhcmFtIHsgQXJyYXkgfSBhcnIg5a2X56ym5Liy5pWw57uEXHJcbiAgICAgKiBAcmV0dXJuIHsgT2JqZWN0IH0g6L2s5YyW5LmL5ZCO55qEaGFzaOWvueixoVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogT2JqZWN0IHtVRWR0aW9yOiAxLCBVRURUSU9SOiAxLCBIZWxsbzogMSwgSEVMTE86IDF9XHJcbiAgICAgKiBjb25zb2xlLmxvZyggVUUudXRpbHMubGlzdFRvTWFwKCBbICdVRWR0aW9yJywgJ0hlbGxvJyBdICkgKTtcclxuICAgICAqXHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgbGlzdFRvTWFwOmZ1bmN0aW9uIChsaXN0KSB7XHJcbiAgICAgICAgaWYgKCFsaXN0KXJldHVybiB7fTtcclxuICAgICAgICBsaXN0ID0gdXRpbHMuaXNBcnJheShsaXN0KSA/IGxpc3QgOiBsaXN0LnNwbGl0KCcsJyk7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpLCBvYmogPSB7fTsgY2kgPSBsaXN0W2krK107KSB7XHJcbiAgICAgICAgICAgIG9ialtjaS50b1VwcGVyQ2FzZSgpXSA9IG9ialtjaV0gPSAxO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gb2JqO1xyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWwhnN0cuS4reeahGh0bWznrKblj7fovazkuYks5bCG6L2s5LmJ4oCcJ++8jCbvvIw877yMXCLvvIw+4oCd5LqU5Liq5a2X56ymXHJcbiAgICAgKiBAbWV0aG9kIHVuaHRtbFxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gc3RyIOmcgOimgei9rOS5ieeahOWtl+espuS4slxyXG4gICAgICogQHJldHVybiB7IFN0cmluZyB9IOi9rOS5ieWQjueahOWtl+espuS4slxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIHZhciBodG1sID0gJzxib2R5PiY8L2JvZHk+JztcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogJmx0O2JvZHkmZ3Q7JmFtcDsmbHQ7L2JvZHkmZ3Q7XHJcbiAgICAgKiBjb25zb2xlLmxvZyggVUUudXRpbHMudW5odG1sKCBodG1sICkgKTtcclxuICAgICAqXHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgdW5odG1sOmZ1bmN0aW9uIChzdHIsIHJlZykge1xyXG4gICAgICAgIHJldHVybiBzdHIgPyBzdHIucmVwbGFjZShyZWcgfHwgL1smPFwiPiddKD86KGFtcHxsdHxxdW90fGd0fCMzOXxuYnNwfCNcXGQrKTspPy9nLCBmdW5jdGlvbiAoYSwgYikge1xyXG4gICAgICAgICAgICBpZiAoYikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGE7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgICc8JzonJmx0OycsXHJcbiAgICAgICAgICAgICAgICAgICAgJyYnOicmYW1wOycsXHJcbiAgICAgICAgICAgICAgICAgICAgJ1wiJzonJnF1b3Q7JyxcclxuICAgICAgICAgICAgICAgICAgICAnPic6JyZndDsnLFxyXG4gICAgICAgICAgICAgICAgICAgIFwiJ1wiOicmIzM5OydcclxuICAgICAgICAgICAgICAgIH1bYV1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9KSA6ICcnO1xyXG4gICAgfSxcclxuICAgIC8qKlxyXG4gICAgICog5bCGdXJs5Lit55qEaHRtbOWtl+espui9rOS5ie+8jCDku4XovazkuYkgICcsIFwiLCA8LCA+IOWbm+S4quWtl+esplxyXG4gICAgICogQHBhcmFtICB7IFN0cmluZyB9IHN0ciDpnIDopoHovazkuYnnmoTlrZfnrKbkuLJcclxuICAgICAqIEBwYXJhbSAgeyBSZWdFeHAgfSByZWcg6Ieq5a6a5LmJ55qE5q2j5YiZXHJcbiAgICAgKiBAcmV0dXJuIHsgU3RyaW5nIH0gICAgIOi9rOS5ieWQjueahOWtl+espuS4slxyXG4gICAgICovXHJcbiAgICB1bmh0bWxGb3JVcmw6ZnVuY3Rpb24gKHN0ciwgcmVnKSB7XHJcbiAgICAgICAgcmV0dXJuIHN0ciA/IHN0ci5yZXBsYWNlKHJlZyB8fCAvWzxcIj4nXS9nLCBmdW5jdGlvbiAoYSkge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgJzwnOicmbHQ7JyxcclxuICAgICAgICAgICAgICAgICcmJzonJmFtcDsnLFxyXG4gICAgICAgICAgICAgICAgJ1wiJzonJnF1b3Q7JyxcclxuICAgICAgICAgICAgICAgICc+JzonJmd0OycsXHJcbiAgICAgICAgICAgICAgICBcIidcIjonJiMzOTsnXHJcbiAgICAgICAgICAgIH1bYV1cclxuXHJcbiAgICAgICAgfSkgOiAnJztcclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlsIZzdHLkuK3nmoTovazkuYnlrZfnrKbov5jljp/miJBodG1s5a2X56ymXHJcbiAgICAgKiBAc2VlIFVFLnV0aWxzLnVuaHRtbChTdHJpbmcpO1xyXG4gICAgICogQG1ldGhvZCBodG1sXHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBzdHIg6ZyA6KaB6YCG6L2s5LmJ55qE5a2X56ym5LiyXHJcbiAgICAgKiBAcmV0dXJuIHsgU3RyaW5nIH0g6YCG6L2s5LmJ5ZCO55qE5a2X56ym5LiyXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICpcclxuICAgICAqIHZhciBzdHIgPSAnJmx0O2JvZHkmZ3Q7JmFtcDsmbHQ7L2JvZHkmZ3Q7JztcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogPGJvZHk+JjwvYm9keT5cclxuICAgICAqIGNvbnNvbGUubG9nKCBVRS51dGlscy5odG1sKCBzdHIgKSApO1xyXG4gICAgICpcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBodG1sOmZ1bmN0aW9uIChzdHIpIHtcclxuICAgICAgICByZXR1cm4gc3RyID8gc3RyLnJlcGxhY2UoLyYoKGd8bHxxdW8pdHxhbXB8IzM5fG5ic3ApOy9nLCBmdW5jdGlvbiAobSkge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgJyZsdDsnOic8JyxcclxuICAgICAgICAgICAgICAgICcmYW1wOyc6JyYnLFxyXG4gICAgICAgICAgICAgICAgJyZxdW90Oyc6J1wiJyxcclxuICAgICAgICAgICAgICAgICcmZ3Q7JzonPicsXHJcbiAgICAgICAgICAgICAgICAnJiMzOTsnOlwiJ1wiLFxyXG4gICAgICAgICAgICAgICAgJyZuYnNwOyc6JyAnXHJcbiAgICAgICAgICAgIH1bbV1cclxuICAgICAgICB9KSA6ICcnO1xyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWwhmNzc+agt+W8j+i9rOaNouS4uumpvOWzsOeahOW9ouW8j1xyXG4gICAgICogQG1ldGhvZCBjc3NTdHlsZVRvRG9tU3R5bGVcclxuICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGNzc05hbWUg6ZyA6KaB6L2s5o2i55qEY3Nz5qC35byP5ZCNXHJcbiAgICAgKiBAcmV0dXJuIHsgU3RyaW5nIH0g6L2s5o2i5oiQ6am85bOw5b2i5byP5ZCO55qEY3Nz5qC35byP5ZCNXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICpcclxuICAgICAqIHZhciBzdHIgPSAnYm9yZGVyLXRvcCc7XHJcbiAgICAgKlxyXG4gICAgICogLy9vdXRwdXQ6IGJvcmRlclRvcFxyXG4gICAgICogY29uc29sZS5sb2coIFVFLnV0aWxzLmNzc1N0eWxlVG9Eb21TdHlsZSggc3RyICkgKTtcclxuICAgICAqXHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgY3NzU3R5bGVUb0RvbVN0eWxlOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgdGVzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLnN0eWxlLFxyXG4gICAgICAgICAgICBjYWNoZSA9IHtcclxuICAgICAgICAgICAgICAgICdmbG9hdCc6dGVzdC5jc3NGbG9hdCAhPSB1bmRlZmluZWQgPyAnY3NzRmxvYXQnIDogdGVzdC5zdHlsZUZsb2F0ICE9IHVuZGVmaW5lZCA/ICdzdHlsZUZsb2F0JyA6ICdmbG9hdCdcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChjc3NOYW1lKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjYWNoZVtjc3NOYW1lXSB8fCAoY2FjaGVbY3NzTmFtZV0gPSBjc3NOYW1lLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvLS4vZywgZnVuY3Rpb24gKG1hdGNoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2guY2hhckF0KDEpLnRvVXBwZXJDYXNlKCk7XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICB9O1xyXG4gICAgfSgpLFxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yqo5oCB5Yqg6L295paH5Lu25YiwZG9j5LitXHJcbiAgICAgKiBAbWV0aG9kIGxvYWRGaWxlXHJcbiAgICAgKiBAcGFyYW0geyBEb21Eb2N1bWVudCB9IGRvY3VtZW50IOmcgOimgeWKoOi9vei1hOa6kOaWh+S7tueahOaWh+aho+WvueixoVxyXG4gICAgICogQHBhcmFtIHsgT2JqZWN0IH0gb3B0aW9ucyDliqDovb3otYTmupDmlofku7bnmoTlsZ7mgKfpm4blkIjvvIwg5Y+W5YC86K+35Y+C6ICD5Luj56CB56S65L6LXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICpcclxuICAgICAqIFVFLnV0aWxzLmxvYWRGaWxlKCBkb2N1bWVudCwge1xyXG4gICAgICogICAgIHNyYzpcInRlc3QuanNcIixcclxuICAgICAqICAgICB0YWc6XCJzY3JpcHRcIixcclxuICAgICAqICAgICB0eXBlOlwidGV4dC9qYXZhc2NyaXB0XCIsXHJcbiAgICAgKiAgICAgZGVmZXI6XCJkZWZlclwiXHJcbiAgICAgKiB9ICk7XHJcbiAgICAgKlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWKqOaAgeWKoOi9veaWh+S7tuWIsGRvY+S4re+8jOWKoOi9veaIkOWKn+WQjuaJp+ihjOeahOWbnuiwg+WHveaVsGZuXHJcbiAgICAgKiBAbWV0aG9kIGxvYWRGaWxlXHJcbiAgICAgKiBAcGFyYW0geyBEb21Eb2N1bWVudCB9IGRvY3VtZW50IOmcgOimgeWKoOi9vei1hOa6kOaWh+S7tueahOaWh+aho+WvueixoVxyXG4gICAgICogQHBhcmFtIHsgT2JqZWN0IH0gb3B0aW9ucyDliqDovb3otYTmupDmlofku7bnmoTlsZ7mgKfpm4blkIjvvIwg6K+l6ZuG5ZCI5pSv5oyB55qE5YC85pivc2NyaXB05qCH562+5ZKMc3R5bGXmoIfnrb7mlK/mjIHnmoTmiYDmnInlsZ7mgKfjgIJcclxuICAgICAqIEBwYXJhbSB7IEZ1bmN0aW9uIH0gZm4g6LWE5rqQ5paH5Lu25Yqg6L295oiQ5Yqf5LmL5ZCO5omn6KGM55qE5Zue6LCDXHJcbiAgICAgKiBAd2FybmluZyDlr7nkuo7lnKjlkIzkuIDkuKrmlofmoaPkuK3lpJrmrKHliqDovb3lkIzkuIBVUkznmoTmlofku7bvvIwg6K+l5pa55rOV5Lya5Zyo56ys5LiA5qyh5Yqg6L295LmL5ZCO57yT5a2Y6K+l6K+35rGC77yMXHJcbiAgICAgKiAgICAgICAgICAg5Zyo5q2k5LmL5ZCO55qE5omA5pyJ5ZCM5LiAVVJM55qE6K+35rGC77yMIOWwhuS8muebtOaOpeinpuWPkeWbnuiwg+OAglxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqXHJcbiAgICAgKiBVRS51dGlscy5sb2FkRmlsZSggZG9jdW1lbnQsIHtcclxuICAgICAqICAgICBzcmM6XCJ0ZXN0LmpzXCIsXHJcbiAgICAgKiAgICAgdGFnOlwic2NyaXB0XCIsXHJcbiAgICAgKiAgICAgdHlwZTpcInRleHQvamF2YXNjcmlwdFwiLFxyXG4gICAgICogICAgIGRlZmVyOlwiZGVmZXJcIlxyXG4gICAgICogfSwgZnVuY3Rpb24gKCkge1xyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCfliqDovb3miJDlip8nKTtcclxuICAgICAqIH0gKTtcclxuICAgICAqXHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgbG9hZEZpbGU6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciB0bXBMaXN0ID0gW107XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIGdldEl0ZW0oZG9jLCBvYmopIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSB0bXBMaXN0W2krK107KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNpLmRvYyA9PT0gZG9jICYmIGNpLnVybCA9PSAob2JqLnNyYyB8fCBvYmouaHJlZikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGRvYywgb2JqLCBmbikge1xyXG4gICAgICAgICAgICB2YXIgaXRlbSA9IGdldEl0ZW0oZG9jLCBvYmopO1xyXG4gICAgICAgICAgICBpZiAoaXRlbSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0ucmVhZHkpIHtcclxuICAgICAgICAgICAgICAgICAgICBmbiAmJiBmbigpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBpdGVtLmZ1bnMucHVzaChmbilcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0bXBMaXN0LnB1c2goe1xyXG4gICAgICAgICAgICAgICAgZG9jOmRvYyxcclxuICAgICAgICAgICAgICAgIHVybDpvYmouc3JjIHx8IG9iai5ocmVmLFxyXG4gICAgICAgICAgICAgICAgZnVuczpbZm5dXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBpZiAoIWRvYy5ib2R5KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgaHRtbCA9IFtdO1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgcCBpbiBvYmopIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocCA9PSAndGFnJyljb250aW51ZTtcclxuICAgICAgICAgICAgICAgICAgICBodG1sLnB1c2gocCArICc9XCInICsgb2JqW3BdICsgJ1wiJylcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGRvYy53cml0ZSgnPCcgKyBvYmoudGFnICsgJyAnICsgaHRtbC5qb2luKCcgJykgKyAnID48LycgKyBvYmoudGFnICsgJz4nKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAob2JqLmlkICYmIGRvYy5nZXRFbGVtZW50QnlJZChvYmouaWQpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBkb2MuY3JlYXRlRWxlbWVudChvYmoudGFnKTtcclxuICAgICAgICAgICAgZGVsZXRlIG9iai50YWc7XHJcbiAgICAgICAgICAgIGZvciAodmFyIHAgaW4gb2JqKSB7XHJcbiAgICAgICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShwLCBvYmpbcF0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsZW1lbnQub25sb2FkID0gZWxlbWVudC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMucmVhZHlTdGF0ZSB8fCAvbG9hZGVkfGNvbXBsZXRlLy50ZXN0KHRoaXMucmVhZHlTdGF0ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBpdGVtID0gZ2V0SXRlbShkb2MsIG9iaik7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uZnVucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0ucmVhZHkgPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBmaTsgZmkgPSBpdGVtLmZ1bnMucG9wKCk7KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQub25sb2FkID0gZWxlbWVudC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBlbGVtZW50Lm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignVGhlIGxvYWQgJyArIChvYmouaHJlZiB8fCBvYmouc3JjKSArICcgZmFpbHMsY2hlY2sgdGhlIHVybCBzZXR0aW5ncyBvZiBmaWxlIHVlZGl0b3IuY29uZmlnLmpzICcpXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGRvYy5nZXRFbGVtZW50c0J5VGFnTmFtZShcImhlYWRcIilbMF0uYXBwZW5kQ2hpbGQoZWxlbWVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgfSgpLFxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yik5patb2Jq5a+56LGh5piv5ZCm5Li656m6XHJcbiAgICAgKiBAbWV0aG9kIGlzRW1wdHlPYmplY3RcclxuICAgICAqIEBwYXJhbSB7ICogfSBvYmog6ZyA6KaB5Yik5pat55qE5a+56LGhXHJcbiAgICAgKiBAcmVtaW5kIOWmguaenOWIpOaWreeahOWvueixoeaYr05VTEzvvIwg5bCG55u05o6l6L+U5ZuedHJ1Ze+8jCDlpoLmnpzmmK/mlbDnu4TkuJTkuLrnqbrvvIwg6L+U5ZuedHJ1Ze+8jCDlpoLmnpzmmK/lrZfnrKbkuLLvvIwg5LiU5a2X56ym5Liy5Li656m677yMXHJcbiAgICAgKiAgICAgICAgICDov5Tlm550cnVl77yMIOWmguaenOaYr+aZrumAmuWvueixoe+8jCDkuJTor6Xlr7nosaHmsqHmnInku7vkvZXlrp7kvovlsZ7mgKfvvIwg6L+U5ZuedHJ1ZVxyXG4gICAgICogQHJldHVybiB7IEJvb2xlYW4gfSDlr7nosaHmmK/lkKbkuLrnqbpcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKlxyXG4gICAgICogLy9vdXRwdXQ6IHRydWVcclxuICAgICAqIGNvbnNvbGUubG9nKCBVRS51dGlscy5pc0VtcHR5T2JqZWN0KCB7fSApICk7XHJcbiAgICAgKlxyXG4gICAgICogLy9vdXRwdXQ6IHRydWVcclxuICAgICAqIGNvbnNvbGUubG9nKCBVRS51dGlscy5pc0VtcHR5T2JqZWN0KCBbXSApICk7XHJcbiAgICAgKlxyXG4gICAgICogLy9vdXRwdXQ6IHRydWVcclxuICAgICAqIGNvbnNvbGUubG9nKCBVRS51dGlscy5pc0VtcHR5T2JqZWN0KCBcIlwiICkgKTtcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogZmFsc2VcclxuICAgICAqIGNvbnNvbGUubG9nKCBVRS51dGlscy5pc0VtcHR5T2JqZWN0KCB7IGtleTogMSB9ICkgKTtcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogZmFsc2VcclxuICAgICAqIGNvbnNvbGUubG9nKCBVRS51dGlscy5pc0VtcHR5T2JqZWN0KCBbMV0gKSApO1xyXG4gICAgICpcclxuICAgICAqIC8vb3V0cHV0OiBmYWxzZVxyXG4gICAgICogY29uc29sZS5sb2coIFVFLnV0aWxzLmlzRW1wdHlPYmplY3QoIFwiMVwiICkgKTtcclxuICAgICAqXHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgaXNFbXB0eU9iamVjdDpmdW5jdGlvbiAob2JqKSB7XHJcbiAgICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdHJ1ZTtcclxuICAgICAgICBpZiAodGhpcy5pc0FycmF5KG9iaikgfHwgdGhpcy5pc1N0cmluZyhvYmopKSByZXR1cm4gb2JqLmxlbmd0aCA9PT0gMDtcclxuICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHJldHVybiBmYWxzZTtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmiopyZ2LmoLzlvI/nmoTpopzoibLlgLzovazmjaLmiJAxNui/m+WItuagvOW8j1xyXG4gICAgICogQG1ldGhvZCBmaXhDb2xvclxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gcmdi5qC85byP55qE6aKc6Imy5YC8XHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIHJnYigyNTUsMjU1LDI1NSkgID0+IFwiI2ZmZmZmZlwiXHJcbiAgICAgKi9cclxuICAgIGZpeENvbG9yOmZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkge1xyXG4gICAgICAgIGlmICgvY29sb3IvaS50ZXN0KG5hbWUpICYmIC9yZ2JhPy8udGVzdCh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgdmFyIGFycmF5ID0gdmFsdWUuc3BsaXQoXCIsXCIpO1xyXG4gICAgICAgICAgICBpZiAoYXJyYXkubGVuZ3RoID4gMylcclxuICAgICAgICAgICAgICAgIHJldHVybiBcIlwiO1xyXG4gICAgICAgICAgICB2YWx1ZSA9IFwiI1wiO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY29sb3I7IGNvbG9yID0gYXJyYXlbaSsrXTspIHtcclxuICAgICAgICAgICAgICAgIGNvbG9yID0gcGFyc2VJbnQoY29sb3IucmVwbGFjZSgvW15cXGRdL2dpLCAnJyksIDEwKS50b1N0cmluZygxNik7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSArPSBjb2xvci5sZW5ndGggPT0gMSA/IFwiMFwiICsgY29sb3IgOiBjb2xvcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnRvVXBwZXJDYXNlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAgdmFsdWU7XHJcbiAgICB9LFxyXG4gICAgLyoqXHJcbiAgICAgKiDlj6rpkojlr7lib3JkZXIscGFkZGluZyxtYXJnaW7lgZrkuoblpITnkIbvvIzlm6DkuLrmgKfog73pl67pophcclxuICAgICAqIEBwdWJsaWNcclxuICAgICAqIEBmdW5jdGlvblxyXG4gICAgICogQHBhcmFtIHtTdHJpbmd9ICAgIHZhbCBzdHlsZeWtl+espuS4slxyXG4gICAgICovXHJcbiAgICBvcHRDc3M6ZnVuY3Rpb24gKHZhbCkge1xyXG4gICAgICAgIHZhciBwYWRkaW5nLCBtYXJnaW4sIGJvcmRlcjtcclxuICAgICAgICB2YWwgPSB2YWwucmVwbGFjZSgvKHBhZGRpbmd8bWFyZ2lufGJvcmRlcilcXC0oW146XSspOihbXjtdKyk7Py9naSwgZnVuY3Rpb24gKHN0ciwga2V5LCBuYW1lLCB2YWwpIHtcclxuICAgICAgICAgICAgaWYgKHZhbC5zcGxpdCgnICcpLmxlbmd0aCA9PSAxKSB7XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKGtleSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3BhZGRpbmcnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAhcGFkZGluZyAmJiAocGFkZGluZyA9IHt9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZ1tuYW1lXSA9IHZhbDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ21hcmdpbic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICFtYXJnaW4gJiYgKG1hcmdpbiA9IHt9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ2luW25hbWVdID0gdmFsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnYm9yZGVyJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbCA9PSAnaW5pdGlhbCcgPyAnJyA6IHN0cjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gc3RyO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBmdW5jdGlvbiBvcHQob2JqLCBuYW1lKSB7XHJcbiAgICAgICAgICAgIGlmICghb2JqKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHQgPSBvYmoudG9wICwgYiA9IG9iai5ib3R0b20sIGwgPSBvYmoubGVmdCwgciA9IG9iai5yaWdodCwgdmFsID0gJyc7XHJcbiAgICAgICAgICAgIGlmICghdCB8fCAhbCB8fCAhYiB8fCAhcikge1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgcCBpbiBvYmopIHtcclxuICAgICAgICAgICAgICAgICAgICB2YWwgKz0gJzsnICsgbmFtZSArICctJyArIHAgKyAnOicgKyBvYmpbcF0gKyAnOyc7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB2YWwgKz0gJzsnICsgbmFtZSArICc6JyArXHJcbiAgICAgICAgICAgICAgICAgICAgKHQgPT0gYiAmJiBiID09IGwgJiYgbCA9PSByID8gdCA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHQgPT0gYiAmJiBsID09IHIgPyAodCArICcgJyArIGwpIDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGwgPT0gciA/ICh0ICsgJyAnICsgbCArICcgJyArIGIpIDogKHQgKyAnICcgKyByICsgJyAnICsgYiArICcgJyArIGwpKSArICc7J1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB2YWw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB2YWwgKz0gb3B0KHBhZGRpbmcsICdwYWRkaW5nJykgKyBvcHQobWFyZ2luLCAnbWFyZ2luJyk7XHJcbiAgICAgICAgcmV0dXJuIHZhbC5yZXBsYWNlKC9eWyBcXG5cXHJcXHQ7XSp8WyBcXG5cXHJcXHRdKiQvLCAnJykucmVwbGFjZSgvOyhbIFxcblxcclxcdF0rKXxcXDE7L2csICc7JylcclxuICAgICAgICAgICAgLnJlcGxhY2UoLygmKChsfGcpdHxxdW90fCMzOSkpPzt7Mix9L2csIGZ1bmN0aW9uIChhLCBiKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYiA/IGIgKyBcIjs7XCIgOiAnOydcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5YWL6ZqG5a+56LGhXHJcbiAgICAgKiBAbWV0aG9kIGNsb25lXHJcbiAgICAgKiBAcGFyYW0geyBPYmplY3QgfSBzb3VyY2Ug5rqQ5a+56LGhXHJcbiAgICAgKiBAcmV0dXJuIHsgT2JqZWN0IH0gc291cmNl55qE5LiA5Liq5Ymv5pysXHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIOa3seW6puWFi+mahuWvueixoe+8jOWwhnNvdXJjZeeahOWxnuaAp+WFi+mahuWIsHRhcmdldOWvueixoe+8jCDkvJropobnm5Z0YXJnZXTph43lkI3nmoTlsZ7mgKfjgIJcclxuICAgICAqIEBtZXRob2QgY2xvbmVcclxuICAgICAqIEBwYXJhbSB7IE9iamVjdCB9IHNvdXJjZSDmupDlr7nosaFcclxuICAgICAqIEBwYXJhbSB7IE9iamVjdCB9IHRhcmdldCDnm67moIflr7nosaFcclxuICAgICAqIEByZXR1cm4geyBPYmplY3QgfSDpmYTliqDkuoZzb3VyY2Xlr7nosaHmiYDmnInlsZ7mgKfnmoR0YXJnZXTlr7nosaFcclxuICAgICAqL1xyXG4gICAgY2xvbmU6ZnVuY3Rpb24gKHNvdXJjZSwgdGFyZ2V0KSB7XHJcbiAgICAgICAgdmFyIHRtcDtcclxuICAgICAgICB0YXJnZXQgPSB0YXJnZXQgfHwge307XHJcbiAgICAgICAgZm9yICh2YXIgaSBpbiBzb3VyY2UpIHtcclxuICAgICAgICAgICAgaWYgKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShpKSkge1xyXG4gICAgICAgICAgICAgICAgdG1wID0gc291cmNlW2ldO1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0bXAgPT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICB0YXJnZXRbaV0gPSB1dGlscy5pc0FycmF5KHRtcCkgPyBbXSA6IHt9O1xyXG4gICAgICAgICAgICAgICAgICAgIHV0aWxzLmNsb25lKHNvdXJjZVtpXSwgdGFyZ2V0W2ldKVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0YXJnZXRbaV0gPSB0bXA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRhcmdldDtcclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmiopjbe+8j3B05Li65Y2V5L2N55qE5YC86L2s5o2i5Li6cHjkuLrljZXkvY3nmoTlgLxcclxuICAgICAqIEBtZXRob2QgdHJhbnNVbml0VG9QeFxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0g5b6F6L2s5o2i55qE5bim5Y2V5L2N55qE5a2X56ym5LiyXHJcbiAgICAgKiBAcmV0dXJuIHsgU3RyaW5nIH0g6L2s5o2i5Li6cHjkuLrorqHph4/ljZXkvY3nmoTlgLznmoTlrZfnrKbkuLJcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKlxyXG4gICAgICogLy9vdXRwdXQ6IDUwMHB4XHJcbiAgICAgKiBjb25zb2xlLmxvZyggVUUudXRpbHMudHJhbnNVbml0VG9QeCggJzIwY20nICkgKTtcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogMjdweFxyXG4gICAgICogY29uc29sZS5sb2coIFVFLnV0aWxzLnRyYW5zVW5pdFRvUHgoICcyMHB0JyApICk7XHJcbiAgICAgKlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIHRyYW5zVW5pdFRvUHg6ZnVuY3Rpb24gKHZhbCkge1xyXG4gICAgICAgIGlmICghLyhwdHxjbSkvLnRlc3QodmFsKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdmFsXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciB1bml0O1xyXG4gICAgICAgIHZhbC5yZXBsYWNlKC8oW1xcZC5dKykoXFx3KykvLCBmdW5jdGlvbiAoc3RyLCB2LCB1KSB7XHJcbiAgICAgICAgICAgIHZhbCA9IHY7XHJcbiAgICAgICAgICAgIHVuaXQgPSB1O1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHN3aXRjaCAodW5pdCkge1xyXG4gICAgICAgICAgICBjYXNlICdjbSc6XHJcbiAgICAgICAgICAgICAgICB2YWwgPSBwYXJzZUZsb2F0KHZhbCkgKiAyNTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdwdCc6XHJcbiAgICAgICAgICAgICAgICB2YWwgPSBNYXRoLnJvdW5kKHBhcnNlRmxvYXQodmFsKSAqIDk2IC8gNzIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdmFsICsgKHZhbCA/ICdweCcgOiAnJyk7XHJcbiAgICB9LFxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5ZyoZG9t5qCRcmVhZHnkuYvlkI7miafooYznu5nlrprnmoTlm57osIPlh73mlbBcclxuICAgICAqIEBtZXRob2QgZG9tUmVhZHlcclxuICAgICAqIEByZW1pbmQg5aaC5p6c5Zyo5omn6KGM6K+l5pa55rOV55qE5pe25YCZ77yMIGRvbeagkeW3sue7j3JlYWR577yMIOmCo+S5iOWbnuiwg+WHveaVsOWwhueri+WIu+aJp+ihjFxyXG4gICAgICogQHBhcmFtIHsgRnVuY3Rpb24gfSBmbiBkb23moJFyZWFkeeS5i+WQjueahOWbnuiwg+WHveaVsFxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqXHJcbiAgICAgKiBVRS51dGlscy5kb21SZWFkeSggZnVuY3Rpb24gKCkge1xyXG4gICAgICpcclxuICAgICAqICAgICBjb25zb2xlLmxvZygnMTIzJyk7XHJcbiAgICAgKlxyXG4gICAgICogfSApO1xyXG4gICAgICpcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBkb21SZWFkeTpmdW5jdGlvbiAoKSB7XHJcblxyXG4gICAgICAgIHZhciBmbkFyciA9IFtdO1xyXG5cclxuICAgICAgICBmdW5jdGlvbiBkb1JlYWR5KGRvYykge1xyXG4gICAgICAgICAgICAvL+ehruS/nW9ucmVhZHnlj6rmiafooYzkuIDmrKFcclxuICAgICAgICAgICAgZG9jLmlzUmVhZHkgPSB0cnVlO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBjaTsgY2kgPSBmbkFyci5wb3AoKTsgY2koKSkge1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKG9ucmVhZHksIHdpbikge1xyXG4gICAgICAgICAgICB3aW4gPSB3aW4gfHwgd2luZG93O1xyXG4gICAgICAgICAgICB2YXIgZG9jID0gd2luLmRvY3VtZW50O1xyXG4gICAgICAgICAgICBvbnJlYWR5ICYmIGZuQXJyLnB1c2gob25yZWFkeSk7XHJcbiAgICAgICAgICAgIGlmIChkb2MucmVhZHlTdGF0ZSA9PT0gXCJjb21wbGV0ZVwiKSB7XHJcbiAgICAgICAgICAgICAgICBkb1JlYWR5KGRvYyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBkb2MuaXNSZWFkeSAmJiBkb1JlYWR5KGRvYyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoYnJvd3Nlci5pZSAmJiBicm93c2VyLnZlcnNpb24gIT0gMTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9jLmlzUmVhZHkpIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvYy5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwoXCJsZWZ0XCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChhcmd1bWVudHMuY2FsbGVlLCAwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb1JlYWR5KGRvYyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSkoKTtcclxuICAgICAgICAgICAgICAgICAgICB3aW4uYXR0YWNoRXZlbnQoJ29ubG9hZCcsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9SZWFkeShkb2MpXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKFwiRE9NQ29udGVudExvYWRlZFwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvYy5yZW1vdmVFdmVudExpc3RlbmVyKFwiRE9NQ29udGVudExvYWRlZFwiLCBhcmd1bWVudHMuY2FsbGVlLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvUmVhZHkoZG9jKTtcclxuICAgICAgICAgICAgICAgICAgICB9LCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgd2luLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvUmVhZHkoZG9jKVxyXG4gICAgICAgICAgICAgICAgICAgIH0sIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICB9KCksXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDliqjmgIHmt7vliqBjc3PmoLflvI9cclxuICAgICAqIEBtZXRob2QgY3NzUnVsZVxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0g6IqC54K55ZCN56ewXHJcbiAgICAgKiBAZ3JhbW1hciBVRS51dGlscy5jc3NSdWxlKCfmt7vliqDnmoTmoLflvI/nmoToioLngrnlkI3np7AnLFsn5qC35byPJ++8jCfmlL7liLDlk6rkuKpkb2N1bWVudOS4iiddKVxyXG4gICAgICogQGdyYW1tYXIgVUUudXRpbHMuY3NzUnVsZSgnYm9keScsJ2JvZHl7YmFja2dyb3VuZDojY2NjfScpID0+IG51bGwgIC8v57uZYm9keea3u+WKoOiDjOaZr+minOiJslxyXG4gICAgICogQGdyYW1tYXIgVUUudXRpbHMuY3NzUnVsZSgnYm9keScpID0+5qC35byP55qE5a2X56ym5LiyICAvL+WPluW+l2tleeWAvOS4umJvZHnnmoTmoLflvI/nmoTlhoXlrrks5aaC5p6c5rKh5pyJ5om+5Yiwa2V55YC85YWI5YWz55qE5qC35byP5bCG6L+U5Zue56m677yM5L6L5aaC5Yia5omN6YKj5Liq6IOM5pmv6aKc6Imy77yM5bCG6L+U5ZueIGJvZHl7YmFja2dyb3VuZDojY2NjfVxyXG4gICAgICogQGdyYW1tYXIgVUUudXRpbHMuY3NzUnVsZSgnYm9keScsZG9jdW1lbnQpID0+IOi/lOWbnuaMh+WummtleeeahOagt+W8j++8jOW5tuS4lOaMh+WumuaYr+WTquS4qmRvY3VtZW50XHJcbiAgICAgKiBAZ3JhbW1hciBVRS51dGlscy5jc3NSdWxlKCdib2R5JywnJykgPT5udWxsIC8v5riF56m657uZ5a6a55qEa2V55YC855qE6IOM5pmv6aKc6ImyXHJcbiAgICAgKi9cclxuICAgIGNzc1J1bGU6YnJvd3Nlci5pZSAmJiBicm93c2VyLnZlcnNpb24gIT0gMTEgPyBmdW5jdGlvbiAoa2V5LCBzdHlsZSwgZG9jKSB7XHJcbiAgICAgICAgdmFyIGluZGV4TGlzdCwgaW5kZXg7XHJcbiAgICAgICAgaWYoc3R5bGUgPT09IHVuZGVmaW5lZCB8fCBzdHlsZSAmJiBzdHlsZS5ub2RlVHlwZSAmJiBzdHlsZS5ub2RlVHlwZSA9PSA5KXtcclxuICAgICAgICAgICAgLy/ojrflj5bmoLflvI9cclxuICAgICAgICAgICAgZG9jID0gc3R5bGUgJiYgc3R5bGUubm9kZVR5cGUgJiYgc3R5bGUubm9kZVR5cGUgPT0gOSA/IHN0eWxlIDogKGRvYyB8fCBkb2N1bWVudCk7XHJcbiAgICAgICAgICAgIGluZGV4TGlzdCA9IGRvYy5pbmRleExpc3QgfHwgKGRvYy5pbmRleExpc3QgPSB7fSk7XHJcbiAgICAgICAgICAgIGluZGV4ID0gaW5kZXhMaXN0W2tleV07XHJcbiAgICAgICAgICAgIGlmKGluZGV4ICE9PSAgdW5kZWZpbmVkKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiBkb2Muc3R5bGVTaGVldHNbaW5kZXhdLmNzc1RleHRcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBkb2MgPSBkb2MgfHwgZG9jdW1lbnQ7XHJcbiAgICAgICAgaW5kZXhMaXN0ID0gZG9jLmluZGV4TGlzdCB8fCAoZG9jLmluZGV4TGlzdCA9IHt9KTtcclxuICAgICAgICBpbmRleCA9IGluZGV4TGlzdFtrZXldO1xyXG4gICAgICAgIC8v5riF6Zmk5qC35byPXHJcbiAgICAgICAgaWYoc3R5bGUgPT09ICcnKXtcclxuICAgICAgICAgICAgaWYoaW5kZXghPT0gdW5kZWZpbmVkKXtcclxuICAgICAgICAgICAgICAgIGRvYy5zdHlsZVNoZWV0c1tpbmRleF0uY3NzVGV4dCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlIGluZGV4TGlzdFtrZXldO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWVcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvL+a3u+WKoOagt+W8j1xyXG4gICAgICAgIGlmKGluZGV4IT09IHVuZGVmaW5lZCl7XHJcbiAgICAgICAgICAgIHNoZWV0U3R5bGUgPSAgZG9jLnN0eWxlU2hlZXRzW2luZGV4XTtcclxuICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgc2hlZXRTdHlsZSA9IGRvYy5jcmVhdGVTdHlsZVNoZWV0KCcnLCBpbmRleCA9IGRvYy5zdHlsZVNoZWV0cy5sZW5ndGgpO1xyXG4gICAgICAgICAgICBpbmRleExpc3Rba2V5XSA9IGluZGV4O1xyXG4gICAgICAgIH1cclxuICAgICAgICBzaGVldFN0eWxlLmNzc1RleHQgPSBzdHlsZTtcclxuICAgIH06IGZ1bmN0aW9uIChrZXksIHN0eWxlLCBkb2MpIHtcclxuICAgICAgICB2YXIgaGVhZCwgbm9kZTtcclxuICAgICAgICBpZihzdHlsZSA9PT0gdW5kZWZpbmVkIHx8IHN0eWxlICYmIHN0eWxlLm5vZGVUeXBlICYmIHN0eWxlLm5vZGVUeXBlID09IDkpe1xyXG4gICAgICAgICAgICAvL+iOt+WPluagt+W8j1xyXG4gICAgICAgICAgICBkb2MgPSBzdHlsZSAmJiBzdHlsZS5ub2RlVHlwZSAmJiBzdHlsZS5ub2RlVHlwZSA9PSA5ID8gc3R5bGUgOiAoZG9jIHx8IGRvY3VtZW50KTtcclxuICAgICAgICAgICAgbm9kZSA9IGRvYy5nZXRFbGVtZW50QnlJZChrZXkpO1xyXG4gICAgICAgICAgICByZXR1cm4gbm9kZSA/IG5vZGUuaW5uZXJIVE1MIDogdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICBkb2MgPSBkb2MgfHwgZG9jdW1lbnQ7XHJcbiAgICAgICAgbm9kZSA9IGRvYy5nZXRFbGVtZW50QnlJZChrZXkpO1xyXG5cclxuICAgICAgICAvL+a4hemZpOagt+W8j1xyXG4gICAgICAgIGlmKHN0eWxlID09PSAnJyl7XHJcbiAgICAgICAgICAgIGlmKG5vZGUpe1xyXG4gICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWVcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvL+a3u+WKoOagt+W8j1xyXG4gICAgICAgIGlmKG5vZGUpe1xyXG4gICAgICAgICAgICBub2RlLmlubmVySFRNTCA9IHN0eWxlO1xyXG4gICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICBub2RlID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7XHJcbiAgICAgICAgICAgIG5vZGUuaWQgPSBrZXk7XHJcbiAgICAgICAgICAgIG5vZGUuaW5uZXJIVE1MID0gc3R5bGU7XHJcbiAgICAgICAgICAgIGRvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdLmFwcGVuZENoaWxkKG5vZGUpO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcbiAgICBzb3J0OmZ1bmN0aW9uKGFycmF5LGNvbXBhcmVGbil7XHJcbiAgICAgICAgY29tcGFyZUZuID0gY29tcGFyZUZuIHx8IGZ1bmN0aW9uKGl0ZW0xLCBpdGVtMil7IHJldHVybiBpdGVtMS5sb2NhbGVDb21wYXJlKGl0ZW0yKTt9O1xyXG4gICAgICAgIGZvcih2YXIgaT0gMCxsZW4gPSBhcnJheS5sZW5ndGg7IGk8bGVuOyBpKyspe1xyXG4gICAgICAgICAgICBmb3IodmFyIGogPSBpLGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsgajxsZW5ndGg7IGorKyl7XHJcbiAgICAgICAgICAgICAgICBpZihjb21wYXJlRm4oYXJyYXlbaV0sIGFycmF5W2pdKSA+IDApe1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB0ID0gYXJyYXlbaV07XHJcbiAgICAgICAgICAgICAgICAgICAgYXJyYXlbaV0gPSBhcnJheVtqXTtcclxuICAgICAgICAgICAgICAgICAgICBhcnJheVtqXSA9IHQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGFycmF5O1xyXG4gICAgfSxcclxuICAgIHNlcmlhbGl6ZVBhcmFtOmZ1bmN0aW9uIChqc29uKSB7XHJcbiAgICAgICAgdmFyIHN0ckFyciA9IFtdO1xyXG4gICAgICAgIGZvciAodmFyIGkgaW4ganNvbikge1xyXG4gICAgICAgICAgICAvL+W/veeVpem7mOiupOeahOWHoOS4quWPguaVsFxyXG4gICAgICAgICAgICBpZihpPT1cIm1ldGhvZFwiIHx8IGk9PVwidGltZW91dFwiIHx8IGk9PVwiYXN5bmNcIikgY29udGludWU7XHJcbiAgICAgICAgICAgIC8v5Lyg6YCS6L+H5p2l55qE5a+56LGh5ZKM5Ye95pWw5LiN5Zyo5o+Q5Lqk5LmL5YiXXHJcbiAgICAgICAgICAgIGlmICghKCh0eXBlb2YganNvbltpXSkudG9Mb3dlckNhc2UoKSA9PSBcImZ1bmN0aW9uXCIgfHwgKHR5cGVvZiBqc29uW2ldKS50b0xvd2VyQ2FzZSgpID09IFwib2JqZWN0XCIpKSB7XHJcbiAgICAgICAgICAgICAgICBzdHJBcnIucHVzaCggZW5jb2RlVVJJQ29tcG9uZW50KGkpICsgXCI9XCIrZW5jb2RlVVJJQ29tcG9uZW50KGpzb25baV0pICk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodXRpbHMuaXNBcnJheShqc29uW2ldKSkge1xyXG4gICAgICAgICAgICAgICAgLy/mlK/mjIHkvKDmlbDnu4TlhoXlrrlcclxuICAgICAgICAgICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCBqc29uW2ldLmxlbmd0aDsgaisrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RyQXJyLnB1c2goIGVuY29kZVVSSUNvbXBvbmVudChpKSArIFwiW109XCIrZW5jb2RlVVJJQ29tcG9uZW50KGpzb25baV1bal0pICk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHN0ckFyci5qb2luKFwiJlwiKTtcclxuICAgIH0sXHJcbiAgICBmb3JtYXRVcmw6ZnVuY3Rpb24gKHVybCkge1xyXG4gICAgICAgIHZhciB1ID0gdXJsLnJlcGxhY2UoLyYmL2csICcmJyk7XHJcbiAgICAgICAgdSA9IHUucmVwbGFjZSgvXFw/Ji9nLCAnPycpO1xyXG4gICAgICAgIHUgPSB1LnJlcGxhY2UoLyYkL2csICcnKTtcclxuICAgICAgICB1ID0gdS5yZXBsYWNlKC8mIy9nLCAnIycpO1xyXG4gICAgICAgIHUgPSB1LnJlcGxhY2UoLyYrL2csICcmJyk7XHJcbiAgICAgICAgcmV0dXJuIHU7XHJcbiAgICB9LFxyXG4gICAgaXNDcm9zc0RvbWFpblVybDpmdW5jdGlvbiAodXJsKSB7XHJcbiAgICAgICAgdmFyIGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XHJcbiAgICAgICAgYS5ocmVmID0gdXJsO1xyXG4gICAgICAgIGlmIChicm93c2VyLmllKSB7XHJcbiAgICAgICAgICAgIGEuaHJlZiA9IGEuaHJlZjtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuICEoYS5wcm90b2NvbCA9PSBsb2NhdGlvbi5wcm90b2NvbCAmJiBhLmhvc3RuYW1lID09IGxvY2F0aW9uLmhvc3RuYW1lICYmXHJcbiAgICAgICAgKGEucG9ydCA9PSBsb2NhdGlvbi5wb3J0IHx8IChhLnBvcnQgPT0gJzgwJyAmJiBsb2NhdGlvbi5wb3J0ID09ICcnKSB8fCAoYS5wb3J0ID09ICcnICYmIGxvY2F0aW9uLnBvcnQgPT0gJzgwJykpKTtcclxuICAgIH0sXHJcbiAgICBjbGVhckVtcHR5QXR0cnMgOiBmdW5jdGlvbihvYmope1xyXG4gICAgICAgIGZvcih2YXIgcCBpbiBvYmope1xyXG4gICAgICAgICAgICBpZihvYmpbcF0gPT09ICcnKXtcclxuICAgICAgICAgICAgICAgIGRlbGV0ZSBvYmpbcF1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gb2JqO1xyXG4gICAgfSxcclxuICAgIHN0cjJqc29uIDogZnVuY3Rpb24ocyl7XHJcblxyXG4gICAgICAgIGlmICghdXRpbHMuaXNTdHJpbmcocykpIHJldHVybiBudWxsO1xyXG4gICAgICAgIGlmICh3aW5kb3cuSlNPTikge1xyXG4gICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShzKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gKG5ldyBGdW5jdGlvbihcInJldHVybiBcIiArIHV0aWxzLnRyaW0ocyB8fCAnJykpKSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9LFxyXG4gICAganNvbjJzdHIgOiAoZnVuY3Rpb24oKXtcclxuXHJcbiAgICAgICAgaWYgKHdpbmRvdy5KU09OKSB7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnk7XHJcblxyXG4gICAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgICAgICB2YXIgZXNjYXBlTWFwID0ge1xyXG4gICAgICAgICAgICAgICAgXCJcXGJcIjogJ1xcXFxiJyxcclxuICAgICAgICAgICAgICAgIFwiXFx0XCI6ICdcXFxcdCcsXHJcbiAgICAgICAgICAgICAgICBcIlxcblwiOiAnXFxcXG4nLFxyXG4gICAgICAgICAgICAgICAgXCJcXGZcIjogJ1xcXFxmJyxcclxuICAgICAgICAgICAgICAgIFwiXFxyXCI6ICdcXFxccicsXHJcbiAgICAgICAgICAgICAgICAnXCInIDogJ1xcXFxcIicsXHJcbiAgICAgICAgICAgICAgICBcIlxcXFxcIjogJ1xcXFxcXFxcJ1xyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgZnVuY3Rpb24gZW5jb2RlU3RyaW5nKHNvdXJjZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKC9bXCJcXFxcXFx4MDAtXFx4MWZdLy50ZXN0KHNvdXJjZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBzb3VyY2UgPSBzb3VyY2UucmVwbGFjZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgL1tcIlxcXFxcXHgwMC1cXHgxZl0vZyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKG1hdGNoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYyA9IGVzY2FwZU1hcFttYXRjaF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYyA9IG1hdGNoLmNoYXJDb2RlQXQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBcIlxcXFx1MDBcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBNYXRoLmZsb29yKGMgLyAxNikudG9TdHJpbmcoMTYpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICArIChjICUgMTYpLnRvU3RyaW5nKDE2KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ1wiJyArIHNvdXJjZSArICdcIic7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIGVuY29kZUFycmF5KHNvdXJjZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtcIltcIl0sXHJcbiAgICAgICAgICAgICAgICAgICAgbCA9IHNvdXJjZS5sZW5ndGgsXHJcbiAgICAgICAgICAgICAgICAgICAgcHJlQ29tbWEsIGksIGl0ZW07XHJcblxyXG4gICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGw7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGl0ZW0gPSBzb3VyY2VbaV07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIGl0ZW0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcInVuZGVmaW5lZFwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwiZnVuY3Rpb25cIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcInVua25vd25cIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYocHJlQ29tbWEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnLCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godXRpbHMuanNvbjJzdHIoaXRlbSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlQ29tbWEgPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKFwiXVwiKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQuam9pbihcIlwiKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZnVuY3Rpb24gcGFkKHNvdXJjZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHNvdXJjZSA8IDEwID8gJzAnICsgc291cmNlIDogc291cmNlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBmdW5jdGlvbiBlbmNvZGVEYXRlKHNvdXJjZSl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ1wiJyArIHNvdXJjZS5nZXRGdWxsWWVhcigpICsgXCItXCJcclxuICAgICAgICAgICAgICAgICsgcGFkKHNvdXJjZS5nZXRNb250aCgpICsgMSkgKyBcIi1cIlxyXG4gICAgICAgICAgICAgICAgKyBwYWQoc291cmNlLmdldERhdGUoKSkgKyBcIlRcIlxyXG4gICAgICAgICAgICAgICAgKyBwYWQoc291cmNlLmdldEhvdXJzKCkpICsgXCI6XCJcclxuICAgICAgICAgICAgICAgICsgcGFkKHNvdXJjZS5nZXRNaW51dGVzKCkpICsgXCI6XCJcclxuICAgICAgICAgICAgICAgICsgcGFkKHNvdXJjZS5nZXRTZWNvbmRzKCkpICsgJ1wiJztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICd1bmRlZmluZWQnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3VuZGVmaW5lZCc7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc0Zpbml0ZSh2YWx1ZSkgPyBTdHJpbmcodmFsdWUpIDogXCJudWxsXCI7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbmNvZGVTdHJpbmcodmFsdWUpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdib29sZWFuJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdudWxsJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh1dGlscy5pc0FycmF5KHZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVuY29kZUFycmF5KHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh1dGlscy5pc0RhdGUodmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW5jb2RlRGF0ZSh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gWyd7J10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5jb2RlID0gdXRpbHMuanNvbjJzdHIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlQ29tbWEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gdmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCBrZXkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0gPSB2YWx1ZVtrZXldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBpdGVtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd1bmRlZmluZWQnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAndW5rbm93bic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdmdW5jdGlvbic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmVDb21tYSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnLCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVDb21tYSA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goZW5jb2RlKGtleSkgKyAnOicgKyBlbmNvZGUoaXRlbSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJ30nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQuam9pbignJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfSkoKVxyXG5cclxufTtcclxuLyoqXHJcbiAqIOWIpOaWree7meWumueahOWvueixoeaYr+WQpuaYr+Wtl+espuS4slxyXG4gKiBAbWV0aG9kIGlzU3RyaW5nXHJcbiAqIEBwYXJhbSB7ICogfSBvYmplY3Qg6ZyA6KaB5Yik5pat55qE5a+56LGhXHJcbiAqIEByZXR1cm4geyBCb29sZWFuIH0g57uZ5a6a55qE5a+56LGh5piv5ZCm5piv5a2X56ym5LiyXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIOWIpOaWree7meWumueahOWvueixoeaYr+WQpuaYr+aVsOe7hFxyXG4gKiBAbWV0aG9kIGlzQXJyYXlcclxuICogQHBhcmFtIHsgKiB9IG9iamVjdCDpnIDopoHliKTmlq3nmoTlr7nosaFcclxuICogQHJldHVybiB7IEJvb2xlYW4gfSDnu5nlrprnmoTlr7nosaHmmK/lkKbmmK/mlbDnu4RcclxuICovXHJcblxyXG4vKipcclxuICog5Yik5pat57uZ5a6a55qE5a+56LGh5piv5ZCm5piv5LiA5LiqRnVuY3Rpb25cclxuICogQG1ldGhvZCBpc0Z1bmN0aW9uXHJcbiAqIEBwYXJhbSB7ICogfSBvYmplY3Qg6ZyA6KaB5Yik5pat55qE5a+56LGhXHJcbiAqIEByZXR1cm4geyBCb29sZWFuIH0g57uZ5a6a55qE5a+56LGh5piv5ZCm5pivRnVuY3Rpb25cclxuICovXHJcblxyXG4vKipcclxuICog5Yik5pat57uZ5a6a55qE5a+56LGh5piv5ZCm5pivTnVtYmVyXHJcbiAqIEBtZXRob2QgaXNOdW1iZXJcclxuICogQHBhcmFtIHsgKiB9IG9iamVjdCDpnIDopoHliKTmlq3nmoTlr7nosaFcclxuICogQHJldHVybiB7IEJvb2xlYW4gfSDnu5nlrprnmoTlr7nosaHmmK/lkKbmmK9OdW1iZXJcclxuICovXHJcblxyXG4vKipcclxuICog5Yik5pat57uZ5a6a55qE5a+56LGh5piv5ZCm5piv5LiA5Liq5q2j5YiZ6KGo6L6+5byPXHJcbiAqIEBtZXRob2QgaXNSZWdFeHBcclxuICogQHBhcmFtIHsgKiB9IG9iamVjdCDpnIDopoHliKTmlq3nmoTlr7nosaFcclxuICogQHJldHVybiB7IEJvb2xlYW4gfSDnu5nlrprnmoTlr7nosaHmmK/lkKbmmK/mraPliJnooajovr7lvI9cclxuICovXHJcblxyXG4vKipcclxuICog5Yik5pat57uZ5a6a55qE5a+56LGh5piv5ZCm5piv5LiA5Liq5pmu6YCa5a+56LGhXHJcbiAqIEBtZXRob2QgaXNPYmplY3RcclxuICogQHBhcmFtIHsgKiB9IG9iamVjdCDpnIDopoHliKTmlq3nmoTlr7nosaFcclxuICogQHJldHVybiB7IEJvb2xlYW4gfSDnu5nlrprnmoTlr7nosaHmmK/lkKbmmK/mma7pgJrlr7nosaFcclxuICovXHJcbnV0aWxzLmVhY2goWydTdHJpbmcnLCAnRnVuY3Rpb24nLCAnQXJyYXknLCAnTnVtYmVyJywgJ1JlZ0V4cCcsICdPYmplY3QnLCAnRGF0ZSddLCBmdW5jdGlvbiAodikge1xyXG4gICAgVUUudXRpbHNbJ2lzJyArIHZdID0gZnVuY3Rpb24gKG9iaikge1xyXG4gICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmFwcGx5KG9iaikgPT0gJ1tvYmplY3QgJyArIHYgKyAnXSc7XHJcbiAgICB9XHJcbn0pO1xyXG5cblxuLy8gY29yZS9FdmVudEJhc2UuanNcbi8qKlxyXG4gKiBVRemHh+eUqOeahOS6i+S7tuWfuuexu1xyXG4gKiBAZmlsZVxyXG4gKiBAbW9kdWxlIFVFXHJcbiAqIEBjbGFzcyBFdmVudEJhc2VcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG4vKipcclxuICogVUVkaXRvcuWFrOeUqOepuumXtO+8jFVFZGl0b3LmiYDmnInnmoTlip/og73pg73mjILovb3lnKjor6Xnqbrpl7TkuItcclxuICogQHVuZmlsZVxyXG4gKiBAbW9kdWxlIFVFXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIFVF6YeH55So55qE5LqL5Lu25Z+657G777yM57un5om/5q2k57G755qE5a+55bqU57G75bCG6I635Y+WYWRkTGlzdGVuZXIscmVtb3ZlTGlzdGVuZXIsZmlyZUV2ZW505pa55rOV44CCXHJcbiAqIOWcqFVF5Lit77yMRWRpdG9y5Lul5Y+K5omA5pyJdWnlrp7kvovpg73nu6fmib/kuobor6XnsbvvvIzmlYXlj6/ku6XlnKjlr7nlupTnmoR1aeWvueixoeS7peWPimVkaXRvcuWvueixoeS4iuS9v+eUqOS4iui/sOaWueazleOAglxyXG4gKiBAdW5maWxlXHJcbiAqIEBtb2R1bGUgVUVcclxuICogQGNsYXNzIEV2ZW50QmFzZVxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiDpgJrov4fmraTmnoTpgKDlmajvvIzlrZDnsbvlj6/ku6Xnu6fmib9FdmVudEJhc2Xojrflj5bkuovku7bnm5HlkKznmoTmlrnms5VcclxuICogQGNvbnN0cnVjdG9yXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogVUUuRXZlbnRCYXNlLmNhbGwoZWRpdG9yKTtcclxuICogYGBgXHJcbiAqL1xyXG52YXIgRXZlbnRCYXNlID0gVUUuRXZlbnRCYXNlID0gZnVuY3Rpb24gKCkge307XHJcblxyXG5FdmVudEJhc2UucHJvdG90eXBlID0ge1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5rOo5YaM5LqL5Lu255uR5ZCs5ZmoXHJcbiAgICAgKiBAbWV0aG9kIGFkZExpc3RlbmVyXHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSB0eXBlcyDnm5HlkKznmoTkuovku7blkI3np7DvvIzlkIzml7bnm5HlkKzlpJrkuKrkuovku7bkvb/nlKjnqbrmoLzliIbpmpRcclxuICAgICAqIEBwYXJhbSB7IEZ1bmN0aW9uIH0gZm4g55uR5ZCs55qE5LqL5Lu26KKr6Kem5Y+R5pe277yM5Lya5omn6KGM6K+l5Zue6LCD5Ye95pWwXHJcbiAgICAgKiBAd2FpbmluZyDkuovku7booqvop6blj5Hml7bvvIznm5HlkKznmoTlh73mlbDlgYflpoLov5Tlm57nmoTlgLzmgZLnrYnkuo50cnVl77yM5Zue6LCD5Ye95pWw55qE6Zif5YiX5Lit5ZCO6Z2i55qE5Ye95pWw5bCG5LiN5omn6KGMXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogZWRpdG9yLmFkZExpc3RlbmVyKCdzZWxlY3Rpb25jaGFuZ2UnLGZ1bmN0aW9uKCl7XHJcbiAgICAgKiAgICAgIGNvbnNvbGUubG9nKFwi6YCJ5Yy65bey57uP5Y+Y5YyW77yBXCIpO1xyXG4gICAgICogfSlcclxuICAgICAqIGVkaXRvci5hZGRMaXN0ZW5lcignYmVmb3JlZ2V0Y29udGVudCBhZnRlcmdldGNvbnRlbnQnLGZ1bmN0aW9uKHR5cGUpe1xyXG4gICAgICogICAgICAgICBpZih0eXBlID09ICdiZWZvcmVnZXRjb250ZW50Jyl7XHJcbiAgICAgKiAgICAgICAgICAgICAvL2RvIHNvbWV0aGluZ1xyXG4gICAgICogICAgICAgICB9ZWxzZXtcclxuICAgICAqICAgICAgICAgICAgIC8vZG8gc29tZXRoaW5nXHJcbiAgICAgKiAgICAgICAgIH1cclxuICAgICAqICAgICAgICAgY29uc29sZS5sb2codGhpcy5nZXRDb250ZW50KSAvLyB0aGlz5piv5rOo5YaM55qE5LqL5Lu255qE57yW6L6R5Zmo5a6e5L6LXHJcbiAgICAgKiB9KVxyXG4gICAgICogYGBgXHJcbiAgICAgKiBAc2VlIFVFLkV2ZW50QmFzZTpmaXJlRXZlbnQoU3RyaW5nKVxyXG4gICAgICovXHJcbiAgICBhZGRMaXN0ZW5lcjpmdW5jdGlvbiAodHlwZXMsIGxpc3RlbmVyKSB7XHJcbiAgICAgICAgdHlwZXMgPSB1dGlscy50cmltKHR5cGVzKS5zcGxpdCgvXFxzKy8pO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwLCB0aTsgdGkgPSB0eXBlc1tpKytdOykge1xyXG4gICAgICAgICAgICBnZXRMaXN0ZW5lcih0aGlzLCB0aSwgdHJ1ZSkucHVzaChsaXN0ZW5lcik7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBvbiA6IGZ1bmN0aW9uKHR5cGVzLCBsaXN0ZW5lcil7XHJcbiAgICAgIHJldHVybiB0aGlzLmFkZExpc3RlbmVyKHR5cGVzLGxpc3RlbmVyKTtcclxuICAgIH0sXHJcbiAgICBvZmYgOiBmdW5jdGlvbih0eXBlcywgbGlzdGVuZXIpe1xyXG4gICAgICAgIHJldHVybiB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGVzLCBsaXN0ZW5lcilcclxuICAgIH0sXHJcbiAgICB0cmlnZ2VyOmZ1bmN0aW9uKCl7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlyZUV2ZW50LmFwcGx5KHRoaXMsYXJndW1lbnRzKTtcclxuICAgIH0sXHJcbiAgICAvKipcclxuICAgICAqIOenu+mZpOS6i+S7tuebkeWQrOWZqFxyXG4gICAgICogQG1ldGhvZCByZW1vdmVMaXN0ZW5lclxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gdHlwZXMg56e76Zmk55qE5LqL5Lu25ZCN56ew77yM5ZCM5pe256e76Zmk5aSa5Liq5LqL5Lu25L2/55So56m65qC85YiG6ZqUXHJcbiAgICAgKiBAcGFyYW0geyBGdW5jdGlvbiB9IGZuIOenu+mZpOebkeWQrOS6i+S7tueahOWHveaVsOW8leeUqFxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIC8vY2hhbmdlQ2FsbGJhY2vkuLrmlrnms5XkvZNcclxuICAgICAqIGVkaXRvci5yZW1vdmVMaXN0ZW5lcihcInNlbGVjdGlvbmNoYW5nZVwiLGNoYW5nZUNhbGxiYWNrKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICByZW1vdmVMaXN0ZW5lcjpmdW5jdGlvbiAodHlwZXMsIGxpc3RlbmVyKSB7XHJcbiAgICAgICAgdHlwZXMgPSB1dGlscy50cmltKHR5cGVzKS5zcGxpdCgvXFxzKy8pO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwLCB0aTsgdGkgPSB0eXBlc1tpKytdOykge1xyXG4gICAgICAgICAgICB1dGlscy5yZW1vdmVJdGVtKGdldExpc3RlbmVyKHRoaXMsIHRpKSB8fCBbXSwgbGlzdGVuZXIpO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDop6blj5Hkuovku7ZcclxuICAgICAqIEBtZXRob2QgZmlyZUV2ZW50XHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSB0eXBlcyDop6blj5HnmoTkuovku7blkI3np7DvvIzlkIzml7bop6blj5HlpJrkuKrkuovku7bkvb/nlKjnqbrmoLzliIbpmpRcclxuICAgICAqIEByZW1pbmQg6K+l5pa55rOV5Lya6Kem5Y+RYWRkTGlzdGVuZXJcclxuICAgICAqIEByZXR1cm4geyAqIH0g6L+U5Zue6Kem5Y+R5LqL5Lu255qE6Zif5YiX5Lit77yM5pyA5ZCO5omn6KGM55qE5Zue6LCD5Ye95pWw55qE6L+U5Zue5YC8XHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogZWRpdG9yLmZpcmVFdmVudChcInNlbGVjdGlvbmNoYW5nZVwiKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDop6blj5Hkuovku7ZcclxuICAgICAqIEBtZXRob2QgZmlyZUV2ZW50XHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSB0eXBlcyDop6blj5HnmoTkuovku7blkI3np7DvvIzlkIzml7bop6blj5HlpJrkuKrkuovku7bkvb/nlKjnqbrmoLzliIbpmpRcclxuICAgICAqIEBwYXJhbSB7ICouLi4gfSBvcHRpb25zIOWPr+mAieWPguaVsO+8jOWPr+S7peS8oOWFpeS4gOS4quaIluWkmuS4quWPguaVsO+8jOS8muS8oOe7meS6i+S7tuinpuWPkeeahOWbnuiwg+WHveaVsFxyXG4gICAgICogQHJldHVybiB7ICogfSDov5Tlm57op6blj5Hkuovku7bnmoTpmJ/liJfkuK3vvIzmnIDlkI7miafooYznmoTlm57osIPlh73mlbDnmoTov5Tlm57lgLxcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKlxyXG4gICAgICogZWRpdG9yLmFkZExpc3RlbmVyKCBcInNlbGVjdGlvbmNoYW5nZVwiLCBmdW5jdGlvbiAoIHR5cGUsIGFyZzEsIGFyZzIgKSB7XHJcbiAgICAgKlxyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCBhcmcxICsgXCIgXCIgKyBhcmcyICk7XHJcbiAgICAgKlxyXG4gICAgICogfSApO1xyXG4gICAgICpcclxuICAgICAqIC8v6Kem5Y+Rc2VsZWN0aW9uY2hhbmdl5LqL5Lu277yMIOS8muaJp+ihjOS4iumdoueahOS6i+S7tuebkeWQrOWZqFxyXG4gICAgICogLy9vdXRwdXQ6IEhlbGxvIFdvcmxkXHJcbiAgICAgKiBlZGl0b3IuZmlyZUV2ZW50KFwic2VsZWN0aW9uY2hhbmdlXCIsIFwiSGVsbG9cIiwgXCJXb3JsZFwiKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBmaXJlRXZlbnQ6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciB0eXBlcyA9IGFyZ3VtZW50c1swXTtcclxuICAgICAgICB0eXBlcyA9IHV0aWxzLnRyaW0odHlwZXMpLnNwbGl0KCcgJyk7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIHRpOyB0aSA9IHR5cGVzW2krK107KSB7XHJcbiAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBnZXRMaXN0ZW5lcih0aGlzLCB0aSksXHJcbiAgICAgICAgICAgICAgICByLCB0LCBrO1xyXG4gICAgICAgICAgICBpZiAobGlzdGVuZXJzKSB7XHJcbiAgICAgICAgICAgICAgICBrID0gbGlzdGVuZXJzLmxlbmd0aDtcclxuICAgICAgICAgICAgICAgIHdoaWxlIChrLS0pIHtcclxuICAgICAgICAgICAgICAgICAgICBpZighbGlzdGVuZXJzW2tdKWNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHQgPSBsaXN0ZW5lcnNba10uYXBwbHkodGhpcywgYXJndW1lbnRzKTtcclxuICAgICAgICAgICAgICAgICAgICBpZih0ID09PSB0cnVlKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgciA9IHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0ID0gdGhpc1snb24nICsgdGkudG9Mb3dlckNhc2UoKV0pIHtcclxuICAgICAgICAgICAgICAgIHIgPSB0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHI7XHJcbiAgICB9XHJcbn07XHJcbi8qKlxyXG4gKiDojrflvpflr7nosaHmiYDmi6XmnInnm5HlkKznsbvlnovnmoTmiYDmnInnm5HlkKzlmahcclxuICogQHVuZmlsZVxyXG4gKiBAbW9kdWxlIFVFXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqIEBtZXRob2QgZ2V0TGlzdGVuZXJcclxuICogQHB1YmxpY1xyXG4gKiBAcGFyYW0geyBPYmplY3QgfSBvYmogIOafpeivouebkeWQrOWZqOeahOWvueixoVxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSB0eXBlIOS6i+S7tuexu+Wei1xyXG4gKiBAcGFyYW0geyBCb29sZWFuIH0gZm9yY2UgIOS4unRydWXkuJTlvZPliY3miYDmnIl0eXBl57G75Z6L55qE5L6m5ZCs5Zmo5LiN5a2Y5Zyo5pe277yM5Yib5bu65LiA5Liq56m655uR5ZCs5Zmo5pWw57uEXHJcbiAqIEByZXR1cm4geyBBcnJheSB9IOebkeWQrOWZqOaVsOe7hFxyXG4gKi9cclxuZnVuY3Rpb24gZ2V0TGlzdGVuZXIob2JqLCB0eXBlLCBmb3JjZSkge1xyXG4gICAgdmFyIGFsbExpc3RlbmVycztcclxuICAgIHR5cGUgPSB0eXBlLnRvTG93ZXJDYXNlKCk7XHJcbiAgICByZXR1cm4gKCAoIGFsbExpc3RlbmVycyA9ICggb2JqLl9fYWxsTGlzdGVuZXJzIHx8IGZvcmNlICYmICggb2JqLl9fYWxsTGlzdGVuZXJzID0ge30gKSApIClcclxuICAgICAgICAmJiAoIGFsbExpc3RlbmVyc1t0eXBlXSB8fCBmb3JjZSAmJiAoIGFsbExpc3RlbmVyc1t0eXBlXSA9IFtdICkgKSApO1xyXG59XHJcblxyXG5cblxuLy8gY29yZS9kdGQuanNcbi8vL2ltcG9ydCBlZGl0b3IuanNcclxuLy8vaW1wb3J0IGNvcmUvZG9tL2RvbS5qc1xyXG4vLy9pbXBvcnQgY29yZS91dGlscy5qc1xyXG4vKipcclxuICogZHRkIGh0bWzor63kuYnljJbnmoTkvZPnjrDnsbtcclxuICogQGNvbnN0cnVjdG9yXHJcbiAqIEBuYW1lc3BhY2UgZHRkXHJcbiAqL1xyXG52YXIgZHRkID0gZG9tLmR0ZCA9IChmdW5jdGlvbigpIHtcclxuICAgIGZ1bmN0aW9uIF8oIHMgKSB7XHJcbiAgICAgICAgZm9yICh2YXIgayBpbiBzKSB7XHJcbiAgICAgICAgICAgIHNbay50b1VwcGVyQ2FzZSgpXSA9IHNba107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBzO1xyXG4gICAgfVxyXG4gICAgdmFyIFggPSB1dGlscy5leHRlbmQyO1xyXG4gICAgdmFyIEEgPSBfKHtpc2luZGV4OjEsZmllbGRzZXQ6MX0pLFxyXG4gICAgICAgIEIgPSBfKHtpbnB1dDoxLGJ1dHRvbjoxLHNlbGVjdDoxLHRleHRhcmVhOjEsbGFiZWw6MX0pLFxyXG4gICAgICAgIEMgPSBYKCBfKHthOjF9KSwgQiApLFxyXG4gICAgICAgIEQgPSBYKCB7aWZyYW1lOjF9LCBDICksXHJcbiAgICAgICAgRSA9IF8oe2hyOjEsdWw6MSxtZW51OjEsZGl2OjEsYmxvY2txdW90ZToxLG5vc2NyaXB0OjEsdGFibGU6MSxjZW50ZXI6MSxhZGRyZXNzOjEsZGlyOjEscHJlOjEsaDU6MSxkbDoxLGg0OjEsbm9mcmFtZXM6MSxoNjoxLG9sOjEsaDE6MSxoMzoxLGgyOjF9KSxcclxuICAgICAgICBGID0gXyh7aW5zOjEsZGVsOjEsc2NyaXB0OjEsc3R5bGU6MX0pLFxyXG4gICAgICAgIEcgPSBYKCBfKHtiOjEsYWNyb255bToxLGJkbzoxLCd2YXInOjEsJyMnOjEsYWJicjoxLGNvZGU6MSxicjoxLGk6MSxjaXRlOjEsa2JkOjEsdToxLHN0cmlrZToxLHM6MSx0dDoxLHN0cm9uZzoxLHE6MSxzYW1wOjEsZW06MSxkZm46MSxzcGFuOjF9KSwgRiApLFxyXG4gICAgICAgIEggPSBYKCBfKHtzdWI6MSxpbWc6MSxlbWJlZDoxLG9iamVjdDoxLHN1cDoxLGJhc2Vmb250OjEsbWFwOjEsYXBwbGV0OjEsZm9udDoxLGJpZzoxLHNtYWxsOjF9KSwgRyApLFxyXG4gICAgICAgIEkgPSBYKCBfKHtwOjF9KSwgSCApLFxyXG4gICAgICAgIEogPSBYKCBfKHtpZnJhbWU6MX0pLCBILCBCICksXHJcbiAgICAgICAgSyA9IF8oe2ltZzoxLGVtYmVkOjEsbm9zY3JpcHQ6MSxicjoxLGtiZDoxLGNlbnRlcjoxLGJ1dHRvbjoxLGJhc2Vmb250OjEsaDU6MSxoNDoxLHNhbXA6MSxoNjoxLG9sOjEsaDE6MSxoMzoxLGgyOjEsZm9ybToxLGZvbnQ6MSwnIyc6MSxzZWxlY3Q6MSxtZW51OjEsaW5zOjEsYWJicjoxLGxhYmVsOjEsY29kZToxLHRhYmxlOjEsc2NyaXB0OjEsY2l0ZToxLGlucHV0OjEsaWZyYW1lOjEsc3Ryb25nOjEsdGV4dGFyZWE6MSxub2ZyYW1lczoxLGJpZzoxLHNtYWxsOjEsc3BhbjoxLGhyOjEsc3ViOjEsYmRvOjEsJ3Zhcic6MSxkaXY6MSxvYmplY3Q6MSxzdXA6MSxzdHJpa2U6MSxkaXI6MSxtYXA6MSxkbDoxLGFwcGxldDoxLGRlbDoxLGlzaW5kZXg6MSxmaWVsZHNldDoxLHVsOjEsYjoxLGFjcm9ueW06MSxhOjEsYmxvY2txdW90ZToxLGk6MSx1OjEsczoxLHR0OjEsYWRkcmVzczoxLHE6MSxwcmU6MSxwOjEsZW06MSxkZm46MX0pLFxyXG5cclxuICAgICAgICBMID0gWCggXyh7YTowfSksIEogKSwvL2HkuI3og73ooqvliIflvIDvvIzmiYDku6Xmiorku5ZcclxuICAgICAgICBNID0gXyh7dHI6MX0pLFxyXG4gICAgICAgIE4gPSBfKHsnIyc6MX0pLFxyXG4gICAgICAgIE8gPSBYKCBfKHtwYXJhbToxfSksIEsgKSxcclxuICAgICAgICBQID0gWCggXyh7Zm9ybToxfSksIEEsIEQsIEUsIEkgKSxcclxuICAgICAgICBRID0gXyh7bGk6MSxvbDoxLHVsOjF9KSxcclxuICAgICAgICBSID0gXyh7c3R5bGU6MSxzY3JpcHQ6MX0pLFxyXG4gICAgICAgIFMgPSBfKHtiYXNlOjEsbGluazoxLG1ldGE6MSx0aXRsZToxfSksXHJcbiAgICAgICAgVCA9IFgoIFMsIFIgKSxcclxuICAgICAgICBVID0gXyh7aGVhZDoxLGJvZHk6MX0pLFxyXG4gICAgICAgIFYgPSBfKHtodG1sOjF9KTtcclxuXHJcbiAgICB2YXIgYmxvY2sgPSBfKHthZGRyZXNzOjEsYmxvY2txdW90ZToxLGNlbnRlcjoxLGRpcjoxLGRpdjoxLGRsOjEsZmllbGRzZXQ6MSxmb3JtOjEsaDE6MSxoMjoxLGgzOjEsaDQ6MSxoNToxLGg2OjEsaHI6MSxpc2luZGV4OjEsbWVudToxLG5vZnJhbWVzOjEsb2w6MSxwOjEscHJlOjEsdGFibGU6MSx1bDoxfSksXHJcblxyXG4gICAgICAgIGVtcHR5ID0gIF8oe2FyZWE6MSxiYXNlOjEsYmFzZWZvbnQ6MSxicjoxLGNvbDoxLGNvbW1hbmQ6MSxkaWFsb2c6MSxlbWJlZDoxLGhyOjEsaW1nOjEsaW5wdXQ6MSxpc2luZGV4OjEsa2V5Z2VuOjEsbGluazoxLG1ldGE6MSxwYXJhbToxLHNvdXJjZToxLHRyYWNrOjEsd2JyOjF9KTtcclxuXHJcbiAgICByZXR1cm4gIF8oe1xyXG5cclxuICAgICAgICAvLyAkIOihqOekuuiHquWumueahOWxnuaAp1xyXG5cclxuICAgICAgICAvLyBib2R55aSW55qE5YWD57Sg5YiX6KGoLlxyXG4gICAgICAgICRub25Cb2R5Q29udGVudDogWCggViwgVSwgUyApLFxyXG5cclxuICAgICAgICAvL+Wdl+e7k+aehOWFg+e0oOWIl+ihqFxyXG4gICAgICAgICRibG9jayA6IGJsb2NrLFxyXG5cclxuICAgICAgICAvL+WGheiBlOWFg+e0oOWIl+ihqFxyXG4gICAgICAgICRpbmxpbmUgOiBMLFxyXG5cclxuICAgICAgICAkaW5saW5lV2l0aEEgOiBYKF8oe2E6MX0pLEwpLFxyXG5cclxuICAgICAgICAkYm9keSA6IFgoIF8oe3NjcmlwdDoxLHN0eWxlOjF9KSwgYmxvY2sgKSxcclxuXHJcbiAgICAgICAgJGNkYXRhIDogXyh7c2NyaXB0OjEsc3R5bGU6MX0pLFxyXG5cclxuICAgICAgICAvL+iHqumXreWSjOWFg+e0oFxyXG4gICAgICAgICRlbXB0eSA6IGVtcHR5LFxyXG5cclxuICAgICAgICAvL+S4jeaYr+iHqumXreWQiO+8jOS9huS4jeiDveiuqXJhbmdl6YCJ5Lit6YeM6L65XHJcbiAgICAgICAgJG5vbkNoaWxkIDogXyh7aWZyYW1lOjEsdGV4dGFyZWE6MX0pLFxyXG4gICAgICAgIC8v5YiX6KGo5YWD57Sg5YiX6KGoXHJcbiAgICAgICAgJGxpc3RJdGVtIDogXyh7ZGQ6MSxkdDoxLGxpOjF9KSxcclxuXHJcbiAgICAgICAgLy/liJfooajmoLnlhYPntKDliJfooahcclxuICAgICAgICAkbGlzdDogXyh7dWw6MSxvbDoxLGRsOjF9KSxcclxuXHJcbiAgICAgICAgLy/kuI3og73orqTkuLrmmK/nqbrnmoTlhYPntKBcclxuICAgICAgICAkaXNOb3RFbXB0eSA6IF8oe3RhYmxlOjEsdWw6MSxvbDoxLGRsOjEsaWZyYW1lOjEsYXJlYToxLGJhc2U6MSxjb2w6MSxocjoxLGltZzoxLGVtYmVkOjEsaW5wdXQ6MSxsaW5rOjEsbWV0YToxLHBhcmFtOjEsaDE6MSxoMjoxLGgzOjEsaDQ6MSxoNToxLGg2OjF9KSxcclxuXHJcbiAgICAgICAgLy/lpoLmnpzmsqHmnInlrZDoioLngrnlsLHlj6/ku6XliKDpmaTnmoTlhYPntKDliJfooajvvIzlg49zcGFuLGFcclxuICAgICAgICAkcmVtb3ZlRW1wdHkgOiBfKHthOjEsYWJicjoxLGFjcm9ueW06MSxhZGRyZXNzOjEsYjoxLGJkbzoxLGJpZzoxLGNpdGU6MSxjb2RlOjEsZGVsOjEsZGZuOjEsZW06MSxmb250OjEsaToxLGluczoxLGxhYmVsOjEsa2JkOjEscToxLHM6MSxzYW1wOjEsc21hbGw6MSxzcGFuOjEsc3RyaWtlOjEsc3Ryb25nOjEsc3ViOjEsc3VwOjEsdHQ6MSx1OjEsJ3Zhcic6MX0pLFxyXG5cclxuICAgICAgICAkcmVtb3ZlRW1wdHlCbG9jayA6IF8oeydwJzoxLCdkaXYnOjF9KSxcclxuXHJcbiAgICAgICAgLy/lnKh0YWJsZeWFg+e0oOmHjOeahOWFg+e0oOWIl+ihqFxyXG4gICAgICAgICR0YWJsZUNvbnRlbnQgOiBfKHtjYXB0aW9uOjEsY29sOjEsY29sZ3JvdXA6MSx0Ym9keToxLHRkOjEsdGZvb3Q6MSx0aDoxLHRoZWFkOjEsdHI6MSx0YWJsZToxfSksXHJcbiAgICAgICAgLy/kuI3ovazmjaLnmoTmoIfnrb5cclxuICAgICAgICAkbm90VHJhbnNDb250ZW50IDogXyh7cHJlOjEsc2NyaXB0OjEsc3R5bGU6MSx0ZXh0YXJlYToxfSksXHJcbiAgICAgICAgaHRtbDogVSxcclxuICAgICAgICBoZWFkOiBULFxyXG4gICAgICAgIHN0eWxlOiBOLFxyXG4gICAgICAgIHNjcmlwdDogTixcclxuICAgICAgICBib2R5OiBQLFxyXG4gICAgICAgIGJhc2U6IHt9LFxyXG4gICAgICAgIGxpbms6IHt9LFxyXG4gICAgICAgIG1ldGE6IHt9LFxyXG4gICAgICAgIHRpdGxlOiBOLFxyXG4gICAgICAgIGNvbCA6IHt9LFxyXG4gICAgICAgIHRyIDogXyh7dGQ6MSx0aDoxfSksXHJcbiAgICAgICAgaW1nIDoge30sXHJcbiAgICAgICAgZW1iZWQ6IHt9LFxyXG4gICAgICAgIGNvbGdyb3VwIDogXyh7dGhlYWQ6MSxjb2w6MSx0Ym9keToxLHRyOjEsdGZvb3Q6MX0pLFxyXG4gICAgICAgIG5vc2NyaXB0IDogUCxcclxuICAgICAgICB0ZCA6IFAsXHJcbiAgICAgICAgYnIgOiB7fSxcclxuICAgICAgICB0aCA6IFAsXHJcbiAgICAgICAgY2VudGVyIDogUCxcclxuICAgICAgICBrYmQgOiBMLFxyXG4gICAgICAgIGJ1dHRvbiA6IFgoIEksIEUgKSxcclxuICAgICAgICBiYXNlZm9udCA6IHt9LFxyXG4gICAgICAgIGg1IDogTCxcclxuICAgICAgICBoNCA6IEwsXHJcbiAgICAgICAgc2FtcCA6IEwsXHJcbiAgICAgICAgaDYgOiBMLFxyXG4gICAgICAgIG9sIDogUSxcclxuICAgICAgICBoMSA6IEwsXHJcbiAgICAgICAgaDMgOiBMLFxyXG4gICAgICAgIG9wdGlvbiA6IE4sXHJcbiAgICAgICAgaDIgOiBMLFxyXG4gICAgICAgIGZvcm0gOiBYKCBBLCBELCBFLCBJICksXHJcbiAgICAgICAgc2VsZWN0IDogXyh7b3B0Z3JvdXA6MSxvcHRpb246MX0pLFxyXG4gICAgICAgIGZvbnQgOiBMLFxyXG4gICAgICAgIGlucyA6IEwsXHJcbiAgICAgICAgbWVudSA6IFEsXHJcbiAgICAgICAgYWJiciA6IEwsXHJcbiAgICAgICAgbGFiZWwgOiBMLFxyXG4gICAgICAgIHRhYmxlIDogXyh7dGhlYWQ6MSxjb2w6MSx0Ym9keToxLHRyOjEsY29sZ3JvdXA6MSxjYXB0aW9uOjEsdGZvb3Q6MX0pLFxyXG4gICAgICAgIGNvZGUgOiBMLFxyXG4gICAgICAgIHRmb290IDogTSxcclxuICAgICAgICBjaXRlIDogTCxcclxuICAgICAgICBsaSA6IFAsXHJcbiAgICAgICAgaW5wdXQgOiB7fSxcclxuICAgICAgICBpZnJhbWUgOiBQLFxyXG4gICAgICAgIHN0cm9uZyA6IEwsXHJcbiAgICAgICAgdGV4dGFyZWEgOiBOLFxyXG4gICAgICAgIG5vZnJhbWVzIDogUCxcclxuICAgICAgICBiaWcgOiBMLFxyXG4gICAgICAgIHNtYWxsIDogTCxcclxuICAgICAgICAvL3RyYWNlOlxyXG4gICAgICAgIHNwYW4gOl8oeycjJzoxLGJyOjEsYjoxLHN0cm9uZzoxLHU6MSxpOjEsZW06MSxzdWI6MSxzdXA6MSxzdHJpa2U6MSxzcGFuOjF9KSxcclxuICAgICAgICBociA6IEwsXHJcbiAgICAgICAgZHQgOiBMLFxyXG4gICAgICAgIHN1YiA6IEwsXHJcbiAgICAgICAgb3B0Z3JvdXAgOiBfKHtvcHRpb246MX0pLFxyXG4gICAgICAgIHBhcmFtIDoge30sXHJcbiAgICAgICAgYmRvIDogTCxcclxuICAgICAgICAndmFyJyA6IEwsXHJcbiAgICAgICAgZGl2IDogUCxcclxuICAgICAgICBvYmplY3QgOiBPLFxyXG4gICAgICAgIHN1cCA6IEwsXHJcbiAgICAgICAgZGQgOiBQLFxyXG4gICAgICAgIHN0cmlrZSA6IEwsXHJcbiAgICAgICAgYXJlYSA6IHt9LFxyXG4gICAgICAgIGRpciA6IFEsXHJcbiAgICAgICAgbWFwIDogWCggXyh7YXJlYToxLGZvcm06MSxwOjF9KSwgQSwgRiwgRSApLFxyXG4gICAgICAgIGFwcGxldCA6IE8sXHJcbiAgICAgICAgZGwgOiBfKHtkdDoxLGRkOjF9KSxcclxuICAgICAgICBkZWwgOiBMLFxyXG4gICAgICAgIGlzaW5kZXggOiB7fSxcclxuICAgICAgICBmaWVsZHNldCA6IFgoIF8oe2xlZ2VuZDoxfSksIEsgKSxcclxuICAgICAgICB0aGVhZCA6IE0sXHJcbiAgICAgICAgdWwgOiBRLFxyXG4gICAgICAgIGFjcm9ueW0gOiBMLFxyXG4gICAgICAgIGIgOiBMLFxyXG4gICAgICAgIGEgOiBYKCBfKHthOjF9KSwgSiApLFxyXG4gICAgICAgIGJsb2NrcXVvdGUgOlgoXyh7dGQ6MSx0cjoxLHRib2R5OjEsbGk6MX0pLFApLFxyXG4gICAgICAgIGNhcHRpb24gOiBMLFxyXG4gICAgICAgIGkgOiBMLFxyXG4gICAgICAgIHUgOiBMLFxyXG4gICAgICAgIHRib2R5IDogTSxcclxuICAgICAgICBzIDogTCxcclxuICAgICAgICBhZGRyZXNzIDogWCggRCwgSSApLFxyXG4gICAgICAgIHR0IDogTCxcclxuICAgICAgICBsZWdlbmQgOiBMLFxyXG4gICAgICAgIHEgOiBMLFxyXG4gICAgICAgIHByZSA6IFgoIEcsIEMgKSxcclxuICAgICAgICBwIDogWChfKHsnYSc6MX0pLEwpLFxyXG4gICAgICAgIGVtIDpMLFxyXG4gICAgICAgIGRmbiA6IExcclxuICAgIH0pO1xyXG59KSgpO1xyXG5cblxuLy8gY29yZS9kb21VdGlscy5qc1xuLyoqXHJcbiAqIERvbeaTjeS9nOW3peWFt+WMhVxyXG4gKiBAZmlsZVxyXG4gKiBAbW9kdWxlIFVFLmRvbS5kb21VdGlsc1xyXG4gKiBAc2luY2UgMS4yLjYuMVxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiBEb23mk43kvZzlt6XlhbfljIVcclxuICogQHVuZmlsZVxyXG4gKiBAbW9kdWxlIFVFLmRvbS5kb21VdGlsc1xyXG4gKi9cclxuZnVuY3Rpb24gZ2V0RG9tTm9kZShub2RlLCBzdGFydCwgbHRyLCBzdGFydEZyb21DaGlsZCwgZm4sIGd1YXJkKSB7XHJcbiAgICB2YXIgdG1wTm9kZSA9IHN0YXJ0RnJvbUNoaWxkICYmIG5vZGVbc3RhcnRdLFxyXG4gICAgICAgIHBhcmVudDtcclxuICAgICF0bXBOb2RlICYmICh0bXBOb2RlID0gbm9kZVtsdHJdKTtcclxuICAgIHdoaWxlICghdG1wTm9kZSAmJiAocGFyZW50ID0gKHBhcmVudCB8fCBub2RlKS5wYXJlbnROb2RlKSkge1xyXG4gICAgICAgIGlmIChwYXJlbnQudGFnTmFtZSA9PSAnQk9EWScgfHwgZ3VhcmQgJiYgIWd1YXJkKHBhcmVudCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRtcE5vZGUgPSBwYXJlbnRbbHRyXTtcclxuICAgIH1cclxuICAgIGlmICh0bXBOb2RlICYmIGZuICYmICFmbih0bXBOb2RlKSkge1xyXG4gICAgICAgIHJldHVybiAgZ2V0RG9tTm9kZSh0bXBOb2RlLCBzdGFydCwgbHRyLCBmYWxzZSwgZm4pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRtcE5vZGU7XHJcbn1cclxudmFyIGF0dHJGaXggPSBpZSAmJiBicm93c2VyLnZlcnNpb24gPCA5ID8ge1xyXG4gICAgICAgIHRhYmluZGV4OlwidGFiSW5kZXhcIixcclxuICAgICAgICByZWFkb25seTpcInJlYWRPbmx5XCIsXHJcbiAgICAgICAgXCJmb3JcIjpcImh0bWxGb3JcIixcclxuICAgICAgICBcImNsYXNzXCI6XCJjbGFzc05hbWVcIixcclxuICAgICAgICBtYXhsZW5ndGg6XCJtYXhMZW5ndGhcIixcclxuICAgICAgICBjZWxsc3BhY2luZzpcImNlbGxTcGFjaW5nXCIsXHJcbiAgICAgICAgY2VsbHBhZGRpbmc6XCJjZWxsUGFkZGluZ1wiLFxyXG4gICAgICAgIHJvd3NwYW46XCJyb3dTcGFuXCIsXHJcbiAgICAgICAgY29sc3BhbjpcImNvbFNwYW5cIixcclxuICAgICAgICB1c2VtYXA6XCJ1c2VNYXBcIixcclxuICAgICAgICBmcmFtZWJvcmRlcjpcImZyYW1lQm9yZGVyXCJcclxuICAgIH0gOiB7XHJcbiAgICAgICAgdGFiaW5kZXg6XCJ0YWJJbmRleFwiLFxyXG4gICAgICAgIHJlYWRvbmx5OlwicmVhZE9ubHlcIlxyXG4gICAgfSxcclxuICAgIHN0eWxlQmxvY2sgPSB1dGlscy5saXN0VG9NYXAoW1xyXG4gICAgICAgICctd2Via2l0LWJveCcsICctbW96LWJveCcsICdibG9jaycgLFxyXG4gICAgICAgICdsaXN0LWl0ZW0nICwgJ3RhYmxlJyAsICd0YWJsZS1yb3ctZ3JvdXAnICxcclxuICAgICAgICAndGFibGUtaGVhZGVyLWdyb3VwJywgJ3RhYmxlLWZvb3Rlci1ncm91cCcgLFxyXG4gICAgICAgICd0YWJsZS1yb3cnICwgJ3RhYmxlLWNvbHVtbi1ncm91cCcgLCAndGFibGUtY29sdW1uJyAsXHJcbiAgICAgICAgJ3RhYmxlLWNlbGwnICwgJ3RhYmxlLWNhcHRpb24nXHJcbiAgICBdKTtcclxudmFyIGRvbVV0aWxzID0gZG9tLmRvbVV0aWxzID0ge1xyXG4gICAgLy/oioLngrnluLjph49cclxuICAgIE5PREVfRUxFTUVOVDoxLFxyXG4gICAgTk9ERV9ET0NVTUVOVDo5LFxyXG4gICAgTk9ERV9URVhUOjMsXHJcbiAgICBOT0RFX0NPTU1FTlQ6OCxcclxuICAgIE5PREVfRE9DVU1FTlRfRlJBR01FTlQ6MTEsXHJcblxyXG4gICAgLy/kvY3nva7lhbPns7tcclxuICAgIFBPU0lUSU9OX0lERU5USUNBTDowLFxyXG4gICAgUE9TSVRJT05fRElTQ09OTkVDVEVEOjEsXHJcbiAgICBQT1NJVElPTl9GT0xMT1dJTkc6MixcclxuICAgIFBPU0lUSU9OX1BSRUNFRElORzo0LFxyXG4gICAgUE9TSVRJT05fSVNfQ09OVEFJTkVEOjgsXHJcbiAgICBQT1NJVElPTl9DT05UQUlOUzoxNixcclxuICAgIC8vaWU25L2/55So5YW25LuW55qE5Lya5pyJ5LiA5q6156m655m95Ye6546wXHJcbiAgICBmaWxsQ2hhcjppZSAmJiBicm93c2VyLnZlcnNpb24gPT0gJzYnID8gJ1xcdWZlZmYnIDogJ1xcdTIwMEInLFxyXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tTm9kZemDqOWIhi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAgICBrZXlzOntcclxuICAgICAgICAvKkJhY2tzcGFjZSovIDg6MSwgLypEZWxldGUqLyA0NjoxLFxyXG4gICAgICAgIC8qU2hpZnQqLyAxNjoxLCAvKkN0cmwqLyAxNzoxLCAvKkFsdCovIDE4OjEsXHJcbiAgICAgICAgMzc6MSwgMzg6MSwgMzk6MSwgNDA6MSxcclxuICAgICAgICAxMzoxIC8qZW50ZXIqL1xyXG4gICAgfSxcclxuICAgIC8qKlxyXG4gICAgICog6I635Y+W6IqC54K5QeebuOWvueS6juiKgueCuULnmoTkvY3nva7lhbPns7tcclxuICAgICAqIEBtZXRob2QgZ2V0UG9zaXRpb25cclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlQSDpnIDopoHmn6Xor6LkvY3nva7lhbPns7vnmoToioLngrlBXHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZUIg6ZyA6KaB5p+l6K+i5L2N572u5YWz57O755qE6IqC54K5QlxyXG4gICAgICogQHJldHVybiB7IE51bWJlciB9IOiKgueCuUHkuI7oioLngrlC55qE5YWz57O7XHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogLy9vdXRwdXQ6IDIwXHJcbiAgICAgKiB2YXIgcG9zaXRpb24gPSBVRS5kb20uZG9tVXRpbHMuZ2V0UG9zaXRpb24oIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgZG9jdW1lbnQuYm9keSApO1xyXG4gICAgICpcclxuICAgICAqIHN3aXRjaCAoIHBvc2l0aW9uICkge1xyXG4gICAgICpcclxuICAgICAqICAgICAgLy8wXHJcbiAgICAgKiAgICAgIGNhc2UgVUUuZG9tLmRvbVV0aWxzLlBPU0lUSU9OX0lERU5USUNBTDpcclxuICAgICAqICAgICAgICAgIGNvbnNvbGUubG9nKCflhYPntKDnm7jlkIwnKTtcclxuICAgICAqICAgICAgICAgIGJyZWFrO1xyXG4gICAgICogICAgICAvLzFcclxuICAgICAqICAgICAgY2FzZSBVRS5kb20uZG9tVXRpbHMuUE9TSVRJT05fRElTQ09OTkVDVEVEOlxyXG4gICAgICogICAgICAgICAgY29uc29sZS5sb2coJ+S4pOS4quiKgueCueWcqOS4jeWQjOeahOaWh+aho+S4rScpO1xyXG4gICAgICogICAgICAgICAgYnJlYWs7XHJcbiAgICAgKiAgICAgIC8vMlxyXG4gICAgICogICAgICBjYXNlIFVFLmRvbS5kb21VdGlscy5QT1NJVElPTl9GT0xMT1dJTkc6XHJcbiAgICAgKiAgICAgICAgICBjb25zb2xlLmxvZygn6IqC54K5QeWcqOiKgueCuULkuYvlkI4nKTtcclxuICAgICAqICAgICAgICAgIGJyZWFrO1xyXG4gICAgICogICAgICAvLzRcclxuICAgICAqICAgICAgY2FzZSBVRS5kb20uZG9tVXRpbHMuUE9TSVRJT05fUFJFQ0VESU5HO1xyXG4gICAgICogICAgICAgICAgY29uc29sZS5sb2coJ+iKgueCuUHlnKjoioLngrlC5LmL5YmNJyk7XHJcbiAgICAgKiAgICAgICAgICBicmVhaztcclxuICAgICAqICAgICAgLy84XHJcbiAgICAgKiAgICAgIGNhc2UgVUUuZG9tLmRvbVV0aWxzLlBPU0lUSU9OX0lTX0NPTlRBSU5FRDpcclxuICAgICAqICAgICAgICAgIGNvbnNvbGUubG9nKCfoioLngrlB6KKr6IqC54K5QuWMheWQqycpO1xyXG4gICAgICogICAgICAgICAgYnJlYWs7XHJcbiAgICAgKiAgICAgIGNhc2UgMTA6XHJcbiAgICAgKiAgICAgICAgICBjb25zb2xlLmxvZygn6IqC54K5Qeiiq+iKgueCuULljIXlkKvkuJToioLngrlB5Zyo6IqC54K5QuS5i+WQjicpO1xyXG4gICAgICogICAgICAgICAgYnJlYWs7XHJcbiAgICAgKiAgICAgIC8vMTZcclxuICAgICAqICAgICAgY2FzZSBVRS5kb20uZG9tVXRpbHMuUE9TSVRJT05fQ09OVEFJTlM6XHJcbiAgICAgKiAgICAgICAgICBjb25zb2xlLmxvZygn6IqC54K5QeWMheWQq+iKgueCuUInKTtcclxuICAgICAqICAgICAgICAgIGJyZWFrO1xyXG4gICAgICogICAgICBjYXNlIDIwOlxyXG4gICAgICogICAgICAgICAgY29uc29sZS5sb2coJ+iKgueCuUHljIXlkKvoioLngrlC5LiU6IqC54K5QeWcqOiKgueCuULkuYvliY0nKTtcclxuICAgICAqICAgICAgICAgIGJyZWFrO1xyXG4gICAgICpcclxuICAgICAqIH1cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBnZXRQb3NpdGlvbjpmdW5jdGlvbiAobm9kZUEsIG5vZGVCKSB7XHJcbiAgICAgICAgLy8g5aaC5p6c5Lik5Liq6IqC54K55piv5ZCM5LiA5Liq6IqC54K5XHJcbiAgICAgICAgaWYgKG5vZGVBID09PSBub2RlQikge1xyXG4gICAgICAgICAgICAvLyBkb21VdGlscy5QT1NJVElPTl9JREVOVElDQUxcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBub2RlLFxyXG4gICAgICAgICAgICBwYXJlbnRzQSA9IFtub2RlQV0sXHJcbiAgICAgICAgICAgIHBhcmVudHNCID0gW25vZGVCXTtcclxuICAgICAgICBub2RlID0gbm9kZUE7XHJcbiAgICAgICAgd2hpbGUgKG5vZGUgPSBub2RlLnBhcmVudE5vZGUpIHtcclxuICAgICAgICAgICAgLy8g5aaC5p6cbm9kZULmmK9ub2RlQeeahOelluWFiOiKgueCuVxyXG4gICAgICAgICAgICBpZiAobm9kZSA9PT0gbm9kZUIpIHtcclxuICAgICAgICAgICAgICAgIC8vIGRvbVV0aWxzLlBPU0lUSU9OX0lTX0NPTlRBSU5FRCArIGRvbVV0aWxzLlBPU0lUSU9OX0ZPTExPV0lOR1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDEwO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHBhcmVudHNBLnB1c2gobm9kZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG5vZGUgPSBub2RlQjtcclxuICAgICAgICB3aGlsZSAobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkge1xyXG4gICAgICAgICAgICAvLyDlpoLmnpxub2RlQeaYr25vZGVC55qE56WW5YWI6IqC54K5XHJcbiAgICAgICAgICAgIGlmIChub2RlID09PSBub2RlQSkge1xyXG4gICAgICAgICAgICAgICAgLy8gZG9tVXRpbHMuUE9TSVRJT05fQ09OVEFJTlMgKyBkb21VdGlscy5QT1NJVElPTl9QUkVDRURJTkdcclxuICAgICAgICAgICAgICAgIHJldHVybiAyMDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBwYXJlbnRzQi5wdXNoKG5vZGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBwYXJlbnRzQS5yZXZlcnNlKCk7XHJcbiAgICAgICAgcGFyZW50c0IucmV2ZXJzZSgpO1xyXG4gICAgICAgIGlmIChwYXJlbnRzQVswXSAhPT0gcGFyZW50c0JbMF0pIHtcclxuICAgICAgICAgICAgLy8gZG9tVXRpbHMuUE9TSVRJT05fRElTQ09OTkVDVEVEXHJcbiAgICAgICAgICAgIHJldHVybiAxO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgaSA9IC0xO1xyXG4gICAgICAgIHdoaWxlIChpKyssIHBhcmVudHNBW2ldID09PSBwYXJlbnRzQltpXSkge1xyXG4gICAgICAgIH1cclxuICAgICAgICBub2RlQSA9IHBhcmVudHNBW2ldO1xyXG4gICAgICAgIG5vZGVCID0gcGFyZW50c0JbaV07XHJcbiAgICAgICAgd2hpbGUgKG5vZGVBID0gbm9kZUEubmV4dFNpYmxpbmcpIHtcclxuICAgICAgICAgICAgaWYgKG5vZGVBID09PSBub2RlQikge1xyXG4gICAgICAgICAgICAgICAgLy8gZG9tVXRpbHMuUE9TSVRJT05fUFJFQ0VESU5HXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gNFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGRvbVV0aWxzLlBPU0lUSU9OX0ZPTExPV0lOR1xyXG4gICAgICAgIHJldHVybiAgMjtcclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmo4DmtYvoioLngrlub2Rl5Zyo54i26IqC54K55Lit55qE57Si5byV5L2N572uXHJcbiAgICAgKiBAbWV0aG9kIGdldE5vZGVJbmRleFxyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg6ZyA6KaB5qOA5rWL55qE6IqC54K55a+56LGhXHJcbiAgICAgKiBAcmV0dXJuIHsgTnVtYmVyIH0g6K+l6IqC54K55Zyo54i26IqC54K55Lit55qE5L2N572uXHJcbiAgICAgKiBAc2VlIFVFLmRvbS5kb21VdGlscy5nZXROb2RlSW5kZXgoTm9kZSxCb29sZWFuKVxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmo4DmtYvoioLngrlub2Rl5Zyo54i26IqC54K55Lit55qE57Si5byV5L2N572u77yMIOagueaNrue7meWumueahG1lcmdlVGV4dE5vZGXlj4LmlbDlhrPlrprmmK/lkKbopoHlkIjlubblpJrkuKrov57nu63nmoTmlofmnKzoioLngrnkuLrkuIDkuKroioLngrlcclxuICAgICAqIEBtZXRob2QgZ2V0Tm9kZUluZGV4XHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZSDpnIDopoHmo4DmtYvnmoToioLngrnlr7nosaFcclxuICAgICAqIEBwYXJhbSB7IEJvb2xlYW4gfSBtZXJnZVRleHROb2RlIOaYr+WQpuWQiOW5tuWkmuS4qui/nue7reeahOaWh+acrOiKgueCueS4uuS4gOS4quiKgueCuVxyXG4gICAgICogQHJldHVybiB7IE51bWJlciB9IOivpeiKgueCueWcqOeItuiKgueCueS4reeahOS9jee9rlxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqXHJcbiAgICAgKiAgICAgIHZhciBub2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgIG5vZGUuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBcImhlbGxvXCIgKSApO1xyXG4gICAgICogICAgICBub2RlLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggXCJ3b3JsZFwiICkgKTtcclxuICAgICAqICAgICAgbm9kZS5hcHBlbmRDaGlsZCggbm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIFwiZGl2XCIgKSApO1xyXG4gICAgICpcclxuICAgICAqICAgICAgLy9vdXRwdXQ6IDJcclxuICAgICAqICAgICAgY29uc29sZS5sb2coIFVFLmRvbS5kb21VdGlscy5nZXROb2RlSW5kZXgoIG5vZGUgKSApO1xyXG4gICAgICpcclxuICAgICAqICAgICAgLy9vdXRwdXQ6IDFcclxuICAgICAqICAgICAgY29uc29sZS5sb2coIFVFLmRvbS5kb21VdGlscy5nZXROb2RlSW5kZXgoIG5vZGUsIHRydWUgKSApO1xyXG4gICAgICpcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBnZXROb2RlSW5kZXg6ZnVuY3Rpb24gKG5vZGUsIGlnbm9yZVRleHROb2RlKSB7XHJcbiAgICAgICAgdmFyIHByZU5vZGUgPSBub2RlLFxyXG4gICAgICAgICAgICBpID0gMDtcclxuICAgICAgICB3aGlsZSAocHJlTm9kZSA9IHByZU5vZGUucHJldmlvdXNTaWJsaW5nKSB7XHJcbiAgICAgICAgICAgIGlmIChpZ25vcmVUZXh0Tm9kZSAmJiBwcmVOb2RlLm5vZGVUeXBlID09IDMpIHtcclxuICAgICAgICAgICAgICAgIGlmKHByZU5vZGUubm9kZVR5cGUgIT0gcHJlTm9kZS5uZXh0U2libGluZy5ub2RlVHlwZSApe1xyXG4gICAgICAgICAgICAgICAgICAgIGkrKztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGkrKztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGk7XHJcbiAgICB9LFxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5qOA5rWL6IqC54K5bm9kZeaYr+WQpuWcqOe7meWumueahGRvY3VtZW505a+56LGh5LiKXHJcbiAgICAgKiBAbWV0aG9kIGluRG9jXHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZSDpnIDopoHmo4DmtYvnmoToioLngrnlr7nosaFcclxuICAgICAqIEBwYXJhbSB7IERvbURvY3VtZW50IH0gZG9jIOmcgOimgeajgOa1i+eahGRvY3VtZW505a+56LGhXHJcbiAgICAgKiBAcmV0dXJuIHsgQm9vbGVhbiB9IOivpeiKgueCuW5vZGXmmK/lkKblnKjnu5nlrprnmoRkb2N1bWVudOeahGRvbeagkeS4ilxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqXHJcbiAgICAgKiB2YXIgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgKlxyXG4gICAgICogLy9vdXRwdXQ6IGZhbHNlXHJcbiAgICAgKiBjb25zb2xlLmxvZyggVUUuZG8uZG9tVXRpbHMuaW5Eb2MoIG5vZGUsIGRvY3VtZW50ICkgKTtcclxuICAgICAqXHJcbiAgICAgKiBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKCBub2RlICk7XHJcbiAgICAgKlxyXG4gICAgICogLy9vdXRwdXQ6IHRydWVcclxuICAgICAqIGNvbnNvbGUubG9nKCBVRS5kby5kb21VdGlscy5pbkRvYyggbm9kZSwgZG9jdW1lbnQgKSApO1xyXG4gICAgICpcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBpbkRvYzpmdW5jdGlvbiAobm9kZSwgZG9jKSB7XHJcbiAgICAgICAgcmV0dXJuIGRvbVV0aWxzLmdldFBvc2l0aW9uKG5vZGUsIGRvYykgPT0gMTA7XHJcbiAgICB9LFxyXG4gICAgLyoqXHJcbiAgICAgKiDmoLnmja7nu5nlrprnmoTov4fmu6Top4TliJlmaWx0ZXJGbu+8jCDmn6Xmib7nrKblkIjor6Xov4fmu6Top4TliJnnmoRub2Rl6IqC54K555qE56ys5LiA5Liq56WW5YWI6IqC54K577yMXHJcbiAgICAgKiDmn6Xmib7nmoTotbfngrnmmK/nu5nlrppub2Rl6IqC54K555qE54i26IqC54K544CCXHJcbiAgICAgKiBAbWV0aG9kIGZpbmRQYXJlbnRcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOmcgOimgeafpeaJvueahOiKgueCuVxyXG4gICAgICogQHBhcmFtIHsgRnVuY3Rpb24gfSBmaWx0ZXJGbiDoh6rlrprkuYnnmoTov4fmu6Tmlrnms5XjgIJcclxuICAgICAqIEB3YXJuaW5nIOafpeaJvueahOe7iOeCueaYr+WIsGJvZHnoioLngrnkuLrmraJcclxuICAgICAqIEByZW1pbmQg6Ieq5a6a5LmJ55qE6L+H5ruk5pa55rOVZmlsdGVyRm7mjqXlj5fkuIDkuKpOb2Rl5a+56LGh5L2c5Li65Y+C5pWw77yMIOivpeWvueixoeS7o+ihqOW9k+WJjeaJp+ihjOajgOa1i+eahOelluWFiOiKgueCueOAgiDlpoLmnpzor6VcclxuICAgICAqICAgICAgICAgIOiKgueCuea7oei2s+i/h+a7pOadoeS7tu+8jCDliJnopoHmsYLov5Tlm550cnVl77yMIOi/meaXtuWwhuebtOaOpei/lOWbnuivpeiKgueCueS9nOS4umZpbmRQYXJlbnQoKeeahOe7k+aenO+8jCDlkKbliJnvvIwg6K+36L+U5ZueZmFsc2XjgIJcclxuICAgICAqIEByZXR1cm4geyBOb2RlIHwgTnVsbCB9IOWmguaenOaJvuWIsOespuWQiOi/h+a7pOadoeS7tueahOiKgueCue+8jCDlsLHov5Tlm57or6XoioLngrnvvIwg5ZCm5YiZ6L+U5ZueTlVMTFxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIHZhciBmaWx0ZXJOb2RlID0gVUUuZG9tLmRvbVV0aWxzLmZpbmRQYXJlbnQoIGRvY3VtZW50LmJvZHkuZmlyc3RDaGlsZCwgZnVuY3Rpb24gKCBub2RlICkge1xyXG4gICAgICpcclxuICAgICAqICAgICAvL+eUseS6juafpeaJvueahOe7iOeCueaYr2JvZHnoioLngrnvvIwg5omA5Lul5rC46L+c5Lmf5LiN5Lya5Yy56YWN5b2T5YmN6L+H5ruk5Zmo55qE5p2h5Lu277yMIOWNs+i/memHjOawuOi/nOS8mui/lOWbnmZhbHNlXHJcbiAgICAgKiAgICAgcmV0dXJuIG5vZGUudGFnTmFtZSA9PT0gXCJIVE1MXCI7XHJcbiAgICAgKlxyXG4gICAgICogfSApO1xyXG4gICAgICpcclxuICAgICAqIC8vb3V0cHV0OiB0cnVlXHJcbiAgICAgKiBjb25zb2xlLmxvZyggZmlsdGVyTm9kZSA9PT0gbnVsbCApO1xyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIOagueaNrue7meWumueahOi/h+a7pOinhOWImWZpbHRlckZu77yMIOafpeaJvuespuWQiOivpei/h+a7pOinhOWImeeahG5vZGXoioLngrnnmoTnrKzkuIDkuKrnpZblhYjoioLngrnvvIxcclxuICAgICAqIOWmguaenGluY2x1ZGVTZWxm55qE5YC85Li6dHJ1Ze+8jOWImeafpeaJvueahOi1t+eCueaYr+e7meWumueahOiKgueCuW5vZGXvvIwg5ZCm5YiZ77yMIOi1t+eCueaYr25vZGXnmoTniLboioLngrlcclxuICAgICAqIEBtZXRob2QgZmluZFBhcmVudFxyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg6ZyA6KaB5p+l5om+55qE6IqC54K5XHJcbiAgICAgKiBAcGFyYW0geyBGdW5jdGlvbiB9IGZpbHRlckZuIOiHquWumuS5ieeahOi/h+a7pOaWueazleOAglxyXG4gICAgICogQHBhcmFtIHsgQm9vbGVhbiB9IGluY2x1ZGVTZWxmIOafpeaJvui/h+eoi+aYr+WQpuWMheWQq+iHqui6q1xyXG4gICAgICogQHdhcm5pbmcg5p+l5om+55qE57uI54K55piv5YiwYm9keeiKgueCueS4uuatolxyXG4gICAgICogQHJlbWluZCDoh6rlrprkuYnnmoTov4fmu6Tmlrnms5VmaWx0ZXJGbuaOpeWPl+S4gOS4qk5vZGXlr7nosaHkvZzkuLrlj4LmlbDvvIwg6K+l5a+56LGh5Luj6KGo5b2T5YmN5omn6KGM5qOA5rWL55qE56WW5YWI6IqC54K544CCIOWmguaenOivpVxyXG4gICAgICogICAgICAgICAg6IqC54K55ruh6Laz6L+H5ruk5p2h5Lu277yMIOWImeimgeaxgui/lOWbnnRydWXvvIwg6L+Z5pe25bCG55u05o6l6L+U5Zue6K+l6IqC54K55L2c5Li6ZmluZFBhcmVudCgp55qE57uT5p6c77yMIOWQpuWIme+8jCDor7fov5Tlm55mYWxzZeOAglxyXG4gICAgICogQHJlbWluZCDlpoLmnpxpbmNsdWRlU2VsZuS4unRydWXvvIwg5YiZ6L+H5ruk5Zmo56ys5LiA5qyh5omn6KGM5pe255qE5Y+C5pWw5Lya5piv6IqC54K55pys6Lqr44CCXHJcbiAgICAgKiAgICAgICAgICDlj43kuYvvvIwg6L+H5ruk5Zmo56ys5LiA5qyh5omn6KGM5pe255qE5Y+C5pWw5bCG5piv6K+l6IqC54K555qE54i26IqC54K544CCXHJcbiAgICAgKiBAcmV0dXJuIHsgTm9kZSB8IE51bGwgfSDlpoLmnpzmib7liLDnrKblkIjov4fmu6TmnaHku7bnmoToioLngrnvvIwg5bCx6L+U5Zue6K+l6IqC54K577yMIOWQpuWImei/lOWbnk5VTExcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBodG1sXHJcbiAgICAgKiA8Ym9keT5cclxuICAgICAqXHJcbiAgICAgKiAgICAgIDxkaXYgaWQ9XCJ0ZXN0XCI+XHJcbiAgICAgKiAgICAgIDwvZGl2PlxyXG4gICAgICpcclxuICAgICAqICAgICAgPHNjcmlwdCB0eXBlPVwidGV4dC9qYXZhc2NyaXB0XCI+XHJcbiAgICAgKlxyXG4gICAgICogICAgICAgICAgLy9vdXRwdXQ6IERJViwgQk9EWVxyXG4gICAgICogICAgICAgICAgdmFyIGZpbHRlck5vZGUgPSBVRS5kb20uZG9tVXRpbHMuZmluZFBhcmVudCggZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIFwidGVzdFwiICksIGZ1bmN0aW9uICggbm9kZSApIHtcclxuICAgICAqXHJcbiAgICAgKiAgICAgICAgICAgICAgY29uc29sZS5sb2coIG5vZGUudGFnTmFtZSApO1xyXG4gICAgICogICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgICAgICB9LCB0cnVlICk7XHJcbiAgICAgKlxyXG4gICAgICogICAgICA8L3NjcmlwdD5cclxuICAgICAqIDwvYm9keT5cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBmaW5kUGFyZW50OmZ1bmN0aW9uIChub2RlLCBmaWx0ZXJGbiwgaW5jbHVkZVNlbGYpIHtcclxuICAgICAgICBpZiAobm9kZSAmJiAhZG9tVXRpbHMuaXNCb2R5KG5vZGUpKSB7XHJcbiAgICAgICAgICAgIG5vZGUgPSBpbmNsdWRlU2VsZiA/IG5vZGUgOiBub2RlLnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgIHdoaWxlIChub2RlKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWZpbHRlckZuIHx8IGZpbHRlckZuKG5vZGUpIHx8IGRvbVV0aWxzLmlzQm9keShub2RlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXJGbiAmJiAhZmlsdGVyRm4obm9kZSkgJiYgZG9tVXRpbHMuaXNCb2R5KG5vZGUpID8gbnVsbCA6IG5vZGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfSxcclxuICAgIC8qKlxyXG4gICAgICog5p+l5om+bm9kZeeahOiKgueCueWQjeS4unRhZ05hbWXnmoTnrKzkuIDkuKrnpZblhYjoioLngrnvvIwg5p+l5om+55qE6LW354K55pivbm9kZeiKgueCueeahOeItuiKgueCueOAglxyXG4gICAgICogQG1ldGhvZCBmaW5kUGFyZW50QnlUYWdOYW1lXHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZSDpnIDopoHmn6Xmib7nmoToioLngrnlr7nosaFcclxuICAgICAqIEBwYXJhbSB7IEFycmF5IH0gdGFnTmFtZXMg6ZyA6KaB5p+l5om+55qE54i26IqC54K555qE5ZCN56ew5pWw57uEXHJcbiAgICAgKiBAd2FybmluZyDmn6Xmib7nmoTnu4jngrnmmK/liLBib2R56IqC54K55Li65q2iXHJcbiAgICAgKiBAcmV0dXJuIHsgTm9kZSB8IE5VTEwgfSDlpoLmnpzmib7liLDnrKblkIjmnaHku7bnmoToioLngrnvvIwg5YiZ6L+U5Zue6K+l6IqC54K577yMIOWQpuWImei/lOWbnk5VTExcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiB2YXIgbm9kZSA9IFVFLmRvbS5kb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImRpdlwiKVswXSwgWyBcIkJPRFlcIiBdICk7XHJcbiAgICAgKiAvL291dHB1dDogQk9EWVxyXG4gICAgICogY29uc29sZS5sb2coIG5vZGUudGFnTmFtZSApO1xyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIOafpeaJvm5vZGXnmoToioLngrnlkI3kuLp0YWdOYW1l55qE56WW5YWI6IqC54K577yMIOWmguaenGluY2x1ZGVTZWxm55qE5YC85Li6dHJ1Ze+8jOWImeafpeaJvueahOi1t+eCueaYr+e7meWumueahOiKgueCuW5vZGXvvIxcclxuICAgICAqIOWQpuWIme+8jCDotbfngrnmmK9ub2Rl55qE54i26IqC54K544CCXHJcbiAgICAgKiBAbWV0aG9kIGZpbmRQYXJlbnRCeVRhZ05hbWVcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOmcgOimgeafpeaJvueahOiKgueCueWvueixoVxyXG4gICAgICogQHBhcmFtIHsgQXJyYXkgfSB0YWdOYW1lcyDpnIDopoHmn6Xmib7nmoTniLboioLngrnnmoTlkI3np7DmlbDnu4RcclxuICAgICAqIEBwYXJhbSB7IEJvb2xlYW4gfSBpbmNsdWRlU2VsZiDmn6Xmib7ov4fnqIvmmK/lkKbljIXlkKtub2Rl6IqC54K56Ieq6LqrXHJcbiAgICAgKiBAd2FybmluZyDmn6Xmib7nmoTnu4jngrnmmK/liLBib2R56IqC54K55Li65q2iXHJcbiAgICAgKiBAcmV0dXJuIHsgTm9kZSB8IE5VTEwgfSDlpoLmnpzmib7liLDnrKblkIjmnaHku7bnmoToioLngrnvvIwg5YiZ6L+U5Zue6K+l6IqC54K577yMIOWQpuWImei/lOWbnk5VTExcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiB2YXIgcXVlcnlUYXJnZXQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImRpdlwiKVswXTtcclxuICAgICAqIHZhciBub2RlID0gVUUuZG9tLmRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUoIHF1ZXJ5VGFyZ2V0LCBbIFwiRElWXCIgXSwgdHJ1ZSApO1xyXG4gICAgICogLy9vdXRwdXQ6IHRydWVcclxuICAgICAqIGNvbnNvbGUubG9nKCBxdWVyeVRhcmdldCA9PT0gbm9kZSApO1xyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIGZpbmRQYXJlbnRCeVRhZ05hbWU6ZnVuY3Rpb24gKG5vZGUsIHRhZ05hbWVzLCBpbmNsdWRlU2VsZiwgZXhjbHVkZUZuKSB7XHJcbiAgICAgICAgdGFnTmFtZXMgPSB1dGlscy5saXN0VG9NYXAodXRpbHMuaXNBcnJheSh0YWdOYW1lcykgPyB0YWdOYW1lcyA6IFt0YWdOYW1lc10pO1xyXG4gICAgICAgIHJldHVybiBkb21VdGlscy5maW5kUGFyZW50KG5vZGUsIGZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0YWdOYW1lc1tub2RlLnRhZ05hbWVdICYmICEoZXhjbHVkZUZuICYmIGV4Y2x1ZGVGbihub2RlKSk7XHJcbiAgICAgICAgfSwgaW5jbHVkZVNlbGYpO1xyXG4gICAgfSxcclxuICAgIC8qKlxyXG4gICAgICog5p+l5om+6IqC54K5bm9kZeeahOelluWFiOiKgueCuembhuWQiO+8jCDmn6Xmib7nmoTotbfngrnmmK/nu5nlrproioLngrnnmoTniLboioLngrnvvIznu5Pmnpzpm4bkuK3kuI3ljIXlkKvnu5nlrprnmoToioLngrnjgIJcclxuICAgICAqIEBtZXRob2QgZmluZFBhcmVudHNcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOmcgOimgeafpeaJvueahOiKgueCueWvueixoVxyXG4gICAgICogQHJldHVybiB7IEFycmF5IH0g57uZ5a6a6IqC54K555qE56WW5YWI6IqC54K55pWw57uEXHJcbiAgICAgKiBAZ3JhbW1hciBVRS5kb20uZG9tVXRpbHMuZmluZFBhcmVudHMobm9kZSkgID0+IEFycmF5ICAvL+i/lOWbnuS4gOS4quelluWFiOiKgueCueaVsOe7hOmbhuWQiO+8jOS4jeWMheWQq+iHqui6q1xyXG4gICAgICogQGdyYW1tYXIgVUUuZG9tLmRvbVV0aWxzLmZpbmRQYXJlbnRzKG5vZGUsaW5jbHVkZVNlbGYpICA9PiBBcnJheSAgLy/ov5Tlm57kuIDkuKrnpZblhYjoioLngrnmlbDnu4Tpm4blkIjvvIxpbmNsdWRlU2VsZuaMh+WumuaYr+WQpuWMheWQq+iHqui6q1xyXG4gICAgICogQGdyYW1tYXIgVUUuZG9tLmRvbVV0aWxzLmZpbmRQYXJlbnRzKG5vZGUsaW5jbHVkZVNlbGYsZmlsdGVyRm4pICA9PiBBcnJheSAgLy/ov5Tlm57kuIDkuKrnpZblhYjoioLngrnmlbDnu4Tpm4blkIjvvIxmaWx0ZXJGbuaMh+Wumui/h+a7pOadoeS7tu+8jOi/lOWbnnRydWXnmoRub2Rl5bCG6KKr6YCJ5Y+WXHJcbiAgICAgKiBAZ3JhbW1hciBVRS5kb20uZG9tVXRpbHMuZmluZFBhcmVudHMobm9kZSxpbmNsdWRlU2VsZixmaWx0ZXJGbixjbG9zZXJGaXJzdCkgID0+IEFycmF5ICAvL+i/lOWbnuS4gOS4quelluWFiOiKgueCueaVsOe7hOmbhuWQiO+8jGNsb3NlckZpcnN05Li6dHJ1ZeeahOivne+8jG5vZGXnmoTnm7TmjqXniLbkurLoioLngrnmmK/mlbDnu4TnmoTnrKww5LiqXHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIOafpeaJvuiKgueCuW5vZGXnmoTnpZblhYjoioLngrnpm4blkIjvvIwg5aaC5p6caW5jbHVkZVNlbGbnmoTlgLzkuLp0cnVl77yMXHJcbiAgICAgKiDliJnov5Tlm57nmoTnu5Pmnpzpm4bkuK3lhYHorrjlh7rnjrDlvZPliY3nu5nlrprnmoToioLngrnvvIwg5ZCm5YiZ77yMIOivpeiKgueCueS4jeS8muWHuueOsOWcqOWFtue7k+aenOmbhuS4reOAglxyXG4gICAgICogQG1ldGhvZCBmaW5kUGFyZW50c1xyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg6ZyA6KaB5p+l5om+55qE6IqC54K55a+56LGhXHJcbiAgICAgKiBAcGFyYW0geyBCb29sZWFuIH0gaW5jbHVkZVNlbGYg5p+l5om+55qE57uT5p6c5Lit5piv5ZCm5YWB6K645YyF5ZCr5b2T5YmN5p+l5om+55qE6IqC54K55a+56LGhXHJcbiAgICAgKiBAcmV0dXJuIHsgQXJyYXkgfSDnu5nlrproioLngrnnmoTnpZblhYjoioLngrnmlbDnu4RcclxuICAgICAqL1xyXG4gICAgZmluZFBhcmVudHM6ZnVuY3Rpb24gKG5vZGUsIGluY2x1ZGVTZWxmLCBmaWx0ZXJGbiwgY2xvc2VyRmlyc3QpIHtcclxuICAgICAgICB2YXIgcGFyZW50cyA9IGluY2x1ZGVTZWxmICYmICggZmlsdGVyRm4gJiYgZmlsdGVyRm4obm9kZSkgfHwgIWZpbHRlckZuICkgPyBbbm9kZV0gOiBbXTtcclxuICAgICAgICB3aGlsZSAobm9kZSA9IGRvbVV0aWxzLmZpbmRQYXJlbnQobm9kZSwgZmlsdGVyRm4pKSB7XHJcbiAgICAgICAgICAgIHBhcmVudHMucHVzaChub2RlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGNsb3NlckZpcnN0ID8gcGFyZW50cyA6IHBhcmVudHMucmV2ZXJzZSgpO1xyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWcqOiKgueCuW5vZGXlkI7pnaLmj5LlhaXmlrDoioLngrluZXdOb2RlXHJcbiAgICAgKiBAbWV0aG9kIGluc2VydEFmdGVyXHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZSDnm67moIfoioLngrlcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBuZXdOb2RlIOaWsOaPkuWFpeeahOiKgueCue+8jCDor6XoioLngrnlsIbnva7kuo7nm67moIfoioLngrnkuYvlkI5cclxuICAgICAqIEByZXR1cm4geyBOb2RlIH0g5paw5o+S5YWl55qE6IqC54K5XHJcbiAgICAgKi9cclxuICAgIGluc2VydEFmdGVyOmZ1bmN0aW9uIChub2RlLCBuZXdOb2RlKSB7XHJcbiAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmcgPyBub2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5ld05vZGUsIG5vZGUubmV4dFNpYmxpbmcpOlxyXG4gICAgICAgICAgICBub2RlLnBhcmVudE5vZGUuYXBwZW5kQ2hpbGQobmV3Tm9kZSk7XHJcbiAgICB9LFxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yig6Zmk6IqC54K5bm9kZeWPiuWFtuS4i+WxnueahOaJgOacieiKgueCuVxyXG4gICAgICogQG1ldGhvZCByZW1vdmVcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOmcgOimgeWIoOmZpOeahOiKgueCueWvueixoVxyXG4gICAgICogQHJldHVybiB7IE5vZGUgfSDov5Tlm57liJrliKDpmaTnmoToioLngrnlr7nosaFcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBodG1sXHJcbiAgICAgKiA8ZGl2IGlkPVwidGVzdFwiPlxyXG4gICAgICogICAgIDxkaXYgaWQ9XCJjaGlsZFwiPuS9oOWlvTwvZGl2PlxyXG4gICAgICogPC9kaXY+XHJcbiAgICAgKiA8c2NyaXB0PlxyXG4gICAgICogICAgIFVFLmRvbS5kb21VdGlscy5yZW1vdmUoIGRvY3VtZW50LmJvZHksIGZhbHNlICk7XHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IGZhbHNlXHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBcImNoaWxkXCIgKSAhPT0gbnVsbCApO1xyXG4gICAgICogPC9zY3JpcHQ+XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yig6Zmk6IqC54K5bm9kZe+8jOW5tuagueaNrmtlZXBDaGlsZHJlbueahOWAvOWGs+WumuaYr+WQpuS/neeVmeWtkOiKgueCuVxyXG4gICAgICogQG1ldGhvZCByZW1vdmVcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOmcgOimgeWIoOmZpOeahOiKgueCueWvueixoVxyXG4gICAgICogQHBhcmFtIHsgQm9vbGVhbiB9IGtlZXBDaGlsZHJlbiDmmK/lkKbpnIDopoHkv53nlZnlrZDoioLngrlcclxuICAgICAqIEByZXR1cm4geyBOb2RlIH0g6L+U5Zue5Yia5Yig6Zmk55qE6IqC54K55a+56LGhXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPGRpdiBpZD1cInRlc3RcIj5cclxuICAgICAqICAgICA8ZGl2IGlkPVwiY2hpbGRcIj7kvaDlpb08L2Rpdj5cclxuICAgICAqIDwvZGl2PlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqICAgICBVRS5kb20uZG9tVXRpbHMucmVtb3ZlKCBkb2N1bWVudC5ib2R5LCB0cnVlICk7XHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IHRydWVcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIFwiY2hpbGRcIiApICE9PSBudWxsICk7XHJcbiAgICAgKiA8L3NjcmlwdD5cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICByZW1vdmU6ZnVuY3Rpb24gKG5vZGUsIGtlZXBDaGlsZHJlbikge1xyXG4gICAgICAgIHZhciBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGUsXHJcbiAgICAgICAgICAgIGNoaWxkO1xyXG4gICAgICAgIGlmIChwYXJlbnQpIHtcclxuICAgICAgICAgICAgaWYgKGtlZXBDaGlsZHJlbiAmJiBub2RlLmhhc0NoaWxkTm9kZXMoKSkge1xyXG4gICAgICAgICAgICAgICAgd2hpbGUgKGNoaWxkID0gbm9kZS5maXJzdENoaWxkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShjaGlsZCwgbm9kZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcGFyZW50LnJlbW92ZUNoaWxkKG5vZGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbm9kZTtcclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlj5blvpdub2Rl6IqC54K555qE5LiL5LiA5Liq5YWE5byf6IqC54K577yMIOWmguaenOivpeiKgueCueWFtuWQjuayoeacieWFhOW8n+iKgueCue+8jCDliJnpgJLlvZLmn6Xmib7lhbbniLboioLngrnkuYvlkI7nmoTnrKzkuIDkuKrlhYTlvJ/oioLngrnvvIxcclxuICAgICAqIOebtOWIsOaJvuWIsOa7oei2s+adoeS7tueahOiKgueCueaIluiAhemAkuW9kuWIsEJPRFnoioLngrnkuYvlkI7miY3kvJrnu5PmnZ/jgIJcclxuICAgICAqIEBtZXRob2QgZ2V0TmV4dERvbU5vZGVcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOmcgOimgeiOt+WPluWFtuWQjueahOWFhOW8n+iKgueCueeahOiKgueCueWvueixoVxyXG4gICAgICogQHJldHVybiB7IE5vZGUgfCBOVUxMIH0g5aaC5p6c5om+5ruh6Laz5p2h5Lu255qE6IqC54K577yMIOWImei/lOWbnuivpeiKgueCue+8jCDlkKbliJnov5Tlm55OVUxMXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogICAgIDxib2R5PlxyXG4gICAgICogICAgICA8ZGl2IGlkPVwidGVzdFwiPlxyXG4gICAgICogICAgICAgICAgPHNwYW4+PC9zcGFuPlxyXG4gICAgICogICAgICA8L2Rpdj5cclxuICAgICAqICAgICAgPGk+eHh4PC9pPlxyXG4gICAgICogPC9ib2R5PlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqXHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IGnoioLngrlcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggVUUuZG9tLmRvbVV0aWxzLmdldE5leHREb21Ob2RlKCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggXCJ0ZXN0XCIgKSApICk7XHJcbiAgICAgKlxyXG4gICAgICogPC9zY3JpcHQ+XHJcbiAgICAgKiBgYGBcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBodG1sXHJcbiAgICAgKiA8Ym9keT5cclxuICAgICAqICAgICAgPGRpdj5cclxuICAgICAqICAgICAgICAgIDxzcGFuPjwvc3Bhbj5cclxuICAgICAqICAgICAgICAgIDxpIGlkPVwidGVzdFwiPnh4eDwvaT5cclxuICAgICAqICAgICAgPC9kaXY+XHJcbiAgICAgKiAgICAgIDxiPnh4eDwvYj5cclxuICAgICAqIDwvYm9keT5cclxuICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgKlxyXG4gICAgICogICAgIC8v55Sx5LqOaWTkuLp0ZXN055qEaeiKgueCueS5i+WQjuayoeacieWFhOW8n+iKgueCue+8jCDliJnmn6Xmib7lhbbniLboioLngrnvvIhkaXbvvInlkI7pnaLnmoTlhYTlvJ/oioLngrlcclxuICAgICAqICAgICAvL291dHB1dDogYuiKgueCuVxyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCBVRS5kb20uZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBcInRlc3RcIiApICkgKTtcclxuICAgICAqXHJcbiAgICAgKiA8L3NjcmlwdD5cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlj5blvpdub2Rl6IqC54K555qE5LiL5LiA5Liq5YWE5byf6IqC54K577yMIOWmguaenHN0YXJ0RnJvbUNoaWxk55qE5YC85Li6dHVyZe+8jOWImeWFiOiOt+WPluWFtuWtkOiKgueCue+8jFxyXG4gICAgICog5aaC5p6c5pyJ5a2Q6IqC54K55YiZ55u05o6l6L+U5Zue56ys5LiA5Liq5a2Q6IqC54K577yb5aaC5p6c5rKh5pyJ5a2Q6IqC54K55oiW6ICFc3RhcnRGcm9tQ2hpbGTnmoTlgLzkuLpmYWxzZe+8jFxyXG4gICAgICog5YiZ5omn6KGMPGEgaHJlZj1cIiNVRS5kb20uZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoTm9kZSlcIj5nZXROZXh0RG9tTm9kZShOb2RlIG5vZGUpPC9hPueahOafpeaJvui/h+eoi+OAglxyXG4gICAgICogQG1ldGhvZCBnZXROZXh0RG9tTm9kZVxyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg6ZyA6KaB6I635Y+W5YW25ZCO55qE5YWE5byf6IqC54K555qE6IqC54K55a+56LGhXHJcbiAgICAgKiBAcGFyYW0geyBCb29sZWFuIH0gc3RhcnRGcm9tQ2hpbGQg5p+l5om+6L+H56iL5piv5ZCm5LuO5YW25a2Q6IqC54K55byA5aeLXHJcbiAgICAgKiBAcmV0dXJuIHsgTm9kZSB8IE5VTEwgfSDlpoLmnpzmib7mu6HotrPmnaHku7bnmoToioLngrnvvIwg5YiZ6L+U5Zue6K+l6IqC54K577yMIOWQpuWImei/lOWbnk5VTExcclxuICAgICAqIEBzZWUgVUUuZG9tLmRvbVV0aWxzLmdldE5leHREb21Ob2RlKE5vZGUpXHJcbiAgICAgKi9cclxuICAgIGdldE5leHREb21Ob2RlOmZ1bmN0aW9uIChub2RlLCBzdGFydEZyb21DaGlsZCwgZmlsdGVyRm4sIGd1YXJkKSB7XHJcbiAgICAgICAgcmV0dXJuIGdldERvbU5vZGUobm9kZSwgJ2ZpcnN0Q2hpbGQnLCAnbmV4dFNpYmxpbmcnLCBzdGFydEZyb21DaGlsZCwgZmlsdGVyRm4sIGd1YXJkKTtcclxuICAgIH0sXHJcbiAgICBnZXRQcmVEb21Ob2RlOmZ1bmN0aW9uIChub2RlLCBzdGFydEZyb21DaGlsZCwgZmlsdGVyRm4sIGd1YXJkKSB7XHJcbiAgICAgICAgcmV0dXJuIGdldERvbU5vZGUobm9kZSwgJ2xhc3RDaGlsZCcsICdwcmV2aW91c1NpYmxpbmcnLCBzdGFydEZyb21DaGlsZCwgZmlsdGVyRm4sIGd1YXJkKTtcclxuICAgIH0sXHJcbiAgICAvKipcclxuICAgICAqIOajgOa1i+iKgueCuW5vZGXmmK/lkKblsZ7mmK9VRWRpdG9y5a6a5LmJ55qEYm9va21hcmvoioLngrlcclxuICAgICAqIEBtZXRob2QgaXNCb29rbWFya05vZGVcclxuICAgICAqIEBwcml2YXRlXHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZSDpnIDopoHmo4DmtYvnmoToioLngrnlr7nosaFcclxuICAgICAqIEByZXR1cm4geyBCb29sZWFuIH0g5piv5ZCm5pivYm9va21hcmvoioLngrlcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBodG1sXHJcbiAgICAgKiA8c3BhbiBpZD1cIl9iYWlkdV9ib29rbWFya18xXCI+PC9zcGFuPlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqICAgICAgdmFyIGJvb2ttYXJrTm9kZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiX2JhaWR1X2Jvb2ttYXJrXzFcIik7XHJcbiAgICAgKiAgICAgIC8vb3V0cHV0OiB0cnVlXHJcbiAgICAgKiAgICAgIGNvbnNvbGUubG9nKCBVRS5kb20uZG9tVXRpbHMuaXNCb29rbWFya05vZGUoIGJvb2ttYXJrTm9kZSApICk7XHJcbiAgICAgKiA8L3NjcmlwdD5cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBpc0Jvb2ttYXJrTm9kZTpmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09IDEgJiYgbm9kZS5pZCAmJiAvXl9iYWlkdV9ib29rbWFya18vaS50ZXN0KG5vZGUuaWQpO1xyXG4gICAgfSxcclxuICAgIC8qKlxyXG4gICAgICog6I635Y+W6IqC54K5bm9kZeaJgOWxnueahHdpbmRvd+WvueixoVxyXG4gICAgICogQG1ldGhvZCAgZ2V0V2luZG93XHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZSDoioLngrnlr7nosaFcclxuICAgICAqIEByZXR1cm4geyBXaW5kb3cgfSDlvZPliY3oioLngrnmiYDlsZ7nmoR3aW5kb3flr7nosaFcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiAvL291dHB1dDogdHJ1ZVxyXG4gICAgICogY29uc29sZS5sb2coIFVFLmRvbS5kb21VdGlscy5nZXRXaW5kb3coIGRvY3VtZW50LmJvZHkgKSA9PT0gd2luZG93ICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgZ2V0V2luZG93OmZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgdmFyIGRvYyA9IG5vZGUub3duZXJEb2N1bWVudCB8fCBub2RlO1xyXG4gICAgICAgIHJldHVybiBkb2MuZGVmYXVsdFZpZXcgfHwgZG9jLnBhcmVudFdpbmRvdztcclxuICAgIH0sXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluemu25vZGVB5LiObm9kZULmnIDov5HnmoTlhazlhbHnmoTnpZblhYjoioLngrlcclxuICAgICAqIEBtZXRob2QgIGdldENvbW1vbkFuY2VzdG9yXHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZUEg56ys5LiA5Liq6IqC54K5XHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZUIg56ys5LqM5Liq6IqC54K5XHJcbiAgICAgKiBAcmVtaW5kIOWmguaenOe7meWumueahOS4pOS4quiKgueCueaYr+WQjOS4gOS4quiKgueCue+8jCDlsIbnm7TmjqXov5Tlm57or6XoioLngrnjgIJcclxuICAgICAqIEByZXR1cm4geyBOb2RlIHwgTlVMTCB9IOWmguaenOacquaJvuWIsOWFrOWFseiKgueCue+8jCDov5Tlm55OVUxM77yMIOWQpuWImei/lOWbnuacgOi/keeahOWFrOWFseelluWFiOiKgueCueOAglxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIHZhciBjb21tb25BbmNlc3RvciA9IFVFLmRvbS5kb21VdGlscy5nZXRDb21tb25BbmNlc3RvciggZG9jdW1lbnQuYm9keSwgZG9jdW1lbnQuYm9keS5maXJzdENoaWxkICk7XHJcbiAgICAgKiAvL291dHB1dDogdHJ1ZVxyXG4gICAgICogY29uc29sZS5sb2coIGNvbW1vbkFuY2VzdG9yLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2JvZHknICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgZ2V0Q29tbW9uQW5jZXN0b3I6ZnVuY3Rpb24gKG5vZGVBLCBub2RlQikge1xyXG4gICAgICAgIGlmIChub2RlQSA9PT0gbm9kZUIpXHJcbiAgICAgICAgICAgIHJldHVybiBub2RlQTtcclxuICAgICAgICB2YXIgcGFyZW50c0EgPSBbbm9kZUFdICwgcGFyZW50c0IgPSBbbm9kZUJdLCBwYXJlbnQgPSBub2RlQSwgaSA9IC0xO1xyXG4gICAgICAgIHdoaWxlIChwYXJlbnQgPSBwYXJlbnQucGFyZW50Tm9kZSkge1xyXG4gICAgICAgICAgICBpZiAocGFyZW50ID09PSBub2RlQikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBwYXJlbnRzQS5wdXNoKHBhcmVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHBhcmVudCA9IG5vZGVCO1xyXG4gICAgICAgIHdoaWxlIChwYXJlbnQgPSBwYXJlbnQucGFyZW50Tm9kZSkge1xyXG4gICAgICAgICAgICBpZiAocGFyZW50ID09PSBub2RlQSlcclxuICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnQ7XHJcbiAgICAgICAgICAgIHBhcmVudHNCLnB1c2gocGFyZW50KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcGFyZW50c0EucmV2ZXJzZSgpO1xyXG4gICAgICAgIHBhcmVudHNCLnJldmVyc2UoKTtcclxuICAgICAgICB3aGlsZSAoaSsrLCBwYXJlbnRzQVtpXSA9PT0gcGFyZW50c0JbaV0pIHtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGkgPT0gMCA/IG51bGwgOiBwYXJlbnRzQVtpIC0gMV07XHJcblxyXG4gICAgfSxcclxuICAgIC8qKlxyXG4gICAgICog5riF6Zmkbm9kZeiKgueCueW3puWPs+i/nue7reS4uuepuueahOWFhOW8n2lubGluZeiKgueCuVxyXG4gICAgICogQG1ldGhvZCBjbGVhckVtcHR5U2libGluZ1xyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg5omn6KGM55qE6IqC54K55a+56LGh77yMIOWmguaenOivpeiKgueCueeahOW3puWPs+i/nue7reeahOWFhOW8n+iKgueCueaYr+epuueahGlubGluZeiKgueCue+8jFxyXG4gICAgICog5YiZ6L+Z5Lqb5YWE5byf6IqC54K55bCG6KKr5Yig6ZmkXHJcbiAgICAgKiBAZ3JhbW1hciBVRS5kb20uZG9tVXRpbHMuY2xlYXJFbXB0eVNpYmxpbmcobm9kZSxpZ25vcmVOZXh0KSAgLy9pZ25vcmVOZXh05oyH5a6a5piv5ZCm5b+955Wl5Y+z6L6556m66IqC54K5XHJcbiAgICAgKiBAZ3JhbW1hciBVRS5kb20uZG9tVXRpbHMuY2xlYXJFbXB0eVNpYmxpbmcobm9kZSxpZ25vcmVOZXh0LGlnbm9yZVByZSkgIC8vaWdub3JlUHJl5oyH5a6a5piv5ZCm5b+955Wl5bem6L6556m66IqC54K5XHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPGJvZHk+XHJcbiAgICAgKiAgICAgPGRpdj48L2Rpdj5cclxuICAgICAqICAgICA8c3BhbiBpZD1cInRlc3RcIj48L3NwYW4+XHJcbiAgICAgKiAgICAgPGk+PC9pPlxyXG4gICAgICogICAgIDxiPjwvYj5cclxuICAgICAqICAgICA8ZW0+eHh4PC9lbT5cclxuICAgICAqICAgICA8c3Bhbj48L3NwYW4+XHJcbiAgICAgKiA8L2JvZHk+XHJcbiAgICAgKiA8c2NyaXB0PlxyXG4gICAgICpcclxuICAgICAqICAgICAgVUUuZG9tLmRvbVV0aWxzLmNsZWFyRW1wdHlTaWJsaW5nKCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggXCJ0ZXN0XCIgKSApO1xyXG4gICAgICpcclxuICAgICAqICAgICAgLy9vdXRwdXQ6IDxkaXY+PC9kaXY+PHNwYW4gaWQ9XCJ0ZXN0XCI+PC9zcGFuPjxlbT54eHg8L2VtPjxzcGFuPjwvc3Bhbj5cclxuICAgICAqICAgICAgY29uc29sZS5sb2coIGRvY3VtZW50LmJvZHkuaW5uZXJIVE1MICk7XHJcbiAgICAgKlxyXG4gICAgICogPC9zY3JpcHQ+XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5riF6Zmkbm9kZeiKgueCueW3puWPs+i/nue7reS4uuepuueahOWFhOW8n2lubGluZeiKgueCue+8jCDlpoLmnpxpZ25vcmVOZXh055qE5YC85Li6dHJ1Ze+8jFxyXG4gICAgICog5YiZ5b+955Wl5a+55Y+z6L655YWE5byf6IqC54K555qE5pON5L2c44CCXHJcbiAgICAgKiBAbWV0aG9kIGNsZWFyRW1wdHlTaWJsaW5nXHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZSDmiafooYznmoToioLngrnlr7nosaHvvIwg5aaC5p6c6K+l6IqC54K555qE5bem5Y+z6L+e57ut55qE5YWE5byf6IqC54K55piv56m655qEaW5saW5l6IqC54K577yMXHJcbiAgICAgKiBAcGFyYW0geyBCb29sZWFuIH0gaWdub3JlTmV4dCDmmK/lkKblv73nlaXlv73nlaXlr7nlj7PovrnnmoTlhYTlvJ/oioLngrnnmoTmk43kvZxcclxuICAgICAqIOWImei/meS6m+WFhOW8n+iKgueCueWwhuiiq+WIoOmZpFxyXG4gICAgICogQHNlZSBVRS5kb20uZG9tVXRpbHMuY2xlYXJFbXB0eVNpYmxpbmcoTm9kZSlcclxuICAgICAqL1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5riF6Zmkbm9kZeiKgueCueW3puWPs+i/nue7reS4uuepuueahOWFhOW8n2lubGluZeiKgueCue+8jCDlpoLmnpxpZ25vcmVOZXh055qE5YC85Li6dHJ1Ze+8jFxyXG4gICAgICog5YiZ5b+955Wl5a+55Y+z6L655YWE5byf6IqC54K555qE5pON5L2c77yMIOWmguaenGlnbm9yZVByZeeahOWAvOS4unRydWXvvIzliJnlv73nlaXlr7nlt6bovrnlhYTlvJ/oioLngrnnmoTmk43kvZzjgIJcclxuICAgICAqIEBtZXRob2QgY2xlYXJFbXB0eVNpYmxpbmdcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOaJp+ihjOeahOiKgueCueWvueixoe+8jCDlpoLmnpzor6XoioLngrnnmoTlt6blj7Pov57nu63nmoTlhYTlvJ/oioLngrnmmK/nqbrnmoRpbmxpbmXoioLngrnvvIxcclxuICAgICAqIEBwYXJhbSB7IEJvb2xlYW4gfSBpZ25vcmVOZXh0IOaYr+WQpuW/veeVpeW/veeVpeWvueWPs+i+ueeahOWFhOW8n+iKgueCueeahOaTjeS9nFxyXG4gICAgICogQHBhcmFtIHsgQm9vbGVhbiB9IGlnbm9yZVByZSDmmK/lkKblv73nlaXlv73nlaXlr7nlt6bovrnnmoTlhYTlvJ/oioLngrnnmoTmk43kvZxcclxuICAgICAqIOWImei/meS6m+WFhOW8n+iKgueCueWwhuiiq+WIoOmZpFxyXG4gICAgICogQHNlZSBVRS5kb20uZG9tVXRpbHMuY2xlYXJFbXB0eVNpYmxpbmcoTm9kZSlcclxuICAgICAqL1xyXG4gICAgY2xlYXJFbXB0eVNpYmxpbmc6ZnVuY3Rpb24gKG5vZGUsIGlnbm9yZU5leHQsIGlnbm9yZVByZSkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGNsZWFyKG5leHQsIGRpcikge1xyXG4gICAgICAgICAgICB2YXIgdG1wTm9kZTtcclxuICAgICAgICAgICAgd2hpbGUgKG5leHQgJiYgIWRvbVV0aWxzLmlzQm9va21hcmtOb2RlKG5leHQpICYmIChkb21VdGlscy5pc0VtcHR5SW5saW5lRWxlbWVudChuZXh0KVxyXG4gICAgICAgICAgICAgICAgLy/ov5nph4zkuI3og73miornqbrmoLznrpfov5vmnaXkvJrlkKfnqbrmoLzlubLmjonvvIzlh7rnjrDmloflrZfpl7TnmoTnqbrmoLzkuKLmjonkuoZcclxuICAgICAgICAgICAgICAgIHx8ICFuZXcgUmVnRXhwKCdbXlxcdFxcblxccicgKyBkb21VdGlscy5maWxsQ2hhciArICddJykudGVzdChuZXh0Lm5vZGVWYWx1ZSkgKSkge1xyXG4gICAgICAgICAgICAgICAgdG1wTm9kZSA9IG5leHRbZGlyXTtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShuZXh0KTtcclxuICAgICAgICAgICAgICAgIG5leHQgPSB0bXBOb2RlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgICFpZ25vcmVOZXh0ICYmIGNsZWFyKG5vZGUubmV4dFNpYmxpbmcsICduZXh0U2libGluZycpO1xyXG4gICAgICAgICFpZ25vcmVQcmUgJiYgY2xlYXIobm9kZS5wcmV2aW91c1NpYmxpbmcsICdwcmV2aW91c1NpYmxpbmcnKTtcclxuICAgIH0sXHJcbiAgICAvKipcclxuICAgICAqIOWwhuS4gOS4quaWh+acrOiKgueCuXRleHROb2Rl5ouG5YiG5oiQ5Lik5Liq5paH5pys6IqC54K577yMb2Zmc2V05oyH5a6a5ouG5YiG5L2N572uXHJcbiAgICAgKiBAbWV0aG9kIHNwbGl0XHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gdGV4dE5vZGUg6ZyA6KaB5ouG5YiG55qE5paH5pys6IqC54K55a+56LGhXHJcbiAgICAgKiBAcGFyYW0geyBpbnQgfSBvZmZzZXQg6ZyA6KaB5ouG5YiG55qE5L2N572u77yMIOS9jee9ruiuoeeul+S7jjDlvIDlp4tcclxuICAgICAqIEByZXR1cm4geyBOb2RlIH0g5ouG5YiG5ZCO5b2i5oiQ55qE5paw6IqC54K5XHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPGRpdiBpZD1cInRlc3RcIj5hYmNkZWY8L2Rpdj5cclxuICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgKiAgICAgIHZhciBuZXdOb2RlID0gVUUuZG9tLmRvbVV0aWxzLnNwbGl0KCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggXCJ0ZXN0XCIgKS5maXJzdENoaWxkLCAzICk7XHJcbiAgICAgKiAgICAgIC8vb3V0cHV0OiBkZWZcclxuICAgICAqICAgICAgY29uc29sZS5sb2coIG5ld05vZGUubm9kZVZhbHVlICk7XHJcbiAgICAgKiA8L3NjcmlwdD5cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBzcGxpdDpmdW5jdGlvbiAobm9kZSwgb2Zmc2V0KSB7XHJcbiAgICAgICAgdmFyIGRvYyA9IG5vZGUub3duZXJEb2N1bWVudDtcclxuICAgICAgICBpZiAoYnJvd3Nlci5pZSAmJiBvZmZzZXQgPT0gbm9kZS5ub2RlVmFsdWUubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHZhciBuZXh0ID0gZG9jLmNyZWF0ZVRleHROb2RlKCcnKTtcclxuICAgICAgICAgICAgcmV0dXJuIGRvbVV0aWxzLmluc2VydEFmdGVyKG5vZGUsIG5leHQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgcmV0dmFsID0gbm9kZS5zcGxpdFRleHQob2Zmc2V0KTtcclxuICAgICAgICAvL2llOOS4i3NwbGl0VGV4dOS4jeS8mui3n+aWsGNoaWxkTm9kZXMs5oiR5Lus5omL5Yqo6Kem5Y+R5LuW55qE5pu05pawXHJcbiAgICAgICAgaWYgKGJyb3dzZXIuaWU4KSB7XHJcbiAgICAgICAgICAgIHZhciB0bXBOb2RlID0gZG9jLmNyZWF0ZVRleHROb2RlKCcnKTtcclxuICAgICAgICAgICAgZG9tVXRpbHMuaW5zZXJ0QWZ0ZXIocmV0dmFsLCB0bXBOb2RlKTtcclxuICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHRtcE5vZGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmV0dmFsO1xyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOajgOa1i+aWh+acrOiKgueCuXRleHROb2Rl5piv5ZCm5Li656m66IqC54K577yI5YyF5ous56m65qC844CB5o2i6KGM44CB5Y2g5L2N56ym562J5a2X56ym77yJXHJcbiAgICAgKiBAbWV0aG9kICBpc1doaXRlc3BhY2VcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOmcgOimgeajgOa1i+eahOiKgueCueWvueixoVxyXG4gICAgICogQHJldHVybiB7IEJvb2xlYW4gfSDmo4DmtYvnmoToioLngrnmmK/lkKbkuLrnqbpcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBodG1sXHJcbiAgICAgKiA8ZGl2IGlkPVwidGVzdFwiPlxyXG4gICAgICpcclxuICAgICAqIDwvZGl2PlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqICAgICAgLy9vdXRwdXQ6IHRydWVcclxuICAgICAqICAgICAgY29uc29sZS5sb2coIFVFLmRvbS5kb21VdGlscy5pc1doaXRlc3BhY2UoIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidGVzdFwiKS5maXJzdENoaWxkICkgKTtcclxuICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIGlzV2hpdGVzcGFjZTpmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgIHJldHVybiAhbmV3IFJlZ0V4cCgnW14gXFx0XFxuXFxyJyArIGRvbVV0aWxzLmZpbGxDaGFyICsgJ10nKS50ZXN0KG5vZGUubm9kZVZhbHVlKTtcclxuICAgIH0sXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluWFg+e0oGVsZW1lbnTnm7jlr7nkuo52aWV3cG9ydOeahOS9jee9ruWdkOagh1xyXG4gICAgICogQG1ldGhvZCBnZXRYWVxyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IGVsZW1lbnQg6ZyA6KaB6K6h566X5L2N572u55qE6IqC54K55a+56LGhXHJcbiAgICAgKiBAcmV0dXJuIHsgT2JqZWN0IH0g6L+U5Zue5b2i5aaCe3g6bGVmdCx5OnRvcH3nmoTkuIDkuKprZXktdmFsdWXmmKDlsITlr7nosaHvvIwg5YW25Lit6ZSueOS7o+ihqOawtOW5s+WBj+enu+i3neemu++8jFxyXG4gICAgICogICAgICAgICAgICAgICAgICAgICAgICAgIHnku6PooajlnoLnm7TlgY/np7vot53nprvjgIJcclxuICAgICAqXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogdmFyIGxvY2F0aW9uID0gVUUuZG9tLmRvbVV0aWxzLmdldFhZKCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInRlc3RcIikgKTtcclxuICAgICAqIC8vb3V0cHV0OiB0ZXN055qE5Z2Q5qCH5Li6OiAxMiwgMjRcclxuICAgICAqIGNvbnNvbGUubG9nKCAndGVzdOeahOWdkOagh+S4uu+8miAnLCBsb2NhdGlvbi54LCAnLCcsIGxvY2F0aW9uLnkgKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBnZXRYWTpmdW5jdGlvbiAoZWxlbWVudCkge1xyXG4gICAgICAgIHZhciB4ID0gMCwgeSA9IDA7XHJcbiAgICAgICAgd2hpbGUgKGVsZW1lbnQub2Zmc2V0UGFyZW50KSB7XHJcbiAgICAgICAgICAgIHkgKz0gZWxlbWVudC5vZmZzZXRUb3A7XHJcbiAgICAgICAgICAgIHggKz0gZWxlbWVudC5vZmZzZXRMZWZ0O1xyXG4gICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5vZmZzZXRQYXJlbnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB7ICd4Jzp4LCAneSc6eX07XHJcbiAgICB9LFxyXG4gICAgLyoqXHJcbiAgICAgKiDkuLrlhYPntKBlbGVtZW5057uR5a6a5Y6f55SfRE9N5LqL5Lu277yMdHlwZeS4uuS6i+S7tuexu+Wei++8jGhhbmRsZXLkuLrlpITnkIblh73mlbBcclxuICAgICAqIEBtZXRob2Qgb25cclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBlbGVtZW50IOmcgOimgee7keWumuS6i+S7tueahOiKgueCueWvueixoVxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gdHlwZSDnu5HlrprnmoTkuovku7bnsbvlnotcclxuICAgICAqIEBwYXJhbSB7IEZ1bmN0aW9uIH0gaGFuZGxlciDkuovku7blpITnkIblmahcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiBVRS5kb20uZG9tVXRpbHMub24oZG9jdW1lbnQuYm9keSxcImNsaWNrXCIsZnVuY3Rpb24oZSl7XHJcbiAgICAgKiAgICAgLy9l5Li65LqL5Lu25a+56LGh77yMdGhpc+S4uuiiq+eCueWHu+WFg+e0oOWvueaIj+mCo+S4qlxyXG4gICAgICogfSk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Li65YWD57SgZWxlbWVudOe7keWumuWOn+eUn0RPTeS6i+S7tu+8jHR5cGXkuLrkuovku7bnsbvlnovvvIxoYW5kbGVy5Li65aSE55CG5Ye95pWwXHJcbiAgICAgKiBAbWV0aG9kIG9uXHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gZWxlbWVudCDpnIDopoHnu5Hlrprkuovku7bnmoToioLngrnlr7nosaFcclxuICAgICAqIEBwYXJhbSB7IEFycmF5IH0gdHlwZSDnu5HlrprnmoTkuovku7bnsbvlnovmlbDnu4RcclxuICAgICAqIEBwYXJhbSB7IEZ1bmN0aW9uIH0gaGFuZGxlciDkuovku7blpITnkIblmahcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiBVRS5kb20uZG9tVXRpbHMub24oZG9jdW1lbnQuYm9keSxbXCJjbGlja1wiLFwibW91c2Vkb3duXCJdLGZ1bmN0aW9uKGV2dCl7XHJcbiAgICAgKiAgICAgLy9ldnTkuLrkuovku7blr7nosaHvvIx0aGlz5Li66KKr54K55Ye75YWD57Sg5a+56LGhXHJcbiAgICAgKiB9KTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBvbjpmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgaGFuZGxlcikge1xyXG5cclxuICAgICAgICB2YXIgdHlwZXMgPSB1dGlscy5pc0FycmF5KHR5cGUpID8gdHlwZSA6IHV0aWxzLnRyaW0odHlwZSkuc3BsaXQoL1xccysvKSxcclxuICAgICAgICAgICAgayA9IHR5cGVzLmxlbmd0aDtcclxuICAgICAgICBpZiAoaykgd2hpbGUgKGstLSkge1xyXG4gICAgICAgICAgICB0eXBlID0gdHlwZXNba107XHJcbiAgICAgICAgICAgIGlmIChlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHtcclxuICAgICAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBoYW5kbGVyLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWhhbmRsZXIuX2QpIHtcclxuICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLl9kID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHMgOiBbXVxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YXIga2V5ID0gdHlwZSArIGhhbmRsZXIudG9TdHJpbmcoKSxpbmRleCA9IHV0aWxzLmluZGV4T2YoaGFuZGxlci5fZC5lbHMsZWxlbWVudCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWhhbmRsZXIuX2Rba2V5XSB8fCBpbmRleCA9PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGluZGV4ID09IC0xKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5fZC5lbHMucHVzaChlbGVtZW50KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoIWhhbmRsZXIuX2Rba2V5XSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIuX2Rba2V5XSA9IGZ1bmN0aW9uIChldnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGVyLmNhbGwoZXZ0LnNyY0VsZW1lbnQsIGV2dCB8fCB3aW5kb3cuZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuYXR0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGhhbmRsZXIuX2Rba2V5XSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxlbWVudCA9IG51bGw7XHJcbiAgICB9LFxyXG4gICAgLyoqXHJcbiAgICAgKiDop6PpmaRET03kuovku7bnu5HlrppcclxuICAgICAqIEBtZXRob2QgdW5cclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBlbGVtZW50IOmcgOimgeino+mZpOS6i+S7tue7keWumueahOiKgueCueWvueixoVxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gdHlwZSDpnIDopoHmjqXop6bnu5HlrprnmoTkuovku7bnsbvlnotcclxuICAgICAqIEBwYXJhbSB7IEZ1bmN0aW9uIH0gaGFuZGxlciDlr7nlupTnmoTkuovku7blpITnkIblmahcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiBVRS5kb20uZG9tVXRpbHMudW4oZG9jdW1lbnQuYm9keSxcImNsaWNrXCIsZnVuY3Rpb24oZXZ0KXtcclxuICAgICAqICAgICAvL2V2dOS4uuS6i+S7tuWvueixoe+8jHRoaXPkuLrooqvngrnlh7vlhYPntKDlr7nosaFcclxuICAgICAqIH0pO1xyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIOino+mZpERPTeS6i+S7tue7keWumlxyXG4gICAgICogQG1ldGhvZCB1blxyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IGVsZW1lbnQg6ZyA6KaB6Kej6Zmk5LqL5Lu257uR5a6a55qE6IqC54K55a+56LGhXHJcbiAgICAgKiBAcGFyYW0geyBBcnJheSB9IHR5cGUg6ZyA6KaB5o6l6Kem57uR5a6a55qE5LqL5Lu257G75Z6L5pWw57uEXHJcbiAgICAgKiBAcGFyYW0geyBGdW5jdGlvbiB9IGhhbmRsZXIg5a+55bqU55qE5LqL5Lu25aSE55CG5ZmoXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogVUUuZG9tLmRvbVV0aWxzLnVuKGRvY3VtZW50LmJvZHksIFtcImNsaWNrXCIsXCJtb3VzZWRvd25cIl0sZnVuY3Rpb24oZXZ0KXtcclxuICAgICAqICAgICAvL2V2dOS4uuS6i+S7tuWvueixoe+8jHRoaXPkuLrooqvngrnlh7vlhYPntKDlr7nosaFcclxuICAgICAqIH0pO1xyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIHVuOmZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBoYW5kbGVyKSB7XHJcbiAgICAgICAgdmFyIHR5cGVzID0gdXRpbHMuaXNBcnJheSh0eXBlKSA/IHR5cGUgOiB1dGlscy50cmltKHR5cGUpLnNwbGl0KC9cXHMrLyksXHJcbiAgICAgICAgICAgIGsgPSB0eXBlcy5sZW5ndGg7XHJcbiAgICAgICAgaWYgKGspIHdoaWxlIChrLS0pIHtcclxuICAgICAgICAgICAgdHlwZSA9IHR5cGVzW2tdO1xyXG4gICAgICAgICAgICBpZiAoZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKSB7XHJcbiAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgaGFuZGxlciwgZmFsc2UpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIGtleSA9IHR5cGUgKyBoYW5kbGVyLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgICAgICB0cnl7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgaGFuZGxlci5fZCA/IGhhbmRsZXIuX2Rba2V5XSA6IGhhbmRsZXIpO1xyXG4gICAgICAgICAgICAgICAgfWNhdGNoKGUpe31cclxuICAgICAgICAgICAgICAgIGlmIChoYW5kbGVyLl9kICYmIGhhbmRsZXIuX2Rba2V5XSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHV0aWxzLmluZGV4T2YoaGFuZGxlci5fZC5lbHMsZWxlbWVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoaW5kZXghPS0xKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5fZC5lbHMuc3BsaWNlKGluZGV4LDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLl9kLmVscy5sZW5ndGggPT0gMCAmJiBkZWxldGUgaGFuZGxlci5fZFtrZXldO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOavlOi+g+iKgueCuW5vZGVB5LiO6IqC54K5bm9kZULmmK/lkKblhbfmnInnm7jlkIznmoTmoIfnrb7lkI3jgIHlsZ7mgKflkI3ku6Xlj4rlsZ7mgKflgLxcclxuICAgICAqIEBtZXRob2QgIGlzU2FtZUVsZW1lbnRcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlQSDpnIDopoHmr5TovoPnmoToioLngrlcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlQiDpnIDopoHmr5TovoPnmoToioLngrlcclxuICAgICAqIEByZXR1cm4geyBCb29sZWFuIH0g5Lik5Liq6IqC54K55piv5ZCm5YW35pyJ55u45ZCM55qE5qCH562+5ZCN44CB5bGe5oCn5ZCN5Lul5Y+K5bGe5oCn5YC8XHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPHNwYW4gc3R5bGU9XCJmb250LXNpemU6MTJweFwiPnNzc3M8L3NwYW4+XHJcbiAgICAgKiA8c3BhbiBzdHlsZT1cImZvbnQtc2l6ZToxMnB4XCI+YmJiYmI8L3NwYW4+XHJcbiAgICAgKiA8c3BhbiBzdHlsZT1cImZvbnQtc2l6ZToxM3B4XCI+c3Nzczwvc3Bhbj5cclxuICAgICAqIDxzcGFuIHN0eWxlPVwiZm9udC1zaXplOjE0cHhcIj5iYmJiYjwvc3Bhbj5cclxuICAgICAqXHJcbiAgICAgKiA8c2NyaXB0PlxyXG4gICAgICpcclxuICAgICAqICAgICB2YXIgbm9kZXMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSggXCJzcGFuXCIgKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IHRydWVcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggVUUuZG9tLmRvbVV0aWxzLmlzU2FtZUVsZW1lbnQoIG5vZGVzWzBdLCBub2Rlc1sxXSApICk7XHJcbiAgICAgKlxyXG4gICAgICogICAgIC8vb3V0cHV0OiBmYWxzZVxyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCBVRS5kb20uZG9tVXRpbHMuaXNTYW1lRWxlbWVudCggbm9kZXNbMl0sIG5vZGVzWzNdICkgKTtcclxuICAgICAqXHJcbiAgICAgKiA8L3NjcmlwdD5cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBpc1NhbWVFbGVtZW50OmZ1bmN0aW9uIChub2RlQSwgbm9kZUIpIHtcclxuICAgICAgICBpZiAobm9kZUEudGFnTmFtZSAhPSBub2RlQi50YWdOYW1lKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHRoaXNBdHRycyA9IG5vZGVBLmF0dHJpYnV0ZXMsXHJcbiAgICAgICAgICAgIG90aGVyQXR0cnMgPSBub2RlQi5hdHRyaWJ1dGVzO1xyXG4gICAgICAgIGlmICghaWUgJiYgdGhpc0F0dHJzLmxlbmd0aCAhPSBvdGhlckF0dHJzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBhdHRyQSwgYXR0ckIsIGFsID0gMCwgYmwgPSAwO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBhdHRyQSA9IHRoaXNBdHRyc1tpKytdOykge1xyXG4gICAgICAgICAgICBpZiAoYXR0ckEubm9kZU5hbWUgPT0gJ3N0eWxlJykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGF0dHJBLnNwZWNpZmllZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFsKys7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoZG9tVXRpbHMuaXNTYW1lU3R5bGUobm9kZUEsIG5vZGVCKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGllKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoYXR0ckEuc3BlY2lmaWVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWwrKztcclxuICAgICAgICAgICAgICAgICAgICBhdHRyQiA9IG90aGVyQXR0cnMuZ2V0TmFtZWRJdGVtKGF0dHJBLm5vZGVOYW1lKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBhdHRyQiA9IG5vZGVCLmF0dHJpYnV0ZXNbYXR0ckEubm9kZU5hbWVdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICghYXR0ckIuc3BlY2lmaWVkIHx8IGF0dHJBLm5vZGVWYWx1ZSAhPSBhdHRyQi5ub2RlVmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDmnInlj6/og71hdHRyQueahOWxnuaAp+WMheWQq+S6hmF0dHJB55qE5bGe5oCn5LmL5aSW6L+Y5pyJ6Ieq5bex55qE5bGe5oCnXHJcbiAgICAgICAgaWYgKGllKSB7XHJcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGF0dHJCID0gb3RoZXJBdHRyc1tpKytdOykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGF0dHJCLnNwZWNpZmllZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGJsKys7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGFsICE9IGJsKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9LFxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yik5pat6IqC54K5bm9kZUHkuI7oioLngrlub2RlQueahOWFg+e0oOeahHN0eWxl5bGe5oCn5piv5ZCm5LiA6Ie0XHJcbiAgICAgKiBAbWV0aG9kIGlzU2FtZVN0eWxlXHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZUEg6ZyA6KaB5q+U6L6D55qE6IqC54K5XHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZUIg6ZyA6KaB5q+U6L6D55qE6IqC54K5XHJcbiAgICAgKiBAcmV0dXJuIHsgQm9vbGVhbiB9IOS4pOS4quiKgueCueaYr+WQpuWFt+acieebuOWQjOeahHN0eWxl5bGe5oCn5YC8XHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPHNwYW4gc3R5bGU9XCJmb250LXNpemU6MTJweFwiPnNzc3M8L3NwYW4+XHJcbiAgICAgKiA8c3BhbiBzdHlsZT1cImZvbnQtc2l6ZToxMnB4XCI+YmJiYmI8L3NwYW4+XHJcbiAgICAgKiA8c3BhbiBzdHlsZT1cImZvbnQtc2l6ZToxM3B4XCI+c3Nzczwvc3Bhbj5cclxuICAgICAqIDxzcGFuIHN0eWxlPVwiZm9udC1zaXplOjE0cHhcIj5iYmJiYjwvc3Bhbj5cclxuICAgICAqXHJcbiAgICAgKiA8c2NyaXB0PlxyXG4gICAgICpcclxuICAgICAqICAgICB2YXIgbm9kZXMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSggXCJzcGFuXCIgKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IHRydWVcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggVUUuZG9tLmRvbVV0aWxzLmlzU2FtZVN0eWxlKCBub2Rlc1swXSwgbm9kZXNbMV0gKSApO1xyXG4gICAgICpcclxuICAgICAqICAgICAvL291dHB1dDogZmFsc2VcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggVUUuZG9tLmRvbVV0aWxzLmlzU2FtZVN0eWxlKCBub2Rlc1syXSwgbm9kZXNbM10gKSApO1xyXG4gICAgICpcclxuICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIGlzU2FtZVN0eWxlOmZ1bmN0aW9uIChub2RlQSwgbm9kZUIpIHtcclxuICAgICAgICB2YXIgc3R5bGVBID0gbm9kZUEuc3R5bGUuY3NzVGV4dC5yZXBsYWNlKC8oID87ID8pL2csICc7JykucmVwbGFjZSgvKCA/OiA/KS9nLCAnOicpLFxyXG4gICAgICAgICAgICBzdHlsZUIgPSBub2RlQi5zdHlsZS5jc3NUZXh0LnJlcGxhY2UoLyggPzsgPykvZywgJzsnKS5yZXBsYWNlKC8oID86ID8pL2csICc6Jyk7XHJcbiAgICAgICAgaWYgKGJyb3dzZXIub3BlcmEpIHtcclxuICAgICAgICAgICAgc3R5bGVBID0gbm9kZUEuc3R5bGU7XHJcbiAgICAgICAgICAgIHN0eWxlQiA9IG5vZGVCLnN0eWxlO1xyXG4gICAgICAgICAgICBpZiAoc3R5bGVBLmxlbmd0aCAhPSBzdHlsZUIubGVuZ3RoKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBwIGluIHN0eWxlQSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKC9eKFxcZCt8Y3NzdGV4dCkkL2kudGVzdChwKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHN0eWxlQVtwXSAhPSBzdHlsZUJbcF0pIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghc3R5bGVBIHx8ICFzdHlsZUIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHN0eWxlQSA9PSBzdHlsZUI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHN0eWxlQSA9IHN0eWxlQS5zcGxpdCgnOycpO1xyXG4gICAgICAgIHN0eWxlQiA9IHN0eWxlQi5zcGxpdCgnOycpO1xyXG4gICAgICAgIGlmIChzdHlsZUEubGVuZ3RoICE9IHN0eWxlQi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKHZhciBpID0gMCwgY2k7IGNpID0gc3R5bGVBW2krK107KSB7XHJcbiAgICAgICAgICAgIGlmICh1dGlscy5pbmRleE9mKHN0eWxlQiwgY2kpID09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9LFxyXG4gICAgLyoqXHJcbiAgICAgKiDmo4Dmn6XoioLngrlub2Rl5piv5ZCm5Li6YmxvY2vlhYPntKBcclxuICAgICAqIEBtZXRob2QgaXNCbG9ja0VsbVxyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg6ZyA6KaB5qOA5rWL55qE6IqC54K55a+56LGhXHJcbiAgICAgKiBAcmV0dXJuIHsgQm9vbGVhbiB9IOaYr+WQpuaYr2Jsb2Nr5YWD57Sg6IqC54K5XHJcbiAgICAgKiBAd2FybmluZyDor6Xmlrnms5XnmoTliKTmlq3op4TliJnlpoLkuIvvvJog5aaC5p6c6K+l5YWD57Sg5Y6f5pys5pivYmxvY2vlhYPntKDvvIwg5YiZ5LiN6K666K+l5YWD57Sg5b2T5YmN55qEY3Nz5qC35byP5piv5LuA5LmI6YO95Lya6L+U5ZuedHJ1Ze+8m1xyXG4gICAgICogICAgICAgICAg5ZCm5YiZ77yM5qOA5rWL6K+l5YWD57Sg55qEY3Nz5qC35byP77yMIOWmguaenOivpeWFg+e0oOW9k+WJjeaYr2Jsb2Nr5YWD57Sg77yMIOWImei/lOWbnnRydWXjgIIg5YW25L2Z5oOF5Ya15LiL6YO96L+U5ZueZmFsc2XjgIJcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBodG1sXHJcbiAgICAgKiA8c3BhbiBpZD1cInRlc3QxXCIgc3R5bGU9XCJkaXNwbGF5OiBibG9ja1wiPjwvc3Bhbj5cclxuICAgICAqIDxzcGFuIGlkPVwidGVzdDJcIj48L3NwYW4+XHJcbiAgICAgKiA8ZGl2IGlkPVwidGVzdDNcIiBzdHlsZT1cImRpc3BsYXk6IGlubGluZVwiPjwvZGl2PlxyXG4gICAgICpcclxuICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgKlxyXG4gICAgICogICAgIC8vb3V0cHV0OiB0cnVlXHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIFVFLmRvbS5kb21VdGlscy5pc0Jsb2NrRWxtKCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInRlc3QxXCIpICkgKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IGZhbHNlXHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIFVFLmRvbS5kb21VdGlscy5pc0Jsb2NrRWxtKCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInRlc3QyXCIpICkgKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IHRydWVcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggVUUuZG9tLmRvbVV0aWxzLmlzQmxvY2tFbG0oIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidGVzdDNcIikgKSApO1xyXG4gICAgICpcclxuICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIGlzQmxvY2tFbG06ZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PSAxICYmIChkdGQuJGJsb2NrW25vZGUudGFnTmFtZV0gfHwgc3R5bGVCbG9ja1tkb21VdGlscy5nZXRDb21wdXRlZFN0eWxlKG5vZGUsICdkaXNwbGF5JyldKSAmJiAhZHRkLiRub25DaGlsZFtub2RlLnRhZ05hbWVdO1xyXG4gICAgfSxcclxuICAgIC8qKlxyXG4gICAgICog5qOA5rWLbm9kZeiKgueCueaYr+WQpuS4umJvZHnoioLngrlcclxuICAgICAqIEBtZXRob2QgaXNCb2R5XHJcbiAgICAgKiBAcGFyYW0geyBFbGVtZW50IH0gbm9kZSDpnIDopoHmo4DmtYvnmoRkb23lhYPntKBcclxuICAgICAqIEByZXR1cm4geyBCb29sZWFuIH0g57uZ5a6a55qE5YWD57Sg5piv5ZCm5pivYm9keeWFg+e0oFxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIC8vb3V0cHV0OiB0cnVlXHJcbiAgICAgKiBjb25zb2xlLmxvZyggVUUuZG9tLmRvbVV0aWxzLmlzQm9keSggZG9jdW1lbnQuYm9keSApICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgaXNCb2R5OmZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgcmV0dXJuICBub2RlICYmIG5vZGUubm9kZVR5cGUgPT0gMSAmJiBub2RlLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAnYm9keSc7XHJcbiAgICB9LFxyXG4gICAgLyoqXHJcbiAgICAgKiDku6Vub2Rl6IqC54K55Li65YiG55WM77yM5bCG6K+l6IqC54K555qE5oyH5a6a56WW5YWI6IqC54K5cGFyZW505ouG5YiG5oiQ5Lik5Liq54us56uL55qE6IqC54K577yMXHJcbiAgICAgKiDmi4bliIblvaLmiJDnmoTkuKTkuKroioLngrnkuYvpl7TmmK9ub2Rl6IqC54K5XHJcbiAgICAgKiBAbWV0aG9kIGJyZWFrUGFyZW50XHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZSDkvZzkuLrliIbnlYznmoToioLngrnlr7nosaFcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBwYXJlbnQg6K+l6IqC54K55b+F6aG75pivbm9kZeiKgueCueeahOelluWFiOiKgueCue+8jCDkuJTmmK9ibG9ja+iKgueCueOAglxyXG4gICAgICogQHJldHVybiB7IE5vZGUgfSDnu5nlrprnmoRub2Rl5YiG55WM6IqC54K5XHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICpcclxuICAgICAqICAgICAgdmFyIG5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3BhblwiKSxcclxuICAgICAqICAgICAgICAgIHdyYXBOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggXCJkaXZcIiApLFxyXG4gICAgICogICAgICAgICAgcGFyZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInBcIik7XHJcbiAgICAgKlxyXG4gICAgICogICAgICBwYXJlbnQuYXBwZW5kQ2hpbGQoIG5vZGUgKTtcclxuICAgICAqICAgICAgd3JhcE5vZGUuYXBwZW5kQ2hpbGQoIHBhcmVudCApO1xyXG4gICAgICpcclxuICAgICAqICAgICAgLy/mi4bliIbliY1cclxuICAgICAqICAgICAgLy9vdXRwdXQ6IDxwPjxzcGFuPjwvc3Bhbj48L3A+XHJcbiAgICAgKiAgICAgIGNvbnNvbGUubG9nKCB3cmFwTm9kZS5pbm5lckhUTUwgKTtcclxuICAgICAqXHJcbiAgICAgKlxyXG4gICAgICogICAgICBVRS5kb20uZG9tVXRpbHMuYnJlYWtQYXJlbnQoIG5vZGUsIHBhcmVudCApO1xyXG4gICAgICogICAgICAvL+aLhuWIhuWQjlxyXG4gICAgICogICAgICAvL291dHB1dDogPHA+PC9wPjxzcGFuPjwvc3Bhbj48cD48L3A+XHJcbiAgICAgKiAgICAgIGNvbnNvbGUubG9nKCB3cmFwTm9kZS5pbm5lckhUTUwgKTtcclxuICAgICAqXHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgYnJlYWtQYXJlbnQ6ZnVuY3Rpb24gKG5vZGUsIHBhcmVudCkge1xyXG4gICAgICAgIHZhciB0bXBOb2RlLFxyXG4gICAgICAgICAgICBwYXJlbnRDbG9uZSA9IG5vZGUsXHJcbiAgICAgICAgICAgIGNsb25lID0gbm9kZSxcclxuICAgICAgICAgICAgbGVmdE5vZGVzLFxyXG4gICAgICAgICAgICByaWdodE5vZGVzO1xyXG4gICAgICAgIGRvIHtcclxuICAgICAgICAgICAgcGFyZW50Q2xvbmUgPSBwYXJlbnRDbG9uZS5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICBpZiAobGVmdE5vZGVzKSB7XHJcbiAgICAgICAgICAgICAgICB0bXBOb2RlID0gcGFyZW50Q2xvbmUuY2xvbmVOb2RlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIHRtcE5vZGUuYXBwZW5kQ2hpbGQobGVmdE5vZGVzKTtcclxuICAgICAgICAgICAgICAgIGxlZnROb2RlcyA9IHRtcE5vZGU7XHJcbiAgICAgICAgICAgICAgICB0bXBOb2RlID0gcGFyZW50Q2xvbmUuY2xvbmVOb2RlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIHRtcE5vZGUuYXBwZW5kQ2hpbGQocmlnaHROb2Rlcyk7XHJcbiAgICAgICAgICAgICAgICByaWdodE5vZGVzID0gdG1wTm9kZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGxlZnROb2RlcyA9IHBhcmVudENsb25lLmNsb25lTm9kZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICByaWdodE5vZGVzID0gbGVmdE5vZGVzLmNsb25lTm9kZShmYWxzZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgd2hpbGUgKHRtcE5vZGUgPSBjbG9uZS5wcmV2aW91c1NpYmxpbmcpIHtcclxuICAgICAgICAgICAgICAgIGxlZnROb2Rlcy5pbnNlcnRCZWZvcmUodG1wTm9kZSwgbGVmdE5vZGVzLmZpcnN0Q2hpbGQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHdoaWxlICh0bXBOb2RlID0gY2xvbmUubmV4dFNpYmxpbmcpIHtcclxuICAgICAgICAgICAgICAgIHJpZ2h0Tm9kZXMuYXBwZW5kQ2hpbGQodG1wTm9kZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2xvbmUgPSBwYXJlbnRDbG9uZTtcclxuICAgICAgICB9IHdoaWxlIChwYXJlbnQgIT09IHBhcmVudENsb25lKTtcclxuICAgICAgICB0bXBOb2RlID0gcGFyZW50LnBhcmVudE5vZGU7XHJcbiAgICAgICAgdG1wTm9kZS5pbnNlcnRCZWZvcmUobGVmdE5vZGVzLCBwYXJlbnQpO1xyXG4gICAgICAgIHRtcE5vZGUuaW5zZXJ0QmVmb3JlKHJpZ2h0Tm9kZXMsIHBhcmVudCk7XHJcbiAgICAgICAgdG1wTm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgcmlnaHROb2Rlcyk7XHJcbiAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHBhcmVudCk7XHJcbiAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICB9LFxyXG4gICAgLyoqXHJcbiAgICAgKiDmo4Dmn6XoioLngrlub2Rl5piv5ZCm5piv56m6aW5saW5l6IqC54K5XHJcbiAgICAgKiBAbWV0aG9kICBpc0VtcHR5SW5saW5lRWxlbWVudFxyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg6ZyA6KaB5qOA5rWL55qE6IqC54K55a+56LGhXHJcbiAgICAgKiBAcmV0dXJuIHsgTnVtYmVyIH0gIOWmguaenOe7meWumueahOiKgueCueaYr+epuueahGlubGluZeiKgueCue+8jCDliJnov5Tlm54xLCDlkKbliJnov5Tlm54w44CCXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPGI+PGk+PC9pPjwvYj4gPT4gMVxyXG4gICAgICogPGI+PGk+PC9pPjx1PjwvdT48L2I+ID0+IDFcclxuICAgICAqIDxiPjwvYj4gPT4gMVxyXG4gICAgICogPGI+eHg8aT48L2k+PC9iPiA9PiAwXHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgaXNFbXB0eUlubGluZUVsZW1lbnQ6ZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSAhPSAxIHx8ICFkdGQuJHJlbW92ZUVtcHR5WyBub2RlLnRhZ05hbWUgXSkge1xyXG4gICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgbm9kZSA9IG5vZGUuZmlyc3RDaGlsZDtcclxuICAgICAgICB3aGlsZSAobm9kZSkge1xyXG4gICAgICAgICAgICAvL+WmguaenOaYr+WIm+W7uueahGJvb2ttYXJr5bCx6Lez6L+HXHJcbiAgICAgICAgICAgIGlmIChkb21VdGlscy5pc0Jvb2ttYXJrTm9kZShub2RlKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSAmJiAhZG9tVXRpbHMuaXNFbXB0eUlubGluZUVsZW1lbnQobm9kZSkgfHxcclxuICAgICAgICAgICAgICAgIG5vZGUubm9kZVR5cGUgPT0gMyAmJiAhZG9tVXRpbHMuaXNXaGl0ZXNwYWNlKG5vZGUpXHJcbiAgICAgICAgICAgICAgICApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG5vZGUgPSBub2RlLm5leHRTaWJsaW5nO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gMTtcclxuXHJcbiAgICB9LFxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yig6Zmkbm9kZeiKgueCueS4i+mmluWwvuS4pOerr+eahOepuueZveaWh+acrOWtkOiKgueCuVxyXG4gICAgICogQG1ldGhvZCB0cmltV2hpdGVUZXh0Tm9kZVxyXG4gICAgICogQHBhcmFtIHsgRWxlbWVudCB9IG5vZGUg6ZyA6KaB5omn6KGM5Yig6Zmk5pON5L2c55qE5YWD57Sg5a+56LGhXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogICAgICB2YXIgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgKlxyXG4gICAgICogICAgICBub2RlLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggXCJcIiApICk7XHJcbiAgICAgKlxyXG4gICAgICogICAgICBub2RlLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpICk7XHJcbiAgICAgKlxyXG4gICAgICogICAgICBub2RlLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggXCJcIiApICk7XHJcbiAgICAgKlxyXG4gICAgICogICAgICAvLzNcclxuICAgICAqICAgICAgY29uc29sZS5sb2coIG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgIFVFLmRvbS5kb21VdGlscy50cmltV2hpdGVUZXh0Tm9kZSggbm9kZSApO1xyXG4gICAgICpcclxuICAgICAqICAgICAgLy8xXHJcbiAgICAgKiAgICAgIGNvbnNvbGUubG9nKCBub2RlLmNoaWxkTm9kZXMubGVuZ3RoICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgdHJpbVdoaXRlVGV4dE5vZGU6ZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICBmdW5jdGlvbiByZW1vdmUoZGlyKSB7XHJcbiAgICAgICAgICAgIHZhciBjaGlsZDtcclxuICAgICAgICAgICAgd2hpbGUgKChjaGlsZCA9IG5vZGVbZGlyXSkgJiYgY2hpbGQubm9kZVR5cGUgPT0gMyAmJiBkb21VdGlscy5pc1doaXRlc3BhY2UoY2hpbGQpKSB7XHJcbiAgICAgICAgICAgICAgICBub2RlLnJlbW92ZUNoaWxkKGNoaWxkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZW1vdmUoJ2ZpcnN0Q2hpbGQnKTtcclxuICAgICAgICByZW1vdmUoJ2xhc3RDaGlsZCcpO1xyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWQiOW5tm5vZGXoioLngrnkuIvnm7jlkIznmoTlrZDoioLngrlcclxuICAgICAqIEBuYW1lIG1lcmdlQ2hpbGRcclxuICAgICAqIEBkZXNjXHJcbiAgICAgKiBVRS5kb20uZG9tVXRpbHMubWVyZ2VDaGlsZChub2RlLHRhZ05hbWUpIC8vdGFnTmFtZeimgeWQiOW5tueahOWtkOiKgueCueeahOagh+etvlxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIDxwPjxzcGFuIHN0eWxlPVwiZm9udC1zaXplOjEycHg7XCI+eHg8c3BhbiBzdHlsZT1cImZvbnQtc2l6ZToxMnB4O1wiPmFhPC9zcGFuPnh4PC9zcGFuPjwvcD5cclxuICAgICAqID09PiBVRS5kb20uZG9tVXRpbHMubWVyZ2VDaGlsZChub2RlLCdzcGFuJylcclxuICAgICAqIDxwPjxzcGFuIHN0eWxlPVwiZm9udC1zaXplOjEycHg7XCI+eHhhYXh4PC9zcGFuPjwvcD5cclxuICAgICAqL1xyXG4gICAgbWVyZ2VDaGlsZDpmdW5jdGlvbiAobm9kZSwgdGFnTmFtZSwgYXR0cnMpIHtcclxuICAgICAgICB2YXIgbGlzdCA9IGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKG5vZGUsIG5vZGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpKTtcclxuICAgICAgICBmb3IgKHZhciBpID0gMCwgY2k7IGNpID0gbGlzdFtpKytdOykge1xyXG4gICAgICAgICAgICBpZiAoIWNpLnBhcmVudE5vZGUgfHwgZG9tVXRpbHMuaXNCb29rbWFya05vZGUoY2kpKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvL3NwYW7ljZXni6zlpITnkIZcclxuICAgICAgICAgICAgaWYgKGNpLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAnc3BhbicpIHtcclxuICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBjaS5wYXJlbnROb2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMudHJpbVdoaXRlVGV4dE5vZGUobm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggPT0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlLnN0eWxlLmNzc1RleHQgPSBjaS5zdHlsZS5jc3NUZXh0ICsgXCI7XCIgKyBub2RlLnN0eWxlLmNzc1RleHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShjaSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNpLnN0eWxlLmNzc1RleHQgPSBub2RlLnN0eWxlLmNzc1RleHQgKyAnOycgKyBjaS5zdHlsZS5jc3NUZXh0O1xyXG4gICAgICAgICAgICAgICAgaWYgKGF0dHJzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN0eWxlID0gYXR0cnMuc3R5bGU7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlID0gc3R5bGUuc3BsaXQoJzsnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIHM7IHMgPSBzdHlsZVtqKytdOykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2kuc3R5bGVbdXRpbHMuY3NzU3R5bGVUb0RvbVN0eWxlKHMuc3BsaXQoJzonKVswXSldID0gcy5zcGxpdCgnOicpWzFdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGRvbVV0aWxzLmlzU2FtZVN0eWxlKGNpLCBub2RlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShjaSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoZG9tVXRpbHMuaXNTYW1lRWxlbWVudChub2RlLCBjaSkpIHtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShjaSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Y6f55Sf5pa55rOVZ2V0RWxlbWVudHNCeVRhZ05hbWXnmoTlsIHoo4VcclxuICAgICAqIEBtZXRob2QgZ2V0RWxlbWVudHNCeVRhZ05hbWVcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOebruagh+iKgueCueWvueixoVxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gdGFnTmFtZSDpnIDopoHmn6Xmib7nmoToioLngrnnmoR0YWdOYW1l77yMIOWkmuS4qnRhZ05hbWXku6XnqbrmoLzliIblibJcclxuICAgICAqIEByZXR1cm4geyBBcnJheSB9IOespuWQiOadoeS7tueahOiKgueCuembhuWQiFxyXG4gICAgICovXHJcbiAgICBnZXRFbGVtZW50c0J5VGFnTmFtZTpmdW5jdGlvbiAobm9kZSwgbmFtZSxmaWx0ZXIpIHtcclxuICAgICAgICBpZihmaWx0ZXIgJiYgdXRpbHMuaXNTdHJpbmcoZmlsdGVyKSl7XHJcbiAgICAgICAgICAgdmFyIGNsYXNzTmFtZSA9IGZpbHRlcjtcclxuICAgICAgICAgICBmaWx0ZXIgPSAgZnVuY3Rpb24obm9kZSl7cmV0dXJuIGRvbVV0aWxzLmhhc0NsYXNzKG5vZGUsY2xhc3NOYW1lKX1cclxuICAgICAgICB9XHJcbiAgICAgICAgbmFtZSA9IHV0aWxzLnRyaW0obmFtZSkucmVwbGFjZSgvWyBdezIsfS9nLCcgJykuc3BsaXQoJyAnKTtcclxuICAgICAgICB2YXIgYXJyID0gW107XHJcbiAgICAgICAgZm9yKHZhciBuID0gMCxuaTtuaT1uYW1lW24rK107KXtcclxuICAgICAgICAgICAgdmFyIGxpc3QgPSBub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKG5pKTtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IGxpc3RbaSsrXTspIHtcclxuICAgICAgICAgICAgICAgIGlmKCFmaWx0ZXIgfHwgZmlsdGVyKGNpKSlcclxuICAgICAgICAgICAgICAgICAgICBhcnIucHVzaChjaSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBhcnI7XHJcbiAgICB9LFxyXG4gICAgLyoqXHJcbiAgICAgKiDlsIboioLngrlub2Rl5o+Q5Y+W5Yiw54i26IqC54K55LiKXHJcbiAgICAgKiBAbWV0aG9kIG1lcmdlVG9QYXJlbnRcclxuICAgICAqIEBwYXJhbSB7IEVsZW1lbnQgfSBub2RlIOmcgOimgeaPkOWPlueahOWFg+e0oOWvueixoVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGh0bWxcclxuICAgICAqIDxkaXYgaWQ9XCJwYXJlbnRcIj5cclxuICAgICAqICAgICA8ZGl2IGlkPVwic3ViXCI+XHJcbiAgICAgKiAgICAgICAgIDxzcGFuIGlkPVwiY2hpbGRcIj48L3NwYW4+XHJcbiAgICAgKiAgICAgPC9kaXY+XHJcbiAgICAgKiA8L2Rpdj5cclxuICAgICAqXHJcbiAgICAgKiA8c2NyaXB0PlxyXG4gICAgICpcclxuICAgICAqICAgICB2YXIgY2hpbGQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggXCJjaGlsZFwiICk7XHJcbiAgICAgKlxyXG4gICAgICogICAgIC8vb3V0cHV0OiBzdWJcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggY2hpbGQucGFyZW50Tm9kZS5pZCApO1xyXG4gICAgICpcclxuICAgICAqICAgICBVRS5kb20uZG9tVXRpbHMubWVyZ2VUb1BhcmVudCggY2hpbGQgKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IHBhcmVudFxyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCBjaGlsZC5wYXJlbnROb2RlLmlkICk7XHJcbiAgICAgKlxyXG4gICAgICogPC9zY3JpcHQ+XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgbWVyZ2VUb1BhcmVudDpmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgIHZhciBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7XHJcbiAgICAgICAgd2hpbGUgKHBhcmVudCAmJiBkdGQuJHJlbW92ZUVtcHR5W3BhcmVudC50YWdOYW1lXSkge1xyXG4gICAgICAgICAgICBpZiAocGFyZW50LnRhZ05hbWUgPT0gbm9kZS50YWdOYW1lIHx8IHBhcmVudC50YWdOYW1lID09ICdBJykgey8v6ZKI5a+5Yeagh+etvuWNleeLrOWkhOeQhlxyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMudHJpbVdoaXRlVGV4dE5vZGUocGFyZW50KTtcclxuICAgICAgICAgICAgICAgIC8vc3BhbumcgOimgeeJueauiuWkhOeQhiAg5LiN5aSE55CG6L+Z5qC355qE5oOF5Ya1IDxzcGFuIHN0bHllPVwiY29sb3I6I2ZmZlwiPnh4eDxzcGFuIHN0eWxlPVwiY29sb3I6I2NjY1wiPnh4eDwvc3Bhbj54eHg8L3NwYW4+XHJcbiAgICAgICAgICAgICAgICBpZiAocGFyZW50LnRhZ05hbWUgPT0gJ1NQQU4nICYmICFkb21VdGlscy5pc1NhbWVTdHlsZShwYXJlbnQsIG5vZGUpXHJcbiAgICAgICAgICAgICAgICAgICAgfHwgKHBhcmVudC50YWdOYW1lID09ICdBJyAmJiBub2RlLnRhZ05hbWUgPT0gJ1NQQU4nKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQuY2hpbGROb2Rlcy5sZW5ndGggPiAxIHx8IHBhcmVudCAhPT0gbm9kZS5wYXJlbnROb2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuc3R5bGUuY3NzVGV4dCA9IHBhcmVudC5zdHlsZS5jc3NUZXh0ICsgXCI7XCIgKyBub2RlLnN0eWxlLmNzc1RleHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuc3R5bGUuY3NzVGV4dCArPSBcIjtcIiArIG5vZGUuc3R5bGUuY3NzVGV4dDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy90cmFjZTo5NTIgYeagh+etvuimgeS/neaMgeS4i+WIkue6v1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LnRhZ05hbWUgPT0gJ0EnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuc3R5bGUudGV4dERlY29yYXRpb24gPSAndW5kZXJsaW5lJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChwYXJlbnQudGFnTmFtZSAhPSAnQScpIHtcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPT09IG5vZGUucGFyZW50Tm9kZSAmJiBkb21VdGlscy5yZW1vdmUobm9kZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnBhcmVudE5vZGU7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIC8qKlxyXG4gICAgICog5ZCI5bm26IqC54K5bm9kZeeahOW3puWPs+WFhOW8n+iKgueCuVxyXG4gICAgICogQG1ldGhvZCBtZXJnZVNpYmxpbmdcclxuICAgICAqIEBwYXJhbSB7IEVsZW1lbnQgfSBub2RlIOmcgOimgeWQiOW5tueahOebruagh+iKgueCuVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGh0bWxcclxuICAgICAqIDxiPnh4eHg8L2I+PGIgaWQ9XCJ0ZXN0XCI+b29vPC9iPjxiPnh4eHg8L2I+XHJcbiAgICAgKlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqICAgICB2YXIgZGVtb05vZGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInRlc3RcIik7XHJcbiAgICAgKiAgICAgVUUuZG9tLmRvbVV0aWxzLm1lcmdlU2libGluZyggZGVtb05vZGUgKTtcclxuICAgICAqICAgICAvL291dHB1dDogeHh4eG9vb3h4eHhcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggZGVtb05vZGUuaW5uZXJIVE1MICk7XHJcbiAgICAgKiA8L3NjcmlwdD5cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlkIjlubboioLngrlub2Rl55qE5bem5Y+z5YWE5byf6IqC54K577yMIOWPr+S7peagueaNrue7meWumueahOadoeS7tumAieaLqeaYr+WQpuW/veeVpeWQiOW5tuW3puiKgueCueOAglxyXG4gICAgICogQG1ldGhvZCBtZXJnZVNpYmxpbmdcclxuICAgICAqIEBwYXJhbSB7IEVsZW1lbnQgfSBub2RlIOmcgOimgeWQiOW5tueahOebruagh+iKgueCuVxyXG4gICAgICogQHBhcmFtIHsgQm9vbGVhbiB9IGlnbm9yZVByZSDmmK/lkKblv73nlaXlkIjlubblt6boioLngrlcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBodG1sXHJcbiAgICAgKiA8Yj54eHh4PC9iPjxiIGlkPVwidGVzdFwiPm9vbzwvYj48Yj54eHh4PC9iPlxyXG4gICAgICpcclxuICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgKiAgICAgdmFyIGRlbW9Ob2RlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ0ZXN0XCIpO1xyXG4gICAgICogICAgIFVFLmRvbS5kb21VdGlscy5tZXJnZVNpYmxpbmcoIGRlbW9Ob2RlLCB0cnVlICk7XHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IG9vb3h4eHhcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggZGVtb05vZGUuaW5uZXJIVE1MICk7XHJcbiAgICAgKiA8L3NjcmlwdD5cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlkIjlubboioLngrlub2Rl55qE5bem5Y+z5YWE5byf6IqC54K577yM5Y+v5Lul5qC55o2u57uZ5a6a55qE5p2h5Lu26YCJ5oup5piv5ZCm5b+955Wl5ZCI5bm25bem5Y+z6IqC54K544CCXHJcbiAgICAgKiBAbWV0aG9kIG1lcmdlU2libGluZ1xyXG4gICAgICogQHBhcmFtIHsgRWxlbWVudCB9IG5vZGUg6ZyA6KaB5ZCI5bm255qE55uu5qCH6IqC54K5XHJcbiAgICAgKiBAcGFyYW0geyBCb29sZWFuIH0gaWdub3JlUHJlIOaYr+WQpuW/veeVpeWQiOW5tuW3puiKgueCuVxyXG4gICAgICogQHBhcmFtIHsgQm9vbGVhbiB9IGlnbm9yZU5leHQg5piv5ZCm5b+955Wl5ZCI5bm25Y+z6IqC54K5XHJcbiAgICAgKiBAcmVtaW5kIOWmguaenOWQjOaXtuW/veeVpeW3puWPs+iKgueCue+8jCDliJnor6Xmk43kvZzku4DkuYjkuZ/kuI3kvJrlgZpcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBodG1sXHJcbiAgICAgKiA8Yj54eHh4PC9iPjxiIGlkPVwidGVzdFwiPm9vbzwvYj48Yj54eHh4PC9iPlxyXG4gICAgICpcclxuICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgKiAgICAgdmFyIGRlbW9Ob2RlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ0ZXN0XCIpO1xyXG4gICAgICogICAgIFVFLmRvbS5kb21VdGlscy5tZXJnZVNpYmxpbmcoIGRlbW9Ob2RlLCBmYWxzZSwgdHJ1ZSApO1xyXG4gICAgICogICAgIC8vb3V0cHV0OiB4eHh4b29vXHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIGRlbW9Ob2RlLmlubmVySFRNTCApO1xyXG4gICAgICogPC9zY3JpcHQ+XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgbWVyZ2VTaWJsaW5nOmZ1bmN0aW9uIChub2RlLCBpZ25vcmVQcmUsIGlnbm9yZU5leHQpIHtcclxuICAgICAgICBmdW5jdGlvbiBtZXJnZShydGwsIHN0YXJ0LCBub2RlKSB7XHJcbiAgICAgICAgICAgIHZhciBuZXh0O1xyXG4gICAgICAgICAgICBpZiAoKG5leHQgPSBub2RlW3J0bF0pICYmICFkb21VdGlscy5pc0Jvb2ttYXJrTm9kZShuZXh0KSAmJiBuZXh0Lm5vZGVUeXBlID09IDEgJiYgZG9tVXRpbHMuaXNTYW1lRWxlbWVudChub2RlLCBuZXh0KSkge1xyXG4gICAgICAgICAgICAgICAgd2hpbGUgKG5leHQuZmlyc3RDaGlsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGFydCA9PSAnZmlyc3RDaGlsZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5pbnNlcnRCZWZvcmUobmV4dC5sYXN0Q2hpbGQsIG5vZGUuZmlyc3RDaGlsZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChuZXh0LmZpcnN0Q2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShuZXh0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAhaWdub3JlUHJlICYmIG1lcmdlKCdwcmV2aW91c1NpYmxpbmcnLCAnZmlyc3RDaGlsZCcsIG5vZGUpO1xyXG4gICAgICAgICFpZ25vcmVOZXh0ICYmIG1lcmdlKCduZXh0U2libGluZycsICdsYXN0Q2hpbGQnLCBub2RlKTtcclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDorr7nva7oioLngrlub2Rl5Y+K5YW25a2Q6IqC54K55LiN5Lya6KKr6YCJ5LitXHJcbiAgICAgKiBAbWV0aG9kIHVuU2VsZWN0YWJsZVxyXG4gICAgICogQHBhcmFtIHsgRWxlbWVudCB9IG5vZGUg6ZyA6KaB5omn6KGM5pON5L2c55qEZG9t5YWD57SgXHJcbiAgICAgKiBAcmVtaW5kIOaJp+ihjOivpeaTjeS9nOWQjueahOiKgueCue+8jCDlsIbkuI3og73ooqvpvKDmoIfpgInkuK1cclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiBVRS5kb20uZG9tVXRpbHMudW5TZWxlY3RhYmxlKCBkb2N1bWVudC5ib2R5ICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgdW5TZWxlY3RhYmxlOmllICYmIGJyb3dzZXIuaWU5YmVsb3cgfHwgYnJvd3Nlci5vcGVyYSA/IGZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgLy9mb3IgaWU5XHJcbiAgICAgICAgbm9kZS5vbnNlbGVjdHN0YXJ0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBub2RlLm9uY2xpY2sgPSBub2RlLm9ua2V5dXAgPSBub2RlLm9ua2V5ZG93biA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgbm9kZS51bnNlbGVjdGFibGUgPSAnb24nO1xyXG4gICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKFwidW5zZWxlY3RhYmxlXCIsIFwib25cIik7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IG5vZGUuYWxsW2krK107KSB7XHJcbiAgICAgICAgICAgIHN3aXRjaCAoY2kudGFnTmFtZS50b0xvd2VyQ2FzZSgpKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdpZnJhbWUnIDpcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3RleHRhcmVhJyA6XHJcbiAgICAgICAgICAgICAgICBjYXNlICdpbnB1dCcgOlxyXG4gICAgICAgICAgICAgICAgY2FzZSAnc2VsZWN0JyA6XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0IDpcclxuICAgICAgICAgICAgICAgICAgICBjaS51bnNlbGVjdGFibGUgPSAnb24nO1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKFwidW5zZWxlY3RhYmxlXCIsIFwib25cIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9IDogZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICBub2RlLnN0eWxlLk1velVzZXJTZWxlY3QgPVxyXG4gICAgICAgICAgICBub2RlLnN0eWxlLndlYmtpdFVzZXJTZWxlY3QgPVxyXG4gICAgICAgICAgICAgICAgbm9kZS5zdHlsZS5tc1VzZXJTZWxlY3QgPVxyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUuc3R5bGUuS2h0bWxVc2VyU2VsZWN0ID0gJ25vbmUnO1xyXG4gICAgfSxcclxuICAgIC8qKlxyXG4gICAgICog5Yig6Zmk6IqC54K5bm9kZeS4iueahOaMh+WumuWxnuaAp+WQjeensOeahOWxnuaAp1xyXG4gICAgICogQG1ldGhvZCAgcmVtb3ZlQXR0cmlidXRlc1xyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg6ZyA6KaB5Yig6Zmk5bGe5oCn55qE6IqC54K55a+56LGhXHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBhdHRyTmFtZXMg5Y+v5Lul5piv56m65qC86ZqU5byA55qE5aSa5Liq5bGe5oCn5ZCN56ew77yM6K+l5pON5L2c5bCG5Lya5L6d5qyh5Yig6Zmk55u45bqU55qE5bGe5oCnXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPGRpdiBpZD1cIndyYXBcIj5cclxuICAgICAqICAgICAgPHNwYW4gc3R5bGU9XCJmb250LXNpemU6MTRweDtcIiBpZD1cInRlc3RcIiBuYW1lPVwiZm9sbG93TWVcIj54eHh4eDwvc3Bhbj5cclxuICAgICAqIDwvZGl2PlxyXG4gICAgICpcclxuICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgKlxyXG4gICAgICogICAgIFVFLmRvbS5kb21VdGlscy5yZW1vdmVBdHRyaWJ1dGVzKCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggXCJ0ZXN0XCIgKSwgXCJpZCBuYW1lXCIgKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IDxzcGFuIHN0eWxlPVwiZm9udC1zaXplOjE0cHg7XCI+eHh4eHg8L3NwYW4+XHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwid3JhcFwiKS5pbm5lckhUTUwgKTtcclxuICAgICAqXHJcbiAgICAgKiA8L3NjcmlwdD5cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDliKDpmaToioLngrlub2Rl5LiK55qE5oyH5a6a5bGe5oCn5ZCN56ew55qE5bGe5oCnXHJcbiAgICAgKiBAbWV0aG9kICByZW1vdmVBdHRyaWJ1dGVzXHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZSDpnIDopoHliKDpmaTlsZ7mgKfnmoToioLngrnlr7nosaFcclxuICAgICAqIEBwYXJhbSB7IEFycmF5IH0gYXR0ck5hbWVzIOmcgOimgeWIoOmZpOeahOWxnuaAp+WQjeaVsOe7hFxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGh0bWxcclxuICAgICAqIDxkaXYgaWQ9XCJ3cmFwXCI+XHJcbiAgICAgKiAgICAgIDxzcGFuIHN0eWxlPVwiZm9udC1zaXplOjE0cHg7XCIgaWQ9XCJ0ZXN0XCIgbmFtZT1cImZvbGxvd01lXCI+eHh4eHg8L3NwYW4+XHJcbiAgICAgKiA8L2Rpdj5cclxuICAgICAqXHJcbiAgICAgKiA8c2NyaXB0PlxyXG4gICAgICpcclxuICAgICAqICAgICBVRS5kb20uZG9tVXRpbHMucmVtb3ZlQXR0cmlidXRlcyggZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIFwidGVzdFwiICksIFtcImlkXCIsIFwibmFtZVwiXSApO1xyXG4gICAgICpcclxuICAgICAqICAgICAvL291dHB1dDogPHNwYW4gc3R5bGU9XCJmb250LXNpemU6MTRweDtcIj54eHh4eDwvc3Bhbj5cclxuICAgICAqICAgICBjb25zb2xlLmxvZyggZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ3cmFwXCIpLmlubmVySFRNTCApO1xyXG4gICAgICpcclxuICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIHJlbW92ZUF0dHJpYnV0ZXM6ZnVuY3Rpb24gKG5vZGUsIGF0dHJOYW1lcykge1xyXG4gICAgICAgIGF0dHJOYW1lcyA9IHV0aWxzLmlzQXJyYXkoYXR0ck5hbWVzKSA/IGF0dHJOYW1lcyA6IHV0aWxzLnRyaW0oYXR0ck5hbWVzKS5yZXBsYWNlKC9bIF17Mix9L2csJyAnKS5zcGxpdCgnICcpO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSBhdHRyTmFtZXNbaSsrXTspIHtcclxuICAgICAgICAgICAgY2kgPSBhdHRyRml4W2NpXSB8fCBjaTtcclxuICAgICAgICAgICAgc3dpdGNoIChjaSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnY2xhc3NOYW1lJzpcclxuICAgICAgICAgICAgICAgICAgICBub2RlW2NpXSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnc3R5bGUnOlxyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUuc3R5bGUuY3NzVGV4dCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB2YWwgPSBub2RlLmdldEF0dHJpYnV0ZU5vZGUoJ3N0eWxlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgIWJyb3dzZXIuaWUgJiYgdmFsICYmIG5vZGUucmVtb3ZlQXR0cmlidXRlTm9kZSh2YWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGNpKTtcclxuICAgICAgICB9XHJcbiAgICB9LFxyXG4gICAgLyoqXHJcbiAgICAgKiDlnKhkb2PkuIvliJvlu7rkuIDkuKrmoIfnrb7lkI3kuLp0YWfvvIzlsZ7mgKfkuLphdHRyc+eahOWFg+e0oFxyXG4gICAgICogQG1ldGhvZCBjcmVhdGVFbGVtZW50XHJcbiAgICAgKiBAcGFyYW0geyBEb21Eb2N1bWVudCB9IGRvYyDmlrDliJvlu7rnmoTlhYPntKDlsZ7kuo7or6Vkb2N1bWVudOiKgueCueWIm+W7ulxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gdGFnTmFtZSDpnIDopoHliJvlu7rnmoTlhYPntKDnmoTmoIfnrb7lkI1cclxuICAgICAqIEBwYXJhbSB7IE9iamVjdCB9IGF0dHJzIOaWsOWIm+W7uueahOWFg+e0oOeahOWxnuaAp2tleS12YWx1ZembhuWQiFxyXG4gICAgICogQHJldHVybiB7IEVsZW1lbnQgfSDmlrDliJvlu7rnmoTlhYPntKDlr7nosaFcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiB2YXIgZWxlID0gVUUuZG9tLmRvbVV0aWxzLmNyZWF0ZUVsZW1lbnQoIGRvY3VtZW50LCAnZGl2Jywge1xyXG4gICAgICogICAgIGlkOiAndGVzdCdcclxuICAgICAqIH0gKTtcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogRElWXHJcbiAgICAgKiBjb25zb2xlLmxvZyggZWxlLnRhZ05hbWUgKTtcclxuICAgICAqXHJcbiAgICAgKiAvL291dHB1dDogdGVzdFxyXG4gICAgICogY29uc29sZS5sb2coIGVsZS5pZCApO1xyXG4gICAgICpcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBjcmVhdGVFbGVtZW50OmZ1bmN0aW9uIChkb2MsIHRhZywgYXR0cnMpIHtcclxuICAgICAgICByZXR1cm4gZG9tVXRpbHMuc2V0QXR0cmlidXRlcyhkb2MuY3JlYXRlRWxlbWVudCh0YWcpLCBhdHRycylcclxuICAgIH0sXHJcbiAgICAvKipcclxuICAgICAqIOS4uuiKgueCuW5vZGXmt7vliqDlsZ7mgKdhdHRyc++8jGF0dHJz5Li65bGe5oCn6ZSu5YC85a+5XHJcbiAgICAgKiBAbWV0aG9kIHNldEF0dHJpYnV0ZXNcclxuICAgICAqIEBwYXJhbSB7IEVsZW1lbnQgfSBub2RlIOmcgOimgeiuvue9ruWxnuaAp+eahOWFg+e0oOWvueixoVxyXG4gICAgICogQHBhcmFtIHsgT2JqZWN0IH0gYXR0cnMg6ZyA6KaB6K6+572u55qE5bGe5oCn5ZCNLeWAvOWvuVxyXG4gICAgICogQHJldHVybiB7IEVsZW1lbnQgfSDorr7nva7lsZ7mgKfnmoTlhYPntKDlr7nosaFcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBodG1sXHJcbiAgICAgKiA8c3BhbiBpZD1cInRlc3RcIj48L3NwYW4+XHJcbiAgICAgKlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqXHJcbiAgICAgKiAgICAgdmFyIHRlc3ROb2RlID0gVUUuZG9tLmRvbVV0aWxzLnNldEF0dHJpYnV0ZXMoIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBcInRlc3RcIiApLCB7XHJcbiAgICAgKiAgICAgICAgIGlkOiAnZGVtbydcclxuICAgICAqICAgICB9ICk7XHJcbiAgICAgKlxyXG4gICAgICogICAgIC8vb3V0cHV0OiBkZW1vXHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIHRlc3ROb2RlLmlkICk7XHJcbiAgICAgKlxyXG4gICAgICogPC9zY3JpcHQ+XHJcbiAgICAgKlxyXG4gICAgICovXHJcbiAgICBzZXRBdHRyaWJ1dGVzOmZ1bmN0aW9uIChub2RlLCBhdHRycykge1xyXG4gICAgICAgIGZvciAodmFyIGF0dHIgaW4gYXR0cnMpIHtcclxuICAgICAgICAgICAgaWYoYXR0cnMuaGFzT3duUHJvcGVydHkoYXR0cikpe1xyXG4gICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gYXR0cnNbYXR0cl07XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKGF0dHIpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdjbGFzcyc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vaWXkuIvopoHov5nmoLfotYvlgLzvvIxzZXRBdHRyaWJ1dGXkuI3otbfkvZznlKhcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5jbGFzc05hbWUgPSB2YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3R5bGUnIDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zdHlsZS5jc3NUZXh0ID0gbm9kZS5zdHlsZS5jc3NUZXh0ICsgXCI7XCIgKyB2YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnaW5uZXJIVE1MJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZVthdHRyXSA9IHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICd2YWx1ZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSB2YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoYXR0ckZpeFthdHRyXSB8fCBhdHRyLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICB9LFxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6I635Y+W5YWD57SgZWxlbWVudOe7j+i/h+iuoeeul+WQjueahOagt+W8j+WAvFxyXG4gICAgICogQG1ldGhvZCBnZXRDb21wdXRlZFN0eWxlXHJcbiAgICAgKiBAcGFyYW0geyBFbGVtZW50IH0gZWxlbWVudCDpnIDopoHojrflj5bmoLflvI/nmoTlhYPntKDlr7nosaFcclxuICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IHN0eWxlTmFtZSDpnIDopoHojrflj5bnmoTmoLflvI/lkI1cclxuICAgICAqIEByZXR1cm4geyBTdHJpbmcgfSDojrflj5bliLDnmoTmoLflvI/lgLxcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBodG1sXHJcbiAgICAgKiA8c3R5bGUgdHlwZT1cInRleHQvY3NzXCI+XHJcbiAgICAgKiAgICAgICN0ZXN0IHtcclxuICAgICAqICAgICAgICAgIGZvbnQtc2l6ZTogMTVweDtcclxuICAgICAqICAgICAgfVxyXG4gICAgICogPC9zdHlsZT5cclxuICAgICAqXHJcbiAgICAgKiA8c3BhbiBpZD1cInRlc3RcIj48L3NwYW4+XHJcbiAgICAgKlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqICAgICAvL291dHB1dDogMTVweFxyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCBVRS5kb20uZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZSggZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIFwidGVzdFwiICksICdmb250LXNpemUnICkgKTtcclxuICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIGdldENvbXB1dGVkU3R5bGU6ZnVuY3Rpb24gKGVsZW1lbnQsIHN0eWxlTmFtZSkge1xyXG4gICAgICAgIC8v5LiA5LiL55qE5bGe5oCn5Y2V54us5aSE55CGXHJcbiAgICAgICAgdmFyIHByb3MgPSAnd2lkdGggaGVpZ2h0IHRvcCBsZWZ0JztcclxuXHJcbiAgICAgICAgaWYocHJvcy5pbmRleE9mKHN0eWxlTmFtZSkgPiAtMSl7XHJcbiAgICAgICAgICAgIHJldHVybiBlbGVtZW50WydvZmZzZXQnICsgc3R5bGVOYW1lLnJlcGxhY2UoL15cXHcvLGZ1bmN0aW9uKHMpe3JldHVybiBzLnRvVXBwZXJDYXNlKCl9KV0gKyAncHgnO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvL+W/veeVpeaWh+acrOiKgueCuVxyXG4gICAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09IDMpIHtcclxuICAgICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy9pZeS4i2ZvbnQtc2l6ZeiLpWJvZHnkuIvlrprkuYnkuoZmb250LXNpemXvvIzliJnku45jdXJyZW50U3R5bGXph4zkvJrlj5bliLDov5nkuKpmb250LXNpemUuIOWPluS4jeWIsOWunumZheWAvO+8jOaVheatpOS/ruaUuS5cclxuICAgICAgICBpZiAoYnJvd3Nlci5pZSAmJiBicm93c2VyLnZlcnNpb24gPCA5ICYmIHN0eWxlTmFtZSA9PSAnZm9udC1zaXplJyAmJiAhZWxlbWVudC5zdHlsZS5mb250U2l6ZSAmJlxyXG4gICAgICAgICAgICAhZHRkLiRlbXB0eVtlbGVtZW50LnRhZ05hbWVdICYmICFkdGQuJG5vbkNoaWxkW2VsZW1lbnQudGFnTmFtZV0pIHtcclxuICAgICAgICAgICAgdmFyIHNwYW4gPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xyXG4gICAgICAgICAgICBzcGFuLnN0eWxlLmNzc1RleHQgPSAncGFkZGluZzowO2JvcmRlcjowO2ZvbnQtZmFtaWx5OnNpbXN1bjsnO1xyXG4gICAgICAgICAgICBzcGFuLmlubmVySFRNTCA9ICcuJztcclxuICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChzcGFuKTtcclxuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHNwYW4ub2Zmc2V0SGVpZ2h0O1xyXG4gICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNoaWxkKHNwYW4pO1xyXG4gICAgICAgICAgICBzcGFuID0gbnVsbDtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdCArICdweCc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGRvbVV0aWxzLmdldFN0eWxlKGVsZW1lbnQsIHN0eWxlTmFtZSkgfHxcclxuICAgICAgICAgICAgICAgICh3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSA/IGRvbVV0aWxzLmdldFdpbmRvdyhlbGVtZW50KS5nZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQsICcnKS5nZXRQcm9wZXJ0eVZhbHVlKHN0eWxlTmFtZSkgOlxyXG4gICAgICAgICAgICAgICAgICAgICggZWxlbWVudC5jdXJyZW50U3R5bGUgfHwgZWxlbWVudC5zdHlsZSApW3V0aWxzLmNzc1N0eWxlVG9Eb21TdHlsZShzdHlsZU5hbWUpXSk7XHJcblxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFwiXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB1dGlscy50cmFuc1VuaXRUb1B4KHV0aWxzLmZpeENvbG9yKHN0eWxlTmFtZSwgdmFsdWUpKTtcclxuICAgIH0sXHJcbiAgICAvKipcclxuICAgICAqIOWIoOmZpOWFg+e0oGVsZW1lbnTmjIflrprnmoRjbGFzc05hbWVcclxuICAgICAqIEBtZXRob2QgcmVtb3ZlQ2xhc3Nlc1xyXG4gICAgICogQHBhcmFtIHsgRWxlbWVudCB9IGVsZSDpnIDopoHliKDpmaRjbGFzc+eahOWFg+e0oOiKgueCuVxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gY2xhc3NOYW1lcyDpnIDopoHliKDpmaTnmoRjbGFzc05hbWXvvIwg5aSa5LiqY2xhc3NOYW1l5LmL6Ze05Lul56m65qC85YiG5byAXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPHNwYW4gaWQ9XCJ0ZXN0XCIgY2xhc3M9XCJ0ZXN0MSB0ZXN0MiB0ZXN0M1wiPnh4eDwvc3Bhbj5cclxuICAgICAqXHJcbiAgICAgKiA8c2NyaXB0PlxyXG4gICAgICpcclxuICAgICAqICAgICB2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggXCJ0ZXN0XCIgKTtcclxuICAgICAqICAgICBVRS5kb20uZG9tVXRpbHMucmVtb3ZlQ2xhc3NlcyggdGVzdE5vZGUsIFwidGVzdDEgdGVzdDJcIiApO1xyXG4gICAgICpcclxuICAgICAqICAgICAvL291dHB1dDogdGVzdDNcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggdGVzdE5vZGUuY2xhc3NOYW1lICk7XHJcbiAgICAgKlxyXG4gICAgICogPC9zY3JpcHQ+XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yig6Zmk5YWD57SgZWxlbWVudOaMh+WumueahGNsYXNzTmFtZVxyXG4gICAgICogQG1ldGhvZCByZW1vdmVDbGFzc2VzXHJcbiAgICAgKiBAcGFyYW0geyBFbGVtZW50IH0gZWxlIOmcgOimgeWIoOmZpGNsYXNz55qE5YWD57Sg6IqC54K5XHJcbiAgICAgKiBAcGFyYW0geyBBcnJheSB9IGNsYXNzTmFtZXMg6ZyA6KaB5Yig6Zmk55qEY2xhc3NOYW1l5pWw57uEXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPHNwYW4gaWQ9XCJ0ZXN0XCIgY2xhc3M9XCJ0ZXN0MSB0ZXN0MiB0ZXN0M1wiPnh4eDwvc3Bhbj5cclxuICAgICAqXHJcbiAgICAgKiA8c2NyaXB0PlxyXG4gICAgICpcclxuICAgICAqICAgICB2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggXCJ0ZXN0XCIgKTtcclxuICAgICAqICAgICBVRS5kb20uZG9tVXRpbHMucmVtb3ZlQ2xhc3NlcyggdGVzdE5vZGUsIFtcInRlc3QxXCIsIFwidGVzdDJcIl0gKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IHRlc3QzXHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIHRlc3ROb2RlLmNsYXNzTmFtZSApO1xyXG4gICAgICpcclxuICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIHJlbW92ZUNsYXNzZXM6ZnVuY3Rpb24gKGVsbSwgY2xhc3NOYW1lcykge1xyXG4gICAgICAgIGNsYXNzTmFtZXMgPSB1dGlscy5pc0FycmF5KGNsYXNzTmFtZXMpID8gY2xhc3NOYW1lcyA6XHJcbiAgICAgICAgICAgIHV0aWxzLnRyaW0oY2xhc3NOYW1lcykucmVwbGFjZSgvWyBdezIsfS9nLCcgJykuc3BsaXQoJyAnKTtcclxuICAgICAgICBmb3IodmFyIGkgPSAwLGNpLGNscyA9IGVsbS5jbGFzc05hbWU7Y2k9Y2xhc3NOYW1lc1tpKytdOyl7XHJcbiAgICAgICAgICAgIGNscyA9IGNscy5yZXBsYWNlKG5ldyBSZWdFeHAoJ1xcXFxiJyArIGNpICsgJ1xcXFxiJyksJycpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNscyA9IHV0aWxzLnRyaW0oY2xzKS5yZXBsYWNlKC9bIF17Mix9L2csJyAnKTtcclxuICAgICAgICBpZihjbHMpe1xyXG4gICAgICAgICAgICBlbG0uY2xhc3NOYW1lID0gY2xzO1xyXG4gICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICBkb21VdGlscy5yZW1vdmVBdHRyaWJ1dGVzKGVsbSxbJ2NsYXNzJ10pO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcbiAgICAvKipcclxuICAgICAqIOe7meWFg+e0oGVsZW1lbnTmt7vliqBjbGFzc05hbWVcclxuICAgICAqIEBtZXRob2QgYWRkQ2xhc3NcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBlbGUg6ZyA6KaB5aKe5YqgY2xhc3NOYW1l55qE5YWD57SgXHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbGFzc05hbWVzIOmcgOimgea3u+WKoOeahGNsYXNzTmFtZe+8jCDlpJrkuKpjbGFzc05hbWXkuYvpl7Tku6XnqbrmoLzliIblibJcclxuICAgICAqIEByZW1pbmQg55u45ZCM55qE57G75ZCN5LiN5Lya6KKr6YeN5aSN5re75YqgXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPHNwYW4gaWQ9XCJ0ZXN0XCIgY2xhc3M9XCJjbHMxIGNsczJcIj48L3NwYW4+XHJcbiAgICAgKlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqICAgICB2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInRlc3RcIik7XHJcbiAgICAgKlxyXG4gICAgICogICAgIFVFLmRvbS5kb21VdGlscy5hZGRDbGFzcyggdGVzdE5vZGUsIFwiY2xzMiBjbHMzIGNsczRcIiApO1xyXG4gICAgICpcclxuICAgICAqICAgICAvL291dHB1dDogY2wxIGNsczIgY2xzMyBjbHM0XHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIHRlc3ROb2RlLmNsYXNzTmFtZSApO1xyXG4gICAgICpcclxuICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog57uZ5YWD57SgZWxlbWVudOa3u+WKoGNsYXNzTmFtZVxyXG4gICAgICogQG1ldGhvZCBhZGRDbGFzc1xyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IGVsZSDpnIDopoHlop7liqBjbGFzc05hbWXnmoTlhYPntKBcclxuICAgICAqIEBwYXJhbSB7IEFycmF5IH0gY2xhc3NOYW1lcyDpnIDopoHmt7vliqDnmoRjbGFzc05hbWXnmoTmlbDnu4RcclxuICAgICAqIEByZW1pbmQg55u45ZCM55qE57G75ZCN5LiN5Lya6KKr6YeN5aSN5re75YqgXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPHNwYW4gaWQ9XCJ0ZXN0XCIgY2xhc3M9XCJjbHMxIGNsczJcIj48L3NwYW4+XHJcbiAgICAgKlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqICAgICB2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInRlc3RcIik7XHJcbiAgICAgKlxyXG4gICAgICogICAgIFVFLmRvbS5kb21VdGlscy5hZGRDbGFzcyggdGVzdE5vZGUsIFtcImNsczJcIiwgXCJjbHMzXCIsIFwiY2xzNFwiXSApO1xyXG4gICAgICpcclxuICAgICAqICAgICAvL291dHB1dDogY2wxIGNsczIgY2xzMyBjbHM0XHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIHRlc3ROb2RlLmNsYXNzTmFtZSApO1xyXG4gICAgICpcclxuICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgYWRkQ2xhc3M6ZnVuY3Rpb24gKGVsbSwgY2xhc3NOYW1lcykge1xyXG4gICAgICAgIGlmKCFlbG0pcmV0dXJuO1xyXG4gICAgICAgIGNsYXNzTmFtZXMgPSB1dGlscy50cmltKGNsYXNzTmFtZXMpLnJlcGxhY2UoL1sgXXsyLH0vZywnICcpLnNwbGl0KCcgJyk7XHJcbiAgICAgICAgZm9yKHZhciBpID0gMCxjaSxjbHMgPSBlbG0uY2xhc3NOYW1lO2NpPWNsYXNzTmFtZXNbaSsrXTspe1xyXG4gICAgICAgICAgICBpZighbmV3IFJlZ0V4cCgnXFxcXGInICsgY2kgKyAnXFxcXGInKS50ZXN0KGNscykpe1xyXG4gICAgICAgICAgICAgICAgY2xzICs9ICcgJyArIGNpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsbS5jbGFzc05hbWUgPSB1dGlscy50cmltKGNscyk7XHJcbiAgICB9LFxyXG4gICAgLyoqXHJcbiAgICAgKiDliKTmlq3lhYPntKBlbGVtZW505piv5ZCm5YyF5ZCr57uZ5a6a55qE5qC35byP57G75ZCNY2xhc3NOYW1lXHJcbiAgICAgKiBAbWV0aG9kIGhhc0NsYXNzXHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gZWxlIOmcgOimgeajgOa1i+eahOWFg+e0oFxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gY2xhc3NOYW1lcyDpnIDopoHmo4DmtYvnmoRjbGFzc05hbWXvvIwg5aSa5LiqY2xhc3NOYW1l5LmL6Ze055So56m65qC85YiG5YmyXHJcbiAgICAgKiBAcmV0dXJuIHsgQm9vbGVhbiB9IOWFg+e0oOaYr+WQpuWMheWQq+aJgOaciee7meWumueahGNsYXNzTmFtZVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGh0bWxcclxuICAgICAqIDxzcGFuIGlkPVwidGVzdDFcIiBjbGFzcz1cImNsczEgY2xzMlwiPjwvc3Bhbj5cclxuICAgICAqXHJcbiAgICAgKiA8c2NyaXB0PlxyXG4gICAgICogICAgIHZhciB0ZXN0MSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidGVzdDFcIik7XHJcbiAgICAgKlxyXG4gICAgICogICAgIC8vb3V0cHV0OiBmYWxzZVxyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCBVRS5kb20uZG9tVXRpbHMuaGFzQ2xhc3MoIHRlc3QxLCBcImNsczIgY2xzMSBjbHMzXCIgKSApO1xyXG4gICAgICpcclxuICAgICAqICAgICAvL291dHB1dDogdHJ1ZVxyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCBVRS5kb20uZG9tVXRpbHMuaGFzQ2xhc3MoIHRlc3QxLCBcImNsczIgY2xzMVwiICkgKTtcclxuICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWIpOaWreWFg+e0oGVsZW1lbnTmmK/lkKbljIXlkKvnu5nlrprnmoTmoLflvI/nsbvlkI1jbGFzc05hbWVcclxuICAgICAqIEBtZXRob2QgaGFzQ2xhc3NcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBlbGUg6ZyA6KaB5qOA5rWL55qE5YWD57SgXHJcbiAgICAgKiBAcGFyYW0geyBBcnJheSB9IGNsYXNzTmFtZXMg6ZyA6KaB5qOA5rWL55qEY2xhc3NOYW1l5pWw57uEXHJcbiAgICAgKiBAcmV0dXJuIHsgQm9vbGVhbiB9IOWFg+e0oOaYr+WQpuWMheWQq+aJgOaciee7meWumueahGNsYXNzTmFtZVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGh0bWxcclxuICAgICAqIDxzcGFuIGlkPVwidGVzdDFcIiBjbGFzcz1cImNsczEgY2xzMlwiPjwvc3Bhbj5cclxuICAgICAqXHJcbiAgICAgKiA8c2NyaXB0PlxyXG4gICAgICogICAgIHZhciB0ZXN0MSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidGVzdDFcIik7XHJcbiAgICAgKlxyXG4gICAgICogICAgIC8vb3V0cHV0OiBmYWxzZVxyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCBVRS5kb20uZG9tVXRpbHMuaGFzQ2xhc3MoIHRlc3QxLCBbIFwiY2xzMlwiLCBcImNsczFcIiwgXCJjbHMzXCIgXSApICk7XHJcbiAgICAgKlxyXG4gICAgICogICAgIC8vb3V0cHV0OiB0cnVlXHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIFVFLmRvbS5kb21VdGlscy5oYXNDbGFzcyggdGVzdDEsIFsgXCJjbHMyXCIsIFwiY2xzMVwiIF0pICk7XHJcbiAgICAgKiA8L3NjcmlwdD5cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBoYXNDbGFzczpmdW5jdGlvbiAoZWxlbWVudCwgY2xhc3NOYW1lKSB7XHJcbiAgICAgICAgaWYodXRpbHMuaXNSZWdFeHAoY2xhc3NOYW1lKSl7XHJcbiAgICAgICAgICAgIHJldHVybiBjbGFzc05hbWUudGVzdChlbGVtZW50LmNsYXNzTmFtZSlcclxuICAgICAgICB9XHJcbiAgICAgICAgY2xhc3NOYW1lID0gdXRpbHMudHJpbShjbGFzc05hbWUpLnJlcGxhY2UoL1sgXXsyLH0vZywnICcpLnNwbGl0KCcgJyk7XHJcbiAgICAgICAgZm9yKHZhciBpID0gMCxjaSxjbHMgPSBlbGVtZW50LmNsYXNzTmFtZTtjaT1jbGFzc05hbWVbaSsrXTspe1xyXG4gICAgICAgICAgICBpZighbmV3IFJlZ0V4cCgnXFxcXGInICsgY2kgKyAnXFxcXGInLCdpJykudGVzdChjbHMpKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gaSAtIDEgPT0gY2xhc3NOYW1lLmxlbmd0aDtcclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDpmLvmraLkuovku7bpu5jorqTooYzkuLpcclxuICAgICAqIEBtZXRob2QgcHJldmVudERlZmF1bHRcclxuICAgICAqIEBwYXJhbSB7IEV2ZW50IH0gZXZ0IOmcgOimgemYu+atoum7mOiupOihjOS4uueahOS6i+S7tuWvueixoVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIFVFLmRvbS5kb21VdGlscy5wcmV2ZW50RGVmYXVsdCggZXZ0ICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgcHJldmVudERlZmF1bHQ6ZnVuY3Rpb24gKGV2dCkge1xyXG4gICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCA/IGV2dC5wcmV2ZW50RGVmYXVsdCgpIDogKGV2dC5yZXR1cm5WYWx1ZSA9IGZhbHNlKTtcclxuICAgIH0sXHJcbiAgICAvKipcclxuICAgICAqIOWIoOmZpOWFg+e0oGVsZW1lbnTmjIflrprnmoTmoLflvI9cclxuICAgICAqIEBtZXRob2QgcmVtb3ZlU3R5bGVcclxuICAgICAqIEBwYXJhbSB7IEVsZW1lbnQgfSBlbGVtZW50IOmcgOimgeWIoOmZpOagt+W8j+eahOWFg+e0oFxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gc3R5bGVOYW1lIOmcgOimgeWIoOmZpOeahOagt+W8j+WQjVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGh0bWxcclxuICAgICAqIDxzcGFuIGlkPVwidGVzdFwiIHN0eWxlPVwiY29sb3I6IHJlZDsgYmFja2dyb3VuZDogYmx1ZTtcIj48L3NwYW4+XHJcbiAgICAgKlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqXHJcbiAgICAgKiAgICAgdmFyIHRlc3ROb2RlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ0ZXN0XCIpO1xyXG4gICAgICpcclxuICAgICAqICAgICBVRS5kb20uZG9tVXRpbHMucmVtb3ZlU3R5bGUoIHRlc3ROb2RlLCAnY29sb3InICk7XHJcbiAgICAgKlxyXG4gICAgICogICAgIC8vb3V0cHV0OiBiYWNrZ3JvdW5kOiBibHVlO1xyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCB0ZXN0Tm9kZS5zdHlsZS5jc3NUZXh0ICk7XHJcbiAgICAgKlxyXG4gICAgICogPC9zY3JpcHQ+XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgcmVtb3ZlU3R5bGU6ZnVuY3Rpb24gKGVsZW1lbnQsIG5hbWUpIHtcclxuICAgICAgICBpZihicm93c2VyLmllICl7XHJcbiAgICAgICAgICAgIC8v6ZKI5a+5Y29sb3LlhYjljZXni6zlpITnkIbkuIDkuItcclxuICAgICAgICAgICAgaWYobmFtZSA9PSAnY29sb3InKXtcclxuICAgICAgICAgICAgICAgIG5hbWUgPSAnKF58OyknICsgbmFtZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbGVtZW50LnN0eWxlLmNzc1RleHQgPSBlbGVtZW50LnN0eWxlLmNzc1RleHQucmVwbGFjZShuZXcgUmVnRXhwKG5hbWUgKyAnW146XSo6W147XSs7PycsJ2lnJyksJycpXHJcbiAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgIGlmIChlbGVtZW50LnN0eWxlLnJlbW92ZVByb3BlcnR5KSB7XHJcbiAgICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlLnJlbW92ZVByb3BlcnR5IChuYW1lKTtcclxuICAgICAgICAgICAgfWVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5yZW1vdmVBdHRyaWJ1dGUgKHV0aWxzLmNzc1N0eWxlVG9Eb21TdHlsZShuYW1lKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICBpZiAoIWVsZW1lbnQuc3R5bGUuY3NzVGV4dCkge1xyXG4gICAgICAgICAgICBkb21VdGlscy5yZW1vdmVBdHRyaWJ1dGVzKGVsZW1lbnQsIFsnc3R5bGUnXSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIC8qKlxyXG4gICAgICog6I635Y+W5YWD57SgZWxlbWVudOeahHN0eWxl5bGe5oCn55qE5oyH5a6a5YC8XHJcbiAgICAgKiBAbWV0aG9kIGdldFN0eWxlXHJcbiAgICAgKiBAcGFyYW0geyBFbGVtZW50IH0gZWxlbWVudCDpnIDopoHojrflj5blsZ7mgKflgLznmoTlhYPntKBcclxuICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IHN0eWxlTmFtZSDpnIDopoHojrflj5bnmoRzdHlsZeeahOWQjeensFxyXG4gICAgICogQHdhcm5pbmcg6K+l5pa55rOV5LuF6I635Y+W5YWD57Sgc3R5bGXlsZ7mgKfkuK3miYDmoIfmmI7nmoTlgLxcclxuICAgICAqIEByZXR1cm4geyBTdHJpbmcgfSDor6XlhYPntKDljIXlkKvmjIflrprnmoRzdHlsZeWxnuaAp+WAvFxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGh0bWxcclxuICAgICAqIDxkaXYgaWQ9XCJ0ZXN0XCIgc3R5bGU9XCJjb2xvcjogcmVkO1wiPjwvZGl2PlxyXG4gICAgICpcclxuICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgKlxyXG4gICAgICogICAgICB2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggXCJ0ZXN0XCIgKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgIC8vb3V0cHV0OiByZWRcclxuICAgICAqICAgICAgY29uc29sZS5sb2coIFVFLmRvbS5kb21VdGlscy5nZXRTdHlsZSggdGVzdE5vZGUsIFwiY29sb3JcIiApICk7XHJcbiAgICAgKlxyXG4gICAgICogICAgICAvL291dHB1dDogXCJcIlxyXG4gICAgICogICAgICBjb25zb2xlLmxvZyggVUUuZG9tLmRvbVV0aWxzLmdldFN0eWxlKCB0ZXN0Tm9kZSwgXCJiYWNrZ3JvdW5kXCIgKSApO1xyXG4gICAgICpcclxuICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIGdldFN0eWxlOmZ1bmN0aW9uIChlbGVtZW50LCBuYW1lKSB7XHJcbiAgICAgICAgdmFyIHZhbHVlID0gZWxlbWVudC5zdHlsZVsgdXRpbHMuY3NzU3R5bGVUb0RvbVN0eWxlKG5hbWUpIF07XHJcbiAgICAgICAgcmV0dXJuIHV0aWxzLmZpeENvbG9yKG5hbWUsIHZhbHVlKTtcclxuICAgIH0sXHJcbiAgICAvKipcclxuICAgICAqIOS4uuWFg+e0oGVsZW1lbnTorr7nva7moLflvI/lsZ7mgKflgLxcclxuICAgICAqIEBtZXRob2Qgc2V0U3R5bGVcclxuICAgICAqIEBwYXJhbSB7IEVsZW1lbnQgfSBlbGVtZW50IOmcgOimgeiuvue9ruagt+W8j+eahOWFg+e0oFxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gc3R5bGVOYW1lIOagt+W8j+WQjVxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gc3R5bGVWYWx1ZSDmoLflvI/lgLxcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBodG1sXHJcbiAgICAgKiA8ZGl2IGlkPVwidGVzdFwiPjwvZGl2PlxyXG4gICAgICpcclxuICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgKlxyXG4gICAgICogICAgICB2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggXCJ0ZXN0XCIgKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgIC8vb3V0cHV0OiBcIlwiXHJcbiAgICAgKiAgICAgIGNvbnNvbGUubG9nKCB0ZXN0Tm9kZS5zdHlsZS5jb2xvciApO1xyXG4gICAgICpcclxuICAgICAqICAgICAgVUUuZG9tLmRvbVV0aWxzLnNldFN0eWxlKCB0ZXN0Tm9kZSwgJ2NvbG9yJywgJ3JlZCcgKTtcclxuICAgICAqICAgICAgLy9vdXRwdXQ6IFwicmVkXCJcclxuICAgICAqICAgICAgY29uc29sZS5sb2coIHRlc3ROb2RlLnN0eWxlLmNvbG9yICk7XHJcbiAgICAgKlxyXG4gICAgICogPC9zY3JpcHQ+XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgc2V0U3R5bGU6ZnVuY3Rpb24gKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7XHJcbiAgICAgICAgZWxlbWVudC5zdHlsZVt1dGlscy5jc3NTdHlsZVRvRG9tU3R5bGUobmFtZSldID0gdmFsdWU7XHJcbiAgICAgICAgaWYoIXV0aWxzLnRyaW0oZWxlbWVudC5zdHlsZS5jc3NUZXh0KSl7XHJcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlQXR0cmlidXRlcyhlbGVtZW50LCdzdHlsZScpXHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIC8qKlxyXG4gICAgICog5Li65YWD57SgZWxlbWVudOiuvue9ruWkmuS4quagt+W8j+WxnuaAp+WAvFxyXG4gICAgICogQG1ldGhvZCBzZXRTdHlsZXNcclxuICAgICAqIEBwYXJhbSB7IEVsZW1lbnQgfSBlbGVtZW50IOmcgOimgeiuvue9ruagt+W8j+eahOWFg+e0oFxyXG4gICAgICogQHBhcmFtIHsgT2JqZWN0IH0gc3R5bGVzIOagt+W8j+WQjeWAvOWvuVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGh0bWxcclxuICAgICAqIDxkaXYgaWQ9XCJ0ZXN0XCI+PC9kaXY+XHJcbiAgICAgKlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqXHJcbiAgICAgKiAgICAgIHZhciB0ZXN0Tm9kZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBcInRlc3RcIiApO1xyXG4gICAgICpcclxuICAgICAqICAgICAgLy9vdXRwdXQ6IFwiXCJcclxuICAgICAqICAgICAgY29uc29sZS5sb2coIHRlc3ROb2RlLnN0eWxlLmNvbG9yICk7XHJcbiAgICAgKlxyXG4gICAgICogICAgICBVRS5kb20uZG9tVXRpbHMuc2V0U3R5bGVzKCB0ZXN0Tm9kZSwge1xyXG4gICAgICogICAgICAgICAgJ2NvbG9yJzogJ3JlZCdcclxuICAgICAqICAgICAgfSApO1xyXG4gICAgICogICAgICAvL291dHB1dDogXCJyZWRcIlxyXG4gICAgICogICAgICBjb25zb2xlLmxvZyggdGVzdE5vZGUuc3R5bGUuY29sb3IgKTtcclxuICAgICAqXHJcbiAgICAgKiA8L3NjcmlwdD5cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBzZXRTdHlsZXM6ZnVuY3Rpb24gKGVsZW1lbnQsIHN0eWxlcykge1xyXG4gICAgICAgIGZvciAodmFyIG5hbWUgaW4gc3R5bGVzKSB7XHJcbiAgICAgICAgICAgIGlmIChzdHlsZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnNldFN0eWxlKGVsZW1lbnQsIG5hbWUsIHN0eWxlc1tuYW1lXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9LFxyXG4gICAgLyoqXHJcbiAgICAgKiDliKDpmaRfbW96X2RpcnR55bGe5oCnXHJcbiAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICogQG1ldGhvZCByZW1vdmVEaXJ0eUF0dHJcclxuICAgICAqL1xyXG4gICAgcmVtb3ZlRGlydHlBdHRyOmZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpLCBub2RlcyA9IG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsgY2kgPSBub2Rlc1tpKytdOykge1xyXG4gICAgICAgICAgICBjaS5yZW1vdmVBdHRyaWJ1dGUoJ19tb3pfZGlydHknKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoJ19tb3pfZGlydHknKTtcclxuICAgIH0sXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluWtkOiKgueCueeahOaVsOmHj1xyXG4gICAgICogQG1ldGhvZCBnZXRDaGlsZENvdW50XHJcbiAgICAgKiBAcGFyYW0geyBFbGVtZW50IH0gbm9kZSDpnIDopoHmo4DmtYvnmoTlhYPntKBcclxuICAgICAqIEByZXR1cm4geyBOdW1iZXIgfSDnu5nlrprnmoRub2Rl5YWD57Sg55qE5a2Q6IqC54K55pWw6YePXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPGRpdiBpZD1cInRlc3RcIj5cclxuICAgICAqICAgICAgPHNwYW4+PC9zcGFuPlxyXG4gICAgICogPC9kaXY+XHJcbiAgICAgKlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqXHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IDNcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggVUUuZG9tLmRvbVV0aWxzLmdldENoaWxkQ291bnQoIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidGVzdFwiKSApICk7XHJcbiAgICAgKlxyXG4gICAgICogPC9zY3JpcHQ+XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5qC55o2u57uZ5a6a55qE6L+H5ruk6KeE5YiZ77yMIOiOt+WPluespuWQiOadoeS7tueahOWtkOiKgueCueeahOaVsOmHj1xyXG4gICAgICogQG1ldGhvZCBnZXRDaGlsZENvdW50XHJcbiAgICAgKiBAcGFyYW0geyBFbGVtZW50IH0gbm9kZSDpnIDopoHmo4DmtYvnmoTlhYPntKBcclxuICAgICAqIEBwYXJhbSB7IEZ1bmN0aW9uIH0gZm4g6L+H5ruk5Zmo77yMIOimgeaxguWvueespuWQiOadoeS7tueahOWtkOiKgueCuei/lOWbnnRydWXvvIwg5Y+N5LmL5YiZ6KaB5rGC6L+U5ZueZmFsc2VcclxuICAgICAqIEByZXR1cm4geyBOdW1iZXIgfSDnrKblkIjov4fmu6TmnaHku7bnmoRub2Rl5YWD57Sg55qE5a2Q6IqC54K55pWw6YePXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPGRpdiBpZD1cInRlc3RcIj5cclxuICAgICAqICAgICAgPHNwYW4+PC9zcGFuPlxyXG4gICAgICogPC9kaXY+XHJcbiAgICAgKlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqXHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IDFcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggVUUuZG9tLmRvbVV0aWxzLmdldENoaWxkQ291bnQoIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidGVzdFwiKSwgZnVuY3Rpb24gKCBub2RlICkge1xyXG4gICAgICpcclxuICAgICAqICAgICAgICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT09IDE7XHJcbiAgICAgKlxyXG4gICAgICogICAgIH0gKSApO1xyXG4gICAgICpcclxuICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIGdldENoaWxkQ291bnQ6ZnVuY3Rpb24gKG5vZGUsIGZuKSB7XHJcbiAgICAgICAgdmFyIGNvdW50ID0gMCwgZmlyc3QgPSBub2RlLmZpcnN0Q2hpbGQ7XHJcbiAgICAgICAgZm4gPSBmbiB8fCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAxO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgd2hpbGUgKGZpcnN0KSB7XHJcbiAgICAgICAgICAgIGlmIChmbihmaXJzdCkpIHtcclxuICAgICAgICAgICAgICAgIGNvdW50Kys7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZmlyc3QgPSBmaXJzdC5uZXh0U2libGluZztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGNvdW50O1xyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWIpOaWree7meWumuiKgueCueaYr+WQpuS4uuepuuiKgueCuVxyXG4gICAgICogQG1ldGhvZCBpc0VtcHR5Tm9kZVxyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg6ZyA6KaB5qOA5rWL55qE6IqC54K55a+56LGhXHJcbiAgICAgKiBAcmV0dXJuIHsgQm9vbGVhbiB9IOiKgueCueaYr+WQpuS4uuepulxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIFVFLmRvbS5kb21VdGlscy5pc0VtcHR5Tm9kZSggZG9jdW1lbnQuYm9keSApO1xyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIGlzRW1wdHlOb2RlOmZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgcmV0dXJuICFub2RlLmZpcnN0Q2hpbGQgfHwgZG9tVXRpbHMuZ2V0Q2hpbGRDb3VudChub2RlLCBmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gICFkb21VdGlscy5pc0JyKG5vZGUpICYmICFkb21VdGlscy5pc0Jvb2ttYXJrTm9kZShub2RlKSAmJiAhZG9tVXRpbHMuaXNXaGl0ZXNwYWNlKG5vZGUpXHJcbiAgICAgICAgfSkgPT0gMFxyXG4gICAgfSxcclxuICAgIGNsZWFyU2VsZWN0ZWRBcnI6ZnVuY3Rpb24gKG5vZGVzKSB7XHJcbiAgICAgICAgdmFyIG5vZGU7XHJcbiAgICAgICAgd2hpbGUgKG5vZGUgPSBub2Rlcy5wb3AoKSkge1xyXG4gICAgICAgICAgICBkb21VdGlscy5yZW1vdmVBdHRyaWJ1dGVzKG5vZGUsIFsnY2xhc3MnXSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIC8qKlxyXG4gICAgICog5bCG5pi+56S65Yy65Z+f5rua5Yqo5Yiw5oyH5a6a6IqC54K555qE5L2N572uXHJcbiAgICAgKiBAbWV0aG9kIHNjcm9sbFRvVmlld1xyXG4gICAgICogQHBhcmFtICAgIHtOb2RlfSAgIG5vZGUgICAg6IqC54K5XHJcbiAgICAgKiBAcGFyYW0gICAge3dpbmRvd30gICB3aW4gICAgICB3aW5kb3flr7nosaFcclxuICAgICAqIEBwYXJhbSAgICB7TnVtYmVyfSAgICBvZmZzZXRUb3AgICAg6Led56a75LiK5pa555qE5YGP56e76YePXHJcbiAgICAgKi9cclxuICAgIHNjcm9sbFRvVmlldzpmdW5jdGlvbiAobm9kZSwgd2luLCBvZmZzZXRUb3ApIHtcclxuICAgICAgICB2YXIgZ2V0Vmlld1BhbmVTaXplID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGRvYyA9IHdpbi5kb2N1bWVudCxcclxuICAgICAgICAgICAgICAgICAgICBtb2RlID0gZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICB3aWR0aDooIG1vZGUgPyBkb2MuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoIDogZG9jLmJvZHkuY2xpZW50V2lkdGggKSB8fCAwLFxyXG4gICAgICAgICAgICAgICAgICAgIGhlaWdodDooIG1vZGUgPyBkb2MuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCA6IGRvYy5ib2R5LmNsaWVudEhlaWdodCApIHx8IDBcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGdldFNjcm9sbFBvc2l0aW9uID0gZnVuY3Rpb24gKHdpbikge1xyXG4gICAgICAgICAgICAgICAgaWYgKCdwYWdlWE9mZnNldCcgaW4gd2luKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgeDp3aW4ucGFnZVhPZmZzZXQgfHwgMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgeTp3aW4ucGFnZVlPZmZzZXQgfHwgMFxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZG9jID0gd2luLmRvY3VtZW50O1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHg6ZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0IHx8IGRvYy5ib2R5LnNjcm9sbExlZnQgfHwgMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgeTpkb2MuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCB8fCBkb2MuYm9keS5zY3JvbGxUb3AgfHwgMFxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgdmFyIHdpbkhlaWdodCA9IGdldFZpZXdQYW5lU2l6ZSgpLmhlaWdodCwgb2Zmc2V0ID0gd2luSGVpZ2h0ICogLTEgKyBvZmZzZXRUb3A7XHJcbiAgICAgICAgb2Zmc2V0ICs9IChub2RlLm9mZnNldEhlaWdodCB8fCAwKTtcclxuICAgICAgICB2YXIgZWxlbWVudFBvc2l0aW9uID0gZG9tVXRpbHMuZ2V0WFkobm9kZSk7XHJcbiAgICAgICAgb2Zmc2V0ICs9IGVsZW1lbnRQb3NpdGlvbi55O1xyXG4gICAgICAgIHZhciBjdXJyZW50U2Nyb2xsID0gZ2V0U2Nyb2xsUG9zaXRpb24od2luKS55O1xyXG4gICAgICAgIC8vIG9mZnNldCArPSA1MDtcclxuICAgICAgICBpZiAob2Zmc2V0ID4gY3VycmVudFNjcm9sbCB8fCBvZmZzZXQgPCBjdXJyZW50U2Nyb2xsIC0gd2luSGVpZ2h0KSB7XHJcbiAgICAgICAgICAgIHdpbi5zY3JvbGxUbygwLCBvZmZzZXQgKyAob2Zmc2V0IDwgMCA/IC0yMCA6IDIwKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIC8qKlxyXG4gICAgICog5Yik5pat57uZ5a6a6IqC54K55piv5ZCm5Li6YnJcclxuICAgICAqIEBtZXRob2QgaXNCclxyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg6ZyA6KaB5Yik5pat55qE6IqC54K55a+56LGhXHJcbiAgICAgKiBAcmV0dXJuIHsgQm9vbGVhbiB9IOe7meWumueahOiKgueCueaYr+WQpuaYr2Jy6IqC54K5XHJcbiAgICAgKi9cclxuICAgIGlzQnI6ZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PSAxICYmIG5vZGUudGFnTmFtZSA9PSAnQlInO1xyXG4gICAgfSxcclxuICAgIC8qKlxyXG4gICAgICog5Yik5pat57uZ5a6a55qE6IqC54K55piv5ZCm5piv5LiA5Liq4oCc5aGr5YWF4oCd6IqC54K5XHJcbiAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICogQG1ldGhvZCBpc0ZpbGxDaGFyXHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZSDpnIDopoHliKTmlq3nmoToioLngrlcclxuICAgICAqIEBwYXJhbSB7IEJvb2xlYW4gfSBpc0luU3RhcnQg5piv5ZCm5LuO6IqC54K55YaF5a6555qE5byA5aeL5L2N572u5Yy56YWNXHJcbiAgICAgKiBAcmV0dXJucyB7IEJvb2xlYW4gfSDoioLngrnmmK/lkKbmmK/loavlhYXoioLngrlcclxuICAgICAqL1xyXG4gICAgaXNGaWxsQ2hhcjpmdW5jdGlvbiAobm9kZSxpc0luU3RhcnQpIHtcclxuICAgICAgICBpZihub2RlLm5vZGVUeXBlICE9IDMpXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB2YXIgdGV4dCA9IG5vZGUubm9kZVZhbHVlO1xyXG4gICAgICAgIGlmKGlzSW5TdGFydCl7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIGRvbVV0aWxzLmZpbGxDaGFyKS50ZXN0KHRleHQpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAhdGV4dC5yZXBsYWNlKG5ldyBSZWdFeHAoZG9tVXRpbHMuZmlsbENoYXIsJ2cnKSwgJycpLmxlbmd0aFxyXG4gICAgfSxcclxuICAgIGlzU3RhcnRJbmJsb2NrOmZ1bmN0aW9uIChyYW5nZSkge1xyXG4gICAgICAgIHZhciB0bXBSYW5nZSA9IHJhbmdlLmNsb25lUmFuZ2UoKSxcclxuICAgICAgICAgICAgZmxhZyA9IDAsXHJcbiAgICAgICAgICAgIHN0YXJ0ID0gdG1wUmFuZ2Uuc3RhcnRDb250YWluZXIsXHJcbiAgICAgICAgICAgIHRtcDtcclxuICAgICAgICBpZihzdGFydC5ub2RlVHlwZSA9PSAxICYmIHN0YXJ0LmNoaWxkTm9kZXNbdG1wUmFuZ2Uuc3RhcnRPZmZzZXRdKXtcclxuICAgICAgICAgICAgc3RhcnQgPSBzdGFydC5jaGlsZE5vZGVzW3RtcFJhbmdlLnN0YXJ0T2Zmc2V0XTtcclxuICAgICAgICAgICAgdmFyIHByZSA9IHN0YXJ0LnByZXZpb3VzU2libGluZztcclxuICAgICAgICAgICAgd2hpbGUocHJlICYmIGRvbVV0aWxzLmlzRmlsbENoYXIocHJlKSl7XHJcbiAgICAgICAgICAgICAgICBzdGFydCA9IHByZTtcclxuICAgICAgICAgICAgICAgIHByZSA9IHByZS5wcmV2aW91c1NpYmxpbmc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYodGhpcy5pc0ZpbGxDaGFyKHN0YXJ0LHRydWUpICYmIHRtcFJhbmdlLnN0YXJ0T2Zmc2V0ID09IDEpe1xyXG4gICAgICAgICAgICB0bXBSYW5nZS5zZXRTdGFydEJlZm9yZShzdGFydCk7XHJcbiAgICAgICAgICAgIHN0YXJ0ID0gdG1wUmFuZ2Uuc3RhcnRDb250YWluZXI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB3aGlsZSAoc3RhcnQgJiYgZG9tVXRpbHMuaXNGaWxsQ2hhcihzdGFydCkpIHtcclxuICAgICAgICAgICAgdG1wID0gc3RhcnQ7XHJcbiAgICAgICAgICAgIHN0YXJ0ID0gc3RhcnQucHJldmlvdXNTaWJsaW5nXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0bXApIHtcclxuICAgICAgICAgICAgdG1wUmFuZ2Uuc2V0U3RhcnRCZWZvcmUodG1wKTtcclxuICAgICAgICAgICAgc3RhcnQgPSB0bXBSYW5nZS5zdGFydENvbnRhaW5lcjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHN0YXJ0Lm5vZGVUeXBlID09IDEgJiYgZG9tVXRpbHMuaXNFbXB0eU5vZGUoc3RhcnQpICYmIHRtcFJhbmdlLnN0YXJ0T2Zmc2V0ID09IDEpIHtcclxuICAgICAgICAgICAgdG1wUmFuZ2Uuc2V0U3RhcnQoc3RhcnQsIDApLmNvbGxhcHNlKHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB3aGlsZSAoIXRtcFJhbmdlLnN0YXJ0T2Zmc2V0KSB7XHJcbiAgICAgICAgICAgIHN0YXJ0ID0gdG1wUmFuZ2Uuc3RhcnRDb250YWluZXI7XHJcbiAgICAgICAgICAgIGlmIChkb21VdGlscy5pc0Jsb2NrRWxtKHN0YXJ0KSB8fCBkb21VdGlscy5pc0JvZHkoc3RhcnQpKSB7XHJcbiAgICAgICAgICAgICAgICBmbGFnID0gMTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBwcmUgPSB0bXBSYW5nZS5zdGFydENvbnRhaW5lci5wcmV2aW91c1NpYmxpbmcsXHJcbiAgICAgICAgICAgICAgICB0bXBOb2RlO1xyXG4gICAgICAgICAgICBpZiAoIXByZSkge1xyXG4gICAgICAgICAgICAgICAgdG1wUmFuZ2Uuc2V0U3RhcnRCZWZvcmUodG1wUmFuZ2Uuc3RhcnRDb250YWluZXIpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgd2hpbGUgKHByZSAmJiBkb21VdGlscy5pc0ZpbGxDaGFyKHByZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0bXBOb2RlID0gcHJlO1xyXG4gICAgICAgICAgICAgICAgICAgIHByZSA9IHByZS5wcmV2aW91c1NpYmxpbmc7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAodG1wTm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRtcFJhbmdlLnNldFN0YXJ0QmVmb3JlKHRtcE5vZGUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0bXBSYW5nZS5zZXRTdGFydEJlZm9yZSh0bXBSYW5nZS5zdGFydENvbnRhaW5lcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZsYWcgJiYgIWRvbVV0aWxzLmlzQm9keSh0bXBSYW5nZS5zdGFydENvbnRhaW5lcikgPyAxIDogMDtcclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDliKTmlq3nu5nlrprnmoTlhYPntKDmmK/lkKbmmK/kuIDkuKrnqbrlhYPntKBcclxuICAgICAqIEBtZXRob2QgaXNFbXB0eUJsb2NrXHJcbiAgICAgKiBAcGFyYW0geyBFbGVtZW50IH0gbm9kZSDpnIDopoHliKTmlq3nmoTlhYPntKBcclxuICAgICAqIEByZXR1cm4geyBCb29sZWFuIH0g5piv5ZCm5piv56m65YWD57SgXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPGRpdiBpZD1cInRlc3RcIj48L2Rpdj5cclxuICAgICAqXHJcbiAgICAgKiA8c2NyaXB0PlxyXG4gICAgICogICAgIC8vb3V0cHV0OiB0cnVlXHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIFVFLmRvbS5kb21VdGlscy5pc0VtcHR5QmxvY2soIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidGVzdFwiKSApICk7XHJcbiAgICAgKiA8L3NjcmlwdD5cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmoLnmja7mjIflrprnmoTliKTmlq3op4TliJnliKTmlq3nu5nlrprnmoTlhYPntKDmmK/lkKbmmK/kuIDkuKrnqbrlhYPntKBcclxuICAgICAqIEBtZXRob2QgaXNFbXB0eUJsb2NrXHJcbiAgICAgKiBAcGFyYW0geyBFbGVtZW50IH0gbm9kZSDpnIDopoHliKTmlq3nmoTlhYPntKBcclxuICAgICAqIEBwYXJhbSB7IFJlZ0V4cCB9IHJlZyDlr7nlhoXlrrnmiafooYzliKTmlq3nmoTmraPliJnooajovr7lvI/lr7nosaFcclxuICAgICAqIEByZXR1cm4geyBCb29sZWFuIH0g5piv5ZCm5piv56m65YWD57SgXHJcbiAgICAgKi9cclxuICAgIGlzRW1wdHlCbG9jazpmdW5jdGlvbiAobm9kZSxyZWcpIHtcclxuICAgICAgICBpZihub2RlLm5vZGVUeXBlICE9IDEpXHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIHJlZyA9IHJlZyB8fCBuZXcgUmVnRXhwKCdbIFxceGEwXFx0XFxyXFxuJyArIGRvbVV0aWxzLmZpbGxDaGFyICsgJ10nLCAnZycpO1xyXG5cclxuICAgICAgICBpZiAobm9kZVticm93c2VyLmllID8gJ2lubmVyVGV4dCcgOiAndGV4dENvbnRlbnQnXS5yZXBsYWNlKHJlZywgJycpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAodmFyIG4gaW4gZHRkLiRpc05vdEVtcHR5KSB7XHJcbiAgICAgICAgICAgIGlmIChub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKG4pLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIDE7XHJcbiAgICB9LFxyXG5cclxuICAgIC8qKlxyXG4gICAgICog56e75Yqo5YWD57Sg5L2/5b6X6K+l5YWD57Sg55qE5L2N572u56e75Yqo5oyH5a6a55qE5YGP56e76YeP55qE6Led56a7XHJcbiAgICAgKiBAbWV0aG9kIHNldFZpZXdwb3J0T2Zmc2V0XHJcbiAgICAgKiBAcGFyYW0geyBFbGVtZW50IH0gZWxlbWVudCDpnIDopoHorr7nva7lgY/np7vph4/nmoTlhYPntKBcclxuICAgICAqIEBwYXJhbSB7IE9iamVjdCB9IG9mZnNldCDlgY/np7vph4/vvIwg5b2i5aaCeyBsZWZ0OiAxMDAsIHRvcDogNTAgfeeahOS4gOS4qumUruWAvOWvue+8jCDooajnpLror6XlhYPntKDlsIblnKhcclxuICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIOeOsOacieeahOS9jee9ruS4iuWQkeawtOW5s+aWueWQkeWBj+enu29mZnNldC5sZWZ055qE6Led56a777yMIOWcqOerluebtOaWueWQkeS4iuWBj+enu1xyXG4gICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LnRvcOeahOi3neemu1xyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGh0bWxcclxuICAgICAqIDxkaXYgaWQ9XCJ0ZXN0XCIgc3R5bGU9XCJ0b3A6IDEwMHB4OyBsZWZ0OiA1MHB4OyBwb3NpdGlvbjogYWJzb2x1dGU7XCI+PC9kaXY+XHJcbiAgICAgKlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqXHJcbiAgICAgKiAgICAgdmFyIHRlc3ROb2RlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ0ZXN0XCIpO1xyXG4gICAgICpcclxuICAgICAqICAgICBVRS5kb20uZG9tVXRpbHMuc2V0Vmlld3BvcnRPZmZzZXQoIHRlc3ROb2RlLCB7XHJcbiAgICAgKiAgICAgICAgIGxlZnQ6IDIwMCxcclxuICAgICAqICAgICAgICAgdG9wOiA1MFxyXG4gICAgICogICAgIH0gKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IHRvcDogMzAwcHg7IGxlZnQ6IDEwMHB4OyBwb3NpdGlvbjogYWJzb2x1dGU7XHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIHRlc3ROb2RlLnN0eWxlLmNzc1RleHQgKTtcclxuICAgICAqXHJcbiAgICAgKiA8L3NjcmlwdD5cclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBzZXRWaWV3cG9ydE9mZnNldDpmdW5jdGlvbiAoZWxlbWVudCwgb2Zmc2V0KSB7XHJcbiAgICAgICAgdmFyIGxlZnQgPSBwYXJzZUludChlbGVtZW50LnN0eWxlLmxlZnQpIHwgMDtcclxuICAgICAgICB2YXIgdG9wID0gcGFyc2VJbnQoZWxlbWVudC5zdHlsZS50b3ApIHwgMDtcclxuICAgICAgICB2YXIgcmVjdCA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgdmFyIG9mZnNldExlZnQgPSBvZmZzZXQubGVmdCAtIHJlY3QubGVmdDtcclxuICAgICAgICB2YXIgb2Zmc2V0VG9wID0gb2Zmc2V0LnRvcCAtIHJlY3QudG9wO1xyXG4gICAgICAgIGlmIChvZmZzZXRMZWZ0KSB7XHJcbiAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUubGVmdCA9IGxlZnQgKyBvZmZzZXRMZWZ0ICsgJ3B4JztcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG9mZnNldFRvcCkge1xyXG4gICAgICAgICAgICBlbGVtZW50LnN0eWxlLnRvcCA9IHRvcCArIG9mZnNldFRvcCArICdweCc7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOeUqOKAnOWhq+WFheWtl+espuKAneWhq+WFheiKgueCuVxyXG4gICAgICogQG1ldGhvZCBmaWxsTm9kZVxyXG4gICAgICogQHByaXZhdGVcclxuICAgICAqIEBwYXJhbSB7IERvbURvY3VtZW50IH0gZG9jIOWhq+WFheeahOiKgueCueaJgOWcqOeahGRvY21lbnTlr7nosaFcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOmcgOimgeWhq+WFheeahOiKgueCueWvueixoVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGh0bWxcclxuICAgICAqIDxkaXYgaWQ9XCJ0ZXN0XCI+PC9kaXY+XHJcbiAgICAgKlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqICAgICB2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInRlc3RcIik7XHJcbiAgICAgKlxyXG4gICAgICogICAgIC8vb3V0cHV0OiAwXHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIHRlc3ROb2RlLmNoaWxkTm9kZXMubGVuZ3RoICk7XHJcbiAgICAgKlxyXG4gICAgICogICAgIFVFLmRvbS5kb21VdGlscy5maWxsTm9kZSggZG9jdW1lbnQsIHRlc3ROb2RlICk7XHJcbiAgICAgKlxyXG4gICAgICogICAgIC8vb3V0cHV0OiAxXHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIHRlc3ROb2RlLmNoaWxkTm9kZXMubGVuZ3RoICk7XHJcbiAgICAgKlxyXG4gICAgICogPC9zY3JpcHQ+XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgZmlsbE5vZGU6ZnVuY3Rpb24gKGRvYywgbm9kZSkge1xyXG4gICAgICAgIHZhciB0bXBOb2RlID0gYnJvd3Nlci5pZSA/IGRvYy5jcmVhdGVUZXh0Tm9kZShkb21VdGlscy5maWxsQ2hhcikgOiBkb2MuY3JlYXRlRWxlbWVudCgnYnInKTtcclxuICAgICAgICBub2RlLmlubmVySFRNTCA9ICcnO1xyXG4gICAgICAgIG5vZGUuYXBwZW5kQ2hpbGQodG1wTm9kZSk7XHJcbiAgICB9LFxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5oqK6IqC54K5c3Jj55qE5omA5pyJ5a2Q6IqC54K56L+95Yqg5Yiw5Y+m5LiA5Liq6IqC54K5dGFn5LiK5Y67XHJcbiAgICAgKiBAbWV0aG9kIG1vdmVDaGlsZFxyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IHNyYyDmupDoioLngrnvvIwg6K+l6IqC54K55LiL55qE5omA5pyJ5a2Q6IqC54K55bCG6KKr56e76ZmkXHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gdGFnIOebruagh+iKgueCue+8jCDku47mupDoioLngrnnp7vpmaTnmoTlrZDoioLngrnlsIbooqvov73liqDliLDor6XoioLngrnkuItcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBodG1sXHJcbiAgICAgKiA8ZGl2IGlkPVwidGVzdDFcIj5cclxuICAgICAqICAgICAgPHNwYW4+PC9zcGFuPlxyXG4gICAgICogPC9kaXY+XHJcbiAgICAgKiA8ZGl2IGlkPVwidGVzdDJcIj5cclxuICAgICAqICAgICA8ZGl2PjwvZGl2PlxyXG4gICAgICogPC9kaXY+XHJcbiAgICAgKlxyXG4gICAgICogPHNjcmlwdD5cclxuICAgICAqXHJcbiAgICAgKiAgICAgdmFyIHRlc3QxID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ0ZXN0MVwiKSxcclxuICAgICAqICAgICAgICAgdGVzdDIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInRlc3QyXCIpO1xyXG4gICAgICpcclxuICAgICAqICAgICBVRS5kb20uZG9tVXRpbHMubW92ZUNoaWxkKCB0ZXN0MSwgdGVzdDIgKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IFwiXCLvvIjnqbrlrZfnrKbkuLLvvIlcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggdGVzdDEuaW5uZXJIVE1MICk7XHJcbiAgICAgKlxyXG4gICAgICogICAgIC8vb3V0cHV0OiBcIjxkaXY+PC9kaXY+PHNwYW4+PC9zcGFuPlwiXHJcbiAgICAgKiAgICAgY29uc29sZS5sb2coIHRlc3QyLmlubmVySFRNTCApO1xyXG4gICAgICpcclxuICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIOaKiuiKgueCuXNyY+eahOaJgOacieWtkOiKgueCueenu+WKqOWIsOWPpuS4gOS4quiKgueCuXRhZ+S4iuWOuywg5Y+v5Lul6YCa6L+HZGly5Y+C5pWw5o6n5Yi26ZmE5Yqg55qE6KGM5Li65piv4oCc6L+95Yqg4oCd6L+Y5piv4oCc5o+S5YWl6aG26YOo4oCdXHJcbiAgICAgKiBAbWV0aG9kIG1vdmVDaGlsZFxyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IHNyYyDmupDoioLngrnvvIwg6K+l6IqC54K55LiL55qE5omA5pyJ5a2Q6IqC54K55bCG6KKr56e76ZmkXHJcbiAgICAgKiBAcGFyYW0geyBOb2RlIH0gdGFnIOebruagh+iKgueCue+8jCDku47mupDoioLngrnnp7vpmaTnmoTlrZDoioLngrnlsIbooqvpmYTliqDliLDor6XoioLngrnkuItcclxuICAgICAqIEBwYXJhbSB7IEJvb2xlYW4gfSBkaXIg6ZmE5Yqg5pa55byP77yMIOWmguaenOS4unRydWXvvIwg5YiZ6ZmE5Yqg6L+b5Y6755qE6IqC54K55bCG6KKr5pS+5Yiw55uu5qCH6IqC54K555qE6aG26YOo77yMIOWPjeS5i++8jOWImeaUvuWIsOacq+WwvlxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGh0bWxcclxuICAgICAqIDxkaXYgaWQ9XCJ0ZXN0MVwiPlxyXG4gICAgICogICAgICA8c3Bhbj48L3NwYW4+XHJcbiAgICAgKiA8L2Rpdj5cclxuICAgICAqIDxkaXYgaWQ9XCJ0ZXN0MlwiPlxyXG4gICAgICogICAgIDxkaXY+PC9kaXY+XHJcbiAgICAgKiA8L2Rpdj5cclxuICAgICAqXHJcbiAgICAgKiA8c2NyaXB0PlxyXG4gICAgICpcclxuICAgICAqICAgICB2YXIgdGVzdDEgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInRlc3QxXCIpLFxyXG4gICAgICogICAgICAgICB0ZXN0MiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidGVzdDJcIik7XHJcbiAgICAgKlxyXG4gICAgICogICAgIFVFLmRvbS5kb21VdGlscy5tb3ZlQ2hpbGQoIHRlc3QxLCB0ZXN0MiwgdHJ1ZSApO1xyXG4gICAgICpcclxuICAgICAqICAgICAvL291dHB1dDogXCJcIu+8iOepuuWtl+espuS4su+8iVxyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCB0ZXN0MS5pbm5lckhUTUwgKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IFwiPHNwYW4+PC9zcGFuPjxkaXY+PC9kaXY+XCJcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggdGVzdDIuaW5uZXJIVE1MICk7XHJcbiAgICAgKlxyXG4gICAgICogPC9zY3JpcHQ+XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgbW92ZUNoaWxkOmZ1bmN0aW9uIChzcmMsIHRhZywgZGlyKSB7XHJcbiAgICAgICAgd2hpbGUgKHNyYy5maXJzdENoaWxkKSB7XHJcbiAgICAgICAgICAgIGlmIChkaXIgJiYgdGFnLmZpcnN0Q2hpbGQpIHtcclxuICAgICAgICAgICAgICAgIHRhZy5pbnNlcnRCZWZvcmUoc3JjLmxhc3RDaGlsZCwgdGFnLmZpcnN0Q2hpbGQpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGFnLmFwcGVuZENoaWxkKHNyYy5maXJzdENoaWxkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDliKTmlq3oioLngrnnmoTmoIfnrb7kuIrmmK/lkKbkuI3lrZjlnKjku7vkvZXlsZ7mgKdcclxuICAgICAqIEBtZXRob2QgaGFzTm9BdHRyaWJ1dGVzXHJcbiAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg6ZyA6KaB5qOA5rWL55qE6IqC54K55a+56LGhXHJcbiAgICAgKiBAcmV0dXJuIHsgQm9vbGVhbiB9IOiKgueCueaYr+WQpuS4jeWMheWQq+S7u+S9leWxnuaAp1xyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGh0bWxcclxuICAgICAqIDxkaXYgaWQ9XCJ0ZXN0XCI+PHNwYW4+eHh4eDwvc3Bhbj48L2Rpdj5cclxuICAgICAqXHJcbiAgICAgKiA8c2NyaXB0PlxyXG4gICAgICpcclxuICAgICAqICAgICAvL291dHB1dDogZmFsc2VcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggVUUuZG9tLmRvbVV0aWxzLmhhc05vQXR0cmlidXRlcyggZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ0ZXN0XCIpICkgKTtcclxuICAgICAqXHJcbiAgICAgKiAgICAgLy9vdXRwdXQ6IHRydWVcclxuICAgICAqICAgICBjb25zb2xlLmxvZyggVUUuZG9tLmRvbVV0aWxzLmhhc05vQXR0cmlidXRlcyggZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ0ZXN0XCIpLmZpcnN0Q2hpbGQgKSApO1xyXG4gICAgICpcclxuICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIGhhc05vQXR0cmlidXRlczpmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgIHJldHVybiBicm93c2VyLmllID8gL148XFx3K1xccyo/Pi8udGVzdChub2RlLm91dGVySFRNTCkgOiBub2RlLmF0dHJpYnV0ZXMubGVuZ3RoID09IDA7XHJcbiAgICB9LFxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5qOA5rWL6IqC54K55piv5ZCm5pivVUVkaXRvcuaJgOS9v+eUqOeahOi+heWKqeiKgueCuVxyXG4gICAgICogQG1ldGhvZCBpc0N1c3RvbWVOb2RlXHJcbiAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg6ZyA6KaB5qOA5rWL55qE6IqC54K5XHJcbiAgICAgKiBAcmVtaW5kIOi+heWKqeiKgueCueaYr+aMh+e8lui+keWZqOimgeWujOaIkOW3peS9nOS4tOaXtua3u+WKoOeahOiKgueCue+8jCDlnKjovpPlh7rnmoTml7blgJnlsIbkvJrku47nvJbovpHlmajlhoXnp7vpmaTvvIwg5LiN5Lya5b2x5ZON5pyA57uI55qE57uT5p6c44CCXHJcbiAgICAgKiBAcmV0dXJuIHsgQm9vbGVhbiB9IOe7meWumueahOiKgueCueaYr+WQpuaYr+S4gOS4qui+heWKqeiKgueCuVxyXG4gICAgICovXHJcbiAgICBpc0N1c3RvbWVOb2RlOmZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT0gMSAmJiBub2RlLmdldEF0dHJpYnV0ZSgnX3VlX2N1c3RvbV9ub2RlXycpO1xyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOajgOa1i+iKgueCueeahOagh+etvuaYr+WQpuaYr+e7meWumueahOagh+etvlxyXG4gICAgICogQG1ldGhvZCBpc1RhZ05vZGVcclxuICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOmcgOimgeajgOa1i+eahOiKgueCueWvueixoVxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gdGFnTmFtZSDmoIfnrb5cclxuICAgICAqIEByZXR1cm4geyBCb29sZWFuIH0g6IqC54K555qE5qCH562+5piv5ZCm5piv57uZ5a6a55qE5qCH562+XHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgaHRtbFxyXG4gICAgICogPGRpdiBpZD1cInRlc3RcIj48L2Rpdj5cclxuICAgICAqXHJcbiAgICAgKiA8c2NyaXB0PlxyXG4gICAgICpcclxuICAgICAqICAgICAvL291dHB1dDogdHJ1ZVxyXG4gICAgICogICAgIGNvbnNvbGUubG9nKCBVRS5kb20uZG9tVXRpbHMuaXNUYWdOb2RlKCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInRlc3RcIiksIFwiZGl2XCIgKSApO1xyXG4gICAgICpcclxuICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIGlzVGFnTm9kZTpmdW5jdGlvbiAobm9kZSwgdGFnTmFtZXMpIHtcclxuICAgICAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PSAxICYmIG5ldyBSZWdFeHAoJ1xcXFxiJyArIG5vZGUudGFnTmFtZSArICdcXFxcYicsJ2knKS50ZXN0KHRhZ05hbWVzKVxyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOe7meWumuS4gOS4quiKgueCueaVsOe7hO+8jOWcqOmAmui/h+aMh+WumueahOi/h+a7pOWZqOi/h+a7pOWQju+8jCDojrflj5blhbbkuK3mu6HotrPov4fmu6TmnaHku7bnmoTnrKzkuIDkuKroioLngrlcclxuICAgICAqIEBtZXRob2QgZmlsdGVyTm9kZUxpc3RcclxuICAgICAqIEBwYXJhbSB7IEFycmF5IH0gbm9kZUxpc3Qg6ZyA6KaB6L+H5ruk55qE6IqC54K55pWw57uEXHJcbiAgICAgKiBAcGFyYW0geyBGdW5jdGlvbiB9IGZuIOi/h+a7pOWZqO+8jCDlr7nnrKblkIjmnaHku7bnmoToioLngrnvvIwg5omn6KGM57uT5p6c6L+U5ZuedHJ1Ze+8jCDlj43kuYvliJnov5Tlm55mYWxzZVxyXG4gICAgICogQHJldHVybiB7IE5vZGUgfCBOVUxMIH0g5aaC5p6c5om+5Yiw56ym5ZCI6L+H5ruk5p2h5Lu255qE6IqC54K577yMIOWImei/lOWbnuivpeiKgueCue+8jCDlkKbliJnov5Tlm55OVUxMXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogdmFyIGRpdk5vZGVzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJkaXZcIik7XHJcbiAgICAgKiBkaXZOb2RlcyA9IFtdLnNsaWNlLmNhbGwoIGRpdk5vZGVzLCAwICk7XHJcbiAgICAgKlxyXG4gICAgICogLy9vdXRwdXQ6IG51bGxcclxuICAgICAqIGNvbnNvbGUubG9nKCBVRS5kb20uZG9tVXRpbHMuZmlsdGVyTm9kZUxpc3QoIGRpdk5vZGVzLCBmdW5jdGlvbiAoIG5vZGUgKSB7XHJcbiAgICAgKiAgICAgcmV0dXJuIG5vZGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAnZGl2JztcclxuICAgICAqIH0gKSApO1xyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIOe7meWumuS4gOS4quiKgueCueaVsOe7hG5vZGVMaXN05ZKM5LiA57uE5qCH562+5ZCNdGFnTmFtZXPvvIwg6I635Y+W5YW25Lit6IO95aSf5Yy56YWN5qCH562+5ZCN55qE6IqC54K56ZuG5ZCI5Lit55qE56ys5LiA5Liq6IqC54K5XHJcbiAgICAgKiBAbWV0aG9kIGZpbHRlck5vZGVMaXN0XHJcbiAgICAgKiBAcGFyYW0geyBBcnJheSB9IG5vZGVMaXN0IOmcgOimgei/h+a7pOeahOiKgueCueaVsOe7hFxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gdGFnTmFtZXMg6ZyA6KaB5Yy56YWN55qE5qCH562+5ZCN77yMIOWkmuS4quagh+etvuWQjeS5i+mXtOeUqOepuuagvOWIhuWJslxyXG4gICAgICogQHJldHVybiB7IE5vZGUgfCBOVUxMIH0g5aaC5p6c5om+5Yiw5qCH562+5ZCN5Yy56YWN55qE6IqC54K577yMIOWImei/lOWbnuivpeiKgueCue+8jCDlkKbliJnov5Tlm55OVUxMXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogdmFyIGRpdk5vZGVzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJkaXZcIik7XHJcbiAgICAgKiBkaXZOb2RlcyA9IFtdLnNsaWNlLmNhbGwoIGRpdk5vZGVzLCAwICk7XHJcbiAgICAgKlxyXG4gICAgICogLy9vdXRwdXQ6IG51bGxcclxuICAgICAqIGNvbnNvbGUubG9nKCBVRS5kb20uZG9tVXRpbHMuZmlsdGVyTm9kZUxpc3QoIGRpdk5vZGVzLCAnYSBzcGFuJyApICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog57uZ5a6a5LiA5Liq6IqC54K55pWw57uE77yM5Zyo6YCa6L+H5oyH5a6a55qE6L+H5ruk5Zmo6L+H5ruk5ZCO77yMIOWmguaenOWPguaVsGZvckFsbOS4unRydWXvvIwg5YiZ5Lya6L+U5Zue5omA5pyJ5ruh6Laz6L+H5rukXHJcbiAgICAgKiDmnaHku7bnmoToioLngrnpm4blkIjvvIwg5ZCm5YiZ77yMIOi/lOWbnua7oei2s+adoeS7tueahOiKgueCuembhuWQiOS4reeahOesrOS4gOS4quiKgueCuVxyXG4gICAgICogQG1ldGhvZCBmaWx0ZXJOb2RlTGlzdFxyXG4gICAgICogQHBhcmFtIHsgQXJyYXkgfSBub2RlTGlzdCDpnIDopoHov4fmu6TnmoToioLngrnmlbDnu4RcclxuICAgICAqIEBwYXJhbSB7IEZ1bmN0aW9uIH0gZm4g6L+H5ruk5Zmo77yMIOWvueespuWQiOadoeS7tueahOiKgueCue+8jCDmiafooYznu5Pmnpzov5Tlm550cnVl77yMIOWPjeS5i+WImei/lOWbnmZhbHNlXHJcbiAgICAgKiBAcGFyYW0geyBCb29sZWFuIH0gZm9yQWxsIOaYr+WQpui/lOWbnuaVtOS4quiKgueCueaVsOe7hCwg5aaC5p6c6K+l5Y+C5pWw5Li6ZmFsc2XvvIwg5YiZ6L+U5Zue6IqC54K56ZuG5ZCI5Lit55qE56ys5LiA5Liq6IqC54K5XHJcbiAgICAgKiBAcmV0dXJuIHsgQXJyYXkgfCBOb2RlIHwgTlVMTCB9IOWmguaenOaJvuWIsOespuWQiOi/h+a7pOadoeS7tueahOiKgueCue+8jCDliJnmoLnmja7lj4LmlbBmb3JBbGznmoTlgLzlhrPlrprov5Tlm57mu6HotrNcclxuICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICDov4fmu6TmnaHku7bnmoToioLngrnmlbDnu4TmiJbnrKzkuIDkuKroioLngrnvvIwg5ZCm5YiZ6L+U5ZueTlVMTFxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIHZhciBkaXZOb2RlcyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiZGl2XCIpO1xyXG4gICAgICogZGl2Tm9kZXMgPSBbXS5zbGljZS5jYWxsKCBkaXZOb2RlcywgMCApO1xyXG4gICAgICpcclxuICAgICAqIC8vb3V0cHV0OiAz77yI5YGH5a6a5pyJM+S4qmRpdu+8iVxyXG4gICAgICogY29uc29sZS5sb2coIGRpdk5vZGVzLmxlbmd0aCApO1xyXG4gICAgICpcclxuICAgICAqIHZhciBub2RlcyA9IFVFLmRvbS5kb21VdGlscy5maWx0ZXJOb2RlTGlzdCggZGl2Tm9kZXMsIGZ1bmN0aW9uICggbm9kZSApIHtcclxuICAgICAqICAgICByZXR1cm4gbm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdkaXYnO1xyXG4gICAgICogfSwgdHJ1ZSApO1xyXG4gICAgICpcclxuICAgICAqIC8vb3V0cHV0OiAzXHJcbiAgICAgKiBjb25zb2xlLmxvZyggbm9kZXMubGVuZ3RoICk7XHJcbiAgICAgKlxyXG4gICAgICogdmFyIG5vZGUgPSBVRS5kb20uZG9tVXRpbHMuZmlsdGVyTm9kZUxpc3QoIGRpdk5vZGVzLCBmdW5jdGlvbiAoIG5vZGUgKSB7XHJcbiAgICAgKiAgICAgcmV0dXJuIG5vZGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnZGl2JztcclxuICAgICAqIH0sIGZhbHNlICk7XHJcbiAgICAgKlxyXG4gICAgICogLy9vdXRwdXQ6IGRpdlxyXG4gICAgICogY29uc29sZS5sb2coIG5vZGUubm9kZU5hbWUgKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBmaWx0ZXJOb2RlTGlzdCA6IGZ1bmN0aW9uKG5vZGVsaXN0LGZpbHRlcixmb3JBbGwpe1xyXG4gICAgICAgIHZhciByZXN1bHRzID0gW107XHJcbiAgICAgICAgaWYoIXV0aWxzIC5pc0Z1bmN0aW9uKGZpbHRlcikpe1xyXG4gICAgICAgICAgICB2YXIgc3RyID0gZmlsdGVyO1xyXG4gICAgICAgICAgICBmaWx0ZXIgPSBmdW5jdGlvbihuKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiB1dGlscy5pbmRleE9mKHV0aWxzLmlzQXJyYXkoc3RyKSA/IHN0cjpzdHIuc3BsaXQoJyAnKSwgbi50YWdOYW1lLnRvTG93ZXJDYXNlKCkpICE9IC0xXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHV0aWxzLmVhY2gobm9kZWxpc3QsZnVuY3Rpb24obil7XHJcbiAgICAgICAgICAgIGZpbHRlcihuKSAmJiByZXN1bHRzLnB1c2gobilcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gcmVzdWx0cy5sZW5ndGggID09IDAgPyBudWxsIDogcmVzdWx0cy5sZW5ndGggPT0gMSB8fCAhZm9yQWxsID8gcmVzdWx0c1swXSA6IHJlc3VsdHNcclxuICAgIH0sXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmn6Xor6Lnu5nlrprnmoRyYW5nZemAieWMuuaYr+WQpuWcqOe7meWumueahG5vZGXoioLngrnlhoXvvIzkuJTlnKjor6XoioLngrnnmoTmnIDmnKvlsL5cclxuICAgICAqIEBtZXRob2QgaXNJbk5vZGVFbmRCb3VuZGFyeVxyXG4gICAgICogQHBhcmFtIHsgVUUuZG9tLlJhbmdlIH0gcm5nIOmcgOimgeWIpOaWreeahHJhbmdl5a+56LGh77yMIOivpeWvueixoeeahHN0YXJ0Q29udGFpbmVy5LiN6IO95Li6TlVMTFxyXG4gICAgICogQHBhcmFtIG5vZGUg6ZyA6KaB5qOA5rWL55qE6IqC54K55a+56LGhXHJcbiAgICAgKiBAcmV0dXJuIHsgTnVtYmVyIH0g5aaC5p6c57uZ5a6a55qE6YCJ5Y+WcmFuZ2Xlr7nosaHmmK/lnKhub2Rl5YaF6YOo55qE5pyA5pyr56uv77yMIOWImei/lOWbnjEsIOWQpuWImei/lOWbnjBcclxuICAgICAqL1xyXG4gICAgaXNJbk5vZGVFbmRCb3VuZGFyeSA6IGZ1bmN0aW9uIChybmcsbm9kZSl7XHJcbiAgICAgICAgdmFyIHN0YXJ0ID0gcm5nLnN0YXJ0Q29udGFpbmVyO1xyXG4gICAgICAgIGlmKHN0YXJ0Lm5vZGVUeXBlID09IDMgJiYgcm5nLnN0YXJ0T2Zmc2V0ICE9IHN0YXJ0Lm5vZGVWYWx1ZS5sZW5ndGgpe1xyXG4gICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYoc3RhcnQubm9kZVR5cGUgPT0gMSAmJiBybmcuc3RhcnRPZmZzZXQgIT0gc3RhcnQuY2hpbGROb2Rlcy5sZW5ndGgpe1xyXG4gICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgd2hpbGUoc3RhcnQgIT09IG5vZGUpe1xyXG4gICAgICAgICAgICBpZihzdGFydC5uZXh0U2libGluZyl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gMFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBzdGFydCA9IHN0YXJ0LnBhcmVudE5vZGU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAxO1xyXG4gICAgfSxcclxuICAgIGlzQm91bmRhcnlOb2RlIDogZnVuY3Rpb24gKG5vZGUsZGlyKXtcclxuICAgICAgICB2YXIgdG1wO1xyXG4gICAgICAgIHdoaWxlKCFkb21VdGlscy5pc0JvZHkobm9kZSkpe1xyXG4gICAgICAgICAgICB0bXAgPSBub2RlO1xyXG4gICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICBpZih0bXAgIT09IG5vZGVbZGlyXSl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9LFxyXG4gICAgZmlsbEh0bWwgOiAgYnJvd3Nlci5pZTExYmVsb3cgPyAnJm5ic3A7JyA6ICc8YnIvPidcclxufTtcclxudmFyIGZpbGxDaGFyUmVnID0gbmV3IFJlZ0V4cChkb21VdGlscy5maWxsQ2hhciwgJ2cnKTtcblxuLy8gY29yZS9SYW5nZS5qc1xuLyoqXHJcbiAqIFJhbmdl5bCB6KOFXHJcbiAqIEBmaWxlXHJcbiAqIEBtb2R1bGUgVUUuZG9tXHJcbiAqIEBjbGFzcyBSYW5nZVxyXG4gKiBAc2luY2UgMS4yLjYuMVxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiBkb23mk43kvZzlsIHoo4VcclxuICogQHVuZmlsZVxyXG4gKiBAbW9kdWxlIFVFLmRvbVxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiBSYW5nZeWunueOsOexu++8jOacrOexu+aYr1VFZGl0b3LlupXlsYLmoLjlv4PnsbvvvIzlsIHoo4XkuI3lkIzmtY/op4jlmajkuYvpl7TnmoRSYW5nZeaTjeS9nOOAglxyXG4gKiBAdW5maWxlXHJcbiAqIEBtb2R1bGUgVUUuZG9tXHJcbiAqIEBjbGFzcyBSYW5nZVxyXG4gKi9cclxuXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGd1aWQgPSAwLFxyXG4gICAgICAgIGZpbGxDaGFyID0gZG9tVXRpbHMuZmlsbENoYXIsXHJcbiAgICAgICAgZmlsbERhdGE7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmm7TmlrByYW5nZeeahGNvbGxhcHNl54q25oCBXHJcbiAgICAgKiBAcGFyYW0gIHtSYW5nZX0gICByYW5nZSAgICByYW5nZeWvueixoVxyXG4gICAgICovXHJcbiAgICBmdW5jdGlvbiB1cGRhdGVDb2xsYXBzZShyYW5nZSkge1xyXG4gICAgICAgIHJhbmdlLmNvbGxhcHNlZCA9XHJcbiAgICAgICAgICAgIHJhbmdlLnN0YXJ0Q29udGFpbmVyICYmIHJhbmdlLmVuZENvbnRhaW5lciAmJlxyXG4gICAgICAgICAgICAgICAgcmFuZ2Uuc3RhcnRDb250YWluZXIgPT09IHJhbmdlLmVuZENvbnRhaW5lciAmJlxyXG4gICAgICAgICAgICAgICAgcmFuZ2Uuc3RhcnRPZmZzZXQgPT0gcmFuZ2UuZW5kT2Zmc2V0O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNlbGVjdE9uZU5vZGUocm5nKXtcclxuICAgICAgICByZXR1cm4gIXJuZy5jb2xsYXBzZWQgJiYgcm5nLnN0YXJ0Q29udGFpbmVyLm5vZGVUeXBlID09IDEgJiYgcm5nLnN0YXJ0Q29udGFpbmVyID09PSBybmcuZW5kQ29udGFpbmVyICYmIHJuZy5lbmRPZmZzZXQgLSBybmcuc3RhcnRPZmZzZXQgPT0gMVxyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gc2V0RW5kUG9pbnQodG9TdGFydCwgbm9kZSwgb2Zmc2V0LCByYW5nZSkge1xyXG4gICAgICAgIC8v5aaC5p6cbm9kZeaYr+iHqumXreWQiOagh+etvuimgeWkhOeQhlxyXG4gICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09IDEgJiYgKGR0ZC4kZW1wdHlbbm9kZS50YWdOYW1lXSB8fCBkdGQuJG5vbkNoaWxkW25vZGUudGFnTmFtZV0pKSB7XHJcbiAgICAgICAgICAgIG9mZnNldCA9IGRvbVV0aWxzLmdldE5vZGVJbmRleChub2RlKSArICh0b1N0YXJ0ID8gMCA6IDEpO1xyXG4gICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodG9TdGFydCkge1xyXG4gICAgICAgICAgICByYW5nZS5zdGFydENvbnRhaW5lciA9IG5vZGU7XHJcbiAgICAgICAgICAgIHJhbmdlLnN0YXJ0T2Zmc2V0ID0gb2Zmc2V0O1xyXG4gICAgICAgICAgICBpZiAoIXJhbmdlLmVuZENvbnRhaW5lcikge1xyXG4gICAgICAgICAgICAgICAgcmFuZ2UuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByYW5nZS5lbmRDb250YWluZXIgPSBub2RlO1xyXG4gICAgICAgICAgICByYW5nZS5lbmRPZmZzZXQgPSBvZmZzZXQ7XHJcbiAgICAgICAgICAgIGlmICghcmFuZ2Uuc3RhcnRDb250YWluZXIpIHtcclxuICAgICAgICAgICAgICAgIHJhbmdlLmNvbGxhcHNlKGZhbHNlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB1cGRhdGVDb2xsYXBzZShyYW5nZSk7XHJcbiAgICAgICAgcmV0dXJuIHJhbmdlO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGV4ZWNDb250ZW50c0FjdGlvbihyYW5nZSwgYWN0aW9uKSB7XHJcbiAgICAgICAgLy/osIPmlbTovrnnlYxcclxuICAgICAgICAvL3JhbmdlLmluY2x1ZGVCb29rbWFyaygpO1xyXG4gICAgICAgIHZhciBzdGFydCA9IHJhbmdlLnN0YXJ0Q29udGFpbmVyLFxyXG4gICAgICAgICAgICBlbmQgPSByYW5nZS5lbmRDb250YWluZXIsXHJcbiAgICAgICAgICAgIHN0YXJ0T2Zmc2V0ID0gcmFuZ2Uuc3RhcnRPZmZzZXQsXHJcbiAgICAgICAgICAgIGVuZE9mZnNldCA9IHJhbmdlLmVuZE9mZnNldCxcclxuICAgICAgICAgICAgZG9jID0gcmFuZ2UuZG9jdW1lbnQsXHJcbiAgICAgICAgICAgIGZyYWcgPSBkb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLFxyXG4gICAgICAgICAgICB0bXBTdGFydCwgdG1wRW5kO1xyXG4gICAgICAgIGlmIChzdGFydC5ub2RlVHlwZSA9PSAxKSB7XHJcbiAgICAgICAgICAgIHN0YXJ0ID0gc3RhcnQuY2hpbGROb2Rlc1tzdGFydE9mZnNldF0gfHwgKHRtcFN0YXJ0ID0gc3RhcnQuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZVRleHROb2RlKCcnKSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZW5kLm5vZGVUeXBlID09IDEpIHtcclxuICAgICAgICAgICAgZW5kID0gZW5kLmNoaWxkTm9kZXNbZW5kT2Zmc2V0XSB8fCAodG1wRW5kID0gZW5kLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVUZXh0Tm9kZSgnJykpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHN0YXJ0ID09PSBlbmQgJiYgc3RhcnQubm9kZVR5cGUgPT0gMykge1xyXG4gICAgICAgICAgICBmcmFnLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVUZXh0Tm9kZShzdGFydC5zdWJzdHJpbmdEYXRhKHN0YXJ0T2Zmc2V0LCBlbmRPZmZzZXQgLSBzdGFydE9mZnNldCkpKTtcclxuICAgICAgICAgICAgLy9pcyBub3QgY2xvbmVcclxuICAgICAgICAgICAgaWYgKGFjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgc3RhcnQuZGVsZXRlRGF0YShzdGFydE9mZnNldCwgZW5kT2Zmc2V0IC0gc3RhcnRPZmZzZXQpO1xyXG4gICAgICAgICAgICAgICAgcmFuZ2UuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGZyYWc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBjdXJyZW50LCBjdXJyZW50TGV2ZWwsIGNsb25lID0gZnJhZyxcclxuICAgICAgICAgICAgc3RhcnRQYXJlbnRzID0gZG9tVXRpbHMuZmluZFBhcmVudHMoc3RhcnQsIHRydWUpLCBlbmRQYXJlbnRzID0gZG9tVXRpbHMuZmluZFBhcmVudHMoZW5kLCB0cnVlKTtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgc3RhcnRQYXJlbnRzW2ldID09IGVuZFBhcmVudHNbaV07KSB7XHJcbiAgICAgICAgICAgIGkrKztcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yICh2YXIgaiA9IGksIHNpOyBzaSA9IHN0YXJ0UGFyZW50c1tqXTsgaisrKSB7XHJcbiAgICAgICAgICAgIGN1cnJlbnQgPSBzaS5uZXh0U2libGluZztcclxuICAgICAgICAgICAgaWYgKHNpID09IHN0YXJ0KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRtcFN0YXJ0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJhbmdlLnN0YXJ0Q29udGFpbmVyLm5vZGVUeXBlID09IDMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xvbmUuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZVRleHROb2RlKHN0YXJ0Lm5vZGVWYWx1ZS5zbGljZShzdGFydE9mZnNldCkpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy9pcyBub3QgY2xvbmVcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQuZGVsZXRlRGF0YShzdGFydE9mZnNldCwgc3RhcnQubm9kZVZhbHVlLmxlbmd0aCAtIHN0YXJ0T2Zmc2V0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsb25lLmFwcGVuZENoaWxkKCFhY3Rpb24gPyBzdGFydC5jbG9uZU5vZGUodHJ1ZSkgOiBzdGFydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY3VycmVudExldmVsID0gc2kuY2xvbmVOb2RlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIGNsb25lLmFwcGVuZENoaWxkKGN1cnJlbnRMZXZlbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQpIHtcclxuICAgICAgICAgICAgICAgIGlmIChjdXJyZW50ID09PSBlbmQgfHwgY3VycmVudCA9PT0gZW5kUGFyZW50c1tqXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgc2kgPSBjdXJyZW50Lm5leHRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgY2xvbmUuYXBwZW5kQ2hpbGQoIWFjdGlvbiA/IGN1cnJlbnQuY2xvbmVOb2RlKHRydWUpIDogY3VycmVudCk7XHJcbiAgICAgICAgICAgICAgICBjdXJyZW50ID0gc2k7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2xvbmUgPSBjdXJyZW50TGV2ZWw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNsb25lID0gZnJhZztcclxuICAgICAgICBpZiAoIXN0YXJ0UGFyZW50c1tpXSkge1xyXG4gICAgICAgICAgICBjbG9uZS5hcHBlbmRDaGlsZChzdGFydFBhcmVudHNbaSAtIDFdLmNsb25lTm9kZShmYWxzZSkpO1xyXG4gICAgICAgICAgICBjbG9uZSA9IGNsb25lLmZpcnN0Q2hpbGQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAodmFyIGogPSBpLCBlaTsgZWkgPSBlbmRQYXJlbnRzW2pdOyBqKyspIHtcclxuICAgICAgICAgICAgY3VycmVudCA9IGVpLnByZXZpb3VzU2libGluZztcclxuICAgICAgICAgICAgaWYgKGVpID09IGVuZCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0bXBFbmQgJiYgcmFuZ2UuZW5kQ29udGFpbmVyLm5vZGVUeXBlID09IDMpIHtcclxuICAgICAgICAgICAgICAgICAgICBjbG9uZS5hcHBlbmRDaGlsZChkb2MuY3JlYXRlVGV4dE5vZGUoZW5kLnN1YnN0cmluZ0RhdGEoMCwgZW5kT2Zmc2V0KSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vaXMgbm90IGNsb25lXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmQuZGVsZXRlRGF0YSgwLCBlbmRPZmZzZXQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGN1cnJlbnRMZXZlbCA9IGVpLmNsb25lTm9kZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICBjbG9uZS5hcHBlbmRDaGlsZChjdXJyZW50TGV2ZWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8v5aaC5p6c5Lik56uv5ZCM57qn77yM5Y+z6L6556ys5LiA5qyh5bey57uP6KKr5byA5aeL5YGa5LqGXHJcbiAgICAgICAgICAgIGlmIChqICE9IGkgfHwgIXN0YXJ0UGFyZW50c1tpXSkge1xyXG4gICAgICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCA9PT0gc3RhcnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVpID0gY3VycmVudC5wcmV2aW91c1NpYmxpbmc7XHJcbiAgICAgICAgICAgICAgICAgICAgY2xvbmUuaW5zZXJ0QmVmb3JlKCFhY3Rpb24gPyBjdXJyZW50LmNsb25lTm9kZSh0cnVlKSA6IGN1cnJlbnQsIGNsb25lLmZpcnN0Q2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBlaTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjbG9uZSA9IGN1cnJlbnRMZXZlbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGFjdGlvbikge1xyXG4gICAgICAgICAgICByYW5nZS5zZXRTdGFydEJlZm9yZSghZW5kUGFyZW50c1tpXSA/IGVuZFBhcmVudHNbaSAtIDFdIDogIXN0YXJ0UGFyZW50c1tpXSA/IHN0YXJ0UGFyZW50c1tpIC0gMV0gOiBlbmRQYXJlbnRzW2ldKS5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdG1wU3RhcnQgJiYgZG9tVXRpbHMucmVtb3ZlKHRtcFN0YXJ0KTtcclxuICAgICAgICB0bXBFbmQgJiYgZG9tVXRpbHMucmVtb3ZlKHRtcEVuZCk7XHJcbiAgICAgICAgcmV0dXJuIGZyYWc7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDliJvlu7rkuIDkuKrot59kb2N1bWVudOe7keWumueahOepuueahFJhbmdl5a6e5L6LXHJcbiAgICAgKiBAY29uc3RydWN0b3JcclxuICAgICAqIEBwYXJhbSB7IERvY3VtZW50IH0gZG9jdW1lbnQg5paw5bu655qE6YCJ5Yy65omA5bGe55qE5paH5qGj5a+56LGhXHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBwcm9wZXJ0eSB7IE5vZGUgfSBzdGFydENvbnRhaW5lciDlvZPliY1SYW5nZeeahOW8gOWni+i+ueeVjOeahOWuueWZqOiKgueCuSwg5Y+v5Lul5piv5LiA5Liq5YWD57Sg6IqC54K55oiW6ICF5piv5paH5pys6IqC54K5XHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBwcm9wZXJ0eSB7IE5vZGUgfSBzdGFydE9mZnNldCDlvZPliY1SYW5nZeeahOW8gOWni+i+ueeVjOWuueWZqOiKgueCueeahOWBj+enu+mHjywg5aaC5p6c5piv5YWD57Sg6IqC54K577yMXHJcbiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIOivpeWAvOWwseaYr2NoaWxkTm9kZXPkuK3nmoTnrKzlh6DkuKroioLngrnvvIwg5aaC5p6c5piv5paH5pys6IqC54K55bCx5piv5paH5pys5YaF5a6555qE56ys5Yeg5Liq5a2X56ymXHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBwcm9wZXJ0eSB7IE5vZGUgfSBlbmRDb250YWluZXIg5b2T5YmNUmFuZ2XnmoTnu5PmnZ/ovrnnlYznmoTlrrnlmajoioLngrksIOWPr+S7peaYr+S4gOS4quWFg+e0oOiKgueCueaIluiAheaYr+aWh+acrOiKgueCuVxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAcHJvcGVydHkgeyBOb2RlIH0gZW5kT2Zmc2V0IOW9k+WJjVJhbmdl55qE57uT5p2f6L6555WM5a655Zmo6IqC54K555qE5YGP56e76YePLCDlpoLmnpzmmK/lhYPntKDoioLngrnvvIxcclxuICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg6K+l5YC85bCx5pivY2hpbGROb2Rlc+S4reeahOesrOWHoOS4quiKgueCue+8jCDlpoLmnpzmmK/mlofmnKzoioLngrnlsLHmmK/mlofmnKzlhoXlrrnnmoTnrKzlh6DkuKrlrZfnrKZcclxuICAgICAqL1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogQHByb3BlcnR5IHsgQm9vbGVhbiB9IGNvbGxhcHNlZCDlvZPliY1SYW5nZeaYr+WQpumXreWQiFxyXG4gICAgICogQGRlZmF1bHQgdHJ1ZVxyXG4gICAgICogQHJlbWluZCBSYW5nZeaYr+mXreWQiOeahOaXtuWAme+8jCBzdGFydENvbnRhaW5lciA9PT0gZW5kQ29udGFpbmVyICYmIHN0YXJ0T2Zmc2V0ID09PSBlbmRPZmZzZXRcclxuICAgICAqL1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogQHByb3BlcnR5IHsgRG9jdW1lbnQgfSBkb2N1bWVudCDlvZPliY1SYW5nZeaJgOWxnueahERvY3VtZW505a+56LGhXHJcbiAgICAgKiBAcmVtaW5kIOS4jeWQjHJhbmdl55qE55qEZG9jdW1lbnTlsZ7mgKflj6/ku6XmmK/kuI3lkIznmoRcclxuICAgICAqL1xyXG4gICAgdmFyIFJhbmdlID0gZG9tLlJhbmdlID0gZnVuY3Rpb24gKGRvY3VtZW50KSB7XHJcbiAgICAgICAgdmFyIG1lID0gdGhpcztcclxuICAgICAgICBtZS5zdGFydENvbnRhaW5lciA9XHJcbiAgICAgICAgICAgIG1lLnN0YXJ0T2Zmc2V0ID1cclxuICAgICAgICAgICAgICAgIG1lLmVuZENvbnRhaW5lciA9XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuZW5kT2Zmc2V0ID0gbnVsbDtcclxuICAgICAgICBtZS5kb2N1bWVudCA9IGRvY3VtZW50O1xyXG4gICAgICAgIG1lLmNvbGxhcHNlZCA9IHRydWU7XHJcbiAgICB9O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yig6ZmkZmlsbERhdGFcclxuICAgICAqIEBwYXJhbSBkb2NcclxuICAgICAqIEBwYXJhbSBleGNsdWRlTm9kZVxyXG4gICAgICovXHJcbiAgICBmdW5jdGlvbiByZW1vdmVGaWxsRGF0YShkb2MsIGV4Y2x1ZGVOb2RlKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgaWYgKGZpbGxEYXRhICYmIGRvbVV0aWxzLmluRG9jKGZpbGxEYXRhLCBkb2MpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWZpbGxEYXRhLm5vZGVWYWx1ZS5yZXBsYWNlKGZpbGxDaGFyUmVnLCAnJykubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRtcE5vZGUgPSBmaWxsRGF0YS5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShmaWxsRGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHRtcE5vZGUgJiYgZG9tVXRpbHMuaXNFbXB0eUlubGluZUVsZW1lbnQodG1wTm9kZSkgJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy9zYWZhcmnnmoRjb250YWluc+aciWJ1Z1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAoYnJvd3Nlci5zYWZhcmkgPyAhKGRvbVV0aWxzLmdldFBvc2l0aW9uKHRtcE5vZGUsZXhjbHVkZU5vZGUpICYgZG9tVXRpbHMuUE9TSVRJT05fQ09OVEFJTlMpIDogIXRtcE5vZGUuY29udGFpbnMoZXhjbHVkZU5vZGUpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmlsbERhdGEgPSB0bXBOb2RlLnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZSh0bXBOb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG1wTm9kZSA9IGZpbGxEYXRhO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmlsbERhdGEubm9kZVZhbHVlID0gZmlsbERhdGEubm9kZVZhbHVlLnJlcGxhY2UoZmlsbENoYXJSZWcsICcnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAcGFyYW0gbm9kZVxyXG4gICAgICogQHBhcmFtIGRpclxyXG4gICAgICovXHJcbiAgICBmdW5jdGlvbiBtZXJnZVNpYmxpbmcobm9kZSwgZGlyKSB7XHJcbiAgICAgICAgdmFyIHRtcE5vZGU7XHJcbiAgICAgICAgbm9kZSA9IG5vZGVbZGlyXTtcclxuICAgICAgICB3aGlsZSAobm9kZSAmJiBkb21VdGlscy5pc0ZpbGxDaGFyKG5vZGUpKSB7XHJcbiAgICAgICAgICAgIHRtcE5vZGUgPSBub2RlW2Rpcl07XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShub2RlKTtcclxuICAgICAgICAgICAgbm9kZSA9IHRtcE5vZGU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIFJhbmdlLnByb3RvdHlwZSA9IHtcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5YWL6ZqG6YCJ5Yy655qE5YaF5a655Yiw5LiA5LiqRG9jdW1lbnRGcmFnbWVudOmHjFxyXG4gICAgICAgICAqIEBtZXRob2QgY2xvbmVDb250ZW50c1xyXG4gICAgICAgICAqIEByZXR1cm4geyBEb2N1bWVudEZyYWdtZW50IHwgTlVMTCB9IOWmguaenOmAieWMuuaYr+mXreWQiOeahOWwhui/lOWbnm51bGzvvIwg5ZCm5YiZ77yMIOi/lOWbnuWMheWQq+aJgGNsb25l5YaF5a6555qERG9jdW1lbnRGcmFnbWVudOWFg+e0oFxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgaHRtbFxyXG4gICAgICAgICAqIDxib2R5PlxyXG4gICAgICAgICAqICAgICAgPCEtLSDkuK3mi6zlj7fooajnpLrpgInljLogLS0+XHJcbiAgICAgICAgICogICAgICA8Yj54PGk+eFt4PC9pPnh4XXg8L2I+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgIDxzY3JpcHQ+XHJcbiAgICAgICAgICogICAgICAgICAgLy9yYW5nZeaYr+W3sumAieS4reeahOmAieWMulxyXG4gICAgICAgICAqICAgICAgICAgIHZhciBmcmFnbWVudCA9IHJhbmdlLmNsb25lQ29udGVudHMoKSxcclxuICAgICAgICAgKiAgICAgICAgICAgICAgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgICAgICBub2RlLmFwcGVuZENoaWxkKCBmcmFnbWVudCApO1xyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgICAgICAgLy9vdXRwdXQ6IDxpPng8L2k+eHhcclxuICAgICAgICAgKiAgICAgICAgICBjb25zb2xlLmxvZyggbm9kZS5pbm5lckhUTUwgKTtcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAgPC9zY3JpcHQ+XHJcbiAgICAgICAgICogPC9ib2R5PlxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGNsb25lQ29udGVudHM6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb2xsYXBzZWQgPyBudWxsIDogZXhlY0NvbnRlbnRzQWN0aW9uKHRoaXMsIDApO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOWIoOmZpOW9k+WJjemAieWMuuiMg+WbtOS4reeahOaJgOacieWGheWuuVxyXG4gICAgICAgICAqIEBtZXRob2QgZGVsZXRlQ29udGVudHNcclxuICAgICAgICAgKiBAcmVtaW5kIOaJp+ihjOWujOivpeaTjeS9nOWQju+8jCDlvZPliY1SYW5nZeWvueixoeWPmOaIkOS6humXreWQiOeKtuaAgVxyXG4gICAgICAgICAqIEByZXR1cm4geyBVRS5kb20uUmFuZ2UgfSDlvZPliY3mk43kvZznmoRSYW5nZeWvueixoVxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgaHRtbFxyXG4gICAgICAgICAqIDxib2R5PlxyXG4gICAgICAgICAqICAgICAgPCEtLSDkuK3mi6zlj7fooajnpLrpgInljLogLS0+XHJcbiAgICAgICAgICogICAgICA8Yj54PGk+eFt4PC9pPnh4XXg8L2I+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgIDxzY3JpcHQ+XHJcbiAgICAgICAgICogICAgICAgICAgLy9yYW5nZeaYr+W3sumAieS4reeahOmAieWMulxyXG4gICAgICAgICAqICAgICAgICAgIHJhbmdlLmRlbGV0ZUNvbnRlbnRzKCk7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgICAgICAvL+erlue6v+ihqOekuumXreWQiOWQjueahOmAieWMuuS9jee9rlxyXG4gICAgICAgICAqICAgICAgICAgIC8vb3V0cHV0OiA8Yj54PGk+eDwvaT58eDwvYj5cclxuICAgICAgICAgKiAgICAgICAgICBjb25zb2xlLmxvZyggZG9jdW1lbnQuYm9keS5pbm5lckhUTUwgKTtcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAgICAgIC8v5q2k5pe277yMIHJhbmdl55qE5ZCE6aG55bGe5oCn5Li6XHJcbiAgICAgICAgICogICAgICAgICAgLy9vdXRwdXQ6IEJcclxuICAgICAgICAgKiAgICAgICAgICBjb25zb2xlLmxvZyggcmFuZ2Uuc3RhcnRDb250YWluZXIudGFnTmFtZSApO1xyXG4gICAgICAgICAqICAgICAgICAgIC8vb3V0cHV0OiAyXHJcbiAgICAgICAgICogICAgICAgICAgY29uc29sZS5sb2coIHJhbmdlLnN0YXJ0T2Zmc2V0ICk7XHJcbiAgICAgICAgICogICAgICAgICAgLy9vdXRwdXQ6IEJcclxuICAgICAgICAgKiAgICAgICAgICBjb25zb2xlLmxvZyggcmFuZ2UuZW5kQ29udGFpbmVyLnRhZ05hbWUgKTtcclxuICAgICAgICAgKiAgICAgICAgICAvL291dHB1dDogMlxyXG4gICAgICAgICAqICAgICAgICAgIGNvbnNvbGUubG9nKCByYW5nZS5lbmRPZmZzZXQgKTtcclxuICAgICAgICAgKiAgICAgICAgICAvL291dHB1dDogdHJ1ZVxyXG4gICAgICAgICAqICAgICAgICAgIGNvbnNvbGUubG9nKCByYW5nZS5jb2xsYXBzZWQgKTtcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAgPC9zY3JpcHQ+XHJcbiAgICAgICAgICogPC9ib2R5PlxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGRlbGV0ZUNvbnRlbnRzOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHR4dDtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmNvbGxhcHNlZCkge1xyXG4gICAgICAgICAgICAgICAgZXhlY0NvbnRlbnRzQWN0aW9uKHRoaXMsIDEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChicm93c2VyLndlYmtpdCkge1xyXG4gICAgICAgICAgICAgICAgdHh0ID0gdGhpcy5zdGFydENvbnRhaW5lcjtcclxuICAgICAgICAgICAgICAgIGlmICh0eHQubm9kZVR5cGUgPT0gMyAmJiAhdHh0Lm5vZGVWYWx1ZS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXJ0QmVmb3JlKHR4dCkuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHR4dCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5bCG5b2T5YmN6YCJ5Yy655qE5YaF5a655o+Q5Y+W5Yiw5LiA5LiqRG9jdW1lbnRGcmFnbWVudOmHjFxyXG4gICAgICAgICAqIEBtZXRob2QgZXh0cmFjdENvbnRlbnRzXHJcbiAgICAgICAgICogQHJlbWluZCDmiafooYzor6Xmk43kvZzlkI7vvIwg6YCJ5Yy65bCG5Y+Y5oiQ6Zet5ZCI54q25oCBXHJcbiAgICAgICAgICogQHdhcm5pbmcg5omn6KGM6K+l5pON5L2c5ZCO77yMIOWOn+adpemAieWMuuaJgOmAieS4reeahOWGheWuueWwhuS7jmRvbeagkeS4iuWJpeemu+WHuuadpVxyXG4gICAgICAgICAqIEByZXR1cm4geyBEb2N1bWVudEZyYWdtZW50IH0g6L+U5Zue5YyF5ZCr5omA5o+Q5Y+W5YaF5a6555qERG9jdW1lbnRGcmFnbWVudOWvueixoVxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgaHRtbFxyXG4gICAgICAgICAqIDxib2R5PlxyXG4gICAgICAgICAqICAgICAgPCEtLSDkuK3mi6zlj7fooajnpLrpgInljLogLS0+XHJcbiAgICAgICAgICogICAgICA8Yj54PGk+eFt4PC9pPnh4XXg8L2I+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgIDxzY3JpcHQ+XHJcbiAgICAgICAgICogICAgICAgICAgLy9yYW5nZeaYr+W3sumAieS4reeahOmAieWMulxyXG4gICAgICAgICAqICAgICAgICAgIHZhciBmcmFnbWVudCA9IHJhbmdlLmV4dHJhY3RDb250ZW50cygpLFxyXG4gICAgICAgICAqICAgICAgICAgICAgICBub2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggXCJkaXZcIiApO1xyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZCggZnJhZ21lbnQgKTtcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAgICAgIC8v56uW57q/6KGo56S66Zet5ZCI5ZCO55qE6YCJ5Yy65L2N572uXHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgICAgICAvL291dHB1dDogPGI+eDxpPng8L2k+fHg8L2I+XHJcbiAgICAgICAgICogICAgICAgICAgY29uc29sZS5sb2coIGRvY3VtZW50LmJvZHkuaW5uZXJIVE1MICk7XHJcbiAgICAgICAgICogICAgICAgICAgLy9vdXRwdXQ6IDxpPng8L2k+eHhcclxuICAgICAgICAgKiAgICAgICAgICBjb25zb2xlLmxvZyggbm9kZS5pbm5lckhUTUwgKTtcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAgICAgIC8v5q2k5pe277yMIHJhbmdl55qE5ZCE6aG55bGe5oCn5Li6XHJcbiAgICAgICAgICogICAgICAgICAgLy9vdXRwdXQ6IEJcclxuICAgICAgICAgKiAgICAgICAgICBjb25zb2xlLmxvZyggcmFuZ2Uuc3RhcnRDb250YWluZXIudGFnTmFtZSApO1xyXG4gICAgICAgICAqICAgICAgICAgIC8vb3V0cHV0OiAyXHJcbiAgICAgICAgICogICAgICAgICAgY29uc29sZS5sb2coIHJhbmdlLnN0YXJ0T2Zmc2V0ICk7XHJcbiAgICAgICAgICogICAgICAgICAgLy9vdXRwdXQ6IEJcclxuICAgICAgICAgKiAgICAgICAgICBjb25zb2xlLmxvZyggcmFuZ2UuZW5kQ29udGFpbmVyLnRhZ05hbWUgKTtcclxuICAgICAgICAgKiAgICAgICAgICAvL291dHB1dDogMlxyXG4gICAgICAgICAqICAgICAgICAgIGNvbnNvbGUubG9nKCByYW5nZS5lbmRPZmZzZXQgKTtcclxuICAgICAgICAgKiAgICAgICAgICAvL291dHB1dDogdHJ1ZVxyXG4gICAgICAgICAqICAgICAgICAgIGNvbnNvbGUubG9nKCByYW5nZS5jb2xsYXBzZWQgKTtcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAgPC9zY3JpcHQ+XHJcbiAgICAgICAgICogPC9ib2R5PlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGV4dHJhY3RDb250ZW50czpmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbGxhcHNlZCA/IG51bGwgOiBleGVjQ29udGVudHNBY3Rpb24odGhpcywgMik7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6K6+572uUmFuZ2XnmoTlvIDlp4vlrrnlmajoioLngrnlkozlgY/np7vph49cclxuICAgICAgICAgKiBAbWV0aG9kICBzZXRTdGFydFxyXG4gICAgICAgICAqIEByZW1pbmQg5aaC5p6c57uZ5a6a55qE6IqC54K55piv5YWD57Sg6IqC54K577yM6YKj5LmIb2Zmc2V05oyH55qE5piv5YW25a2Q5YWD57Sg5Lit57Si5byV5Li6b2Zmc2V055qE5YWD57Sg77yMXHJcbiAgICAgICAgICogICAgICAgICAg5aaC5p6c5piv5paH5pys6IqC54K577yM6YKj5LmIb2Zmc2V05oyH55qE5piv5YW25paH5pys5YaF5a6555qE56ysb2Zmc2V05Liq5a2X56ymXHJcbiAgICAgICAgICogQHJlbWluZCDlpoLmnpzmj5DkvpvnmoTlrrnlmajoioLngrnmmK/kuIDkuKrkuI3og73ljIXlkKvlrZDlhYPntKDnmoToioLngrnvvIwg5YiZ6K+l6YCJ5Yy655qE5byA5aeL5a655Zmo5bCG6KKr6K6+572uXHJcbiAgICAgICAgICogICAgICAgICAg5Li66K+l6IqC54K555qE54i26IqC54K577yMIOatpOaXtu+8jCDlhbbot53nprvlvIDlp4vlrrnlmajnmoTlgY/np7vph4/kuZ/lj5jmiJDkuobor6XoioLngrnlnKjlhbbniLboioLngrlcclxuICAgICAgICAgKiAgICAgICAgICDkuK3nmoTntKLlvJVcclxuICAgICAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZSDlsIbooqvorr7kuLrlvZPliY3pgInljLrlvIDlp4vovrnnlYzlrrnlmajnmoToioLngrnlr7nosaFcclxuICAgICAgICAgKiBAcGFyYW0geyBpbnQgfSBvZmZzZXQg6YCJ5Yy655qE5byA5aeL5L2N572u5YGP56e76YePXHJcbiAgICAgICAgICogQHJldHVybiB7IFVFLmRvbS5SYW5nZSB9IOW9k+WJjXJhbmdl5a+56LGhXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBodG1sXHJcbiAgICAgICAgICogPCEtLSDpgInljLogLS0+XHJcbiAgICAgICAgICogPGI+eHh4PGk+eDxzcGFuPnh4PC9zcGFuPnh4PGVtPnh4PC9lbT54eHg8L2k+W3h4eF08L2I+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8c2NyaXB0PlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIC8v5omn6KGM5pON5L2cXHJcbiAgICAgICAgICogICAgIHJhbmdlLnNldFN0YXJ0KCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImlcIilbMF0sIDEgKTtcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAvL+atpOaXtu+8jCDpgInljLrlj5jmiJDkuoZcclxuICAgICAgICAgKiAgICAgLy88Yj54eHg8aT54WzxzcGFuPnh4PC9zcGFuPnh4PGVtPnh4PC9lbT54eHg8L2k+eHh4XTwvYj5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgaHRtbFxyXG4gICAgICAgICAqIDwhLS0g6YCJ5Yy6IC0tPlxyXG4gICAgICAgICAqIDxiPnh4eDxpbWc+W3h4XXg8L2I+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8c2NyaXB0PlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIC8v5omn6KGM5pON5L2cXHJcbiAgICAgICAgICogICAgIHJhbmdlLnNldFN0YXJ0KCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImltZ1wiKVswXSwgMyApO1xyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIC8v5q2k5pe277yMIOmAieWMuuWPmOaIkOS6hlxyXG4gICAgICAgICAqICAgICAvLzxiPnh4eFs8aW1nPnh4XXg8L2I+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8L3NjcmlwdD5cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICBzZXRTdGFydDpmdW5jdGlvbiAobm9kZSwgb2Zmc2V0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBzZXRFbmRQb2ludCh0cnVlLCBub2RlLCBvZmZzZXQsIHRoaXMpO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOiuvue9rlJhbmdl55qE57uT5p2f5a655Zmo5ZKM5YGP56e76YePXHJcbiAgICAgICAgICogQG1ldGhvZCAgc2V0RW5kXHJcbiAgICAgICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg5L2c5Li65b2T5YmN6YCJ5Yy657uT5p2f6L6555WM5a655Zmo55qE6IqC54K55a+56LGhXHJcbiAgICAgICAgICogQHBhcmFtIHsgaW50IH0gb2Zmc2V0IOe7k+adn+i+ueeVjOeahOWBj+enu+mHj1xyXG4gICAgICAgICAqIEBzZWUgVUUuZG9tLlJhbmdlOnNldFN0YXJ0KE5vZGUsaW50KVxyXG4gICAgICAgICAqIEByZXR1cm4geyBVRS5kb20uUmFuZ2UgfSDlvZPliY1yYW5nZeWvueixoVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHNldEVuZDpmdW5jdGlvbiAobm9kZSwgb2Zmc2V0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBzZXRFbmRQb2ludChmYWxzZSwgbm9kZSwgb2Zmc2V0LCB0aGlzKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDlsIZSYW5nZeW8gOWni+S9jee9ruiuvue9ruWIsG5vZGXoioLngrnkuYvlkI5cclxuICAgICAgICAgKiBAbWV0aG9kICBzZXRTdGFydEFmdGVyXHJcbiAgICAgICAgICogQHJlbWluZCDor6Xmk43kvZzlsIbkvJrmiornu5nlrproioLngrnnmoTniLboioLngrnkvZzkuLpyYW5nZeeahOW8gOWni+WuueWZqO+8jCDkuJTlgY/np7vph4/mmK/or6XoioLngrnlnKjlhbbniLboioLngrnkuK3nmoTkvY3nva7ntKLlvJUrMVxyXG4gICAgICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOmAieWMuueahOW8gOWni+i+ueeVjOWwhue0p+aOpeedgOivpeiKgueCueS5i+WQjlxyXG4gICAgICAgICAqIEByZXR1cm4geyBVRS5kb20uUmFuZ2UgfSDlvZPliY1yYW5nZeWvueixoVxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgaHRtbFxyXG4gICAgICAgICAqIDwhLS0g6YCJ5Yy656S65L6LIC0tPlxyXG4gICAgICAgICAqIDxiPnh4PGk+eHh4PC9pPjxzcGFuPnh4W3g8L3NwYW4+eHh4XTwvYj5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy/miafooYzmk43kvZxcclxuICAgICAgICAgKiAgICAgcmFuZ2Uuc2V0U3RhcnRBZnRlciggZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJpXCIpWzBdICk7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy/nu5PmnpzpgInljLpcclxuICAgICAgICAgKiAgICAgLy88Yj54eDxpPnh4eDwvaT5bPHNwYW4+eHh4PC9zcGFuPnh4eF08L2I+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8L3NjcmlwdD5cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICBzZXRTdGFydEFmdGVyOmZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldFN0YXJ0KG5vZGUucGFyZW50Tm9kZSwgZG9tVXRpbHMuZ2V0Tm9kZUluZGV4KG5vZGUpICsgMSk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5bCGUmFuZ2XlvIDlp4vkvY3nva7orr7nva7liLBub2Rl6IqC54K55LmL5YmNXHJcbiAgICAgICAgICogQG1ldGhvZCAgc2V0U3RhcnRCZWZvcmVcclxuICAgICAgICAgKiBAcmVtaW5kIOivpeaTjeS9nOWwhuS8muaKiue7meWumuiKgueCueeahOeItuiKgueCueS9nOS4unJhbmdl55qE5byA5aeL5a655Zmo77yMIOS4lOWBj+enu+mHj+aYr+ivpeiKgueCueWcqOWFtueItuiKgueCueS4reeahOS9jee9rue0ouW8lVxyXG4gICAgICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOaWsOeahOmAieWMuuW8gOWni+S9jee9ruWcqOivpeiKgueCueS5i+WJjVxyXG4gICAgICAgICAqIEBzZWUgVUUuZG9tLlJhbmdlOnNldFN0YXJ0QWZ0ZXIoTm9kZSlcclxuICAgICAgICAgKiBAcmV0dXJuIHsgVUUuZG9tLlJhbmdlIH0g5b2T5YmNcmFuZ2Xlr7nosaFcclxuICAgICAgICAgKi9cclxuICAgICAgICBzZXRTdGFydEJlZm9yZTpmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXRTdGFydChub2RlLnBhcmVudE5vZGUsIGRvbVV0aWxzLmdldE5vZGVJbmRleChub2RlKSk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5bCGUmFuZ2Xnu5PmnZ/kvY3nva7orr7nva7liLBub2Rl6IqC54K55LmL5ZCOXHJcbiAgICAgICAgICogQG1ldGhvZCAgc2V0RW5kQWZ0ZXJcclxuICAgICAgICAgKiBAcmVtaW5kIOivpeaTjeS9nOWwhuS8muaKiue7meWumuiKgueCueeahOeItuiKgueCueS9nOS4unJhbmdl55qE57uT5p2f5a655Zmo77yMIOS4lOWBj+enu+mHj+aYr+ivpeiKgueCueWcqOWFtueItuiKgueCueS4reeahOS9jee9rue0ouW8lSsxXHJcbiAgICAgICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg55uu5qCH6IqC54K5XHJcbiAgICAgICAgICogQHNlZSBVRS5kb20uUmFuZ2U6c2V0U3RhcnRBZnRlcihOb2RlKVxyXG4gICAgICAgICAqIEByZXR1cm4geyBVRS5kb20uUmFuZ2UgfSDlvZPliY1yYW5nZeWvueixoVxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgaHRtbFxyXG4gICAgICAgICAqIDwhLS0g6YCJ5Yy656S65L6LIC0tPlxyXG4gICAgICAgICAqIDxiPlt4eDxpPnh4eDwvaT48c3Bhbj54eF14PC9zcGFuPnh4eDwvYj5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy/miafooYzmk43kvZxcclxuICAgICAgICAgKiAgICAgcmFuZ2Uuc2V0U3RhcnRBZnRlciggZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJzcGFuXCIpWzBdICk7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy/nu5PmnpzpgInljLpcclxuICAgICAgICAgKiAgICAgLy88Yj5beHg8aT54eHg8L2k+PHNwYW4+eHh4PC9zcGFuPl14eHg8L2I+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8L3NjcmlwdD5cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICBzZXRFbmRBZnRlcjpmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXRFbmQobm9kZS5wYXJlbnROb2RlLCBkb21VdGlscy5nZXROb2RlSW5kZXgobm9kZSkgKyAxKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDlsIZSYW5nZee7k+adn+S9jee9ruiuvue9ruWIsG5vZGXoioLngrnkuYvliY1cclxuICAgICAgICAgKiBAbWV0aG9kICBzZXRFbmRCZWZvcmVcclxuICAgICAgICAgKiBAcmVtaW5kIOivpeaTjeS9nOWwhuS8muaKiue7meWumuiKgueCueeahOeItuiKgueCueS9nOS4unJhbmdl55qE57uT5p2f5a655Zmo77yMIOS4lOWBj+enu+mHj+aYr+ivpeiKgueCueWcqOWFtueItuiKgueCueS4reeahOS9jee9rue0ouW8lVxyXG4gICAgICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOebruagh+iKgueCuVxyXG4gICAgICAgICAqIEBzZWUgVUUuZG9tLlJhbmdlOnNldEVuZEFmdGVyKE5vZGUpXHJcbiAgICAgICAgICogQHJldHVybiB7IFVFLmRvbS5SYW5nZSB9IOW9k+WJjXJhbmdl5a+56LGhXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgc2V0RW5kQmVmb3JlOmZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldEVuZChub2RlLnBhcmVudE5vZGUsIGRvbVV0aWxzLmdldE5vZGVJbmRleChub2RlKSk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6K6+572uUmFuZ2XnmoTlvIDlp4vkvY3nva7liLBub2Rl6IqC54K55YaF55qE56ys5LiA5Liq5a2Q6IqC54K55LmL5YmNXHJcbiAgICAgICAgICogQG1ldGhvZCAgc2V0U3RhcnRBdEZpcnN0XHJcbiAgICAgICAgICogQHJlbWluZCDpgInljLrnmoTlvIDlp4vlrrnlmajlsIblj5jmiJDnu5nlrprnmoToioLngrnvvIwg5LiU5YGP56e76YeP5Li6MFxyXG4gICAgICAgICAqIEByZW1pbmQg5aaC5p6c57uZ5a6a55qE6IqC54K55piv5YWD57Sg6IqC54K577yMIOWImeivpeiKgueCueW/hemhu+aYr+WFgeiuuOWMheWQq+WtkOiKgueCueeahOWFg+e0oOOAglxyXG4gICAgICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOebruagh+iKgueCuVxyXG4gICAgICAgICAqIEBzZWUgVUUuZG9tLlJhbmdlOnNldFN0YXJ0QmVmb3JlKE5vZGUpXHJcbiAgICAgICAgICogQHJldHVybiB7IFVFLmRvbS5SYW5nZSB9IOW9k+WJjXJhbmdl5a+56LGhXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBodG1sXHJcbiAgICAgICAgICogPCEtLSDpgInljLrnpLrkvosgLS0+XHJcbiAgICAgICAgICogPGI+eHg8aT54eHg8L2k+PHNwYW4+W3h4XXg8L3NwYW4+eHh4PC9iPlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogPHNjcmlwdD5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAvL+aJp+ihjOaTjeS9nFxyXG4gICAgICAgICAqICAgICByYW5nZS5zZXRTdGFydEF0Rmlyc3QoIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiaVwiKVswXSApO1xyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIC8v57uT5p6c6YCJ5Yy6XHJcbiAgICAgICAgICogICAgIC8vPGI+eHg8aT5beHh4PC9pPjxzcGFuPnh4XXg8L3NwYW4+eHh4PC9iPlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogPC9zY3JpcHQ+XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgc2V0U3RhcnRBdEZpcnN0OmZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldFN0YXJ0KG5vZGUsIDApO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOiuvue9rlJhbmdl55qE5byA5aeL5L2N572u5Yiwbm9kZeiKgueCueWGheeahOacgOWQjuS4gOS4quiKgueCueS5i+WQjlxyXG4gICAgICAgICAqIEBtZXRob2Qgc2V0U3RhcnRBdExhc3RcclxuICAgICAgICAgKiBAcmVtaW5kIOmAieWMuueahOW8gOWni+WuueWZqOWwhuWPmOaIkOe7meWumueahOiKgueCue+8jCDkuJTlgY/np7vph4/kuLror6XoioLngrnnmoTlrZDoioLngrnmlbBcclxuICAgICAgICAgKiBAcmVtaW5kIOWmguaenOe7meWumueahOiKgueCueaYr+WFg+e0oOiKgueCue+8jCDliJnor6XoioLngrnlv4XpobvmmK/lhYHorrjljIXlkKvlrZDoioLngrnnmoTlhYPntKDjgIJcclxuICAgICAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZSDnm67moIfoioLngrlcclxuICAgICAgICAgKiBAc2VlIFVFLmRvbS5SYW5nZTpzZXRTdGFydEF0Rmlyc3QoTm9kZSlcclxuICAgICAgICAgKiBAcmV0dXJuIHsgVUUuZG9tLlJhbmdlIH0g5b2T5YmNcmFuZ2Xlr7nosaFcclxuICAgICAgICAgKi9cclxuICAgICAgICBzZXRTdGFydEF0TGFzdDpmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXRTdGFydChub2RlLCBub2RlLm5vZGVUeXBlID09IDMgPyBub2RlLm5vZGVWYWx1ZS5sZW5ndGggOiBub2RlLmNoaWxkTm9kZXMubGVuZ3RoKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDorr7nva5SYW5nZeeahOe7k+adn+S9jee9ruWIsG5vZGXoioLngrnlhoXnmoTnrKzkuIDkuKroioLngrnkuYvliY1cclxuICAgICAgICAgKiBAbWV0aG9kICBzZXRFbmRBdEZpcnN0XHJcbiAgICAgICAgICogQHBhcmFtIHsgTm9kZSB9IG5vZGUg55uu5qCH6IqC54K5XHJcbiAgICAgICAgICogQHJlbWluZCDpgInljLrnmoTnu5PmnZ/lrrnlmajlsIblj5jmiJDnu5nlrprnmoToioLngrnvvIwg5LiU5YGP56e76YeP5Li6MFxyXG4gICAgICAgICAqIEByZW1pbmQgbm9kZeW/hemhu+aYr+S4gOS4quWFg+e0oOiKgueCue+8jCDkuJTlv4XpobvmmK/lhYHorrjljIXlkKvlrZDoioLngrnnmoTlhYPntKDjgIJcclxuICAgICAgICAgKiBAc2VlIFVFLmRvbS5SYW5nZTpzZXRTdGFydEF0Rmlyc3QoTm9kZSlcclxuICAgICAgICAgKiBAcmV0dXJuIHsgVUUuZG9tLlJhbmdlIH0g5b2T5YmNcmFuZ2Xlr7nosaFcclxuICAgICAgICAgKi9cclxuICAgICAgICBzZXRFbmRBdEZpcnN0OmZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldEVuZChub2RlLCAwKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDorr7nva5SYW5nZeeahOe7k+adn+S9jee9ruWIsG5vZGXoioLngrnlhoXnmoTmnIDlkI7kuIDkuKroioLngrnkuYvlkI5cclxuICAgICAgICAgKiBAbWV0aG9kICBzZXRFbmRBdExhc3RcclxuICAgICAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZSDnm67moIfoioLngrlcclxuICAgICAgICAgKiBAcmVtaW5kIOmAieWMuueahOe7k+adn+WuueWZqOWwhuWPmOaIkOe7meWumueahOiKgueCue+8jCDkuJTlgY/np7vph4/kuLror6XoioLngrnnmoTlrZDoioLngrnmlbDph49cclxuICAgICAgICAgKiBAcmVtaW5kIG5vZGXlv4XpobvmmK/kuIDkuKrlhYPntKDoioLngrnvvIwg5LiU5b+F6aG75piv5YWB6K645YyF5ZCr5a2Q6IqC54K555qE5YWD57Sg44CCXHJcbiAgICAgICAgICogQHNlZSBVRS5kb20uUmFuZ2U6c2V0U3RhcnRBdEZpcnN0KE5vZGUpXHJcbiAgICAgICAgICogQHJldHVybiB7IFVFLmRvbS5SYW5nZSB9IOW9k+WJjXJhbmdl5a+56LGhXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgc2V0RW5kQXRMYXN0OmZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldEVuZChub2RlLCBub2RlLm5vZGVUeXBlID09IDMgPyBub2RlLm5vZGVWYWx1ZS5sZW5ndGggOiBub2RlLmNoaWxkTm9kZXMubGVuZ3RoKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDpgInkuK3nu5nlrproioLngrlcclxuICAgICAgICAgKiBAbWV0aG9kICBzZWxlY3ROb2RlXHJcbiAgICAgICAgICogQHJlbWluZCDmraTml7bvvIwg6YCJ5Yy655qE5byA5aeL5a655Zmo5ZKM57uT5p2f5a655Zmo6YO95piv6K+l6IqC54K555qE54i26IqC54K577yMIOWFtnN0YXJ0T2Zmc2V05piv6K+l6IqC54K55Zyo54i26IqC54K55Lit55qE5L2N572u57Si5byV77yMXHJcbiAgICAgICAgICogICAgICAgICAg6ICMZW5kT2Zmc2V05Li6c3RhcnRPZmZzZXQrMVxyXG4gICAgICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOmcgOimgemAieS4reeahOiKgueCuVxyXG4gICAgICAgICAqIEByZXR1cm4geyBVRS5kb20uUmFuZ2UgfSDlvZPliY1yYW5nZeWvueixoe+8jOatpOaXtueahHJhbmdl5LuF5YyF5ZCr5b2T5YmN57uZ5a6a55qE6IqC54K55a+56LGhXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBodG1sXHJcbiAgICAgICAgICogPCEtLSDpgInljLrnpLrkvosgLS0+XHJcbiAgICAgICAgICogPGI+eHg8aT54eHg8L2k+PHNwYW4+W3h4XXg8L3NwYW4+eHh4PC9iPlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogPHNjcmlwdD5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAvL+aJp+ihjOaTjeS9nFxyXG4gICAgICAgICAqICAgICByYW5nZS5zZWxlY3ROb2RlKCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImlcIilbMF0gKTtcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAvL+e7k+aenOmAieWMulxyXG4gICAgICAgICAqICAgICAvLzxiPnh4WzxpPnh4eDwvaT5dPHNwYW4+eHh4PC9zcGFuPnh4eDwvYj5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHNlbGVjdE5vZGU6ZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0U3RhcnRCZWZvcmUobm9kZSkuc2V0RW5kQWZ0ZXIobm9kZSk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6YCJ5Lit57uZ5a6a6IqC54K55YaF6YOo55qE5omA5pyJ6IqC54K5XHJcbiAgICAgICAgICogQG1ldGhvZCAgc2VsZWN0Tm9kZUNvbnRlbnRzXHJcbiAgICAgICAgICogQHJlbWluZCDmraTml7bvvIwg6YCJ5Yy655qE5byA5aeL5a655Zmo5ZKM57uT5p2f5a655Zmo6YO95piv6K+l6IqC54K577yMIOWFtnN0YXJ0T2Zmc2V05Li6MO+8jFxyXG4gICAgICAgICAqICAgICAgICAgIOiAjGVuZE9mZnNldOaYr+ivpeiKgueCueeahOWtkOiKgueCueaVsOOAglxyXG4gICAgICAgICAqIEBwYXJhbSB7IE5vZGUgfSBub2RlIOebruagh+iKgueCue+8jCDlvZPliY1yYW5nZeWwhuWMheWQq+ivpeiKgueCueWGheeahOaJgOacieiKgueCuVxyXG4gICAgICAgICAqIEByZXR1cm4geyBVRS5kb20uUmFuZ2UgfSDlvZPliY1yYW5nZeWvueixoe+8jCDmraTml7ZyYW5nZeS7heWMheWQq+e7meWumuiKgueCueeahOaJgOacieWtkOiKgueCuVxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgaHRtbFxyXG4gICAgICAgICAqIDwhLS0g6YCJ5Yy656S65L6LIC0tPlxyXG4gICAgICAgICAqIDxiPnh4PGk+eHh4PC9pPjxzcGFuPlt4eF14PC9zcGFuPnh4eDwvYj5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy/miafooYzmk43kvZxcclxuICAgICAgICAgKiAgICAgcmFuZ2Uuc2VsZWN0Tm9kZSggZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJiXCIpWzBdICk7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy/nu5PmnpzpgInljLpcclxuICAgICAgICAgKiAgICAgLy88Yj5beHg8aT54eHg8L2k+PHNwYW4+eHh4PC9zcGFuPnh4eF08L2I+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8L3NjcmlwdD5cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICBzZWxlY3ROb2RlQ29udGVudHM6ZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0U3RhcnQobm9kZSwgMCkuc2V0RW5kQXRMYXN0KG5vZGUpO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIGNsb25l5b2T5YmNUmFuZ2Xlr7nosaFcclxuICAgICAgICAgKiBAbWV0aG9kICBjbG9uZVJhbmdlXHJcbiAgICAgICAgICogQHJlbWluZCDov5Tlm57nmoRyYW5nZeaYr+S4gOS4quWFqOaWsOeahHJhbmdl5a+56LGh77yMIOWFtuWGhemDqOaJgOacieWxnuaAp+S4juW9k+WJjeiiq2Nsb25l55qEcmFuZ2Xnm7jlkIzjgIJcclxuICAgICAgICAgKiBAcmV0dXJuIHsgVUUuZG9tLlJhbmdlIH0g5b2T5YmNcmFuZ2Xlr7nosaHnmoTkuIDkuKrlia/mnKxcclxuICAgICAgICAgKi9cclxuICAgICAgICBjbG9uZVJhbmdlOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBSYW5nZShtZS5kb2N1bWVudCkuc2V0U3RhcnQobWUuc3RhcnRDb250YWluZXIsIG1lLnN0YXJ0T2Zmc2V0KS5zZXRFbmQobWUuZW5kQ29udGFpbmVyLCBtZS5lbmRPZmZzZXQpO1xyXG5cclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDlkJHlvZPliY3pgInljLrnmoTnu5PmnZ/lpITpl63lkIjpgInljLpcclxuICAgICAgICAgKiBAbWV0aG9kICBjb2xsYXBzZVxyXG4gICAgICAgICAqIEByZXR1cm4geyBVRS5kb20uUmFuZ2UgfSDlvZPliY1yYW5nZeWvueixoVxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgaHRtbFxyXG4gICAgICAgICAqIDwhLS0g6YCJ5Yy656S65L6LIC0tPlxyXG4gICAgICAgICAqIDxiPnh4PGk+eHh4PC9pPjxzcGFuPlt4eF14PC9zcGFuPnh4eDwvYj5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy/miafooYzmk43kvZxcclxuICAgICAgICAgKiAgICAgcmFuZ2UuY29sbGFwc2UoKTtcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAvL+e7k+aenOmAieWMulxyXG4gICAgICAgICAqICAgICAvL+KAnHzigJ3ooajnpLrpgInljLrlt7Lpl63lkIhcclxuICAgICAgICAgKiAgICAgLy88Yj54eDxpPnh4eDwvaT48c3Bhbj54eHx4PC9zcGFuPnh4eDwvYj5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDpl63lkIjlvZPliY3pgInljLrvvIzmoLnmja7nu5nlrprnmoR0b1N0YXJ05Y+C5pWw6aG55Yaz5a6a5piv5ZCR5b2T5YmN6YCJ5Yy65byA5aeL5aSE6Zet5ZCI6L+Y5piv5ZCR57uT5p2f5aSE6Zet5ZCI77yMXHJcbiAgICAgICAgICog5aaC5p6cdG9TdGFydOeahOWAvOS4unRydWXvvIzliJnlkJHlvIDlp4vkvY3nva7pl63lkIjvvIwg5Y+N5LmL77yM5ZCR57uT5p2f5L2N572u6Zet5ZCI44CCXHJcbiAgICAgICAgICogQG1ldGhvZCAgY29sbGFwc2VcclxuICAgICAgICAgKiBAcGFyYW0geyBCb29sZWFuIH0gdG9TdGFydCDmmK/lkKblkJHpgInljLrlvIDlp4vlpITpl63lkIhcclxuICAgICAgICAgKiBAcmV0dXJuIHsgVUUuZG9tLlJhbmdlIH0g5b2T5YmNcmFuZ2Xlr7nosaHvvIzmraTml7ZyYW5nZeWvueixoeWkhOS6jumXreWQiOeKtuaAgVxyXG4gICAgICAgICAqIEBzZWUgVUUuZG9tLlJhbmdlOmNvbGxhcHNlKClcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGh0bWxcclxuICAgICAgICAgKiA8IS0tIOmAieWMuuekuuS+iyAtLT5cclxuICAgICAgICAgKiA8Yj54eDxpPnh4eDwvaT48c3Bhbj5beHhdeDwvc3Bhbj54eHg8L2I+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8c2NyaXB0PlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIC8v5omn6KGM5pON5L2cXHJcbiAgICAgICAgICogICAgIHJhbmdlLmNvbGxhcHNlKCB0cnVlICk7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy/nu5PmnpzpgInljLpcclxuICAgICAgICAgKiAgICAgLy/igJx84oCd6KGo56S66YCJ5Yy65bey6Zet5ZCIXHJcbiAgICAgICAgICogICAgIC8vPGI+eHg8aT54eHg8L2k+PHNwYW4+fHh4eDwvc3Bhbj54eHg8L2I+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8L3NjcmlwdD5cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICBjb2xsYXBzZTpmdW5jdGlvbiAodG9TdGFydCkge1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICBpZiAodG9TdGFydCkge1xyXG4gICAgICAgICAgICAgICAgbWUuZW5kQ29udGFpbmVyID0gbWUuc3RhcnRDb250YWluZXI7XHJcbiAgICAgICAgICAgICAgICBtZS5lbmRPZmZzZXQgPSBtZS5zdGFydE9mZnNldDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG1lLnN0YXJ0Q29udGFpbmVyID0gbWUuZW5kQ29udGFpbmVyO1xyXG4gICAgICAgICAgICAgICAgbWUuc3RhcnRPZmZzZXQgPSBtZS5lbmRPZmZzZXQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbWUuY29sbGFwc2VkID0gdHJ1ZTtcclxuICAgICAgICAgICAgcmV0dXJuIG1lO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOiwg+aVtHJhbmdl55qE5byA5aeL5L2N572u5ZKM57uT5p2f5L2N572u77yM5L2/5YW2XCLmlLbnvKlcIuWIsOacgOWwj+eahOS9jee9rlxyXG4gICAgICAgICAqIEBtZXRob2QgIHNocmlua0JvdW5kYXJ5XHJcbiAgICAgICAgICogQHJldHVybiB7IFVFLmRvbS5SYW5nZSB9IOW9k+WJjXJhbmdl5a+56LGhXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBodG1sXHJcbiAgICAgICAgICogPHNwYW4+eHg8Yj54eFs8L2I+eHh4eHhdPC9zcGFuPiA9PiA8c3Bhbj54eDxiPnh4PC9iPlt4eHh4eF08L3NwYW4+XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGh0bWxcclxuICAgICAgICAgKiA8IS0tIOmAieWMuuekuuS+iyAtLT5cclxuICAgICAgICAgKiA8Yj54W3h4PC9iPjxpPl14eHg8L2k+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8c2NyaXB0PlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIC8v5omn6KGM5pS257ypXHJcbiAgICAgICAgICogICAgIHJhbmdlLnNocmlua0JvdW5kYXJ5KCk7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy/nu5PmnpzpgInljLpcclxuICAgICAgICAgKiAgICAgLy88Yj54W3h4XTwvYj48aT54eHg8L2k+XHJcbiAgICAgICAgICogPC9zY3JpcHQ+XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGh0bWxcclxuICAgICAgICAgKiBbPGI+PGk+eHh4eDwvaT54eHh4eHh4PC9iPl0gPT4gPGI+PGk+W3h4eHg8L2k+eHh4eHh4eF08L2I+XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOiwg+aVtHJhbmdl55qE5byA5aeL5L2N572u5ZKM57uT5p2f5L2N572u77yM5L2/5YW2XCLmlLbnvKlcIuWIsOacgOWwj+eahOS9jee9ru+8jFxyXG4gICAgICAgICAqIOWmguaenGlnbm9yZUVuZOeahOWAvOS4unRydWXvvIzliJnlv73nlaXlr7nnu5PmnZ/kvY3nva7nmoTosIPmlbRcclxuICAgICAgICAgKiBAbWV0aG9kICBzaHJpbmtCb3VuZGFyeVxyXG4gICAgICAgICAqIEBwYXJhbSB7IEJvb2xlYW4gfSBpZ25vcmVFbmQg5piv5ZCm5b+955Wl5a+557uT5p2f5L2N572u55qE6LCD5pW0XHJcbiAgICAgICAgICogQHJldHVybiB7IFVFLmRvbS5SYW5nZSB9IOW9k+WJjXJhbmdl5a+56LGhXHJcbiAgICAgICAgICogQHNlZSBVRS5kb20uZG9tVXRpbHMuUmFuZ2U6c2hyaW5rQm91bmRhcnkoKVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHNocmlua0JvdW5kYXJ5OmZ1bmN0aW9uIChpZ25vcmVFbmQpIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcywgY2hpbGQsXHJcbiAgICAgICAgICAgICAgICBjb2xsYXBzZWQgPSBtZS5jb2xsYXBzZWQ7XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrKG5vZGUpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT0gMSAmJiAhZG9tVXRpbHMuaXNCb29rbWFya05vZGUobm9kZSkgJiYgIWR0ZC4kZW1wdHlbbm9kZS50YWdOYW1lXSAmJiAhZHRkLiRub25DaGlsZFtub2RlLnRhZ05hbWVdXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgd2hpbGUgKG1lLnN0YXJ0Q29udGFpbmVyLm5vZGVUeXBlID09IDEgLy/mmK9lbGVtZW50XHJcbiAgICAgICAgICAgICAgICAmJiAoY2hpbGQgPSBtZS5zdGFydENvbnRhaW5lci5jaGlsZE5vZGVzW21lLnN0YXJ0T2Zmc2V0XSkgLy/lrZDoioLngrnkuZ/mmK9lbGVtZW50XHJcbiAgICAgICAgICAgICAgICAmJiBjaGVjayhjaGlsZCkpIHtcclxuICAgICAgICAgICAgICAgIG1lLnNldFN0YXJ0KGNoaWxkLCAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoY29sbGFwc2VkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbWUuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCFpZ25vcmVFbmQpIHtcclxuICAgICAgICAgICAgICAgIHdoaWxlIChtZS5lbmRDb250YWluZXIubm9kZVR5cGUgPT0gMS8v5pivZWxlbWVudFxyXG4gICAgICAgICAgICAgICAgICAgICYmIG1lLmVuZE9mZnNldCA+IDAgLy/lpoLmnpzmmK/nqbrlhYPntKDlsLHpgIDlh7ogZW5kT2Zmc2V0PTDpgqPkuYhlbmRPZmZzdC0x5Li66LSf5YC877yMY2hpbGROb2Rlc1tlbmRPZmZzZXRd5oql6ZSZXHJcbiAgICAgICAgICAgICAgICAgICAgJiYgKGNoaWxkID0gbWUuZW5kQ29udGFpbmVyLmNoaWxkTm9kZXNbbWUuZW5kT2Zmc2V0IC0gMV0pIC8v5a2Q6IqC54K55Lmf5pivZWxlbWVudFxyXG4gICAgICAgICAgICAgICAgICAgICYmIGNoZWNrKGNoaWxkKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLnNldEVuZChjaGlsZCwgY2hpbGQuY2hpbGROb2Rlcy5sZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBtZTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDojrflj5bnprvlvZPliY3pgInljLrlhoXljIXlkKvnmoTmiYDmnInoioLngrnmnIDov5HnmoTlhazlhbHnpZblhYjoioLngrnvvIxcclxuICAgICAgICAgKiBAbWV0aG9kICBnZXRDb21tb25BbmNlc3RvclxyXG4gICAgICAgICAqIEByZW1pbmQg6L+U5Zue55qE5YWs5YWx56WW5YWI6IqC54K55LiA5a6a5LiN5pivcmFuZ2Xoh6rouqvnmoTlrrnlmajoioLngrnvvIwg5L2G5pyJ5Y+v6IO95piv5LiA5Liq5paH5pys6IqC54K5XHJcbiAgICAgICAgICogQHJldHVybiB7IE5vZGUgfSDlvZPliY1yYW5nZeWvueixoeWGheaJgOacieiKgueCueeahOWFrOWFseelluWFiOiKgueCuVxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgaHRtbFxyXG4gICAgICAgICAqIC8v6YCJ5Yy656S65L6LXHJcbiAgICAgICAgICogPHNwYW4+eHh4PGI+eFt4PGVtPnh4XXg8L2VtPnh4eDwvYj54eDwvc3Bhbj5cclxuICAgICAgICAgKiA8c2NyaXB0PlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIHZhciBub2RlID0gcmFuZ2UuZ2V0Q29tbW9uQW5jZXN0b3IoKTtcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAvL+WFrOWFseelluWFiOiKgueCueaYr++8miBi6IqC54K5XHJcbiAgICAgICAgICogICAgIC8v6L6T5Ye677yaIEJcclxuICAgICAgICAgKiAgICAgY29uc29sZS5sb2cobm9kZS50YWdOYW1lKTtcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDojrflj5blvZPliY3pgInljLrmiYDljIXlkKvnmoTmiYDmnInoioLngrnnmoTlhazlhbHnpZblhYjoioLngrnvvIwg5Y+v5Lul5qC55o2u57uZ5a6a55qE5Y+C5pWwIGluY2x1ZGVTZWxmIOWGs+WumuiOt+WPluWIsFxyXG4gICAgICAgICAqIOeahOWFrOWFseelluWFiOiKgueCueaYr+WQpuWPr+S7peaYr+W9k+WJjemAieWMuueahHN0YXJ0Q29udGFpbmVy5oiWZW5kQ29udGFpbmVy6IqC54K577yMIOWmguaenCBpbmNsdWRlU2VsZlxyXG4gICAgICAgICAqIOeahOWPluWAvOS4unRydWXvvIwg5YiZ6L+U5Zue55qE6IqC54K55Y+v5Lul5piv6Ieq6Lqr55qE5a655Zmo6IqC54K577yMIOWQpuWIme+8jCDliJnkuI3og73mmK/lrrnlmajoioLngrlcclxuICAgICAgICAgKiBAbWV0aG9kICBnZXRDb21tb25BbmNlc3RvclxyXG4gICAgICAgICAqIEBwYXJhbSB7IEJvb2xlYW4gfSBpbmNsdWRlU2VsZiDmmK/lkKblhYHorrjojrflj5bliLDnmoTlhazlhbHnpZblhYjoioLngrnmmK/lvZPliY1yYW5nZeWvueixoeeahOWuueWZqOiKgueCuVxyXG4gICAgICAgICAqIEByZXR1cm4geyBOb2RlIH0g5b2T5YmNcmFuZ2Xlr7nosaHlhoXmiYDmnInoioLngrnnmoTlhazlhbHnpZblhYjoioLngrlcclxuICAgICAgICAgKiBAc2VlIFVFLmRvbS5SYW5nZTpnZXRDb21tb25BbmNlc3RvcigpXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBodG1sXHJcbiAgICAgICAgICogPGJvZHk+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgPCEtLSDpgInljLrnpLrkvosgLS0+XHJcbiAgICAgICAgICogICAgIDxiPnh4eDxpPnh4eHg8c3Bhbj54eFt4PC9zcGFuPnh4XXg8L2k+eHh4eHh4eDwvYj5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICA8c2NyaXB0PlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgICAgICB2YXIgbm9kZSA9IHJhbmdlLmdldENvbW1vbkFuY2VzdG9yKCBmYWxzZSApO1xyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgICAgICAvL+i/memHjOeahOWFrOWFseelluWFiOiKgueCueaYr0LogIzkuI3mmK9J77yMIOaYr+WboOS4uuWPguaVsOmZkOWItuS6huiOt+WPluWIsOeahOiKgueCueS4jeiDveaYr+WuueWZqOiKgueCuVxyXG4gICAgICAgICAqICAgICAgICAgLy9vdXRwdXQ6IEJcclxuICAgICAgICAgKiAgICAgICAgIGNvbnNvbGUubG9nKCBub2RlLnRhZ05hbWUgKTtcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICA8L3NjcmlwdD5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIDwvYm9keT5cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6I635Y+W5b2T5YmN6YCJ5Yy65omA5YyF5ZCr55qE5omA5pyJ6IqC54K555qE5YWs5YWx56WW5YWI6IqC54K577yMIOWPr+S7peagueaNrue7meWumueahOWPguaVsCBpbmNsdWRlU2VsZiDlhrPlrprojrflj5bliLBcclxuICAgICAgICAgKiDnmoTlhazlhbHnpZblhYjoioLngrnmmK/lkKblj6/ku6XmmK/lvZPliY3pgInljLrnmoRzdGFydENvbnRhaW5lcuaIlmVuZENvbnRhaW5lcuiKgueCue+8jCDlpoLmnpwgaW5jbHVkZVNlbGZcclxuICAgICAgICAgKiDnmoTlj5blgLzkuLp0cnVl77yMIOWImei/lOWbnueahOiKgueCueWPr+S7peaYr+iHqui6q+eahOWuueWZqOiKgueCue+8jCDlkKbliJnvvIwg5YiZ5LiN6IO95piv5a655Zmo6IqC54K577ybIOWQjOaXtuWPr+S7peagueaNrlxyXG4gICAgICAgICAqIGlnbm9yZVRleHROb2RlIOWPguaVsOeahOWPluWAvOWGs+WumuaYr+WQpuW/veeVpeexu+Wei+S4uuaWh+acrOiKgueCueeahOelluWFiOiKgueCueOAglxyXG4gICAgICAgICAqIEBtZXRob2QgIGdldENvbW1vbkFuY2VzdG9yXHJcbiAgICAgICAgICogQHBhcmFtIHsgQm9vbGVhbiB9IGluY2x1ZGVTZWxmIOaYr+WQpuWFgeiuuOiOt+WPluWIsOeahOWFrOWFseelluWFiOiKgueCueaYr+W9k+WJjXJhbmdl5a+56LGh55qE5a655Zmo6IqC54K5XHJcbiAgICAgICAgICogQHBhcmFtIHsgQm9vbGVhbiB9IGlnbm9yZVRleHROb2RlIOiOt+WPluelluWFiOiKgueCueeahOi/h+eoi+S4reaYr+WQpuW/veeVpeexu+Wei+S4uuaWh+acrOiKgueCueeahOelluWFiOiKgueCuVxyXG4gICAgICAgICAqIEByZXR1cm4geyBOb2RlIH0g5b2T5YmNcmFuZ2Xlr7nosaHlhoXmiYDmnInoioLngrnnmoTlhazlhbHnpZblhYjoioLngrlcclxuICAgICAgICAgKiBAc2VlIFVFLmRvbS5SYW5nZTpnZXRDb21tb25BbmNlc3RvcigpXHJcbiAgICAgICAgICogQHNlZSBVRS5kb20uUmFuZ2U6Z2V0Q29tbW9uQW5jZXN0b3IoQm9vbGVhbilcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGh0bWxcclxuICAgICAgICAgKiA8Ym9keT5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICA8IS0tIOmAieWMuuekuuS+iyAtLT5cclxuICAgICAgICAgKiAgICAgPGI+eHh4PGk+eHh4eDxzcGFuPnhbeF14PC9zcGFuPnh4eDwvaT54eHh4eHh4PC9iPlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIDxzY3JpcHQ+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgICAgIHZhciBub2RlID0gcmFuZ2UuZ2V0Q29tbW9uQW5jZXN0b3IoIHRydWUsIGZhbHNlICk7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgICAgIC8vb3V0cHV0OiBTUEFOXHJcbiAgICAgICAgICogICAgICAgICBjb25zb2xlLmxvZyggbm9kZS50YWdOYW1lICk7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgPC9zY3JpcHQ+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8L2JvZHk+XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0Q29tbW9uQW5jZXN0b3I6ZnVuY3Rpb24gKGluY2x1ZGVTZWxmLCBpZ25vcmVUZXh0Tm9kZSkge1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzLFxyXG4gICAgICAgICAgICAgICAgc3RhcnQgPSBtZS5zdGFydENvbnRhaW5lcixcclxuICAgICAgICAgICAgICAgIGVuZCA9IG1lLmVuZENvbnRhaW5lcjtcclxuICAgICAgICAgICAgaWYgKHN0YXJ0ID09PSBlbmQpIHtcclxuICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlU2VsZiAmJiBzZWxlY3RPbmVOb2RlKHRoaXMpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBzdGFydC5jaGlsZE5vZGVzW21lLnN0YXJ0T2Zmc2V0XTtcclxuICAgICAgICAgICAgICAgICAgICBpZihzdGFydC5ub2RlVHlwZSA9PSAxKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3RhcnQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvL+WPquacieWcqOS4iuadpeWwseebuOetieeahOaDheWGteS4i+aJjeS8muWHuueOsOaYr+aWh+acrOeahOaDheWGtVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGlnbm9yZVRleHROb2RlICYmIHN0YXJ0Lm5vZGVUeXBlID09IDMgPyBzdGFydC5wYXJlbnROb2RlIDogc3RhcnQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGRvbVV0aWxzLmdldENvbW1vbkFuY2VzdG9yKHN0YXJ0LCBlbmQpO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOiwg+aVtOW9k+WJjVJhbmdl55qE5byA5aeL5ZKM57uT5p2f6L6555WM5a655Zmo77yM5aaC5p6c5piv5a655Zmo6IqC54K55piv5paH5pys6IqC54K5LOWwseiwg+aVtOWIsOWMheWQq+ivpeaWh+acrOiKgueCueeahOeItuiKgueCueS4ilxyXG4gICAgICAgICAqIEBtZXRob2QgdHJpbUJvdW5kYXJ5XHJcbiAgICAgICAgICogQHJlbWluZCDor6Xmk43kvZzmnInlj6/og73kvJrlvJXotbfmlofmnKzoioLngrnooqvliIflvIBcclxuICAgICAgICAgKiBAcmV0dXJuIHsgVUUuZG9tLlJhbmdlIH0g5b2T5YmNcmFuZ2Xlr7nosaFcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGh0bWxcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIC8v6YCJ5Yy656S65L6LXHJcbiAgICAgICAgICogPGI+eHh4PGk+W3h4eHh4XTwvaT54eHg8L2I+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8c2NyaXB0PlxyXG4gICAgICAgICAqICAgICAvL+acquiwg+aVtOWJje+8jCDpgInljLrnmoTlvIDlp4vlrrnlmajlkoznu5PmnZ/pg73mmK/mlofmnKzoioLngrlcclxuICAgICAgICAgKiAgICAgLy/miafooYzosIPmlbRcclxuICAgICAgICAgKiAgICAgcmFuZ2UudHJpbUJvdW5kYXJ5KCk7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy/osIPmlbTkuYvlkI7vvIwg5a655Zmo6IqC54K55Y+Y5oiQ5LqGaeiKgueCuVxyXG4gICAgICAgICAqICAgICAvLzxiPnh4eFs8aT54eHh4eDwvaT5deHh4PC9iPlxyXG4gICAgICAgICAqIDwvc2NyaXB0PlxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDosIPmlbTlvZPliY1SYW5nZeeahOW8gOWni+WSjOe7k+adn+i+ueeVjOWuueWZqO+8jOWmguaenOaYr+WuueWZqOiKgueCueaYr+aWh+acrOiKgueCuSzlsLHosIPmlbTliLDljIXlkKvor6XmlofmnKzoioLngrnnmoTniLboioLngrnkuIrvvIxcclxuICAgICAgICAgKiDlj6/ku6XmoLnmja4gaWdub3JlRW5kIOWPguaVsOeahOWAvOWGs+WumuaYr+WQpuiwg+aVtOWvuee7k+adn+i+ueeVjOeahOiwg+aVtFxyXG4gICAgICAgICAqIEBtZXRob2QgdHJpbUJvdW5kYXJ5XHJcbiAgICAgICAgICogQHBhcmFtIHsgQm9vbGVhbiB9IGlnbm9yZUVuZCDmmK/lkKblv73nlaXlr7nnu5PmnZ/ovrnnlYznmoTosIPmlbRcclxuICAgICAgICAgKiBAcmV0dXJuIHsgVUUuZG9tLlJhbmdlIH0g5b2T5YmNcmFuZ2Xlr7nosaFcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGh0bWxcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIC8v6YCJ5Yy656S65L6LXHJcbiAgICAgICAgICogPGI+eHh4PGk+W3h4eHh4XTwvaT54eHg8L2I+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8c2NyaXB0PlxyXG4gICAgICAgICAqICAgICAvL+acquiwg+aVtOWJje+8jCDpgInljLrnmoTlvIDlp4vlrrnlmajlkoznu5PmnZ/pg73mmK/mlofmnKzoioLngrlcclxuICAgICAgICAgKiAgICAgLy/miafooYzosIPmlbRcclxuICAgICAgICAgKiAgICAgcmFuZ2UudHJpbUJvdW5kYXJ5KCB0cnVlICk7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy/osIPmlbTkuYvlkI7vvIwg5byA5aeL5a655Zmo6IqC54K55Y+Y5oiQ5LqGaeiKgueCuVxyXG4gICAgICAgICAqICAgICAvL+S9huaYr++8jCDnu5PmnZ/lrrnlmajmsqHmnInlj5HnlJ/lj5jljJZcclxuICAgICAgICAgKiAgICAgLy88Yj54eHhbPGk+eHh4eHhdPC9pPnh4eDwvYj5cclxuICAgICAgICAgKiA8L3NjcmlwdD5cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICB0cmltQm91bmRhcnk6ZnVuY3Rpb24gKGlnbm9yZUVuZCkge1xyXG4gICAgICAgICAgICB0aGlzLnR4dFRvRWxtQm91bmRhcnkoKTtcclxuICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5zdGFydENvbnRhaW5lcixcclxuICAgICAgICAgICAgICAgIG9mZnNldCA9IHRoaXMuc3RhcnRPZmZzZXQsXHJcbiAgICAgICAgICAgICAgICBjb2xsYXBzZWQgPSB0aGlzLmNvbGxhcHNlZCxcclxuICAgICAgICAgICAgICAgIGVuZCA9IHRoaXMuZW5kQ29udGFpbmVyO1xyXG4gICAgICAgICAgICBpZiAoc3RhcnQubm9kZVR5cGUgPT0gMykge1xyXG4gICAgICAgICAgICAgICAgaWYgKG9mZnNldCA9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTdGFydEJlZm9yZShzdGFydCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvZmZzZXQgPj0gc3RhcnQubm9kZVZhbHVlLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXJ0QWZ0ZXIoc3RhcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0Tm9kZSA9IGRvbVV0aWxzLnNwbGl0KHN0YXJ0LCBvZmZzZXQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL+i3n+aWsOe7k+adn+i+ueeVjFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhcnQgPT09IGVuZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRFbmQodGV4dE5vZGUsIHRoaXMuZW5kT2Zmc2V0IC0gb2Zmc2V0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydC5wYXJlbnROb2RlID09PSBlbmQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kT2Zmc2V0ICs9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTdGFydEJlZm9yZSh0ZXh0Tm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGNvbGxhcHNlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbGxhcHNlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICghaWdub3JlRW5kKSB7XHJcbiAgICAgICAgICAgICAgICBvZmZzZXQgPSB0aGlzLmVuZE9mZnNldDtcclxuICAgICAgICAgICAgICAgIGVuZCA9IHRoaXMuZW5kQ29udGFpbmVyO1xyXG4gICAgICAgICAgICAgICAgaWYgKGVuZC5ub2RlVHlwZSA9PSAzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9mZnNldCA9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RW5kQmVmb3JlKGVuZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0IDwgZW5kLm5vZGVWYWx1ZS5sZW5ndGggJiYgZG9tVXRpbHMuc3BsaXQoZW5kLCBvZmZzZXQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEVuZEFmdGVyKGVuZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOWmguaenOmAieWMuuWcqOaWh+acrOeahOi+ueeVjOS4iu+8jOWwseaJqeWxlemAieWMuuWIsOaWh+acrOeahOeItuiKgueCueS4iiwg5aaC5p6c5b2T5YmN6YCJ5Yy65piv6Zet5ZCI55qE77yMIOWImeS7gOS5iOS5n+S4jeWBmlxyXG4gICAgICAgICAqIEBtZXRob2QgdHh0VG9FbG1Cb3VuZGFyeVxyXG4gICAgICAgICAqIEByZW1pbmQg6K+l5pON5L2c5LiN5Lya5L+u5pS5ZG9t6IqC54K5XHJcbiAgICAgICAgICogQHJldHVybiB7IFVFLmRvbS5SYW5nZSB9IOW9k+WJjXJhbmdl5a+56LGhXHJcbiAgICAgICAgICovXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOWmguaenOmAieWMuuWcqOaWh+acrOeahOi+ueeVjOS4iu+8jOWwseaJqeWxlemAieWMuuWIsOaWh+acrOeahOeItuiKgueCueS4iiwg5aaC5p6c5b2T5YmN6YCJ5Yy65piv6Zet5ZCI55qE77yMIOWImeagueaNruWPguaVsOmhuVxyXG4gICAgICAgICAqIGlnbm9yZUNvbGxhcHNlZCDnmoTlgLzlhrPlrprmmK/lkKbmiafooYzor6XosIPmlbRcclxuICAgICAgICAgKiBAbWV0aG9kIHR4dFRvRWxtQm91bmRhcnlcclxuICAgICAgICAgKiBAcGFyYW0geyBCb29sZWFuIH0gaWdub3JlQ29sbGFwc2VkIOaYr+WQpuW/veeVpemAieWMuueahOmXreWQiOeKtuaAge+8jCDlpoLmnpzor6Xlj4LmlbDlj5blgLzkuLp0cnVl77yMIOWImVxyXG4gICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgIOS4jeiuuumAieWMuuaYr+WQpumXreWQiO+8jCDpg73kvJrmiafooYzor6Xmk43kvZzvvIwg5Y+N5LmL77yMIOWImeS4jeS8muWvuemXreWQiOeahOmAieWMuuaJp+ihjOivpeaTjeS9nFxyXG4gICAgICAgICAqIEByZXR1cm4geyBVRS5kb20uUmFuZ2UgfSDlvZPliY1yYW5nZeWvueixoVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHR4dFRvRWxtQm91bmRhcnk6ZnVuY3Rpb24gKGlnbm9yZUNvbGxhcHNlZCkge1xyXG4gICAgICAgICAgICBmdW5jdGlvbiBhZGp1c3QociwgYykge1xyXG4gICAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lciA9IHJbYyArICdDb250YWluZXInXSxcclxuICAgICAgICAgICAgICAgICAgICBvZmZzZXQgPSByW2MgKyAnT2Zmc2V0J107XHJcbiAgICAgICAgICAgICAgICBpZiAoY29udGFpbmVyLm5vZGVUeXBlID09IDMpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIW9mZnNldCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByWydzZXQnICsgYy5yZXBsYWNlKC8oXFx3KS8sIGZ1bmN0aW9uIChhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS50b1VwcGVyQ2FzZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KSArICdCZWZvcmUnXShjb250YWluZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob2Zmc2V0ID49IGNvbnRhaW5lci5ub2RlVmFsdWUubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJbJ3NldCcgKyBjLnJlcGxhY2UoLyhcXHcpLywgZnVuY3Rpb24gKGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhLnRvVXBwZXJDYXNlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pICsgJ0FmdGVyJyBdKGNvbnRhaW5lcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoaWdub3JlQ29sbGFwc2VkIHx8ICF0aGlzLmNvbGxhcHNlZCkge1xyXG4gICAgICAgICAgICAgICAgYWRqdXN0KHRoaXMsICdzdGFydCcpO1xyXG4gICAgICAgICAgICAgICAgYWRqdXN0KHRoaXMsICdlbmQnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcztcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDlnKjlvZPliY3pgInljLrnmoTlvIDlp4vkvY3nva7liY3mj5LlhaXoioLngrnvvIzmlrDmj5LlhaXnmoToioLngrnkvJrooqvor6VyYW5nZeWMheWQq1xyXG4gICAgICAgICAqIEBtZXRob2QgIGluc2VydE5vZGVcclxuICAgICAgICAgKiBAcGFyYW0geyBOb2RlIH0gbm9kZSDpnIDopoHmj5LlhaXnmoToioLngrlcclxuICAgICAgICAgKiBAcmVtaW5kIOaPkuWFpeeahOiKgueCueWPr+S7peaYr+S4gOS4qkRvY3VtZW50RnJhZ21lbnTkvp3mrKHmj5LlhaXlpJrkuKroioLngrlcclxuICAgICAgICAgKiBAcmV0dXJuIHsgVUUuZG9tLlJhbmdlIH0g5b2T5YmNcmFuZ2Xlr7nosaFcclxuICAgICAgICAgKi9cclxuICAgICAgICBpbnNlcnROb2RlOmZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgICAgIHZhciBmaXJzdCA9IG5vZGUsIGxlbmd0aCA9IDE7XHJcbiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09IDExKSB7XHJcbiAgICAgICAgICAgICAgICBmaXJzdCA9IG5vZGUuZmlyc3RDaGlsZDtcclxuICAgICAgICAgICAgICAgIGxlbmd0aCA9IG5vZGUuY2hpbGROb2Rlcy5sZW5ndGg7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy50cmltQm91bmRhcnkodHJ1ZSk7XHJcbiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuc3RhcnRDb250YWluZXIsXHJcbiAgICAgICAgICAgICAgICBvZmZzZXQgPSB0aGlzLnN0YXJ0T2Zmc2V0O1xyXG4gICAgICAgICAgICB2YXIgbmV4dE5vZGUgPSBzdGFydC5jaGlsZE5vZGVzWyBvZmZzZXQgXTtcclxuICAgICAgICAgICAgaWYgKG5leHROb2RlKSB7XHJcbiAgICAgICAgICAgICAgICBzdGFydC5pbnNlcnRCZWZvcmUobm9kZSwgbmV4dE5vZGUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc3RhcnQuYXBwZW5kQ2hpbGQobm9kZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGZpcnN0LnBhcmVudE5vZGUgPT09IHRoaXMuZW5kQ29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVuZE9mZnNldCA9IHRoaXMuZW5kT2Zmc2V0ICsgbGVuZ3RoO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldFN0YXJ0QmVmb3JlKGZpcnN0KTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDpl63lkIjpgInljLrliLDlvZPliY3pgInljLrnmoTlvIDlp4vkvY3nva7vvIwg5bm25LiU5a6a5L2N5YWJ5qCH5Yiw6Zet5ZCI5ZCO55qE5L2N572uXHJcbiAgICAgICAgICogQG1ldGhvZCAgc2V0Q3Vyc29yXHJcbiAgICAgICAgICogQHJldHVybiB7IFVFLmRvbS5SYW5nZSB9IOW9k+WJjXJhbmdl5a+56LGhXHJcbiAgICAgICAgICogQHNlZSBVRS5kb20uUmFuZ2U6Y29sbGFwc2UoKVxyXG4gICAgICAgICAqL1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDpl63lkIjpgInljLrvvIzlj6/ku6XmoLnmja7lj4LmlbB0b0VuZOeahOWAvOaOp+WItumAieWMuuaYr+WQkeWJjemXreWQiOi/mOaYr+WQkeWQjumXreWQiO+8jCDlubbkuJTlrprkvY3lhYnmoIfliLDpl63lkIjlkI7nmoTkvY3nva7jgIJcclxuICAgICAgICAgKiBAbWV0aG9kICBzZXRDdXJzb3JcclxuICAgICAgICAgKiBAcGFyYW0geyBCb29sZWFuIH0gdG9FbmQg5piv5ZCm5ZCR5ZCO6Zet5ZCI77yMIOWmguaenOS4unRydWXvvIwg5YiZ6Zet5ZCI6YCJ5Yy65pe277yMIOWwhuWQkee7k+adn+WuueWZqOaWueWQkemXreWQiO+8jFxyXG4gICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgIOWPjeS5i++8jOWImeWQkeW8gOWni+WuueWZqOaWueWQkemXreWQiFxyXG4gICAgICAgICAqIEByZXR1cm4geyBVRS5kb20uUmFuZ2UgfSDlvZPliY1yYW5nZeWvueixoVxyXG4gICAgICAgICAqIEBzZWUgVUUuZG9tLlJhbmdlOmNvbGxhcHNlKEJvb2xlYW4pXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgc2V0Q3Vyc29yOmZ1bmN0aW9uICh0b0VuZCwgbm9GaWxsRGF0YSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb2xsYXBzZSghdG9FbmQpLnNlbGVjdChub0ZpbGxEYXRhKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDliJvlu7rlvZPliY1yYW5nZeeahOS4gOS4quS5puetvu+8jOiusOW9leS4i+W9k+WJjXJhbmdl55qE5L2N572u77yM5pa55L6/5b2TZG9t5qCR5pS55Y+Y5pe277yM6L+Y6IO95om+5Zue5Y6f5p2l55qE6YCJ5Yy65L2N572uXHJcbiAgICAgICAgICogQG1ldGhvZCBjcmVhdGVCb29rbWFya1xyXG4gICAgICAgICAqIEBwYXJhbSB7IEJvb2xlYW4gfSBzZXJpYWxpemUg5o6n5Yi26L+U5Zue55qE5qCH6K6w5L2N572u5piv5a+55b2T5YmN5L2N572u55qE5byV55So6L+Y5pivSUTvvIzlpoLmnpzor6XlgLzkuLp0cnVl77yM5YiZXHJcbiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICDov5Tlm57moIforrDkvY3nva7nmoRJRO+8jCDlj43kuYvliJnov5Tlm57moIforrDkvY3nva7oioLngrnnmoTlvJXnlKhcclxuICAgICAgICAgKiBAcmV0dXJuIHsgT2JqZWN0IH0g6L+U5Zue5LiA5Liq5Lmm562+6K6w5b2V6ZSu5YC85a+577yMIOWFtuWMheWQq+eahGtleeacie+8miBzdGFydCA9PiDlvIDlp4vmoIforrDnmoRJROaIluiAheW8leeUqO+8jFxyXG4gICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICBlbmQgPT4g57uT5p2f5qCH6K6w55qESUTmiJblvJXnlKjvvIwgaWQgPT4g5b2T5YmN5qCH6K6w55qE57G75Z6L77yMIOWmguaenOS4unRydWXvvIzliJnooajnpLpcclxuICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAg6L+U5Zue55qE6K6w5b2V55qE57G75Z6L5Li6SUTvvIwg5Y+N5LmL5YiZ5Li65byV55SoXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgY3JlYXRlQm9va21hcms6ZnVuY3Rpb24gKHNlcmlhbGl6ZSwgc2FtZSkge1xyXG4gICAgICAgICAgICB2YXIgZW5kTm9kZSxcclxuICAgICAgICAgICAgICAgIHN0YXJ0Tm9kZSA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xyXG4gICAgICAgICAgICBzdGFydE5vZGUuc3R5bGUuY3NzVGV4dCA9ICdkaXNwbGF5Om5vbmU7bGluZS1oZWlnaHQ6MHB4Oyc7XHJcbiAgICAgICAgICAgIHN0YXJ0Tm9kZS5hcHBlbmRDaGlsZCh0aGlzLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCdcXHUyMDBEJykpO1xyXG4gICAgICAgICAgICBzdGFydE5vZGUuaWQgPSAnX2JhaWR1X2Jvb2ttYXJrX3N0YXJ0XycgKyAoc2FtZSA/ICcnIDogZ3VpZCsrKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghdGhpcy5jb2xsYXBzZWQpIHtcclxuICAgICAgICAgICAgICAgIGVuZE5vZGUgPSBzdGFydE5vZGUuY2xvbmVOb2RlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgZW5kTm9kZS5pZCA9ICdfYmFpZHVfYm9va21hcmtfZW5kXycgKyAoc2FtZSA/ICcnIDogZ3VpZCsrKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmluc2VydE5vZGUoc3RhcnROb2RlKTtcclxuICAgICAgICAgICAgaWYgKGVuZE5vZGUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29sbGFwc2UoKS5pbnNlcnROb2RlKGVuZE5vZGUpLnNldEVuZEJlZm9yZShlbmROb2RlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnNldFN0YXJ0QWZ0ZXIoc3RhcnROb2RlKTtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIHN0YXJ0OnNlcmlhbGl6ZSA/IHN0YXJ0Tm9kZS5pZCA6IHN0YXJ0Tm9kZSxcclxuICAgICAgICAgICAgICAgIGVuZDplbmROb2RlID8gc2VyaWFsaXplID8gZW5kTm9kZS5pZCA6IGVuZE5vZGUgOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgaWQ6c2VyaWFsaXplXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiAg6LCD5pW05b2T5YmNcmFuZ2XnmoTovrnnlYzliLDkuabnrb7kvY3nva7vvIzlubbliKDpmaTor6Xkuabnrb7lr7nosaHmiYDmoIforrDnmoTkvY3nva7lhoXnmoToioLngrlcclxuICAgICAgICAgKiAgQG1ldGhvZCAgbW92ZVRvQm9va21hcmtcclxuICAgICAgICAgKiAgQHBhcmFtIHsgQm9va01hcmsgfSBib29rbWFyayBjcmVhdGVCb29rbWFya+aJgOWIm+W7uueahOagh+etvuWvueixoVxyXG4gICAgICAgICAqICBAcmV0dXJuIHsgVUUuZG9tLlJhbmdlIH0g5b2T5YmNcmFuZ2Xlr7nosaFcclxuICAgICAgICAgKiAgQHNlZSBVRS5kb20uUmFuZ2U6Y3JlYXRlQm9va21hcmsoQm9vbGVhbilcclxuICAgICAgICAgKi9cclxuICAgICAgICBtb3ZlVG9Cb29rbWFyazpmdW5jdGlvbiAoYm9va21hcmspIHtcclxuICAgICAgICAgICAgdmFyIHN0YXJ0ID0gYm9va21hcmsuaWQgPyB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGJvb2ttYXJrLnN0YXJ0KSA6IGJvb2ttYXJrLnN0YXJ0LFxyXG4gICAgICAgICAgICAgICAgZW5kID0gYm9va21hcmsuZW5kICYmIGJvb2ttYXJrLmlkID8gdGhpcy5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChib29rbWFyay5lbmQpIDogYm9va21hcmsuZW5kO1xyXG4gICAgICAgICAgICB0aGlzLnNldFN0YXJ0QmVmb3JlKHN0YXJ0KTtcclxuICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHN0YXJ0KTtcclxuICAgICAgICAgICAgaWYgKGVuZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRFbmRCZWZvcmUoZW5kKTtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShlbmQpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcztcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDosIPmlbRyYW5nZeeahOi+ueeVjO+8jOS9v+WFtlwi5pS+5aSnXCLliLDmnIDov5HnmoTniLboioLngrlcclxuICAgICAgICAgKiBAbWV0aG9kICBlbmxhcmdlXHJcbiAgICAgICAgICogQHJlbWluZCDkvJrlvJXotbfpgInljLrnmoTlj5jljJZcclxuICAgICAgICAgKiBAcmV0dXJuIHsgVUUuZG9tLlJhbmdlIH0g5b2T5YmNcmFuZ2Xlr7nosaFcclxuICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6LCD5pW0cmFuZ2XnmoTovrnnlYzvvIzkvb/lhbZcIuaUvuWkp1wi5Yiw5pyA6L+R55qE54i26IqC54K577yM5qC55o2u5Y+C5pWwIHRvQmxvY2sg55qE5Y+W5YC877yMIOWPr+S7pVxyXG4gICAgICAgICAqIOimgeaxguaJqeWkp+S5i+WQjueahOeItuiKgueCueaYr2Jsb2Nr6IqC54K5XHJcbiAgICAgICAgICogQG1ldGhvZCAgZW5sYXJnZVxyXG4gICAgICAgICAqIEBwYXJhbSB7IEJvb2xlYW4gfSB0b0Jsb2NrIOaYr+WQpuimgeaxguaJqeWkp+S5i+WQjueahOeItuiKgueCueW/hemhu+aYr2Jsb2Nr6IqC54K5XHJcbiAgICAgICAgICogQHJldHVybiB7IFVFLmRvbS5SYW5nZSB9IOW9k+WJjXJhbmdl5a+56LGhXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZW5sYXJnZTpmdW5jdGlvbiAodG9CbG9jaywgc3RvcEZuKSB7XHJcbiAgICAgICAgICAgIHZhciBpc0JvZHkgPSBkb21VdGlscy5pc0JvZHksXHJcbiAgICAgICAgICAgICAgICBwcmUsIG5vZGUsIHRtcCA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJycpO1xyXG4gICAgICAgICAgICBpZiAodG9CbG9jaykge1xyXG4gICAgICAgICAgICAgICAgbm9kZSA9IHRoaXMuc3RhcnRDb250YWluZXI7XHJcbiAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGROb2Rlc1t0aGlzLnN0YXJ0T2Zmc2V0XSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmUgPSBub2RlID0gbm9kZS5jaGlsZE5vZGVzW3RoaXMuc3RhcnRPZmZzZXRdXHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZCh0bXApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmUgPSBub2RlID0gdG1wO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJlID0gbm9kZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHdoaWxlICgxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRvbVV0aWxzLmlzQmxvY2tFbG0obm9kZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHByZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChwcmUgPSBub2RlLnByZXZpb3VzU2libGluZykgJiYgIWRvbVV0aWxzLmlzQmxvY2tFbG0ocHJlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHByZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXJ0QmVmb3JlKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcHJlID0gbm9kZTtcclxuICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbm9kZSA9IHRoaXMuZW5kQ29udGFpbmVyO1xyXG4gICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwcmUgPSBub2RlLmNoaWxkTm9kZXNbdGhpcy5lbmRPZmZzZXRdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuaW5zZXJ0QmVmb3JlKHRtcCwgcHJlKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlLmFwcGVuZENoaWxkKHRtcCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHByZSA9IG5vZGUgPSB0bXA7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHByZSA9IG5vZGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB3aGlsZSAoMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkb21VdGlscy5pc0Jsb2NrRWxtKG5vZGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBwcmU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgocHJlID0gbm9kZS5uZXh0U2libGluZykgJiYgIWRvbVV0aWxzLmlzQmxvY2tFbG0ocHJlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHByZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEVuZEFmdGVyKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcHJlID0gbm9kZTtcclxuICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHRtcC5wYXJlbnROb2RlID09PSB0aGlzLmVuZENvbnRhaW5lcikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kT2Zmc2V0LS07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUodG1wKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8g5omp5bGV6L6555WM5Yiw5pyA5aSnXHJcbiAgICAgICAgICAgIGlmICghdGhpcy5jb2xsYXBzZWQpIHtcclxuICAgICAgICAgICAgICAgIHdoaWxlICh0aGlzLnN0YXJ0T2Zmc2V0ID09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcEZuICYmIHN0b3BGbih0aGlzLnN0YXJ0Q29udGFpbmVyKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzQm9keSh0aGlzLnN0YXJ0Q29udGFpbmVyKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTdGFydEJlZm9yZSh0aGlzLnN0YXJ0Q29udGFpbmVyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHdoaWxlICh0aGlzLmVuZE9mZnNldCA9PSAodGhpcy5lbmRDb250YWluZXIubm9kZVR5cGUgPT0gMSA/IHRoaXMuZW5kQ29udGFpbmVyLmNoaWxkTm9kZXMubGVuZ3RoIDogdGhpcy5lbmRDb250YWluZXIubm9kZVZhbHVlLmxlbmd0aCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcEZuICYmIHN0b3BGbih0aGlzLmVuZENvbnRhaW5lcikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0JvZHkodGhpcy5lbmRDb250YWluZXIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEVuZEFmdGVyKHRoaXMuZW5kQ29udGFpbmVyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcztcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVubGFyZ2VUb0Jsb2NrRWxtOmZ1bmN0aW9uKGlnbm9yZUVuZCl7XHJcbiAgICAgICAgICAgIHdoaWxlKCFkb21VdGlscy5pc0Jsb2NrRWxtKHRoaXMuc3RhcnRDb250YWluZXIpKXtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhcnRCZWZvcmUodGhpcy5zdGFydENvbnRhaW5lcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYoIWlnbm9yZUVuZCl7XHJcbiAgICAgICAgICAgICAgICB3aGlsZSghZG9tVXRpbHMuaXNCbG9ja0VsbSh0aGlzLmVuZENvbnRhaW5lcikpe1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0RW5kQWZ0ZXIodGhpcy5lbmRDb250YWluZXIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6LCD5pW0UmFuZ2XnmoTovrnnlYzvvIzkvb/lhbZcIue8qeWwj1wi5Yiw5pyA5ZCI6YCC55qE5L2N572uXHJcbiAgICAgICAgICogQG1ldGhvZCBhZGp1c3RtZW50Qm91bmRhcnlcclxuICAgICAgICAgKiBAcmV0dXJuIHsgVUUuZG9tLlJhbmdlIH0g5b2T5YmNcmFuZ2Xlr7nosaFcclxuICAgICAgICAgKiBAc2VlIFVFLmRvbS5SYW5nZTpzaHJpbmtCb3VuZGFyeSgpXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgYWRqdXN0bWVudEJvdW5kYXJ5OmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmNvbGxhcHNlZCkge1xyXG4gICAgICAgICAgICAgICAgd2hpbGUgKCFkb21VdGlscy5pc0JvZHkodGhpcy5zdGFydENvbnRhaW5lcikgJiZcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0T2Zmc2V0ID09IHRoaXMuc3RhcnRDb250YWluZXJbdGhpcy5zdGFydENvbnRhaW5lci5ub2RlVHlwZSA9PSAzID8gJ25vZGVWYWx1ZScgOiAnY2hpbGROb2RlcyddLmxlbmd0aCAmJlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRDb250YWluZXJbdGhpcy5zdGFydENvbnRhaW5lci5ub2RlVHlwZSA9PSAzID8gJ25vZGVWYWx1ZScgOiAnY2hpbGROb2RlcyddLmxlbmd0aFxyXG4gICAgICAgICAgICAgICAgICAgICkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXJ0QWZ0ZXIodGhpcy5zdGFydENvbnRhaW5lcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB3aGlsZSAoIWRvbVV0aWxzLmlzQm9keSh0aGlzLmVuZENvbnRhaW5lcikgJiYgIXRoaXMuZW5kT2Zmc2V0ICYmXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmRDb250YWluZXJbdGhpcy5lbmRDb250YWluZXIubm9kZVR5cGUgPT0gMyA/ICdub2RlVmFsdWUnIDogJ2NoaWxkTm9kZXMnXS5sZW5ndGhcclxuICAgICAgICAgICAgICAgICAgICApIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEVuZEJlZm9yZSh0aGlzLmVuZENvbnRhaW5lcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog57uZcmFuZ2XpgInljLrkuK3nmoTlhoXlrrnmt7vliqDnu5nlrprnmoRpbmxpbmXmoIfnrb5cclxuICAgICAgICAgKiBAbWV0aG9kIGFwcGx5SW5saW5lU3R5bGVcclxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSB0YWdOYW1lIOmcgOimgea3u+WKoOeahOagh+etvuWQjVxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgaHRtbFxyXG4gICAgICAgICAqIDxwPnh4eHhbeHh4eF14PC9wPiAgPT0+ICByYW5nZS5hcHBseUlubGluZVN0eWxlKFwic3Ryb25nXCIpICA9PT4gIDxwPnh4eHhbPHN0cm9uZz54eHh4PC9zdHJvbmc+XXg8L3A+XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOe7mXJhbmdl6YCJ5Yy65Lit55qE5YaF5a655re75Yqg57uZ5a6a55qEaW5saW5l5qCH562+77yMIOW5tuS4lOS4uuagh+etvumZhOWKoOS4iuS4gOS6m+WIneWni+WMluWxnuaAp+OAglxyXG4gICAgICAgICAqIEBtZXRob2QgYXBwbHlJbmxpbmVTdHlsZVxyXG4gICAgICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IHRhZ05hbWUg6ZyA6KaB5re75Yqg55qE5qCH562+5ZCNXHJcbiAgICAgICAgICogQHBhcmFtIHsgT2JqZWN0IH0gYXR0cnMg6Lef6ZqP5paw5re75Yqg55qE5qCH562+55qE5bGe5oCnXHJcbiAgICAgICAgICogQHJldHVybiB7IFVFLmRvbS5SYW5nZSB9IOW9k+WJjemAieWMulxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgaHRtbFxyXG4gICAgICAgICAqIDxwPnh4eHhbeHh4eF14PC9wPlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogPT0+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8IS0tIOaJp+ihjOaTjeS9nCAtLT5cclxuICAgICAgICAgKiByYW5nZS5hcHBseUlubGluZVN0eWxlKFwic3Ryb25nXCIse1wic3R5bGVcIjpcImZvbnQtc2l6ZToxMnB4XCJ9KVxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogPT0+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8cD54eHh4WzxzdHJvbmcgc3R5bGU9XCJmb250LXNpemU6MTJweFwiPnh4eHg8L3N0cm9uZz5deDwvcD5cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICBhcHBseUlubGluZVN0eWxlOmZ1bmN0aW9uICh0YWdOYW1lLCBhdHRycywgbGlzdCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5jb2xsYXBzZWQpcmV0dXJuIHRoaXM7XHJcbiAgICAgICAgICAgIHRoaXMudHJpbUJvdW5kYXJ5KCkuZW5sYXJnZShmYWxzZSxcclxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT0gMSAmJiBkb21VdGlscy5pc0Jsb2NrRWxtKG5vZGUpXHJcbiAgICAgICAgICAgICAgICB9KS5hZGp1c3RtZW50Qm91bmRhcnkoKTtcclxuICAgICAgICAgICAgdmFyIGJvb2ttYXJrID0gdGhpcy5jcmVhdGVCb29rbWFyaygpLFxyXG4gICAgICAgICAgICAgICAgZW5kID0gYm9va21hcmsuZW5kLFxyXG4gICAgICAgICAgICAgICAgZmlsdGVyRm4gPSBmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09IDEgPyBub2RlLnRhZ05hbWUudG9Mb3dlckNhc2UoKSAhPSAnYnInIDogIWRvbVV0aWxzLmlzV2hpdGVzcGFjZShub2RlKTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBjdXJyZW50ID0gZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoYm9va21hcmsuc3RhcnQsIGZhbHNlLCBmaWx0ZXJGbiksXHJcbiAgICAgICAgICAgICAgICBub2RlLFxyXG4gICAgICAgICAgICAgICAgcHJlLFxyXG4gICAgICAgICAgICAgICAgcmFuZ2UgPSB0aGlzLmNsb25lUmFuZ2UoKTtcclxuICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQgJiYgKGRvbVV0aWxzLmdldFBvc2l0aW9uKGN1cnJlbnQsIGVuZCkgJiBkb21VdGlscy5QT1NJVElPTl9QUkVDRURJTkcpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY3VycmVudC5ub2RlVHlwZSA9PSAzIHx8IGR0ZFt0YWdOYW1lXVtjdXJyZW50LnRhZ05hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnRCZWZvcmUoY3VycmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGN1cnJlbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUgJiYgKG5vZGUubm9kZVR5cGUgPT0gMyB8fCBkdGRbdGFnTmFtZV1bbm9kZS50YWdOYW1lXSkgJiYgbm9kZSAhPT0gZW5kKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZSA9IG5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBkb21VdGlscy5nZXROZXh0RG9tTm9kZShub2RlLCBub2RlLm5vZGVUeXBlID09IDEsIG51bGwsIGZ1bmN0aW9uIChwYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkdGRbdGFnTmFtZV1bcGFyZW50LnRhZ05hbWVdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZyYWcgPSByYW5nZS5zZXRFbmRBZnRlcihwcmUpLmV4dHJhY3RDb250ZW50cygpLCBlbG07XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGxpc3QgJiYgbGlzdC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsZXZlbCwgdG9wO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0b3AgPSBsZXZlbCA9IGxpc3RbMF0uY2xvbmVOb2RlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDEsIGNpOyBjaSA9IGxpc3RbaSsrXTspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldmVsLmFwcGVuZENoaWxkKGNpLmNsb25lTm9kZShmYWxzZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV2ZWwgPSBsZXZlbC5maXJzdENoaWxkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsbSA9IGxldmVsO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsbSA9IHJhbmdlLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnTmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChhdHRycykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5zZXRBdHRyaWJ1dGVzKGVsbSwgYXR0cnMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbG0uYXBwZW5kQ2hpbGQoZnJhZyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2UuaW5zZXJ0Tm9kZShsaXN0ID8gdG9wIDogZWxtKTtcclxuICAgICAgICAgICAgICAgICAgICAvL+WkhOeQhuS4i+a7kee6v+WcqGHkuIrnmoTmg4XlhrVcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYU5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ05hbWUgPT0gJ3NwYW4nICYmIGF0dHJzLnN0eWxlICYmIC90ZXh0XFwtZGVjb3JhdGlvbi8udGVzdChhdHRycy5zdHlsZSkgJiYgKGFOb2RlID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShlbG0sICdhJywgdHJ1ZSkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnNldEF0dHJpYnV0ZXMoYU5vZGUsIGF0dHJzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKGVsbSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsbSA9IGFOb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLm1lcmdlU2libGluZyhlbG0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5jbGVhckVtcHR5U2libGluZyhlbG0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAvL+WOu+mZpOWtkOiKgueCueebuOWQjOeahFxyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLm1lcmdlQ2hpbGQoZWxtLCBhdHRycyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGRvbVV0aWxzLmdldE5leHREb21Ob2RlKGVsbSwgZmFsc2UsIGZpbHRlckZuKTtcclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5tZXJnZVRvUGFyZW50KGVsbSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGVuZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBkb21VdGlscy5nZXROZXh0RG9tTm9kZShjdXJyZW50LCB0cnVlLCBmaWx0ZXJGbik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMubW92ZVRvQm9va21hcmsoYm9va21hcmspO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOenu+mZpOW9k+WJjemAieWMuuWGheaMh+WumueahGlubGluZeagh+etvu+8jOS9huS/neeVmeWFtuS4reeahOWGheWuuVxyXG4gICAgICAgICAqIEBtZXRob2QgcmVtb3ZlSW5saW5lU3R5bGVcclxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSB0YWdOYW1lIOmcgOimgeenu+mZpOeahOagh+etvuWQjVxyXG4gICAgICAgICAqIEByZXR1cm4geyBVRS5kb20uUmFuZ2UgfSDlvZPliY3nmoRyYW5nZeWvueixoVxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgaHRtbFxyXG4gICAgICAgICAqIHh4W3g8c3Bhbj54eHg8ZW0+eXl5PC9lbT56el16PC9zcGFuPiAgPT4gcmFuZ2UucmVtb3ZlSW5saW5lU3R5bGUoW1wiZW1cIl0pICA9PiB4eFt4PHNwYW4+eHh4eXl5enpdejwvc3Bhbj5cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog56e76Zmk5b2T5YmN6YCJ5Yy65YaF5oyH5a6a55qE5LiA57uEaW5saW5l5qCH562+77yM5L2G5L+d55WZ5YW25Lit55qE5YaF5a65XHJcbiAgICAgICAgICogQG1ldGhvZCByZW1vdmVJbmxpbmVTdHlsZVxyXG4gICAgICAgICAqIEBwYXJhbSB7IEFycmF5IH0gdGFnTmFtZUFyciDpnIDopoHnp7vpmaTnmoTmoIfnrb7lkI3nmoTmlbDnu4RcclxuICAgICAgICAgKiBAcmV0dXJuIHsgVUUuZG9tLlJhbmdlIH0g5b2T5YmN55qEcmFuZ2Xlr7nosaFcclxuICAgICAgICAgKiBAc2VlIFVFLmRvbS5SYW5nZTpyZW1vdmVJbmxpbmVTdHlsZShTdHJpbmcpXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgcmVtb3ZlSW5saW5lU3R5bGU6ZnVuY3Rpb24gKHRhZ05hbWVzKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbGxhcHNlZClyZXR1cm4gdGhpcztcclxuICAgICAgICAgICAgdGFnTmFtZXMgPSB1dGlscy5pc0FycmF5KHRhZ05hbWVzKSA/IHRhZ05hbWVzIDogW3RhZ05hbWVzXTtcclxuICAgICAgICAgICAgdGhpcy5zaHJpbmtCb3VuZGFyeSgpLmFkanVzdG1lbnRCb3VuZGFyeSgpO1xyXG4gICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLnN0YXJ0Q29udGFpbmVyLCBlbmQgPSB0aGlzLmVuZENvbnRhaW5lcjtcclxuICAgICAgICAgICAgd2hpbGUgKDEpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdGFydC5ub2RlVHlwZSA9PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHV0aWxzLmluZGV4T2YodGFnTmFtZXMsIHN0YXJ0LnRhZ05hbWUudG9Mb3dlckNhc2UoKSkgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXJ0LnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAnYm9keScpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBzdGFydCA9IHN0YXJ0LnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgd2hpbGUgKDEpIHtcclxuICAgICAgICAgICAgICAgIGlmIChlbmQubm9kZVR5cGUgPT0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh1dGlscy5pbmRleE9mKHRhZ05hbWVzLCBlbmQudGFnTmFtZS50b0xvd2VyQ2FzZSgpKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoZW5kLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAnYm9keScpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZW5kID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZW5kID0gZW5kLnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGJvb2ttYXJrID0gdGhpcy5jcmVhdGVCb29rbWFyaygpLFxyXG4gICAgICAgICAgICAgICAgZnJhZyxcclxuICAgICAgICAgICAgICAgIHRtcFJhbmdlO1xyXG4gICAgICAgICAgICBpZiAoc3RhcnQpIHtcclxuICAgICAgICAgICAgICAgIHRtcFJhbmdlID0gdGhpcy5jbG9uZVJhbmdlKCkuc2V0RW5kQmVmb3JlKGJvb2ttYXJrLnN0YXJ0KS5zZXRTdGFydEJlZm9yZShzdGFydCk7XHJcbiAgICAgICAgICAgICAgICBmcmFnID0gdG1wUmFuZ2UuZXh0cmFjdENvbnRlbnRzKCk7XHJcbiAgICAgICAgICAgICAgICB0bXBSYW5nZS5pbnNlcnROb2RlKGZyYWcpO1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMuY2xlYXJFbXB0eVNpYmxpbmcoc3RhcnQsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgc3RhcnQucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoYm9va21hcmsuc3RhcnQsIHN0YXJ0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoZW5kKSB7XHJcbiAgICAgICAgICAgICAgICB0bXBSYW5nZSA9IHRoaXMuY2xvbmVSYW5nZSgpLnNldFN0YXJ0QWZ0ZXIoYm9va21hcmsuZW5kKS5zZXRFbmRBZnRlcihlbmQpO1xyXG4gICAgICAgICAgICAgICAgZnJhZyA9IHRtcFJhbmdlLmV4dHJhY3RDb250ZW50cygpO1xyXG4gICAgICAgICAgICAgICAgdG1wUmFuZ2UuaW5zZXJ0Tm9kZShmcmFnKTtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLmNsZWFyRW1wdHlTaWJsaW5nKGVuZCwgZmFsc2UsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgZW5kLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGJvb2ttYXJrLmVuZCwgZW5kLm5leHRTaWJsaW5nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgY3VycmVudCA9IGRvbVV0aWxzLmdldE5leHREb21Ob2RlKGJvb2ttYXJrLnN0YXJ0LCBmYWxzZSwgZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09IDE7XHJcbiAgICAgICAgICAgIH0pLCBuZXh0O1xyXG4gICAgICAgICAgICB3aGlsZSAoY3VycmVudCAmJiBjdXJyZW50ICE9PSBib29rbWFyay5lbmQpIHtcclxuICAgICAgICAgICAgICAgIG5leHQgPSBkb21VdGlscy5nZXROZXh0RG9tTm9kZShjdXJyZW50LCB0cnVlLCBmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09IDE7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGlmICh1dGlscy5pbmRleE9mKHRhZ05hbWVzLCBjdXJyZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKSkgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShjdXJyZW50LCB0cnVlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBuZXh0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm1vdmVUb0Jvb2ttYXJrKGJvb2ttYXJrKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDojrflj5blvZPliY3pgInkuK3nmoToh6rpl63lkIjnmoToioLngrlcclxuICAgICAgICAgKiBAbWV0aG9kICBnZXRDbG9zZWROb2RlXHJcbiAgICAgICAgICogQHJldHVybiB7IE5vZGUgfCBOVUxMIH0g5aaC5p6c5b2T5YmN6YCJ5Lit55qE5piv6Ieq6Zet5ZCI6IqC54K577yMIOWImei/lOWbnuivpeiKgueCue+8jCDlkKbliJnov5Tlm55OVUxMXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0Q2xvc2VkTm9kZTpmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBub2RlO1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuY29sbGFwc2VkKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmFuZ2UgPSB0aGlzLmNsb25lUmFuZ2UoKS5hZGp1c3RtZW50Qm91bmRhcnkoKS5zaHJpbmtCb3VuZGFyeSgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHNlbGVjdE9uZU5vZGUocmFuZ2UpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gcmFuZ2Uuc3RhcnRDb250YWluZXIuY2hpbGROb2Rlc1tyYW5nZS5zdGFydE9mZnNldF07XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkICYmIGNoaWxkLm5vZGVUeXBlID09IDEgJiYgKGR0ZC4kZW1wdHlbY2hpbGQudGFnTmFtZV0gfHwgZHRkLiRub25DaGlsZFtjaGlsZC50YWdOYW1lXSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGNoaWxkO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gbm9kZTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDlnKjpobXpnaLkuIrpq5jkuq5yYW5nZeaJgOihqOekuueahOmAieWMulxyXG4gICAgICAgICAqIEBtZXRob2Qgc2VsZWN0XHJcbiAgICAgICAgICogQHJldHVybiB7IFVFLmRvbS5SYW5nZSB9IOi/lOWbnuW9k+WJjVJhbmdl5a+56LGhXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgICAgIC8v6L+Z6YeM5LiN5Yy65YiGaWU55Lul5LiK77yMdHJhY2U6MzgyNFxyXG4gICAgICAgIHNlbGVjdDpicm93c2VyLmllID8gZnVuY3Rpb24gKG5vRmlsbERhdGEsIHRleHRSYW5nZSkge1xyXG4gICAgICAgICAgICB2YXIgbmF0aXZlUmFuZ2U7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5jb2xsYXBzZWQpXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNocmlua0JvdW5kYXJ5KCk7XHJcbiAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5nZXRDbG9zZWROb2RlKCk7XHJcbiAgICAgICAgICAgIGlmIChub2RlICYmICF0ZXh0UmFuZ2UpIHtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmF0aXZlUmFuZ2UgPSB0aGlzLmRvY3VtZW50LmJvZHkuY3JlYXRlQ29udHJvbFJhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgbmF0aXZlUmFuZ2UuYWRkRWxlbWVudChub2RlKTtcclxuICAgICAgICAgICAgICAgICAgICBuYXRpdmVSYW5nZS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgYm9va21hcmsgPSB0aGlzLmNyZWF0ZUJvb2ttYXJrKCksXHJcbiAgICAgICAgICAgICAgICBzdGFydCA9IGJvb2ttYXJrLnN0YXJ0LFxyXG4gICAgICAgICAgICAgICAgZW5kO1xyXG4gICAgICAgICAgICBuYXRpdmVSYW5nZSA9IHRoaXMuZG9jdW1lbnQuYm9keS5jcmVhdGVUZXh0UmFuZ2UoKTtcclxuICAgICAgICAgICAgbmF0aXZlUmFuZ2UubW92ZVRvRWxlbWVudFRleHQoc3RhcnQpO1xyXG4gICAgICAgICAgICBuYXRpdmVSYW5nZS5tb3ZlU3RhcnQoJ2NoYXJhY3RlcicsIDEpO1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuY29sbGFwc2VkKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbmF0aXZlUmFuZ2VFbmQgPSB0aGlzLmRvY3VtZW50LmJvZHkuY3JlYXRlVGV4dFJhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICBlbmQgPSBib29rbWFyay5lbmQ7XHJcbiAgICAgICAgICAgICAgICBuYXRpdmVSYW5nZUVuZC5tb3ZlVG9FbGVtZW50VGV4dChlbmQpO1xyXG4gICAgICAgICAgICAgICAgbmF0aXZlUmFuZ2Uuc2V0RW5kUG9pbnQoJ0VuZFRvRW5kJywgbmF0aXZlUmFuZ2VFbmQpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFub0ZpbGxEYXRhICYmIHRoaXMuc3RhcnRDb250YWluZXIubm9kZVR5cGUgIT0gMykge1xyXG4gICAgICAgICAgICAgICAgICAgIC8v5L2/55SoPHNwYW4+fHg8c3Bhbj7lm7rlrprkvY/lhYnmoIdcclxuICAgICAgICAgICAgICAgICAgICB2YXIgdG1wVGV4dCA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoZmlsbENoYXIpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bXAgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcclxuICAgICAgICAgICAgICAgICAgICB0bXAuYXBwZW5kQ2hpbGQodGhpcy5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShmaWxsQ2hhcikpO1xyXG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0LnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRtcCwgc3RhcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0LnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRtcFRleHQsIHN0YXJ0KTtcclxuICAgICAgICAgICAgICAgICAgICAvL+W9k+eCuWIsaSx15pe277yM5LiN6IO95riF6ZmkaeS4iui+ueeahGJcclxuICAgICAgICAgICAgICAgICAgICByZW1vdmVGaWxsRGF0YSh0aGlzLmRvY3VtZW50LCB0bXBUZXh0KTtcclxuICAgICAgICAgICAgICAgICAgICBmaWxsRGF0YSA9IHRtcFRleHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgbWVyZ2VTaWJsaW5nKHRtcCwgJ3ByZXZpb3VzU2libGluZycpO1xyXG4gICAgICAgICAgICAgICAgICAgIG1lcmdlU2libGluZyhzdGFydCwgJ25leHRTaWJsaW5nJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgbmF0aXZlUmFuZ2UubW92ZVN0YXJ0KCdjaGFyYWN0ZXInLCAtMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbmF0aXZlUmFuZ2UuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5tb3ZlVG9Cb29rbWFyayhib29rbWFyayk7XHJcbiAgICAgICAgICAgIHRtcCAmJiBkb21VdGlscy5yZW1vdmUodG1wKTtcclxuICAgICAgICAgICAgLy9JReWcqOmakOiXj+eKtuaAgeS4i+S4jeaUr+aMgXJhbmdl5pON5L2c77yMY2F0Y2jkuIDkuItcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIG5hdGl2ZVJhbmdlLnNlbGVjdCgpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICAgICAgfSA6IGZ1bmN0aW9uIChub3RJbnNlcnRGaWxsRGF0YSkge1xyXG4gICAgICAgICAgICBmdW5jdGlvbiBjaGVja09mZnNldChybmcpe1xyXG5cclxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrKG5vZGUsb2Zmc2V0LGRpcil7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYobm9kZS5ub2RlVHlwZSA9PSAzICYmIG5vZGUubm9kZVZhbHVlLmxlbmd0aCA8IG9mZnNldCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJuZ1tkaXIgKyAnT2Zmc2V0J10gPSBub2RlLm5vZGVWYWx1ZS5sZW5ndGhcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjaGVjayhybmcuc3RhcnRDb250YWluZXIscm5nLnN0YXJ0T2Zmc2V0LCdzdGFydCcpO1xyXG4gICAgICAgICAgICAgICAgY2hlY2socm5nLmVuZENvbnRhaW5lcixybmcuZW5kT2Zmc2V0LCdlbmQnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgd2luID0gZG9tVXRpbHMuZ2V0V2luZG93KHRoaXMuZG9jdW1lbnQpLFxyXG4gICAgICAgICAgICAgICAgc2VsID0gd2luLmdldFNlbGVjdGlvbigpLFxyXG4gICAgICAgICAgICAgICAgdHh0Tm9kZTtcclxuICAgICAgICAgICAgLy9GRuS4i+WFs+mXreiHquWKqOmVv+mrmOaXtua7muWKqOadoeWcqOWFs+mXrWRpYWxvZ+aXtuS8mui3s1xyXG4gICAgICAgICAgICAvL2Zm5LiL5aaC5p6c5LiNYm9keS5mb2N1c+WwhuS4jeiDveWumuS9jemXreWQiOWFieagh+WIsOe8lui+keWZqOWGhVxyXG4gICAgICAgICAgICBicm93c2VyLmdlY2tvID8gdGhpcy5kb2N1bWVudC5ib2R5LmZvY3VzKCkgOiB3aW4uZm9jdXMoKTtcclxuICAgICAgICAgICAgaWYgKHNlbCkge1xyXG4gICAgICAgICAgICAgICAgc2VsLnJlbW92ZUFsbFJhbmdlcygpO1xyXG4gICAgICAgICAgICAgICAgLy8gdHJhY2U6ODcwIGNocm9tZS9zYWZhcmnlkI7ovrnmmK9icuWvueS6jumXreWQiOW+l3Jhbmdl5LiN6IO95a6a5L2NIOaJgOS7peWOu+aOieS6huWIpOaWrVxyXG4gICAgICAgICAgICAgICAgLy8gdGhpcy5zdGFydENvbnRhaW5lci5ub2RlVHlwZSAhPSAzICYmISAoKGNoaWxkID0gdGhpcy5zdGFydENvbnRhaW5lci5jaGlsZE5vZGVzW3RoaXMuc3RhcnRPZmZzZXRdKSAmJiBjaGlsZC5ub2RlVHlwZSA9PSAxICYmIGNoaWxkLnRhZ05hbWUgPT0gJ0JSJ1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuY29sbGFwc2VkICYmICFub3RJbnNlcnRGaWxsRGF0YSkge1xyXG4vLyAgICAgICAgICAgICAgICAgICAgLy9vcGVhcuWmguaenOayoeacieiKgueCueaOpeedgO+8jOWOn+eUn+eahOS4jeiDveWkn+WumuS9jSzkuI3og73lnKhib2R555qE56ys5LiA57qn5o+S5YWl56m655m96IqC54K5XHJcbi8vICAgICAgICAgICAgICAgICAgICBpZiAobm90SW5zZXJ0RmlsbERhdGEgJiYgYnJvd3Nlci5vcGVyYSAmJiAhZG9tVXRpbHMuaXNCb2R5KHRoaXMuc3RhcnRDb250YWluZXIpICYmIHRoaXMuc3RhcnRDb250YWluZXIubm9kZVR5cGUgPT0gMSkge1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0bXAgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCcnKTtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluc2VydE5vZGUodG1wKS5zZXRTdGFydCh0bXAsIDApLmNvbGxhcHNlKHRydWUpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgfVxyXG4vL1xyXG4gICAgICAgICAgICAgICAgICAgIC8v5aSE55CG5YWJ5qCH6JC95Zyo5paH5pys6IqC54K555qE5oOF5Ya1XHJcbiAgICAgICAgICAgICAgICAgICAgLy/lpITnkIbku6XkuIvnmoTmg4XlhrVcclxuICAgICAgICAgICAgICAgICAgICAvLzxiPnx4eHh4PC9iPlxyXG4gICAgICAgICAgICAgICAgICAgIC8vPGI+eHh4eDwvYj58eHh4eFxyXG4gICAgICAgICAgICAgICAgICAgIC8veHh4eDxiPnw8L2I+XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5zdGFydENvbnRhaW5lcixjaGlsZCA9IHN0YXJ0O1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKHN0YXJ0Lm5vZGVUeXBlID09IDEpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IHN0YXJ0LmNoaWxkTm9kZXNbdGhpcy5zdGFydE9mZnNldF07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiggIShzdGFydC5ub2RlVHlwZSA9PSAzICYmIHRoaXMuc3RhcnRPZmZzZXQpICAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAoY2hpbGQgP1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKCFjaGlsZC5wcmV2aW91c1NpYmxpbmcgfHwgY2hpbGQucHJldmlvdXNTaWJsaW5nLm5vZGVUeXBlICE9IDMpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoIXN0YXJ0Lmxhc3RDaGlsZCB8fCBzdGFydC5sYXN0Q2hpbGQubm9kZVR5cGUgIT0gMylcclxuICAgICAgICAgICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgICAgICAgICl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR4dE5vZGUgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGZpbGxDaGFyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy/ot5/nnYDliY3ovrnotbBcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnNlcnROb2RlKHR4dE5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVGaWxsRGF0YSh0aGlzLmRvY3VtZW50LCB0eHROb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VTaWJsaW5nKHR4dE5vZGUsICdwcmV2aW91c1NpYmxpbmcnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VTaWJsaW5nKHR4dE5vZGUsICduZXh0U2libGluZycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWxsRGF0YSA9IHR4dE5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhcnQodHh0Tm9kZSwgYnJvd3Nlci53ZWJraXQgPyAxIDogMCkuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdmFyIG5hdGl2ZVJhbmdlID0gdGhpcy5kb2N1bWVudC5jcmVhdGVSYW5nZSgpO1xyXG4gICAgICAgICAgICAgICAgaWYodGhpcy5jb2xsYXBzZWQgJiYgYnJvd3Nlci5vcGVyYSAmJiB0aGlzLnN0YXJ0Q29udGFpbmVyLm5vZGVUeXBlID09IDEpe1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IHRoaXMuc3RhcnRDb250YWluZXIuY2hpbGROb2Rlc1t0aGlzLnN0YXJ0T2Zmc2V0XTtcclxuICAgICAgICAgICAgICAgICAgICBpZighY2hpbGQpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL+W+gOWJjemdoOaLolxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IHRoaXMuc3RhcnRDb250YWluZXIubGFzdENoaWxkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiggY2hpbGQgJiYgZG9tVXRpbHMuaXNCcihjaGlsZCkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTdGFydEJlZm9yZShjaGlsZCkuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy/lkJHlkI7pnaDmi6JcclxuICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoY2hpbGQgJiYgZG9tVXRpbHMuaXNCbG9ja0VsbShjaGlsZCkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoY2hpbGQubm9kZVR5cGUgPT0gMSAmJiBjaGlsZC5jaGlsZE5vZGVzWzBdKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLmNoaWxkTm9kZXNbMF1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkICYmIHRoaXMuc2V0U3RhcnRCZWZvcmUoY2hpbGQpLmNvbGxhcHNlKHRydWUpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8v5pivY3JlYXRlQWRkcmVzc+acgOWQjuS4gOS9jeeul+eahOS4jeWHhu+8jOeOsOWcqOi/memHjOi/m+ihjOW+ruiwg1xyXG4gICAgICAgICAgICAgICAgY2hlY2tPZmZzZXQodGhpcyk7XHJcbiAgICAgICAgICAgICAgICBuYXRpdmVSYW5nZS5zZXRTdGFydCh0aGlzLnN0YXJ0Q29udGFpbmVyLCB0aGlzLnN0YXJ0T2Zmc2V0KTtcclxuICAgICAgICAgICAgICAgIG5hdGl2ZVJhbmdlLnNldEVuZCh0aGlzLmVuZENvbnRhaW5lciwgdGhpcy5lbmRPZmZzZXQpO1xyXG4gICAgICAgICAgICAgICAgc2VsLmFkZFJhbmdlKG5hdGl2ZVJhbmdlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcztcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDmu5rliqjliLDlvZPliY1yYW5nZeW8gOWni+eahOS9jee9rlxyXG4gICAgICAgICAqIEBtZXRob2Qgc2Nyb2xsVG9WaWV3XHJcbiAgICAgICAgICogQHBhcmFtIHsgV2luZG93IH0gd2luIOW9k+WJjXJhbmdl5a+56LGh5omA5bGe55qEd2luZG935a+56LGhXHJcbiAgICAgICAgICogQHJldHVybiB7IFVFLmRvbS5SYW5nZSB9IOW9k+WJjVJhbmdl5a+56LGhXHJcbiAgICAgICAgICovXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOa7muWKqOWIsOi3neemu+W9k+WJjXJhbmdl5byA5aeL5L2N572uIG9mZnNldCDnmoTkvY3nva7lpIRcclxuICAgICAgICAgKiBAbWV0aG9kIHNjcm9sbFRvVmlld1xyXG4gICAgICAgICAqIEBwYXJhbSB7IFdpbmRvdyB9IHdpbiDlvZPliY1yYW5nZeWvueixoeaJgOWxnueahHdpbmRvd+WvueixoVxyXG4gICAgICAgICAqIEBwYXJhbSB7IE51bWJlciB9IG9mZnNldCDot53nprtyYW5nZeW8gOWni+S9jee9ruWkhOeahOWBj+enu+mHj++8jCDlpoLmnpzkuLrmraPmlbDvvIwg5YiZ5ZCR5LiL5YGP56e777yMIOWPjeS5i++8jCDliJnlkJHkuIrlgY/np7tcclxuICAgICAgICAgKiBAcmV0dXJuIHsgVUUuZG9tLlJhbmdlIH0g5b2T5YmNUmFuZ2Xlr7nosaFcclxuICAgICAgICAgKi9cclxuICAgICAgICBzY3JvbGxUb1ZpZXc6ZnVuY3Rpb24gKHdpbiwgb2Zmc2V0KSB7XHJcbiAgICAgICAgICAgIHdpbiA9IHdpbiA/IHdpbmRvdyA6IGRvbVV0aWxzLmdldFdpbmRvdyh0aGlzLmRvY3VtZW50KTtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICAgICAgICAgIHNwYW4gPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XHJcbiAgICAgICAgICAgIC8vdHJhY2U6NzE3XHJcbiAgICAgICAgICAgIHNwYW4uaW5uZXJIVE1MID0gJyZuYnNwOyc7XHJcbiAgICAgICAgICAgIG1lLmNsb25lUmFuZ2UoKS5pbnNlcnROb2RlKHNwYW4pO1xyXG4gICAgICAgICAgICBkb21VdGlscy5zY3JvbGxUb1ZpZXcoc3Bhbiwgd2luLCBvZmZzZXQpO1xyXG4gICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoc3Bhbik7XHJcbiAgICAgICAgICAgIHJldHVybiBtZTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDliKTmlq3lvZPliY3pgInljLrlhoXlrrnmmK/lkKbljaDkvY3nrKZcclxuICAgICAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICAgICAqIEBtZXRob2QgaW5GaWxsQ2hhclxyXG4gICAgICAgICAqIEByZXR1cm4geyBCb29sZWFuIH0g5aaC5p6c5piv5Y2g5L2N56ym6L+U5ZuedHJ1Ze+8jOWQpuWImei/lOWbnmZhbHNlXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgaW5GaWxsQ2hhciA6IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuc3RhcnRDb250YWluZXI7XHJcbiAgICAgICAgICAgIGlmKHRoaXMuY29sbGFwc2VkICYmIHN0YXJ0Lm5vZGVUeXBlID09IDNcclxuICAgICAgICAgICAgICAgICYmIHN0YXJ0Lm5vZGVWYWx1ZS5yZXBsYWNlKG5ldyBSZWdFeHAoJ14nICsgZG9tVXRpbHMuZmlsbENoYXIpLCcnKS5sZW5ndGggKyAxID09IHN0YXJ0Lm5vZGVWYWx1ZS5sZW5ndGhcclxuICAgICAgICAgICAgICAgICl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5L+d5a2YXHJcbiAgICAgICAgICogQG1ldGhvZCBjcmVhdGVBZGRyZXNzXHJcbiAgICAgICAgICogQHByaXZhdGVcclxuICAgICAgICAgKiBAcmV0dXJuIHsgQm9vbGVhbiB9IOi/lOWbnuW8gOWni+WSjOe7k+adn+eahOS9jee9rlxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgaHRtbFxyXG4gICAgICAgICAqIDxib2R5PlxyXG4gICAgICAgICAqICAgICA8cD5cclxuICAgICAgICAgKiAgICAgICAgIGFhYWFcclxuICAgICAgICAgKiAgICAgICAgIDxlbT5cclxuICAgICAgICAgKiAgICAgICAgICAgICA8IS0tIOmAieWMuuW8gOWniyAtLT5cclxuICAgICAgICAgKiAgICAgICAgICAgICBiYmJiXHJcbiAgICAgICAgICogICAgICAgICAgICAgPCEtLSDpgInljLrnu5PmnZ8gLS0+XHJcbiAgICAgICAgICogICAgICAgICA8L2VtPlxyXG4gICAgICAgICAqICAgICA8L3A+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgPHNjcmlwdD5cclxuICAgICAgICAgKiAgICAgICAgIC8vb3V0cHV0OiB7c3RhcnRBZGRyZXNzOlswLDEsMCwwXSxlbmRBZGRyZXNzOlswLDEsMCw0XX1cclxuICAgICAgICAgKiAgICAgICAgIGNvbnNvbGUubG9nKCByYW5nZS5jcmVhdGVBZGRyZXNzKCkgKTtcclxuICAgICAgICAgKiAgICAgPC9zY3JpcHQ+XHJcbiAgICAgICAgICogPC9ib2R5PlxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGNyZWF0ZUFkZHJlc3MgOiBmdW5jdGlvbihpZ25vcmVFbmQsaWdub3JlVHh0KXtcclxuICAgICAgICAgICAgdmFyIGFkZHIgPSB7fSxtZSA9IHRoaXM7XHJcblxyXG4gICAgICAgICAgICBmdW5jdGlvbiBnZXRBZGRyZXNzKGlzU3RhcnQpe1xyXG4gICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBpc1N0YXJ0ID8gbWUuc3RhcnRDb250YWluZXIgOiBtZS5lbmRDb250YWluZXI7XHJcbiAgICAgICAgICAgICAgICB2YXIgcGFyZW50cyA9IGRvbVV0aWxzLmZpbmRQYXJlbnRzKG5vZGUsdHJ1ZSxmdW5jdGlvbihub2RlKXtyZXR1cm4gIWRvbVV0aWxzLmlzQm9keShub2RlKX0pLFxyXG4gICAgICAgICAgICAgICAgICAgIGFkZHJzID0gW107XHJcbiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwLGNpO2NpID0gcGFyZW50c1tpKytdOyl7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkcnMucHVzaChkb21VdGlscy5nZXROb2RlSW5kZXgoY2ksaWdub3JlVHh0KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YXIgZmlyc3RJbmRleCA9IDA7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYoaWdub3JlVHh0KXtcclxuICAgICAgICAgICAgICAgICAgICBpZihub2RlLm5vZGVUeXBlID09IDMpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wTm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSh0bXBOb2RlICYmIHRtcE5vZGUubm9kZVR5cGUgPT0gMyl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdEluZGV4ICs9IHRtcE5vZGUubm9kZVZhbHVlLnJlcGxhY2UoZmlsbENoYXJSZWcsJycpLmxlbmd0aDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcE5vZGUgPSB0bXBOb2RlLnByZXZpb3VzU2libGluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaXJzdEluZGV4ICs9ICAoaXNTdGFydCA/IG1lLnN0YXJ0T2Zmc2V0IDogbWUuZW5kT2Zmc2V0KS8vIC0gKGZpbGxDaGFyUmVnLnRlc3Qobm9kZS5ub2RlVmFsdWUpID8gMSA6IDAgKVxyXG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gIG5vZGUuY2hpbGROb2Rlc1sgaXNTdGFydCA/IG1lLnN0YXJ0T2Zmc2V0IDogbWUuZW5kT2Zmc2V0XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYobm9kZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdEluZGV4ID0gZG9tVXRpbHMuZ2V0Tm9kZUluZGV4KG5vZGUsaWdub3JlVHh0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gaXNTdGFydCA/IG1lLnN0YXJ0Q29udGFpbmVyIDogbWUuZW5kQ29udGFpbmVyO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0ID0gbm9kZS5maXJzdENoaWxkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoZmlyc3Qpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGRvbVV0aWxzLmlzRmlsbENoYXIoZmlyc3QpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3QgPSBmaXJzdC5uZXh0U2libGluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0SW5kZXgrKztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihmaXJzdC5ub2RlVHlwZSA9PSAzKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoIGZpcnN0ICYmIGZpcnN0Lm5vZGVUeXBlID09IDMpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3QgPSBmaXJzdC5uZXh0U2libGluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdCA9IGZpcnN0Lm5leHRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICBmaXJzdEluZGV4ID0gaXNTdGFydCA/IGRvbVV0aWxzLmlzRmlsbENoYXIobm9kZSkgPyAwIDogbWUuc3RhcnRPZmZzZXQgIDogbWUuZW5kT2Zmc2V0XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZihmaXJzdEluZGV4IDwgMCl7XHJcbiAgICAgICAgICAgICAgICAgICAgZmlyc3RJbmRleCA9IDA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBhZGRycy5wdXNoKGZpcnN0SW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFkZHJzO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGFkZHIuc3RhcnRBZGRyZXNzID0gZ2V0QWRkcmVzcyh0cnVlKTtcclxuICAgICAgICAgICAgaWYoIWlnbm9yZUVuZCl7XHJcbiAgICAgICAgICAgICAgICBhZGRyLmVuZEFkZHJlc3MgPSBtZS5jb2xsYXBzZWQgPyBbXS5jb25jYXQoYWRkci5zdGFydEFkZHJlc3MpIDogZ2V0QWRkcmVzcygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBhZGRyO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOS/neWtmFxyXG4gICAgICAgICAqIEBtZXRob2QgY3JlYXRlQWRkcmVzc1xyXG4gICAgICAgICAqIEBwcml2YXRlXHJcbiAgICAgICAgICogQHJldHVybiB7IEJvb2xlYW4gfSDov5Tlm57lvIDlp4vlkoznu5PmnZ/nmoTkvY3nva5cclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGh0bWxcclxuICAgICAgICAgKiA8Ym9keT5cclxuICAgICAgICAgKiAgICAgPHA+XHJcbiAgICAgICAgICogICAgICAgICBhYWFhXHJcbiAgICAgICAgICogICAgICAgICA8ZW0+XHJcbiAgICAgICAgICogICAgICAgICAgICAgPCEtLSDpgInljLrlvIDlp4sgLS0+XHJcbiAgICAgICAgICogICAgICAgICAgICAgYmJiYlxyXG4gICAgICAgICAqICAgICAgICAgICAgIDwhLS0g6YCJ5Yy657uT5p2fIC0tPlxyXG4gICAgICAgICAqICAgICAgICAgPC9lbT5cclxuICAgICAgICAgKiAgICAgPC9wPlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIDxzY3JpcHQ+XHJcbiAgICAgICAgICogICAgICAgICB2YXIgcmFuZ2UgPSBlZGl0b3Iuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICogICAgICAgICByYW5nZS5tb3ZlVG9BZGRyZXNzKHtzdGFydEFkZHJlc3M6WzAsMSwwLDBdLGVuZEFkZHJlc3M6WzAsMSwwLDRdfSk7XHJcbiAgICAgICAgICogICAgICAgICByYW5nZS5zZWxlY3QoKTtcclxuICAgICAgICAgKiAgICAgICAgIC8vb3V0cHV0OiAnYmJiYidcclxuICAgICAgICAgKiAgICAgICAgIGNvbnNvbGUubG9nKGVkaXRvci5zZWxlY3Rpb24uZ2V0VGV4dCgpKTtcclxuICAgICAgICAgKiAgICAgPC9zY3JpcHQ+XHJcbiAgICAgICAgICogPC9ib2R5PlxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIG1vdmVUb0FkZHJlc3MgOiBmdW5jdGlvbihhZGRyLGlnbm9yZUVuZCl7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIGdldE5vZGUoYWRkcmVzcyxpc1N0YXJ0KXtcclxuICAgICAgICAgICAgICAgIHZhciB0bXBOb2RlID0gbWUuZG9jdW1lbnQuYm9keSxcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnROb2RlLG9mZnNldDtcclxuICAgICAgICAgICAgICAgIGZvcih2YXIgaT0gMCxjaSxsPWFkZHJlc3MubGVuZ3RoO2k8bDtpKyspe1xyXG4gICAgICAgICAgICAgICAgICAgIGNpID0gYWRkcmVzc1tpXTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnROb2RlID0gdG1wTm9kZTtcclxuICAgICAgICAgICAgICAgICAgICB0bXBOb2RlID0gdG1wTm9kZS5jaGlsZE5vZGVzW2NpXTtcclxuICAgICAgICAgICAgICAgICAgICBpZighdG1wTm9kZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldCA9IGNpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZihpc1N0YXJ0KXtcclxuICAgICAgICAgICAgICAgICAgICBpZih0bXBOb2RlKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuc2V0U3RhcnRCZWZvcmUodG1wTm9kZSlcclxuICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuc2V0U3RhcnQocGFyZW50Tm9kZSxvZmZzZXQpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYodG1wTm9kZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLnNldEVuZEJlZm9yZSh0bXBOb2RlKVxyXG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5zZXRFbmQocGFyZW50Tm9kZSxvZmZzZXQpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGdldE5vZGUoYWRkci5zdGFydEFkZHJlc3MsdHJ1ZSk7XHJcbiAgICAgICAgICAgICFpZ25vcmVFbmQgJiYgYWRkci5lbmRBZGRyZXNzICYmICBnZXROb2RlKGFkZHIuZW5kQWRkcmVzcyk7XHJcbiAgICAgICAgICAgIHJldHVybiBtZTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDliKTmlq3nu5nlrprnmoRSYW5nZeWvueixoeaYr+WQpuWSjOW9k+WJjVJhbmdl5a+56LGh6KGo56S655qE5piv5ZCM5LiA5Liq6YCJ5Yy6XHJcbiAgICAgICAgICogQG1ldGhvZCBlcXVhbHNcclxuICAgICAgICAgKiBAcGFyYW0geyBVRS5kb20uUmFuZ2UgfSDpnIDopoHliKTmlq3nmoRSYW5nZeWvueixoVxyXG4gICAgICAgICAqIEByZXR1cm4geyBCb29sZWFuIH0g5aaC5p6c57uZ5a6a55qEUmFuZ2Xlr7nosaHkuI7lvZPliY1SYW5nZeWvueixoeihqOekuueahOaYr+WQjOS4gOS4qumAieWMuu+8jCDliJnov5Tlm550cnVl77yMIOWQpuWImei/lOWbnmZhbHNlXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZXF1YWxzIDogZnVuY3Rpb24ocm5nKXtcclxuICAgICAgICAgICAgZm9yKHZhciBwIGluIHRoaXMpe1xyXG4gICAgICAgICAgICAgICAgaWYodGhpcy5oYXNPd25Qcm9wZXJ0eShwKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYodGhpc1twXSAhPT0gcm5nW3BdKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2VcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuXHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6YGN5Y6GcmFuZ2XlhoXnmoToioLngrnjgILmr4/lvZPpgY3ljobkuIDkuKroioLngrnml7bvvIwg6YO95Lya5omn6KGM5Y+C5pWw6aG5IGRvRm4g5oyH5a6a55qE5Ye95pWw77yMIOivpeWHveaVsOeahOaOpeWPl+W9k+WJjemBjeWOhueahOiKgueCuVxyXG4gICAgICAgICAqIOS9nOS4uuWFtuWPguaVsOOAglxyXG4gICAgICAgICAqIEBtZXRob2QgdHJhdmVyc2FsXHJcbiAgICAgICAgICogQHBhcmFtIHsgRnVuY3Rpb24gfSAgZG9GbiDlr7nmr4/kuKrpgY3ljobnmoToioLngrnopoHmiafooYznmoTmlrnms5XvvIwg6K+l5pa55rOV5o6l5Y+X5b2T5YmN6YGN5Y6G55qE6IqC54K55L2c5Li65YW25Y+C5pWwXHJcbiAgICAgICAgICogQHJldHVybiB7IFVFLmRvbS5SYW5nZSB9IOW9k+WJjXJhbmdl5a+56LGhXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBodG1sXHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8Ym9keT5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICA8IS0tIOmAieWMuuW8gOWniyAtLT5cclxuICAgICAgICAgKiAgICAgPHNwYW4+PC9zcGFuPlxyXG4gICAgICAgICAqICAgICA8YT48L2E+XHJcbiAgICAgICAgICogICAgIDwhLS0g6YCJ5Yy657uT5p2fIC0tPlxyXG4gICAgICAgICAqIDwvYm9keT5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIDxzY3JpcHQ+XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy9vdXRwdXQ6IDxzcGFuPjwvc3Bhbj48YT48L2E+XHJcbiAgICAgICAgICogICAgIGNvbnNvbGUubG9nKCByYW5nZS5jbG9uZUNvbnRlbnRzKCkgKTtcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICByYW5nZS50cmF2ZXJzYWwoIGZ1bmN0aW9uICggbm9kZSApIHtcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAgICAgaWYgKCBub2RlLm5vZGVUeXBlID09PSAxICkge1xyXG4gICAgICAgICAqICAgICAgICAgICAgIG5vZGUuY2xhc3NOYW1lID0gXCJ0ZXN0XCI7XHJcbiAgICAgICAgICogICAgICAgICB9XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgfSApO1xyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIC8vb3V0cHV0OiA8c3BhbiBjbGFzcz1cInRlc3RcIj48L3NwYW4+PGEgY2xhc3M9XCJ0ZXN0XCI+PC9hPlxyXG4gICAgICAgICAqICAgICBjb25zb2xlLmxvZyggcmFuZ2UuY2xvbmVDb250ZW50cygpICk7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8L3NjcmlwdD5cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6YGN5Y6GcmFuZ2XlhoXnmoToioLngrnjgIJcclxuICAgICAgICAgKiDmr4/lvZPpgY3ljobkuIDkuKroioLngrnml7bvvIwg6YO95Lya5omn6KGM5Y+C5pWw6aG5IGRvRm4g5oyH5a6a55qE5Ye95pWw77yMIOivpeWHveaVsOeahOaOpeWPl+W9k+WJjemBjeWOhueahOiKgueCuVxyXG4gICAgICAgICAqIOS9nOS4uuWFtuWPguaVsOOAglxyXG4gICAgICAgICAqIOWPr+S7pemAmui/h+WPguaVsOmhuSBmaWx0ZXJGbiDmnaXmjIflrprkuIDkuKrov4fmu6TlmajvvIwg5Y+q5pyJ56ym5ZCI6K+l6L+H5ruk5Zmo6L+H5ruk6KeE5YiZ55qE6IqC54K55omN5Lya6KemXHJcbiAgICAgICAgICog5Y+RZG9GbuWHveaVsOeahOaJp+ihjFxyXG4gICAgICAgICAqIEBtZXRob2QgdHJhdmVyc2FsXHJcbiAgICAgICAgICogQHBhcmFtIHsgRnVuY3Rpb24gfSBkb0ZuIOWvueavj+S4qumBjeWOhueahOiKgueCueimgeaJp+ihjOeahOaWueazle+8jCDor6Xmlrnms5XmjqXlj5flvZPliY3pgY3ljobnmoToioLngrnkvZzkuLrlhbblj4LmlbBcclxuICAgICAgICAgKiBAcGFyYW0geyBGdW5jdGlvbiB9IGZpbHRlckZuIOi/h+a7pOWZqO+8jCDor6Xlh73mlbDmjqXlj5flvZPliY3pgY3ljobnmoToioLngrnkvZzkuLrlj4LmlbDvvIwg5aaC5p6c6K+l6IqC54K55ruh6Laz6L+H5rukXHJcbiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAg6KeE5YiZ77yMIOivt+i/lOWbnnRydWXvvIwg6K+l6IqC54K55Lya6Kem5Y+RZG9Gbu+8jCDlkKbliJnvvIwg6K+36L+U5ZueZmFsc2XvvIwg5YiZ6K+l6IqC54K55LiNXHJcbiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAg5Lya6Kem5Y+RZG9GbuOAglxyXG4gICAgICAgICAqIEByZXR1cm4geyBVRS5kb20uUmFuZ2UgfSDlvZPliY1yYW5nZeWvueixoVxyXG4gICAgICAgICAqIEBzZWUgVUUuZG9tLlJhbmdlOnRyYXZlcnNhbChGdW5jdGlvbilcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGh0bWxcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIDxib2R5PlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIDwhLS0g6YCJ5Yy65byA5aeLIC0tPlxyXG4gICAgICAgICAqICAgICA8c3Bhbj48L3NwYW4+XHJcbiAgICAgICAgICogICAgIDxhPjwvYT5cclxuICAgICAgICAgKiAgICAgPCEtLSDpgInljLrnu5PmnZ8gLS0+XHJcbiAgICAgICAgICogPC9ib2R5PlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogPHNjcmlwdD5cclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAvL291dHB1dDogPHNwYW4+PC9zcGFuPjxhPjwvYT5cclxuICAgICAgICAgKiAgICAgY29uc29sZS5sb2coIHJhbmdlLmNsb25lQ29udGVudHMoKSApO1xyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIHJhbmdlLnRyYXZlcnNhbCggZnVuY3Rpb24gKCBub2RlICkge1xyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgICAgICBub2RlLmNsYXNzTmFtZSA9IFwidGVzdFwiO1xyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIH0sIGZ1bmN0aW9uICggbm9kZSApIHtcclxuICAgICAgICAgKiAgICAgICAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PT0gMTtcclxuICAgICAgICAgKiAgICAgfSApO1xyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIC8vb3V0cHV0OiA8c3BhbiBjbGFzcz1cInRlc3RcIj48L3NwYW4+PGEgY2xhc3M9XCJ0ZXN0XCI+PC9hPlxyXG4gICAgICAgICAqICAgICBjb25zb2xlLmxvZyggcmFuZ2UuY2xvbmVDb250ZW50cygpICk7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiA8L3NjcmlwdD5cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICB0cmF2ZXJzYWw6ZnVuY3Rpb24oZG9GbixmaWx0ZXJGbil7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbGxhcHNlZClcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgICAgICAgICB2YXIgYm9va21hcmsgPSB0aGlzLmNyZWF0ZUJvb2ttYXJrKCksXHJcbiAgICAgICAgICAgICAgICBlbmQgPSBib29rbWFyay5lbmQsXHJcbiAgICAgICAgICAgICAgICBjdXJyZW50ID0gZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoYm9va21hcmsuc3RhcnQsIGZhbHNlLCBmaWx0ZXJGbik7XHJcbiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50ICYmIGN1cnJlbnQgIT09IGVuZCAmJiAoZG9tVXRpbHMuZ2V0UG9zaXRpb24oY3VycmVudCwgZW5kKSAmIGRvbVV0aWxzLlBPU0lUSU9OX1BSRUNFRElORykpIHtcclxuICAgICAgICAgICAgICAgIHZhciB0bXBOb2RlID0gZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoY3VycmVudCxmYWxzZSxmaWx0ZXJGbik7XHJcbiAgICAgICAgICAgICAgICBkb0ZuKGN1cnJlbnQpO1xyXG4gICAgICAgICAgICAgICAgY3VycmVudCA9IHRtcE5vZGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMubW92ZVRvQm9va21hcmsoYm9va21hcmspO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbn0pKCk7XG5cbi8vIGNvcmUvU2VsZWN0aW9uLmpzXG4vKipcclxuICog6YCJ6ZuGXHJcbiAqIEBmaWxlXHJcbiAqIEBtb2R1bGUgVUUuZG9tXHJcbiAqIEBjbGFzcyBTZWxlY3Rpb25cclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG4vKipcclxuICog6YCJ5Yy66ZuG5ZCIXHJcbiAqIEB1bmZpbGVcclxuICogQG1vZHVsZSBVRS5kb21cclxuICogQGNsYXNzIFNlbGVjdGlvblxyXG4gKi9cclxuKGZ1bmN0aW9uICgpIHtcclxuXHJcbiAgICBmdW5jdGlvbiBnZXRCb3VuZGFyeUluZm9ybWF0aW9uKCByYW5nZSwgc3RhcnQgKSB7XHJcbiAgICAgICAgdmFyIGdldEluZGV4ID0gZG9tVXRpbHMuZ2V0Tm9kZUluZGV4O1xyXG4gICAgICAgIHJhbmdlID0gcmFuZ2UuZHVwbGljYXRlKCk7XHJcbiAgICAgICAgcmFuZ2UuY29sbGFwc2UoIHN0YXJ0ICk7XHJcbiAgICAgICAgdmFyIHBhcmVudCA9IHJhbmdlLnBhcmVudEVsZW1lbnQoKTtcclxuICAgICAgICAvL+WmguaenOiKgueCuemHjOayoeacieWtkOiKgueCue+8jOebtOaOpemAgOWHulxyXG4gICAgICAgIGlmICggIXBhcmVudC5oYXNDaGlsZE5vZGVzKCkgKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAge2NvbnRhaW5lcjpwYXJlbnQsIG9mZnNldDowfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHNpYmxpbmdzID0gcGFyZW50LmNoaWxkcmVuLFxyXG4gICAgICAgICAgICBjaGlsZCxcclxuICAgICAgICAgICAgdGVzdFJhbmdlID0gcmFuZ2UuZHVwbGljYXRlKCksXHJcbiAgICAgICAgICAgIHN0YXJ0SW5kZXggPSAwLCBlbmRJbmRleCA9IHNpYmxpbmdzLmxlbmd0aCAtIDEsIGluZGV4ID0gLTEsXHJcbiAgICAgICAgICAgIGRpc3RhbmNlO1xyXG4gICAgICAgIHdoaWxlICggc3RhcnRJbmRleCA8PSBlbmRJbmRleCApIHtcclxuICAgICAgICAgICAgaW5kZXggPSBNYXRoLmZsb29yKCAoc3RhcnRJbmRleCArIGVuZEluZGV4KSAvIDIgKTtcclxuICAgICAgICAgICAgY2hpbGQgPSBzaWJsaW5nc1tpbmRleF07XHJcbiAgICAgICAgICAgIHRlc3RSYW5nZS5tb3ZlVG9FbGVtZW50VGV4dCggY2hpbGQgKTtcclxuICAgICAgICAgICAgdmFyIHBvc2l0aW9uID0gdGVzdFJhbmdlLmNvbXBhcmVFbmRQb2ludHMoICdTdGFydFRvU3RhcnQnLCByYW5nZSApO1xyXG4gICAgICAgICAgICBpZiAoIHBvc2l0aW9uID4gMCApIHtcclxuICAgICAgICAgICAgICAgIGVuZEluZGV4ID0gaW5kZXggLSAxO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKCBwb3NpdGlvbiA8IDAgKSB7XHJcbiAgICAgICAgICAgICAgICBzdGFydEluZGV4ID0gaW5kZXggKyAxO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy90cmFjZToxMDQzXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gIHtjb250YWluZXI6cGFyZW50LCBvZmZzZXQ6Z2V0SW5kZXgoIGNoaWxkICl9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICggaW5kZXggPT0gLTEgKSB7XHJcbiAgICAgICAgICAgIHRlc3RSYW5nZS5tb3ZlVG9FbGVtZW50VGV4dCggcGFyZW50ICk7XHJcbiAgICAgICAgICAgIHRlc3RSYW5nZS5zZXRFbmRQb2ludCggJ1N0YXJ0VG9TdGFydCcsIHJhbmdlICk7XHJcbiAgICAgICAgICAgIGRpc3RhbmNlID0gdGVzdFJhbmdlLnRleHQucmVwbGFjZSggLyhcXHJcXG58XFxyKS9nLCAnXFxuJyApLmxlbmd0aDtcclxuICAgICAgICAgICAgc2libGluZ3MgPSBwYXJlbnQuY2hpbGROb2RlcztcclxuICAgICAgICAgICAgaWYgKCAhZGlzdGFuY2UgKSB7XHJcbiAgICAgICAgICAgICAgICBjaGlsZCA9IHNpYmxpbmdzW3NpYmxpbmdzLmxlbmd0aCAtIDFdO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICB7Y29udGFpbmVyOmNoaWxkLCBvZmZzZXQ6Y2hpbGQubm9kZVZhbHVlLmxlbmd0aH07XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHZhciBpID0gc2libGluZ3MubGVuZ3RoO1xyXG4gICAgICAgICAgICB3aGlsZSAoIGRpc3RhbmNlID4gMCApe1xyXG4gICAgICAgICAgICAgICAgZGlzdGFuY2UgLT0gc2libGluZ3NbIC0taSBdLm5vZGVWYWx1ZS5sZW5ndGg7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHtjb250YWluZXI6c2libGluZ3NbaV0sIG9mZnNldDotZGlzdGFuY2V9O1xyXG4gICAgICAgIH1cclxuICAgICAgICB0ZXN0UmFuZ2UuY29sbGFwc2UoIHBvc2l0aW9uID4gMCApO1xyXG4gICAgICAgIHRlc3RSYW5nZS5zZXRFbmRQb2ludCggcG9zaXRpb24gPiAwID8gJ1N0YXJ0VG9TdGFydCcgOiAnRW5kVG9TdGFydCcsIHJhbmdlICk7XHJcbiAgICAgICAgZGlzdGFuY2UgPSB0ZXN0UmFuZ2UudGV4dC5yZXBsYWNlKCAvKFxcclxcbnxcXHIpL2csICdcXG4nICkubGVuZ3RoO1xyXG4gICAgICAgIGlmICggIWRpc3RhbmNlICkge1xyXG4gICAgICAgICAgICByZXR1cm4gIGR0ZC4kZW1wdHlbY2hpbGQudGFnTmFtZV0gfHwgZHRkLiRub25DaGlsZFtjaGlsZC50YWdOYW1lXSA/XHJcbiAgICAgICAgICAgIHtjb250YWluZXI6cGFyZW50LCBvZmZzZXQ6Z2V0SW5kZXgoIGNoaWxkICkgKyAocG9zaXRpb24gPiAwID8gMCA6IDEpfSA6XHJcbiAgICAgICAgICAgIHtjb250YWluZXI6Y2hpbGQsIG9mZnNldDpwb3NpdGlvbiA+IDAgPyAwIDogY2hpbGQuY2hpbGROb2Rlcy5sZW5ndGh9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHdoaWxlICggZGlzdGFuY2UgPiAwICkge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHByZSA9IGNoaWxkO1xyXG4gICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZFtwb3NpdGlvbiA+IDAgPyAncHJldmlvdXNTaWJsaW5nJyA6ICduZXh0U2libGluZyddO1xyXG4gICAgICAgICAgICAgICAgZGlzdGFuY2UgLT0gY2hpbGQubm9kZVZhbHVlLmxlbmd0aDtcclxuICAgICAgICAgICAgfSBjYXRjaCAoIGUgKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge2NvbnRhaW5lcjpwYXJlbnQsIG9mZnNldDpnZXRJbmRleCggcHJlICl9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAge2NvbnRhaW5lcjpjaGlsZCwgb2Zmc2V0OnBvc2l0aW9uID4gMCA/IC1kaXN0YW5jZSA6IGNoaWxkLm5vZGVWYWx1ZS5sZW5ndGggKyBkaXN0YW5jZX1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWwhmllUmFuZ2XovazmjaLkuLpSYW5nZeWvueixoVxyXG4gICAgICogQHBhcmFtIHtSYW5nZX0gICBpZVJhbmdlICAgIGllUmFuZ2Xlr7nosaFcclxuICAgICAqIEBwYXJhbSB7UmFuZ2V9ICAgcmFuZ2UgICAgICBSYW5nZeWvueixoVxyXG4gICAgICogQHJldHVybiAge1JhbmdlfSAgcmFuZ2UgICAgICAg6L+U5Zue6L2s5o2i5ZCO55qEUmFuZ2Xlr7nosaFcclxuICAgICAqL1xyXG4gICAgZnVuY3Rpb24gdHJhbnNmb3JtSUVSYW5nZVRvUmFuZ2UoIGllUmFuZ2UsIHJhbmdlICkge1xyXG4gICAgICAgIGlmICggaWVSYW5nZS5pdGVtICkge1xyXG4gICAgICAgICAgICByYW5nZS5zZWxlY3ROb2RlKCBpZVJhbmdlLml0ZW0oIDAgKSApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHZhciBiaSA9IGdldEJvdW5kYXJ5SW5mb3JtYXRpb24oIGllUmFuZ2UsIHRydWUgKTtcclxuICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQoIGJpLmNvbnRhaW5lciwgYmkub2Zmc2V0ICk7XHJcbiAgICAgICAgICAgIGlmICggaWVSYW5nZS5jb21wYXJlRW5kUG9pbnRzKCAnU3RhcnRUb0VuZCcsIGllUmFuZ2UgKSAhPSAwICkge1xyXG4gICAgICAgICAgICAgICAgYmkgPSBnZXRCb3VuZGFyeUluZm9ybWF0aW9uKCBpZVJhbmdlLCBmYWxzZSApO1xyXG4gICAgICAgICAgICAgICAgcmFuZ2Uuc2V0RW5kKCBiaS5jb250YWluZXIsIGJpLm9mZnNldCApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByYW5nZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+W+l2llUmFuZ2VcclxuICAgICAqIEBwYXJhbSB7U2VsZWN0aW9ufSBzZWwgICAgU2VsZWN0aW9u5a+56LGhXHJcbiAgICAgKiBAcmV0dXJuIHtpZVJhbmdlfSAgICDlvpfliLBpZVJhbmdlXHJcbiAgICAgKi9cclxuICAgIGZ1bmN0aW9uIF9nZXRJRVJhbmdlKCBzZWwgKSB7XHJcbiAgICAgICAgdmFyIGllUmFuZ2U7XHJcbiAgICAgICAgLy9pZeS4i+acieWPr+iDveaKpemUmVxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGllUmFuZ2UgPSBzZWwuZ2V0TmF0aXZlKCkuY3JlYXRlUmFuZ2UoKTtcclxuICAgICAgICB9IGNhdGNoICggZSApIHtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBlbCA9IGllUmFuZ2UuaXRlbSA/IGllUmFuZ2UuaXRlbSggMCApIDogaWVSYW5nZS5wYXJlbnRFbGVtZW50KCk7XHJcbiAgICAgICAgaWYgKCAoIGVsLm93bmVyRG9jdW1lbnQgfHwgZWwgKSA9PT0gc2VsLmRvY3VtZW50ICkge1xyXG4gICAgICAgICAgICByZXR1cm4gaWVSYW5nZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIFNlbGVjdGlvbiA9IGRvbS5TZWxlY3Rpb24gPSBmdW5jdGlvbiAoIGRvYyApIHtcclxuICAgICAgICB2YXIgbWUgPSB0aGlzLCBpZnJhbWU7XHJcbiAgICAgICAgbWUuZG9jdW1lbnQgPSBkb2M7XHJcbiAgICAgICAgaWYgKCBicm93c2VyLmllOWJlbG93ICkge1xyXG4gICAgICAgICAgICBpZnJhbWUgPSBkb21VdGlscy5nZXRXaW5kb3coIGRvYyApLmZyYW1lRWxlbWVudDtcclxuICAgICAgICAgICAgZG9tVXRpbHMub24oIGlmcmFtZSwgJ2JlZm9yZWRlYWN0aXZhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBtZS5fYmFrSUVSYW5nZSA9IG1lLmdldElFUmFuZ2UoKTtcclxuICAgICAgICAgICAgfSApO1xyXG4gICAgICAgICAgICBkb21VdGlscy5vbiggaWZyYW1lLCAnYWN0aXZhdGUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICggIV9nZXRJRVJhbmdlKCBtZSApICYmIG1lLl9iYWtJRVJhbmdlICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5fYmFrSUVSYW5nZS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGNhdGNoICggZXggKSB7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBtZS5fYmFrSUVSYW5nZSA9IG51bGw7XHJcbiAgICAgICAgICAgIH0gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWZyYW1lID0gZG9jID0gbnVsbDtcclxuICAgIH07XHJcblxyXG4gICAgU2VsZWN0aW9uLnByb3RvdHlwZSA9IHtcclxuXHJcbiAgICAgICAgcmFuZ2VJbkJvZHkgOiBmdW5jdGlvbihybmcsdHh0UmFuZ2Upe1xyXG4gICAgICAgICAgICB2YXIgbm9kZSA9IGJyb3dzZXIuaWU5YmVsb3cgfHwgdHh0UmFuZ2UgPyBybmcuaXRlbSA/IHJuZy5pdGVtKCkgOiBybmcucGFyZW50RWxlbWVudCgpIDogcm5nLnN0YXJ0Q29udGFpbmVyO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIG5vZGUgPT09IHRoaXMuZG9jdW1lbnQuYm9keSB8fCBkb21VdGlscy5pbkRvYyhub2RlLHRoaXMuZG9jdW1lbnQpO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOiOt+WPluWOn+eUn3NlbGVjaXRvbuWvueixoVxyXG4gICAgICAgICAqIEBtZXRob2QgZ2V0TmF0aXZlXHJcbiAgICAgICAgICogQHJldHVybiB7IE9iamVjdCB9IOiOt+W+l3NlbGVjdGlvbuWvueixoVxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGVkaXRvci5zZWxlY3Rpb24uZ2V0TmF0aXZlKCk7XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0TmF0aXZlOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGRvYyA9IHRoaXMuZG9jdW1lbnQ7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gIWRvYyA/IG51bGwgOiBicm93c2VyLmllOWJlbG93ID8gZG9jLnNlbGVjdGlvbiA6IGRvbVV0aWxzLmdldFdpbmRvdyggZG9jICkuZ2V0U2VsZWN0aW9uKCk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKCBlICkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDojrflvpdpZVJhbmdlXHJcbiAgICAgICAgICogQG1ldGhvZCBnZXRJRVJhbmdlXHJcbiAgICAgICAgICogQHJldHVybiB7IE9iamVjdCB9IOi/lOWbnmll5Y6f55Sf55qEUmFuZ2VcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBlZGl0b3Iuc2VsZWN0aW9uLmdldElFUmFuZ2UoKTtcclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICBnZXRJRVJhbmdlOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGllUmFuZ2UgPSBfZ2V0SUVSYW5nZSggdGhpcyApO1xyXG4gICAgICAgICAgICBpZiAoICFpZVJhbmdlICkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCB0aGlzLl9iYWtJRVJhbmdlICkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9iYWtJRVJhbmdlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBpZVJhbmdlO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOe8k+WtmOW9k+WJjemAieWMuueahHJhbmdl5ZKM6YCJ5Yy655qE5byA5aeL6IqC54K5XHJcbiAgICAgICAgICogQG1ldGhvZCBjYWNoZVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGNhY2hlOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdGhpcy5jbGVhcigpO1xyXG4gICAgICAgICAgICB0aGlzLl9jYWNoZWRSYW5nZSA9IHRoaXMuZ2V0UmFuZ2UoKTtcclxuICAgICAgICAgICAgdGhpcy5fY2FjaGVkU3RhcnRFbGVtZW50ID0gdGhpcy5nZXRTdGFydCgpO1xyXG4gICAgICAgICAgICB0aGlzLl9jYWNoZWRTdGFydEVsZW1lbnRQYXRoID0gdGhpcy5nZXRTdGFydEVsZW1lbnRQYXRoKCk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6I635Y+W6YCJ5Yy65byA5aeL5L2N572u55qE54i26IqC54K55YiwYm9keVxyXG4gICAgICAgICAqIEBtZXRob2QgZ2V0U3RhcnRFbGVtZW50UGF0aFxyXG4gICAgICAgICAqIEByZXR1cm4geyBBcnJheSB9IOi/lOWbnueItuiKgueCuembhuWQiFxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGVkaXRvci5zZWxlY3Rpb24uZ2V0U3RhcnRFbGVtZW50UGF0aCgpO1xyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGdldFN0YXJ0RWxlbWVudFBhdGg6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAoIHRoaXMuX2NhY2hlZFN0YXJ0RWxlbWVudFBhdGggKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fY2FjaGVkU3RhcnRFbGVtZW50UGF0aDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLmdldFN0YXJ0KCk7XHJcbiAgICAgICAgICAgIGlmICggc3RhcnQgKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZG9tVXRpbHMuZmluZFBhcmVudHMoIHN0YXJ0LCB0cnVlLCBudWxsLCB0cnVlIClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gW107XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5riF56m657yT5a2YXHJcbiAgICAgICAgICogQG1ldGhvZCBjbGVhclxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGNsZWFyOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdGhpcy5fY2FjaGVkU3RhcnRFbGVtZW50UGF0aCA9IHRoaXMuX2NhY2hlZFJhbmdlID0gdGhpcy5fY2FjaGVkU3RhcnRFbGVtZW50ID0gbnVsbDtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDnvJbovpHlmajmmK/lkKblvpfliLDkuobpgInljLpcclxuICAgICAgICAgKiBAbWV0aG9kIGlzRm9jdXNcclxuICAgICAgICAgKi9cclxuICAgICAgICBpc0ZvY3VzOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGlmKGJyb3dzZXIuaWU5YmVsb3cpe1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB2YXIgbmF0aXZlUmFuZ2UgPSBfZ2V0SUVSYW5nZSh0aGlzKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gISEobmF0aXZlUmFuZ2UgJiYgdGhpcy5yYW5nZUluQm9keShuYXRpdmVSYW5nZSkpO1xyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICEhdGhpcy5nZXROYXRpdmUoKS5yYW5nZUNvdW50O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGNhdGNoICggZSApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDojrflj5bpgInljLrlr7nlupTnmoRSYW5nZVxyXG4gICAgICAgICAqIEBtZXRob2QgZ2V0UmFuZ2VcclxuICAgICAgICAgKiBAcmV0dXJuIHsgT2JqZWN0IH0g5b6X5YiwUmFuZ2Xlr7nosaFcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBlZGl0b3Iuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0UmFuZ2U6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICBmdW5jdGlvbiBvcHRpbXplKCByYW5nZSApIHtcclxuICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG1lLmRvY3VtZW50LmJvZHkuZmlyc3RDaGlsZCxcclxuICAgICAgICAgICAgICAgICAgICBjb2xsYXBzZWQgPSByYW5nZS5jb2xsYXBzZWQ7XHJcbiAgICAgICAgICAgICAgICB3aGlsZSAoIGNoaWxkICYmIGNoaWxkLmZpcnN0Q2hpbGQgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQoIGNoaWxkLCAwICk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5maXJzdENoaWxkO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKCAhcmFuZ2Uuc3RhcnRDb250YWluZXIgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQoIG1lLmRvY3VtZW50LmJvZHksIDAgKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKCBjb2xsYXBzZWQgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2UuY29sbGFwc2UoIHRydWUgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKCBtZS5fY2FjaGVkUmFuZ2UgIT0gbnVsbCApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9jYWNoZWRSYW5nZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgcmFuZ2UgPSBuZXcgYmFpZHUuZWRpdG9yLmRvbS5SYW5nZSggbWUuZG9jdW1lbnQgKTtcclxuXHJcbiAgICAgICAgICAgIGlmICggYnJvd3Nlci5pZTliZWxvdyApIHtcclxuICAgICAgICAgICAgICAgIHZhciBuYXRpdmVSYW5nZSA9IG1lLmdldElFUmFuZ2UoKTtcclxuICAgICAgICAgICAgICAgIGlmICggbmF0aXZlUmFuZ2UgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy/lpIfku73nmoRfYmFrSUVSYW5nZeWPr+iDveW3sue7j+WunuaViOS6hu+8jGRvbeagkeWPkeeUn+S6huWPmOWMluavlOWmguS7jua6kOeggeaooeW8j+WIh+Wbnuadpe+8jOaJgOS7pXRyeeS4gOS4i++8jOWunuaViOWwseaUvuWIsGJvZHnlvIDlp4vkvY3nva5cclxuICAgICAgICAgICAgICAgICAgICB0cnl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybUlFUmFuZ2VUb1JhbmdlKCBuYXRpdmVSYW5nZSwgcmFuZ2UgKTtcclxuICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGltemUoIHJhbmdlICk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW16ZSggcmFuZ2UgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHZhciBzZWwgPSBtZS5nZXROYXRpdmUoKTtcclxuICAgICAgICAgICAgICAgIGlmICggc2VsICYmIHNlbC5yYW5nZUNvdW50ICkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBmaXJzdFJhbmdlID0gc2VsLmdldFJhbmdlQXQoIDAgKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdFJhbmdlID0gc2VsLmdldFJhbmdlQXQoIHNlbC5yYW5nZUNvdW50IC0gMSApO1xyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KCBmaXJzdFJhbmdlLnN0YXJ0Q29udGFpbmVyLCBmaXJzdFJhbmdlLnN0YXJ0T2Zmc2V0ICkuc2V0RW5kKCBsYXN0UmFuZ2UuZW5kQ29udGFpbmVyLCBsYXN0UmFuZ2UuZW5kT2Zmc2V0ICk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCByYW5nZS5jb2xsYXBzZWQgJiYgZG9tVXRpbHMuaXNCb2R5KCByYW5nZS5zdGFydENvbnRhaW5lciApICYmICFyYW5nZS5zdGFydE9mZnNldCApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW16ZSggcmFuZ2UgKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vdHJhY2U6MTczNCDmnInlj6/og73lt7Lnu4/kuI3lnKhkb23moJHkuIrkuobvvIzmoIfor4bnmoToioLngrlcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIHRoaXMuX2Jha1JhbmdlICYmIGRvbVV0aWxzLmluRG9jKCB0aGlzLl9iYWtSYW5nZS5zdGFydENvbnRhaW5lciwgdGhpcy5kb2N1bWVudCApICl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9iYWtSYW5nZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW16ZSggcmFuZ2UgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fYmFrUmFuZ2UgPSByYW5nZTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDojrflj5blvIDlp4vlhYPntKDvvIznlKjkuo7nirbmgIHlj43lsIRcclxuICAgICAgICAgKiBAbWV0aG9kIGdldFN0YXJ0XHJcbiAgICAgICAgICogQHJldHVybiB7IEVsZW1lbnQgfSDojrflvpflvIDlp4vlhYPntKBcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBlZGl0b3Iuc2VsZWN0aW9uLmdldFN0YXJ0KCk7XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0U3RhcnQ6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAoIHRoaXMuX2NhY2hlZFN0YXJ0RWxlbWVudCApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9jYWNoZWRTdGFydEVsZW1lbnQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHJhbmdlID0gYnJvd3Nlci5pZTliZWxvdyA/IHRoaXMuZ2V0SUVSYW5nZSgpIDogdGhpcy5nZXRSYW5nZSgpLFxyXG4gICAgICAgICAgICAgICAgdG1wUmFuZ2UsXHJcbiAgICAgICAgICAgICAgICBzdGFydCwgdG1wLCBwYXJlbnQ7XHJcbiAgICAgICAgICAgIGlmICggYnJvd3Nlci5pZTliZWxvdyApIHtcclxuICAgICAgICAgICAgICAgIGlmICggIXJhbmdlICkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vdG9kbyDnu5nnrKzkuIDkuKrlgLzlj6/og73kvJrmnInpl67pophcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kb2N1bWVudC5ib2R5LmZpcnN0Q2hpbGQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvL2NvbnRyb2zlhYPntKBcclxuICAgICAgICAgICAgICAgIGlmICggcmFuZ2UuaXRlbSApe1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByYW5nZS5pdGVtKCAwICk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0bXBSYW5nZSA9IHJhbmdlLmR1cGxpY2F0ZSgpO1xyXG4gICAgICAgICAgICAgICAgLy/kv67mraNpZeS4izxiPng8L2I+W3h4XSDpl63lkIjlkI4gPGI+eHw8L2I+eHhcclxuICAgICAgICAgICAgICAgIHRtcFJhbmdlLnRleHQubGVuZ3RoID4gMCAmJiB0bXBSYW5nZS5tb3ZlU3RhcnQoICdjaGFyYWN0ZXInLCAxICk7XHJcbiAgICAgICAgICAgICAgICB0bXBSYW5nZS5jb2xsYXBzZSggMSApO1xyXG4gICAgICAgICAgICAgICAgc3RhcnQgPSB0bXBSYW5nZS5wYXJlbnRFbGVtZW50KCk7XHJcbiAgICAgICAgICAgICAgICBwYXJlbnQgPSB0bXAgPSByYW5nZS5wYXJlbnRFbGVtZW50KCk7XHJcbiAgICAgICAgICAgICAgICB3aGlsZSAoIHRtcCA9IHRtcC5wYXJlbnROb2RlICkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICggdG1wID09IHN0YXJ0ICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHBhcmVudDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmFuZ2Uuc2hyaW5rQm91bmRhcnkoKTtcclxuICAgICAgICAgICAgICAgIHN0YXJ0ID0gcmFuZ2Uuc3RhcnRDb250YWluZXI7XHJcbiAgICAgICAgICAgICAgICBpZiAoIHN0YXJ0Lm5vZGVUeXBlID09IDEgJiYgc3RhcnQuaGFzQ2hpbGROb2RlcygpICl7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBzdGFydC5jaGlsZE5vZGVzW01hdGgubWluKCBzdGFydC5jaGlsZE5vZGVzLmxlbmd0aCAtIDEsIHJhbmdlLnN0YXJ0T2Zmc2V0ICldO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKCBzdGFydC5ub2RlVHlwZSA9PSAzICl7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0YXJ0LnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHN0YXJ0O1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOW+l+WIsOmAieWMuuS4reeahOaWh+acrFxyXG4gICAgICAgICAqIEBtZXRob2QgZ2V0VGV4dFxyXG4gICAgICAgICAqIEByZXR1cm4geyBTdHJpbmcgfSDpgInljLrkuK3ljIXlkKvnmoTmlofmnKxcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBlZGl0b3Iuc2VsZWN0aW9uLmdldFRleHQoKTtcclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICBnZXRUZXh0OmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIG5hdGl2ZVNlbCwgbmF0aXZlUmFuZ2U7XHJcbiAgICAgICAgICAgIGlmICggdGhpcy5pc0ZvY3VzKCkgJiYgKG5hdGl2ZVNlbCA9IHRoaXMuZ2V0TmF0aXZlKCkpICkge1xyXG4gICAgICAgICAgICAgICAgbmF0aXZlUmFuZ2UgPSBicm93c2VyLmllOWJlbG93ID8gbmF0aXZlU2VsLmNyZWF0ZVJhbmdlKCkgOiBuYXRpdmVTZWwuZ2V0UmFuZ2VBdCggMCApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGJyb3dzZXIuaWU5YmVsb3cgPyBuYXRpdmVSYW5nZS50ZXh0IDogbmF0aXZlUmFuZ2UudG9TdHJpbmcoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5riF6Zmk6YCJ5Yy6XHJcbiAgICAgICAgICogQG1ldGhvZCBjbGVhclJhbmdlXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogZWRpdG9yLnNlbGVjdGlvbi5jbGVhclJhbmdlKCk7XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgY2xlYXJSYW5nZSA6IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0TmF0aXZlKClbYnJvd3Nlci5pZTliZWxvdyA/ICdlbXB0eScgOiAncmVtb3ZlQWxsUmFuZ2VzJ10oKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59KSgpO1xuXG4vLyBjb3JlL0VkaXRvci5qc1xuLyoqXHJcbiAqIOe8lui+keWZqOS4u+exu++8jOWMheWQq+e8lui+keWZqOaPkOS+m+eahOWkp+mDqOWIhuWFrOeUqOaOpeWPo1xyXG4gKiBAZmlsZVxyXG4gKiBAbW9kdWxlIFVFXHJcbiAqIEBjbGFzcyBFZGl0b3JcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG4vKipcclxuICogVUVkaXRvcuWFrOeUqOepuumXtO+8jFVFZGl0b3LmiYDmnInnmoTlip/og73pg73mjILovb3lnKjor6Xnqbrpl7TkuItcclxuICogQHVuZmlsZVxyXG4gKiBAbW9kdWxlIFVFXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIFVFZGl0b3LnmoTmoLjlv4PnsbvvvIzkuLrnlKjmiLfmj5DkvpvkuI7nvJbovpHlmajkuqTkupLnmoTmjqXlj6PjgIJcclxuICogQHVuZmlsZVxyXG4gKiBAbW9kdWxlIFVFXHJcbiAqIEBjbGFzcyBFZGl0b3JcclxuICovXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIHVpZCA9IDAsIF9zZWxlY3Rpb25DaGFuZ2VUaW1lcjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPlue8lui+keWZqOeahGh0bWzlhoXlrrnvvIzotYvlgLzliLDnvJbovpHlmajmiYDlnKjooajljZXnmoR0ZXh0YXJlYeaWh+acrOWfn+mHjOmdolxyXG4gICAgICogQHByaXZhdGVcclxuICAgICAqIEBtZXRob2Qgc2V0VmFsdWVcclxuICAgICAqIEBwYXJhbSB7IFVFLkVkaXRvciB9IGVkaXRvciDnvJbovpHlmajkuovkvotcclxuICAgICAqL1xyXG4gICAgZnVuY3Rpb24gc2V0VmFsdWUoZm9ybSwgZWRpdG9yKSB7XHJcbiAgICAgICAgdmFyIHRleHRhcmVhO1xyXG4gICAgICAgIGlmIChlZGl0b3IudGV4dGFyZWEpIHtcclxuICAgICAgICAgICAgaWYgKHV0aWxzLmlzU3RyaW5nKGVkaXRvci50ZXh0YXJlYSkpIHtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCB0aSwgdGlzID0gZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoZm9ybSwgJ3RleHRhcmVhJyk7IHRpID0gdGlzW2krK107KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRpLmlkID09ICd1ZWRpdG9yX3RleHRhcmVhXycgKyBlZGl0b3Iub3B0aW9ucy50ZXh0YXJlYSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0YXJlYSA9IHRpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0ZXh0YXJlYSA9IGVkaXRvci50ZXh0YXJlYTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRleHRhcmVhKSB7XHJcbiAgICAgICAgICAgIGZvcm0uYXBwZW5kQ2hpbGQodGV4dGFyZWEgPSBkb21VdGlscy5jcmVhdGVFbGVtZW50KGRvY3VtZW50LCAndGV4dGFyZWEnLCB7XHJcbiAgICAgICAgICAgICAgICAnbmFtZSc6IGVkaXRvci5vcHRpb25zLnRleHRhcmVhLFxyXG4gICAgICAgICAgICAgICAgJ2lkJzogJ3VlZGl0b3JfdGV4dGFyZWFfJyArIGVkaXRvci5vcHRpb25zLnRleHRhcmVhLFxyXG4gICAgICAgICAgICAgICAgJ3N0eWxlJzogXCJkaXNwbGF5Om5vbmVcIlxyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgIC8v5LiN6KaB5Lqn55Sf5aSa5LiqdGV4dGFyZWFcclxuICAgICAgICAgICAgZWRpdG9yLnRleHRhcmVhID0gdGV4dGFyZWE7XHJcbiAgICAgICAgfVxyXG4gICAgICAgICF0ZXh0YXJlYS5nZXRBdHRyaWJ1dGUoJ25hbWUnKSAmJiB0ZXh0YXJlYS5zZXRBdHRyaWJ1dGUoJ25hbWUnLCBlZGl0b3Iub3B0aW9ucy50ZXh0YXJlYSApO1xyXG4gICAgICAgIHRleHRhcmVhLnZhbHVlID0gZWRpdG9yLmhhc0NvbnRlbnRzKCkgP1xyXG4gICAgICAgICAgICAoZWRpdG9yLm9wdGlvbnMuYWxsSHRtbEVuYWJsZWQgPyBlZGl0b3IuZ2V0QWxsSHRtbCgpIDogZWRpdG9yLmdldENvbnRlbnQobnVsbCwgbnVsbCwgdHJ1ZSkpIDpcclxuICAgICAgICAgICAgJydcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIGxvYWRQbHVnaW5zKG1lKXtcclxuICAgICAgICAvL+WIneWni+WMluaPkuS7tlxyXG4gICAgICAgIGZvciAodmFyIHBpIGluIFVFLnBsdWdpbnMpIHtcclxuICAgICAgICAgICAgVUUucGx1Z2luc1twaV0uY2FsbChtZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIGNoZWNrQ3VyTGFuZyhJMThOKXtcclxuICAgICAgICBmb3IodmFyIGxhbmcgaW4gSTE4Til7XHJcbiAgICAgICAgICAgIHJldHVybiBsYW5nXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGxhbmdSZWFkaWVkKG1lKXtcclxuICAgICAgICBtZS5sYW5nSXNSZWFkeSA9IHRydWU7XHJcblxyXG4gICAgICAgIG1lLmZpcmVFdmVudChcImxhbmdSZWFkeVwiKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOe8lui+keWZqOWHhuWkh+Wwsee7quWQjuS8muinpuWPkeivpeS6i+S7tlxyXG4gICAgICogQG1vZHVsZSBVRVxyXG4gICAgICogQGNsYXNzIEVkaXRvclxyXG4gICAgICogQGV2ZW50IHJlYWR5XHJcbiAgICAgKiBAcmVtaW5kIHJlbmRlcuaWueazleaJp+ihjOWujOaIkOS5i+WQjizkvJrop6blj5Hor6Xkuovku7ZcclxuICAgICAqIEByZW1pbmRcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiBlZGl0b3IuYWRkTGlzdGVuZXIoICdyZWFkeScsIGZ1bmN0aW9uKCBlZGl0b3IgKSB7XHJcbiAgICAgKiAgICAgZWRpdG9yLmV4ZWNDb21tYW5kKCAnZm9jdXMnICk7IC8v57yW6L6R5Zmo5a625Zyo5a6M5oiQ5ZCO77yM6K6p57yW6L6R5Zmo5ou/5Yiw54Sm54K5XHJcbiAgICAgKiB9ICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgLyoqXHJcbiAgICAgKiDmiafooYxkZXN0cm955pa55rOVLOS8muinpuWPkeivpeS6i+S7tlxyXG4gICAgICogQG1vZHVsZSBVRVxyXG4gICAgICogQGNsYXNzIEVkaXRvclxyXG4gICAgICogQGV2ZW50IGRlc3Ryb3lcclxuICAgICAqIEBzZWUgVUUuRWRpdG9yOmRlc3Ryb3koKVxyXG4gICAgICovXHJcbiAgICAvKipcclxuICAgICAqIOaJp+ihjHJlc2V05pa55rOVLOS8muinpuWPkeivpeS6i+S7tlxyXG4gICAgICogQG1vZHVsZSBVRVxyXG4gICAgICogQGNsYXNzIEVkaXRvclxyXG4gICAgICogQGV2ZW50IHJlc2V0XHJcbiAgICAgKiBAc2VlIFVFLkVkaXRvcjpyZXNldCgpXHJcbiAgICAgKi9cclxuICAgIC8qKlxyXG4gICAgICog5omn6KGMZm9jdXPmlrnms5Us5Lya6Kem5Y+R6K+l5LqL5Lu2XHJcbiAgICAgKiBAbW9kdWxlIFVFXHJcbiAgICAgKiBAY2xhc3MgRWRpdG9yXHJcbiAgICAgKiBAZXZlbnQgZm9jdXNcclxuICAgICAqIEBzZWUgVUUuRWRpdG9yOmZvY3VzKEJvb2xlYW4pXHJcbiAgICAgKi9cclxuICAgIC8qKlxyXG4gICAgICog6K+t6KiA5Yqg6L295a6M5oiQ5Lya6Kem5Y+R6K+l5LqL5Lu2XHJcbiAgICAgKiBAbW9kdWxlIFVFXHJcbiAgICAgKiBAY2xhc3MgRWRpdG9yXHJcbiAgICAgKiBAZXZlbnQgbGFuZ1JlYWR5XHJcbiAgICAgKi9cclxuICAgIC8qKlxyXG4gICAgICog6L+Q6KGM5ZG95Luk5LmL5ZCO5Lya6Kem5Y+R6K+l5ZG95LukXHJcbiAgICAgKiBAbW9kdWxlIFVFXHJcbiAgICAgKiBAY2xhc3MgRWRpdG9yXHJcbiAgICAgKiBAZXZlbnQgYmVmb3JlRXhlY0NvbW1hbmRcclxuICAgICAqL1xyXG4gICAgLyoqXHJcbiAgICAgKiDov5DooYzlkb3ku6TkuYvlkI7kvJrop6blj5Hor6Xlkb3ku6RcclxuICAgICAqIEBtb2R1bGUgVUVcclxuICAgICAqIEBjbGFzcyBFZGl0b3JcclxuICAgICAqIEBldmVudCBhZnRlckV4ZWNDb21tYW5kXHJcbiAgICAgKi9cclxuICAgIC8qKlxyXG4gICAgICog6L+Q6KGM5ZG95Luk5LmL5YmN5Lya6Kem5Y+R6K+l5ZG95LukXHJcbiAgICAgKiBAbW9kdWxlIFVFXHJcbiAgICAgKiBAY2xhc3MgRWRpdG9yXHJcbiAgICAgKiBAZXZlbnQgZmlyc3RCZWZvcmVFeGVjQ29tbWFuZFxyXG4gICAgICovXHJcbiAgICAvKipcclxuICAgICAqIOWcqGdldENvbnRlbnTmlrnms5XmiafooYzkuYvliY3kvJrop6blj5Hor6Xkuovku7ZcclxuICAgICAqIEBtb2R1bGUgVUVcclxuICAgICAqIEBjbGFzcyBFZGl0b3JcclxuICAgICAqIEBldmVudCBiZWZvcmVHZXRDb250ZW50XHJcbiAgICAgKiBAc2VlIFVFLkVkaXRvcjpnZXRDb250ZW50KClcclxuICAgICAqL1xyXG4gICAgLyoqXHJcbiAgICAgKiDlnKhnZXRDb250ZW505pa55rOV5omn6KGM5LmL5ZCO5Lya6Kem5Y+R6K+l5LqL5Lu2XHJcbiAgICAgKiBAbW9kdWxlIFVFXHJcbiAgICAgKiBAY2xhc3MgRWRpdG9yXHJcbiAgICAgKiBAZXZlbnQgYWZ0ZXJHZXRDb250ZW50XHJcbiAgICAgKiBAc2VlIFVFLkVkaXRvcjpnZXRDb250ZW50KClcclxuICAgICAqL1xyXG4gICAgLyoqXHJcbiAgICAgKiDlnKhnZXRBbGxIdG1s5pa55rOV5omn6KGM5pe25Lya6Kem5Y+R6K+l5LqL5Lu2XHJcbiAgICAgKiBAbW9kdWxlIFVFXHJcbiAgICAgKiBAY2xhc3MgRWRpdG9yXHJcbiAgICAgKiBAZXZlbnQgZ2V0QWxsSHRtbFxyXG4gICAgICogQHNlZSBVRS5FZGl0b3I6Z2V0QWxsSHRtbCgpXHJcbiAgICAgKi9cclxuICAgIC8qKlxyXG4gICAgICog5Zyoc2V0Q29udGVudOaWueazleaJp+ihjOS5i+WJjeS8muinpuWPkeivpeS6i+S7tlxyXG4gICAgICogQG1vZHVsZSBVRVxyXG4gICAgICogQGNsYXNzIEVkaXRvclxyXG4gICAgICogQGV2ZW50IGJlZm9yZVNldENvbnRlbnRcclxuICAgICAqIEBzZWUgVUUuRWRpdG9yOnNldENvbnRlbnQoU3RyaW5nKVxyXG4gICAgICovXHJcbiAgICAvKipcclxuICAgICAqIOWcqHNldENvbnRlbnTmlrnms5XmiafooYzkuYvlkI7kvJrop6blj5Hor6Xkuovku7ZcclxuICAgICAqIEBtb2R1bGUgVUVcclxuICAgICAqIEBjbGFzcyBFZGl0b3JcclxuICAgICAqIEBldmVudCBhZnRlclNldENvbnRlbnRcclxuICAgICAqIEBzZWUgVUUuRWRpdG9yOnNldENvbnRlbnQoU3RyaW5nKVxyXG4gICAgICovXHJcbiAgICAvKipcclxuICAgICAqIOavj+W9k+e8lui+keWZqOWGhemDqOmAieWMuuWPkeeUn+aUueWPmOaXtu+8jOWwhuinpuWPkeivpeS6i+S7tlxyXG4gICAgICogQGV2ZW50IHNlbGVjdGlvbmNoYW5nZVxyXG4gICAgICogQHdhcm5pbmcg6K+l5LqL5Lu255qE6Kem5Y+R6Z2e5bi46aKR57mB77yM5LiN5bu66K6u5Zyo6K+l5LqL5Lu255qE5aSE55CG6L+H56iL5Lit5YGa6YeN6YeP57qn55qE5aSE55CGXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogZWRpdG9yLmFkZExpc3RlbmVyKCAnc2VsZWN0aW9uY2hhbmdlJywgZnVuY3Rpb24oIGVkaXRvciApIHtcclxuICAgICAqICAgICBjb25zb2xlLmxvZygn6YCJ5Yy65Y+R55Sf5pS55Y+YJyk7XHJcbiAgICAgKiB9XHJcbiAgICAgKi9cclxuICAgIC8qKlxyXG4gICAgICog5Zyo5omA5pyJc2VsZWN0aW9uY2hhbmdl55qE55uR5ZCs5Ye95pWw5omn6KGM5LmL5YmN77yM5Lya6Kem5Y+R6K+l5LqL5Lu2XHJcbiAgICAgKiBAbW9kdWxlIFVFXHJcbiAgICAgKiBAY2xhc3MgRWRpdG9yXHJcbiAgICAgKiBAZXZlbnQgYmVmb3JlU2VsZWN0aW9uQ2hhbmdlXHJcbiAgICAgKiBAc2VlIFVFLkVkaXRvcjpzZWxlY3Rpb25jaGFuZ2VcclxuICAgICAqL1xyXG4gICAgLyoqXHJcbiAgICAgKiDlnKjmiYDmnIlzZWxlY3Rpb25jaGFuZ2XnmoTnm5HlkKzlh73mlbDmiafooYzlrozkuYvlkI7vvIzkvJrop6blj5Hor6Xkuovku7ZcclxuICAgICAqIEBtb2R1bGUgVUVcclxuICAgICAqIEBjbGFzcyBFZGl0b3JcclxuICAgICAqIEBldmVudCBhZnRlclNlbGVjdGlvbkNoYW5nZVxyXG4gICAgICogQHNlZSBVRS5FZGl0b3I6c2VsZWN0aW9uY2hhbmdlXHJcbiAgICAgKi9cclxuICAgIC8qKlxyXG4gICAgICog57yW6L6R5Zmo5YaF5a655Y+R55Sf5pS55Y+Y5pe25Lya6Kem5Y+R6K+l5LqL5Lu2XHJcbiAgICAgKiBAbW9kdWxlIFVFXHJcbiAgICAgKiBAY2xhc3MgRWRpdG9yXHJcbiAgICAgKiBAZXZlbnQgY29udGVudENoYW5nZVxyXG4gICAgICovXHJcblxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Lul6buY6K6k5Y+C5pWw5p6E5bu65LiA5Liq57yW6L6R5Zmo5a6e5L6LXHJcbiAgICAgKiBAY29uc3RydWN0b3JcclxuICAgICAqIEByZW1pbmQg6YCa6L+HIOaUueaehOmAoOaWueazleWunuS+i+WMlueahOe8lui+keWZqCzkuI3luKZ1aeWxgi7pnIDopoFyZW5kZXLliLDkuIDkuKrlrrnlmags57yW6L6R5Zmo5a6e5L6L5omN6IO95q2j5bi45riy5p+T5Yiw6aG16Z2iXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogdmFyIGVkaXRvciA9IG5ldyBVRS5FZGl0b3IoKTtcclxuICAgICAqIGVkaXRvci5leGVjQ29tbWFuZCgnYmxvZCcpO1xyXG4gICAgICogYGBgXHJcbiAgICAgKiBAc2VlIFVFLkNvbmZpZ1xyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDku6Xnu5nlrprnmoTlj4LmlbDpm4blkIjliJvlu7rkuIDkuKrnvJbovpHlmajlrp7kvovvvIzlr7nkuo7mnKrmjIflrprnmoTlj4LmlbDvvIzlsIblupTnlKjpu5jorqTlj4LmlbDjgIJcclxuICAgICAqIEBjb25zdHJ1Y3RvclxyXG4gICAgICogQHJlbWluZCDpgJrov4cg5pS55p6E6YCg5pa55rOV5a6e5L6L5YyW55qE57yW6L6R5ZmoLOS4jeW4pnVp5bGCLumcgOimgXJlbmRlcuWIsOS4gOS4quWuueWZqCznvJbovpHlmajlrp7kvovmiY3og73mraPluLjmuLLmn5PliLDpobXpnaJcclxuICAgICAqIEBwYXJhbSB7IE9iamVjdCB9IHNldHRpbmcg5Yib5bu657yW6L6R5Zmo55qE5Y+C5pWwXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogdmFyIGVkaXRvciA9IG5ldyBVRS5FZGl0b3IoKTtcclxuICAgICAqIGVkaXRvci5leGVjQ29tbWFuZCgnYmxvZCcpO1xyXG4gICAgICogYGBgXHJcbiAgICAgKiBAc2VlIFVFLkNvbmZpZ1xyXG4gICAgICovXHJcbiAgICB2YXIgRWRpdG9yID0gVUUuRWRpdG9yID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcclxuICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgIG1lLnVpZCA9IHVpZCsrO1xyXG4gICAgICAgIEV2ZW50QmFzZS5jYWxsKG1lKTtcclxuICAgICAgICBtZS5jb21tYW5kcyA9IHt9O1xyXG4gICAgICAgIG1lLm9wdGlvbnMgPSB1dGlscy5leHRlbmQodXRpbHMuY2xvbmUob3B0aW9ucyB8fCB7fSksIFVFRElUT1JfQ09ORklHLCB0cnVlKTtcclxuICAgICAgICBtZS5zaG9ydGN1dGtleXMgPSB7fTtcclxuICAgICAgICBtZS5pbnB1dFJ1bGVzID0gW107XHJcbiAgICAgICAgbWUub3V0cHV0UnVsZXMgPSBbXTtcclxuICAgICAgICAvL+iuvue9rum7mOiupOeahOW4uOeUqOWxnuaAp1xyXG4gICAgICAgIG1lLnNldE9wdChFZGl0b3IuZGVmYXVsdE9wdGlvbnMobWUpKTtcclxuXHJcbiAgICAgICAgLyog5bCd6K+V5byC5q2l5Yqg6L295ZCO5Y+w6YWN572uICovXHJcbiAgICAgICAgbWUubG9hZFNlcnZlckNvbmZpZygpO1xyXG5cclxuICAgICAgICBpZighdXRpbHMuaXNFbXB0eU9iamVjdChVRS5JMThOKSl7XHJcbiAgICAgICAgICAgIC8v5L+u5pS56buY6K6k55qE6K+t6KiA57G75Z6LXHJcbiAgICAgICAgICAgIG1lLm9wdGlvbnMubGFuZyA9IGNoZWNrQ3VyTGFuZyhVRS5JMThOKTtcclxuICAgICAgICAgICAgVUUucGx1Z2luLmxvYWQobWUpO1xyXG4gICAgICAgICAgICBsYW5nUmVhZGllZChtZSk7XHJcblxyXG4gICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICB1dGlscy5sb2FkRmlsZShkb2N1bWVudCwge1xyXG4gICAgICAgICAgICAgICAgc3JjOiBtZS5vcHRpb25zLmxhbmdQYXRoICsgbWUub3B0aW9ucy5sYW5nICsgXCIvXCIgKyBtZS5vcHRpb25zLmxhbmcgKyBcIi5qc1wiLFxyXG4gICAgICAgICAgICAgICAgdGFnOiBcInNjcmlwdFwiLFxyXG4gICAgICAgICAgICAgICAgdHlwZTogXCJ0ZXh0L2phdmFzY3JpcHRcIixcclxuICAgICAgICAgICAgICAgIGRlZmVyOiBcImRlZmVyXCJcclxuICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgVUUucGx1Z2luLmxvYWQobWUpO1xyXG4gICAgICAgICAgICAgICAgbGFuZ1JlYWRpZWQobWUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIFVFLmluc3RhbnRzWyd1ZWRpdG9ySW5zdGFudCcgKyBtZS51aWRdID0gbWU7XHJcbiAgICB9O1xyXG4gICAgRWRpdG9yLnByb3RvdHlwZSA9IHtcclxuICAgICAgICAgcmVnaXN0ZXJDb21tYW5kIDogZnVuY3Rpb24obmFtZSxvYmope1xyXG4gICAgICAgICAgICB0aGlzLmNvbW1hbmRzW25hbWVdID0gb2JqO1xyXG4gICAgICAgICB9LFxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOe8lui+keWZqOWvueWkluaPkOS+m+eahOebkeWQrHJlYWR55LqL5Lu255qE5o6l5Y+j77yMIOmAmui/h+iwg+eUqOivpeaWueazle+8jOi+vuWIsOeahOaViOaenOS4juebkeWQrHJlYWR55LqL5Lu25piv5LiA6Ie055qEXHJcbiAgICAgICAgICogQG1ldGhvZCByZWFkeVxyXG4gICAgICAgICAqIEBwYXJhbSB7IEZ1bmN0aW9uIH0gZm4g57yW6L6R5ZmocmVhZHnkuYvlkI7miYDmiafooYznmoTlm57osIMsIOWmguaenOWcqOazqOWGjOS6i+S7tuS5i+WJjee8lui+keWZqOW3sue7j3JlYWR577yM5bCG5LyaXHJcbiAgICAgICAgICog56uL5Y2z6Kem5Y+R6K+l5Zue6LCD44CCXHJcbiAgICAgICAgICogQHJlbWluZCDpnIDopoHnrYnlvoXnvJbovpHlmajliqDovb3lrozmiJDlkI7miY3og73miafooYznmoTku6PnoIEs5Y+v5Lul5L2/55So6K+l5pa55rOV5Lyg5YWlXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogZWRpdG9yLnJlYWR5KCBmdW5jdGlvbiggZWRpdG9yICkge1xyXG4gICAgICAgICAqICAgICBlZGl0b3Iuc2V0Q29udGVudCgn5Yid5aeL5YyW5a6M5q+VJyk7XHJcbiAgICAgICAgICogfSApO1xyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqIEBzZWUgVUUuRWRpdG9yLmV2ZW50OnJlYWR5XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uIChmbikge1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICBpZiAoZm4pIHtcclxuICAgICAgICAgICAgICAgIG1lLmlzUmVhZHkgPyBmbi5hcHBseShtZSkgOiBtZS5hZGRMaXN0ZW5lcigncmVhZHknLCBmbik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDor6Xmlrnms5XmmK/mj5Dkvpvnu5nmj5Lku7bph4zpnaLkvb/nlKjvvIzorr7nva7phY3nva7pobnpu5jorqTlgLxcclxuICAgICAgICAgKiBAbWV0aG9kIHNldE9wdFxyXG4gICAgICAgICAqIEB3YXJuaW5nIOS4ieWkhOiuvue9rumFjee9rumhueeahOS8mOWFiOe6pzog5a6e5L6L5YyW5pe25Lyg5YWl5Y+C5pWwID4gc2V0T3B0KCnorr7nva4gPiBjb25maWfmlofku7bph4zorr7nva5cclxuICAgICAgICAgKiBAd2FybmluZyDor6Xmlrnms5Xku4XkvpvnvJbovpHlmajmj5Lku7blhoXpg6jlkoznvJbovpHlmajliJ3lp4vljJbml7bosIPnlKjvvIzlhbbku5blnLDmlrnkuI3og73osIPnlKjjgIJcclxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBrZXkg57yW6L6R5Zmo55qE5Y+v5o6l5Y+X55qE6YCJ6aG55ZCN56ewXHJcbiAgICAgICAgICogQHBhcmFtIHsgKiB9IHZhbCAg6K+l6YCJ6aG55Y+v5o6l5Y+X55qE5YC8XHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogZWRpdG9yLnNldE9wdCggJ2luaXRDb250ZW50JywgJ+asoui/juS9v+eUqOe8lui+keWZqCcgKTtcclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6K+l5pa55rOV5piv5o+Q5L6b57uZ5o+S5Lu26YeM6Z2i5L2/55So77yM5Lule2tleTp2YWx1ZX3pm4blkIjnmoTmlrnlvI/orr7nva7mj5Lku7blhoXnlKjliLDnmoTphY3nva7pobnpu5jorqTlgLxcclxuICAgICAgICAgKiBAbWV0aG9kIHNldE9wdFxyXG4gICAgICAgICAqIEB3YXJuaW5nIOS4ieWkhOiuvue9rumFjee9rumhueeahOS8mOWFiOe6pzog5a6e5L6L5YyW5pe25Lyg5YWl5Y+C5pWwID4gc2V0T3B0KCnorr7nva4gPiBjb25maWfmlofku7bph4zorr7nva5cclxuICAgICAgICAgKiBAd2FybmluZyDor6Xmlrnms5Xku4XkvpvnvJbovpHlmajmj5Lku7blhoXpg6jlkoznvJbovpHlmajliJ3lp4vljJbml7bosIPnlKjvvIzlhbbku5blnLDmlrnkuI3og73osIPnlKjjgIJcclxuICAgICAgICAgKiBAcGFyYW0geyBPYmplY3QgfSBvcHRpb25zIOWwhuimgeiuvue9rueahOmAiemhueeahOmUruWAvOWvueWvueixoVxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGVkaXRvci5zZXRPcHQoIHtcclxuICAgICAgICAgKiAgICAgJ2luaXRDb250ZW50JzogJ+asoui/juS9v+eUqOe8lui+keWZqCdcclxuICAgICAgICAgKiB9ICk7XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgc2V0T3B0OiBmdW5jdGlvbiAoa2V5LCB2YWwpIHtcclxuICAgICAgICAgICAgdmFyIG9iaiA9IHt9O1xyXG4gICAgICAgICAgICBpZiAodXRpbHMuaXNTdHJpbmcoa2V5KSkge1xyXG4gICAgICAgICAgICAgICAgb2JqW2tleV0gPSB2YWxcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG9iaiA9IGtleTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB1dGlscy5leHRlbmQodGhpcy5vcHRpb25zLCBvYmosIHRydWUpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0T3B0OmZ1bmN0aW9uKGtleSl7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnNba2V5XVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6ZSA5q+B57yW6L6R5Zmo5a6e5L6L77yM5L2/55SodGV4dGFyZWHku6Pmm79cclxuICAgICAgICAgKiBAbWV0aG9kIGRlc3Ryb3lcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBlZGl0b3IuZGVzdHJveSgpO1xyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHtcclxuXHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnZGVzdHJveScpO1xyXG4gICAgICAgICAgICB2YXIgY29udGFpbmVyID0gbWUuY29udGFpbmVyLnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgIHZhciB0ZXh0YXJlYSA9IG1lLnRleHRhcmVhO1xyXG4gICAgICAgICAgICBpZiAoIXRleHRhcmVhKSB7XHJcbiAgICAgICAgICAgICAgICB0ZXh0YXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RleHRhcmVhJyk7XHJcbiAgICAgICAgICAgICAgICBjb250YWluZXIucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGV4dGFyZWEsIGNvbnRhaW5lcik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0ZXh0YXJlYS5zdHlsZS5kaXNwbGF5ID0gJydcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGV4dGFyZWEuc3R5bGUud2lkdGggPSBtZS5pZnJhbWUub2Zmc2V0V2lkdGggKyAncHgnO1xyXG4gICAgICAgICAgICB0ZXh0YXJlYS5zdHlsZS5oZWlnaHQgPSBtZS5pZnJhbWUub2Zmc2V0SGVpZ2h0ICsgJ3B4JztcclxuICAgICAgICAgICAgdGV4dGFyZWEudmFsdWUgPSBtZS5nZXRDb250ZW50KCk7XHJcbiAgICAgICAgICAgIHRleHRhcmVhLmlkID0gbWUua2V5O1xyXG4gICAgICAgICAgICBjb250YWluZXIuaW5uZXJIVE1MID0gJyc7XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShjb250YWluZXIpO1xyXG4gICAgICAgICAgICB2YXIga2V5ID0gbWUua2V5O1xyXG4gICAgICAgICAgICAvL3RyYWNlOjIwMDRcclxuICAgICAgICAgICAgZm9yICh2YXIgcCBpbiBtZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKG1lLmhhc093blByb3BlcnR5KHApKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXNbcF07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgVUUuZGVsRWRpdG9yKGtleSk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5riy5p+T57yW6L6R5Zmo55qERE9N5Yiw5oyH5a6a5a655ZmoXHJcbiAgICAgICAgICogQG1ldGhvZCByZW5kZXJcclxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjb250YWluZXJJZCDmjIflrprkuIDkuKrlrrnlmahJRFxyXG4gICAgICAgICAqIEByZW1pbmQg5omn6KGM6K+l5pa55rOVLOS8muinpuWPkXJlYWR55LqL5Lu2XHJcbiAgICAgICAgICogQHdhcm5pbmcg5b+F6aG75LiU5Y+q6IO96LCD55So5LiA5qyhXHJcbiAgICAgICAgICovXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOa4suafk+e8lui+keWZqOeahERPTeWIsOaMh+WumuWuueWZqFxyXG4gICAgICAgICAqIEBtZXRob2QgcmVuZGVyXHJcbiAgICAgICAgICogQHBhcmFtIHsgRWxlbWVudCB9IGNvbnRhaW5lckRvbSDnm7TmjqXmjIflrprlrrnlmajlr7nosaFcclxuICAgICAgICAgKiBAcmVtaW5kIOaJp+ihjOivpeaWueazlSzkvJrop6blj5FyZWFkeeS6i+S7tlxyXG4gICAgICAgICAqIEB3YXJuaW5nIOW/hemhu+S4lOWPquiDveiwg+eUqOS4gOasoVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHJlbmRlcjogZnVuY3Rpb24gKGNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzLFxyXG4gICAgICAgICAgICAgICAgb3B0aW9ucyA9IG1lLm9wdGlvbnMsXHJcbiAgICAgICAgICAgICAgICBnZXRTdHlsZVZhbHVlPWZ1bmN0aW9uKGF0dHIpe1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZUludChkb21VdGlscy5nZXRDb21wdXRlZFN0eWxlKGNvbnRhaW5lcixhdHRyKSk7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBpZiAodXRpbHMuaXNTdHJpbmcoY29udGFpbmVyKSkge1xyXG4gICAgICAgICAgICAgICAgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY29udGFpbmVyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoY29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgICAgICBpZihvcHRpb25zLmluaXRpYWxGcmFtZVdpZHRoKXtcclxuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm1pbkZyYW1lV2lkdGggPSBvcHRpb25zLmluaXRpYWxGcmFtZVdpZHRoXHJcbiAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm1pbkZyYW1lV2lkdGggPSBvcHRpb25zLmluaXRpYWxGcmFtZVdpZHRoID0gY29udGFpbmVyLm9mZnNldFdpZHRoO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYob3B0aW9ucy5pbml0aWFsRnJhbWVIZWlnaHQpe1xyXG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnMubWluRnJhbWVIZWlnaHQgPSBvcHRpb25zLmluaXRpYWxGcmFtZUhlaWdodFxyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5pbml0aWFsRnJhbWVIZWlnaHQgPSBvcHRpb25zLm1pbkZyYW1lSGVpZ2h0ID0gY29udGFpbmVyLm9mZnNldEhlaWdodDtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBjb250YWluZXIuc3R5bGUud2lkdGggPSAvJSQvLnRlc3Qob3B0aW9ucy5pbml0aWFsRnJhbWVXaWR0aCkgPyAgJzEwMCUnIDogb3B0aW9ucy5pbml0aWFsRnJhbWVXaWR0aC1cclxuICAgICAgICAgICAgICAgICAgICBnZXRTdHlsZVZhbHVlKFwicGFkZGluZy1sZWZ0XCIpLSBnZXRTdHlsZVZhbHVlKFwicGFkZGluZy1yaWdodFwiKSArJ3B4JztcclxuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5zdHlsZS5oZWlnaHQgPSAvJSQvLnRlc3Qob3B0aW9ucy5pbml0aWFsRnJhbWVIZWlnaHQpID8gICcxMDAlJyA6IG9wdGlvbnMuaW5pdGlhbEZyYW1lSGVpZ2h0IC1cclxuICAgICAgICAgICAgICAgICAgICBnZXRTdHlsZVZhbHVlKFwicGFkZGluZy10b3BcIiktIGdldFN0eWxlVmFsdWUoXCJwYWRkaW5nLWJvdHRvbVwiKSArJ3B4JztcclxuXHJcbiAgICAgICAgICAgICAgICBjb250YWluZXIuc3R5bGUuekluZGV4ID0gb3B0aW9ucy56SW5kZXg7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIGh0bWwgPSAoIGllICYmIGJyb3dzZXIudmVyc2lvbiA8IDkgID8gJycgOiAnPCFET0NUWVBFIGh0bWw+JykgK1xyXG4gICAgICAgICAgICAgICAgICAgICc8aHRtbCB4bWxucz1cXCdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sXFwnIGNsYXNzPVxcJ3ZpZXdcXCcgPjxoZWFkPicgK1xyXG4gICAgICAgICAgICAgICAgICAgICc8c3R5bGUgdHlwZT1cXCd0ZXh0L2Nzc1xcJz4nICtcclxuICAgICAgICAgICAgICAgICAgICAvL+iuvue9ruWbm+WRqOeahOeVmei+uVxyXG4gICAgICAgICAgICAgICAgICAgICcudmlld3twYWRkaW5nOjA7d29yZC13cmFwOmJyZWFrLXdvcmQ7Y3Vyc29yOnRleHQ7aGVpZ2h0OjkwJTt9XFxuJyArXHJcbiAgICAgICAgICAgICAgICAgICAgLy/orr7nva7pu5jorqTlrZfkvZPlkozlrZflj7dcclxuICAgICAgICAgICAgICAgICAgICAvL2ZvbnQtZmFtaWx55LiN6IO95ZGi6ZqP5L6/5pS577yM5Zyoc2FmYXJp5LiLZmlsbGNoYXLkvJrmnInop6PmnpDpl67pophcclxuICAgICAgICAgICAgICAgICAgICAnYm9keXttYXJnaW46OHB4O2ZvbnQtZmFtaWx5OnNhbnMtc2VyaWY7Zm9udC1zaXplOjE2cHg7fScgK1xyXG4gICAgICAgICAgICAgICAgICAgIC8v6K6+572u5q616JC96Ze06LedXHJcbiAgICAgICAgICAgICAgICAgICAgJ3B7bWFyZ2luOjVweCAwO308L3N0eWxlPicgK1xyXG4gICAgICAgICAgICAgICAgICAgICggb3B0aW9ucy5pZnJhbWVDc3NVcmwgPyAnPGxpbmsgcmVsPVxcJ3N0eWxlc2hlZXRcXCcgdHlwZT1cXCd0ZXh0L2Nzc1xcJyBocmVmPVxcJycgKyB1dGlscy51bmh0bWwob3B0aW9ucy5pZnJhbWVDc3NVcmwpICsgJ1xcJy8+JyA6ICcnICkgK1xyXG4gICAgICAgICAgICAgICAgICAgIChvcHRpb25zLmluaXRpYWxTdHlsZSA/ICc8c3R5bGU+JyArIG9wdGlvbnMuaW5pdGlhbFN0eWxlICsgJzwvc3R5bGU+JyA6ICcnKSArXHJcbiAgICAgICAgICAgICAgICAgICAgJzwvaGVhZD48Ym9keSBjbGFzcz1cXCd2aWV3XFwnID48L2JvZHk+JyArXHJcbiAgICAgICAgICAgICAgICAgICAgJzxzY3JpcHQgdHlwZT1cXCd0ZXh0L2phdmFzY3JpcHRcXCcgJyArIChpZSA/ICdkZWZlcj1cXCdkZWZlclxcJycgOiAnJyApICsnIGlkPVxcJ19pbml0aWFsU2NyaXB0XFwnPicgK1xyXG4gICAgICAgICAgICAgICAgICAgICdzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7ZWRpdG9yID0gd2luZG93LnBhcmVudC5VRS5pbnN0YW50c1tcXCd1ZWRpdG9ySW5zdGFudCcgKyBtZS51aWQgKyAnXFwnXTtlZGl0b3IuX3NldHVwKGRvY3VtZW50KTt9LDApOycgK1xyXG4gICAgICAgICAgICAgICAgICAgICd2YXIgX3RtcFNjcmlwdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFxcJ19pbml0aWFsU2NyaXB0XFwnKTtfdG1wU2NyaXB0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoX3RtcFNjcmlwdCk7PC9zY3JpcHQ+PC9odG1sPic7XHJcbiAgICAgICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZG9tVXRpbHMuY3JlYXRlRWxlbWVudChkb2N1bWVudCwgJ2lmcmFtZScsIHtcclxuICAgICAgICAgICAgICAgICAgICBpZDogJ3VlZGl0b3JfJyArIG1lLnVpZCxcclxuICAgICAgICAgICAgICAgICAgICB3aWR0aDogXCIxMDAlXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBcIjEwMCVcIixcclxuICAgICAgICAgICAgICAgICAgICBmcmFtZWJvcmRlcjogXCIwXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgLy/lhYjms6jph4rmjonkuobvvIzliqDnmoTljp/lm6Dlv5jorrDkuobvvIzkvYblvIDlkK/kvJrnm7TmjqXlr7zoh7TlhajlsY/mqKHlvI/kuIvlhoXlrrnlpJrml7bkuI3kvJrlh7rnjrDmu5rliqjmnaFcclxuLy8gICAgICAgICAgICAgICAgICAgIHNjcm9sbGluZyA6J25vJyxcclxuICAgICAgICAgICAgICAgICAgICBzcmM6ICdqYXZhc2NyaXB0OnZvaWQoZnVuY3Rpb24oKXtkb2N1bWVudC5vcGVuKCk7JyArIChvcHRpb25zLmN1c3RvbURvbWFpbiAmJiBkb2N1bWVudC5kb21haW4gIT0gbG9jYXRpb24uaG9zdG5hbWUgPyAgJ2RvY3VtZW50LmRvbWFpbj1cIicgKyBkb2N1bWVudC5kb21haW4gKyAnXCI7JyA6ICcnKSArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICdkb2N1bWVudC53cml0ZShcIicgKyBodG1sICsgJ1wiKTtkb2N1bWVudC5jbG9zZSgpO30oKSknXHJcbiAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICBjb250YWluZXIuc3R5bGUub3ZlcmZsb3cgPSAnaGlkZGVuJztcclxuICAgICAgICAgICAgICAgIC8v6Kej5Yaz5aaC5p6c5piv57uZ5a6a55qE55m+5YiG5q+U77yM5Lya5a+86Ie06auY5bqm566X5LiN5a+555qE6Zeu6aKYXHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoIC8lJC8udGVzdChvcHRpb25zLmluaXRpYWxGcmFtZVdpZHRoKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMubWluRnJhbWVXaWR0aCA9IG9wdGlvbnMuaW5pdGlhbEZyYW1lV2lkdGggPSBjb250YWluZXIub2Zmc2V0V2lkdGg7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8v5aaC5p6c6L+Z6YeM57uZ5a6a5a695bqm77yM5Lya5a+86Ie0aWXlnKjmi5bliqjnqpflj6PlpKflsI/ml7bvvIznvJbovpHljLrln5/kuI3pmo/nnYDlj5jljJZcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuc3R5bGUud2lkdGggPSBvcHRpb25zLmluaXRpYWxGcmFtZVdpZHRoICsgJ3B4JztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoLyUkLy50ZXN0KG9wdGlvbnMuaW5pdGlhbEZyYW1lSGVpZ2h0KSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMubWluRnJhbWVIZWlnaHQgPSBvcHRpb25zLmluaXRpYWxGcmFtZUhlaWdodCA9IGNvbnRhaW5lci5vZmZzZXRIZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5zdHlsZS5oZWlnaHQgPSBvcHRpb25zLmluaXRpYWxGcmFtZUhlaWdodCArICdweCc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOe8lui+keWZqOWIneWni+WMllxyXG4gICAgICAgICAqIEBtZXRob2QgX3NldHVwXHJcbiAgICAgICAgICogQHByaXZhdGVcclxuICAgICAgICAgKiBAcGFyYW0geyBFbGVtZW50IH0gZG9jIOe8lui+keWZqElmcmFtZeS4reeahOaWh+aho+WvueixoVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIF9zZXR1cDogZnVuY3Rpb24gKGRvYykge1xyXG5cclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBtZS5vcHRpb25zO1xyXG4gICAgICAgICAgICBpZiAoaWUpIHtcclxuICAgICAgICAgICAgICAgIGRvYy5ib2R5LmRpc2FibGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGRvYy5ib2R5LmNvbnRlbnRFZGl0YWJsZSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBkb2MuYm9keS5kaXNhYmxlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZG9jLmJvZHkuY29udGVudEVkaXRhYmxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBkb2MuYm9keS5zcGVsbGNoZWNrID0gZmFsc2U7XHJcbiAgICAgICAgICAgIG1lLmRvY3VtZW50ID0gZG9jO1xyXG4gICAgICAgICAgICBtZS53aW5kb3cgPSBkb2MuZGVmYXVsdFZpZXcgfHwgZG9jLnBhcmVudFdpbmRvdztcclxuICAgICAgICAgICAgbWUuaWZyYW1lID0gbWUud2luZG93LmZyYW1lRWxlbWVudDtcclxuICAgICAgICAgICAgbWUuYm9keSA9IGRvYy5ib2R5O1xyXG4gICAgICAgICAgICBtZS5zZWxlY3Rpb24gPSBuZXcgZG9tLlNlbGVjdGlvbihkb2MpO1xyXG4gICAgICAgICAgICAvL2dlY2tv5Yid5aeL5YyW5bCx6IO95b6X5YiwcmFuZ2Us5peg5rOV5Yik5pataXNGb2N1c+S6hlxyXG4gICAgICAgICAgICB2YXIgZ2Vja29TZWw7XHJcbiAgICAgICAgICAgIGlmIChicm93c2VyLmdlY2tvICYmIChnZWNrb1NlbCA9IHRoaXMuc2VsZWN0aW9uLmdldE5hdGl2ZSgpKSkge1xyXG4gICAgICAgICAgICAgICAgZ2Vja29TZWwucmVtb3ZlQWxsUmFuZ2VzKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5faW5pdEV2ZW50cygpO1xyXG4gICAgICAgICAgICAvL+S4umZvcm3mj5DkuqTmj5DkvpvkuIDkuKrpmpDol4/nmoR0ZXh0YXJlYVxyXG4gICAgICAgICAgICBmb3IgKHZhciBmb3JtID0gdGhpcy5pZnJhbWUucGFyZW50Tm9kZTsgIWRvbVV0aWxzLmlzQm9keShmb3JtKTsgZm9ybSA9IGZvcm0ucGFyZW50Tm9kZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGZvcm0udGFnTmFtZSA9PSAnRk9STScpIHtcclxuICAgICAgICAgICAgICAgICAgICBtZS5mb3JtID0gZm9ybTtcclxuICAgICAgICAgICAgICAgICAgICBpZihtZS5vcHRpb25zLmF1dG9TeW5jRGF0YSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLm9uKG1lLndpbmRvdywnYmx1cicsZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFZhbHVlKGZvcm0sbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMub24oZm9ybSwgJ3N1Ym1pdCcsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFZhbHVlKHRoaXMsIG1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChvcHRpb25zLmluaXRpYWxDb250ZW50KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5hdXRvQ2xlYXJpbml0aWFsQ29udGVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBvbGRFeGVjQ29tbWFuZCA9IG1lLmV4ZWNDb21tYW5kO1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ2ZpcnN0QmVmb3JlRXhlY0NvbW1hbmQnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9sZEV4ZWNDb21tYW5kLmFwcGx5KG1lLCBhcmd1bWVudHMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2V0RGVmYXVsdENvbnRlbnQob3B0aW9ucy5pbml0aWFsQ29udGVudCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2VcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldENvbnRlbnQob3B0aW9ucy5pbml0aWFsQ29udGVudCwgZmFsc2UsIHRydWUpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvL+e8lui+keWZqOS4jeiDveS4uuepuuWGheWuuVxyXG5cclxuICAgICAgICAgICAgaWYgKGRvbVV0aWxzLmlzRW1wdHlOb2RlKG1lLmJvZHkpKSB7XHJcbiAgICAgICAgICAgICAgICBtZS5ib2R5LmlubmVySFRNTCA9ICc8cD4nICsgKGJyb3dzZXIuaWUgPyAnJyA6ICc8YnIvPicpICsgJzwvcD4nO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8v5aaC5p6c6KaB5rGCZm9jdXMsIOWwseaKiuWFieagh+WumuS9jeWIsOWGheWuueW8gOWni1xyXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5mb2N1cykge1xyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuZm9jdXMobWUub3B0aW9ucy5mb2N1c0luRW5kKTtcclxuICAgICAgICAgICAgICAgICAgICAvL+WmguaenOiHquWKqOa4hemZpOW8gOedgO+8jOWwseS4jemcgOimgeWBmnNlbGVjdGlvbmNoYW5nZTtcclxuICAgICAgICAgICAgICAgICAgICAhbWUub3B0aW9ucy5hdXRvQ2xlYXJpbml0aWFsQ29udGVudCAmJiBtZS5fc2VsZWN0aW9uQ2hhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICB9LCAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIW1lLmNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICAgICAgbWUuY29udGFpbmVyID0gdGhpcy5pZnJhbWUucGFyZW50Tm9kZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5mdWxsc2NyZWVuICYmIG1lLnVpKSB7XHJcbiAgICAgICAgICAgICAgICBtZS51aS5zZXRGdWxsU2NyZWVuKHRydWUpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgbWUuZG9jdW1lbnQuZXhlY0NvbW1hbmQoJzJELXBvc2l0aW9uJywgZmFsc2UsIGZhbHNlKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBtZS5kb2N1bWVudC5leGVjQ29tbWFuZCgnZW5hYmxlSW5saW5lVGFibGVFZGl0aW5nJywgZmFsc2UsIGZhbHNlKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBtZS5kb2N1bWVudC5leGVjQ29tbWFuZCgnZW5hYmxlT2JqZWN0UmVzaXppbmcnLCBmYWxzZSwgZmFsc2UpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8v5oyC5o6l5b+r5o236ZSuXHJcbiAgICAgICAgICAgIG1lLl9iaW5kc2hvcnRjdXRLZXlzKCk7XHJcbiAgICAgICAgICAgIG1lLmlzUmVhZHkgPSAxO1xyXG4gICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3JlYWR5Jyk7XHJcbiAgICAgICAgICAgIG9wdGlvbnMub25yZWFkeSAmJiBvcHRpb25zLm9ucmVhZHkuY2FsbChtZSk7XHJcbiAgICAgICAgICAgIGlmICghYnJvd3Nlci5pZTliZWxvdykge1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMub24obWUud2luZG93LCBbJ2JsdXInLCAnZm9jdXMnXSwgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAvL2Nocm9tZeS4i+S8muWHuueOsGFsdCt0YWLliIfmjaLml7bvvIzlr7zoh7TpgInljLrkvY3nva7kuI3lr7lcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZS50eXBlID09ICdibHVyJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5fYmFrUmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLl9iYWtOYXRpdmVSYW5nZSA9IG1lLnNlbGVjdGlvbi5nZXROYXRpdmUoKS5nZXRSYW5nZUF0KDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuc2VsZWN0aW9uLmdldE5hdGl2ZSgpLnJlbW92ZUFsbFJhbmdlcygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5fYmFrTmF0aXZlUmFuZ2UgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5fYmFrUmFuZ2UgJiYgbWUuX2Jha1JhbmdlLnNlbGVjdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvL3RyYWNlOjE1MTggZmYzLjZib2R55LiN5aSf5a+b77yM5Lya5a+86Ie054K55Ye756m655m95aSE5peg5rOV6I635b6X54Sm54K5XHJcbiAgICAgICAgICAgIGlmIChicm93c2VyLmdlY2tvICYmIGJyb3dzZXIudmVyc2lvbiA8PSAxMDkwMikge1xyXG4gICAgICAgICAgICAgICAgLy/kv67lpI1mZjMuNuWIneWni+WMlui/m+adpe+8jOS4jeiDveeCueWHu+iOt+W+l+eEpueCuVxyXG4gICAgICAgICAgICAgICAgbWUuYm9keS5jb250ZW50RWRpdGFibGUgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmJvZHkuY29udGVudEVkaXRhYmxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH0sIDEwMCk7XHJcbiAgICAgICAgICAgICAgICBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuYm9keS5zdHlsZS5oZWlnaHQgPSBtZS5pZnJhbWUub2Zmc2V0SGVpZ2h0IC0gMjAgKyAncHgnXHJcbiAgICAgICAgICAgICAgICB9LCAxMDApXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICFvcHRpb25zLmlzU2hvdyAmJiBtZS5zZXRIaWRlKCk7XHJcbiAgICAgICAgICAgIG9wdGlvbnMucmVhZG9ubHkgJiYgbWUuc2V0RGlzYWJsZWQoKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDlkIzmraXmlbDmja7liLDnvJbovpHlmajmiYDlnKjnmoRmb3JtXHJcbiAgICAgICAgICog5LuO57yW6L6R5Zmo55qE5a655Zmo6IqC54K55ZCR5LiK5p+l5om+Zm9ybeWFg+e0oO+8jOiLpeaJvuWIsO+8jOWwseWQjOatpee8lui+keWGheWuueWIsOaJvuWIsOeahGZvcm3ph4zvvIzkuLrmj5DkuqTmlbDmja7lgZrlh4blpIfvvIzkuLvopoHnlKjkuo7mmK/miYvliqjmj5DkuqTnmoTmg4XlhrVcclxuICAgICAgICAgKiDlkI7lj7Dlj5blvpfmlbDmja7nmoTplK7lgLzvvIzkvb/nlKjkvaDlrrnlmajkuIrnmoRuYW1l5bGe5oCn77yM5aaC5p6c5rKh5pyJ5bCx5L2/55So5Y+C5pWw6YeM55qEdGV4dGFyZWHpoblcclxuICAgICAgICAgKiBAbWV0aG9kIHN5bmNcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBlZGl0b3Iuc3luYygpO1xyXG4gICAgICAgICAqIGZvcm0uc3VtYml0KCk7IC8vZm9ybeWPmOmHj+W3sue7j+aMh+WQkeS6hmZvcm3lhYPntKBcclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5qC55o2u5Lyg5YWl55qEZm9ybUlk77yM5Zyo6aG16Z2i5LiK5p+l5om+6KaB5ZCM5q2l5pWw5o2u55qE6KGo5Y2V77yM6Iul5om+5Yiw77yM5bCx5ZCM5q2l57yW6L6R5YaF5a655Yiw5om+5Yiw55qEZm9ybemHjO+8jOS4uuaPkOS6pOaVsOaNruWBmuWHhuWkh1xyXG4gICAgICAgICAqIOWQjuWPsOWPluW+l+aVsOaNrueahOmUruWAvO+8jOivpemUruWAvOm7mOiupOS9v+eUqOe7meWumueahOe8lui+keWZqOWuueWZqOeahG5hbWXlsZ7mgKfvvIzlpoLmnpzmsqHmnIluYW1l5bGe5oCn5YiZ5L2/55So5Y+C5pWw6aG56YeM57uZ5a6a55qE4oCcdGV4dGFyZWHigJ3poblcclxuICAgICAgICAgKiBAbWV0aG9kIHN5bmNcclxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBmb3JtSUQg5oyH5a6a5LiA5Liq6KaB5ZCM5q2l5pWw5o2u55qEZm9ybeeahGlkLOe8lui+keWZqOeahOaVsOaNruS8muWQjOatpeWIsOS9oOaMh+WummZvcm3kuItcclxuICAgICAgICAgKi9cclxuICAgICAgICBzeW5jOiBmdW5jdGlvbiAoZm9ybUlkKSB7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgICAgICAgICBmb3JtID0gZm9ybUlkID8gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZm9ybUlkKSA6XHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuZmluZFBhcmVudChtZS5pZnJhbWUucGFyZW50Tm9kZSwgZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUudGFnTmFtZSA9PSAnRk9STSdcclxuICAgICAgICAgICAgICAgICAgICB9LCB0cnVlKTtcclxuICAgICAgICAgICAgZm9ybSAmJiBzZXRWYWx1ZShmb3JtLCBtZSk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6K6+572u57yW6L6R5Zmo6auY5bqmXHJcbiAgICAgICAgICogQG1ldGhvZCBzZXRIZWlnaHRcclxuICAgICAgICAgKiBAcmVtaW5kIOW9k+mFjee9rumhuWF1dG9IZWlnaHRFbmFibGVk5Li655yf5pe2LOivpeaWueazleaXoOaViFxyXG4gICAgICAgICAqIEBwYXJhbSB7IE51bWJlciB9IG51bWJlciDorr7nva7nmoTpq5jluqblgLzvvIznuq/mlbDlgLzvvIzkuI3luKbljZXkvY1cclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBlZGl0b3Iuc2V0SGVpZ2h0KG51bWJlcik7XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgc2V0SGVpZ2h0OiBmdW5jdGlvbiAoaGVpZ2h0LG5vdFNldEhlaWdodCkge1xyXG4gICAgICAgICAgICBpZiAoaGVpZ2h0ICE9PSBwYXJzZUludCh0aGlzLmlmcmFtZS5wYXJlbnROb2RlLnN0eWxlLmhlaWdodCkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaWZyYW1lLnBhcmVudE5vZGUuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgJ3B4JztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAhbm90U2V0SGVpZ2h0ICYmICh0aGlzLm9wdGlvbnMubWluRnJhbWVIZWlnaHQgPSB0aGlzLm9wdGlvbnMuaW5pdGlhbEZyYW1lSGVpZ2h0ID0gaGVpZ2h0KTtcclxuICAgICAgICAgICAgdGhpcy5ib2R5LnN0eWxlLmhlaWdodCA9IGhlaWdodCArICdweCc7XHJcbiAgICAgICAgICAgICFub3RTZXRIZWlnaHQgJiYgdGhpcy50cmlnZ2VyKCdzZXRIZWlnaHQnKVxyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOS4uue8lui+keWZqOeahOe8lui+keWRveS7pOaPkOS+m+W/q+aNt+mUrlxyXG4gICAgICAgICAqIOi/meS4quaOpeWPo+aYr+S4uuaPkuS7tuaJqeWxleaPkOS+m+eahOaOpeWPoyzkuLvopoHmmK/kuLrmlrDmt7vliqDnmoTmj5Lku7bvvIzlpoLmnpzpnIDopoHmt7vliqDlv6vmjbfplK7vvIzmiYDmj5DkvpvnmoTmjqXlj6NcclxuICAgICAgICAgKiBAbWV0aG9kIGFkZHNob3J0Y3V0a2V5XHJcbiAgICAgICAgICogQHBhcmFtIHsgT2JqZWN0IH0ga2V5c2V0IOWRveS7pOWQjeWSjOW/q+aNt+mUrumUruWAvOWvueWvueixoe+8jOWkmuS4quaMiemSrueahOW/q+aNt+mUrueUqOKAnO+8i+KAneWIhumalFxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGVkaXRvci5hZGRzaG9ydGN1dGtleSh7XHJcbiAgICAgICAgICogICAgIFwiQm9sZFwiIDogXCJjdHJsKzY2XCIsLy9eQlxyXG4gICAgICAgICAqICAgICBcIkl0YWxpY1wiIDogXCJjdHJsKzczXCIsIC8vXklcclxuICAgICAgICAgKiB9KTtcclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDov5nkuKrmjqXlj6PmmK/kuLrmj5Lku7bmianlsZXmj5DkvpvnmoTmjqXlj6Ms5Li76KaB5piv5Li65paw5re75Yqg55qE5o+S5Lu277yM5aaC5p6c6ZyA6KaB5re75Yqg5b+r5o236ZSu77yM5omA5o+Q5L6b55qE5o6l5Y+jXHJcbiAgICAgICAgICogQG1ldGhvZCBhZGRzaG9ydGN1dGtleVxyXG4gICAgICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDop6blj5Hlv6vmjbfplK7ml7bvvIzlk43lupTnmoTlkb3ku6RcclxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBrZXlzIOW/q+aNt+mUrueahOWtl+espuS4su+8jOWkmuS4quaMiemSrueUqOKAnO+8i+KAneWIhumalFxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGVkaXRvci5hZGRzaG9ydGN1dGtleShcIlVuZGVybGluZVwiLCBcImN0cmwrODVcIik7IC8vXlVcclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICBhZGRzaG9ydGN1dGtleTogZnVuY3Rpb24gKGNtZCwga2V5cykge1xyXG4gICAgICAgICAgICB2YXIgb2JqID0ge307XHJcbiAgICAgICAgICAgIGlmIChrZXlzKSB7XHJcbiAgICAgICAgICAgICAgICBvYmpbY21kXSA9IGtleXNcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG9iaiA9IGNtZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB1dGlscy5leHRlbmQodGhpcy5zaG9ydGN1dGtleXMsIG9iailcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDlr7nnvJbovpHlmajorr7nva5rZXlkb3du5LqL5Lu255uR5ZCs77yM57uR5a6a5b+r5o236ZSu5ZKM5ZG95Luk77yM5b2T5b+r5o236ZSu57uE5ZCI6Kem5Y+R5oiQ5Yqf77yM5Lya5ZON5bqU5a+55bqU55qE5ZG95LukXHJcbiAgICAgICAgICogQG1ldGhvZCBfYmluZHNob3J0Y3V0S2V5c1xyXG4gICAgICAgICAqIEBwcml2YXRlXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgX2JpbmRzaG9ydGN1dEtleXM6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcywgc2hvcnRjdXRrZXlzID0gdGhpcy5zaG9ydGN1dGtleXM7XHJcbiAgICAgICAgICAgIG1lLmFkZExpc3RlbmVyKCdrZXlkb3duJywgZnVuY3Rpb24gKHR5cGUsIGUpIHtcclxuICAgICAgICAgICAgICAgIHZhciBrZXlDb2RlID0gZS5rZXlDb2RlIHx8IGUud2hpY2g7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIHNob3J0Y3V0a2V5cykge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB0bXAgPSBzaG9ydGN1dGtleXNbaV0uc3BsaXQoJywnKTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciB0ID0gMCwgdGk7IHRpID0gdG1wW3QrK107KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpID0gdGkuc3BsaXQoJzonKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IHRpWzBdLCBwYXJhbSA9IHRpWzFdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoL14oY3RybCkoXFwrc2hpZnQpP1xcKyhcXGQrKSQvLnRlc3Qoa2V5LnRvTG93ZXJDYXNlKCkpIHx8IC9eKFxcZCspJC8udGVzdChrZXkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKCAoUmVnRXhwLiQxID09ICdjdHJsJyA/IChlLmN0cmxLZXkgfHwgZS5tZXRhS2V5KSA6IDApXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgKFJlZ0V4cC4kMiAhPSBcIlwiID8gZVtSZWdFeHAuJDIuc2xpY2UoMSkgKyBcIktleVwiXSA6IDEpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYga2V5Q29kZSA9PSBSZWdFeHAuJDNcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5Q29kZSA9PSBSZWdFeHAuJDFcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWUucXVlcnlDb21tYW5kU3RhdGUoaSxwYXJhbSkgIT0gLTEpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKGksIHBhcmFtKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5wcmV2ZW50RGVmYXVsdChlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOiOt+WPlue8lui+keWZqOeahOWGheWuuVxyXG4gICAgICAgICAqIEBtZXRob2QgZ2V0Q29udGVudFxyXG4gICAgICAgICAqIEB3YXJuaW5nIOivpeaWueazleiOt+WPluWIsOeahOaYr+e7j+i/h+e8lui+keWZqOWGhee9rueahOi/h+a7pOinhOWImei/m+ihjOi/h+a7pOWQjuW+l+WIsOeahOWGheWuuVxyXG4gICAgICAgICAqIEByZXR1cm4geyBTdHJpbmcgfSDnvJbovpHlmajnmoTlhoXlrrnlrZfnrKbkuLIsIOWmguaenOe8lui+keWZqOeahOWGheWuueS4uuepuu+8jOaIluiAheaYr+epuueahOagh+etvuWGheWuue+8iOWmgjrigJ0mbHQ7cCZndDsmbHQ7YnIvJmd0OyZsdDsvcCZndDvigJzvvInvvIwg5YiZ6L+U5Zue56m65a2X56ym5LiyXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogLy/nvJbovpHlmahodG1s5YaF5a65OjxwPjE8c3Ryb25nPjI8ZW0+MzQ8L2VtPjU8L3N0cm9uZz42PC9wPlxyXG4gICAgICAgICAqIHZhciBjb250ZW50ID0gZWRpdG9yLmdldENvbnRlbnQoKTsgLy/ov5Tlm57lgLw6PHA+MTxzdHJvbmc+MjxlbT4zNDwvZW0+NTwvc3Ryb25nPjY8L3A+XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOiOt+WPlue8lui+keWZqOeahOWGheWuueOAgiDlj6/ku6XpgJrov4flj4LmlbDlrprkuYnnvJbovpHlmajlhoXnva7nmoTliKTnqbrop4TliJlcclxuICAgICAgICAgKiBAbWV0aG9kIGdldENvbnRlbnRcclxuICAgICAgICAgKiBAcGFyYW0geyBGdW5jdGlvbiB9IGZuIOiHquWumueahOWIpOepuuinhOWIme+8jCDopoHmsYLor6Xmlrnms5Xov5Tlm57kuIDkuKpib29sZWFu57G75Z6L55qE5YC877yMXHJcbiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAg5Luj6KGo5b2T5YmN57yW6L6R5Zmo55qE5YaF5a655piv5ZCm56m677yMXHJcbiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAg5aaC5p6c6L+U5ZuedHJ1Ze+8jCDliJnor6Xmlrnms5XlsIbnm7TmjqXov5Tlm57nqbrlrZfnrKbkuLLvvJvlpoLmnpzov5Tlm55mYWxzZe+8jOWImee8lui+keWZqOWwhui/lOWbnlxyXG4gICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgIOe7j+i/h+WGhee9rui/h+a7pOinhOWImeWkhOeQhuWQjueahOWGheWuueOAglxyXG4gICAgICAgICAqIEByZW1pbmQg6K+l5pa55rOV5Zyo5aSE55CG5YyF5ZCr5pyJ5Yid5aeL5YyW5YaF5a6555qE5pe25YCZ6IO96LW35Yiw5b6I5aW955qE5L2c55So44CCXHJcbiAgICAgICAgICogQHdhcm5pbmcg6K+l5pa55rOV6I635Y+W5Yiw55qE5piv57uP6L+H57yW6L6R5Zmo5YaF572u55qE6L+H5ruk6KeE5YiZ6L+b6KGM6L+H5ruk5ZCO5b6X5Yiw55qE5YaF5a65XHJcbiAgICAgICAgICogQHJldHVybiB7IFN0cmluZyB9IOe8lui+keWZqOeahOWGheWuueWtl+espuS4slxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIC8vIGVkaXRvciDmmK/kuIDkuKrnvJbovpHlmajnmoTlrp7kvotcclxuICAgICAgICAgKiB2YXIgY29udGVudCA9IGVkaXRvci5nZXRDb250ZW50KCBmdW5jdGlvbiAoIGVkaXRvciApIHtcclxuICAgICAgICAgKiAgICAgIHJldHVybiBlZGl0b3IuYm9keS5pbm5lckhUTUwgPT09ICfmrKLov47kvb/nlKhVRWRpdG9yJzsgLy/ov5Tlm57nqbrlrZfnrKbkuLJcclxuICAgICAgICAgKiB9ICk7XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0Q29udGVudDogZnVuY3Rpb24gKGNtZCwgZm4sbm90U2V0Q3Vyc29yLGlnbm9yZUJsYW5rLGZvcm1hdHRlcikge1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICBpZiAoY21kICYmIHV0aWxzLmlzRnVuY3Rpb24oY21kKSkge1xyXG4gICAgICAgICAgICAgICAgZm4gPSBjbWQ7XHJcbiAgICAgICAgICAgICAgICBjbWQgPSAnJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoZm4gPyAhZm4oKSA6ICF0aGlzLmhhc0NvbnRlbnRzKCkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAnJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBtZS5maXJlRXZlbnQoJ2JlZm9yZWdldGNvbnRlbnQnKTtcclxuICAgICAgICAgICAgdmFyIHJvb3QgPSBVRS5odG1scGFyc2VyKG1lLmJvZHkuaW5uZXJIVE1MLGlnbm9yZUJsYW5rKTtcclxuICAgICAgICAgICAgbWUuZmlsdGVyT3V0cHV0UnVsZShyb290KTtcclxuICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdhZnRlcmdldGNvbnRlbnQnLCBjbWQscm9vdCk7XHJcbiAgICAgICAgICAgIHJldHVybiAgcm9vdC50b0h0bWwoZm9ybWF0dGVyKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDlj5blvpflrozmlbTnmoRodG1s5Luj56CB77yM5Y+v5Lul55u05o6l5pi+56S65oiQ5a6M5pW055qEaHRtbOaWh+aho1xyXG4gICAgICAgICAqIEBtZXRob2QgZ2V0QWxsSHRtbFxyXG4gICAgICAgICAqIEByZXR1cm4geyBTdHJpbmcgfSDnvJbovpHlmajnmoTlhoXlrrlodG1s5paH5qGj5a2X56ym5LiyXHJcbiAgICAgICAgICogQGVheG1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogZWRpdG9yLmdldEFsbEh0bWwoKTsgLy/ov5Tlm57moLzlvI/lpKfoh7TmmK86IDxodG1sPjxoZWFkPi4uLjwvaGVhZD48Ym9keT4uLi48L2JvZHk+PC9odG1sPlxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGdldEFsbEh0bWw6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICAgICAgICAgIGhlYWRIdG1sID0gW10sXHJcbiAgICAgICAgICAgICAgICBodG1sID0gJyc7XHJcbiAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnZ2V0QWxsSHRtbCcsIGhlYWRIdG1sKTtcclxuICAgICAgICAgICAgaWYgKGJyb3dzZXIuaWUgJiYgYnJvd3Nlci52ZXJzaW9uID4gOCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGhlYWRIdG1sRm9ySUU5ID0gJyc7XHJcbiAgICAgICAgICAgICAgICB1dGlscy5lYWNoKG1lLmRvY3VtZW50LnN0eWxlU2hlZXRzLCBmdW5jdGlvbiAoc2kpIHtcclxuICAgICAgICAgICAgICAgICAgICBoZWFkSHRtbEZvcklFOSArPSAoIHNpLmhyZWYgPyAnPGxpbmsgcmVsPVwic3R5bGVzaGVldFwiIHR5cGU9XCJ0ZXh0L2Nzc1wiIGhyZWY9XCInICsgc2kuaHJlZiArICdcIiAvPicgOiAnPHN0eWxlPicgKyBzaS5jc3NUZXh0ICsgJzwvc3R5bGU+Jyk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHV0aWxzLmVhY2gobWUuZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpLCBmdW5jdGlvbiAoc2kpIHtcclxuICAgICAgICAgICAgICAgICAgICBoZWFkSHRtbEZvcklFOSArPSBzaS5vdXRlckhUTUw7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuICc8aHRtbD48aGVhZD4nICsgKG1lLm9wdGlvbnMuY2hhcnNldCA/ICc8bWV0YSBodHRwLWVxdWl2PVwiQ29udGVudC1UeXBlXCIgY29udGVudD1cInRleHQvaHRtbDsgY2hhcnNldD0nICsgbWUub3B0aW9ucy5jaGFyc2V0ICsgJ1wiLz4nIDogJycpXHJcbiAgICAgICAgICAgICAgICArIChoZWFkSHRtbEZvcklFOSB8fCBtZS5kb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdLmlubmVySFRNTCkgKyBoZWFkSHRtbC5qb2luKCdcXG4nKSArICc8L2hlYWQ+J1xyXG4gICAgICAgICAgICAgICAgKyAnPGJvZHkgJyArIChpZSAmJiBicm93c2VyLnZlcnNpb24gPCA5ID8gJ2NsYXNzPVwidmlld1wiJyA6ICcnKSArICc+JyArIG1lLmdldENvbnRlbnQobnVsbCwgbnVsbCwgdHJ1ZSkgKyAnPC9ib2R5PjwvaHRtbD4nO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOW+l+WIsOe8lui+keWZqOeahOe6r+aWh+acrOWGheWuue+8jOS9huS8muS/neeVmeauteiQveagvOW8j1xyXG4gICAgICAgICAqIEBtZXRob2QgZ2V0UGxhaW5UeHRcclxuICAgICAgICAgKiBAcmV0dXJuIHsgU3RyaW5nIH0g57yW6L6R5Zmo5bim5q616JC95qC85byP55qE57qv5paH5pys5YaF5a655a2X56ym5LiyXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogLy/nvJbovpHlmahodG1s5YaF5a65OjxwPjxzdHJvbmc+MTwvc3Ryb25nPjwvcD48cD48c3Ryb25nPjI8L3N0cm9uZz48L3A+XHJcbiAgICAgICAgICogY29uc29sZS5sb2coZWRpdG9yLmdldFBsYWluVHh0KCkpOyAvL+i+k+WHujpcIjFcXG4yXFxuXHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0UGxhaW5UeHQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJlZyA9IG5ldyBSZWdFeHAoZG9tVXRpbHMuZmlsbENoYXIsICdnJyksXHJcbiAgICAgICAgICAgICAgICBodG1sID0gdGhpcy5ib2R5LmlubmVySFRNTC5yZXBsYWNlKC9bXFxuXFxyXS9nLCAnJyk7Ly9pZeimgeWFiOWOu+S6hlxcbuWcqOWkhOeQhlxyXG4gICAgICAgICAgICBodG1sID0gaHRtbC5yZXBsYWNlKC88KHB8ZGl2KVtePl0qPig8YnJcXC8/PnwmbmJzcDspPFxcL1xcMT4vZ2ksICdcXG4nKVxyXG4gICAgICAgICAgICAgICAgLnJlcGxhY2UoLzxiclxcLz8+L2dpLCAnXFxuJylcclxuICAgICAgICAgICAgICAgIC5yZXBsYWNlKC88W14+L10rPi9nLCAnJylcclxuICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8oXFxuKT88XFwvKFtePl0rKT4vZywgZnVuY3Rpb24gKGEsIGIsIGMpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZHRkLiRibG9ja1tjXSA/ICdcXG4nIDogYiA/IGIgOiAnJztcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvL+WPluWHuuadpeeahOepuuagvOS8muaciWMyYTDkvJrlj5jmiJDkubHnoIHvvIzlpITnkIbov5nnp43mg4XlhrVcXHUwMGEwXHJcbiAgICAgICAgICAgIHJldHVybiBodG1sLnJlcGxhY2UocmVnLCAnJykucmVwbGFjZSgvXFx1MDBhMC9nLCAnICcpLnJlcGxhY2UoLyZuYnNwOy9nLCAnICcpO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOiOt+WPlue8lui+keWZqOS4reeahOe6r+aWh+acrOWGheWuuSzmsqHmnInmrrXokL3moLzlvI9cclxuICAgICAgICAgKiBAbWV0aG9kIGdldENvbnRlbnRUeHRcclxuICAgICAgICAgKiBAcmV0dXJuIHsgU3RyaW5nIH0g57yW6L6R5Zmo5LiN5bim5q616JC95qC85byP55qE57qv5paH5pys5YaF5a655a2X56ym5LiyXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogLy/nvJbovpHlmahodG1s5YaF5a65OjxwPjxzdHJvbmc+MTwvc3Ryb25nPjwvcD48cD48c3Ryb25nPjI8L3N0cm9uZz48L3A+XHJcbiAgICAgICAgICogY29uc29sZS5sb2coZWRpdG9yLmdldFBsYWluVHh0KCkpOyAvL+i+k+WHujpcIjEyXHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0Q29udGVudFR4dDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcmVnID0gbmV3IFJlZ0V4cChkb21VdGlscy5maWxsQ2hhciwgJ2cnKTtcclxuICAgICAgICAgICAgLy/lj5blh7rmnaXnmoTnqbrmoLzkvJrmnIljMmEw5Lya5Y+Y5oiQ5Lmx56CB77yM5aSE55CG6L+Z56eN5oOF5Ya1XFx1MDBhMFxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5ib2R5W2Jyb3dzZXIuaWUgPyAnaW5uZXJUZXh0JyA6ICd0ZXh0Q29udGVudCddLnJlcGxhY2UocmVnLCAnJykucmVwbGFjZSgvXFx1MDBhMC9nLCAnICcpO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOiuvue9rue8lui+keWZqOeahOWGheWuue+8jOWPr+S/ruaUuee8lui+keWZqOW9k+WJjeeahGh0bWzlhoXlrrlcclxuICAgICAgICAgKiBAbWV0aG9kIHNldENvbnRlbnRcclxuICAgICAgICAgKiBAd2FybmluZyDpgJrov4for6Xmlrnms5Xmj5LlhaXnmoTlhoXlrrnvvIzmmK/nu4/ov4fnvJbovpHlmajlhoXnva7nmoTov4fmu6Top4TliJnov5vooYzov4fmu6TlkI7lvpfliLDnmoTlhoXlrrlcclxuICAgICAgICAgKiBAd2FybmluZyDor6Xmlrnms5XkvJrop6blj5FzZWxlY3Rpb25jaGFuZ2Xkuovku7ZcclxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBodG1sIOimgeaPkuWFpeeahGh0bWzlhoXlrrlcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBlZGl0b3IuZ2V0Q29udGVudCgnPHA+dGVzdDwvcD4nKTtcclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6K6+572u57yW6L6R5Zmo55qE5YaF5a6577yM5Y+v5L+u5pS557yW6L6R5Zmo5b2T5YmN55qEaHRtbOWGheWuuVxyXG4gICAgICAgICAqIEBtZXRob2Qgc2V0Q29udGVudFxyXG4gICAgICAgICAqIEB3YXJuaW5nIOmAmui/h+ivpeaWueazleaPkuWFpeeahOWGheWuue+8jOaYr+e7j+i/h+e8lui+keWZqOWGhee9rueahOi/h+a7pOinhOWImei/m+ihjOi/h+a7pOWQjuW+l+WIsOeahOWGheWuuVxyXG4gICAgICAgICAqIEB3YXJuaW5nIOivpeaWueazleS8muinpuWPkXNlbGVjdGlvbmNoYW5nZeS6i+S7tlxyXG4gICAgICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGh0bWwg6KaB5o+S5YWl55qEaHRtbOWGheWuuVxyXG4gICAgICAgICAqIEBwYXJhbSB7IEJvb2xlYW4gfSBpc0FwcGVuZFRvIOiLpeS8oOWFpXRydWXvvIzkuI3muIXnqbrljp/mnaXnmoTlhoXlrrnvvIzlnKjmnIDlkI7mj5LlhaXlhoXlrrnvvIzlkKbliJnvvIzmuIXnqbrlhoXlrrnlho3mj5LlhaVcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiAvL+WBh+iuvuiuvue9ruWJjeeahOe8lui+keWZqOWGheWuueaYryA8cD5vbGQgdGV4dDwvcD5cclxuICAgICAgICAgKiBlZGl0b3Iuc2V0Q29udGVudCgnPHA+bmV3IHRleHQ8L3A+JywgdHJ1ZSk7IC8v5o+S5YWl55qE57uT5p6c5pivPHA+b2xkIHRleHQ8L3A+PHA+bmV3IHRleHQ8L3A+XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgc2V0Q29udGVudDogZnVuY3Rpb24gKGh0bWwsIGlzQXBwZW5kVG8sIG5vdEZpcmVTZWxlY3Rpb25jaGFuZ2UpIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcclxuXHJcbiAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnYmVmb3Jlc2V0Y29udGVudCcsIGh0bWwpO1xyXG4gICAgICAgICAgICB2YXIgcm9vdCA9IFVFLmh0bWxwYXJzZXIoaHRtbCk7XHJcbiAgICAgICAgICAgIG1lLmZpbHRlcklucHV0UnVsZShyb290KTtcclxuICAgICAgICAgICAgaHRtbCA9IHJvb3QudG9IdG1sKCk7XHJcblxyXG4gICAgICAgICAgICBtZS5ib2R5LmlubmVySFRNTCA9IChpc0FwcGVuZFRvID8gbWUuYm9keS5pbm5lckhUTUwgOiAnJykgKyBodG1sO1xyXG5cclxuXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIGlzQ2RhdGFEaXYobm9kZSl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gIG5vZGUudGFnTmFtZSA9PSAnRElWJyAmJiBub2RlLmdldEF0dHJpYnV0ZSgnY2RhdGFfdGFnJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy/nu5nmlofmnKzmiJbogIVpbmxpbmXoioLngrnlpZdw5qCH562+XHJcbiAgICAgICAgICAgIGlmIChtZS5vcHRpb25zLmVudGVyVGFnID09ICdwJykge1xyXG5cclxuICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IHRoaXMuYm9keS5maXJzdENoaWxkLCB0bXBOb2RlO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFjaGlsZCB8fCBjaGlsZC5ub2RlVHlwZSA9PSAxICYmXHJcbiAgICAgICAgICAgICAgICAgICAgKGR0ZC4kY2RhdGFbY2hpbGQudGFnTmFtZV0gfHwgaXNDZGF0YURpdihjaGlsZCkgfHxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuaXNDdXN0b21lTm9kZShjaGlsZClcclxuICAgICAgICAgICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgICAgICAgICYmIGNoaWxkID09PSB0aGlzLmJvZHkubGFzdENoaWxkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ib2R5LmlubmVySFRNTCA9ICc8cD4nICsgKGJyb3dzZXIuaWUgPyAnJm5ic3A7JyA6ICc8YnIvPicpICsgJzwvcD4nICsgdGhpcy5ib2R5LmlubmVySFRNTDtcclxuXHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBwID0gbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIHdoaWxlIChjaGlsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgJiYgKGNoaWxkLm5vZGVUeXBlID09IDMgfHwgY2hpbGQubm9kZVR5cGUgPT0gMSAmJiBkdGQucFtjaGlsZC50YWdOYW1lXSAmJiAhZHRkLiRjZGF0YVtjaGlsZC50YWdOYW1lXSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcE5vZGUgPSBjaGlsZC5uZXh0U2libGluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuYXBwZW5kQ2hpbGQoY2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSB0bXBOb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLmZpcnN0Q2hpbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY2hpbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5ib2R5LmFwcGVuZENoaWxkKHApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShwLCBjaGlsZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcCA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLm5leHRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBtZS5maXJlRXZlbnQoJ2FmdGVyc2V0Y29udGVudCcpO1xyXG4gICAgICAgICAgICBtZS5maXJlRXZlbnQoJ2NvbnRlbnRjaGFuZ2UnKTtcclxuXHJcbiAgICAgICAgICAgICFub3RGaXJlU2VsZWN0aW9uY2hhbmdlICYmIG1lLl9zZWxlY3Rpb25DaGFuZ2UoKTtcclxuICAgICAgICAgICAgLy/muIXpmaTkv53lrZjnmoTpgInljLpcclxuICAgICAgICAgICAgbWUuX2Jha1JhbmdlID0gbWUuX2Jha0lFUmFuZ2UgPSBtZS5fYmFrTmF0aXZlUmFuZ2UgPSBudWxsO1xyXG4gICAgICAgICAgICAvL3RyYWNlOjE3NDIgc2V0Q29udGVudOWQjmdlY2tv6IO95b6X5Yiw54Sm54K56Zeu6aKYXHJcbiAgICAgICAgICAgIHZhciBnZWNrb1NlbDtcclxuICAgICAgICAgICAgaWYgKGJyb3dzZXIuZ2Vja28gJiYgKGdlY2tvU2VsID0gdGhpcy5zZWxlY3Rpb24uZ2V0TmF0aXZlKCkpKSB7XHJcbiAgICAgICAgICAgICAgICBnZWNrb1NlbC5yZW1vdmVBbGxSYW5nZXMoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZihtZS5vcHRpb25zLmF1dG9TeW5jRGF0YSl7XHJcbiAgICAgICAgICAgICAgICBtZS5mb3JtICYmIHNldFZhbHVlKG1lLmZvcm0sbWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6K6p57yW6L6R5Zmo6I635b6X54Sm54K577yM6buY6K6kZm9jdXPliLDnvJbovpHlmajlpLTpg6hcclxuICAgICAgICAgKiBAbWV0aG9kIGZvY3VzXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogZWRpdG9yLmZvY3VzKClcclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6K6p57yW6L6R5Zmo6I635b6X54Sm54K577yMdG9FbmTnoa7lrppmb2N1c+S9jee9rlxyXG4gICAgICAgICAqIEBtZXRob2QgZm9jdXNcclxuICAgICAgICAgKiBAcGFyYW0geyBCb29sZWFuIH0gdG9FbmQg6buY6K6kZm9jdXPliLDnvJbovpHlmajlpLTpg6jvvIx0b0VuZOS4unRydWXml7Zmb2N1c+WIsOWGheWuueWwvumDqFxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGVkaXRvci5mb2N1cyh0cnVlKVxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGZvY3VzOiBmdW5jdGlvbiAodG9FbmQpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgICAgICAgICAgICAgcm5nID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAodG9FbmQpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IG1lLmJvZHkubGFzdENoaWxkO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKG5vZGUgJiYgbm9kZS5ub2RlVHlwZSA9PSAxICYmICFkdGQuJGVtcHR5W25vZGUudGFnTmFtZV0pe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihkb21VdGlscy5pc0VtcHR5QmxvY2sobm9kZSkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcm5nLnNldFN0YXJ0QXRGaXJzdChub2RlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJuZy5zZXRTdGFydEF0TGFzdChub2RlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJuZy5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcm5nLnNldEN1cnNvcih0cnVlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoIXJuZy5jb2xsYXBzZWQgJiYgZG9tVXRpbHMuaXNCb2R5KHJuZy5zdGFydENvbnRhaW5lcikgJiYgcm5nLnN0YXJ0T2Zmc2V0ID09IDApe1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBtZS5ib2R5LmZpcnN0Q2hpbGQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5vZGUgJiYgbm9kZS5ub2RlVHlwZSA9PSAxICYmICFkdGQuJGVtcHR5W25vZGUudGFnTmFtZV0pe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcm5nLnNldFN0YXJ0QXRGaXJzdChub2RlKS5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcm5nLnNlbGVjdCh0cnVlKTtcclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnZm9jdXMgc2VsZWN0aW9uY2hhbmdlJyk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9LFxyXG4gICAgICAgIGlzRm9jdXM6ZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0aW9uLmlzRm9jdXMoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGJsdXI6ZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgdmFyIHNlbCA9IHRoaXMuc2VsZWN0aW9uLmdldE5hdGl2ZSgpO1xyXG4gICAgICAgICAgICBpZihzZWwuZW1wdHkgJiYgYnJvd3Nlci5pZSl7XHJcbiAgICAgICAgICAgICAgICB2YXIgbmF0aXZlUm5nID0gZG9jdW1lbnQuYm9keS5jcmVhdGVUZXh0UmFuZ2UoKTtcclxuICAgICAgICAgICAgICAgIG5hdGl2ZVJuZy5tb3ZlVG9FbGVtZW50VGV4dChkb2N1bWVudC5ib2R5KTtcclxuICAgICAgICAgICAgICAgIG5hdGl2ZVJuZy5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgIG5hdGl2ZVJuZy5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgIHNlbC5lbXB0eSgpXHJcbiAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgc2VsLnJlbW92ZUFsbFJhbmdlcygpXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vdGhpcy5maXJlRXZlbnQoJ2JsdXIgc2VsZWN0aW9uY2hhbmdlJyk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDliJ3lp4vljJZVReS6i+S7tuWPiumDqOWIhuS6i+S7tuS7o+eQhlxyXG4gICAgICAgICAqIEBtZXRob2QgX2luaXRFdmVudHNcclxuICAgICAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIF9pbml0RXZlbnRzOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgICAgICAgICBkb2MgPSBtZS5kb2N1bWVudCxcclxuICAgICAgICAgICAgICAgIHdpbiA9IG1lLndpbmRvdztcclxuICAgICAgICAgICAgbWUuX3Byb3h5RG9tRXZlbnQgPSB1dGlscy5iaW5kKG1lLl9wcm94eURvbUV2ZW50LCBtZSk7XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLm9uKGRvYywgWydjbGljaycsICdjb250ZXh0bWVudScsICdtb3VzZWRvd24nLCAna2V5ZG93bicsICdrZXl1cCcsICdrZXlwcmVzcycsICdtb3VzZXVwJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsICdzZWxlY3RzdGFydCddLCBtZS5fcHJveHlEb21FdmVudCk7XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLm9uKHdpbiwgWydmb2N1cycsICdibHVyJ10sIG1lLl9wcm94eURvbUV2ZW50KTtcclxuICAgICAgICAgICAgZG9tVXRpbHMub24obWUuYm9keSwnZHJvcCcsZnVuY3Rpb24oZSl7XHJcbiAgICAgICAgICAgICAgICAvL+mYu+atomZm5LiL6buY6K6k55qE5by55Ye65paw6aG16Z2i5omT5byA5Zu+54mHXHJcbiAgICAgICAgICAgICAgICBpZihicm93c2VyLmdlY2tvICYmIGUuc3RvcFByb3BhZ2F0aW9uKSB7IGUuc3RvcFByb3BhZ2F0aW9uKCk7IH1cclxuICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnY29udGVudGNoYW5nZScpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBkb21VdGlscy5vbihkb2MsIFsnbW91c2V1cCcsICdrZXlkb3duJ10sIGZ1bmN0aW9uIChldnQpIHtcclxuICAgICAgICAgICAgICAgIC8v54m55q6K6ZSu5LiN6Kem5Y+Rc2VsZWN0aW9uY2hhbmdlXHJcbiAgICAgICAgICAgICAgICBpZiAoZXZ0LnR5cGUgPT0gJ2tleWRvd24nICYmIChldnQuY3RybEtleSB8fCBldnQubWV0YUtleSB8fCBldnQuc2hpZnRLZXkgfHwgZXZ0LmFsdEtleSkpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoZXZ0LmJ1dHRvbiA9PSAyKXJldHVybjtcclxuICAgICAgICAgICAgICAgIG1lLl9zZWxlY3Rpb25DaGFuZ2UoMjUwLCBldnQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOinpuWPkeS6i+S7tuS7o+eQhlxyXG4gICAgICAgICAqIEBtZXRob2QgX3Byb3h5RG9tRXZlbnRcclxuICAgICAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICAgICAqIEByZXR1cm4geyAqIH0gZmlyZUV2ZW5055qE6L+U5Zue5YC8XHJcbiAgICAgICAgICogQHNlZSBVRS5FdmVudEJhc2U6ZmlyZUV2ZW50KFN0cmluZylcclxuICAgICAgICAgKi9cclxuICAgICAgICBfcHJveHlEb21FdmVudDogZnVuY3Rpb24gKGV2dCkge1xyXG4gICAgICAgICAgICBpZih0aGlzLmZpcmVFdmVudCgnYmVmb3JlJyArIGV2dC50eXBlLnJlcGxhY2UoL15vbi8sICcnKS50b0xvd2VyQ2FzZSgpKSA9PT0gZmFsc2Upe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKHRoaXMuZmlyZUV2ZW50KGV2dC50eXBlLnJlcGxhY2UoL15vbi8sICcnKSwgZXZ0KSA9PT0gZmFsc2Upe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZpcmVFdmVudCgnYWZ0ZXInICsgZXZ0LnR5cGUucmVwbGFjZSgvXm9uLywgJycpLnRvTG93ZXJDYXNlKCkpXHJcbiAgICAgICAgfSxcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDlj5jljJbpgInljLpcclxuICAgICAgICAgKiBAbWV0aG9kIF9zZWxlY3Rpb25DaGFuZ2VcclxuICAgICAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIF9zZWxlY3Rpb25DaGFuZ2U6IGZ1bmN0aW9uIChkZWxheSwgZXZ0KSB7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICAgICAgICAgIC8v5pyJ5YWJ5qCH5omN5YGac2VsZWN0aW9uY2hhbmdlIOS4uuS6huino+WGs+acqmZvY3Vz5pe254K55Ye7c291cmNl5LiN6IO96Kem5Y+R5pu05pS55bel5YW35qCP54q25oCB55qE6Zeu6aKY77yIc291cmNl5ZG95Lukbm90TmVlZFVuZG89Me+8iVxyXG4vLyAgICAgICAgICAgIGlmICggIW1lLnNlbGVjdGlvbi5pc0ZvY3VzKCkgKXtcclxuLy8gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4vLyAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICB2YXIgaGFja0Zvck1vdXNlVXAgPSBmYWxzZTtcclxuICAgICAgICAgICAgdmFyIG1vdXNlWCwgbW91c2VZO1xyXG4gICAgICAgICAgICBpZiAoYnJvd3Nlci5pZSAmJiBicm93c2VyLnZlcnNpb24gPCA5ICYmIGV2dCAmJiBldnQudHlwZSA9PSAnbW91c2V1cCcpIHtcclxuICAgICAgICAgICAgICAgIHZhciByYW5nZSA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXJhbmdlLmNvbGxhcHNlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGhhY2tGb3JNb3VzZVVwID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBtb3VzZVggPSBldnQuY2xpZW50WDtcclxuICAgICAgICAgICAgICAgICAgICBtb3VzZVkgPSBldnQuY2xpZW50WTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQoX3NlbGVjdGlvbkNoYW5nZVRpbWVyKTtcclxuICAgICAgICAgICAgX3NlbGVjdGlvbkNoYW5nZVRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIW1lLnNlbGVjdGlvbiB8fCAhbWUuc2VsZWN0aW9uLmdldE5hdGl2ZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy/kv67lpI3kuIDkuKpJReS4i+eahGJ1Zzog6byg5qCH54K55Ye75LiA5q615bey6YCJ5oup55qE5paH5pys5Lit6Ze05pe277yM5Y+v6IO95ZyobW91c2V1cOWQjueahOS4gOauteaXtumXtOWGheWPluWIsOeahHJhbmdl5piv5Zyoc2VsZWN0aW9u55qEdHlwZeS4uk5vbmXkuIvnmoTplJnor6/lgLwuXHJcbiAgICAgICAgICAgICAgICAvL0lF5LiL5aaC5p6c55So5oi35piv5ouW5ou95LiA5q615bey6YCJ5oup5paH5pys77yM5YiZ5LiN5Lya6Kem5Y+RbW91c2V1cOS6i+S7tu+8jOaJgOS7pei/memHjOeahOeJueauiuWkhOeQhuS4jeS8muWvueWFtuacieW9seWTjVxyXG4gICAgICAgICAgICAgICAgdmFyIGllUmFuZ2U7XHJcbiAgICAgICAgICAgICAgICBpZiAoaGFja0Zvck1vdXNlVXAgJiYgbWUuc2VsZWN0aW9uLmdldE5hdGl2ZSgpLnR5cGUgPT0gJ05vbmUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWVSYW5nZSA9IG1lLmRvY3VtZW50LmJvZHkuY3JlYXRlVGV4dFJhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWVSYW5nZS5tb3ZlVG9Qb2ludChtb3VzZVgsIG1vdXNlWSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWVSYW5nZSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdmFyIGJha0dldElFUmFuZ2U7XHJcbiAgICAgICAgICAgICAgICBpZiAoaWVSYW5nZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGJha0dldElFUmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0SUVSYW5nZTtcclxuICAgICAgICAgICAgICAgICAgICBtZS5zZWxlY3Rpb24uZ2V0SUVSYW5nZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGllUmFuZ2U7XHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIG1lLnNlbGVjdGlvbi5jYWNoZSgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGJha0dldElFUmFuZ2UpIHtcclxuICAgICAgICAgICAgICAgICAgICBtZS5zZWxlY3Rpb24uZ2V0SUVSYW5nZSA9IGJha0dldElFUmFuZ2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAobWUuc2VsZWN0aW9uLl9jYWNoZWRSYW5nZSAmJiBtZS5zZWxlY3Rpb24uX2NhY2hlZFN0YXJ0RWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnYmVmb3Jlc2VsZWN0aW9uY2hhbmdlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g56ys5LqM5Liq5Y+C5pWwY2F1c2VCeVVp5Li6dHJ1ZeS7o+ihqOeUseeUqOaIt+S6pOS6kumAoOaIkOeahHNlbGVjdGlvbmNoYW5nZS5cclxuICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NlbGVjdGlvbmNoYW5nZScsICEhZXZ0KTtcclxuICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ2FmdGVyc2VsZWN0aW9uY2hhbmdlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuc2VsZWN0aW9uLmNsZWFyKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sIGRlbGF5IHx8IDUwKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDmiafooYznvJbovpHlkb3ku6RcclxuICAgICAgICAgKiBAbWV0aG9kIF9jYWxsQ21kRm5cclxuICAgICAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGZuTmFtZSDlh73mlbDlkI3np7BcclxuICAgICAgICAgKiBAcGFyYW0geyAqIH0gYXJncyDkvKDnu5nlkb3ku6Tlh73mlbDnmoTlj4LmlbBcclxuICAgICAgICAgKiBAcmV0dXJuIHsgKiB9IOi/lOWbnuWRveS7pOWHveaVsOi/kOihjOeahOi/lOWbnuWAvFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIF9jYWxsQ21kRm46IGZ1bmN0aW9uIChmbk5hbWUsIGFyZ3MpIHtcclxuICAgICAgICAgICAgdmFyIGNtZE5hbWUgPSBhcmdzWzBdLnRvTG93ZXJDYXNlKCksXHJcbiAgICAgICAgICAgICAgICBjbWQsIGNtZEZuO1xyXG4gICAgICAgICAgICBjbWQgPSB0aGlzLmNvbW1hbmRzW2NtZE5hbWVdIHx8IFVFLmNvbW1hbmRzW2NtZE5hbWVdO1xyXG4gICAgICAgICAgICBjbWRGbiA9IGNtZCAmJiBjbWRbZm5OYW1lXTtcclxuICAgICAgICAgICAgLy/msqHmnIlxdWVyeWNvbW1hbmRzdGF0ZeaIluiAheayoeaciWNvbW1hbmTnmoTpg73pu5jorqTov5Tlm54wXHJcbiAgICAgICAgICAgIGlmICgoIWNtZCB8fCAhY21kRm4pICYmIGZuTmFtZSA9PSAncXVlcnlDb21tYW5kU3RhdGUnKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChjbWRGbikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNtZEZuLmFwcGx5KHRoaXMsIGFyZ3MpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5omn6KGM57yW6L6R5ZG95LukY21kTmFtZe+8jOWujOaIkOWvjOaWh+acrOe8lui+keaViOaenFxyXG4gICAgICAgICAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWROYW1lIOmcgOimgeaJp+ihjOeahOWRveS7pFxyXG4gICAgICAgICAqIEByZW1pbmQg5YW35L2T5ZG95Luk55qE5L2/55So6K+35Y+C6ICDPGEgaHJlZj1cIiNDT01NQU5ELkxJU1RcIj7lkb3ku6TliJfooag8L2E+XHJcbiAgICAgICAgICogQHJldHVybiB7ICogfSDov5Tlm57lkb3ku6Tlh73mlbDov5DooYznmoTov5Tlm57lgLxcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBlZGl0b3IuZXhlY0NvbW1hbmQoY21kTmFtZSk7XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uIChjbWROYW1lKSB7XHJcbiAgICAgICAgICAgIGNtZE5hbWUgPSBjbWROYW1lLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgICAgICAgICByZXN1bHQsXHJcbiAgICAgICAgICAgICAgICBjbWQgPSBtZS5jb21tYW5kc1tjbWROYW1lXSB8fCBVRS5jb21tYW5kc1tjbWROYW1lXTtcclxuICAgICAgICAgICAgaWYgKCFjbWQgfHwgIWNtZC5leGVjQ29tbWFuZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCFjbWQubm90TmVlZFVuZG8gJiYgIW1lLl9faGFzRW50ZXJFeGVjQ29tbWFuZCkge1xyXG4gICAgICAgICAgICAgICAgbWUuX19oYXNFbnRlckV4ZWNDb21tYW5kID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGlmIChtZS5xdWVyeUNvbW1hbmRTdGF0ZS5hcHBseShtZSxhcmd1bWVudHMpICE9IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdzYXZlU2NlbmUnKTtcclxuICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQuYXBwbHkobWUsIFsnYmVmb3JlZXhlY2NvbW1hbmQnLCBjbWROYW1lXS5jb25jYXQoYXJndW1lbnRzKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy5fY2FsbENtZEZuKCdleGVjQ29tbWFuZCcsIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy/kv53lrZjlnLrmma/ml7bvvIzlgZrkuoblhoXlrrnlr7nmr5TvvIzlho3nnIvmmK/lkKbov5vooYxjb250ZW50Y2hhbmdl6Kem5Y+R77yM6L+Z6YeM5aSa6Kem5Y+R5LqG5LiA5qyh77yM5Y675o6JXHJcbi8vICAgICAgICAgICAgICAgICAgICAoIWNtZC5pZ25vcmVDb250ZW50Q2hhbmdlICYmICFtZS5faWdub3JlQ29udGVudENoYW5nZSkgJiYgbWUuZmlyZUV2ZW50KCdjb250ZW50Y2hhbmdlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50LmFwcGx5KG1lLCBbJ2FmdGVyZXhlY2NvbW1hbmQnLCBjbWROYW1lXS5jb25jYXQoYXJndW1lbnRzKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdzYXZlU2NlbmUnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIG1lLl9faGFzRW50ZXJFeGVjQ29tbWFuZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy5fY2FsbENtZEZuKCdleGVjQ29tbWFuZCcsIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgICAgICAgICAoIW1lLl9faGFzRW50ZXJFeGVjQ29tbWFuZCAmJiAhY21kLmlnbm9yZUNvbnRlbnRDaGFuZ2UgJiYgIW1lLl9pZ25vcmVDb250ZW50Q2hhbmdlKSAmJiBtZS5maXJlRXZlbnQoJ2NvbnRlbnRjaGFuZ2UnKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICghbWUuX19oYXNFbnRlckV4ZWNDb21tYW5kICYmICFjbWQuaWdub3JlQ29udGVudENoYW5nZSAmJiAhbWUuX2lnbm9yZUNvbnRlbnRDaGFuZ2UpICYmIG1lLl9zZWxlY3Rpb25DaGFuZ2UoKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDmoLnmja7kvKDlhaXnmoRjb21tYW5k5ZG95Luk77yM5p+l6YCJ57yW6L6R5Zmo5b2T5YmN55qE6YCJ5Yy677yM6L+U5Zue5ZG95Luk55qE54q25oCBXHJcbiAgICAgICAgICogQG1ldGhvZCAgcXVlcnlDb21tYW5kU3RhdGVcclxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWROYW1lIOmcgOimgeafpeivoueahOWRveS7pOWQjeensFxyXG4gICAgICAgICAqIEByZW1pbmQg5YW35L2T5ZG95Luk55qE5L2/55So6K+35Y+C6ICDPGEgaHJlZj1cIiNDT01NQU5ELkxJU1RcIj7lkb3ku6TliJfooag8L2E+XHJcbiAgICAgICAgICogQHJldHVybiB7IE51bWJlciB9IG51bWJlciDov5Tlm57mlL7liY3lkb3ku6TnmoTnirbmgIHvvIzov5Tlm57lgLzkuInnp43mg4XlhrXvvJooLTF8MHwxKVxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGVkaXRvci5xdWVyeUNvbW1hbmRTdGF0ZShjbWROYW1lKSAgPT4gKC0xfDB8MSlcclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKiBAc2VlIENPTU1BTkQuTElTVFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoY21kTmFtZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fY2FsbENtZEZuKCdxdWVyeUNvbW1hbmRTdGF0ZScsIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5qC55o2u5Lyg5YWl55qEY29tbWFuZOWRveS7pO+8jOafpemAiee8lui+keWZqOW9k+WJjeeahOmAieWMuu+8jOagueaNruWRveS7pOi/lOWbnuebuOWFs+eahOWAvFxyXG4gICAgICAgICAqIEBtZXRob2QgcXVlcnlDb21tYW5kVmFsdWVcclxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWROYW1lIOmcgOimgeafpeivoueahOWRveS7pOWQjeensFxyXG4gICAgICAgICAqIEByZW1pbmQg5YW35L2T5ZG95Luk55qE5L2/55So6K+35Y+C6ICDPGEgaHJlZj1cIiNDT01NQU5ELkxJU1RcIj7lkb3ku6TliJfooag8L2E+XHJcbiAgICAgICAgICogQHJlbWluZCDlj6rmnInpg6jliIbmj5Lku7bmnInmraTmlrnms5VcclxuICAgICAgICAgKiBAcmV0dXJuIHsgKiB9IOi/lOWbnuavj+S4quWRveS7pOeJueWumueahOW9k+WJjeeKtuaAgeWAvFxyXG4gICAgICAgICAqIEBncmFtbWFyIGVkaXRvci5xdWVyeUNvbW1hbmRWYWx1ZShjbWROYW1lKSAgPT4gIHsqfVxyXG4gICAgICAgICAqIEBzZWUgQ09NTUFORC5MSVNUXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgcXVlcnlDb21tYW5kVmFsdWU6IGZ1bmN0aW9uIChjbWROYW1lKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jYWxsQ21kRm4oJ3F1ZXJ5Q29tbWFuZFZhbHVlJywgYXJndW1lbnRzKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDmo4Dmn6XnvJbovpHljLrln5/kuK3mmK/lkKbmnInlhoXlrrlcclxuICAgICAgICAgKiBAbWV0aG9kICBoYXNDb250ZW50c1xyXG4gICAgICAgICAqIEByZW1pbmQg6buY6K6k5pyJ5paH5pys5YaF5a6577yM5oiW6ICF5pyJ5Lul5LiL6IqC54K56YO95LiN6K6k5Li65piv56m6XHJcbiAgICAgICAgICogdGFibGUsdWwsb2wsZGwsaWZyYW1lLGFyZWEsYmFzZSxjb2wsaHIsaW1nLGVtYmVkLGlucHV0LGxpbmssbWV0YSxwYXJhbVxyXG4gICAgICAgICAqIEByZXR1cm4geyBCb29sZWFuIH0g5qOA5p+l5pyJ5YaF5a656L+U5ZuedHJ1Ze+8jOWQpuWImei/lOWbnmZhbHNlXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogZWRpdG9yLmhhc0NvbnRlbnRzKClcclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5qOA5p+l57yW6L6R5Yy65Z+f5Lit5piv5ZCm5pyJ5YaF5a6577yM6Iul5YyF5ZCr5Y+C5pWwdGFnc+S4reeahOiKgueCueexu+Wei++8jOebtOaOpei/lOWbnnRydWVcclxuICAgICAgICAgKiBAbWV0aG9kICBoYXNDb250ZW50c1xyXG4gICAgICAgICAqIEBwYXJhbSB7IEFycmF5IH0gdGFncyDkvKDlhaXmlbDnu4TliKTmlq3ml7bnlKjliLDnmoToioLngrnnsbvlnotcclxuICAgICAgICAgKiBAcmV0dXJuIHsgQm9vbGVhbiB9IOiLpeaWh+aho+S4reWMheWQq3RhZ3PmlbDnu4Tph4zlr7nlupTnmoR0YWfvvIzov5Tlm550cnVl77yM5ZCm5YiZ6L+U5ZueZmFsc2VcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBlZGl0b3IuaGFzQ29udGVudHMoWydzcGFuJ10pO1xyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGhhc0NvbnRlbnRzOiBmdW5jdGlvbiAodGFncykge1xyXG4gICAgICAgICAgICBpZiAodGFncykge1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IHRhZ3NbaSsrXTspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShjaSkubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCFkb21VdGlscy5pc0VtcHR5QmxvY2sodGhpcy5ib2R5KSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWVcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvL+maj+aXtua3u+WKoCzlrprkuYnnmoTnibnmrormoIfnrb7lpoLmnpzlrZjlnKjvvIzkuI3og73orqTkuLrmmK/nqbpcclxuICAgICAgICAgICAgdGFncyA9IFsnZGl2J107XHJcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGNpID0gdGFnc1tpKytdOykge1xyXG4gICAgICAgICAgICAgICAgdmFyIG5vZGVzID0gZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGhpcy5kb2N1bWVudCwgY2kpO1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgbiA9IDAsIGNuOyBjbiA9IG5vZGVzW24rK107KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRvbVV0aWxzLmlzQ3VzdG9tZU5vZGUoY24pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6YeN572u57yW6L6R5Zmo77yM5Y+v55So5p2l5YGa5aSa5LiqdGFi5L2/55So5ZCM5LiA5Liq57yW6L6R5Zmo5a6e5L6LXHJcbiAgICAgICAgICogQG1ldGhvZCAgcmVzZXRcclxuICAgICAgICAgKiBAcmVtaW5kIOatpOaWueazleS8mua4heepuue8lui+keWZqOWGheWuue+8jOa4heepuuWbnumAgOWIl+ihqO+8jOS8muinpuWPkXJlc2V05LqL5Lu2XHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogZWRpdG9yLnJlc2V0KClcclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICByZXNldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgncmVzZXQnKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDorr7nva7lvZPliY3nvJbovpHljLrln5/lj6/ku6XnvJbovpFcclxuICAgICAgICAgKiBAbWV0aG9kIHNldEVuYWJsZWRcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBlZGl0b3Iuc2V0RW5hYmxlZCgpXHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgc2V0RW5hYmxlZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzLCByYW5nZTtcclxuICAgICAgICAgICAgaWYgKG1lLmJvZHkuY29udGVudEVkaXRhYmxlID09ICdmYWxzZScpIHtcclxuICAgICAgICAgICAgICAgIG1lLmJvZHkuY29udGVudEVkaXRhYmxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHJhbmdlID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICAvL+acieWPr+iDveWGheWuueS4ouWkseS6hlxyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5tb3ZlVG9Cb29rbWFyayhtZS5sYXN0QmspO1xyXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBtZS5sYXN0QmtcclxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydEF0Rmlyc3QobWUuYm9keSkuY29sbGFwc2UodHJ1ZSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJhbmdlLnNlbGVjdCh0cnVlKTtcclxuICAgICAgICAgICAgICAgIGlmIChtZS5ia3F1ZXJ5Q29tbWFuZFN0YXRlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUucXVlcnlDb21tYW5kU3RhdGUgPSBtZS5ia3F1ZXJ5Q29tbWFuZFN0YXRlO1xyXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBtZS5ia3F1ZXJ5Q29tbWFuZFN0YXRlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKG1lLmJrcXVlcnlDb21tYW5kVmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBtZS5xdWVyeUNvbW1hbmRWYWx1ZSA9IG1lLmJrcXVlcnlDb21tYW5kVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG1lLmJrcXVlcnlDb21tYW5kVmFsdWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NlbGVjdGlvbmNoYW5nZScpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbmFibGU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0RW5hYmxlZCgpO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKiDorr7nva7lvZPliY3nvJbovpHljLrln5/kuI3lj6/nvJbovpFcclxuICAgICAgICAgKiBAbWV0aG9kIHNldERpc2FibGVkXHJcbiAgICAgICAgICovXHJcblxyXG4gICAgICAgIC8qKiDorr7nva7lvZPliY3nvJbovpHljLrln5/kuI3lj6/nvJbovpEsZXhjZXB05Lit55qE5ZG95Luk6Zmk5aSWXHJcbiAgICAgICAgICogQG1ldGhvZCBzZXREaXNhYmxlZFxyXG4gICAgICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGV4Y2VwdCDkvovlpJblkb3ku6TnmoTlrZfnrKbkuLJcclxuICAgICAgICAgKiBAcmVtaW5kIOWNs+S9v+iuvue9ruS6hmRpc2FibGXvvIzmraTlpITphY3nva7nmoTkvovlpJblkb3ku6Tku43nhLblj6/ku6XmiafooYxcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBlZGl0b3Iuc2V0RGlzYWJsZWQoJ2JvbGQnKTsgLy/npoHnlKjlt6XlhbfmoI/kuK3pmaTliqDnspfkuYvlpJbnmoTmiYDmnInlip/og71cclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgLyoqIOiuvue9ruW9k+WJjee8lui+keWMuuWfn+S4jeWPr+e8lui+kSxleGNlcHTkuK3nmoTlkb3ku6TpmaTlpJZcclxuICAgICAgICAgKiBAbWV0aG9kIHNldERpc2FibGVkXHJcbiAgICAgICAgICogQHBhcmFtIHsgQXJyYXkgfSBleGNlcHQg5L6L5aSW5ZG95Luk55qE5a2X56ym5Liy5pWw57uE77yM5pWw57uE5Lit55qE5ZG95Luk5LuN54S25Y+v5Lul5omn6KGMXHJcbiAgICAgICAgICogQHJlbWluZCDljbPkvb/orr7nva7kuoZkaXNhYmxl77yM5q2k5aSE6YWN572u55qE5L6L5aSW5ZG95Luk5LuN54S25Y+v5Lul5omn6KGMXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogZWRpdG9yLnNldERpc2FibGVkKFsnYm9sZCcsJ2luc2VydGltYWdlJ10pOyAvL+emgeeUqOW3peWFt+agj+S4remZpOWKoOeyl+WSjOaPkuWFpeWbvueJh+S5i+WklueahOaJgOacieWKn+iDvVxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHNldERpc2FibGVkOiBmdW5jdGlvbiAoZXhjZXB0KSB7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICAgICAgICAgIGV4Y2VwdCA9IGV4Y2VwdCA/IHV0aWxzLmlzQXJyYXkoZXhjZXB0KSA/IGV4Y2VwdCA6IFtleGNlcHRdIDogW107XHJcbiAgICAgICAgICAgIGlmIChtZS5ib2R5LmNvbnRlbnRFZGl0YWJsZSA9PSAndHJ1ZScpIHtcclxuICAgICAgICAgICAgICAgIGlmICghbWUubGFzdEJrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUubGFzdEJrID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCkuY3JlYXRlQm9va21hcmsodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBtZS5ib2R5LmNvbnRlbnRFZGl0YWJsZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgbWUuYmtxdWVyeUNvbW1hbmRTdGF0ZSA9IG1lLnF1ZXJ5Q29tbWFuZFN0YXRlO1xyXG4gICAgICAgICAgICAgICAgbWUuYmtxdWVyeUNvbW1hbmRWYWx1ZSA9IG1lLnF1ZXJ5Q29tbWFuZFZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbWUucXVlcnlDb21tYW5kU3RhdGUgPSBmdW5jdGlvbiAodHlwZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh1dGlscy5pbmRleE9mKGV4Y2VwdCwgdHlwZSkgIT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lLmJrcXVlcnlDb21tYW5kU3RhdGUuYXBwbHkobWUsIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAtMTtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBtZS5xdWVyeUNvbW1hbmRWYWx1ZSA9IGZ1bmN0aW9uICh0eXBlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHV0aWxzLmluZGV4T2YoZXhjZXB0LCB0eXBlKSAhPSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWUuYmtxdWVyeUNvbW1hbmRWYWx1ZS5hcHBseShtZSwgYXJndW1lbnRzKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdzZWxlY3Rpb25jaGFuZ2UnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZGlzYWJsZTogZnVuY3Rpb24gKGV4Y2VwdCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXREaXNhYmxlZChleGNlcHQpO1xyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOiuvue9rum7mOiupOWGheWuuVxyXG4gICAgICAgICAqIEBtZXRob2QgX3NldERlZmF1bHRDb250ZW50XHJcbiAgICAgICAgICogQHByaXZhdGVcclxuICAgICAgICAgKiBAcGFyYW0gIHsgU3RyaW5nIH0gY29udCDopoHlrZjlhaXnmoTlhoXlrrlcclxuICAgICAgICAgKi9cclxuICAgICAgICBfc2V0RGVmYXVsdENvbnRlbnQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgZnVuY3Rpb24gY2xlYXIoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1lLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpbml0Q29udGVudCcpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuYm9keS5pbm5lckhUTUwgPSAnPHA+JyArIChpZSA/ICcnIDogJzxici8+JykgKyAnPC9wPic7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUucmVtb3ZlTGlzdGVuZXIoJ2ZpcnN0QmVmb3JlRXhlY0NvbW1hbmQgZm9jdXMnLCBjbGVhcik7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmZvY3VzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLl9zZWxlY3Rpb25DaGFuZ2UoKTtcclxuICAgICAgICAgICAgICAgICAgICB9LCAwKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGNvbnQpIHtcclxuICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICAgICAgICAgICAgICBtZS5ib2R5LmlubmVySFRNTCA9ICc8cCBpZD1cImluaXRDb250ZW50XCI+JyArIGNvbnQgKyAnPC9wPic7XHJcblxyXG4gICAgICAgICAgICAgICAgbWUuYWRkTGlzdGVuZXIoJ2ZpcnN0QmVmb3JlRXhlY0NvbW1hbmQgZm9jdXMnLCBjbGVhcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KCksXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOaYvuekuue8lui+keWZqFxyXG4gICAgICAgICAqIEBtZXRob2Qgc2V0U2hvd1xyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGVkaXRvci5zZXRTaG93KClcclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICBzZXRTaG93OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsIHJhbmdlID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgIGlmIChtZS5jb250YWluZXIuc3R5bGUuZGlzcGxheSA9PSAnbm9uZScpIHtcclxuICAgICAgICAgICAgICAgIC8v5pyJ5Y+v6IO95YaF5a655Lii5aSx5LqGXHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLm1vdmVUb0Jvb2ttYXJrKG1lLmxhc3RCayk7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG1lLmxhc3RCa1xyXG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0QXRGaXJzdChtZS5ib2R5KS5jb2xsYXBzZSh0cnVlKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy9pZeS4i2ZvY3Vz5a6e5pWI77yM5omA5Lul5YGa5LqG5Liq5bu26L+fXHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5zZWxlY3QodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9LCAxMDApO1xyXG4gICAgICAgICAgICAgICAgbWUuY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnJztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9LFxyXG4gICAgICAgIHNob3c6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0U2hvdygpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6ZqQ6JeP57yW6L6R5ZmoXHJcbiAgICAgICAgICogQG1ldGhvZCBzZXRIaWRlXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogZWRpdG9yLnNldEhpZGUoKVxyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHNldEhpZGU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcclxuICAgICAgICAgICAgaWYgKCFtZS5sYXN0QmspIHtcclxuICAgICAgICAgICAgICAgIG1lLmxhc3RCayA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLmNyZWF0ZUJvb2ttYXJrKHRydWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG1lLmNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnXHJcbiAgICAgICAgfSxcclxuICAgICAgICBoaWRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldEhpZGUoKTtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDmoLnmja7mjIflrprnmoTot6/lvoTvvIzojrflj5blr7nlupTnmoTor63oqIDotYTmupBcclxuICAgICAgICAgKiBAbWV0aG9kIGdldExhbmdcclxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBwYXRoIOi3r+W+hOagueaNrueahOaYr2xhbmfnm67lvZXkuIvnmoTor63oqIDmlofku7bnmoTot6/lvoTnu5PmnoRcclxuICAgICAgICAgKiBAcmV0dXJuIHsgT2JqZWN0IHwgU3RyaW5nIH0g5qC55o2u6Lev5b6E6L+U5Zue6K+t6KiA6LWE5rqQ55qESnNvbuagvOW8j+WvueixoeaIluiAheivreiogOWtl+espuS4slxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGVkaXRvci5nZXRMYW5nKCdjb250ZXh0TWVudS5kZWxldGUnKTsgLy/lpoLmnpzlvZPliY3mmK/kuK3mlofvvIzpgqPov5Tlm57mmK/nmoTmmK8n5Yig6ZmkJ1xyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGdldExhbmc6IGZ1bmN0aW9uIChwYXRoKSB7XHJcbiAgICAgICAgICAgIHZhciBsYW5nID0gVUUuSTE4Tlt0aGlzLm9wdGlvbnMubGFuZ107XHJcbiAgICAgICAgICAgIGlmICghbGFuZykge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoXCJub3QgaW1wb3J0IGxhbmd1YWdlIGZpbGVcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcGF0aCA9IChwYXRoIHx8IFwiXCIpLnNwbGl0KFwiLlwiKTtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IHBhdGhbaSsrXTspIHtcclxuICAgICAgICAgICAgICAgIGxhbmcgPSBsYW5nW2NpXTtcclxuICAgICAgICAgICAgICAgIGlmICghbGFuZylicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gbGFuZztcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDorqHnrpfnvJbovpHlmahodG1s5YaF5a655a2X56ym5Liy55qE6ZW/5bqmXHJcbiAgICAgICAgICogQG1ldGhvZCAgZ2V0Q29udGVudExlbmd0aFxyXG4gICAgICAgICAqIEByZXR1cm4geyBOdW1iZXIgfSDov5Tlm57orqHnrpfnmoTplb/luqZcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiAvL+e8lui+keWZqGh0bWzlhoXlrrk8cD48c3Ryb25nPjEzMjwvc3Ryb25nPjwvcD5cclxuICAgICAgICAgKiBlZGl0b3IuZ2V0Q29udGVudExlbmd0aCgpIC8v6L+U5ZueMjdcclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDorqHnrpfnvJbovpHlmajlvZPliY3nuq/mlofmnKzlhoXlrrnnmoTplb/luqZcclxuICAgICAgICAgKiBAbWV0aG9kICBnZXRDb250ZW50TGVuZ3RoXHJcbiAgICAgICAgICogQHBhcmFtIHsgQm9vbGVhbiB9IGluZ29uZUh0bWwg5Lyg5YWldHJ1ZeaXtu+8jOWPquaMieeFp+e6r+aWh+acrOadpeiuoeeul1xyXG4gICAgICAgICAqIEByZXR1cm4geyBOdW1iZXIgfSDov5Tlm57orqHnrpfnmoTplb/luqbvvIzlhoXlrrnkuK3mnIloci9pbWcvaWZyYW1l5qCH562+77yM6ZW/5bqm5YqgMVxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIC8v57yW6L6R5ZmoaHRtbOWGheWuuTxwPjxzdHJvbmc+MTMyPC9zdHJvbmc+PC9wPlxyXG4gICAgICAgICAqIGVkaXRvci5nZXRDb250ZW50TGVuZ3RoKCkgLy/ov5Tlm54zXHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0Q29udGVudExlbmd0aDogZnVuY3Rpb24gKGluZ29uZUh0bWwsIHRhZ05hbWVzKSB7XHJcbiAgICAgICAgICAgIHZhciBjb3VudCA9IHRoaXMuZ2V0Q29udGVudChmYWxzZSxmYWxzZSx0cnVlKS5sZW5ndGg7XHJcbiAgICAgICAgICAgIGlmIChpbmdvbmVIdG1sKSB7XHJcbiAgICAgICAgICAgICAgICB0YWdOYW1lcyA9ICh0YWdOYW1lcyB8fCBbXSkuY29uY2F0KFsgJ2hyJywgJ2ltZycsICdpZnJhbWUnXSk7XHJcbiAgICAgICAgICAgICAgICBjb3VudCA9IHRoaXMuZ2V0Q29udGVudFR4dCgpLnJlcGxhY2UoL1tcXHRcXHJcXG5dKy9nLCAnJykubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IHRhZ05hbWVzW2krK107KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY291bnQgKz0gdGhpcy5kb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShjaSkubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBjb3VudDtcclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDms6jlhozovpPlhaXov4fmu6Top4TliJlcclxuICAgICAgICAgKiBAbWV0aG9kICBhZGRJbnB1dFJ1bGVcclxuICAgICAgICAgKiBAcGFyYW0geyBGdW5jdGlvbiB9IHJ1bGUg6KaB5re75Yqg55qE6L+H5ruk6KeE5YiZXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogZWRpdG9yLmFkZElucHV0UnVsZShmdW5jdGlvbihyb290KXtcclxuICAgICAgICAgKiAgICQuZWFjaChyb290LmdldE5vZGVzQnlUYWdOYW1lKCdkaXYnKSxmdW5jdGlvbihpLG5vZGUpe1xyXG4gICAgICAgICAqICAgICAgIG5vZGUudGFnTmFtZT1cInBcIjtcclxuICAgICAgICAgKiAgIH0pO1xyXG4gICAgICAgICAqIH0pO1xyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGFkZElucHV0UnVsZTogZnVuY3Rpb24gKHJ1bGUpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnB1dFJ1bGVzLnB1c2gocnVsZSk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5omn6KGM5rOo5YaM55qE6L+H5ruk6KeE5YiZXHJcbiAgICAgICAgICogQG1ldGhvZCAgZmlsdGVySW5wdXRSdWxlXHJcbiAgICAgICAgICogQHBhcmFtIHsgVUUudU5vZGUgfSByb290IOimgei/h+a7pOeahHVOb2Rl6IqC54K5XHJcbiAgICAgICAgICogQHJlbWluZCDmiafooYxlZGl0b3Iuc2V0Q29udGVudOaWueazleWSjOaJp+ihjCdpbnNlcnRodG1sJ+WRveS7pOWQju+8jOS8mui/kOihjOivpei/h+a7pOWHveaVsFxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGVkaXRvci5maWx0ZXJJbnB1dFJ1bGUoZWRpdG9yLmJvZHkpO1xyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqIEBzZWUgVUUuRWRpdG9yOmFkZElucHV0UnVsZVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGZpbHRlcklucHV0UnVsZTogZnVuY3Rpb24gKHJvb3QpIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IHRoaXMuaW5wdXRSdWxlc1tpKytdOykge1xyXG4gICAgICAgICAgICAgICAgY2kuY2FsbCh0aGlzLCByb290KVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5rOo5YaM6L6T5Ye66L+H5ruk6KeE5YiZXHJcbiAgICAgICAgICogQG1ldGhvZCAgYWRkT3V0cHV0UnVsZVxyXG4gICAgICAgICAqIEBwYXJhbSB7IEZ1bmN0aW9uIH0gcnVsZSDopoHmt7vliqDnmoTov4fmu6Top4TliJlcclxuICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgKiBlZGl0b3IuYWRkT3V0cHV0UnVsZShmdW5jdGlvbihyb290KXtcclxuICAgICAgICAgKiAgICQuZWFjaChyb290LmdldE5vZGVzQnlUYWdOYW1lKCdwJyksZnVuY3Rpb24oaSxub2RlKXtcclxuICAgICAgICAgKiAgICAgICBub2RlLnRhZ05hbWU9XCJkaXZcIjtcclxuICAgICAgICAgKiAgIH0pO1xyXG4gICAgICAgICAqIH0pO1xyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGFkZE91dHB1dFJ1bGU6IGZ1bmN0aW9uIChydWxlKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3V0cHV0UnVsZXMucHVzaChydWxlKVxyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOagueaNrui+k+WHuui/h+a7pOinhOWIme+8jOi/h+a7pOe8lui+keWZqOWGheWuuVxyXG4gICAgICAgICAqIEBtZXRob2QgIGZpbHRlck91dHB1dFJ1bGVcclxuICAgICAgICAgKiBAcmVtaW5kIOaJp+ihjGVkaXRvci5nZXRDb250ZW505pa55rOV55qE5pe25YCZ77yM5Lya5YWI6L+Q6KGM6K+l6L+H5ruk5Ye95pWwXHJcbiAgICAgICAgICogQHBhcmFtIHsgVUUudU5vZGUgfSByb290IOimgei/h+a7pOeahHVOb2Rl6IqC54K5XHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogZWRpdG9yLmZpbHRlck91dHB1dFJ1bGUoZWRpdG9yLmJvZHkpO1xyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqIEBzZWUgVUUuRWRpdG9yOmFkZE91dHB1dFJ1bGVcclxuICAgICAgICAgKi9cclxuICAgICAgICBmaWx0ZXJPdXRwdXRSdWxlOiBmdW5jdGlvbiAocm9vdCkge1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2k7IGNpID0gdGhpcy5vdXRwdXRSdWxlc1tpKytdOykge1xyXG4gICAgICAgICAgICAgICAgY2kuY2FsbCh0aGlzLCByb290KVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5qC55o2uYWN0aW9u5ZCN56ew6I635Y+W6K+35rGC55qE6Lev5b6EXHJcbiAgICAgICAgICogQG1ldGhvZCAgZ2V0QWN0aW9uVXJsXHJcbiAgICAgICAgICogQHJlbWluZCDlgYflpoLmsqHmnInorr7nva5zZXJ2ZXJVcmws5Lya5qC55o2uaW1hZ2VVcmzorr7nva7pu5jorqTnmoRjb250cm9sbGVy6Lev5b6EXHJcbiAgICAgICAgICogQHBhcmFtIHsgU3RyaW5nIH0gYWN0aW9uIGFjdGlvbuWQjeensFxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqIGVkaXRvci5nZXRBY3Rpb25VcmwoJ2NvbmZpZycpOyAvL+i/lOWbniBcIi91ZWRpdG9yL3BocC9jb250cm9sbGVyLnBocD9hY3Rpb249Y29uZmlnXCJcclxuICAgICAgICAgKiBlZGl0b3IuZ2V0QWN0aW9uVXJsKCdpbWFnZScpOyAvL+i/lOWbniBcIi91ZWRpdG9yL3BocC9jb250cm9sbGVyLnBocD9hY3Rpb249dXBsYW9kaW1hZ2VcIlxyXG4gICAgICAgICAqIGVkaXRvci5nZXRBY3Rpb25VcmwoJ3NjcmF3bCcpOyAvL+i/lOWbniBcIi91ZWRpdG9yL3BocC9jb250cm9sbGVyLnBocD9hY3Rpb249dXBsYW9kc2NyYXdsXCJcclxuICAgICAgICAgKiBlZGl0b3IuZ2V0QWN0aW9uVXJsKCdpbWFnZU1hbmFnZXInKTsgLy/ov5Tlm54gXCIvdWVkaXRvci9waHAvY29udHJvbGxlci5waHA/YWN0aW9uPWxpc3RpbWFnZVwiXHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0QWN0aW9uVXJsOiBmdW5jdGlvbihhY3Rpb24pe1xyXG4gICAgICAgICAgICB2YXIgYWN0aW9uTmFtZSA9IHRoaXMuZ2V0T3B0KGFjdGlvbikgfHwgYWN0aW9uLFxyXG4gICAgICAgICAgICAgICAgaW1hZ2VVcmwgPSB0aGlzLmdldE9wdCgnaW1hZ2VVcmwnKSxcclxuICAgICAgICAgICAgICAgIHNlcnZlclVybCA9IHRoaXMuZ2V0T3B0KCdzZXJ2ZXJVcmwnKTtcclxuXHJcbiAgICAgICAgICAgIGlmKCFzZXJ2ZXJVcmwgJiYgaW1hZ2VVcmwpIHtcclxuICAgICAgICAgICAgICAgIHNlcnZlclVybCA9IGltYWdlVXJsLnJlcGxhY2UoL14oLipbXFwvXSkuKyhbXFwuXS4rKSQvLCAnJDFjb250cm9sbGVyJDInKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYoc2VydmVyVXJsKSB7XHJcbiAgICAgICAgICAgICAgICBzZXJ2ZXJVcmwgPSBzZXJ2ZXJVcmwgKyAoc2VydmVyVXJsLmluZGV4T2YoJz8nKSA9PSAtMSA/ICc/JzonJicpICsgJ2FjdGlvbj0nICsgKGFjdGlvbk5hbWUgfHwgJycpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHV0aWxzLmZvcm1hdFVybChzZXJ2ZXJVcmwpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHV0aWxzLmluaGVyaXRzKEVkaXRvciwgRXZlbnRCYXNlKTtcclxufSkoKTtcclxuXG5cbi8vIGNvcmUvRWRpdG9yLmRlZmF1bHRvcHRpb25zLmpzXG4vL+e7tOaKpOe8lui+keWZqOS4gOS4i+m7mOiupOeahOS4jeWcqOaPkuS7tuS4reeahOmFjee9rumhuVxuVUUuRWRpdG9yLmRlZmF1bHRPcHRpb25zID0gZnVuY3Rpb24oZWRpdG9yKXtcblxuICAgIHZhciBfdXJsID0gZWRpdG9yLm9wdGlvbnMuVUVESVRPUl9IT01FX1VSTDtcbiAgICByZXR1cm4ge1xuICAgICAgICBpc1Nob3c6IHRydWUsXG4gICAgICAgIGluaXRpYWxDb250ZW50OiAnJyxcbiAgICAgICAgaW5pdGlhbFN0eWxlOicnLFxuICAgICAgICBhdXRvQ2xlYXJpbml0aWFsQ29udGVudDogZmFsc2UsXG4gICAgICAgIGlmcmFtZUNzc1VybDogX3VybCArICd0aGVtZXMvaWZyYW1lLmNzcycsXG4gICAgICAgIHRleHRhcmVhOiAnZWRpdG9yVmFsdWUnLFxuICAgICAgICBmb2N1czogZmFsc2UsXG4gICAgICAgIGZvY3VzSW5FbmQ6IHRydWUsXG4gICAgICAgIGF1dG9DbGVhckVtcHR5Tm9kZTogdHJ1ZSxcbiAgICAgICAgZnVsbHNjcmVlbjogZmFsc2UsXG4gICAgICAgIHJlYWRvbmx5OiBmYWxzZSxcbiAgICAgICAgekluZGV4OiA5OTksXG4gICAgICAgIGltYWdlUG9wdXA6IHRydWUsXG4gICAgICAgIGVudGVyVGFnOiAncCcsXG4gICAgICAgIGN1c3RvbURvbWFpbjogZmFsc2UsXG4gICAgICAgIGxhbmc6ICd6aC1jbicsXG4gICAgICAgIGxhbmdQYXRoOiBfdXJsICsgJ2xhbmcvJyxcbiAgICAgICAgdGhlbWU6ICdkZWZhdWx0JyxcbiAgICAgICAgdGhlbWVQYXRoOiBfdXJsICsgJ3RoZW1lcy8nLFxuICAgICAgICBhbGxIdG1sRW5hYmxlZDogZmFsc2UsXG4gICAgICAgIHNjYWxlRW5hYmxlZDogZmFsc2UsXG4gICAgICAgIHRhYmxlTmF0aXZlRWRpdEluRkY6IGZhbHNlLFxuICAgICAgICBhdXRvU3luY0RhdGEgOiB0cnVlLFxuICAgICAgICBmaWxlTmFtZUZvcm1hdDogJ3t0aW1lfXtyYW5kOjZ9J1xuICAgIH1cbn07XG5cbi8vIGNvcmUvbG9hZGNvbmZpZy5qc1xuKGZ1bmN0aW9uKCl7XG5cbiAgICBVRS5FZGl0b3IucHJvdG90eXBlLmxvYWRTZXJ2ZXJDb25maWcgPSBmdW5jdGlvbigpe1xuICAgICAgICB2YXIgbWUgPSB0aGlzO1xuICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICB0cnl7XG4gICAgICAgICAgICAgICAgbWUub3B0aW9ucy5pbWFnZVVybCAmJiBtZS5zZXRPcHQoJ3NlcnZlclVybCcsIG1lLm9wdGlvbnMuaW1hZ2VVcmwucmVwbGFjZSgvXiguKltcXC9dKS4rKFtcXC5dLispJC8sICckMWNvbnRyb2xsZXIkMicpKTtcblxuICAgICAgICAgICAgICAgIHZhciBjb25maWdVcmwgPSBtZS5nZXRBY3Rpb25VcmwoJ2NvbmZpZycpLFxuICAgICAgICAgICAgICAgICAgICBpc0pzb25wID0gdXRpbHMuaXNDcm9zc0RvbWFpblVybChjb25maWdVcmwpO1xuXG4gICAgICAgICAgICAgICAgLyog5Y+R5Ye6YWpheOivt+axgiAqL1xuICAgICAgICAgICAgICAgIG1lLl9zZXJ2ZXJDb25maWdMb2FkZWQgPSBmYWxzZTtcblxuICAgICAgICAgICAgICAgIGNvbmZpZ1VybCAmJiBVRS5hamF4LnJlcXVlc3QoY29uZmlnVXJsLHtcbiAgICAgICAgICAgICAgICAgICAgJ21ldGhvZCc6ICdHRVQnLFxuICAgICAgICAgICAgICAgICAgICAnZGF0YVR5cGUnOiBpc0pzb25wID8gJ2pzb25wJzonJyxcbiAgICAgICAgICAgICAgICAgICAgJ29uc3VjY2Vzcyc6ZnVuY3Rpb24ocil7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb25maWcgPSBpc0pzb25wID8gcjpldmFsKFwiKFwiK3IucmVzcG9uc2VUZXh0K1wiKVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1dGlscy5leHRlbmQobWUub3B0aW9ucywgY29uZmlnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NlcnZlckNvbmZpZ0xvYWRlZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLl9zZXJ2ZXJDb25maWdMb2FkZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3dFcnJvck1zZyhtZS5nZXRMYW5nKCdsb2FkY29uZmlnRm9ybWF0RXJyb3InKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICdvbmVycm9yJzpmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgICAgICAgICAgc2hvd0Vycm9yTXNnKG1lLmdldExhbmcoJ2xvYWRjb25maWdIdHRwRXJyb3InKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gY2F0Y2goZSl7XG4gICAgICAgICAgICAgICAgc2hvd0Vycm9yTXNnKG1lLmdldExhbmcoJ2xvYWRjb25maWdFcnJvcicpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgZnVuY3Rpb24gc2hvd0Vycm9yTXNnKG1zZykge1xuICAgICAgICAgICAgY29uc29sZSAmJiBjb25zb2xlLmVycm9yKG1zZyk7XG4gICAgICAgICAgICAvL21lLmZpcmVFdmVudCgnc2hvd01lc3NhZ2UnLCB7XG4gICAgICAgICAgICAvLyAgICAndGl0bGUnOiBtc2csXG4gICAgICAgICAgICAvLyAgICAndHlwZSc6ICdlcnJvcidcbiAgICAgICAgICAgIC8vfSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgVUUuRWRpdG9yLnByb3RvdHlwZS5pc1NlcnZlckNvbmZpZ0xvYWRlZCA9IGZ1bmN0aW9uKCl7XG4gICAgICAgIHZhciBtZSA9IHRoaXM7XG4gICAgICAgIHJldHVybiBtZS5fc2VydmVyQ29uZmlnTG9hZGVkIHx8IGZhbHNlO1xuICAgIH07XG5cbiAgICBVRS5FZGl0b3IucHJvdG90eXBlLmFmdGVyQ29uZmlnUmVhZHkgPSBmdW5jdGlvbihoYW5kbGVyKXtcbiAgICAgICAgaWYgKCFoYW5kbGVyIHx8ICF1dGlscy5pc0Z1bmN0aW9uKGhhbmRsZXIpKSByZXR1cm47XG4gICAgICAgIHZhciBtZSA9IHRoaXM7XG4gICAgICAgIHZhciByZWFkeUhhbmRsZXIgPSBmdW5jdGlvbigpe1xuICAgICAgICAgICAgaGFuZGxlci5hcHBseShtZSwgYXJndW1lbnRzKTtcbiAgICAgICAgICAgIG1lLnJlbW92ZUxpc3RlbmVyKCdzZXJ2ZXJDb25maWdMb2FkZWQnLCByZWFkeUhhbmRsZXIpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChtZS5pc1NlcnZlckNvbmZpZ0xvYWRlZCgpKSB7XG4gICAgICAgICAgICBoYW5kbGVyLmNhbGwobWUsICdzZXJ2ZXJDb25maWdMb2FkZWQnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG1lLmFkZExpc3RlbmVyKCdzZXJ2ZXJDb25maWdMb2FkZWQnLCByZWFkeUhhbmRsZXIpO1xuICAgICAgICB9XG4gICAgfTtcblxufSkoKTtcblxuXG4vLyBjb3JlL2FqYXguanNcbi8qKlxyXG4gKiBAZmlsZVxyXG4gKiBAbW9kdWxlIFVFLmFqYXhcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG4vKipcclxuICog5o+Q5L6b5a+5YWpheOivt+axgueahOaUr+aMgVxyXG4gKiBAbW9kdWxlIFVFLmFqYXhcclxuICovXHJcblVFLmFqYXggPSBmdW5jdGlvbigpIHtcclxuXHJcbiAgICAvL+WIm+W7uuS4gOS4qmFqYXhSZXF1ZXN05a+56LGhXHJcbiAgICB2YXIgZm5TdHIgPSAnWE1MSHR0cFJlcXVlc3QoKSc7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIG5ldyBBY3RpdmVYT2JqZWN0KFwiTXN4bWwyLlhNTEhUVFBcIik7XHJcbiAgICAgICAgZm5TdHIgPSAnQWN0aXZlWE9iamVjdChcXCdNc3htbDIuWE1MSFRUUFxcJyknO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIG5ldyBBY3RpdmVYT2JqZWN0KFwiTWljcm9zb2Z0LlhNTEhUVFBcIik7XHJcbiAgICAgICAgICAgIGZuU3RyID0gJ0FjdGl2ZVhPYmplY3QoXFwnTWljcm9zb2Z0LlhNTEhUVFBcXCcpJ1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICB2YXIgY3JlYXRBamF4UmVxdWVzdCA9IG5ldyBGdW5jdGlvbigncmV0dXJuIG5ldyAnICsgZm5TdHIpO1xyXG5cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWwhmpzb27lj4LmlbDovazljJbmiJDpgILlkIhhamF45o+Q5Lqk55qE5Y+C5pWw5YiX6KGoXHJcbiAgICAgKiBAcGFyYW0ganNvblxyXG4gICAgICovXHJcbiAgICBmdW5jdGlvbiBqc29uMnN0cihqc29uKSB7XHJcbiAgICAgICAgdmFyIHN0ckFyciA9IFtdO1xyXG4gICAgICAgIGZvciAodmFyIGkgaW4ganNvbikge1xyXG4gICAgICAgICAgICAvL+W/veeVpem7mOiupOeahOWHoOS4quWPguaVsFxyXG4gICAgICAgICAgICBpZihpPT1cIm1ldGhvZFwiIHx8IGk9PVwidGltZW91dFwiIHx8IGk9PVwiYXN5bmNcIiB8fCBpPT1cImRhdGFUeXBlXCIgfHwgaT09XCJjYWxsYmFja1wiKSBjb250aW51ZTtcclxuICAgICAgICAgICAgLy/lv73nlaXmjqfliLZcclxuICAgICAgICAgICAgaWYoanNvbltpXSA9PSB1bmRlZmluZWQgfHwganNvbltpXSA9PSBudWxsKSBjb250aW51ZTtcclxuICAgICAgICAgICAgLy/kvKDpgJLov4fmnaXnmoTlr7nosaHlkozlh73mlbDkuI3lnKjmj5DkuqTkuYvliJdcclxuICAgICAgICAgICAgaWYgKCEoKHR5cGVvZiBqc29uW2ldKS50b0xvd2VyQ2FzZSgpID09IFwiZnVuY3Rpb25cIiB8fCAodHlwZW9mIGpzb25baV0pLnRvTG93ZXJDYXNlKCkgPT0gXCJvYmplY3RcIikpIHtcclxuICAgICAgICAgICAgICAgIHN0ckFyci5wdXNoKCBlbmNvZGVVUklDb21wb25lbnQoaSkgKyBcIj1cIitlbmNvZGVVUklDb21wb25lbnQoanNvbltpXSkgKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICh1dGlscy5pc0FycmF5KGpzb25baV0pKSB7XHJcbiAgICAgICAgICAgIC8v5pSv5oyB5Lyg5pWw57uE5YaF5a65XHJcbiAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwganNvbltpXS5sZW5ndGg7IGorKykge1xyXG4gICAgICAgICAgICAgICAgICAgIHN0ckFyci5wdXNoKCBlbmNvZGVVUklDb21wb25lbnQoaSkgKyBcIltdPVwiK2VuY29kZVVSSUNvbXBvbmVudChqc29uW2ldW2pdKSApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBzdHJBcnIuam9pbihcIiZcIik7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZG9BamF4KHVybCwgYWpheE9wdGlvbnMpIHtcclxuICAgICAgICB2YXIgeGhyID0gY3JlYXRBamF4UmVxdWVzdCgpLFxyXG4gICAgICAgIC8v5piv5ZCm6LaF5pe2XHJcbiAgICAgICAgICAgIHRpbWVJc091dCA9IGZhbHNlLFxyXG4gICAgICAgIC8v6buY6K6k5Y+C5pWwXHJcbiAgICAgICAgICAgIGRlZmF1bHRBamF4T3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgICAgIG1ldGhvZDpcIlBPU1RcIixcclxuICAgICAgICAgICAgICAgIHRpbWVvdXQ6NTAwMCxcclxuICAgICAgICAgICAgICAgIGFzeW5jOnRydWUsXHJcbiAgICAgICAgICAgICAgICBkYXRhOnt9LC8v6ZyA6KaB5Lyg6YCS5a+56LGh55qE6K+d5Y+q6IO96KaG55uWXHJcbiAgICAgICAgICAgICAgICBvbnN1Y2Nlc3M6ZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgb25lcnJvcjpmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaWYgKHR5cGVvZiB1cmwgPT09IFwib2JqZWN0XCIpIHtcclxuICAgICAgICAgICAgYWpheE9wdGlvbnMgPSB1cmw7XHJcbiAgICAgICAgICAgIHVybCA9IGFqYXhPcHRpb25zLnVybDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF4aHIgfHwgIXVybCkgcmV0dXJuO1xyXG4gICAgICAgIHZhciBhamF4T3B0cyA9IGFqYXhPcHRpb25zID8gdXRpbHMuZXh0ZW5kKGRlZmF1bHRBamF4T3B0aW9ucyxhamF4T3B0aW9ucykgOiBkZWZhdWx0QWpheE9wdGlvbnM7XHJcblxyXG4gICAgICAgIHZhciBzdWJtaXRTdHIgPSBqc29uMnN0cihhamF4T3B0cyk7ICAvLyB7IG5hbWU6XCJKaW1cIixjaXR5OlwiQmVpamluZ1wiIH0gLS0+IFwibmFtZT1KaW0mY2l0eT1CZWlqaW5nXCJcclxuICAgICAgICAvL+WmguaenOeUqOaIt+ebtOaOpemAmui/h2RhdGHlj4LmlbDkvKDpgJJqc29u5a+56LGh6L+H5p2l77yM5YiZ5Lmf6KaB5bCG5q2kanNvbuWvueixoei9rOWMluS4uuWtl+espuS4slxyXG4gICAgICAgIGlmICghdXRpbHMuaXNFbXB0eU9iamVjdChhamF4T3B0cy5kYXRhKSl7XHJcbiAgICAgICAgICAgIHN1Ym1pdFN0ciArPSAoc3VibWl0U3RyPyBcIiZcIjpcIlwiKSArIGpzb24yc3RyKGFqYXhPcHRzLmRhdGEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvL+i2heaXtuajgOa1i1xyXG4gICAgICAgIHZhciB0aW1lcklEID0gc2V0VGltZW91dChmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgaWYgKHhoci5yZWFkeVN0YXRlICE9IDQpIHtcclxuICAgICAgICAgICAgICAgIHRpbWVJc091dCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB4aHIuYWJvcnQoKTtcclxuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcklEKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIGFqYXhPcHRzLnRpbWVvdXQpO1xyXG5cclxuICAgICAgICB2YXIgbWV0aG9kID0gYWpheE9wdHMubWV0aG9kLnRvVXBwZXJDYXNlKCk7XHJcbiAgICAgICAgdmFyIHN0ciA9IHVybCArICh1cmwuaW5kZXhPZihcIj9cIik9PS0xP1wiP1wiOlwiJlwiKSArIChtZXRob2Q9PVwiUE9TVFwiP1wiXCI6c3VibWl0U3RyKyBcIiZub0NhY2hlPVwiICsgK25ldyBEYXRlKTtcclxuICAgICAgICB4aHIub3BlbihtZXRob2QsIHN0ciwgYWpheE9wdHMuYXN5bmMpO1xyXG4gICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgaWYgKHhoci5yZWFkeVN0YXRlID09IDQpIHtcclxuICAgICAgICAgICAgICAgIGlmICghdGltZUlzT3V0ICYmIHhoci5zdGF0dXMgPT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWpheE9wdHMub25zdWNjZXNzKHhocik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGFqYXhPcHRzLm9uZXJyb3IoeGhyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgaWYgKG1ldGhvZCA9PSBcIlBPU1RcIikge1xyXG4gICAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpO1xyXG4gICAgICAgICAgICB4aHIuc2VuZChzdWJtaXRTdHIpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHhoci5zZW5kKG51bGwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBkb0pzb25wKHVybCwgb3B0cykge1xyXG5cclxuICAgICAgICB2YXIgc3VjY2Vzc2hhbmRsZXIgPSBvcHRzLm9uc3VjY2VzcyB8fCBmdW5jdGlvbigpe30sXHJcbiAgICAgICAgICAgIHNjciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ1NDUklQVCcpLFxyXG4gICAgICAgICAgICBvcHRpb25zID0gb3B0cyB8fCB7fSxcclxuICAgICAgICAgICAgY2hhcnNldCA9IG9wdGlvbnNbJ2NoYXJzZXQnXSxcclxuICAgICAgICAgICAgY2FsbGJhY2tGaWVsZCA9IG9wdGlvbnNbJ2pzb25wJ10gfHwgJ2NhbGxiYWNrJyxcclxuICAgICAgICAgICAgY2FsbGJhY2tGbk5hbWUsXHJcbiAgICAgICAgICAgIHRpbWVPdXQgPSBvcHRpb25zWyd0aW1lT3V0J10gfHwgMCxcclxuICAgICAgICAgICAgdGltZXIsXHJcbiAgICAgICAgICAgIHJlZyA9IG5ldyBSZWdFeHAoJyhcXFxcP3wmKScgKyBjYWxsYmFja0ZpZWxkICsgJz0oW14mXSopJyksXHJcbiAgICAgICAgICAgIG1hdGNoZXM7XHJcblxyXG4gICAgICAgIGlmICh1dGlscy5pc0Z1bmN0aW9uKHN1Y2Nlc3NoYW5kbGVyKSkge1xyXG4gICAgICAgICAgICBjYWxsYmFja0ZuTmFtZSA9ICdiZF9fZWRpdG9yX18nICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjE0NzQ4MzY0OCkudG9TdHJpbmcoMzYpO1xyXG4gICAgICAgICAgICB3aW5kb3dbY2FsbGJhY2tGbk5hbWVdID0gZ2V0Q2FsbEJhY2soMCk7XHJcbiAgICAgICAgfSBlbHNlIGlmKHV0aWxzLmlzU3RyaW5nKHN1Y2Nlc3NoYW5kbGVyKSl7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrRm5OYW1lID0gc3VjY2Vzc2hhbmRsZXI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKG1hdGNoZXMgPSByZWcuZXhlYyh1cmwpKSB7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFja0ZuTmFtZSA9IG1hdGNoZXNbMl07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHVybCA9IHVybC5yZXBsYWNlKHJlZywgJ1xceDI0MScgKyBjYWxsYmFja0ZpZWxkICsgJz0nICsgY2FsbGJhY2tGbk5hbWUpO1xyXG5cclxuICAgICAgICBpZiAodXJsLnNlYXJjaChyZWcpIDwgMCkge1xyXG4gICAgICAgICAgICB1cmwgKz0gKHVybC5pbmRleE9mKCc/JykgPCAwID8gJz8nIDogJyYnKSArIGNhbGxiYWNrRmllbGQgKyAnPScgKyBjYWxsYmFja0ZuTmFtZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHZhciBxdWVyeVN0ciA9IGpzb24yc3RyKG9wdHMpOyAgLy8geyBuYW1lOlwiSmltXCIsY2l0eTpcIkJlaWppbmdcIiB9IC0tPiBcIm5hbWU9SmltJmNpdHk9QmVpamluZ1wiXHJcbiAgICAgICAgLy/lpoLmnpznlKjmiLfnm7TmjqXpgJrov4dkYXRh5Y+C5pWw5Lyg6YCSanNvbuWvueixoei/h+adpe+8jOWImeS5n+imgeWwhuatpGpzb27lr7nosaHovazljJbkuLrlrZfnrKbkuLJcclxuICAgICAgICBpZiAoIXV0aWxzLmlzRW1wdHlPYmplY3Qob3B0cy5kYXRhKSl7XHJcbiAgICAgICAgICAgIHF1ZXJ5U3RyICs9IChxdWVyeVN0cj8gXCImXCI6XCJcIikgKyBqc29uMnN0cihvcHRzLmRhdGEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocXVlcnlTdHIpIHtcclxuICAgICAgICAgICAgdXJsID0gdXJsLnJlcGxhY2UoL1xcPy8sICc/JyArIHF1ZXJ5U3RyICsgJyYnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHNjci5vbmVycm9yID0gZ2V0Q2FsbEJhY2soMSk7XHJcbiAgICAgICAgaWYoIHRpbWVPdXQgKXtcclxuICAgICAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KGdldENhbGxCYWNrKDEpLCB0aW1lT3V0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY3JlYXRlU2NyaXB0VGFnKHNjciwgdXJsLCBjaGFyc2V0KTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gY3JlYXRlU2NyaXB0VGFnKHNjciwgdXJsLCBjaGFyc2V0KSB7XHJcbiAgICAgICAgICAgIHNjci5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAndGV4dC9qYXZhc2NyaXB0Jyk7XHJcbiAgICAgICAgICAgIHNjci5zZXRBdHRyaWJ1dGUoJ2RlZmVyJywgJ2RlZmVyJyk7XHJcbiAgICAgICAgICAgIGNoYXJzZXQgJiYgc2NyLnNldEF0dHJpYnV0ZSgnY2hhcnNldCcsIGNoYXJzZXQpO1xyXG4gICAgICAgICAgICBzY3Iuc2V0QXR0cmlidXRlKCdzcmMnLCB1cmwpO1xyXG4gICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdLmFwcGVuZENoaWxkKHNjcik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBnZXRDYWxsQmFjayhvblRpbWVPdXQpe1xyXG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYob25UaW1lT3V0KXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5vbmVycm9yICYmIG9wdGlvbnMub25lcnJvcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0cnl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc2hhbmRsZXIuYXBwbHkod2luZG93LCBhcmd1bWVudHMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKXt9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXhjZXB0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5vbmVycm9yICYmIG9wdGlvbnMub25lcnJvci5jYWxsKHdpbmRvdywgZXhjZXB0aW9uKTtcclxuICAgICAgICAgICAgICAgIH0gZmluYWxseSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5vbmNvbXBsZXRlICYmIG9wdGlvbnMub25jb21wbGV0ZS5hcHBseSh3aW5kb3csIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2NyLnBhcmVudE5vZGUgJiYgc2NyLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc2NyKTtcclxuICAgICAgICAgICAgICAgICAgICB3aW5kb3dbY2FsbGJhY2tGbk5hbWVdID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgd2luZG93W2NhbGxiYWNrRm5OYW1lXTtcclxuICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZSl7fVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5qC55o2u57uZ5a6a55qE5Y+C5pWw6aG577yM5ZCR5oyH5a6a55qEdXJs5Y+R6LW35LiA5LiqYWpheOivt+axguOAgiBhamF46K+35rGC5a6M5oiQ5ZCO77yM5Lya5qC55o2u6K+35rGC57uT5p6c6LCD55So55u45bqU5Zue6LCD77yaIOWmguaenOivt+axglxyXG4gICAgICAgICAqIOaIkOWKn++8jCDliJnosIPnlKhvbnN1Y2Nlc3Plm57osIPvvIwg5aSx6LSl5YiZ6LCD55SoIG9uZXJyb3Ig5Zue6LCDXHJcbiAgICAgICAgICogQG1ldGhvZCByZXF1ZXN0XHJcbiAgICAgICAgICogQHBhcmFtIHsgVVJMU3RyaW5nIH0gdXJsIGFqYXjor7fmsYLnmoR1cmzlnLDlnYBcclxuICAgICAgICAgKiBAcGFyYW0geyBPYmplY3QgfSBhamF4T3B0aW9ucyBhamF46K+35rGC6YCJ6aG555qE6ZSu5YC85a+577yM5pSv5oyB55qE6YCJ6aG55aaC5LiL77yaXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogLy/lkJFzYXloZWxsby5waHDlj5HotbfkuIDkuKrlvILmraXnmoRBamF4IEdFVOivt+axgiwg6K+35rGC6LaF5pe25pe26Ze05Li6MTBz77yMIOivt+axguWujOaIkOWQjuaJp+ihjOebuOW6lOeahOWbnuiwg+OAglxyXG4gICAgICAgICAqIFVFLmFqYXgucmVxdWVzZXQoICdzYXloZWxsby5waHAnLCB7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy/or7fmsYLmlrnms5XjgILlj6/pgInlgLzvvJogJ0dFVCcsICdQT1NUJ++8jOm7mOiupOWAvOaYrydQT1NUJ1xyXG4gICAgICAgICAqICAgICBtZXRob2Q6ICdHRVQnLFxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIC8v6LaF5pe25pe26Ze044CCIOm7mOiupOS4ujUwMDDvvIwg5Y2V5L2N5pivbXNcclxuICAgICAgICAgKiAgICAgdGltZW91dDogMTAwMDAsXHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy/mmK/lkKbmmK/lvILmraXor7fmsYLjgIIgdHJ1ZeS4uuW8guatpeivt+axgu+8jCBmYWxzZeS4uuWQjOatpeivt+axglxyXG4gICAgICAgICAqICAgICBhc3luYzogdHJ1ZSxcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqICAgICAvL+ivt+axguaQuuW4pueahOaVsOaNruOAguWmguaenOivt+axguS4ukdFVOivt+axgu+8jCBkYXRh5Lya57uP6L+Hc3RyaW5naWZ55ZCO6ZmE5Yqg5Yiw6K+35rGCdXJs5LmL5ZCO44CCXHJcbiAgICAgICAgICogICAgIGRhdGE6IHtcclxuICAgICAgICAgKiAgICAgICAgIG5hbWU6ICd1ZWRpdG9yJ1xyXG4gICAgICAgICAqICAgICB9LFxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIC8v6K+35rGC5oiQ5Yqf5ZCO55qE5Zue6LCD77yMIOivpeWbnuiwg+aOpeWPl+W9k+WJjeeahFhNTEh0dHBSZXF1ZXN05a+56LGh5L2c5Li65Y+C5pWw44CCXHJcbiAgICAgICAgICogICAgIG9uc3VjY2VzczogZnVuY3Rpb24gKCB4aHIgKSB7XHJcbiAgICAgICAgICogICAgICAgICBjb25zb2xlLmxvZyggeGhyLnJlc3BvbnNlVGV4dCApO1xyXG4gICAgICAgICAqICAgICB9LFxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogICAgIC8v6K+35rGC5aSx6LSl5oiW6ICF6LaF5pe25ZCO55qE5Zue6LCD44CCXHJcbiAgICAgICAgICogICAgIG9uZXJyb3I6IGZ1bmN0aW9uICggeGhyICkge1xyXG4gICAgICAgICAqICAgICAgICAgIGFsZXJ0KCAnQWpheOivt+axguWksei0pScgKTtcclxuICAgICAgICAgKiAgICAgfVxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogfSApO1xyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDmoLnmja7nu5nlrprnmoTlj4LmlbDpobnlj5HotbfkuIDkuKphamF46K+35rGC77yMIOWPguaVsOmhuemHjOW/hemhu+WMheWQq+S4gOS4qnVybOWcsOWdgOOAgiBhamF46K+35rGC5a6M5oiQ5ZCO77yM5Lya5qC55o2u6K+35rGC57uT5p6c6LCD55So55u45bqU5Zue6LCD77yaIOWmguaenOivt+axglxyXG4gICAgICAgICAqIOaIkOWKn++8jCDliJnosIPnlKhvbnN1Y2Nlc3Plm57osIPvvIwg5aSx6LSl5YiZ6LCD55SoIG9uZXJyb3Ig5Zue6LCD44CCXHJcbiAgICAgICAgICogQG1ldGhvZCByZXF1ZXN0XHJcbiAgICAgICAgICogQHdhcm5pbmcg5aaC5p6c5Zyo5Y+C5pWw6aG56YeM5pyq5o+Q5L6b5LiA5Liqa2V55Li64oCcdXJs4oCd55qE5Zyw5Z2A5YC877yM5YiZ6K+l6K+35rGC5bCG55u05o6l6YCA5Ye644CCXHJcbiAgICAgICAgICogQHBhcmFtIHsgT2JqZWN0IH0gYWpheE9wdGlvbnMgYWpheOivt+axgumAiemhueeahOmUruWAvOWvue+8jOaUr+aMgeeahOmAiemhueWmguS4i++8mlxyXG4gICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogLy/lkJFzYXloZWxsby5waHDlj5HotbfkuIDkuKrlvILmraXnmoRBamF4IFBPU1Tor7fmsYIsIOivt+axgui2heaXtuaXtumXtOS4ujVz77yMIOivt+axguWujOaIkOWQjuS4jeaJp+ihjOS7u+S9leWbnuiwg+OAglxyXG4gICAgICAgICAqIFVFLmFqYXgucmVxdWVzZXQoICdzYXloZWxsby5waHAnLCB7XHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiAgICAgLy/or7fmsYLnmoTlnLDlnYDvvIwg6K+l6aG55piv5b+F6aG755qE44CCXHJcbiAgICAgICAgICogICAgIHVybDogJ3NheWhlbGxvLnBocCdcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIH0gKTtcclxuICAgICAgICAgKiBgYGBcclxuICAgICAgICAgKi9cclxuXHRcdHJlcXVlc3Q6ZnVuY3Rpb24odXJsLCBvcHRzKSB7XHJcbiAgICAgICAgICAgIGlmIChvcHRzICYmIG9wdHMuZGF0YVR5cGUgPT0gJ2pzb25wJykge1xyXG4gICAgICAgICAgICAgICAgZG9Kc29ucCh1cmwsIG9wdHMpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZG9BamF4KHVybCwgb3B0cyk7XHJcbiAgICAgICAgICAgIH1cclxuXHRcdH0sXHJcbiAgICAgICAgZ2V0SlNPTlA6ZnVuY3Rpb24odXJsLCBkYXRhLCBmbikge1xyXG4gICAgICAgICAgICB2YXIgb3B0cyA9IHtcclxuICAgICAgICAgICAgICAgICdkYXRhJzogZGF0YSxcclxuICAgICAgICAgICAgICAgICdvbmNvbXBsZXRlJzogZm5cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgZG9Kc29ucCh1cmwsIG9wdHMpO1xyXG5cdFx0fVxyXG5cdH07XHJcblxyXG5cclxufSgpO1xyXG5cblxuLy8gY29yZS9maWx0ZXJ3b3JkLmpzXG4vKipcclxuICogVUXov4fmu6R3b3Jk55qE6Z2Z5oCB5pa55rOVXHJcbiAqIEBmaWxlXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIFVFZGl0b3LlhaznlKjnqbrpl7TvvIxVRWRpdG9y5omA5pyJ55qE5Yqf6IO96YO95oyC6L295Zyo6K+l56m66Ze05LiLXHJcbiAqIEBtb2R1bGUgVUVcclxuICovXHJcblxyXG5cclxuLyoqXHJcbiAqIOagueaNruS8oOWFpWh0bWzlrZfnrKbkuLLov4fmu6R3b3JkXHJcbiAqIEBtb2R1bGUgVUVcclxuICogQHNpbmNlIDEuMi42LjFcclxuICogQG1ldGhvZCBmaWx0ZXJXb3JkXHJcbiAqIEBwYXJhbSB7IFN0cmluZyB9IGh0bWwgaHRtbOWtl+espuS4slxyXG4gKiBAcmV0dXJuIHsgU3RyaW5nIH0g5bey6L+H5ruk5ZCO55qE57uT5p6c5a2X56ym5LiyXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogVUUuZmlsdGVyV29yZChodG1sKTtcclxuICogYGBgXHJcbiAqL1xyXG52YXIgZmlsdGVyV29yZCA9IFVFLmZpbHRlcldvcmQgPSBmdW5jdGlvbiAoKSB7XHJcblxyXG4gICAgLy/mmK/lkKbmmK93b3Jk6L+H5p2l55qE5YaF5a65XHJcbiAgICBmdW5jdGlvbiBpc1dvcmREb2N1bWVudCggc3RyICkge1xyXG4gICAgICAgIHJldHVybiAvKGNsYXNzPVwiP01zb3xzdHlsZT1cIlteXCJdKlxcYm1zb1xcLXx3OldvcmREb2N1bWVudHw8KHZ8byk6fGxhbmc9KS9pZy50ZXN0KCBzdHIgKTtcclxuICAgIH1cclxuICAgIC8v5Y675o6J5bCP5pWwXHJcbiAgICBmdW5jdGlvbiB0cmFuc1VuaXQoIHYgKSB7XHJcbiAgICAgICAgdiA9IHYucmVwbGFjZSggL1tcXGQuXStcXHcrL2csIGZ1bmN0aW9uICggbSApIHtcclxuICAgICAgICAgICAgcmV0dXJuIHV0aWxzLnRyYW5zVW5pdFRvUHgobSk7XHJcbiAgICAgICAgfSApO1xyXG4gICAgICAgIHJldHVybiB2O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGZpbHRlclBhc3RlV29yZCggc3RyICkge1xyXG4gICAgICAgIHJldHVybiBzdHIucmVwbGFjZSgvW1xcdFxcclxcbl0rL2csJyAnKVxyXG4gICAgICAgICAgICAgICAgLnJlcGxhY2UoIC88IS0tW1xcc1xcU10qPy0tPi9pZywgXCJcIiApXHJcbiAgICAgICAgICAgICAgICAvL+i9rOaNouWbvueJh1xyXG4gICAgICAgICAgICAgICAgLnJlcGxhY2UoLzx2OnNoYXBlIFtePl0qPltcXHNcXFNdKj8uPFxcL3Y6c2hhcGU+L2dpLGZ1bmN0aW9uKHN0cil7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9vcGVyYeiDveiHquW3seino+aekOWHumltYWdl5omA6L+Z6YeM55u05o6l6L+U5Zue56m6XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoYnJvd3Nlci5vcGVyYSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnJztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdHJ5e1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL+acieWPr+iDveaYr2JpdG1hcOWNoOS4uuWbvu+8jOaXoOeUqO+8jOebtOaOpei/h+a7pOaOie+8jOS4u+imgeS9k+eOsOWcqOeymOi0tGV4Y2Vs6KGo5qC85LitXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKC9CaXRtYXAvaS50ZXN0KHN0cikpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3aWR0aCA9IHN0ci5tYXRjaCgvd2lkdGg6KFsgXFxkLl0qcFt0eF0pL2kpWzFdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0ID0gc3RyLm1hdGNoKC9oZWlnaHQ6KFsgXFxkLl0qcFt0eF0pL2kpWzFdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjID0gIHN0ci5tYXRjaCgvc3JjPVxccypcIihbXlwiXSopXCIvaSlbMV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGltZyB3aWR0aD1cIicrIHRyYW5zVW5pdCh3aWR0aCkgKydcIiBoZWlnaHQ9XCInK3RyYW5zVW5pdChoZWlnaHQpICsnXCIgc3JjPVwiJyArIHNyYyArICdcIiAvPic7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaChlKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAvL+mSiOWvuXdwc+a3u+WKoOeahOWkmuS9meagh+etvuWkhOeQhlxyXG4gICAgICAgICAgICAgICAgLnJlcGxhY2UoLzxcXC8/ZGl2W14+XSo+L2csJycpXHJcbiAgICAgICAgICAgICAgICAvL+WOu+aOieWkmuS9meeahOWxnuaAp1xyXG4gICAgICAgICAgICAgICAgLnJlcGxhY2UoIC92Olxcdys9KFtcIiddPylbXidcIl0rXFwxL2csICcnIClcclxuICAgICAgICAgICAgICAgIC5yZXBsYWNlKCAvPCghfHNjcmlwdFtePl0qPi4qPzxcXC9zY3JpcHQoPz1bPlxcc10pfFxcLz8oXFw/eG1sKDpcXHcrKT98eG1sfG1ldGF8bGlua3xzdHlsZXxcXHcrOlxcdyspKD89W1xcc1xcLz5dKSlbXj5dKj4vZ2ksIFwiXCIgKVxyXG4gICAgICAgICAgICAgICAgLnJlcGxhY2UoIC88cCBbXj5dKmNsYXNzPVwiP01zb0hlYWRpbmdcIj9bXj5dKj4oLio/KTxcXC9wPi9naSwgXCI8cD48c3Ryb25nPiQxPC9zdHJvbmc+PC9wPlwiIClcclxuICAgICAgICAgICAgICAgIC8v5Y675o6J5aSa5L2Z55qE5bGe5oCnXHJcbiAgICAgICAgICAgICAgICAucmVwbGFjZSggL1xccysoY2xhc3N8bGFuZ3xhbGlnbilcXHMqPVxccyooWydcIl0/KShbXFx3LV0rKVxcMi9pZywgZnVuY3Rpb24oc3RyLG5hbWUsbWFya3MsdmFsKXtcclxuICAgICAgICAgICAgICAgICAgICAvL+S/neeVmWxpc3TnmoTmoIfnpLpcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmFtZSA9PSAnY2xhc3MnICYmIHZhbCA9PSAnTXNvTGlzdFBhcmFncmFwaCcgPyBzdHIgOiAnJ1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC8v5riF6Zmk5aSa5L2Z55qEZm9udC9zcGFu5LiN6IO95Yy56YWNJm5ic3A75pyJ5Y+v6IO95piv56m65qC8XHJcbiAgICAgICAgICAgICAgICAucmVwbGFjZSggLzwoZm9udHxzcGFuKVtePl0qPihcXHMqKTxcXC9cXDE+L2dpLCBmdW5jdGlvbihhLGIsYyl7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGMucmVwbGFjZSgvW1xcdFxcclxcbiBdKy9nLCcgJylcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAvL+WkhOeQhnN0eWxl55qE6Zeu6aKYXHJcbiAgICAgICAgICAgICAgICAucmVwbGFjZSggLyg8W2Etel1bXj5dKilcXHNzdHlsZT0oW1wiJ10pKFteXFwyXSo/KVxcMi9naSwgZnVuY3Rpb24oIHN0ciwgdGFnLCB0bXAsIHN0eWxlICkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBuID0gW10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHMgPSBzdHlsZS5yZXBsYWNlKCAvXlxccyt8XFxzKyQvLCAnJyApXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvJiMzOTsvZywnXFwnJylcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKCAvJnF1b3Q7L2dpLCBcIidcIiApXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW1xcZC5dKyhjbXxwdCkvZyxmdW5jdGlvbihzdHIpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1dGlscy50cmFuc1VuaXRUb1B4KHN0cilcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc3BsaXQoIC87XFxzKi9nICk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGZvciAoIHZhciBpID0gMCx2OyB2ID0gc1tpXTtpKysgKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSwgdmFsdWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IHYuc3BsaXQoIFwiOlwiICk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHBhcnRzLmxlbmd0aCA9PSAyICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IHBhcnRzWzBdLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHBhcnRzWzFdLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZigvXihiYWNrZ3JvdW5kKVxcdyovLnRlc3QobmFtZSkgJiYgdmFsdWUucmVwbGFjZSgvKGluaXRpYWx8XFxzKS9nLCcnKS5sZW5ndGggPT0gMFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgL14obWFyZ2luKVxcdyovLnRlc3QobmFtZSkgJiYgL14wXFx3KyQvLnRlc3QodmFsdWUpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoIG5hbWUgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm1zby1wYWRkaW5nLWFsdFwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtc28tcGFkZGluZy10b3AtYWx0XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm1zby1wYWRkaW5nLXJpZ2h0LWFsdFwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtc28tcGFkZGluZy1ib3R0b20tYWx0XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm1zby1wYWRkaW5nLWxlZnQtYWx0XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm1zby1tYXJnaW4tYWx0XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm1zby1tYXJnaW4tdG9wLWFsdFwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtc28tbWFyZ2luLXJpZ2h0LWFsdFwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtc28tbWFyZ2luLWJvdHRvbS1hbHRcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwibXNvLW1hcmdpbi1sZWZ0LWFsdFwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vaWXkuIvkvJrlh7rnjrDmjKTliLDkuIDotbfnmoTmg4XlhrVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vY2FzZSBcIm1zby10YWJsZS1sYXlvdXQtYWx0XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm1zby1oZWlnaHRcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwibXNvLXdpZHRoXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm1zby12ZXJ0aWNhbC1hbGlnbi1hbHRcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy90cmFjZToxODE5IGZm5LiL5Lya6Kej5p6Q5Ye6cGFkZGluZ+WcqHRhYmxl5LiKXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCEvPHRhYmxlLy50ZXN0KHRhZykpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuW2ldID0gbmFtZS5yZXBsYWNlKCAvXm1zby18LWFsdCQvZywgXCJcIiApICsgXCI6XCIgKyB0cmFuc1VuaXQoIHZhbHVlICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJob3Jpei1hbGlnblwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuW2ldID0gXCJ0ZXh0LWFsaWduOlwiICsgdmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwidmVydC1hbGlnblwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuW2ldID0gXCJ2ZXJ0aWNhbC1hbGlnbjpcIiArIHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcImZvbnQtY29sb3JcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwibXNvLWZvcmVncm91bmRcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbltpXSA9IFwiY29sb3I6XCIgKyB2YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtc28tYmFja2dyb3VuZFwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtc28taGlnaGxpZ2h0XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5baV0gPSBcImJhY2tncm91bmQ6XCIgKyB2YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtc28tZGVmYXVsdC1oZWlnaHRcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbltpXSA9IFwibWluLWhlaWdodDpcIiArIHRyYW5zVW5pdCggdmFsdWUgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtc28tZGVmYXVsdC13aWR0aFwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuW2ldID0gXCJtaW4td2lkdGg6XCIgKyB0cmFuc1VuaXQoIHZhbHVlICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwibXNvLXBhZGRpbmctYmV0d2Vlbi1hbHRcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbltpXSA9IFwiYm9yZGVyLWNvbGxhcHNlOnNlcGFyYXRlO2JvcmRlci1zcGFjaW5nOlwiICsgdHJhbnNVbml0KCB2YWx1ZSApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcInRleHQtbGluZS10aHJvdWdoXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggKHZhbHVlID09IFwic2luZ2xlXCIpIHx8ICh2YWx1ZSA9PSBcImRvdWJsZVwiKSApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5baV0gPSBcInRleHQtZGVjb3JhdGlvbjpsaW5lLXRocm91Z2hcIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwibXNvLXplcm8taGVpZ2h0XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggdmFsdWUgPT0gXCJ5ZXNcIiApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5baV0gPSBcImRpc3BsYXk6bm9uZVwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnYmFja2dyb3VuZCc6XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbWFyZ2luJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCAhL1sxLTldLy50ZXN0KCB2YWx1ZSApICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCAvXihtc298Y29sdW1ufGZvbnQtZW1waHxsYW5nfGxheW91dHxsaW5lLWJyZWFrfGxpc3QtaW1hZ2V8bmF2fHBhbm9zZXxwdW5jdHxyb3d8cnVieXxzZXB8c2l6ZXxzcmN8dGFiLXx0YWJsZS1ib3JkZXJ8dGV4dC0oPzpkZWNvcnx0cmFucyl8dG9wLWJhcnx2ZXJzaW9ufHZuZHx3b3JkLWJyZWFrKS8udGVzdCggbmFtZSApXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfHxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvdGV4dFxcLWluZGVudHxwYWRkaW5nfG1hcmdpbi8udGVzdChuYW1lKSAmJiAvXFwtW1xcZC5dKy8udGVzdCh2YWx1ZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5baV0gPSBuYW1lICsgXCI6XCIgKyBwYXJ0c1sxXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFnICsgKG4ubGVuZ3RoID8gJyBzdHlsZT1cIicgKyBuLmpvaW4oICc7JykucmVwbGFjZSgvO3syLH0vZywnOycpICsgJ1wiJyA6ICcnKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKCBodG1sICkge1xyXG4gICAgICAgIHJldHVybiAoaXNXb3JkRG9jdW1lbnQoIGh0bWwgKSA/IGZpbHRlclBhc3RlV29yZCggaHRtbCApIDogaHRtbCk7XHJcbiAgICB9O1xyXG59KCk7XG5cbi8vIGNvcmUvbm9kZS5qc1xuLyoqXG4gKiDnvJbovpHlmajmqKHmi5/nmoToioLngrnnsbtcbiAqIEBmaWxlXG4gKiBAbW9kdWxlIFVFXG4gKiBAY2xhc3MgdU5vZGVcbiAqIEBzaW5jZSAxLjIuNi4xXG4gKi9cblxuLyoqXG4gKiBVRWRpdG9y5YWs55So56m66Ze077yMVUVkaXRvcuaJgOacieeahOWKn+iDvemDveaMgui9veWcqOivpeepuumXtOS4i1xuICogQHVuZmlsZVxuICogQG1vZHVsZSBVRVxuICovXG5cbihmdW5jdGlvbiAoKSB7XG5cbiAgICAvKipcbiAgICAgKiDnvJbovpHlmajmqKHmi5/nmoToioLngrnnsbtcbiAgICAgKiBAdW5maWxlXG4gICAgICogQG1vZHVsZSBVRVxuICAgICAqIEBjbGFzcyB1Tm9kZVxuICAgICAqL1xuXG4gICAgLyoqXG4gICAgICog6YCa6L+H5LiA5Liq6ZSu5YC85a+577yM5Yib5bu65LiA5LiqdU5vZGXlr7nosaFcbiAgICAgKiBAY29uc3RydWN0b3JcbiAgICAgKiBAcGFyYW0geyBPYmplY3QgfSBhdHRyIOS8oOWFpeimgeWIm+W7uueahHVOb2Rl55qE5Yid5aeL5bGe5oCnXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICogdmFyIG5vZGUgPSBuZXcgdU5vZGUoe1xuICAgICAqICAgICB0eXBlOidlbGVtZW50JyxcbiAgICAgKiAgICAgdGFnTmFtZTonc3BhbicsXG4gICAgICogICAgIGF0dHJzOntzdHlsZTonZm9udC1zaXplOjE0cHg7J31cbiAgICAgKiB9XG4gICAgICogYGBgXG4gICAgICovXG4gICAgdmFyIHVOb2RlID0gVUUudU5vZGUgPSBmdW5jdGlvbiAob2JqKSB7XG4gICAgICAgIHRoaXMudHlwZSA9IG9iai50eXBlO1xuICAgICAgICB0aGlzLmRhdGEgPSBvYmouZGF0YTtcbiAgICAgICAgdGhpcy50YWdOYW1lID0gb2JqLnRhZ05hbWU7XG4gICAgICAgIHRoaXMucGFyZW50Tm9kZSA9IG9iai5wYXJlbnROb2RlO1xuICAgICAgICB0aGlzLmF0dHJzID0gb2JqLmF0dHJzIHx8IHt9O1xuICAgICAgICB0aGlzLmNoaWxkcmVuID0gb2JqLmNoaWxkcmVuO1xuICAgIH07XG5cbiAgICB2YXIgbm90VHJhbnNBdHRycyA9IHtcbiAgICAgICAgJ2hyZWYnOjEsXG4gICAgICAgICdzcmMnOjEsXG4gICAgICAgICdfc3JjJzoxLFxuICAgICAgICAnX2hyZWYnOjEsXG4gICAgICAgICdjZGF0YV9kYXRhJzoxXG4gICAgfTtcblxuICAgIHZhciBub3RUcmFuc1RhZ05hbWUgPSB7XG4gICAgICAgIHN0eWxlOjEsXG4gICAgICAgIHNjcmlwdDoxXG4gICAgfTtcblxuICAgIHZhciBpbmRlbnRDaGFyID0gJyAgICAnLFxuICAgICAgICBicmVha0NoYXIgPSAnXFxuJztcblxuICAgIGZ1bmN0aW9uIGluc2VydExpbmUoYXJyLCBjdXJyZW50LCBiZWdpbikge1xuICAgICAgICBhcnIucHVzaChicmVha0NoYXIpO1xuICAgICAgICByZXR1cm4gY3VycmVudCArIChiZWdpbiA/IDEgOiAtMSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gaW5zZXJ0SW5kZW50KGFyciwgY3VycmVudCkge1xuICAgICAgICAvL+aPkuWFpee8qei/m1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGN1cnJlbnQ7IGkrKykge1xuICAgICAgICAgICAgYXJyLnB1c2goaW5kZW50Q2hhcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvL+WIm+W7unVOb2Rl55qE6Z2Z5oCB5pa55rOVXG4gICAgLy/mlK/mjIHmoIfnrb7lkoxodG1sXG4gICAgdU5vZGUuY3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uIChodG1sKSB7XG4gICAgICAgIGlmICgvWzw+XS8udGVzdChodG1sKSkge1xuICAgICAgICAgICAgcmV0dXJuIFVFLmh0bWxwYXJzZXIoaHRtbCkuY2hpbGRyZW5bMF1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgdU5vZGUoe1xuICAgICAgICAgICAgICAgIHR5cGU6J2VsZW1lbnQnLFxuICAgICAgICAgICAgICAgIGNoaWxkcmVuOltdLFxuICAgICAgICAgICAgICAgIHRhZ05hbWU6aHRtbFxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgIH07XG4gICAgdU5vZGUuY3JlYXRlVGV4dCA9IGZ1bmN0aW9uIChkYXRhLG5vVHJhbnMpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBVRS51Tm9kZSh7XG4gICAgICAgICAgICB0eXBlOid0ZXh0JyxcbiAgICAgICAgICAgICdkYXRhJzpub1RyYW5zID8gZGF0YSA6IHV0aWxzLnVuaHRtbChkYXRhIHx8ICcnKVxuICAgICAgICB9KVxuICAgIH07XG4gICAgZnVuY3Rpb24gbm9kZVRvSHRtbChub2RlLCBhcnIsIGZvcm1hdHRlciwgY3VycmVudCkge1xuICAgICAgICBzd2l0Y2ggKG5vZGUudHlwZSkge1xuICAgICAgICAgICAgY2FzZSAncm9vdCc6XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IG5vZGUuY2hpbGRyZW5baSsrXTspIHtcbiAgICAgICAgICAgICAgICAgICAgLy/mj5LlhaXmlrDooYxcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1hdHRlciAmJiBjaS50eXBlID09ICdlbGVtZW50JyAmJiAhZHRkLiRpbmxpbmVXaXRoQVtjaS50YWdOYW1lXSAmJiBpID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0TGluZShhcnIsIGN1cnJlbnQsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0SW5kZW50KGFyciwgY3VycmVudClcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBub2RlVG9IdG1sKGNpLCBhcnIsIGZvcm1hdHRlciwgY3VycmVudClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICd0ZXh0JzpcbiAgICAgICAgICAgICAgICBpc1RleHQobm9kZSwgYXJyKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ2VsZW1lbnQnOlxuICAgICAgICAgICAgICAgIGlzRWxlbWVudChub2RlLCBhcnIsIGZvcm1hdHRlciwgY3VycmVudCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdjb21tZW50JzpcbiAgICAgICAgICAgICAgICBpc0NvbW1lbnQobm9kZSwgYXJyLCBmb3JtYXR0ZXIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhcnI7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gaXNUZXh0KG5vZGUsIGFycikge1xuICAgICAgICBpZihub2RlLnBhcmVudE5vZGUudGFnTmFtZSA9PSAncHJlJyl7XG4gICAgICAgICAgICAvL+a6kOeggeaooeW8j+S4i+i+k+WFpWh0bWzmoIfnrb7vvIzkuI3og73lgZrovazmjaLlpITnkIbvvIznm7TmjqXovpPlh7pcbiAgICAgICAgICAgIGFyci5wdXNoKG5vZGUuZGF0YSlcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICBhcnIucHVzaChub3RUcmFuc1RhZ05hbWVbbm9kZS5wYXJlbnROb2RlLnRhZ05hbWVdID8gdXRpbHMuaHRtbChub2RlLmRhdGEpIDogbm9kZS5kYXRhLnJlcGxhY2UoL1sgXXsyfS9nLCcgJm5ic3A7JykpXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGlzRWxlbWVudChub2RlLCBhcnIsIGZvcm1hdHRlciwgY3VycmVudCkge1xuICAgICAgICB2YXIgYXR0cmh0bWwgPSAnJztcbiAgICAgICAgaWYgKG5vZGUuYXR0cnMpIHtcbiAgICAgICAgICAgIGF0dHJodG1sID0gW107XG4gICAgICAgICAgICB2YXIgYXR0cnMgPSBub2RlLmF0dHJzO1xuICAgICAgICAgICAgZm9yICh2YXIgYSBpbiBhdHRycykge1xuICAgICAgICAgICAgICAgIC8v6L+Z6YeM5bCx6ZKI5a+5XG4gICAgICAgICAgICAgICAgLy88cD4nPGltZyBzcmM9J2h0dHA6Ly9uc2NsaWNrLmJhaWR1LmNvbS91LmdpZj8mYXNkZj1cXFwic2RmJmFzZGZhc2Rmczthc2RmJz48L3A+XG4gICAgICAgICAgICAgICAgLy/ov5nph4zovrnnmoRcXFwi5YGa6L2s5o2i77yM6KaB5LiN55SoaW5uZXJIVE1M55u05o6l6KKr5oiq5pat5LqG77yM5bGe5oCnc3JjXG4gICAgICAgICAgICAgICAgLy/mnInlj6/og73lgZrnmoTkuI3lpJ9cbiAgICAgICAgICAgICAgICBhdHRyaHRtbC5wdXNoKGEgKyAoYXR0cnNbYV0gIT09IHVuZGVmaW5lZCA/ICc9XCInICsgKG5vdFRyYW5zQXR0cnNbYV0gPyB1dGlscy5odG1sKGF0dHJzW2FdKS5yZXBsYWNlKC9bXCJdL2csIGZ1bmN0aW9uIChhKSB7XG4gICAgICAgICAgICAgICAgICAgcmV0dXJuICcmcXVvdDsnXG4gICAgICAgICAgICAgICAgfSkgOiB1dGlscy51bmh0bWwoYXR0cnNbYV0pKSArICdcIicgOiAnJykpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhdHRyaHRtbCA9IGF0dHJodG1sLmpvaW4oJyAnKTtcbiAgICAgICAgfVxuICAgICAgICBhcnIucHVzaCgnPCcgKyBub2RlLnRhZ05hbWUgK1xuICAgICAgICAgICAgKGF0dHJodG1sID8gJyAnICsgYXR0cmh0bWwgIDogJycpICtcbiAgICAgICAgICAgIChkdGQuJGVtcHR5W25vZGUudGFnTmFtZV0gPyAnXFwvJyA6ICcnICkgKyAnPidcbiAgICAgICAgKTtcbiAgICAgICAgLy/mj5LlhaXmlrDooYxcbiAgICAgICAgaWYgKGZvcm1hdHRlciAgJiYgICFkdGQuJGlubGluZVdpdGhBW25vZGUudGFnTmFtZV0gJiYgbm9kZS50YWdOYW1lICE9ICdwcmUnKSB7XG4gICAgICAgICAgICBpZihub2RlLmNoaWxkcmVuICYmIG5vZGUuY2hpbGRyZW4ubGVuZ3RoKXtcbiAgICAgICAgICAgICAgICBjdXJyZW50ID0gaW5zZXJ0TGluZShhcnIsIGN1cnJlbnQsIHRydWUpO1xuICAgICAgICAgICAgICAgIGluc2VydEluZGVudChhcnIsIGN1cnJlbnQpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuICAgICAgICBpZiAobm9kZS5jaGlsZHJlbiAmJiBub2RlLmNoaWxkcmVuLmxlbmd0aCkge1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IG5vZGUuY2hpbGRyZW5baSsrXTspIHtcbiAgICAgICAgICAgICAgICBpZiAoZm9ybWF0dGVyICYmIGNpLnR5cGUgPT0gJ2VsZW1lbnQnICYmICAhZHRkLiRpbmxpbmVXaXRoQVtjaS50YWdOYW1lXSAmJiBpID4gMSkge1xuICAgICAgICAgICAgICAgICAgICBpbnNlcnRMaW5lKGFyciwgY3VycmVudCk7XG4gICAgICAgICAgICAgICAgICAgIGluc2VydEluZGVudChhcnIsIGN1cnJlbnQpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG5vZGVUb0h0bWwoY2ksIGFyciwgZm9ybWF0dGVyLCBjdXJyZW50KVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghZHRkLiRlbXB0eVtub2RlLnRhZ05hbWVdKSB7XG4gICAgICAgICAgICBpZiAoZm9ybWF0dGVyICYmICFkdGQuJGlubGluZVdpdGhBW25vZGUudGFnTmFtZV0gICYmIG5vZGUudGFnTmFtZSAhPSAncHJlJykge1xuXG4gICAgICAgICAgICAgICAgaWYobm9kZS5jaGlsZHJlbiAmJiBub2RlLmNoaWxkcmVuLmxlbmd0aCl7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBpbnNlcnRMaW5lKGFyciwgY3VycmVudCk7XG4gICAgICAgICAgICAgICAgICAgIGluc2VydEluZGVudChhcnIsIGN1cnJlbnQpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXJyLnB1c2goJzxcXC8nICsgbm9kZS50YWdOYW1lICsgJz4nKTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gaXNDb21tZW50KG5vZGUsIGFycikge1xuICAgICAgICBhcnIucHVzaCgnPCEtLScgKyBub2RlLmRhdGEgKyAnLS0+Jyk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0Tm9kZUJ5SWQocm9vdCwgaWQpIHtcbiAgICAgICAgdmFyIG5vZGU7XG4gICAgICAgIGlmIChyb290LnR5cGUgPT0gJ2VsZW1lbnQnICYmIHJvb3QuZ2V0QXR0cignaWQnKSA9PSBpZCkge1xuICAgICAgICAgICAgcmV0dXJuIHJvb3Q7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJvb3QuY2hpbGRyZW4gJiYgcm9vdC5jaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSByb290LmNoaWxkcmVuW2krK107KSB7XG4gICAgICAgICAgICAgICAgaWYgKG5vZGUgPSBnZXROb2RlQnlJZChjaSwgaWQpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldE5vZGVzQnlUYWdOYW1lKG5vZGUsIHRhZ05hbWUsIGFycikge1xuICAgICAgICBpZiAobm9kZS50eXBlID09ICdlbGVtZW50JyAmJiBub2RlLnRhZ05hbWUgPT0gdGFnTmFtZSkge1xuICAgICAgICAgICAgYXJyLnB1c2gobm9kZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5vZGUuY2hpbGRyZW4gJiYgbm9kZS5jaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSBub2RlLmNoaWxkcmVuW2krK107KSB7XG4gICAgICAgICAgICAgICAgZ2V0Tm9kZXNCeVRhZ05hbWUoY2ksIHRhZ05hbWUsIGFycilcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBmdW5jdGlvbiBub2RlVHJhdmVyc2FsKHJvb3QsZm4pe1xuICAgICAgICBpZihyb290LmNoaWxkcmVuICYmIHJvb3QuY2hpbGRyZW4ubGVuZ3RoKXtcbiAgICAgICAgICAgIGZvcih2YXIgaT0gMCxjaTtjaT1yb290LmNoaWxkcmVuW2ldOyl7XG4gICAgICAgICAgICAgICAgbm9kZVRyYXZlcnNhbChjaSxmbik7XG4gICAgICAgICAgICAgICAgLy9jaeiiq+abv+aNoueahOaDheWGte+8jOi/memHjOWwseS4jeWGjei1sCBmbuS6hlxuICAgICAgICAgICAgICAgIGlmKGNpLnBhcmVudE5vZGUgKXtcbiAgICAgICAgICAgICAgICAgICAgaWYoY2kuY2hpbGRyZW4gJiYgY2kuY2hpbGRyZW4ubGVuZ3RoKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZuKGNpKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmKGNpLnBhcmVudE5vZGUpIGkrK1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICBmbihyb290KVxuICAgICAgICB9XG5cbiAgICB9XG4gICAgdU5vZGUucHJvdG90eXBlID0ge1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDlvZPliY3oioLngrnlr7nosaHvvIzovazmjaLmiJBodG1s5paH5pysXG4gICAgICAgICAqIEBtZXRob2QgdG9IdG1sXG4gICAgICAgICAqIEByZXR1cm4geyBTdHJpbmcgfSDov5Tlm57ovazmjaLlkI7nmoRodG1s5a2X56ym5LiyXG4gICAgICAgICAqIEBleGFtcGxlXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcbiAgICAgICAgICogbm9kZS50b0h0bWwoKTtcbiAgICAgICAgICogYGBgXG4gICAgICAgICAqL1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDlvZPliY3oioLngrnlr7nosaHvvIzovazmjaLmiJBodG1s5paH5pysXG4gICAgICAgICAqIEBtZXRob2QgdG9IdG1sXG4gICAgICAgICAqIEBwYXJhbSB7IEJvb2xlYW4gfSBmb3JtYXR0ZXIg5piv5ZCm5qC85byP5YyW6L+U5Zue5YC8XG4gICAgICAgICAqIEByZXR1cm4geyBTdHJpbmcgfSDov5Tlm57ovazmjaLlkI7nmoRodG1s5a2X56ym5LiyXG4gICAgICAgICAqIEBleGFtcGxlXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcbiAgICAgICAgICogbm9kZS50b0h0bWwoIHRydWUgKTtcbiAgICAgICAgICogYGBgXG4gICAgICAgICAqL1xuICAgICAgICB0b0h0bWw6ZnVuY3Rpb24gKGZvcm1hdHRlcikge1xuICAgICAgICAgICAgdmFyIGFyciA9IFtdO1xuICAgICAgICAgICAgbm9kZVRvSHRtbCh0aGlzLCBhcnIsIGZvcm1hdHRlciwgMCk7XG4gICAgICAgICAgICByZXR1cm4gYXJyLmpvaW4oJycpXG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOiOt+WPluiKgueCueeahGh0bWzlhoXlrrlcbiAgICAgICAgICogQG1ldGhvZCBpbm5lckhUTUxcbiAgICAgICAgICogQHdhcm5pbmcg5YGH5aaC6IqC54K555qEdHlwZeS4jeaYrydlbGVtZW50J++8jOaIluiKgueCueeahOagh+etvuWQjeensOS4jeWcqGR0ZOWIl+ihqOmHjO+8jOebtOaOpei/lOWbnuW9k+WJjeiKgueCuVxuICAgICAgICAgKiBAcmV0dXJuIHsgU3RyaW5nIH0g6L+U5Zue6IqC54K555qEaHRtbOWGheWuuVxuICAgICAgICAgKiBAZXhhbXBsZVxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAqIHZhciBodG1sc3RyID0gbm9kZS5pbm5lckhUTUwoKTtcbiAgICAgICAgICogYGBgXG4gICAgICAgICAqL1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDorr7nva7oioLngrnnmoRodG1s5YaF5a65XG4gICAgICAgICAqIEBtZXRob2QgaW5uZXJIVE1MXG4gICAgICAgICAqIEB3YXJuaW5nIOWBh+WmguiKgueCueeahHR5cGXkuI3mmK8nZWxlbWVudCfvvIzmiJboioLngrnnmoTmoIfnrb7lkI3np7DkuI3lnKhkdGTliJfooajph4zvvIznm7TmjqXov5Tlm57lvZPliY3oioLngrlcbiAgICAgICAgICogQHBhcmFtIHsgU3RyaW5nIH0gaHRtbHN0ciDkvKDlhaXopoHorr7nva7nmoRodG1s5YaF5a65XG4gICAgICAgICAqIEByZXR1cm4geyBVRS51Tm9kZSB9IOi/lOWbnuiKgueCueacrOi6q1xuICAgICAgICAgKiBAZXhhbXBsZVxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAqIG5vZGUuaW5uZXJIVE1MKCc8c3Bhbj50ZXh0PC9zcGFuPicpO1xuICAgICAgICAgKiBgYGBcbiAgICAgICAgICovXG4gICAgICAgIGlubmVySFRNTDpmdW5jdGlvbiAoaHRtbHN0cikge1xuICAgICAgICAgICAgaWYgKHRoaXMudHlwZSAhPSAnZWxlbWVudCcgfHwgZHRkLiRlbXB0eVt0aGlzLnRhZ05hbWVdKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodXRpbHMuaXNTdHJpbmcoaHRtbHN0cikpIHtcbiAgICAgICAgICAgICAgICBpZih0aGlzLmNoaWxkcmVuKXtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IHRoaXMuY2hpbGRyZW5baSsrXTspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNpLnBhcmVudE5vZGUgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4gPSBbXTtcbiAgICAgICAgICAgICAgICB2YXIgdG1wUm9vdCA9IFVFLmh0bWxwYXJzZXIoaHRtbHN0cik7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IHRtcFJvb3QuY2hpbGRyZW5baSsrXTspIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGlsZHJlbi5wdXNoKGNpKTtcbiAgICAgICAgICAgICAgICAgICAgY2kucGFyZW50Tm9kZSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgdG1wUm9vdCA9IG5ldyBVRS51Tm9kZSh7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6J3Jvb3QnLFxuICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjp0aGlzLmNoaWxkcmVuXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRtcFJvb3QudG9IdG1sKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOiOt+WPluiKgueCueeahOe6r+aWh+acrOWGheWuuVxuICAgICAgICAgKiBAbWV0aG9kIGlubmVyVGV4dFxuICAgICAgICAgKiBAd2FybmluZyDlgYflpoLoioLngrnnmoR0eXBl5LiN5pivJ2VsZW1lbnQn77yM5oiW6IqC54K555qE5qCH562+5ZCN56ew5LiN5ZyoZHRk5YiX6KGo6YeM77yM55u05o6l6L+U5Zue5b2T5YmN6IqC54K5XG4gICAgICAgICAqIEByZXR1cm4geyBTdHJpbmcgfSDov5Tlm57oioLngrnnmoTlrZjmlofmnKzlhoXlrrlcbiAgICAgICAgICogQGV4YW1wbGVcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxuICAgICAgICAgKiB2YXIgdGV4dFN0ciA9IG5vZGUuaW5uZXJUZXh0KCk7XG4gICAgICAgICAqIGBgYFxuICAgICAgICAgKi9cblxuICAgICAgICAvKipcbiAgICAgICAgICog6K6+572u6IqC54K555qE57qv5paH5pys5YaF5a65XG4gICAgICAgICAqIEBtZXRob2QgaW5uZXJUZXh0XG4gICAgICAgICAqIEB3YXJuaW5nIOWBh+WmguiKgueCueeahHR5cGXkuI3mmK8nZWxlbWVudCfvvIzmiJboioLngrnnmoTmoIfnrb7lkI3np7DkuI3lnKhkdGTliJfooajph4zvvIznm7TmjqXov5Tlm57lvZPliY3oioLngrlcbiAgICAgICAgICogQHBhcmFtIHsgU3RyaW5nIH0gdGV4dFN0ciDkvKDlhaXopoHorr7nva7nmoTmlofmnKzlhoXlrrlcbiAgICAgICAgICogQHJldHVybiB7IFVFLnVOb2RlIH0g6L+U5Zue6IqC54K55pys6LqrXG4gICAgICAgICAqIEBleGFtcGxlXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcbiAgICAgICAgICogbm9kZS5pbm5lclRleHQoJzxzcGFuPnRleHQ8L3NwYW4+Jyk7XG4gICAgICAgICAqIGBgYFxuICAgICAgICAgKi9cbiAgICAgICAgaW5uZXJUZXh0OmZ1bmN0aW9uICh0ZXh0U3RyLG5vVHJhbnMpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnR5cGUgIT0gJ2VsZW1lbnQnIHx8IGR0ZC4kZW1wdHlbdGhpcy50YWdOYW1lXSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRleHRTdHIpIHtcbiAgICAgICAgICAgICAgICBpZih0aGlzLmNoaWxkcmVuKXtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IHRoaXMuY2hpbGRyZW5baSsrXTspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNpLnBhcmVudE5vZGUgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4gPSBbXTtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZENoaWxkKHVOb2RlLmNyZWF0ZVRleHQodGV4dFN0cixub1RyYW5zKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnRvSHRtbCgpLnJlcGxhY2UoLzxbXj5dKz4vZywgJycpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDojrflj5blvZPliY3lr7nosaHnmoRkYXRh5bGe5oCnXG4gICAgICAgICAqIEBtZXRob2QgZ2V0RGF0YVxuICAgICAgICAgKiBAcmV0dXJuIHsgT2JqZWN0IH0g6Iul6IqC54K555qEdHlwZeWAvOaYr2VsZW1lbmV077yM6L+U5Zue56m65a2X56ym5Liy77yM5ZCm5YiZ6L+U5Zue6IqC54K555qEZGF0YeWxnuaAp1xuICAgICAgICAgKiBAZXhhbXBsZVxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAqIG5vZGUuZ2V0RGF0YSgpO1xuICAgICAgICAgKiBgYGBcbiAgICAgICAgICovXG4gICAgICAgIGdldERhdGE6ZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHRoaXMudHlwZSA9PSAnZWxlbWVudCcpXG4gICAgICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YVxuICAgICAgICB9LFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDojrflj5blvZPliY3oioLngrnkuIvnmoTnrKzkuIDkuKrlrZDoioLngrlcbiAgICAgICAgICogQG1ldGhvZCBmaXJzdENoaWxkXG4gICAgICAgICAqIEByZXR1cm4geyBVRS51Tm9kZSB9IOi/lOWbnuesrOS4gOS4quWtkOiKgueCuVxuICAgICAgICAgKiBAZXhhbXBsZVxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAqIG5vZGUuZmlyc3RDaGlsZCgpOyAvL+i/lOWbnuesrOS4gOS4quWtkOiKgueCuVxuICAgICAgICAgKiBgYGBcbiAgICAgICAgICovXG4gICAgICAgIGZpcnN0Q2hpbGQ6ZnVuY3Rpb24gKCkge1xuLy8gICAgICAgICAgICBpZiAodGhpcy50eXBlICE9ICdlbGVtZW50JyB8fCBkdGQuJGVtcHR5W3RoaXMudGFnTmFtZV0pIHtcbi8vICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuLy8gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jaGlsZHJlbiA/IHRoaXMuY2hpbGRyZW5bMF0gOiBudWxsO1xuICAgICAgICB9LFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDojrflj5blvZPliY3oioLngrnkuIvnmoTmnIDlkI7kuIDkuKrlrZDoioLngrlcbiAgICAgICAgICogQG1ldGhvZCBsYXN0Q2hpbGRcbiAgICAgICAgICogQHJldHVybiB7IFVFLnVOb2RlIH0g6L+U5Zue5pyA5ZCO5LiA5Liq5a2Q6IqC54K5XG4gICAgICAgICAqIEBleGFtcGxlXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcbiAgICAgICAgICogbm9kZS5sYXN0Q2hpbGQoKTsgLy/ov5Tlm57mnIDlkI7kuIDkuKrlrZDoioLngrlcbiAgICAgICAgICogYGBgXG4gICAgICAgICAqL1xuICAgICAgICBsYXN0Q2hpbGQ6ZnVuY3Rpb24gKCkge1xuLy8gICAgICAgICAgICBpZiAodGhpcy50eXBlICE9ICdlbGVtZW50JyB8fCBkdGQuJGVtcHR5W3RoaXMudGFnTmFtZV0gKSB7XG4vLyAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbi8vICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hpbGRyZW4gPyB0aGlzLmNoaWxkcmVuW3RoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gMV0gOiBudWxsO1xuICAgICAgICB9LFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDojrflj5blkozlvZPliY3oioLngrnmnInnm7jlkIzniLbkurLoioLngrnnmoTliY3kuIDkuKroioLngrlcbiAgICAgICAgICogQG1ldGhvZCBwcmV2aW91c1NpYmxpbmdcbiAgICAgICAgICogQHJldHVybiB7IFVFLnVOb2RlIH0g6L+U5Zue5YmN5LiA5Liq6IqC54K5XG4gICAgICAgICAqIEBleGFtcGxlXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcbiAgICAgICAgICogbm9kZS5jaGlsZHJlblsyXS5wcmV2aW91c1NpYmxpbmcoKTsgLy/ov5Tlm57lrZDoioLngrlub2RlLmNoaWxkcmVuWzFdXG4gICAgICAgICAqIGBgYFxuICAgICAgICAgKi9cbiAgICAgICAgcHJldmlvdXNTaWJsaW5nIDogZnVuY3Rpb24oKXtcbiAgICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLnBhcmVudE5vZGU7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2k7IGNpID0gcGFyZW50LmNoaWxkcmVuW2ldOyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoY2kgPT09IHRoaXMpIHtcbiAgICAgICAgICAgICAgICAgICByZXR1cm4gaSA9PSAwID8gbnVsbCA6IHBhcmVudC5jaGlsZHJlbltpLTFdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9LFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDojrflj5blkozlvZPliY3oioLngrnmnInnm7jlkIzniLbkurLoioLngrnnmoTlkI7kuIDkuKroioLngrlcbiAgICAgICAgICogQG1ldGhvZCBuZXh0U2libGluZ1xuICAgICAgICAgKiBAcmV0dXJuIHsgVUUudU5vZGUgfSDov5Tlm57lkI7kuIDkuKroioLngrks5om+5LiN5Yiw6L+U5ZuebnVsbFxuICAgICAgICAgKiBAZXhhbXBsZVxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAqIG5vZGUuY2hpbGRyZW5bMl0ubmV4dFNpYmxpbmcoKTsgLy/lpoLmnpzmnInvvIzov5Tlm57lrZDoioLngrlub2RlLmNoaWxkcmVuWzNdXG4gICAgICAgICAqIGBgYFxuICAgICAgICAgKi9cbiAgICAgICAgbmV4dFNpYmxpbmcgOiBmdW5jdGlvbigpe1xuICAgICAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMucGFyZW50Tm9kZTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSBwYXJlbnQuY2hpbGRyZW5baSsrXTspIHtcbiAgICAgICAgICAgICAgICBpZiAoY2kgPT09IHRoaXMpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudC5jaGlsZHJlbltpXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOeUqOaWsOeahOiKgueCueabv+aNouW9k+WJjeiKgueCuVxuICAgICAgICAgKiBAbWV0aG9kIHJlcGxhY2VDaGlsZFxuICAgICAgICAgKiBAcGFyYW0geyBVRS51Tm9kZSB9IHRhcmdldCDopoHmm7/mjaLmiJDor6XoioLngrnlj4LmlbBcbiAgICAgICAgICogQHBhcmFtIHsgVUUudU5vZGUgfSBzb3VyY2Ug6KaB6KKr5pu/5o2i5o6J55qE6IqC54K5XG4gICAgICAgICAqIEByZXR1cm4geyBVRS51Tm9kZSB9IOi/lOWbnuabv+aNouS5i+WQjueahOiKgueCueWvueixoVxuICAgICAgICAgKiBAZXhhbXBsZVxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAqIG5vZGUucmVwbGFjZUNoaWxkKG5ld05vZGUsIGNoaWxkTm9kZSk7IC8v55SobmV3Tm9kZeabv+aNomNoaWxkTm9kZSxjaGlsZE5vZGXmmK9ub2Rl55qE5a2Q6IqC54K5XG4gICAgICAgICAqIGBgYFxuICAgICAgICAgKi9cbiAgICAgICAgcmVwbGFjZUNoaWxkOmZ1bmN0aW9uICh0YXJnZXQsIHNvdXJjZSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgICAgICBpZih0YXJnZXQucGFyZW50Tm9kZSl7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRhcmdldCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSB0aGlzLmNoaWxkcmVuW2ldOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNpID09PSBzb3VyY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4uc3BsaWNlKGksIDEsIHRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2UucGFyZW50Tm9kZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQucGFyZW50Tm9kZSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDlnKjoioLngrnnmoTlrZDoioLngrnliJfooajmnIDlkI7kvY3nva7mj5LlhaXkuIDkuKroioLngrlcbiAgICAgICAgICogQG1ldGhvZCBhcHBlbmRDaGlsZFxuICAgICAgICAgKiBAcGFyYW0geyBVRS51Tm9kZSB9IG5vZGUg6KaB5o+S5YWl55qE6IqC54K5XG4gICAgICAgICAqIEByZXR1cm4geyBVRS51Tm9kZSB9IOi/lOWbnuWImuaPkuWFpeeahOWtkOiKgueCuVxuICAgICAgICAgKiBAZXhhbXBsZVxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAqIG5vZGUuYXBwZW5kQ2hpbGQoIG5ld05vZGUgKTsgLy/lnKhub2Rl5YaF5o+S5YWl5a2Q6IqC54K5bmV3Tm9kZVxuICAgICAgICAgKiBgYGBcbiAgICAgICAgICovXG4gICAgICAgIGFwcGVuZENoaWxkOmZ1bmN0aW9uIChub2RlKSB7XG4gICAgICAgICAgICBpZiAodGhpcy50eXBlID09ICdyb290JyB8fCAodGhpcy50eXBlID09ICdlbGVtZW50JyAmJiAhZHRkLiRlbXB0eVt0aGlzLnRhZ05hbWVdKSkge1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy5jaGlsZHJlbikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNoaWxkcmVuID0gW11cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYobm9kZS5wYXJlbnROb2RlKXtcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2k7IGNpID0gdGhpcy5jaGlsZHJlbltpXTsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjaSA9PT0gbm9kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmNoaWxkcmVuLnB1c2gobm9kZSk7XG4gICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlID0gdGhpcztcbiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTtcbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOWcqOS8oOWFpeiKgueCueeahOWJjemdouaPkuWFpeS4gOS4quiKgueCuVxuICAgICAgICAgKiBAbWV0aG9kIGluc2VydEJlZm9yZVxuICAgICAgICAgKiBAcGFyYW0geyBVRS51Tm9kZSB9IHRhcmdldCDopoHmj5LlhaXnmoToioLngrlcbiAgICAgICAgICogQHBhcmFtIHsgVUUudU5vZGUgfSBzb3VyY2Ug5Zyo6K+l5Y+C5pWw6IqC54K55YmN6Z2i5o+S5YWlXG4gICAgICAgICAqIEByZXR1cm4geyBVRS51Tm9kZSB9IOi/lOWbnuWImuaPkuWFpeeahOWtkOiKgueCuVxuICAgICAgICAgKiBAZXhhbXBsZVxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAqIG5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobmV3Tm9kZSwgbm9kZSk7IC8v5Zyobm9kZeiKgueCueWQjumdouaPkuWFpW5ld05vZGVcbiAgICAgICAgICogYGBgXG4gICAgICAgICAqL1xuICAgICAgICBpbnNlcnRCZWZvcmU6ZnVuY3Rpb24gKHRhcmdldCwgc291cmNlKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbikge1xuICAgICAgICAgICAgICAgIGlmKHRhcmdldC5wYXJlbnROb2RlKXtcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGFyZ2V0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IHRoaXMuY2hpbGRyZW5baV07IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2kgPT09IHNvdXJjZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaSwgMCwgdGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5wYXJlbnROb2RlID0gdGhpcztcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcblxuICAgICAgICAvKipcbiAgICAgICAgICog5Zyo5Lyg5YWl6IqC54K555qE5ZCO6Z2i5o+S5YWl5LiA5Liq6IqC54K5XG4gICAgICAgICAqIEBtZXRob2QgaW5zZXJ0QWZ0ZXJcbiAgICAgICAgICogQHBhcmFtIHsgVUUudU5vZGUgfSB0YXJnZXQg6KaB5o+S5YWl55qE6IqC54K5XG4gICAgICAgICAqIEBwYXJhbSB7IFVFLnVOb2RlIH0gc291cmNlIOWcqOivpeWPguaVsOiKgueCueWQjumdouaPkuWFpVxuICAgICAgICAgKiBAcmV0dXJuIHsgVUUudU5vZGUgfSDov5Tlm57liJrmj5LlhaXnmoTlrZDoioLngrlcbiAgICAgICAgICogQGV4YW1wbGVcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxuICAgICAgICAgKiBub2RlLnBhcmVudE5vZGUuaW5zZXJ0QWZ0ZXIobmV3Tm9kZSwgbm9kZSk7IC8v5Zyobm9kZeiKgueCueWQjumdouaPkuWFpW5ld05vZGVcbiAgICAgICAgICogYGBgXG4gICAgICAgICAqL1xuICAgICAgICBpbnNlcnRBZnRlcjpmdW5jdGlvbiAodGFyZ2V0LCBzb3VyY2UpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmNoaWxkcmVuKSB7XG4gICAgICAgICAgICAgICAgaWYodGFyZ2V0LnBhcmVudE5vZGUpe1xuICAgICAgICAgICAgICAgICAgICB0YXJnZXQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0YXJnZXQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2k7IGNpID0gdGhpcy5jaGlsZHJlbltpXTsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjaSA9PT0gc291cmNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoaWxkcmVuLnNwbGljZShpICsgMSwgMCwgdGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5wYXJlbnROb2RlID0gdGhpcztcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXQ7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcblxuICAgICAgICAvKipcbiAgICAgICAgICog5LuO5b2T5YmN6IqC54K555qE5a2Q6IqC54K55YiX6KGo5Lit77yM56e76Zmk6IqC54K5XG4gICAgICAgICAqIEBtZXRob2QgcmVtb3ZlQ2hpbGRcbiAgICAgICAgICogQHBhcmFtIHsgVUUudU5vZGUgfSBub2RlIOimgeenu+mZpOeahOiKgueCueW8leeUqFxuICAgICAgICAgKiBAcGFyYW0geyBCb29sZWFuIH0ga2VlcENoaWxkcmVuIOaYr+WQpuS/neeVmeenu+mZpOiKgueCueeahOWtkOiKgueCue+8jOiLpeS8oOWFpXRydWXvvIzoh6rliqjmiornp7vpmaToioLngrnnmoTlrZDoioLngrnmj5LlhaXliLDnp7vpmaTnmoTkvY3nva5cbiAgICAgICAgICogQHJldHVybiB7ICogfSDov5Tlm57liJrnp7vpmaTnmoTlrZDoioLngrlcbiAgICAgICAgICogQGV4YW1wbGVcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxuICAgICAgICAgKiBub2RlLnJlbW92ZUNoaWxkKGNoaWxkTm9kZSx0cnVlKTsgLy/lnKhub2Rl55qE5a2Q6IqC54K55YiX6KGo5Lit56e76ZmkY2hpbGToioLngrnvvIzlubbkuJTlkKdjaGlsZOeahOWtkOiKgueCueaPkuWFpeWIsOenu+mZpOeahOS9jee9rlxuICAgICAgICAgKiBgYGBcbiAgICAgICAgICovXG4gICAgICAgIHJlbW92ZUNoaWxkOmZ1bmN0aW9uIChub2RlLGtlZXBDaGlsZHJlbikge1xuICAgICAgICAgICAgaWYgKHRoaXMuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2k7IGNpID0gdGhpcy5jaGlsZHJlbltpXTsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjaSA9PT0gbm9kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaS5wYXJlbnROb2RlID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGtlZXBDaGlsZHJlbiAmJiBjaS5jaGlsZHJlbiAmJiBjaS5jaGlsZHJlbi5sZW5ndGgpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaj0gMCxjajtjaj1jaS5jaGlsZHJlbltqXTtqKyspe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoaWxkcmVuLnNwbGljZShpK2osMCxjaik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNqLnBhcmVudE5vZGUgPSB0aGlzO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDojrflj5blvZPliY3oioLngrnmiYDku6PooajnmoTlhYPntKDlsZ7mgKfvvIzljbPojrflj5ZhdHRyc+WvueixoeS4i+eahOWxnuaAp+WAvFxuICAgICAgICAgKiBAbWV0aG9kIGdldEF0dHJcbiAgICAgICAgICogQHBhcmFtIHsgU3RyaW5nIH0gYXR0ck5hbWUg6KaB6I635Y+W55qE5bGe5oCn5ZCN56ewXG4gICAgICAgICAqIEByZXR1cm4geyAqIH0g6L+U5ZueYXR0cnPlr7nosaHkuIvnmoTlsZ7mgKflgLxcbiAgICAgICAgICogQGV4YW1wbGVcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxuICAgICAgICAgKiBub2RlLmdldEF0dHIoJ3RpdGxlJyk7XG4gICAgICAgICAqIGBgYFxuICAgICAgICAgKi9cbiAgICAgICAgZ2V0QXR0cjpmdW5jdGlvbiAoYXR0ck5hbWUpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmF0dHJzICYmIHRoaXMuYXR0cnNbYXR0ck5hbWUudG9Mb3dlckNhc2UoKV1cbiAgICAgICAgfSxcblxuICAgICAgICAvKipcbiAgICAgICAgICog6K6+572u5b2T5YmN6IqC54K55omA5Luj6KGo55qE5YWD57Sg5bGe5oCn77yM5Y2z6K6+572uYXR0cnPlr7nosaHkuIvnmoTlsZ7mgKflgLxcbiAgICAgICAgICogQG1ldGhvZCBzZXRBdHRyXG4gICAgICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGF0dHJOYW1lIOimgeiuvue9rueahOWxnuaAp+WQjeensFxuICAgICAgICAgKiBAcGFyYW0geyAqIH0gYXR0clZhbCDopoHorr7nva7nmoTlsZ7mgKflgLzvvIznsbvlnovop4borr7nva7nmoTlsZ7mgKfogIzlrppcbiAgICAgICAgICogQHJldHVybiB7ICogfSDov5Tlm55hdHRyc+WvueixoeS4i+eahOWxnuaAp+WAvFxuICAgICAgICAgKiBAZXhhbXBsZVxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAqIG5vZGUuc2V0QXR0cigndGl0bGUnLCfmoIfpopgnKTtcbiAgICAgICAgICogYGBgXG4gICAgICAgICAqL1xuICAgICAgICBzZXRBdHRyOmZ1bmN0aW9uIChhdHRyTmFtZSwgYXR0clZhbCkge1xuICAgICAgICAgICAgaWYgKCFhdHRyTmFtZSkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmF0dHJzO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmKCF0aGlzLmF0dHJzKXtcbiAgICAgICAgICAgICAgICB0aGlzLmF0dHJzID0ge307XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodXRpbHMuaXNPYmplY3QoYXR0ck5hbWUpKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgYSBpbiBhdHRyTmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWF0dHJOYW1lW2FdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5hdHRyc1thXVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdHRyc1thLnRvTG93ZXJDYXNlKCldID0gYXR0ck5hbWVbYV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmICghYXR0clZhbCkge1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5hdHRyc1thdHRyTmFtZV1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmF0dHJzW2F0dHJOYW1lLnRvTG93ZXJDYXNlKCldID0gYXR0clZhbDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcblxuICAgICAgICAvKipcbiAgICAgICAgICog6I635Y+W5b2T5YmN6IqC54K55Zyo54i26IqC54K55LiL55qE5L2N572u57Si5byVXG4gICAgICAgICAqIEBtZXRob2QgZ2V0SW5kZXhcbiAgICAgICAgICogQHJldHVybiB7IE51bWJlciB9IOi/lOWbnue0ouW8leaVsOWAvO+8jOWmguaenOayoeacieeItuiKgueCue+8jOi/lOWbni0xXG4gICAgICAgICAqIEBleGFtcGxlXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcbiAgICAgICAgICogbm9kZS5nZXRJbmRleCgpO1xuICAgICAgICAgKiBgYGBcbiAgICAgICAgICovXG4gICAgICAgIGdldEluZGV4OmZ1bmN0aW9uKCl7XG4gICAgICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy5wYXJlbnROb2RlO1xuICAgICAgICAgICAgZm9yKHZhciBpPSAwLGNpO2NpPXBhcmVudC5jaGlsZHJlbltpXTtpKyspe1xuICAgICAgICAgICAgICAgIGlmKGNpID09PSB0aGlzKXtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICB9LFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDlnKjlvZPliY3oioLngrnkuIvvvIzmoLnmja5pZOafpeaJvuiKgueCuVxuICAgICAgICAgKiBAbWV0aG9kIGdldE5vZGVCeUlkXG4gICAgICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGlkIOimgeafpeaJvueahGlkXG4gICAgICAgICAqIEByZXR1cm4geyBVRS51Tm9kZSB9IOi/lOWbnuaJvuWIsOeahOiKgueCuVxuICAgICAgICAgKiBAZXhhbXBsZVxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAqIG5vZGUuZ2V0Tm9kZUJ5SWQoJ3RleHRJZCcpO1xuICAgICAgICAgKiBgYGBcbiAgICAgICAgICovXG4gICAgICAgIGdldE5vZGVCeUlkOmZ1bmN0aW9uIChpZCkge1xuICAgICAgICAgICAgdmFyIG5vZGU7XG4gICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbiAmJiB0aGlzLmNoaWxkcmVuLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSB0aGlzLmNoaWxkcmVuW2krK107KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChub2RlID0gZ2V0Tm9kZUJ5SWQoY2ksIGlkKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOWcqOW9k+WJjeiKgueCueS4i++8jOagueaNruWFg+e0oOWQjeensOafpeaJvuiKgueCueWIl+ihqFxuICAgICAgICAgKiBAbWV0aG9kIGdldE5vZGVzQnlUYWdOYW1lXG4gICAgICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IHRhZ05hbWVzIOimgeafpeaJvueahOWFg+e0oOWQjeensFxuICAgICAgICAgKiBAcmV0dXJuIHsgQXJyYXkgfSDov5Tlm57mib7liLDnmoToioLngrnliJfooahcbiAgICAgICAgICogQGV4YW1wbGVcbiAgICAgICAgICogYGBgamF2YXNjcmlwdFxuICAgICAgICAgKiBub2RlLmdldE5vZGVzQnlUYWdOYW1lKCdzcGFuJyk7XG4gICAgICAgICAqIGBgYFxuICAgICAgICAgKi9cbiAgICAgICAgZ2V0Tm9kZXNCeVRhZ05hbWU6ZnVuY3Rpb24gKHRhZ05hbWVzKSB7XG4gICAgICAgICAgICB0YWdOYW1lcyA9IHV0aWxzLnRyaW0odGFnTmFtZXMpLnJlcGxhY2UoL1sgXXsyLH0vZywgJyAnKS5zcGxpdCgnICcpO1xuICAgICAgICAgICAgdmFyIGFyciA9IFtdLCBtZSA9IHRoaXM7XG4gICAgICAgICAgICB1dGlscy5lYWNoKHRhZ05hbWVzLCBmdW5jdGlvbiAodGFnTmFtZSkge1xuICAgICAgICAgICAgICAgIGlmIChtZS5jaGlsZHJlbiAmJiBtZS5jaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IG1lLmNoaWxkcmVuW2krK107KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBnZXROb2Rlc0J5VGFnTmFtZShjaSwgdGFnTmFtZSwgYXJyKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gYXJyO1xuICAgICAgICB9LFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDmoLnmja7moLflvI/lkI3np7DvvIzojrflj5boioLngrnnmoTmoLflvI/lgLxcbiAgICAgICAgICogQG1ldGhvZCBnZXRTdHlsZVxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBuYW1lIOimgeiOt+WPlueahOagt+W8j+WQjeensFxuICAgICAgICAgKiBAcmV0dXJuIHsgU3RyaW5nIH0g6L+U5Zue5qC35byP5YC8XG4gICAgICAgICAqIEBleGFtcGxlXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcbiAgICAgICAgICogbm9kZS5nZXRTdHlsZSgnZm9udC1zaXplJyk7XG4gICAgICAgICAqIGBgYFxuICAgICAgICAgKi9cbiAgICAgICAgZ2V0U3R5bGU6ZnVuY3Rpb24gKG5hbWUpIHtcbiAgICAgICAgICAgIHZhciBjc3NTdHlsZSA9IHRoaXMuZ2V0QXR0cignc3R5bGUnKTtcbiAgICAgICAgICAgIGlmICghY3NzU3R5bGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gJydcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciByZWcgPSBuZXcgUmVnRXhwKCcoXnw7KVxcXFxzKicgKyBuYW1lICsgJzooW147XSspJywnaScpO1xuICAgICAgICAgICAgdmFyIG1hdGNoID0gY3NzU3R5bGUubWF0Y2gocmVnKTtcbiAgICAgICAgICAgIGlmIChtYXRjaCAmJiBtYXRjaFswXSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaFsyXVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9LFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDnu5noioLngrnorr7nva7moLflvI9cbiAgICAgICAgICogQG1ldGhvZCBzZXRTdHlsZVxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBuYW1lIOimgeiuvue9rueahOeahOagt+W8j+WQjeensFxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSB2YWwg6KaB6K6+572u55qE55qE5qC35YC8XG4gICAgICAgICAqIEBleGFtcGxlXG4gICAgICAgICAqIGBgYGphdmFzY3JpcHRcbiAgICAgICAgICogbm9kZS5zZXRTdHlsZSgnZm9udC1zaXplJywgJzEycHgnKTtcbiAgICAgICAgICogYGBgXG4gICAgICAgICAqL1xuICAgICAgICBzZXRTdHlsZTpmdW5jdGlvbiAobmFtZSwgdmFsKSB7XG4gICAgICAgICAgICBmdW5jdGlvbiBleGVjKG5hbWUsIHZhbCkge1xuICAgICAgICAgICAgICAgIHZhciByZWcgPSBuZXcgUmVnRXhwKCcoXnw7KVxcXFxzKicgKyBuYW1lICsgJzooW147XSs7PyknLCAnZ2knKTtcbiAgICAgICAgICAgICAgICBjc3NTdHlsZSA9IGNzc1N0eWxlLnJlcGxhY2UocmVnLCAnJDEnKTtcbiAgICAgICAgICAgICAgICBpZiAodmFsKSB7XG4gICAgICAgICAgICAgICAgICAgIGNzc1N0eWxlID0gbmFtZSArICc6JyArIHV0aWxzLnVuaHRtbCh2YWwpICsgJzsnICsgY3NzU3R5bGVcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIGNzc1N0eWxlID0gdGhpcy5nZXRBdHRyKCdzdHlsZScpO1xuICAgICAgICAgICAgaWYgKCFjc3NTdHlsZSkge1xuICAgICAgICAgICAgICAgIGNzc1N0eWxlID0gJyc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodXRpbHMuaXNPYmplY3QobmFtZSkpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBhIGluIG5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgZXhlYyhhLCBuYW1lW2FdKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZXhlYyhuYW1lLCB2YWwpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNldEF0dHIoJ3N0eWxlJywgdXRpbHMudHJpbShjc3NTdHlsZSkpXG4gICAgICAgIH0sXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOS8oOWFpeS4gOS4quWHveaVsO+8jOmAkuW9kumBjeWOhuW9k+WJjeiKgueCueS4i+eahOaJgOacieiKgueCuVxuICAgICAgICAgKiBAbWV0aG9kIHRyYXZlcnNhbFxuICAgICAgICAgKiBAcGFyYW0geyBGdW5jdGlvbiB9IGZuIOmBjeWOhuWIsOiKgueCueeahOaXtu+8jOS8oOWFpeiKgueCueS9nOS4uuWPguaVsO+8jOi/kOihjOatpOWHveaVsFxuICAgICAgICAgKiBAZXhhbXBsZVxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAqIHRyYXZlcnNhbChub2RlLCBmdW5jdGlvbigpe1xuICAgICAgICAgKiAgICAgY29uc29sZS5sb2cobm9kZS50eXBlKTtcbiAgICAgICAgICogfSk7XG4gICAgICAgICAqIGBgYFxuICAgICAgICAgKi9cbiAgICAgICAgdHJhdmVyc2FsOmZ1bmN0aW9uKGZuKXtcbiAgICAgICAgICAgIGlmKHRoaXMuY2hpbGRyZW4gJiYgdGhpcy5jaGlsZHJlbi5sZW5ndGgpe1xuICAgICAgICAgICAgICAgIG5vZGVUcmF2ZXJzYWwodGhpcyxmbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgfVxuICAgIH1cbn0pKCk7XG5cblxuLy8gY29yZS9odG1scGFyc2VyLmpzXG4vKipcbiAqIGh0bWzlrZfnrKbkuLLovazmjaLmiJB1Tm9kZeiKgueCuVxuICogQGZpbGVcbiAqIEBtb2R1bGUgVUVcbiAqIEBzaW5jZSAxLjIuNi4xXG4gKi9cblxuLyoqXG4gKiBVRWRpdG9y5YWs55So56m66Ze077yMVUVkaXRvcuaJgOacieeahOWKn+iDvemDveaMgui9veWcqOivpeepuumXtOS4i1xuICogQHVuZmlsZVxuICogQG1vZHVsZSBVRVxuICovXG5cbi8qKlxuICogaHRtbOWtl+espuS4sui9rOaNouaIkHVOb2Rl6IqC54K555qE6Z2Z5oCB5pa55rOVXG4gKiBAbWV0aG9kIGh0bWxwYXJzZXJcbiAqIEBwYXJhbSB7IFN0cmluZyB9IGh0bWxzdHIg6KaB6L2s5o2i55qEaHRtbOS7o+eggVxuICogQHBhcmFtIHsgQm9vbGVhbiB9IGlnbm9yZUJsYW5rIOiLpeiuvue9ruS4unRydWXvvIzovazmjaLnmoTml7blgJnlv73nlaVcXG5cXHJcXHTnrYnnqbrnmb3lrZfnrKZcbiAqIEByZXR1cm4geyB1Tm9kZSB9IOe7meWumueahGh0bWzniYfmrrXovazmjaLlvaLmiJDnmoR1Tm9kZeWvueixoVxuICogQGV4YW1wbGVcbiAqIGBgYGphdmFzY3JpcHRcbiAqIHZhciByb290ID0gVUUuaHRtbHBhcnNlcignPHA+PGI+aHRtbHBhcnNlcjwvYj48L3A+JywgdHJ1ZSk7XG4gKiBgYGBcbiAqL1xuXG52YXIgaHRtbHBhcnNlciA9IFVFLmh0bWxwYXJzZXIgPSBmdW5jdGlvbiAoaHRtbHN0cixpZ25vcmVCbGFuaykge1xuICAgIC8vdG9kbyDljp/mnaXnmoTmlrnlvI8gIFteXCInPD5cXC9dIOaciVxcL+WwseS4jeiDvemFjeWvueS4iiA8VEQgdkFsaWduPXRvcCBiYWNrZ3JvdW5kPS4uL0FBQS5KUEc+IOi/meagt+eahOagh+etvuS6hlxuICAgIC8v5YWI5Y675o6J5LqG77yM5Yqg5LiK55qE5Y6f5Zug5b+Y5LqG77yM6L+Z6YeM5YWI6K6w5b2VXG4gICAgdmFyIHJlX3RhZyA9IC88KD86KD86XFwvKFtePl0rKT4pfCg/OiEtLShbXFxTfFxcc10qPyktLT4pfCg/OihbXlxcc1xcLzw+XSspXFxzKigoPzooPzpcIlteXCJdKlwiKXwoPzonW14nXSonKXxbXlwiJzw+XSkqKVxcLz8+KSkvZyxcbiAgICAgICAgcmVfYXR0ciA9IC8oW1xcd1xcLTouXSspKD86KD86XFxzKj1cXHMqKD86KD86XCIoW15cIl0qKVwiKXwoPzonKFteJ10qKScpfChbXlxccz5dKykpKXwoPz1cXHN8JCkpL2c7XG5cbiAgICAvL2ll5LiL5Y+W5b6X55qEaHRtbOWPr+iDveS8muaciVxcbuWtmOWcqO+8jOimgeWOu+aOie+8jOWcqOWkhOeQhnJlcGxhY2UoL1tcXHRcXHJcXG5dKi9nLCcnKTvku6PnoIHpq5jph4/nmoRcXG7kuI3og73ljrvpmaRcbiAgICB2YXIgYWxsb3dFbXB0eVRhZ3MgPSB7XG4gICAgICAgIGI6MSxjb2RlOjEsaToxLHU6MSxzdHJpa2U6MSxzOjEsdHQ6MSxzdHJvbmc6MSxxOjEsc2FtcDoxLGVtOjEsc3BhbjoxLFxuICAgICAgICBzdWI6MSxpbWc6MSxzdXA6MSxmb250OjEsYmlnOjEsc21hbGw6MSxpZnJhbWU6MSxhOjEsYnI6MSxwcmU6MVxuICAgIH07XG4gICAgaHRtbHN0ciA9IGh0bWxzdHIucmVwbGFjZShuZXcgUmVnRXhwKGRvbVV0aWxzLmZpbGxDaGFyLCAnZycpLCAnJyk7XG4gICAgaWYoIWlnbm9yZUJsYW5rKXtcbiAgICAgICAgaHRtbHN0ciA9IGh0bWxzdHIucmVwbGFjZShuZXcgUmVnRXhwKCdbXFxcXHJcXFxcdFxcXFxuJysoaWdub3JlQmxhbms/Jyc6JyAnKSsnXSo8XFwvPyhcXFxcdyspXFxcXHMqKD86W14+XSopPltcXFxcclxcXFx0XFxcXG4nKyhpZ25vcmVCbGFuaz8nJzonICcpKyddKicsJ2cnKSwgZnVuY3Rpb24oYSxiKXtcbiAgICAgICAgICAgIC8vYnLmmoLml7bljZXni6zlpITnkIZcbiAgICAgICAgICAgIGlmKGIgJiYgYWxsb3dFbXB0eVRhZ3NbYi50b0xvd2VyQ2FzZSgpXSl7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGEucmVwbGFjZSgvKF5bXFxuXFxyXSspfChbXFxuXFxyXSskKS9nLCcnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBhLnJlcGxhY2UobmV3IFJlZ0V4cCgnXltcXFxcclxcXFxuJysoaWdub3JlQmxhbms/Jyc6JyAnKSsnXSsnKSwnJykucmVwbGFjZShuZXcgUmVnRXhwKCdbXFxcXHJcXFxcbicrKGlnbm9yZUJsYW5rPycnOicgJykrJ10rJCcpLCcnKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgdmFyIG5vdFRyYW5zQXR0cnMgPSB7XG4gICAgICAgICdocmVmJzoxLFxuICAgICAgICAnc3JjJzoxXG4gICAgfTtcblxuICAgIHZhciB1Tm9kZSA9IFVFLnVOb2RlLFxuICAgICAgICBuZWVkUGFyZW50Tm9kZSA9IHtcbiAgICAgICAgICAgICd0ZCc6J3RyJyxcbiAgICAgICAgICAgICd0cic6Wyd0Ym9keScsJ3RoZWFkJywndGZvb3QnXSxcbiAgICAgICAgICAgICd0Ym9keSc6J3RhYmxlJyxcbiAgICAgICAgICAgICd0aCc6J3RyJyxcbiAgICAgICAgICAgICd0aGVhZCc6J3RhYmxlJyxcbiAgICAgICAgICAgICd0Zm9vdCc6J3RhYmxlJyxcbiAgICAgICAgICAgICdjYXB0aW9uJzondGFibGUnLFxuICAgICAgICAgICAgJ2xpJzpbJ3VsJywgJ29sJ10sXG4gICAgICAgICAgICAnZHQnOidkbCcsXG4gICAgICAgICAgICAnZGQnOidkbCcsXG4gICAgICAgICAgICAnb3B0aW9uJzonc2VsZWN0J1xuICAgICAgICB9LFxuICAgICAgICBuZWVkQ2hpbGQgPSB7XG4gICAgICAgICAgICAnb2wnOidsaScsXG4gICAgICAgICAgICAndWwnOidsaSdcbiAgICAgICAgfTtcblxuICAgIGZ1bmN0aW9uIHRleHQocGFyZW50LCBkYXRhKSB7XG5cbiAgICAgICAgaWYobmVlZENoaWxkW3BhcmVudC50YWdOYW1lXSl7XG4gICAgICAgICAgICB2YXIgdG1wTm9kZSA9IHVOb2RlLmNyZWF0ZUVsZW1lbnQobmVlZENoaWxkW3BhcmVudC50YWdOYW1lXSk7XG4gICAgICAgICAgICBwYXJlbnQuYXBwZW5kQ2hpbGQodG1wTm9kZSk7XG4gICAgICAgICAgICB0bXBOb2RlLmFwcGVuZENoaWxkKHVOb2RlLmNyZWF0ZVRleHQoZGF0YSkpO1xuICAgICAgICAgICAgcGFyZW50ID0gdG1wTm9kZTtcbiAgICAgICAgfWVsc2V7XG5cbiAgICAgICAgICAgIHBhcmVudC5hcHBlbmRDaGlsZCh1Tm9kZS5jcmVhdGVUZXh0KGRhdGEpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGVsZW1lbnQocGFyZW50LCB0YWdOYW1lLCBodG1sYXR0cikge1xuICAgICAgICB2YXIgbmVlZFBhcmVudFRhZztcbiAgICAgICAgaWYgKG5lZWRQYXJlbnRUYWcgPSBuZWVkUGFyZW50Tm9kZVt0YWdOYW1lXSkge1xuICAgICAgICAgICAgdmFyIHRtcFBhcmVudCA9IHBhcmVudCxoYXNQYXJlbnQ7XG4gICAgICAgICAgICB3aGlsZSh0bXBQYXJlbnQudHlwZSAhPSAncm9vdCcpe1xuICAgICAgICAgICAgICAgIGlmKHV0aWxzLmlzQXJyYXkobmVlZFBhcmVudFRhZykgPyB1dGlscy5pbmRleE9mKG5lZWRQYXJlbnRUYWcsIHRtcFBhcmVudC50YWdOYW1lKSAhPSAtMSA6IG5lZWRQYXJlbnRUYWcgPT0gdG1wUGFyZW50LnRhZ05hbWUpe1xuICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSB0bXBQYXJlbnQ7XG4gICAgICAgICAgICAgICAgICAgIGhhc1BhcmVudCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0bXBQYXJlbnQgPSB0bXBQYXJlbnQucGFyZW50Tm9kZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmKCFoYXNQYXJlbnQpe1xuICAgICAgICAgICAgICAgIHBhcmVudCA9IGVsZW1lbnQocGFyZW50LCB1dGlscy5pc0FycmF5KG5lZWRQYXJlbnRUYWcpID8gbmVlZFBhcmVudFRhZ1swXSA6IG5lZWRQYXJlbnRUYWcpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy/mjIlkdGTlpITnkIbltYzlpZdcbi8vICAgICAgICBpZihwYXJlbnQudHlwZSAhPSAncm9vdCcgJiYgIWR0ZFtwYXJlbnQudGFnTmFtZV1bdGFnTmFtZV0pXG4vLyAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnROb2RlO1xuICAgICAgICB2YXIgZWxtID0gbmV3IHVOb2RlKHtcbiAgICAgICAgICAgIHBhcmVudE5vZGU6cGFyZW50LFxuICAgICAgICAgICAgdHlwZTonZWxlbWVudCcsXG4gICAgICAgICAgICB0YWdOYW1lOnRhZ05hbWUudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgIC8v5piv6Ieq6Zet5ZCI55qE5aSE55CG5LiA5LiLXG4gICAgICAgICAgICBjaGlsZHJlbjpkdGQuJGVtcHR5W3RhZ05hbWVdID8gbnVsbCA6IFtdXG4gICAgICAgIH0pO1xuICAgICAgICAvL+WmguaenOWxnuaAp+WtmOWcqO+8jOWkhOeQhuWxnuaAp1xuICAgICAgICBpZiAoaHRtbGF0dHIpIHtcbiAgICAgICAgICAgIHZhciBhdHRycyA9IHt9LCBtYXRjaDtcbiAgICAgICAgICAgIHdoaWxlIChtYXRjaCA9IHJlX2F0dHIuZXhlYyhodG1sYXR0cikpIHtcbiAgICAgICAgICAgICAgICBhdHRyc1ttYXRjaFsxXS50b0xvd2VyQ2FzZSgpXSA9IG5vdFRyYW5zQXR0cnNbbWF0Y2hbMV0udG9Mb3dlckNhc2UoKV0gPyAobWF0Y2hbMl0gfHwgbWF0Y2hbM10gfHwgbWF0Y2hbNF0pIDogdXRpbHMudW5odG1sKG1hdGNoWzJdIHx8IG1hdGNoWzNdIHx8IG1hdGNoWzRdKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxtLmF0dHJzID0gYXR0cnM7XG4gICAgICAgIH1cbiAgICAgICAgLy90cmFjZTozOTcwXG4vLyAgICAgICAgLy/lpoLmnpxwYXJlbnTkuIvkuI3og73mlL5lbG1cbi8vICAgICAgICBpZihkdGQuJGlubGluZVtwYXJlbnQudGFnTmFtZV0gJiYgZHRkLiRibG9ja1tlbG0udGFnTmFtZV0gJiYgIWR0ZFtwYXJlbnQudGFnTmFtZV1bZWxtLnRhZ05hbWVdKXtcbi8vICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnBhcmVudE5vZGU7XG4vLyAgICAgICAgICAgIGVsbS5wYXJlbnROb2RlID0gcGFyZW50O1xuLy8gICAgICAgIH1cbiAgICAgICAgcGFyZW50LmNoaWxkcmVuLnB1c2goZWxtKTtcbiAgICAgICAgLy/lpoLmnpzmmK/oh6rpl63lkIjoioLngrnov5Tlm57niLbkurLoioLngrlcbiAgICAgICAgcmV0dXJuICBkdGQuJGVtcHR5W3RhZ05hbWVdID8gcGFyZW50IDogZWxtXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gY29tbWVudChwYXJlbnQsIGRhdGEpIHtcbiAgICAgICAgcGFyZW50LmNoaWxkcmVuLnB1c2gobmV3IHVOb2RlKHtcbiAgICAgICAgICAgIHR5cGU6J2NvbW1lbnQnLFxuICAgICAgICAgICAgZGF0YTpkYXRhLFxuICAgICAgICAgICAgcGFyZW50Tm9kZTpwYXJlbnRcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIHZhciBtYXRjaCwgY3VycmVudEluZGV4ID0gMCwgbmV4dEluZGV4ID0gMDtcbiAgICAvL+iuvue9ruagueiKgueCuVxuICAgIHZhciByb290ID0gbmV3IHVOb2RlKHtcbiAgICAgICAgdHlwZToncm9vdCcsXG4gICAgICAgIGNoaWxkcmVuOltdXG4gICAgfSk7XG4gICAgdmFyIGN1cnJlbnRQYXJlbnQgPSByb290O1xuXG4gICAgd2hpbGUgKG1hdGNoID0gcmVfdGFnLmV4ZWMoaHRtbHN0cikpIHtcbiAgICAgICAgY3VycmVudEluZGV4ID0gbWF0Y2guaW5kZXg7XG4gICAgICAgIHRyeXtcbiAgICAgICAgICAgIGlmIChjdXJyZW50SW5kZXggPiBuZXh0SW5kZXgpIHtcbiAgICAgICAgICAgICAgICAvL3RleHQgbm9kZVxuICAgICAgICAgICAgICAgIHRleHQoY3VycmVudFBhcmVudCwgaHRtbHN0ci5zbGljZShuZXh0SW5kZXgsIGN1cnJlbnRJbmRleCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG1hdGNoWzNdKSB7XG5cbiAgICAgICAgICAgICAgICBpZihkdGQuJGNkYXRhW2N1cnJlbnRQYXJlbnQudGFnTmFtZV0pe1xuICAgICAgICAgICAgICAgICAgICB0ZXh0KGN1cnJlbnRQYXJlbnQsIG1hdGNoWzBdKTtcbiAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgLy9zdGFydCB0YWdcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBhcmVudCA9IGVsZW1lbnQoY3VycmVudFBhcmVudCwgbWF0Y2hbM10udG9Mb3dlckNhc2UoKSwgbWF0Y2hbNF0pO1xuICAgICAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICB9IGVsc2UgaWYgKG1hdGNoWzFdKSB7XG4gICAgICAgICAgICAgICAgaWYoY3VycmVudFBhcmVudC50eXBlICE9ICdyb290Jyl7XG4gICAgICAgICAgICAgICAgICAgIGlmKGR0ZC4kY2RhdGFbY3VycmVudFBhcmVudC50YWdOYW1lXSAmJiAhZHRkLiRjZGF0YVttYXRjaFsxXV0pe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dChjdXJyZW50UGFyZW50LCBtYXRjaFswXSk7XG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRtcFBhcmVudCA9IGN1cnJlbnRQYXJlbnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZShjdXJyZW50UGFyZW50LnR5cGUgPT0gJ2VsZW1lbnQnICYmIGN1cnJlbnRQYXJlbnQudGFnTmFtZSAhPSBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGFyZW50ID0gY3VycmVudFBhcmVudC5wYXJlbnROb2RlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGN1cnJlbnRQYXJlbnQudHlwZSA9PSAncm9vdCcpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGFyZW50ID0gdG1wUGFyZW50O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAnYnJlYWsnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgLy9lbmQgdGFnXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGFyZW50ID0gY3VycmVudFBhcmVudC5wYXJlbnROb2RlO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0gZWxzZSBpZiAobWF0Y2hbMl0pIHtcbiAgICAgICAgICAgICAgICAvL2NvbW1lbnRcbiAgICAgICAgICAgICAgICBjb21tZW50KGN1cnJlbnRQYXJlbnQsIG1hdGNoWzJdKVxuICAgICAgICAgICAgfVxuICAgICAgICB9Y2F0Y2goZSl7fVxuXG4gICAgICAgIG5leHRJbmRleCA9IHJlX3RhZy5sYXN0SW5kZXg7XG5cbiAgICB9XG4gICAgLy/lpoLmnpznu5PmnZ/mmK/mlofmnKzvvIzlsLHmnInlj6/og73kuKLmjonvvIzmiYDku6Xov5nph4zmiYvliqjliKTmlq3kuIDkuItcbiAgICAvL+S+i+WmgiA8bGk+c2Rmc2Rmc2RmPGxpPnNkZnNkZnNkZnNkZlxuICAgIGlmIChuZXh0SW5kZXggPCBodG1sc3RyLmxlbmd0aCkge1xuICAgICAgICB0ZXh0KGN1cnJlbnRQYXJlbnQsIGh0bWxzdHIuc2xpY2UobmV4dEluZGV4KSk7XG4gICAgfVxuICAgIHJldHVybiByb290O1xufTtcblxuXG4vLyBjb3JlL2ZpbHRlcm5vZGUuanNcbi8qKlxyXG4gKiBVRei/h+a7pOiKgueCueeahOmdmeaAgeaWueazlVxyXG4gKiBAZmlsZVxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiBVRWRpdG9y5YWs55So56m66Ze077yMVUVkaXRvcuaJgOacieeahOWKn+iDvemDveaMgui9veWcqOivpeepuumXtOS4i1xyXG4gKiBAbW9kdWxlIFVFXHJcbiAqL1xyXG5cclxuXHJcbi8qKlxyXG4gKiDmoLnmja7kvKDlhaXoioLngrnlkozov4fmu6Top4TliJnov4fmu6Tnm7jlupToioLngrlcclxuICogQG1vZHVsZSBVRVxyXG4gKiBAc2luY2UgMS4yLjYuMVxyXG4gKiBAbWV0aG9kIGZpbHRlck5vZGVcclxuICogQHBhcmFtIHsgT2JqZWN0IH0gcm9vdCDmjIflrppyb2906IqC54K5XHJcbiAqIEBwYXJhbSB7IE9iamVjdCB9IHJ1bGVzIOi/h+a7pOinhOWImWpzb27lr7nosaFcclxuICogQGV4YW1wbGVcclxuICogYGBgamF2YXNjcmlwdFxyXG4gKiBVRS5maWx0ZXJOb2RlKHJvb3QsZWRpdG9yLm9wdGlvbnMuZmlsdGVyUnVsZXMpO1xyXG4gKiBgYGBcclxuICovXHJcbnZhciBmaWx0ZXJOb2RlID0gVUUuZmlsdGVyTm9kZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIGZpbHRlck5vZGUobm9kZSxydWxlcyl7XHJcbiAgICAgICAgc3dpdGNoIChub2RlLnR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnZWxlbWVudCc6XHJcbiAgICAgICAgICAgICAgICB2YXIgdmFsO1xyXG4gICAgICAgICAgICAgICAgaWYodmFsID0gcnVsZXNbbm9kZS50YWdOYW1lXSl7XHJcbiAgICAgICAgICAgICAgICAgICBpZih2YWwgPT09ICctJyl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpXHJcbiAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZih1dGlscy5pc0Z1bmN0aW9uKHZhbCkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gbm9kZS5wYXJlbnROb2RlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCA9IG5vZGUuZ2V0SW5kZXgoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICB2YWwobm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgaWYobm9kZS5wYXJlbnROb2RlKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobm9kZS5jaGlsZHJlbil7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwLGNpO2NpPW5vZGUuY2hpbGRyZW5baV07KXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJOb2RlKGNpLHJ1bGVzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihjaS5wYXJlbnROb2RlKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaSsrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSBpbmRleCxjaTtjaT1wYXJlbnROb2RlLmNoaWxkcmVuW2ldOyl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJOb2RlKGNpLHJ1bGVzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGNpLnBhcmVudE5vZGUpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkrKztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHJzID0gdmFsWyckJ107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgaWYoYXR0cnMgJiYgbm9kZS5hdHRycyl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0bXBBdHRycyA9IHt9LHRtcFZhbDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBhIGluIGF0dHJzKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFZhbCA9IG5vZGUuZ2V0QXR0cihhKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vdG9kbyDlj6rlhYjlr7lzdHlsZeWNleeLrOWkhOeQhlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoYSA9PSAnc3R5bGUnICYmIHV0aWxzLmlzQXJyYXkoYXR0cnNbYV0pKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wQ3NzU3R5bGUgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1dGlscy5lYWNoKGF0dHJzW2FdLGZ1bmN0aW9uKHYpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0bXAgPSBub2RlLmdldFN0eWxlKHYpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcENzc1N0eWxlLnB1c2godiArICc6JyArIHRtcCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBWYWwgPSB0bXBDc3NTdHlsZS5qb2luKCc7JylcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRtcFZhbCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wQXR0cnNbYV0gPSB0bXBWYWw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuYXR0cnMgPSB0bXBBdHRycztcclxuICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgaWYobm9kZS5jaGlsZHJlbil7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsY2k7Y2k9bm9kZS5jaGlsZHJlbltpXTspe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyTm9kZShjaSxydWxlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihjaS5wYXJlbnROb2RlKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpKys7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICAvL+WmguaenOS4jeWcqOWQjeWNlemHjOaJo+WHuuWtkOiKgueCueW5tuWIoOmZpOivpeiKgueCuSxjZGF0YemZpOWkllxyXG4gICAgICAgICAgICAgICAgICAgIGlmKGR0ZC4kY2RhdGFbbm9kZS50YWdOYW1lXSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKVxyXG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IG5vZGUucGFyZW50Tm9kZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gbm9kZS5nZXRJbmRleCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSx0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gaW5kZXgsY2k7Y2k9cGFyZW50Tm9kZS5jaGlsZHJlbltpXTspe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyTm9kZShjaSxydWxlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihjaS5wYXJlbnROb2RlKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpKys7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnY29tbWVudCc6XHJcbiAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSlcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZ1bmN0aW9uKHJvb3QscnVsZXMpe1xyXG4gICAgICAgIGlmKHV0aWxzLmlzRW1wdHlPYmplY3QocnVsZXMpKXtcclxuICAgICAgICAgICAgcmV0dXJuIHJvb3Q7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciB2YWw7XHJcbiAgICAgICAgaWYodmFsID0gcnVsZXNbJy0nXSl7XHJcbiAgICAgICAgICAgIHV0aWxzLmVhY2godmFsLnNwbGl0KCcgJyksZnVuY3Rpb24oayl7XHJcbiAgICAgICAgICAgICAgICBydWxlc1trXSA9ICctJ1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IodmFyIGk9IDAsY2k7Y2k9cm9vdC5jaGlsZHJlbltpXTspe1xyXG4gICAgICAgICAgICBmaWx0ZXJOb2RlKGNpLHJ1bGVzKTtcclxuICAgICAgICAgICAgaWYoY2kucGFyZW50Tm9kZSl7XHJcbiAgICAgICAgICAgICAgIGkrKztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcm9vdDtcclxuICAgIH1cclxufSgpO1xuXG4vLyBjb3JlL3BsdWdpbi5qc1xuLyoqXG4gKiBDcmVhdGVkIHdpdGggSmV0QnJhaW5zIFBocFN0b3JtLlxuICogVXNlcjogY2FtcGFpZ25cbiAqIERhdGU6IDEwLzgvMTNcbiAqIFRpbWU6IDY6MTUgUE1cbiAqIFRvIGNoYW5nZSB0aGlzIHRlbXBsYXRlIHVzZSBGaWxlIHwgU2V0dGluZ3MgfCBGaWxlIFRlbXBsYXRlcy5cbiAqL1xuVUUucGx1Z2luID0gZnVuY3Rpb24oKXtcbiAgICB2YXIgX3BsdWdpbnMgPSB7fTtcbiAgICByZXR1cm4ge1xuICAgICAgICByZWdpc3RlciA6IGZ1bmN0aW9uKHBsdWdpbk5hbWUsZm4sb2xkT3B0aW9uTmFtZSxhZnRlckRpc2FibGVkKXtcbiAgICAgICAgICAgIGlmKG9sZE9wdGlvbk5hbWUgJiYgdXRpbHMuaXNGdW5jdGlvbihvbGRPcHRpb25OYW1lKSl7XG4gICAgICAgICAgICAgICAgYWZ0ZXJEaXNhYmxlZCA9IG9sZE9wdGlvbk5hbWU7XG4gICAgICAgICAgICAgICAgb2xkT3B0aW9uTmFtZSA9IG51bGxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF9wbHVnaW5zW3BsdWdpbk5hbWVdID0ge1xuICAgICAgICAgICAgICAgIG9wdGlvbk5hbWUgOiBvbGRPcHRpb25OYW1lIHx8IHBsdWdpbk5hbWUsXG4gICAgICAgICAgICAgICAgZXhlY0ZuIDogZm4sXG4gICAgICAgICAgICAgICAgLy/lvZPmj5Lku7booqvnpoHnlKjml7bmiafooYxcbiAgICAgICAgICAgICAgICBhZnRlckRpc2FibGVkIDogYWZ0ZXJEaXNhYmxlZFxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBsb2FkIDogZnVuY3Rpb24oZWRpdG9yKXtcbiAgICAgICAgICAgIHV0aWxzLmVhY2goX3BsdWdpbnMsZnVuY3Rpb24ocGx1Z2luKXtcbiAgICAgICAgICAgICAgICB2YXIgX2V4cG9ydCA9IHBsdWdpbi5leGVjRm4uY2FsbChlZGl0b3IpO1xuICAgICAgICAgICAgICAgIGlmKGVkaXRvci5vcHRpb25zW3BsdWdpbi5vcHRpb25OYW1lXSAhPT0gZmFsc2Upe1xuICAgICAgICAgICAgICAgICAgICBpZihfZXhwb3J0KXtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8v5ZCO6L656ZyA6KaB5YaN5YGa5omp5bGVXG4gICAgICAgICAgICAgICAgICAgICAgICB1dGlscy5lYWNoKF9leHBvcnQsZnVuY3Rpb24odixrKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2goay50b0xvd2VyQ2FzZSgpKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc2hvcnRjdXRrZXknOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmFkZHNob3J0Y3V0a2V5KHYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2JpbmRldmVudHMnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXRpbHMuZWFjaCh2LGZ1bmN0aW9uKGZuLGV2ZW50TmFtZSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmFkZExpc3RlbmVyKGV2ZW50TmFtZSxmbik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdiaW5kbXVsdGlldmVudHMnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXRpbHMuZWFjaCh1dGlscy5pc0FycmF5KHYpID8gdjpbdl0sZnVuY3Rpb24oZXZlbnQpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0eXBlcyA9IHV0aWxzLnRyaW0oZXZlbnQudHlwZSkuc3BsaXQoL1xccysvKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1dGlscy5lYWNoKHR5cGVzLGZ1bmN0aW9uKGV2ZW50TmFtZSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvci5hZGRMaXN0ZW5lcihldmVudE5hbWUsIGV2ZW50LmhhbmRsZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY29tbWFuZHMnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXRpbHMuZWFjaCh2LGZ1bmN0aW9uKGV4ZWNGbixleGVjTmFtZSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmNvbW1hbmRzW2V4ZWNOYW1lXSA9IGV4ZWNGblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnb3V0cHV0cnVsZSc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlZGl0b3IuYWRkT3V0cHV0UnVsZSh2KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdpbnB1dHJ1bGUnOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmFkZElucHV0UnVsZSh2KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdkZWZhdWx0b3B0aW9ucyc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlZGl0b3Iuc2V0T3B0KHYpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgfWVsc2UgaWYocGx1Z2luLmFmdGVyRGlzYWJsZWQpe1xuICAgICAgICAgICAgICAgICAgICBwbHVnaW4uYWZ0ZXJEaXNhYmxlZC5jYWxsKGVkaXRvcilcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy/lkJHkuIvlhbzlrrlcbiAgICAgICAgICAgIHV0aWxzLmVhY2goVUUucGx1Z2lucyxmdW5jdGlvbihwbHVnaW4pe1xuICAgICAgICAgICAgICAgIHBsdWdpbi5jYWxsKGVkaXRvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICAgICAgcnVuIDogZnVuY3Rpb24ocGx1Z2luTmFtZSxlZGl0b3Ipe1xuICAgICAgICAgICAgdmFyIHBsdWdpbiA9IF9wbHVnaW5zW3BsdWdpbk5hbWVdO1xuICAgICAgICAgICAgaWYocGx1Z2luKXtcbiAgICAgICAgICAgICAgICBwbHVnaW4uZXhlRm4uY2FsbChlZGl0b3IpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59KCk7XG5cbi8vIGNvcmUva2V5bWFwLmpzXG52YXIga2V5bWFwID0gVUUua2V5bWFwICA9IHtcbiAgICAnQmFja3NwYWNlJyA6IDgsXG4gICAgJ1RhYicgOiA5LFxuICAgICdFbnRlcicgOiAxMyxcblxuICAgICdTaGlmdCc6MTYsXG4gICAgJ0NvbnRyb2wnOjE3LFxuICAgICdBbHQnOjE4LFxuICAgICdDYXBzTG9jayc6MjAsXG5cbiAgICAnRXNjJzoyNyxcblxuICAgICdTcGFjZWJhcic6MzIsXG5cbiAgICAnUGFnZVVwJzozMyxcbiAgICAnUGFnZURvd24nOjM0LFxuICAgICdFbmQnOjM1LFxuICAgICdIb21lJzozNixcblxuICAgICdMZWZ0JzozNyxcbiAgICAnVXAnOjM4LFxuICAgICdSaWdodCc6MzksXG4gICAgJ0Rvd24nOjQwLFxuXG4gICAgJ0luc2VydCc6NDUsXG5cbiAgICAnRGVsJzo0NixcblxuICAgICdOdW1Mb2NrJzoxNDQsXG5cbiAgICAnQ21kJzo5MSxcblxuICAgICc9JzoxODcsXG4gICAgJy0nOjE4OSxcblxuICAgIFwiYlwiOjY2LFxuICAgICdpJzo3MyxcbiAgICAvL+WbnumAgFxuICAgICd6Jzo5MCxcbiAgICAneSc6ODksXG4gICAgLy/nspjotLRcbiAgICAndicgOiA4NixcbiAgICAneCcgOiA4OCxcblxuICAgICdzJyA6IDgzLFxuXG4gICAgJ24nIDogNzhcbn07XG5cbi8vIGNvcmUvbG9jYWxzdG9yYWdlLmpzXG4vL+WtmOWCqOWqkuS7i+WwgeijhVxudmFyIExvY2FsU3RvcmFnZSA9IFVFLkxvY2FsU3RvcmFnZSA9IChmdW5jdGlvbiAoKSB7XG5cbiAgICB2YXIgc3RvcmFnZSA9IHdpbmRvdy5sb2NhbFN0b3JhZ2UgfHwgZ2V0VXNlckRhdGEoKSB8fCBudWxsLFxuICAgICAgICBMT0NBTF9GSUxFID0gJ2xvY2FsU3RvcmFnZSc7XG5cbiAgICByZXR1cm4ge1xuXG4gICAgICAgIHNhdmVMb2NhbERhdGE6IGZ1bmN0aW9uIChrZXksIGRhdGEpIHtcblxuICAgICAgICAgICAgaWYgKHN0b3JhZ2UgJiYgZGF0YSkge1xuICAgICAgICAgICAgICAgIHN0b3JhZ2Uuc2V0SXRlbShrZXksIGRhdGEpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgfSxcblxuICAgICAgICBnZXRMb2NhbERhdGE6IGZ1bmN0aW9uIChrZXkpIHtcblxuICAgICAgICAgICAgaWYgKHN0b3JhZ2UpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RvcmFnZS5nZXRJdGVtKGtleSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuXG4gICAgICAgIH0sXG5cbiAgICAgICAgcmVtb3ZlSXRlbTogZnVuY3Rpb24gKGtleSkge1xuXG4gICAgICAgICAgICBzdG9yYWdlICYmIHN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpO1xuXG4gICAgICAgIH1cblxuICAgIH07XG5cbiAgICBmdW5jdGlvbiBnZXRVc2VyRGF0YSgpIHtcblxuICAgICAgICB2YXIgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICAgICAgY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcblxuICAgICAgICBpZiAoIWNvbnRhaW5lci5hZGRCZWhhdmlvcikge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBjb250YWluZXIuYWRkQmVoYXZpb3IoXCIjZGVmYXVsdCN1c2VyZGF0YVwiKTtcblxuICAgICAgICByZXR1cm4ge1xuXG4gICAgICAgICAgICBnZXRJdGVtOiBmdW5jdGlvbiAoa2V5KSB7XG5cbiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gbnVsbDtcblxuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoY29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmxvYWQoTE9DQUxfRklMRSk7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGNvbnRhaW5lci5nZXRBdHRyaWJ1dGUoa2V5KTtcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChjb250YWluZXIpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBzZXRJdGVtOiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkge1xuXG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChjb250YWluZXIpO1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyLnNhdmUoTE9DQUxfRklMRSk7XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChjb250YWluZXIpO1xuXG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICAvLy8vIOaaguaXtuayoeacieeUqOWIsFxuICAgICAgICAgICAgLy9jbGVhcjogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgLy9cbiAgICAgICAgICAgIC8vICAgIHZhciBleHBpcmVzVGltZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICAvLyAgICBleHBpcmVzVGltZS5zZXRGdWxsWWVhcihleHBpcmVzVGltZS5nZXRGdWxsWWVhcigpIC0gMSk7XG4gICAgICAgICAgICAvLyAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGNvbnRhaW5lcik7XG4gICAgICAgICAgICAvLyAgICBjb250YWluZXIuZXhwaXJlcyA9IGV4cGlyZXNUaW1lLnRvVVRDU3RyaW5nKCk7XG4gICAgICAgICAgICAvLyAgICBjb250YWluZXIuc2F2ZShMT0NBTF9GSUxFKTtcbiAgICAgICAgICAgIC8vICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoY29udGFpbmVyKTtcbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAvL30sXG5cbiAgICAgICAgICAgIHJlbW92ZUl0ZW06IGZ1bmN0aW9uIChrZXkpIHtcblxuICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoY29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICBjb250YWluZXIucmVtb3ZlQXR0cmlidXRlKGtleSk7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyLnNhdmUoTE9DQUxfRklMRSk7XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChjb250YWluZXIpO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfTtcblxuICAgIH1cblxufSkoKTtcblxuKGZ1bmN0aW9uICgpIHtcblxuICAgIHZhciBST09US0VZID0gJ3VlZGl0b3JfcHJlZmVyZW5jZSc7XG5cbiAgICBVRS5FZGl0b3IucHJvdG90eXBlLnNldFByZWZlcmVuY2VzID0gZnVuY3Rpb24oa2V5LHZhbHVlKXtcbiAgICAgICAgdmFyIG9iaiA9IHt9O1xuICAgICAgICBpZiAodXRpbHMuaXNTdHJpbmcoa2V5KSkge1xuICAgICAgICAgICAgb2JqWyBrZXkgXSA9IHZhbHVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb2JqID0ga2V5O1xuICAgICAgICB9XG4gICAgICAgIHZhciBkYXRhID0gTG9jYWxTdG9yYWdlLmdldExvY2FsRGF0YShST09US0VZKTtcbiAgICAgICAgaWYgKGRhdGEgJiYgKGRhdGEgPSB1dGlscy5zdHIyanNvbihkYXRhKSkpIHtcbiAgICAgICAgICAgIHV0aWxzLmV4dGVuZChkYXRhLCBvYmopO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGF0YSA9IG9iajtcbiAgICAgICAgfVxuICAgICAgICBkYXRhICYmIExvY2FsU3RvcmFnZS5zYXZlTG9jYWxEYXRhKFJPT1RLRVksIHV0aWxzLmpzb24yc3RyKGRhdGEpKTtcbiAgICB9O1xuXG4gICAgVUUuRWRpdG9yLnByb3RvdHlwZS5nZXRQcmVmZXJlbmNlcyA9IGZ1bmN0aW9uKGtleSl7XG4gICAgICAgIHZhciBkYXRhID0gTG9jYWxTdG9yYWdlLmdldExvY2FsRGF0YShST09US0VZKTtcbiAgICAgICAgaWYgKGRhdGEgJiYgKGRhdGEgPSB1dGlscy5zdHIyanNvbihkYXRhKSkpIHtcbiAgICAgICAgICAgIHJldHVybiBrZXkgPyBkYXRhW2tleV0gOiBkYXRhXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfTtcblxuICAgIFVFLkVkaXRvci5wcm90b3R5cGUucmVtb3ZlUHJlZmVyZW5jZXMgPSBmdW5jdGlvbiAoa2V5KSB7XG4gICAgICAgIHZhciBkYXRhID0gTG9jYWxTdG9yYWdlLmdldExvY2FsRGF0YShST09US0VZKTtcbiAgICAgICAgaWYgKGRhdGEgJiYgKGRhdGEgPSB1dGlscy5zdHIyanNvbihkYXRhKSkpIHtcbiAgICAgICAgICAgIGRhdGFba2V5XSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIGRlbGV0ZSBkYXRhW2tleV1cbiAgICAgICAgfVxuICAgICAgICBkYXRhICYmIExvY2FsU3RvcmFnZS5zYXZlTG9jYWxEYXRhKFJPT1RLRVksIHV0aWxzLmpzb24yc3RyKGRhdGEpKTtcbiAgICB9O1xuXG59KSgpO1xuXG5cbi8vIHBsdWdpbnMvZGVmYXVsdGZpbHRlci5qc1xuLy8vaW1wb3J0IGNvcmVcclxuLy8vcGx1Z2luIOe8lui+keWZqOm7mOiupOeahOi/h+a7pOi9rOaNouacuuWItlxyXG5cclxuVUUucGx1Z2luc1snZGVmYXVsdGZpbHRlciddID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIG1lID0gdGhpcztcclxuICAgIG1lLnNldE9wdCh7XHJcbiAgICAgICAgJ2FsbG93RGl2VHJhbnNUb1AnOnRydWUsXHJcbiAgICAgICAgJ2Rpc2FibGVkVGFibGVJblRhYmxlJzp0cnVlXHJcbiAgICB9KTtcclxuICAgIC8v6buY6K6k55qE6L+H5ruk5aSE55CGXHJcbiAgICAvL+i/m+WFpee8lui+keWZqOeahOWGheWuueWkhOeQhlxyXG4gICAgbWUuYWRkSW5wdXRSdWxlKGZ1bmN0aW9uIChyb290KSB7XHJcbiAgICAgICAgdmFyIGFsbG93RGl2VHJhbnNUb1AgPSB0aGlzLm9wdGlvbnMuYWxsb3dEaXZUcmFuc1RvUDtcclxuICAgICAgICB2YXIgdmFsO1xyXG4gICAgICAgIGZ1bmN0aW9uIHRkUGFyZW50KG5vZGUpe1xyXG4gICAgICAgICAgICB3aGlsZShub2RlICYmIG5vZGUudHlwZSA9PSAnZWxlbWVudCcpe1xyXG4gICAgICAgICAgICAgICAgaWYobm9kZS50YWdOYW1lID09ICd0ZCcpe1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8v6L+b6KGM6buY6K6k55qE5aSE55CGXHJcbiAgICAgICAgcm9vdC50cmF2ZXJzYWwoZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICAgICAgaWYgKG5vZGUudHlwZSA9PSAnZWxlbWVudCcpIHtcclxuICAgICAgICAgICAgICAgIGlmICghZHRkLiRjZGF0YVtub2RlLnRhZ05hbWVdICYmIG1lLm9wdGlvbnMuYXV0b0NsZWFyRW1wdHlOb2RlICYmIGR0ZC4kaW5saW5lW25vZGUudGFnTmFtZV0gJiYgIWR0ZC4kZW1wdHlbbm9kZS50YWdOYW1lXSAmJiAoIW5vZGUuYXR0cnMgfHwgdXRpbHMuaXNFbXB0eU9iamVjdChub2RlLmF0dHJzKSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGUuZmlyc3RDaGlsZCgpKSBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobm9kZS50YWdOYW1lID09ICdzcGFuJyAmJiAoIW5vZGUuYXR0cnMgfHwgdXRpbHMuaXNFbXB0eU9iamVjdChub2RlLmF0dHJzKSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUsIHRydWUpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHN3aXRjaCAobm9kZS50YWdOYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3R5bGUnOlxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3NjcmlwdCc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cih7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZGF0YV90YWc6IG5vZGUudGFnTmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNkYXRhX2RhdGE6IChub2RlLmlubmVySFRNTCgpIHx8ICcnKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdfdWVfY3VzdG9tX25vZGVfJzondHJ1ZSdcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUudGFnTmFtZSA9ICdkaXYnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlLmlubmVySFRNTCgnJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2EnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsID0gbm9kZS5nZXRBdHRyKCdocmVmJykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cignX2hyZWYnLCB2YWwpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnaW1nJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy90b2RvIGJhc2U2NOaaguaXtuWOu+aOie+8jOWQjui+ueWBmui/nOeoi+WbvueJh+S4iuS8oOWQju+8jOW5suaOiei/meS4qlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsID0gbm9kZS5nZXRBdHRyKCdzcmMnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC9eZGF0YTovLnRlc3QodmFsKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlLnNldEF0dHIoJ19zcmMnLCBub2RlLmdldEF0dHIoJ3NyYycpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3Bhbic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChicm93c2VyLndlYmtpdCAmJiAodmFsID0gbm9kZS5nZXRTdHlsZSgnd2hpdGUtc3BhY2UnKSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgvbm93cmFwfG5vcm1hbC8udGVzdCh2YWwpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRTdHlsZSgnd2hpdGUtc3BhY2UnLCAnJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lLm9wdGlvbnMuYXV0b0NsZWFyRW1wdHlOb2RlICYmIHV0aWxzLmlzRW1wdHlPYmplY3Qobm9kZS5hdHRycykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUsIHRydWUpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IG5vZGUuZ2V0QXR0cignaWQnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYodmFsICYmIC9eX2JhaWR1X2Jvb2ttYXJrXy9pLnRlc3QodmFsKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdwJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA9IG5vZGUuZ2V0QXR0cignYWxpZ24nKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyKCdhbGlnbicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRTdHlsZSgndGV4dC1hbGlnbicsIHZhbClcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL3RyYWNlOjM0MzFcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICB2YXIgY3NzU3R5bGUgPSBub2RlLmdldEF0dHIoJ3N0eWxlJyk7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNzc1N0eWxlKSB7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNzc1N0eWxlID0gY3NzU3R5bGUucmVwbGFjZSgvKG1hcmdpbnxwYWRkaW5nKVteO10rL2csICcnKTtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyKCdzdHlsZScsIGNzc1N0eWxlKVxyXG4vL1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy9w5qCH562+5LiN5YWB6K645bWM5aWXXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHV0aWxzLmVhY2gobm9kZS5jaGlsZHJlbixmdW5jdGlvbihuKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG4udHlwZSA9PSAnZWxlbWVudCcgJiYgbi50YWdOYW1lID09ICdwJyl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5leHQgPSBuLm5leHRTaWJsaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLmluc2VydEFmdGVyKG4sbm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3QgPSBuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKG5leHQpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wID0gbmV4dC5uZXh0U2libGluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUuaW5zZXJ0QWZ0ZXIobmV4dCxsYXN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdCA9IG5leHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQgPSB0bXA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbm9kZS5maXJzdENoaWxkKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuaW5uZXJIVE1MKGJyb3dzZXIuaWUgPyAnJm5ic3A7JyA6ICc8YnIvPicpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnZGl2JzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYobm9kZS5nZXRBdHRyKCdjZGF0YV90YWcnKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL+mSiOWvueS7o+eggei/memHjOS4jeWkhOeQhuaPkuWFpeS7o+eggeeahGRpdlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSBub2RlLmdldEF0dHIoJ2NsYXNzJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHZhbCAmJiAvXmxpbmUgbnVtYmVyXFxkKy8udGVzdCh2YWwpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFhbGxvd0RpdlRyYW5zVG9QKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0bXBOb2RlLCBwID0gVUUudU5vZGUuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAodG1wTm9kZSA9IG5vZGUuZmlyc3RDaGlsZCgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG1wTm9kZS50eXBlID09ICd0ZXh0JyB8fCAhVUUuZG9tLmR0ZC4kYmxvY2tbdG1wTm9kZS50YWdOYW1lXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuYXBwZW5kQ2hpbGQodG1wTm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLmZpcnN0Q2hpbGQoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHAsIG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwID0gVUUudU5vZGUuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodG1wTm9kZSwgbm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLmZpcnN0Q2hpbGQoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShwLCBub2RlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2RsJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS50YWdOYW1lID0gJ3VsJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnZHQnOlxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2RkJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS50YWdOYW1lID0gJ2xpJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbGknOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gbm9kZS5nZXRBdHRyKCdjbGFzcycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNsYXNzTmFtZSB8fCAhL2xpc3RcXC0vLnRlc3QoY2xhc3NOYW1lKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyKClcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wTm9kZXMgPSBub2RlLmdldE5vZGVzQnlUYWdOYW1lKCdvbCB1bCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBVRS51dGlscy5lYWNoKHRtcE5vZGVzLCBmdW5jdGlvbiAobikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLmluc2VydEFmdGVyKG4sIG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAndGQnOlxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RoJzpcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdjYXB0aW9uJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoIW5vZGUuY2hpbGRyZW4gfHwgIW5vZGUuY2hpbGRyZW4ubGVuZ3RoKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuYXBwZW5kQ2hpbGQoYnJvd3Nlci5pZTExYmVsb3cgPyBVRS51Tm9kZS5jcmVhdGVUZXh0KCcgJykgOiBVRS51Tm9kZS5jcmVhdGVFbGVtZW50KCdicicpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RhYmxlJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYobWUub3B0aW9ucy5kaXNhYmxlZFRhYmxlSW5UYWJsZSAmJiB0ZFBhcmVudChub2RlKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKFVFLnVOb2RlLmNyZWF0ZVRleHQobm9kZS5pbm5lclRleHQoKSksbm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgICAgIGlmKG5vZGUudHlwZSA9PSAnY29tbWVudCcpe1xyXG4vLyAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7XHJcbi8vICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgfSk7XHJcblxyXG4gICAgLy/ku47nvJbovpHlmajlh7rljrvnmoTlhoXlrrnlpITnkIZcclxuICAgIG1lLmFkZE91dHB1dFJ1bGUoZnVuY3Rpb24gKHJvb3QpIHtcclxuXHJcbiAgICAgICAgdmFyIHZhbDtcclxuICAgICAgICByb290LnRyYXZlcnNhbChmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICBpZiAobm9kZS50eXBlID09ICdlbGVtZW50Jykge1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChtZS5vcHRpb25zLmF1dG9DbGVhckVtcHR5Tm9kZSAmJiBkdGQuJGlubGluZVtub2RlLnRhZ05hbWVdICYmICFkdGQuJGVtcHR5W25vZGUudGFnTmFtZV0gJiYgKCFub2RlLmF0dHJzIHx8IHV0aWxzLmlzRW1wdHlPYmplY3Qobm9kZS5hdHRycykpKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghbm9kZS5maXJzdENoaWxkKCkpIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTtcclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChub2RlLnRhZ05hbWUgPT0gJ3NwYW4nICYmICghbm9kZS5hdHRycyB8fCB1dGlscy5pc0VtcHR5T2JqZWN0KG5vZGUuYXR0cnMpKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSwgdHJ1ZSlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChub2RlLnRhZ05hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdkaXYnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsID0gbm9kZS5nZXRBdHRyKCdjZGF0YV90YWcnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS50YWdOYW1lID0gdmFsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChVRS51Tm9kZS5jcmVhdGVUZXh0KG5vZGUuZ2V0QXR0cignY2RhdGFfZGF0YScpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnNldEF0dHIoe2NkYXRhX3RhZzogJycsIGNkYXRhX2RhdGE6ICcnLCdfdWVfY3VzdG9tX25vZGVfJzonJ30pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2EnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsID0gbm9kZS5nZXRBdHRyKCdfaHJlZicpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnNldEF0dHIoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdocmVmJzogdXRpbHMuaHRtbCh2YWwpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdfaHJlZic6ICcnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdzcGFuJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gbm9kZS5nZXRBdHRyKCdpZCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZih2YWwgJiYgL15fYmFpZHVfYm9va21hcmtfL2kudGVzdCh2YWwpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ltZyc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWwgPSBub2RlLmdldEF0dHIoJ19zcmMnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3JjJzogbm9kZS5nZXRBdHRyKCdfc3JjJyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ19zcmMnOiAnJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSlcclxuXHJcblxyXG4gICAgfSk7XHJcbn07XHJcblxuXG4vLyBwbHVnaW5zL2luc2VydGh0bWwuanNcbi8qKlxyXG4gKiDmj5LlhaVodG1s5a2X56ym5Liy5o+S5Lu2XHJcbiAqIEBmaWxlXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIOaPkuWFpWh0bWzku6PnoIFcclxuICogQGNvbW1hbmQgaW5zZXJ0aHRtbFxyXG4gKiBAbWV0aG9kIGV4ZWNDb21tYW5kXHJcbiAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gaHRtbCDmj5LlhaXnmoRodG1s5a2X56ym5LiyXHJcbiAqIEByZW1haW5kIOaPkuWFpeeahOagh+etvuWGheWuueaYr+WcqOW9k+WJjeeahOmAieWMuuS9jee9ruS4iuaPkuWFpe+8jOWmguaenOW9k+WJjeaYr+mXreWQiOeKtuaAge+8jOmCo+ebtOaOpeaPkuWFpeWGheWuue+8jCDlpoLmnpzlvZPliY3mmK/pgInkuK3nirbmgIHvvIzlsIblhYjmuIXpmaTlvZPliY3pgInkuK3lhoXlrrnlkI7vvIzlho3lgZrmj5LlhaVcclxuICogQHdhcm5pbmcg5rOo5oSPOuivpeWRveS7pOS8muWvueW9k+WJjemAieWMuueahOS9jee9ru+8jOWvueaPkuWFpeeahOWGheWuuei/m+ihjOi/h+a7pOi9rOaNouWkhOeQhuOAgiDov4fmu6TnmoTop4TliJnpgbXlvqpodG1s6K+t5oSP5YyW55qE5Y6f5YiZ44CCXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogLy94eHhbQkJdeHh4IOW9k+WJjemAieWMuuS4uumdnumXreWQiOmAieWMuu+8jOmAieS4rUJC6L+Z5Lik5Liq5paH5pysXHJcbiAqIC8v5omn6KGM5ZG95Luk77yM5o+S5YWlPGI+Q0M8L2I+XHJcbiAqIC8v5o+S5YWl5ZCO55qE5pWI5p6cIHh4eDxiPkNDPC9iPnh4eFxyXG4gKiAvLzxwPnh4fHh4eDwvcD4g5b2T5YmN6YCJ5Yy65Li66Zet5ZCI54q25oCBXHJcbiAqIC8v5o+S5YWlPHA+Q0M8L3A+XHJcbiAqIC8v57uT5p6cIDxwPnh4PC9wPjxwPkNDPC9wPjxwPnh4eDwvcD5cclxuICogLy88cD54eHh4PC9wPnw8L3A+eHh4PC9wPiDlvZPliY3pgInljLrlnKjkuKTkuKpw5qCH562+5LmL6Ze0XHJcbiAqIC8v5o+S5YWlIHh4eHhcclxuICogLy/nu5PmnpwgPHA+eHh4eDwvcD48cD54eHh4PC9wPjwvcD54eHg8L3A+XHJcbiAqIGBgYFxyXG4gKi9cclxuXHJcblVFLmNvbW1hbmRzWydpbnNlcnRodG1sJ10gPSB7XHJcbiAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKGNvbW1hbmQsaHRtbCxub3ROZWVkRmlsdGVyKXtcclxuICAgICAgICB2YXIgbWUgPSB0aGlzLFxyXG4gICAgICAgICAgICByYW5nZSxcclxuICAgICAgICAgICAgZGl2O1xyXG4gICAgICAgIGlmKCFodG1sKXtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZihtZS5maXJlRXZlbnQoJ2JlZm9yZWluc2VydGh0bWwnLGh0bWwpID09PSB0cnVlKXtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICByYW5nZSA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xyXG4gICAgICAgIGRpdiA9IHJhbmdlLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdkaXYnICk7XHJcbiAgICAgICAgZGl2LnN0eWxlLmRpc3BsYXkgPSAnaW5saW5lJztcclxuXHJcbiAgICAgICAgaWYgKCFub3ROZWVkRmlsdGVyKSB7XHJcbiAgICAgICAgICAgIHZhciByb290ID0gVUUuaHRtbHBhcnNlcihodG1sKTtcclxuICAgICAgICAgICAgLy/lpoLmnpznu5nkuobov4fmu6Top4TliJnlsLHlhYjov5vooYzov4fmu6RcclxuICAgICAgICAgICAgaWYobWUub3B0aW9ucy5maWx0ZXJSdWxlcyl7XHJcbiAgICAgICAgICAgICAgICBVRS5maWx0ZXJOb2RlKHJvb3QsbWUub3B0aW9ucy5maWx0ZXJSdWxlcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy/miafooYzpu5jorqTnmoTlpITnkIZcclxuICAgICAgICAgICAgbWUuZmlsdGVySW5wdXRSdWxlKHJvb3QpO1xyXG4gICAgICAgICAgICBodG1sID0gcm9vdC50b0h0bWwoKVxyXG4gICAgICAgIH1cclxuICAgICAgICBkaXYuaW5uZXJIVE1MID0gdXRpbHMudHJpbSggaHRtbCApO1xyXG5cclxuICAgICAgICBpZiAoICFyYW5nZS5jb2xsYXBzZWQgKSB7XHJcbiAgICAgICAgICAgIHZhciB0bXBOb2RlID0gcmFuZ2Uuc3RhcnRDb250YWluZXI7XHJcbiAgICAgICAgICAgIGlmKGRvbVV0aWxzLmlzRmlsbENoYXIodG1wTm9kZSkpe1xyXG4gICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnRCZWZvcmUodG1wTm9kZSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0bXBOb2RlID0gcmFuZ2UuZW5kQ29udGFpbmVyO1xyXG4gICAgICAgICAgICBpZihkb21VdGlscy5pc0ZpbGxDaGFyKHRtcE5vZGUpKXtcclxuICAgICAgICAgICAgICAgIHJhbmdlLnNldEVuZEFmdGVyKHRtcE5vZGUpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmFuZ2UudHh0VG9FbG1Cb3VuZGFyeSgpO1xyXG4gICAgICAgICAgICAvL+e7k+adn+i+ueeVjOWPr+iDveaUvuWIsOS6hmJy55qE5YmN6L6577yM6KaB5oqKYnLljIXlkKvov5vmnaVcclxuICAgICAgICAgICAgLy8geFt4eHhdPGJyLz5cclxuICAgICAgICAgICAgaWYocmFuZ2UuZW5kQ29udGFpbmVyICYmIHJhbmdlLmVuZENvbnRhaW5lci5ub2RlVHlwZSA9PSAxKXtcclxuICAgICAgICAgICAgICAgIHRtcE5vZGUgPSByYW5nZS5lbmRDb250YWluZXIuY2hpbGROb2Rlc1tyYW5nZS5lbmRPZmZzZXRdO1xyXG4gICAgICAgICAgICAgICAgaWYodG1wTm9kZSAmJiBkb21VdGlscy5pc0JyKHRtcE5vZGUpKXtcclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRFbmRBZnRlcih0bXBOb2RlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZihyYW5nZS5zdGFydE9mZnNldCA9PSAwKXtcclxuICAgICAgICAgICAgICAgIHRtcE5vZGUgPSByYW5nZS5zdGFydENvbnRhaW5lcjtcclxuICAgICAgICAgICAgICAgIGlmKGRvbVV0aWxzLmlzQm91bmRhcnlOb2RlKHRtcE5vZGUsJ2ZpcnN0Q2hpbGQnKSApe1xyXG4gICAgICAgICAgICAgICAgICAgIHRtcE5vZGUgPSByYW5nZS5lbmRDb250YWluZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYocmFuZ2UuZW5kT2Zmc2V0ID09ICh0bXBOb2RlLm5vZGVUeXBlID09IDMgPyB0bXBOb2RlLm5vZGVWYWx1ZS5sZW5ndGggOiB0bXBOb2RlLmNoaWxkTm9kZXMubGVuZ3RoKSAmJiBkb21VdGlscy5pc0JvdW5kYXJ5Tm9kZSh0bXBOb2RlLCdsYXN0Q2hpbGQnKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmJvZHkuaW5uZXJIVE1MID0gJzxwPicrKGJyb3dzZXIuaWUgPyAnJyA6ICc8YnIvPicpKyc8L3A+JztcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQobWUuYm9keS5maXJzdENoaWxkLDApLmNvbGxhcHNlKHRydWUpXHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAhcmFuZ2UuY29sbGFwc2VkICYmIHJhbmdlLmRlbGV0ZUNvbnRlbnRzKCk7XHJcbiAgICAgICAgICAgIGlmKHJhbmdlLnN0YXJ0Q29udGFpbmVyLm5vZGVUeXBlID09IDEpe1xyXG4gICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gcmFuZ2Uuc3RhcnRDb250YWluZXIuY2hpbGROb2Rlc1tyYW5nZS5zdGFydE9mZnNldF0scHJlO1xyXG4gICAgICAgICAgICAgICAgaWYoY2hpbGQgJiYgZG9tVXRpbHMuaXNCbG9ja0VsbShjaGlsZCkgJiYgKHByZSA9IGNoaWxkLnByZXZpb3VzU2libGluZykgJiYgZG9tVXRpbHMuaXNCbG9ja0VsbShwcmUpKXtcclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRFbmQocHJlLHByZS5jaGlsZE5vZGVzLmxlbmd0aCkuY29sbGFwc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICB3aGlsZShjaGlsZC5maXJzdENoaWxkKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJlLmFwcGVuZENoaWxkKGNoaWxkLmZpcnN0Q2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoY2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIHZhciBjaGlsZCxwYXJlbnQscHJlLHRtcCxoYWRCcmVhayA9IDAsIG5leHROb2RlO1xyXG4gICAgICAgIC8v5aaC5p6c5b2T5YmN5L2N572u6YCJ5Lit5LqGZmlsbGNoYXLopoHlubLmjonvvIzopoHkuI3kvJrkuqfnlJ/nqbrooYxcclxuICAgICAgICBpZihyYW5nZS5pbkZpbGxDaGFyKCkpe1xyXG4gICAgICAgICAgICBjaGlsZCA9IHJhbmdlLnN0YXJ0Q29udGFpbmVyO1xyXG4gICAgICAgICAgICBpZihkb21VdGlscy5pc0ZpbGxDaGFyKGNoaWxkKSl7XHJcbiAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydEJlZm9yZShjaGlsZCkuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoY2hpbGQpO1xyXG4gICAgICAgICAgICB9ZWxzZSBpZihkb21VdGlscy5pc0ZpbGxDaGFyKGNoaWxkLHRydWUpKXtcclxuICAgICAgICAgICAgICAgIGNoaWxkLm5vZGVWYWx1ZSA9IGNoaWxkLm5vZGVWYWx1ZS5yZXBsYWNlKGZpbGxDaGFyUmVnLCcnKTtcclxuICAgICAgICAgICAgICAgIHJhbmdlLnN0YXJ0T2Zmc2V0LS07XHJcbiAgICAgICAgICAgICAgICByYW5nZS5jb2xsYXBzZWQgJiYgcmFuZ2UuY29sbGFwc2UodHJ1ZSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvL+WIl+ihqOWNleeLrOWkhOeQhlxyXG4gICAgICAgIHZhciBsaSA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocmFuZ2Uuc3RhcnRDb250YWluZXIsJ2xpJyx0cnVlKTtcclxuICAgICAgICBpZihsaSl7XHJcbiAgICAgICAgICAgIHZhciBuZXh0LGxhc3Q7XHJcbiAgICAgICAgICAgIHdoaWxlKGNoaWxkID0gZGl2LmZpcnN0Q2hpbGQpe1xyXG4gICAgICAgICAgICAgICAgLy/pkojlr7locuWNleeLrOWkhOeQhuS4gOS4i+WFiFxyXG4gICAgICAgICAgICAgICAgd2hpbGUoY2hpbGQgJiYgKGNoaWxkLm5vZGVUeXBlID09IDMgfHwgIWRvbVV0aWxzLmlzQmxvY2tFbG0oY2hpbGQpIHx8IGNoaWxkLnRhZ05hbWU9PSdIUicgKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV4dCA9IGNoaWxkLm5leHRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLmluc2VydE5vZGUoIGNoaWxkKS5jb2xsYXBzZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxhc3QgPSBjaGlsZDtcclxuICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IG5leHQ7XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYoY2hpbGQpe1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKC9eKG9sfHVsKSQvaS50ZXN0KGNoaWxkLnRhZ05hbWUpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoY2hpbGQuZmlyc3RDaGlsZCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0ID0gY2hpbGQuZmlyc3RDaGlsZDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmluc2VydEFmdGVyKGxpLGNoaWxkLmZpcnN0Q2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGkgPSBsaS5uZXh0U2libGluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoY2hpbGQpXHJcbiAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0bXBMaTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCA9IGNoaWxkLm5leHRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bXBMaSA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmluc2VydEFmdGVyKGxpLHRtcExpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG1wTGkuYXBwZW5kQ2hpbGQoY2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0ID0gY2hpbGQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkID0gbmV4dDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGkgPSB0bXBMaTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGkgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHJhbmdlLnN0YXJ0Q29udGFpbmVyLCdsaScsdHJ1ZSk7XHJcbiAgICAgICAgICAgIGlmKGRvbVV0aWxzLmlzRW1wdHlCbG9jayhsaSkpe1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKGxpKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKGxhc3Qpe1xyXG5cclxuICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0QWZ0ZXIobGFzdCkuY29sbGFwc2UodHJ1ZSkuc2VsZWN0KHRydWUpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgd2hpbGUgKCBjaGlsZCA9IGRpdi5maXJzdENoaWxkICkge1xyXG4gICAgICAgICAgICAgICAgaWYoaGFkQnJlYWspe1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBwID0gbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIHdoaWxlKGNoaWxkICYmIChjaGlsZC5ub2RlVHlwZSA9PSAzIHx8ICFkdGQuJGJsb2NrW2NoaWxkLnRhZ05hbWVdKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5leHROb2RlID0gY2hpbGQubmV4dFNpYmxpbmc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuYXBwZW5kQ2hpbGQoY2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IG5leHROb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZihwLmZpcnN0Q2hpbGQpe1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBwXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmFuZ2UuaW5zZXJ0Tm9kZSggY2hpbGQgKTtcclxuICAgICAgICAgICAgICAgIG5leHROb2RlID0gY2hpbGQubmV4dFNpYmxpbmc7XHJcbiAgICAgICAgICAgICAgICBpZiAoICFoYWRCcmVhayAmJiBjaGlsZC5ub2RlVHlwZSA9PSBkb21VdGlscy5OT0RFX0VMRU1FTlQgJiYgZG9tVXRpbHMuaXNCbG9ja0VsbSggY2hpbGQgKSApe1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSBkb21VdGlscy5maW5kUGFyZW50KCBjaGlsZCxmdW5jdGlvbiAoIG5vZGUgKXsgcmV0dXJuIGRvbVV0aWxzLmlzQmxvY2tFbG0oIG5vZGUgKTsgfSApO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICggcGFyZW50ICYmIHBhcmVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgIT0gJ2JvZHknICYmICEoZHRkW3BhcmVudC50YWdOYW1lXVtjaGlsZC5ub2RlTmFtZV0gJiYgY2hpbGQucGFyZW50Tm9kZSA9PT0gcGFyZW50KSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFkdGRbcGFyZW50LnRhZ05hbWVdW2NoaWxkLm5vZGVOYW1lXSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUgPSBwYXJlbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gY2hpbGQucGFyZW50Tm9kZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICh0bXAgIT09IHBhcmVudCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlID0gdG1wO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcCA9IHRtcC5wYXJlbnROb2RlO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmJyZWFrUGFyZW50KCBjaGlsZCwgcHJlIHx8IHRtcCApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL+WOu+aOiWJyZWFr5ZCO5YmN5LiA5Liq5aSa5L2Z55qE6IqC54K5ICA8cD58PFtwPiA9PT4gPHA+PC9wPjxkaXY+PC9kaXY+PHA+fDwvcD5cclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByZSA9IGNoaWxkLnByZXZpb3VzU2libGluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMudHJpbVdoaXRlVGV4dE5vZGUocHJlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoIXByZS5jaGlsZE5vZGVzLmxlbmd0aCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUocHJlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL3RyYWNlOjIwMTIs5Zyo6Z2eaWXnmoTmg4XlhrXvvIzliIflvIDlkI7liankuIvnmoToioLngrnmnInlj6/og73kuI3og73ngrnlhaXlhYnmoIfmt7vliqBicuWNoOS9jVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWJyb3dzZXIuaWUgJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIChuZXh0ID0gY2hpbGQubmV4dFNpYmxpbmcpICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5pc0Jsb2NrRWxtKG5leHQpICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0Lmxhc3RDaGlsZCAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIWRvbVV0aWxzLmlzQnIobmV4dC5sYXN0Q2hpbGQpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQuYXBwZW5kQ2hpbGQobWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnInKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaGFkQnJlYWsgPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gY2hpbGQubmV4dFNpYmxpbmc7XHJcbiAgICAgICAgICAgICAgICBpZighZGl2LmZpcnN0Q2hpbGQgJiYgbmV4dCAmJiBkb21VdGlscy5pc0Jsb2NrRWxtKG5leHQpKXtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQobmV4dCwwKS5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJhbmdlLnNldEVuZEFmdGVyKCBjaGlsZCApLmNvbGxhcHNlKCk7XHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjaGlsZCA9IHJhbmdlLnN0YXJ0Q29udGFpbmVyO1xyXG5cclxuICAgICAgICAgICAgaWYobmV4dE5vZGUgJiYgZG9tVXRpbHMuaXNCcihuZXh0Tm9kZSkpe1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKG5leHROb2RlKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8v55SoY2hyb21l5Y+v6IO95pyJ56m655m95bGV5L2N56ymXHJcbiAgICAgICAgICAgIGlmKGRvbVV0aWxzLmlzQmxvY2tFbG0oY2hpbGQpICYmIGRvbVV0aWxzLmlzRW1wdHlOb2RlKGNoaWxkKSl7XHJcbiAgICAgICAgICAgICAgICBpZihuZXh0Tm9kZSA9IGNoaWxkLm5leHRTaWJsaW5nKXtcclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoY2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKG5leHROb2RlLm5vZGVUeXBlID09IDEgJiYgZHRkLiRibG9ja1tuZXh0Tm9kZS50YWdOYW1lXSl7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydChuZXh0Tm9kZSwwKS5jb2xsYXBzZSh0cnVlKS5zaHJpbmtCb3VuZGFyeSgpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHRyeXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuaW5uZXJIVE1MID0gYnJvd3Nlci5pZSA/IGRvbVV0aWxzLmZpbGxDaGFyIDogJzxici8+JztcclxuICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0QmVmb3JlKGNoaWxkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKGNoaWxkKVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8v5Yqg5LiKdHJ1ZeWboOS4uuWcqOWIoOmZpOihqOaDheetieaXtuS8muWIoOS4pOasoe+8jOesrOS4gOasoeaYr+WIoOeahGZpbGxEYXRhXHJcbiAgICAgICAgICAgIHRyeXtcclxuICAgICAgICAgICAgICAgIHJhbmdlLnNlbGVjdCh0cnVlKTtcclxuICAgICAgICAgICAgfWNhdGNoKGUpe31cclxuXHJcbiAgICAgICAgfVxyXG5cclxuXHJcblxyXG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgcmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuICAgICAgICAgICAgcmFuZ2Uuc2Nyb2xsVG9WaWV3KG1lLmF1dG9IZWlnaHRFbmFibGVkLG1lLmF1dG9IZWlnaHRFbmFibGVkID8gZG9tVXRpbHMuZ2V0WFkobWUuaWZyYW1lKS55OjApO1xyXG4gICAgICAgICAgICBtZS5maXJlRXZlbnQoJ2FmdGVyaW5zZXJ0aHRtbCcsIGh0bWwpO1xyXG4gICAgICAgIH0sMjAwKTtcclxuICAgIH1cclxufTtcclxuXG5cbi8vIHBsdWdpbnMvYXV0b3R5cGVzZXQuanNcbi8qKlxyXG4gKiDoh6rliqjmjpLniYhcclxuICogQGZpbGVcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG4vKipcclxuICog5a+55b2T5YmN57yW6L6R5Zmo55qE5YaF5a655omn6KGM6Ieq5Yqo5o6S54mI77yMIOaOkueJiOeahOihjOS4uuagueaNrmNvbmZpZ+mFjee9ruaWh+S7tumHjOeahOKAnGF1dG90eXBlc2V04oCd6YCJ6aG56L+b6KGM5o6n5Yi244CCXHJcbiAqIEBjb21tYW5kIGF1dG90eXBlc2V0XHJcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGBqYXZhc2NyaXB0XHJcbiAqIGVkaXRvci5leGVjQ29tbWFuZCggJ2F1dG90eXBlc2V0JyApO1xyXG4gKiBgYGBcclxuICovXHJcblxyXG5VRS5wbHVnaW5zWydhdXRvdHlwZXNldCddID0gZnVuY3Rpb24oKXtcclxuXHJcbiAgICB0aGlzLnNldE9wdCh7J2F1dG90eXBlc2V0Jzoge1xyXG4gICAgICAgIG1lcmdlRW1wdHlsaW5lOiB0cnVlLCAgICAgICAgICAgLy/lkIjlubbnqbrooYxcclxuICAgICAgICByZW1vdmVDbGFzczogdHJ1ZSwgICAgICAgICAgICAgIC8v5Y675o6J5YaX5L2Z55qEY2xhc3NcclxuICAgICAgICByZW1vdmVFbXB0eWxpbmU6IGZhbHNlLCAgICAgICAgIC8v5Y675o6J56m66KGMXHJcbiAgICAgICAgdGV4dEFsaWduOlwibGVmdFwiLCAgICAgICAgICAgICAgIC8v5q616JC955qE5o6S54mI5pa55byP77yM5Y+v5Lul5pivIGxlZnQscmlnaHQsY2VudGVyLGp1c3RpZnkg5Y675o6J6L+Z5Liq5bGe5oCn6KGo56S65LiN5omn6KGM5o6S54mIXHJcbiAgICAgICAgaW1hZ2VCbG9ja0xpbmU6ICdjZW50ZXInLCAgICAgICAvL+WbvueJh+eahOa1ruWKqOaWueW8j++8jOeLrOWNoOS4gOihjOWJp+S4rSzlt6blj7Pmta7liqjvvIzpu5jorqQ6IGNlbnRlcixsZWZ0LHJpZ2h0LG5vbmUg5Y675o6J6L+Z5Liq5bGe5oCn6KGo56S65LiN5omn6KGM5o6S54mIXHJcbiAgICAgICAgcGFzdGVGaWx0ZXI6IGZhbHNlLCAgICAgICAgICAgICAvL+agueaNruinhOWImei/h+a7pOayoeS6i+eymOi0tOi/m+adpeeahOWGheWuuVxyXG4gICAgICAgIGNsZWFyRm9udFNpemU6IGZhbHNlLCAgICAgICAgICAgLy/ljrvmjonmiYDmnInnmoTlhoXltYzlrZflj7fvvIzkvb/nlKjnvJbovpHlmajpu5jorqTnmoTlrZflj7dcclxuICAgICAgICBjbGVhckZvbnRGYW1pbHk6IGZhbHNlLCAgICAgICAgIC8v5Y675o6J5omA5pyJ55qE5YaF5bWM5a2X5L2T77yM5L2/55So57yW6L6R5Zmo6buY6K6k55qE5a2X5L2TXHJcbiAgICAgICAgcmVtb3ZlRW1wdHlOb2RlOiBmYWxzZSwgICAgICAgICAvLyDljrvmjonnqbroioLngrlcclxuICAgICAgICAvL+WPr+S7peWOu+aOieeahOagh+etvlxyXG4gICAgICAgIHJlbW92ZVRhZ05hbWVzOiB1dGlscy5leHRlbmQoe2RpdjoxfSxkdGQuJHJlbW92ZUVtcHR5KSxcclxuICAgICAgICBpbmRlbnQ6IGZhbHNlLCAgICAgICAgICAgICAgICAgIC8vIOihjOmmlue8qei/m1xyXG4gICAgICAgIGluZGVudFZhbHVlIDogJzJlbScsICAgICAgICAgICAgLy/ooYzpppbnvKnov5vnmoTlpKflsI9cclxuICAgICAgICBiZGMyc2I6IGZhbHNlLFxyXG4gICAgICAgIHRvYmRjOiBmYWxzZVxyXG4gICAgfX0pO1xyXG5cclxuICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgb3B0ID0gbWUub3B0aW9ucy5hdXRvdHlwZXNldCxcclxuICAgICAgICByZW1haW5DbGFzcyA9IHtcclxuICAgICAgICAgICAgJ3NlbGVjdFRkQ2xhc3MnOjEsXHJcbiAgICAgICAgICAgICdwYWdlYnJlYWsnOjEsXHJcbiAgICAgICAgICAgICdhbmNob3JjbGFzcyc6MVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcmVtYWluVGFnID0ge1xyXG4gICAgICAgICAgICAnbGknOjFcclxuICAgICAgICB9LFxyXG4gICAgICAgIHRhZ3MgPSB7XHJcbiAgICAgICAgICAgIGRpdjoxLFxyXG4gICAgICAgICAgICBwOjEsXHJcbiAgICAgICAgICAgIC8vdHJhY2U6MjE4MyDov5nkupvkuZ/orqTkuLrmmK/ooYxcclxuICAgICAgICAgICAgYmxvY2txdW90ZToxLGNlbnRlcjoxLGgxOjEsaDI6MSxoMzoxLGg0OjEsaDU6MSxoNjoxLFxyXG4gICAgICAgICAgICBzcGFuOjFcclxuICAgICAgICB9LFxyXG4gICAgICAgIGhpZ2hsaWdodENvbnQ7XHJcbiAgICAvL+WNh+e6p+S6hueJiOacrO+8jOS9humFjee9rumhueebrumHjOayoeaciWF1dG90eXBlc2V0XHJcbiAgICBpZighb3B0KXtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgcmVhZExvY2FsT3B0cygpO1xyXG5cclxuICAgIGZ1bmN0aW9uIGlzTGluZShub2RlLG5vdEVtcHR5KXtcclxuICAgICAgICBpZighbm9kZSB8fCBub2RlLm5vZGVUeXBlID09IDMpXHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIGlmKGRvbVV0aWxzLmlzQnIobm9kZSkpXHJcbiAgICAgICAgICAgIHJldHVybiAxO1xyXG4gICAgICAgIGlmKG5vZGUgJiYgbm9kZS5wYXJlbnROb2RlICYmIHRhZ3Nbbm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCldKXtcclxuICAgICAgICAgICAgaWYoaGlnaGxpZ2h0Q29udCAmJiBoaWdobGlnaHRDb250LmNvbnRhaW5zKG5vZGUpXHJcbiAgICAgICAgICAgICAgICB8fFxyXG4gICAgICAgICAgICAgICAgbm9kZS5nZXRBdHRyaWJ1dGUoJ3BhZ2VicmVhaycpXHJcbiAgICAgICAgICAgICl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIG5vdEVtcHR5ID8gIWRvbVV0aWxzLmlzRW1wdHlCbG9jayhub2RlKSA6IGRvbVV0aWxzLmlzRW1wdHlCbG9jayhub2RlLG5ldyBSZWdFeHAoJ1tcXFxccycrZG9tVXRpbHMuZmlsbENoYXJcclxuICAgICAgICAgICAgICAgICsnXScsJ2cnKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlbW92ZU5vdEF0dHJpYnV0ZVNwYW4obm9kZSl7XHJcbiAgICAgICAgaWYoIW5vZGUuc3R5bGUuY3NzVGV4dCl7XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZUF0dHJpYnV0ZXMobm9kZSxbJ3N0eWxlJ10pO1xyXG4gICAgICAgICAgICBpZihub2RlLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAnc3BhbicgJiYgZG9tVXRpbHMuaGFzTm9BdHRyaWJ1dGVzKG5vZGUpKXtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShub2RlLHRydWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gYXV0b3R5cGUodHlwZSxodG1sKXtcclxuXHJcbiAgICAgICAgdmFyIG1lID0gdGhpcyxjb250O1xyXG4gICAgICAgIGlmKGh0bWwpe1xyXG4gICAgICAgICAgICBpZighb3B0LnBhc3RlRmlsdGVyKXtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb250ID0gbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgICAgIGNvbnQuaW5uZXJIVE1MID0gaHRtbC5odG1sO1xyXG4gICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICBjb250ID0gbWUuZG9jdW1lbnQuYm9keTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIG5vZGVzID0gZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoY29udCwnKicpO1xyXG5cclxuICAgICAgICAvLyDooYzpppbnvKnov5vvvIzmrrXokL3mlrnlkJHvvIzmrrXpl7Tot53vvIzmrrXlhoXpl7Tot51cclxuICAgICAgICBmb3IodmFyIGk9MCxjaTtjaT1ub2Rlc1tpKytdOyl7XHJcblxyXG4gICAgICAgICAgICBpZihtZS5maXJlRXZlbnQoJ2V4Y2x1ZGVOb2RlaW5hdXRvdHlwZScsY2kpID09PSB0cnVlKXtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAvL2ZvbnQtc2l6ZVxyXG4gICAgICAgICAgICBpZihvcHQuY2xlYXJGb250U2l6ZSAmJiBjaS5zdHlsZS5mb250U2l6ZSl7XHJcbiAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmVTdHlsZShjaSwnZm9udC1zaXplJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgcmVtb3ZlTm90QXR0cmlidXRlU3BhbihjaSk7XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vZm9udC1mYW1pbHlcclxuICAgICAgICAgICAgaWYob3B0LmNsZWFyRm9udEZhbWlseSAmJiBjaS5zdHlsZS5mb250RmFtaWx5KXtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZVN0eWxlKGNpLCdmb250LWZhbWlseScpO1xyXG4gICAgICAgICAgICAgICAgcmVtb3ZlTm90QXR0cmlidXRlU3BhbihjaSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmKGlzTGluZShjaSkpe1xyXG4gICAgICAgICAgICAgICAgLy/lkIjlubbnqbrooYxcclxuICAgICAgICAgICAgICAgIGlmKG9wdC5tZXJnZUVtcHR5bGluZSApe1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gY2kubmV4dFNpYmxpbmcsdG1wTm9kZSxpc0JyID0gZG9tVXRpbHMuaXNCcihjaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUoaXNMaW5lKG5leHQpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG1wTm9kZSA9IG5leHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5leHQgPSB0bXBOb2RlLm5leHRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihpc0JyICYmICghbmV4dCB8fCBuZXh0ICYmICFkb21VdGlscy5pc0JyKG5leHQpKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUodG1wTm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAvL+WOu+aOieepuuihjO+8jOS/neeVmeWNoOS9jeeahOepuuihjFxyXG4gICAgICAgICAgICAgICAgaWYob3B0LnJlbW92ZUVtcHR5bGluZSAmJiBkb21VdGlscy5pbkRvYyhjaSxjb250KSAmJiAhcmVtYWluVGFnW2NpLnBhcmVudE5vZGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpXSApe1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGRvbVV0aWxzLmlzQnIoY2kpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCA9IGNpLm5leHRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihuZXh0ICYmICFkb21VdGlscy5pc0JyKG5leHQpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShjaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZihpc0xpbmUoY2ksdHJ1ZSkgJiYgY2kudGFnTmFtZSAhPSAnU1BBTicpe1xyXG4gICAgICAgICAgICAgICAgaWYob3B0LmluZGVudCl7XHJcbiAgICAgICAgICAgICAgICAgICAgY2kuc3R5bGUudGV4dEluZGVudCA9IG9wdC5pbmRlbnRWYWx1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmKG9wdC50ZXh0QWxpZ24pe1xyXG4gICAgICAgICAgICAgICAgICAgIGNpLnN0eWxlLnRleHRBbGlnbiA9IG9wdC50ZXh0QWxpZ247XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyBpZihvcHQubGluZUhlaWdodClcclxuICAgICAgICAgICAgICAgIC8vICAgICBjaS5zdHlsZS5saW5lSGVpZ2h0ID0gb3B0LmxpbmVIZWlnaHQgKyAnY20nO1xyXG5cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy/ljrvmjoljbGFzcyzkv53nlZnnmoRjbGFzc+S4jeWOu+aOiVxyXG4gICAgICAgICAgICBpZihvcHQucmVtb3ZlQ2xhc3MgJiYgY2kuY2xhc3NOYW1lICYmICFyZW1haW5DbGFzc1tjaS5jbGFzc05hbWUudG9Mb3dlckNhc2UoKV0pe1xyXG5cclxuICAgICAgICAgICAgICAgIGlmKGhpZ2hsaWdodENvbnQgJiYgaGlnaGxpZ2h0Q29udC5jb250YWlucyhjaSkpe1xyXG4gICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZUF0dHJpYnV0ZXMoY2ksWydjbGFzcyddKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy/ooajmg4XkuI3lpITnkIZcclxuICAgICAgICAgICAgaWYob3B0LmltYWdlQmxvY2tMaW5lICYmIGNpLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAnaW1nJyAmJiAhY2kuZ2V0QXR0cmlidXRlKCdlbW90aW9uJykpe1xyXG4gICAgICAgICAgICAgICAgaWYoaHRtbCl7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGltZyA9IGNpO1xyXG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaCAob3B0LmltYWdlQmxvY2tMaW5lKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbGVmdCc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3JpZ2h0JzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbm9uZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcE4gPSBpbWcucGFyZW50Tm9kZSx0bXBOb2RlLHByZSxuZXh0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoZHRkLiRpbmxpbmVbcE4udGFnTmFtZV0gfHwgcE4udGFnTmFtZSA9PSAnQScpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBOID0gcE4ucGFyZW50Tm9kZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcE5vZGUgPSBwTjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRtcE5vZGUudGFnTmFtZSA9PSAnUCcgJiYgZG9tVXRpbHMuZ2V0U3R5bGUodG1wTm9kZSwndGV4dC1hbGlnbicpID09ICdjZW50ZXInKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighZG9tVXRpbHMuaXNCb2R5KHRtcE5vZGUpICYmIGRvbVV0aWxzLmdldENoaWxkQ291bnQodG1wTm9kZSxmdW5jdGlvbihub2RlKXtyZXR1cm4gIWRvbVV0aWxzLmlzQnIobm9kZSkgJiYgIWRvbVV0aWxzLmlzV2hpdGVzcGFjZShub2RlKX0pID09IDEpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUgPSB0bXBOb2RlLnByZXZpb3VzU2libGluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCA9IHRtcE5vZGUubmV4dFNpYmxpbmc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHByZSAmJiBuZXh0ICYmIHByZS5ub2RlVHlwZSA9PSAxICYmICBuZXh0Lm5vZGVUeXBlID09IDEgJiYgcHJlLnRhZ05hbWUgPT0gbmV4dC50YWdOYW1lICYmIGRvbVV0aWxzLmlzQmxvY2tFbG0ocHJlKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUuYXBwZW5kQ2hpbGQodG1wTm9kZS5maXJzdENoaWxkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKG5leHQuZmlyc3RDaGlsZCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlLmFwcGVuZENoaWxkKG5leHQuZmlyc3RDaGlsZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUodG1wTm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUobmV4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuc2V0U3R5bGUodG1wTm9kZSwndGV4dC1hbGlnbicsJycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnNldFN0eWxlKGltZywnZmxvYXQnLCBvcHQuaW1hZ2VCbG9ja0xpbmUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2NlbnRlcic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihtZS5xdWVyeUNvbW1hbmRWYWx1ZSgnaW1hZ2VmbG9hdCcpICE9ICdjZW50ZXInKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwTiA9IGltZy5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnNldFN0eWxlKGltZywnZmxvYXQnLCdub25lJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wTm9kZSA9IGltZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZShwTiAmJiBkb21VdGlscy5nZXRDaGlsZENvdW50KHBOLGZ1bmN0aW9uKG5vZGUpe3JldHVybiAhZG9tVXRpbHMuaXNCcihub2RlKSAmJiAhZG9tVXRpbHMuaXNXaGl0ZXNwYWNlKG5vZGUpfSkgPT0gMVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiAoZHRkLiRpbmxpbmVbcE4udGFnTmFtZV0gfHwgcE4udGFnTmFtZSA9PSAnQScpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wTm9kZSA9IHBOO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwTiA9IHBOLnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwTm9kZSA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5zZXRBdHRyaWJ1dGVzKHBOb2RlLHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOid0ZXh0LWFsaWduOmNlbnRlcidcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBOb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHBOb2RlLHRtcE5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBOb2RlLmFwcGVuZENoaWxkKHRtcE5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnNldFN0eWxlKHRtcE5vZGUsJ2Zsb2F0JywnJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5zZWxlY3ROb2RlKGNpKS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICBtZS5leGVjQ29tbWFuZCgnaW1hZ2VmbG9hdCcsIG9wdC5pbWFnZUJsb2NrTGluZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvL+WOu+aOieWGl+S9meeahOagh+etvlxyXG4gICAgICAgICAgICBpZihvcHQucmVtb3ZlRW1wdHlOb2RlKXtcclxuICAgICAgICAgICAgICAgIGlmKG9wdC5yZW1vdmVUYWdOYW1lc1tjaS50YWdOYW1lLnRvTG93ZXJDYXNlKCldICYmIGRvbVV0aWxzLmhhc05vQXR0cmlidXRlcyhjaSkgJiYgZG9tVXRpbHMuaXNFbXB0eUJsb2NrKGNpKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKGNpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZihvcHQudG9iZGMpe1xyXG4gICAgICAgICAgICB2YXIgcm9vdCA9IFVFLmh0bWxwYXJzZXIoY29udC5pbm5lckhUTUwpO1xyXG4gICAgICAgICAgICByb290LnRyYXZlcnNhbChmdW5jdGlvbihub2RlKXtcclxuICAgICAgICAgICAgICAgIGlmKG5vZGUudHlwZSA9PSAndGV4dCcpe1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSA9IFRvREJDKG5vZGUuZGF0YSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGNvbnQuaW5uZXJIVE1MID0gcm9vdC50b0h0bWwoKVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZihvcHQuYmRjMnNiKXtcclxuICAgICAgICAgICAgdmFyIHJvb3QgPSBVRS5odG1scGFyc2VyKGNvbnQuaW5uZXJIVE1MKTtcclxuICAgICAgICAgICAgcm9vdC50cmF2ZXJzYWwoZnVuY3Rpb24obm9kZSl7XHJcbiAgICAgICAgICAgICAgICBpZihub2RlLnR5cGUgPT0gJ3RleHQnKXtcclxuICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSBEQkMyU0Iobm9kZS5kYXRhKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgY29udC5pbm5lckhUTUwgPSByb290LnRvSHRtbCgpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmKGh0bWwpe1xyXG4gICAgICAgICAgICBodG1sLmh0bWwgPSBjb250LmlubmVySFRNTDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBpZihvcHQucGFzdGVGaWx0ZXIpe1xyXG4gICAgICAgIG1lLmFkZExpc3RlbmVyKCdiZWZvcmVwYXN0ZScsYXV0b3R5cGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIERCQzJTQihzdHIpIHtcclxuICAgICAgICB2YXIgcmVzdWx0ID0gJyc7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgdmFyIGNvZGUgPSBzdHIuY2hhckNvZGVBdChpKTsgLy/ojrflj5blvZPliY3lrZfnrKbnmoR1bmljb2Rl57yW56CBXHJcbiAgICAgICAgICAgIGlmIChjb2RlID49IDY1MjgxICYmIGNvZGUgPD0gNjUzNzMpLy/lnKjov5nkuKp1bmljb2Rl57yW56CB6IyD5Zu05Lit55qE5piv5omA5pyJ55qE6Iux5paH5a2X5q+N5bey57uP5ZCE56eN5a2X56ymXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHN0ci5jaGFyQ29kZUF0KGkpIC0gNjUyNDgpOyAvL+aKiuWFqOinkuWtl+espueahHVuaWNvZGXnvJbnoIHovazmjaLkuLrlr7nlupTljYrop5LlrZfnrKbnmoR1bmljb2Rl56CBXHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY29kZSA9PSAxMjI4OCkvL+epuuagvFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShzdHIuY2hhckNvZGVBdChpKSAtIDEyMjg4ICsgMzIpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ICs9IHN0ci5jaGFyQXQoaSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIFRvREJDKHR4dHN0cmluZykge1xyXG4gICAgICAgIHR4dHN0cmluZyA9IHV0aWxzLmh0bWwodHh0c3RyaW5nKTtcclxuICAgICAgICB2YXIgdG1wID0gXCJcIjtcclxuICAgICAgICB2YXIgbWFyayA9IFwiXCI7LyrnlKjkuo7liKTmlq0s5aaC5p6c5pivaHRtbOWwluaLrOmHjOeahOagh+iusCzliJnkuI3ov5vooYzlhajop5LnmoTovazmjaIqL1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHh0c3RyaW5nLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmICh0eHRzdHJpbmcuY2hhckNvZGVBdChpKSA9PSAzMikge1xyXG4gICAgICAgICAgICAgICAgdG1wID0gdG1wICsgU3RyaW5nLmZyb21DaGFyQ29kZSgxMjI4OCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAodHh0c3RyaW5nLmNoYXJDb2RlQXQoaSkgPCAxMjcpIHtcclxuICAgICAgICAgICAgICAgIHRtcCA9IHRtcCArIFN0cmluZy5mcm9tQ2hhckNvZGUodHh0c3RyaW5nLmNoYXJDb2RlQXQoaSkgKyA2NTI0OCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0bXAgKz0gdHh0c3RyaW5nLmNoYXJBdChpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdG1wO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlYWRMb2NhbE9wdHMoKSB7XHJcbiAgICAgICAgdmFyIGNvb2tpZU9wdCA9IG1lLmdldFByZWZlcmVuY2VzKCdhdXRvdHlwZXNldCcpO1xyXG4gICAgICAgIHV0aWxzLmV4dGVuZChtZS5vcHRpb25zLmF1dG90eXBlc2V0LCBjb29raWVPcHQpO1xyXG4gICAgfVxyXG5cclxuICAgIG1lLmNvbW1hbmRzWydhdXRvdHlwZXNldCddID0ge1xyXG4gICAgICAgIGV4ZWNDb21tYW5kOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgbWUucmVtb3ZlTGlzdGVuZXIoJ2JlZm9yZXBhc3RlJyxhdXRvdHlwZSk7XHJcbiAgICAgICAgICAgIGlmKG9wdC5wYXN0ZUZpbHRlcil7XHJcbiAgICAgICAgICAgICAgICBtZS5hZGRMaXN0ZW5lcignYmVmb3JlcGFzdGUnLGF1dG90eXBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBhdXRvdHlwZS5jYWxsKG1lKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9O1xyXG5cclxufTtcclxuXHJcblxuXG4vLyBwbHVnaW5zL2F1dG9zdWJtaXQuanNcbi8qKlxyXG4gKiDlv6vmjbfplK7mj5DkuqRcclxuICogQGZpbGVcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG4vKipcclxuICog5o+Q5Lqk6KGo5Y2VXHJcbiAqIEBjb21tYW5kIGF1dG9zdWJtaXRcclxuICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnYXV0b3N1Ym1pdCcgKTtcclxuICogYGBgXHJcbiAqL1xyXG5cclxuVUUucGx1Z2luLnJlZ2lzdGVyKCdhdXRvc3VibWl0JyxmdW5jdGlvbigpe1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBzaG9ydGN1dGtleTp7XHJcbiAgICAgICAgICAgIFwiYXV0b3N1Ym1pdFwiOlwiY3RybCsxM1wiIC8v5omL5Yqo5o+Q5LqkXHJcbiAgICAgICAgfSxcclxuICAgICAgICBjb21tYW5kczp7XHJcbiAgICAgICAgICAgICdhdXRvc3VibWl0Jzp7XHJcbiAgICAgICAgICAgICAgICBleGVjQ29tbWFuZDpmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1lPXRoaXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0gPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKG1lLmlmcmFtZSxcImZvcm1cIiwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmb3JtKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYobWUuZmlyZUV2ZW50KFwiYmVmb3Jlc3VibWl0XCIpPT09ZmFsc2Upe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLnN5bmMoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9ybS5zdWJtaXQoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0pO1xuXG4vLyBwbHVnaW5zL2JhY2tncm91bmQuanNcbi8qKlxyXG4gKiDog4zmma/mj5Lku7bvvIzkuLpVRWRpdG9y5o+Q5L6b6K6+572u6IOM5pmv5Yqf6IO9XHJcbiAqIEBmaWxlXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqL1xyXG5VRS5wbHVnaW4ucmVnaXN0ZXIoJ2JhY2tncm91bmQnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgbWUgPSB0aGlzLFxyXG4gICAgICAgIGNzc1J1bGVJZCA9ICdlZGl0b3JfYmFja2dyb3VuZCcsXHJcbiAgICAgICAgaXNTZXRDb2xvcmVkLFxyXG4gICAgICAgIHJlZyA9IG5ldyBSZWdFeHAoJ2JvZHlbXFxcXHNdKlxcXFx7KC4rKVxcXFx9JywgJ2knKTtcclxuXHJcbiAgICBmdW5jdGlvbiBzdHJpbmdUb09iaihzdHIpIHtcclxuICAgICAgICB2YXIgb2JqID0ge30sIHN0eWxlcyA9IHN0ci5zcGxpdCgnOycpO1xyXG4gICAgICAgIHV0aWxzLmVhY2goc3R5bGVzLCBmdW5jdGlvbiAodikge1xyXG4gICAgICAgICAgICB2YXIgaW5kZXggPSB2LmluZGV4T2YoJzonKSxcclxuICAgICAgICAgICAgICAgIGtleSA9IHV0aWxzLnRyaW0odi5zdWJzdHIoMCwgaW5kZXgpKS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICBrZXkgJiYgKG9ialtrZXldID0gdXRpbHMudHJpbSh2LnN1YnN0cihpbmRleCArIDEpIHx8ICcnKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIG9iajtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzZXRCYWNrZ3JvdW5kKG9iaikge1xyXG4gICAgICAgIGlmIChvYmopIHtcclxuICAgICAgICAgICAgdmFyIHN0eWxlcyA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIG9iaikge1xyXG4gICAgICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHN0eWxlcy5wdXNoKG5hbWUgKyBcIjpcIiArIG9ialtuYW1lXSArICc7ICcpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHV0aWxzLmNzc1J1bGUoY3NzUnVsZUlkLCBzdHlsZXMubGVuZ3RoID8gKCdib2R5eycgKyBzdHlsZXMuam9pbihcIlwiKSArICd9JykgOiAnJywgbWUuZG9jdW1lbnQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHV0aWxzLmNzc1J1bGUoY3NzUnVsZUlkLCAnJywgbWUuZG9jdW1lbnQpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy/ph43lhpllZGl0b3IuaGFzQ29udGVudOaWueazlVxyXG5cclxuICAgIHZhciBvcmdGbiA9IG1lLmhhc0NvbnRlbnRzO1xyXG4gICAgbWUuaGFzQ29udGVudHMgPSBmdW5jdGlvbigpe1xyXG4gICAgICAgIGlmKG1lLnF1ZXJ5Q29tbWFuZFZhbHVlKCdiYWNrZ3JvdW5kJykpe1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gb3JnRm4uYXBwbHkobWUsYXJndW1lbnRzKTtcclxuICAgIH07XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGJpbmRFdmVudHM6IHtcclxuICAgICAgICAgICAgJ2dldEFsbEh0bWwnOiBmdW5jdGlvbiAodHlwZSwgaGVhZEh0bWwpIHtcclxuICAgICAgICAgICAgICAgIHZhciBib2R5ID0gdGhpcy5ib2R5LFxyXG4gICAgICAgICAgICAgICAgICAgIHN1ID0gZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZShib2R5LCBcImJhY2tncm91bmQtaW1hZ2VcIiksXHJcbiAgICAgICAgICAgICAgICAgICAgdXJsID0gXCJcIjtcclxuICAgICAgICAgICAgICAgIGlmIChzdS5pbmRleE9mKG1lLm9wdGlvbnMuaW1hZ2VQYXRoKSA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICB1cmwgPSBzdS5zdWJzdHJpbmcoc3UuaW5kZXhPZihtZS5vcHRpb25zLmltYWdlUGF0aCksIHN1Lmxlbmd0aCAtIDEpLnJlcGxhY2UoL1wifFxcKHxcXCkvaWcsIFwiXCIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB1cmwgPSBzdSAhPSBcIm5vbmVcIiA/IHN1LnJlcGxhY2UoL3VybFxcKFwiP3xcIj9cXCkvaWcsIFwiXCIpIDogXCJcIjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHZhciBodG1sID0gJzxzdHlsZSB0eXBlPVwidGV4dC9jc3NcIj5ib2R5eyc7XHJcbiAgICAgICAgICAgICAgICB2YXIgYmdPYmogPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgXCJiYWNrZ3JvdW5kLWNvbG9yXCI6IGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUoYm9keSwgXCJiYWNrZ3JvdW5kLWNvbG9yXCIpIHx8IFwiI2ZmZmZmZlwiLFxyXG4gICAgICAgICAgICAgICAgICAgICdiYWNrZ3JvdW5kLWltYWdlJzogdXJsID8gJ3VybCgnICsgdXJsICsgJyknIDogJycsXHJcbiAgICAgICAgICAgICAgICAgICAgJ2JhY2tncm91bmQtcmVwZWF0JzogZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZShib2R5LCBcImJhY2tncm91bmQtcmVwZWF0XCIpIHx8IFwiXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgJ2JhY2tncm91bmQtcG9zaXRpb24nOiBicm93c2VyLmllID8gKGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUoYm9keSwgXCJiYWNrZ3JvdW5kLXBvc2l0aW9uLXhcIikgKyBcIiBcIiArIGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUoYm9keSwgXCJiYWNrZ3JvdW5kLXBvc2l0aW9uLXlcIikpIDogZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZShib2R5LCBcImJhY2tncm91bmQtcG9zaXRpb25cIiksXHJcbiAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCc6IGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUoYm9keSwgXCJoZWlnaHRcIilcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIGJnT2JqKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJnT2JqLmhhc093blByb3BlcnR5KG5hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGh0bWwgKz0gbmFtZSArIFwiOlwiICsgYmdPYmpbbmFtZV0gKyBcIjsgXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaHRtbCArPSAnfTwvc3R5bGU+ICc7XHJcbiAgICAgICAgICAgICAgICBoZWFkSHRtbC5wdXNoKGh0bWwpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAnYWZ0ZXJzZXRjb250ZW50JzogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgaWYoaXNTZXRDb2xvcmVkID09IGZhbHNlKSBzZXRCYWNrZ3JvdW5kKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGlucHV0UnVsZTogZnVuY3Rpb24gKHJvb3QpIHtcclxuICAgICAgICAgICAgaXNTZXRDb2xvcmVkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHV0aWxzLmVhY2gocm9vdC5nZXROb2Rlc0J5VGFnTmFtZSgncCcpLCBmdW5jdGlvbiAocCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHN0eWxlcyA9IHAuZ2V0QXR0cignZGF0YS1iYWNrZ3JvdW5kJyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3R5bGVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaXNTZXRDb2xvcmVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBzZXRCYWNrZ3JvdW5kKHN0cmluZ1RvT2JqKHN0eWxlcykpO1xyXG4gICAgICAgICAgICAgICAgICAgIHAucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChwKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9LFxyXG4gICAgICAgIG91dHB1dFJ1bGU6IGZ1bmN0aW9uIChyb290KSB7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgICAgICAgICBzdHlsZXMgPSAodXRpbHMuY3NzUnVsZShjc3NSdWxlSWQsIG1lLmRvY3VtZW50KSB8fCAnJykucmVwbGFjZSgvW1xcblxccl0rL2csICcnKS5tYXRjaChyZWcpO1xyXG4gICAgICAgICAgICBpZiAoc3R5bGVzKSB7XHJcbiAgICAgICAgICAgICAgICByb290LmFwcGVuZENoaWxkKFVFLnVOb2RlLmNyZWF0ZUVsZW1lbnQoJzxwIHN0eWxlPVwiZGlzcGxheTpub25lO1wiIGRhdGEtYmFja2dyb3VuZD1cIicgKyB1dGlscy50cmltKHN0eWxlc1sxXS5yZXBsYWNlKC9cIi9nLCAnJykucmVwbGFjZSgvW1xcc10rL2csICcgJykpICsgJ1wiPjxici8+PC9wPicpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY29tbWFuZHM6IHtcclxuICAgICAgICAgICAgJ2JhY2tncm91bmQnOiB7XHJcbiAgICAgICAgICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKGNtZCwgb2JqKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0QmFja2dyb3VuZChvYmopO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHF1ZXJ5Q29tbWFuZFZhbHVlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGVzID0gKHV0aWxzLmNzc1J1bGUoY3NzUnVsZUlkLCBtZS5kb2N1bWVudCkgfHwgJycpLnJlcGxhY2UoL1tcXG5cXHJdKy9nLCAnJykubWF0Y2gocmVnKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3R5bGVzID8gc3RyaW5nVG9PYmooc3R5bGVzWzFdKSA6IG51bGw7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgbm90TmVlZFVuZG86IHRydWVcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufSk7XG5cbi8vIHBsdWdpbnMvaW1hZ2UuanNcbi8qKlxuICog5Zu+54mH5o+S5YWl44CB5o6S54mI5o+S5Lu2XG4gKiBAZmlsZVxuICogQHNpbmNlIDEuMi42LjFcbiAqL1xuXG4vKipcbiAqIOWbvueJh+Wvuem9kOaWueW8j1xuICogQGNvbW1hbmQgaW1hZ2VmbG9hdFxuICogQG1ldGhvZCBleGVjQ29tbWFuZFxuICogQHJlbWluZCDlgLxjZW50ZXLkuLrni6zljaDkuIDooYzlsYXkuK1cbiAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcbiAqIEBwYXJhbSB7IFN0cmluZyB9IGFsaWduIOWvuem9kOaWueW8j++8jOWPr+S8oGxlZnTjgIFyaWdodOOAgW5vbmXjgIFjZW50ZXJcbiAqIEByZW1haW5kIGNlbnRlcuihqOekuuWbvueJh+eLrOWNoOS4gOihjFxuICogQGV4YW1wbGVcbiAqIGBgYGphdmFzY3JpcHRcbiAqIGVkaXRvci5leGVjQ29tbWFuZCggJ2ltYWdlZmxvYXQnLCAnY2VudGVyJyApO1xuICogYGBgXG4gKi9cblxuLyoqXG4gKiDlpoLmnpzpgInljLrmiYDlnKjkvY3nva7mmK/lm77niYfljLrln59cbiAqIEBjb21tYW5kIGltYWdlZmxvYXRcbiAqIEBtZXRob2QgcXVlcnlDb21tYW5kVmFsdWVcbiAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcbiAqIEByZXR1cm4geyBTdHJpbmcgfSDov5Tlm57lm77niYflr7npvZDmlrnlvI9cbiAqIEBleGFtcGxlXG4gKiBgYGBqYXZhc2NyaXB0XG4gKiBlZGl0b3IucXVlcnlDb21tYW5kVmFsdWUoICdpbWFnZWZsb2F0JyApO1xuICogYGBgXG4gKi9cblxuVUUuY29tbWFuZHNbJ2ltYWdlZmxvYXQnXSA9IHtcbiAgICBleGVjQ29tbWFuZDpmdW5jdGlvbiAoY21kLCBhbGlnbikge1xuICAgICAgICB2YXIgbWUgPSB0aGlzLFxuICAgICAgICAgICAgcmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcbiAgICAgICAgaWYgKCFyYW5nZS5jb2xsYXBzZWQpIHtcbiAgICAgICAgICAgIHZhciBpbWcgPSByYW5nZS5nZXRDbG9zZWROb2RlKCk7XG4gICAgICAgICAgICBpZiAoaW1nICYmIGltZy50YWdOYW1lID09ICdJTUcnKSB7XG4gICAgICAgICAgICAgICAgc3dpdGNoIChhbGlnbikge1xuICAgICAgICAgICAgICAgICAgICBjYXNlICdsZWZ0JzpcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAncmlnaHQnOlxuICAgICAgICAgICAgICAgICAgICBjYXNlICdub25lJzpcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwTiA9IGltZy5wYXJlbnROb2RlLCB0bXBOb2RlLCBwcmUsIG5leHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoZHRkLiRpbmxpbmVbcE4udGFnTmFtZV0gfHwgcE4udGFnTmFtZSA9PSAnQScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwTiA9IHBOLnBhcmVudE5vZGU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB0bXBOb2RlID0gcE47XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodG1wTm9kZS50YWdOYW1lID09ICdQJyAmJiBkb21VdGlscy5nZXRTdHlsZSh0bXBOb2RlLCAndGV4dC1hbGlnbicpID09ICdjZW50ZXInKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb21VdGlscy5pc0JvZHkodG1wTm9kZSkgJiYgZG9tVXRpbHMuZ2V0Q2hpbGRDb3VudCh0bXBOb2RlLCBmdW5jdGlvbiAobm9kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIWRvbVV0aWxzLmlzQnIobm9kZSkgJiYgIWRvbVV0aWxzLmlzV2hpdGVzcGFjZShub2RlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSA9PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZSA9IHRtcE5vZGUucHJldmlvdXNTaWJsaW5nO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0ID0gdG1wTm9kZS5uZXh0U2libGluZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZSAmJiBuZXh0ICYmIHByZS5ub2RlVHlwZSA9PSAxICYmIG5leHQubm9kZVR5cGUgPT0gMSAmJiBwcmUudGFnTmFtZSA9PSBuZXh0LnRhZ05hbWUgJiYgZG9tVXRpbHMuaXNCbG9ja0VsbShwcmUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUuYXBwZW5kQ2hpbGQodG1wTm9kZS5maXJzdENoaWxkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChuZXh0LmZpcnN0Q2hpbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUuYXBwZW5kQ2hpbGQobmV4dC5maXJzdENoaWxkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZSh0bXBOb2RlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShuZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnNldFN0eWxlKHRtcE5vZGUsICd0ZXh0LWFsaWduJywgJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNlbGVjdE5vZGUoaW1nKS5zZWxlY3QoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnNldFN0eWxlKGltZywgJ2Zsb2F0JywgYWxpZ24gPT0gJ25vbmUnID8gJycgOiBhbGlnbik7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihhbGlnbiA9PSAnbm9uZScpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZUF0dHJpYnV0ZXMoaW1nLCdhbGlnbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnY2VudGVyJzpcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZS5xdWVyeUNvbW1hbmRWYWx1ZSgnaW1hZ2VmbG9hdCcpICE9ICdjZW50ZXInKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcE4gPSBpbWcucGFyZW50Tm9kZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5zZXRTdHlsZShpbWcsICdmbG9hdCcsICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmVBdHRyaWJ1dGVzKGltZywnYWxpZ24nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBOb2RlID0gaW1nO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChwTiAmJiBkb21VdGlscy5nZXRDaGlsZENvdW50KHBOLCBmdW5jdGlvbiAobm9kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIWRvbVV0aWxzLmlzQnIobm9kZSkgJiYgIWRvbVV0aWxzLmlzV2hpdGVzcGFjZShub2RlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSA9PSAxXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIChkdGQuJGlubGluZVtwTi50YWdOYW1lXSB8fCBwTi50YWdOYW1lID09ICdBJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wTm9kZSA9IHBOO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwTiA9IHBOLnBhcmVudE5vZGU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0QmVmb3JlKHRtcE5vZGUpLnNldEN1cnNvcihmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcE4gPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwTi5hcHBlbmRDaGlsZCh0bXBOb2RlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5zZXRTdHlsZSh0bXBOb2RlLCAnZmxvYXQnLCAnJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5leGVjQ29tbWFuZCgnaW5zZXJ0SHRtbCcsICc8cCBpZD1cIl9pbWdfcGFyZW50X3RtcFwiIHN0eWxlPVwidGV4dC1hbGlnbjpjZW50ZXJcIj4nICsgcE4uaW5uZXJIVE1MICsgJzwvcD4nKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcE5vZGUgPSBtZS5kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnX2ltZ19wYXJlbnRfdG1wJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wTm9kZS5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wTm9kZSA9IHRtcE5vZGUuZmlyc3RDaGlsZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZWxlY3ROb2RlKHRtcE5vZGUpLnNlbGVjdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8v5Y675o6J5ZCO6L655aSa5L2Z55qE5YWD57SgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCA9IHRtcE5vZGUucGFyZW50Tm9kZS5uZXh0U2libGluZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCAmJiBkb21VdGlscy5pc0VtcHR5Tm9kZShuZXh0KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUobmV4dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcbiAgICBxdWVyeUNvbW1hbmRWYWx1ZTpmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciByYW5nZSA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCksXG4gICAgICAgICAgICBzdGFydE5vZGUsIGZsb2F0U3R5bGU7XG4gICAgICAgIGlmIChyYW5nZS5jb2xsYXBzZWQpIHtcbiAgICAgICAgICAgIHJldHVybiAnbm9uZSc7XG4gICAgICAgIH1cbiAgICAgICAgc3RhcnROb2RlID0gcmFuZ2UuZ2V0Q2xvc2VkTm9kZSgpO1xuICAgICAgICBpZiAoc3RhcnROb2RlICYmIHN0YXJ0Tm9kZS5ub2RlVHlwZSA9PSAxICYmIHN0YXJ0Tm9kZS50YWdOYW1lID09ICdJTUcnKSB7XG4gICAgICAgICAgICBmbG9hdFN0eWxlID0gZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZShzdGFydE5vZGUsICdmbG9hdCcpIHx8IHN0YXJ0Tm9kZS5nZXRBdHRyaWJ1dGUoJ2FsaWduJyk7XG5cbiAgICAgICAgICAgIGlmIChmbG9hdFN0eWxlID09ICdub25lJykge1xuICAgICAgICAgICAgICAgIGZsb2F0U3R5bGUgPSBkb21VdGlscy5nZXRDb21wdXRlZFN0eWxlKHN0YXJ0Tm9kZS5wYXJlbnROb2RlLCAndGV4dC1hbGlnbicpID09ICdjZW50ZXInID8gJ2NlbnRlcicgOiBmbG9hdFN0eWxlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBsZWZ0OjEsXG4gICAgICAgICAgICAgICAgcmlnaHQ6MSxcbiAgICAgICAgICAgICAgICBjZW50ZXI6MVxuICAgICAgICAgICAgfVtmbG9hdFN0eWxlXSA/IGZsb2F0U3R5bGUgOiAnbm9uZSc7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICdub25lJztcblxuXG4gICAgfSxcbiAgICBxdWVyeUNvbW1hbmRTdGF0ZTpmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciByYW5nZSA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCksXG4gICAgICAgICAgICBzdGFydE5vZGU7XG5cbiAgICAgICAgaWYgKHJhbmdlLmNvbGxhcHNlZCkgIHJldHVybiAtMTtcblxuICAgICAgICBzdGFydE5vZGUgPSByYW5nZS5nZXRDbG9zZWROb2RlKCk7XG4gICAgICAgIGlmIChzdGFydE5vZGUgJiYgc3RhcnROb2RlLm5vZGVUeXBlID09IDEgJiYgc3RhcnROb2RlLnRhZ05hbWUgPT0gJ0lNRycpIHtcbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAtMTtcbiAgICB9XG59O1xuXG5cbi8qKlxuICog5o+S5YWl5Zu+54mHXG4gKiBAY29tbWFuZCBpbnNlcnRpbWFnZVxuICogQG1ldGhvZCBleGVjQ29tbWFuZFxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxuICogQHBhcmFtIHsgT2JqZWN0IH0gb3B0IOWxnuaAp+mUruWAvOWvue+8jOi/meS6m+WxnuaAp+mDveWwhuiiq+WkjeWItuWIsOW9k+WJjeaPkuWFpeWbvueJh1xuICogQHJlbWluZCDor6Xlkb3ku6TnrKzkuozkuKrlj4LmlbDlj6/mjqXlj5fkuIDkuKrlm77niYfphY3nva7pobnlr7nosaHnmoTmlbDnu4TvvIzlj6/ku6Xmj5LlhaXlpJrlvKDlm77niYfvvIxcbiAqIOatpOaXtuaVsOe7hOeahOavj+S4gOS4quWFg+e0oOmDveaYr+S4gOS4qk9iamVjdOexu+Wei+eahOWbvueJh+WxnuaAp+mbhuWQiOOAglxuICogQGV4YW1wbGVcbiAqIGBgYGphdmFzY3JpcHRcbiAqIGVkaXRvci5leGVjQ29tbWFuZCggJ2luc2VydGltYWdlJywge1xuICogICAgIHNyYzonYS9iL2MuanBnJyxcbiAqICAgICB3aWR0aDonMTAwJyxcbiAqICAgICBoZWlnaHQ6JzEwMCdcbiAqIH0gKTtcbiAqIGBgYFxuICogQGV4YW1wbGVcbiAqIGBgYGphdmFzY3JpcHRcbiAqIGVkaXRvci5leGVjQ29tbWFuZCggJ2luc2VydGltYWdlJywgW3tcbiAqICAgICBzcmM6J2EvYi9jLmpwZycsXG4gKiAgICAgd2lkdGg6JzEwMCcsXG4gKiAgICAgaGVpZ2h0OicxMDAnXG4gKiB9LHtcbiAqICAgICBzcmM6J2EvYi9kLmpwZycsXG4gKiAgICAgd2lkdGg6JzEwMCcsXG4gKiAgICAgaGVpZ2h0OicxMDAnXG4gKiB9XSApO1xuICogYGBgXG4gKi9cblxuVUUuY29tbWFuZHNbJ2luc2VydGltYWdlJ10gPSB7XG4gICAgZXhlY0NvbW1hbmQ6ZnVuY3Rpb24gKGNtZCwgb3B0KSB7XG5cbiAgICAgICAgb3B0ID0gdXRpbHMuaXNBcnJheShvcHQpID8gb3B0IDogW29wdF07XG4gICAgICAgIGlmICghb3B0Lmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHZhciBtZSA9IHRoaXMsXG4gICAgICAgICAgICByYW5nZSA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxuICAgICAgICAgICAgaW1nID0gcmFuZ2UuZ2V0Q2xvc2VkTm9kZSgpO1xuXG4gICAgICAgIGlmKG1lLmZpcmVFdmVudCgnYmVmb3JlaW5zZXJ0aW1hZ2UnLCBvcHQpID09PSB0cnVlKXtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIHVuaHRtbERhdGEoaW1nQ2kpIHtcblxuICAgICAgICAgICAgdXRpbHMuZWFjaCgnd2lkdGgsaGVpZ2h0LGJvcmRlcixoc3BhY2UsdnNwYWNlJy5zcGxpdCgnLCcpLCBmdW5jdGlvbiAoaXRlbSkge1xuXG4gICAgICAgICAgICAgICAgaWYgKGltZ0NpW2l0ZW1dKSB7XG4gICAgICAgICAgICAgICAgICAgIGltZ0NpW2l0ZW1dID0gcGFyc2VJbnQoaW1nQ2lbaXRlbV0sIDEwKSB8fCAwO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB1dGlscy5lYWNoKCdzcmMsX3NyYycuc3BsaXQoJywnKSwgZnVuY3Rpb24gKGl0ZW0pIHtcblxuICAgICAgICAgICAgICAgIGlmIChpbWdDaVtpdGVtXSkge1xuICAgICAgICAgICAgICAgICAgICBpbWdDaVtpdGVtXSA9IHV0aWxzLnVuaHRtbEZvclVybChpbWdDaVtpdGVtXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB1dGlscy5lYWNoKCd0aXRsZSxhbHQnLnNwbGl0KCcsJyksIGZ1bmN0aW9uIChpdGVtKSB7XG5cbiAgICAgICAgICAgICAgICBpZiAoaW1nQ2lbaXRlbV0pIHtcbiAgICAgICAgICAgICAgICAgICAgaW1nQ2lbaXRlbV0gPSB1dGlscy51bmh0bWwoaW1nQ2lbaXRlbV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGltZyAmJiAvaW1nL2kudGVzdChpbWcudGFnTmFtZSkgJiYgKGltZy5jbGFzc05hbWUgIT0gXCJlZHVpLWZha2VkLXZpZGVvXCIgfHwgaW1nLmNsYXNzTmFtZS5pbmRleE9mKFwiZWR1aS11cGxvYWQtdmlkZW9cIikhPS0xKSAmJiAhaW1nLmdldEF0dHJpYnV0ZShcIndvcmRfaW1nXCIpKSB7XG4gICAgICAgICAgICB2YXIgZmlyc3QgPSBvcHQuc2hpZnQoKTtcbiAgICAgICAgICAgIHZhciBmbG9hdFN0eWxlID0gZmlyc3RbJ2Zsb2F0U3R5bGUnXTtcbiAgICAgICAgICAgIGRlbGV0ZSBmaXJzdFsnZmxvYXRTdHlsZSddO1xuLy8vLyAgICAgICAgICAgICAgICBpbWcuc3R5bGUuYm9yZGVyID0gKGZpcnN0LmJvcmRlcnx8MCkgK1wicHggc29saWQgIzAwMFwiO1xuLy8vLyAgICAgICAgICAgICAgICBpbWcuc3R5bGUubWFyZ2luID0gKGZpcnN0Lm1hcmdpbnx8MCkgK1wicHhcIjtcbi8vICAgICAgICAgICAgICAgIGltZy5zdHlsZS5jc3NUZXh0ICs9ICc7bWFyZ2luOicgKyAoZmlyc3QubWFyZ2lufHwwKSArXCJweDtcIiArICdib3JkZXI6JyArIChmaXJzdC5ib3JkZXJ8fDApICtcInB4IHNvbGlkICMwMDBcIjtcbiAgICAgICAgICAgIGRvbVV0aWxzLnNldEF0dHJpYnV0ZXMoaW1nLCBmaXJzdCk7XG4gICAgICAgICAgICBtZS5leGVjQ29tbWFuZCgnaW1hZ2VmbG9hdCcsIGZsb2F0U3R5bGUpO1xuICAgICAgICAgICAgaWYgKG9wdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnRBZnRlcihpbWcpLnNldEN1cnNvcihmYWxzZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgbWUuZXhlY0NvbW1hbmQoJ2luc2VydGltYWdlJywgb3B0KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIGh0bWwgPSBbXSwgc3RyID0gJycsIGNpO1xuICAgICAgICAgICAgY2kgPSBvcHRbMF07XG4gICAgICAgICAgICBpZiAob3B0Lmxlbmd0aCA9PSAxKSB7XG4gICAgICAgICAgICAgICAgdW5odG1sRGF0YShjaSk7XG5cbiAgICAgICAgICAgICAgICBzdHIgPSAnPGltZyBzcmM9XCInICsgY2kuc3JjICsgJ1wiICcgKyAoY2kuX3NyYyA/ICcgX3NyYz1cIicgKyBjaS5fc3JjICsgJ1wiICcgOiAnJykgK1xuICAgICAgICAgICAgICAgICAgICAoY2kud2lkdGggPyAnd2lkdGg9XCInICsgY2kud2lkdGggKyAnXCIgJyA6ICcnKSArXG4gICAgICAgICAgICAgICAgICAgIChjaS5oZWlnaHQgPyAnIGhlaWdodD1cIicgKyBjaS5oZWlnaHQgKyAnXCIgJyA6ICcnKSArXG4gICAgICAgICAgICAgICAgICAgIChjaVsnZmxvYXRTdHlsZSddID09ICdsZWZ0JyB8fCBjaVsnZmxvYXRTdHlsZSddID09ICdyaWdodCcgPyAnIHN0eWxlPVwiZmxvYXQ6JyArIGNpWydmbG9hdFN0eWxlJ10gKyAnO1wiJyA6ICcnKSArXG4gICAgICAgICAgICAgICAgICAgIChjaS50aXRsZSAmJiBjaS50aXRsZSAhPSBcIlwiID8gJyB0aXRsZT1cIicgKyBjaS50aXRsZSArICdcIicgOiAnJykgK1xuICAgICAgICAgICAgICAgICAgICAoY2kuYm9yZGVyICYmIGNpLmJvcmRlciAhPSBcIjBcIiA/ICcgYm9yZGVyPVwiJyArIGNpLmJvcmRlciArICdcIicgOiAnJykgK1xuICAgICAgICAgICAgICAgICAgICAoY2kuYWx0ICYmIGNpLmFsdCAhPSBcIlwiID8gJyBhbHQ9XCInICsgY2kuYWx0ICsgJ1wiJyA6ICcnKSArXG4gICAgICAgICAgICAgICAgICAgIChjaS5oc3BhY2UgJiYgY2kuaHNwYWNlICE9IFwiMFwiID8gJyBoc3BhY2UgPSBcIicgKyBjaS5oc3BhY2UgKyAnXCInIDogJycpICtcbiAgICAgICAgICAgICAgICAgICAgKGNpLnZzcGFjZSAmJiBjaS52c3BhY2UgIT0gXCIwXCIgPyAnIHZzcGFjZSA9IFwiJyArIGNpLnZzcGFjZSArICdcIicgOiAnJykgKyAnLz4nO1xuICAgICAgICAgICAgICAgIGlmIChjaVsnZmxvYXRTdHlsZSddID09ICdjZW50ZXInKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0ciA9ICc8cCBzdHlsZT1cInRleHQtYWxpZ246IGNlbnRlclwiPicgKyBzdHIgKyAnPC9wPic7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGh0bWwucHVzaChzdHIpO1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBjaSA9IG9wdFtpKytdOykge1xuICAgICAgICAgICAgICAgICAgICB1bmh0bWxEYXRhKGNpKTtcbiAgICAgICAgICAgICAgICAgICAgc3RyID0gJzxwICcgKyAoY2lbJ2Zsb2F0U3R5bGUnXSA9PSAnY2VudGVyJyA/ICdzdHlsZT1cInRleHQtYWxpZ246IGNlbnRlclwiICcgOiAnJykgKyAnPjxpbWcgc3JjPVwiJyArIGNpLnNyYyArICdcIiAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgIChjaS53aWR0aCA/ICd3aWR0aD1cIicgKyBjaS53aWR0aCArICdcIiAnIDogJycpICsgKGNpLl9zcmMgPyAnIF9zcmM9XCInICsgY2kuX3NyYyArICdcIiAnIDogJycpICtcbiAgICAgICAgICAgICAgICAgICAgICAgIChjaS5oZWlnaHQgPyAnIGhlaWdodD1cIicgKyBjaS5oZWlnaHQgKyAnXCIgJyA6ICcnKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAnIHN0eWxlPVwiJyArIChjaVsnZmxvYXRTdHlsZSddICYmIGNpWydmbG9hdFN0eWxlJ10gIT0gJ2NlbnRlcicgPyAnZmxvYXQ6JyArIGNpWydmbG9hdFN0eWxlJ10gKyAnOycgOiAnJykgK1xuICAgICAgICAgICAgICAgICAgICAgICAgKGNpLmJvcmRlciB8fCAnJykgKyAnXCIgJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAoY2kudGl0bGUgPyAnIHRpdGxlPVwiJyArIGNpLnRpdGxlICsgJ1wiJyA6ICcnKSArICcgLz48L3A+JztcbiAgICAgICAgICAgICAgICAgICAgaHRtbC5wdXNoKHN0cik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBtZS5leGVjQ29tbWFuZCgnaW5zZXJ0SHRtbCcsIGh0bWwuam9pbignJykpO1xuICAgICAgICB9XG5cbiAgICAgICAgbWUuZmlyZUV2ZW50KCdhZnRlcmluc2VydGltYWdlJywgb3B0KVxuICAgIH1cbn07XG5cblxuLy8gcGx1Z2lucy9qdXN0aWZ5LmpzXG4vKipcclxuICog5q616JC95qC85byPXHJcbiAqIEBmaWxlXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIOauteiQveWvuem9kOaWueW8j1xyXG4gKiBAY29tbWFuZCBqdXN0aWZ5XHJcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBhbGlnbiDlr7npvZDmlrnlvI/vvJpsZWZ0ID0+IOWxheW3pu+8jHJpZ2h0ID0+IOWxheWPs++8jGNlbnRlciA9PiDlsYXkuK3vvIxqdXN0aWZ5ID0+IOS4pOerr+Wvuem9kFxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGBqYXZhc2NyaXB0XHJcbiAqIGVkaXRvci5leGVjQ29tbWFuZCggJ2p1c3RpZnknLCAnY2VudGVyJyApO1xyXG4gKiBgYGBcclxuICovXHJcbi8qKlxyXG4gKiDlpoLmnpzpgInljLrmiYDlnKjkvY3nva7mmK/mrrXokL3ljLrln5/vvIzov5Tlm57lvZPliY3mrrXokL3lr7npvZDmlrnlvI9cclxuICogQGNvbW1hbmQganVzdGlmeVxyXG4gKiBAbWV0aG9kIHF1ZXJ5Q29tbWFuZFZhbHVlXHJcbiAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcclxuICogQHJldHVybiB7IFN0cmluZyB9IOi/lOWbnuauteiQveWvuem9kOaWueW8j1xyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGBqYXZhc2NyaXB0XHJcbiAqIGVkaXRvci5xdWVyeUNvbW1hbmRWYWx1ZSggJ2p1c3RpZnknICk7XHJcbiAqIGBgYFxyXG4gKi9cclxuXHJcblVFLnBsdWdpbnNbJ2p1c3RpZnknXT1mdW5jdGlvbigpe1xyXG4gICAgdmFyIG1lPXRoaXMsXHJcbiAgICAgICAgYmxvY2sgPSBkb21VdGlscy5pc0Jsb2NrRWxtLFxyXG4gICAgICAgIGRlZmF1bHRWYWx1ZSA9IHtcclxuICAgICAgICAgICAgbGVmdDoxLFxyXG4gICAgICAgICAgICByaWdodDoxLFxyXG4gICAgICAgICAgICBjZW50ZXI6MSxcclxuICAgICAgICAgICAganVzdGlmeToxXHJcbiAgICAgICAgfSxcclxuICAgICAgICBkb0p1c3RpZnkgPSBmdW5jdGlvbiAocmFuZ2UsIHN0eWxlKSB7XHJcbiAgICAgICAgICAgIHZhciBib29rbWFyayA9IHJhbmdlLmNyZWF0ZUJvb2ttYXJrKCksXHJcbiAgICAgICAgICAgICAgICBmaWx0ZXJGbiA9IGZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT0gMSA/IG5vZGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpICE9ICdicicgJiYgIWRvbVV0aWxzLmlzQm9va21hcmtOb2RlKG5vZGUpIDogIWRvbVV0aWxzLmlzV2hpdGVzcGFjZShub2RlKTtcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICByYW5nZS5lbmxhcmdlKHRydWUpO1xyXG4gICAgICAgICAgICB2YXIgYm9va21hcmsyID0gcmFuZ2UuY3JlYXRlQm9va21hcmsoKSxcclxuICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBkb21VdGlscy5nZXROZXh0RG9tTm9kZShib29rbWFyazIuc3RhcnQsIGZhbHNlLCBmaWx0ZXJGbiksXHJcbiAgICAgICAgICAgICAgICB0bXBSYW5nZSA9IHJhbmdlLmNsb25lUmFuZ2UoKSxcclxuICAgICAgICAgICAgICAgIHRtcE5vZGU7XHJcbiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50ICYmICEoZG9tVXRpbHMuZ2V0UG9zaXRpb24oY3VycmVudCwgYm9va21hcmsyLmVuZCkgJiBkb21VdGlscy5QT1NJVElPTl9GT0xMT1dJTkcpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY3VycmVudC5ub2RlVHlwZSA9PSAzIHx8ICFibG9jayhjdXJyZW50KSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRtcFJhbmdlLnNldFN0YXJ0QmVmb3JlKGN1cnJlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHdoaWxlIChjdXJyZW50ICYmIGN1cnJlbnQgIT09IGJvb2ttYXJrMi5lbmQgJiYgIWJsb2NrKGN1cnJlbnQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRtcE5vZGUgPSBjdXJyZW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoY3VycmVudCwgZmFsc2UsIG51bGwsIGZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIWJsb2NrKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdG1wUmFuZ2Uuc2V0RW5kQWZ0ZXIodG1wTm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbW1vbiA9IHRtcFJhbmdlLmdldENvbW1vbkFuY2VzdG9yKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFkb21VdGlscy5pc0JvZHkoY29tbW9uKSAmJiBibG9jayhjb21tb24pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnNldFN0eWxlcyhjb21tb24sIHV0aWxzLmlzU3RyaW5nKHN0eWxlKSA/IHsndGV4dC1hbGlnbic6c3R5bGV9IDogc3R5bGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gY29tbW9uO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwID0gcmFuZ2UuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5zZXRTdHlsZXMocCwgdXRpbHMuaXNTdHJpbmcoc3R5bGUpID8geyd0ZXh0LWFsaWduJzpzdHlsZX0gOiBzdHlsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmcmFnID0gdG1wUmFuZ2UuZXh0cmFjdENvbnRlbnRzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuYXBwZW5kQ2hpbGQoZnJhZyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRtcFJhbmdlLmluc2VydE5vZGUocCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBwO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoY3VycmVudCwgZmFsc2UsIGZpbHRlckZuKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGRvbVV0aWxzLmdldE5leHREb21Ob2RlKGN1cnJlbnQsIHRydWUsIGZpbHRlckZuKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gcmFuZ2UubW92ZVRvQm9va21hcmsoYm9va21hcmsyKS5tb3ZlVG9Cb29rbWFyayhib29rbWFyayk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICBVRS5jb21tYW5kc1snanVzdGlmeSddID0ge1xyXG4gICAgICAgIGV4ZWNDb21tYW5kOmZ1bmN0aW9uIChjbWROYW1lLCBhbGlnbikge1xyXG4gICAgICAgICAgICB2YXIgcmFuZ2UgPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxyXG4gICAgICAgICAgICAgICAgdHh0O1xyXG5cclxuICAgICAgICAgICAgLy/pl63lkIjml7bljZXni6zlpITnkIZcclxuICAgICAgICAgICAgaWYgKHJhbmdlLmNvbGxhcHNlZCkge1xyXG4gICAgICAgICAgICAgICAgdHh0ID0gdGhpcy5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgncCcpO1xyXG4gICAgICAgICAgICAgICAgcmFuZ2UuaW5zZXJ0Tm9kZSh0eHQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRvSnVzdGlmeShyYW5nZSwgYWxpZ24pO1xyXG4gICAgICAgICAgICBpZiAodHh0KSB7XHJcbiAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydEJlZm9yZSh0eHQpLmNvbGxhcHNlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHR4dCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJhbmdlLnNlbGVjdCgpO1xyXG5cclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcXVlcnlDb21tYW5kVmFsdWU6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgc3RhcnROb2RlID0gdGhpcy5zZWxlY3Rpb24uZ2V0U3RhcnQoKSxcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZShzdGFydE5vZGUsICd0ZXh0LWFsaWduJyk7XHJcbiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWVbdmFsdWVdID8gdmFsdWUgOiAnbGVmdCc7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZTpmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuc2VsZWN0aW9uLmdldFN0YXJ0KCksXHJcbiAgICAgICAgICAgICAgICBjZWxsID0gc3RhcnQgJiYgZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShzdGFydCwgW1widGRcIiwgXCJ0aFwiLFwiY2FwdGlvblwiXSwgdHJ1ZSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gY2VsbD8gLTE6MDtcclxuICAgICAgICB9XHJcblxyXG4gICAgfTtcclxufTtcclxuXG5cbi8vIHBsdWdpbnMvZm9udC5qc1xuLyoqXHJcbiAqIOWtl+S9k+minOiJsizog4zmma/oibIs5a2X5Y+3LOWtl+S9kyzkuIvliJLnur8s5Yig6Zmk57q/XHJcbiAqIEBmaWxlXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIOWtl+S9k+minOiJslxyXG4gKiBAY29tbWFuZCBmb3JlY29sb3JcclxuICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEBwYXJhbSB7IFN0cmluZyB9IHZhbHVlIOiJsuWAvCjlv4XpobvljYHlha3ov5vliLYpXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnZm9yZWNvbG9yJywgJyMwMDAnICk7XHJcbiAqIGBgYFxyXG4gKi9cclxuLyoqXHJcbiAqIOi/lOWbnumAieWMuuWtl+S9k+minOiJslxyXG4gKiBAY29tbWFuZCBmb3JlY29sb3JcclxuICogQG1ldGhvZCBxdWVyeUNvbW1hbmRWYWx1ZVxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEByZXR1cm4geyBTdHJpbmcgfSDov5Tlm57lrZfkvZPpopzoibJcclxuICogQGV4YW1wbGVcclxuICogYGBgamF2YXNjcmlwdFxyXG4gKiBlZGl0b3IucXVlcnlDb21tYW5kVmFsdWUoICdmb3JlY29sb3InICk7XHJcbiAqIGBgYFxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiDlrZfkvZPog4zmma/popzoibJcclxuICogQGNvbW1hbmQgYmFja2NvbG9yXHJcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSB2YWx1ZSDoibLlgLwo5b+F6aG75Y2B5YWt6L+b5Yi2KVxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGBqYXZhc2NyaXB0XHJcbiAqIGVkaXRvci5leGVjQ29tbWFuZCggJ2JhY2tjb2xvcicsICcjMDAwJyApO1xyXG4gKiBgYGBcclxuICovXHJcbi8qKlxyXG4gKiDov5Tlm57pgInljLrlrZfkvZPpopzoibJcclxuICogQGNvbW1hbmQgYmFja2NvbG9yXHJcbiAqIEBtZXRob2QgcXVlcnlDb21tYW5kVmFsdWVcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAcmV0dXJuIHsgU3RyaW5nIH0g6L+U5Zue5a2X5L2T6IOM5pmv6aKc6ImyXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogZWRpdG9yLnF1ZXJ5Q29tbWFuZFZhbHVlKCAnYmFja2NvbG9yJyApO1xyXG4gKiBgYGBcclxuICovXHJcblxyXG4vKipcclxuICog5a2X5L2T5aSn5bCPXHJcbiAqIEBjb21tYW5kIGZvbnRzaXplXHJcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSB2YWx1ZSDlrZfkvZPlpKflsI9cclxuICogQGV4YW1wbGVcclxuICogYGBgamF2YXNjcmlwdFxyXG4gKiBlZGl0b3IuZXhlY0NvbW1hbmQoICdmb250c2l6ZScsICcxNHB4JyApO1xyXG4gKiBgYGBcclxuICovXHJcbi8qKlxyXG4gKiDov5Tlm57pgInljLrlrZfkvZPlpKflsI9cclxuICogQGNvbW1hbmQgZm9udHNpemVcclxuICogQG1ldGhvZCBxdWVyeUNvbW1hbmRWYWx1ZVxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEByZXR1cm4geyBTdHJpbmcgfSDov5Tlm57lrZfkvZPlpKflsI9cclxuICogQGV4YW1wbGVcclxuICogYGBgamF2YXNjcmlwdFxyXG4gKiBlZGl0b3IucXVlcnlDb21tYW5kVmFsdWUoICdmb250c2l6ZScgKTtcclxuICogYGBgXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIOWtl+S9k+agt+W8j1xyXG4gKiBAY29tbWFuZCBmb250ZmFtaWx5XHJcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSB2YWx1ZSDlrZfkvZPmoLflvI9cclxuICogQGV4YW1wbGVcclxuICogYGBgamF2YXNjcmlwdFxyXG4gKiBlZGl0b3IuZXhlY0NvbW1hbmQoICdmb250ZmFtaWx5JywgJ+W+rui9r+mbhem7kScgKTtcclxuICogYGBgXHJcbiAqL1xyXG4vKipcclxuICog6L+U5Zue6YCJ5Yy65a2X5L2T5qC35byPXHJcbiAqIEBjb21tYW5kIGZvbnRmYW1pbHlcclxuICogQG1ldGhvZCBxdWVyeUNvbW1hbmRWYWx1ZVxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEByZXR1cm4geyBTdHJpbmcgfSDov5Tlm57lrZfkvZPmoLflvI9cclxuICogQGV4YW1wbGVcclxuICogYGBgamF2YXNjcmlwdFxyXG4gKiBlZGl0b3IucXVlcnlDb21tYW5kVmFsdWUoICdmb250ZmFtaWx5JyApO1xyXG4gKiBgYGBcclxuICovXHJcblxyXG4vKipcclxuICog5a2X5L2T5LiL5YiS57q/LOS4juWIoOmZpOe6v+S6kuaWpVxyXG4gKiBAY29tbWFuZCB1bmRlcmxpbmVcclxuICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogZWRpdG9yLmV4ZWNDb21tYW5kKCAndW5kZXJsaW5lJyApO1xyXG4gKiBgYGBcclxuICovXHJcblxyXG4vKipcclxuICog5a2X5L2T5Yig6Zmk57q/LOS4juS4i+WIkue6v+S6kuaWpVxyXG4gKiBAY29tbWFuZCBzdHJpa2V0aHJvdWdoXHJcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGBqYXZhc2NyaXB0XHJcbiAqIGVkaXRvci5leGVjQ29tbWFuZCggJ3N0cmlrZXRocm91Z2gnICk7XHJcbiAqIGBgYFxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiDlrZfkvZPovrnmoYZcclxuICogQGNvbW1hbmQgZm9udGJvcmRlclxyXG4gKiBAbWV0aG9kIGV4ZWNDb21tYW5kXHJcbiAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcclxuICogQGV4YW1wbGVcclxuICogYGBgamF2YXNjcmlwdFxyXG4gKiBlZGl0b3IuZXhlY0NvbW1hbmQoICdmb250Ym9yZGVyJyApO1xyXG4gKiBgYGBcclxuICovXHJcblxyXG5VRS5wbHVnaW5zWydmb250J10gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgbWUgPSB0aGlzLFxyXG4gICAgICAgIGZvbnRzID0ge1xyXG4gICAgICAgICAgICAnZm9yZWNvbG9yJzogJ2NvbG9yJyxcclxuICAgICAgICAgICAgJ2JhY2tjb2xvcic6ICdiYWNrZ3JvdW5kLWNvbG9yJyxcclxuICAgICAgICAgICAgJ2ZvbnRzaXplJzogJ2ZvbnQtc2l6ZScsXHJcbiAgICAgICAgICAgICdmb250ZmFtaWx5JzogJ2ZvbnQtZmFtaWx5JyxcclxuICAgICAgICAgICAgJ3VuZGVybGluZSc6ICd0ZXh0LWRlY29yYXRpb24nLFxyXG4gICAgICAgICAgICAnc3RyaWtldGhyb3VnaCc6ICd0ZXh0LWRlY29yYXRpb24nLFxyXG4gICAgICAgICAgICAnZm9udGJvcmRlcic6ICdib3JkZXInXHJcbiAgICAgICAgfSxcclxuICAgICAgICBuZWVkQ21kID0geyd1bmRlcmxpbmUnOiAxLCAnc3RyaWtldGhyb3VnaCc6IDEsICdmb250Ym9yZGVyJzogMX0sXHJcbiAgICAgICAgbmVlZFNldENoaWxkID0ge1xyXG4gICAgICAgICAgICAnZm9yZWNvbG9yJzogJ2NvbG9yJyxcclxuICAgICAgICAgICAgJ2JhY2tjb2xvcic6ICdiYWNrZ3JvdW5kLWNvbG9yJyxcclxuICAgICAgICAgICAgJ2ZvbnRzaXplJzogJ2ZvbnQtc2l6ZScsXHJcbiAgICAgICAgICAgICdmb250ZmFtaWx5JzogJ2ZvbnQtZmFtaWx5J1xyXG5cclxuICAgICAgICB9O1xyXG4gICAgbWUuc2V0T3B0KHtcclxuICAgICAgICAnZm9udGZhbWlseSc6IFtcclxuICAgICAgICAgICAgeyBuYW1lOiAnc29uZ3RpJywgdmFsOiAn5a6L5L2TLFNpbVN1bid9LFxyXG4gICAgICAgICAgICB7IG5hbWU6ICd5YWhlaScsIHZhbDogJ+W+rui9r+mbhem7kSxNaWNyb3NvZnQgWWFIZWknfSxcclxuICAgICAgICAgICAgeyBuYW1lOiAna2FpdGknLCB2YWw6ICfmpbfkvZMs5qW35L2TX0dCMjMxMiwgU2ltS2FpJ30sXHJcbiAgICAgICAgICAgIHsgbmFtZTogJ2hlaXRpJywgdmFsOiAn6buR5L2TLCBTaW1IZWknfSxcclxuICAgICAgICAgICAgeyBuYW1lOiAnbGlzaHUnLCB2YWw6ICfpmrbkuaYsIFNpbUxpJ30sXHJcbiAgICAgICAgICAgIHsgbmFtZTogJ2FuZGFsZU1vbm8nLCB2YWw6ICdhbmRhbGUgbW9ubyd9LFxyXG4gICAgICAgICAgICB7IG5hbWU6ICdhcmlhbCcsIHZhbDogJ2FyaWFsLCBoZWx2ZXRpY2Esc2Fucy1zZXJpZid9LFxyXG4gICAgICAgICAgICB7IG5hbWU6ICdhcmlhbEJsYWNrJywgdmFsOiAnYXJpYWwgYmxhY2ssYXZhbnQgZ2FyZGUnfSxcclxuICAgICAgICAgICAgeyBuYW1lOiAnY29taWNTYW5zTXMnLCB2YWw6ICdjb21pYyBzYW5zIG1zJ30sXHJcbiAgICAgICAgICAgIHsgbmFtZTogJ2ltcGFjdCcsIHZhbDogJ2ltcGFjdCxjaGljYWdvJ30sXHJcbiAgICAgICAgICAgIHsgbmFtZTogJ3RpbWVzTmV3Um9tYW4nLCB2YWw6ICd0aW1lcyBuZXcgcm9tYW4nfVxyXG4gICAgICAgIF0sXHJcbiAgICAgICAgJ2ZvbnRzaXplJzogWzEwLCAxMSwgMTIsIDE0LCAxNiwgMTgsIDIwLCAyNCwgMzZdXHJcbiAgICB9KTtcclxuXHJcbiAgICBmdW5jdGlvbiBtZXJnZVdpdGhQYXJlbnQobm9kZSl7XHJcbiAgICAgICAgdmFyIHBhcmVudDtcclxuICAgICAgICB3aGlsZShwYXJlbnQgPSBub2RlLnBhcmVudE5vZGUpe1xyXG4gICAgICAgICAgICBpZihwYXJlbnQudGFnTmFtZSA9PSAnU1BBTicgJiYgZG9tVXRpbHMuZ2V0Q2hpbGRDb3VudChwYXJlbnQsZnVuY3Rpb24oY2hpbGQpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICFkb21VdGlscy5pc0Jvb2ttYXJrTm9kZShjaGlsZCkgJiYgIWRvbVV0aWxzLmlzQnIoY2hpbGQpXHJcbiAgICAgICAgICAgIH0pID09IDEpIHtcclxuICAgICAgICAgICAgICAgIHBhcmVudC5zdHlsZS5jc3NUZXh0ICs9IG5vZGUuc3R5bGUuY3NzVGV4dDtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShub2RlLHRydWUpO1xyXG4gICAgICAgICAgICAgICAgbm9kZSA9IHBhcmVudDtcclxuXHJcbiAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gbWVyZ2VDaGlsZChybmcsY21kTmFtZSx2YWx1ZSl7XHJcbiAgICAgICAgaWYobmVlZFNldENoaWxkW2NtZE5hbWVdKXtcclxuICAgICAgICAgICAgcm5nLmFkanVzdG1lbnRCb3VuZGFyeSgpO1xyXG4gICAgICAgICAgICBpZighcm5nLmNvbGxhcHNlZCAmJiBybmcuc3RhcnRDb250YWluZXIubm9kZVR5cGUgPT0gMSl7XHJcbiAgICAgICAgICAgICAgICB2YXIgc3RhcnQgPSBybmcuc3RhcnRDb250YWluZXIuY2hpbGROb2Rlc1tybmcuc3RhcnRPZmZzZXRdO1xyXG4gICAgICAgICAgICAgICAgaWYoc3RhcnQgJiYgZG9tVXRpbHMuaXNUYWdOb2RlKHN0YXJ0LCdzcGFuJykpe1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBiayA9IHJuZy5jcmVhdGVCb29rbWFyaygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHV0aWxzLmVhY2goZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoc3RhcnQsICdzcGFuJyksIGZ1bmN0aW9uIChzcGFuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3Bhbi5wYXJlbnROb2RlIHx8IGRvbVV0aWxzLmlzQm9va21hcmtOb2RlKHNwYW4pKXJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoY21kTmFtZSA9PSAnYmFja2NvbG9yJyAmJiBkb21VdGlscy5nZXRDb21wdXRlZFN0eWxlKHNwYW4sJ2JhY2tncm91bmQtY29sb3InKS50b0xvd2VyQ2FzZSgpID09PSB2YWx1ZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlU3R5bGUoc3BhbixuZWVkU2V0Q2hpbGRbY21kTmFtZV0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihzcGFuLnN0eWxlLmNzc1RleHQucmVwbGFjZSgvXlxccyskLywnJykubGVuZ3RoID09IDApe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHNwYW4sdHJ1ZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHJuZy5tb3ZlVG9Cb29rbWFyayhiaylcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiBtZXJnZXNpYmxpbmcocm5nLGNtZE5hbWUsdmFsdWUpIHtcclxuICAgICAgICB2YXIgY29sbGFwc2VkID0gcm5nLmNvbGxhcHNlZCxcclxuICAgICAgICAgICAgYmsgPSBybmcuY3JlYXRlQm9va21hcmsoKSwgY29tbW9uO1xyXG4gICAgICAgIGlmIChjb2xsYXBzZWQpIHtcclxuICAgICAgICAgICAgY29tbW9uID0gYmsuc3RhcnQucGFyZW50Tm9kZTtcclxuICAgICAgICAgICAgd2hpbGUgKGR0ZC4kaW5saW5lW2NvbW1vbi50YWdOYW1lXSkge1xyXG4gICAgICAgICAgICAgICAgY29tbW9uID0gY29tbW9uLnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb21tb24gPSBkb21VdGlscy5nZXRDb21tb25BbmNlc3Rvcihiay5zdGFydCwgYmsuZW5kKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdXRpbHMuZWFjaChkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZShjb21tb24sICdzcGFuJyksIGZ1bmN0aW9uIChzcGFuKSB7XHJcbiAgICAgICAgICAgIGlmICghc3Bhbi5wYXJlbnROb2RlIHx8IGRvbVV0aWxzLmlzQm9va21hcmtOb2RlKHNwYW4pKXJldHVybjtcclxuICAgICAgICAgICAgaWYgKC9cXHMqYm9yZGVyXFxzKjpcXHMqbm9uZTs/XFxzKi9pLnRlc3Qoc3Bhbi5zdHlsZS5jc3NUZXh0KSkge1xyXG4gICAgICAgICAgICAgICAgaWYoL15cXHMqYm9yZGVyXFxzKjpcXHMqbm9uZTs/XFxzKiQvLnRlc3Qoc3Bhbi5zdHlsZS5jc3NUZXh0KSl7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHNwYW4sIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlU3R5bGUoc3BhbiwnYm9yZGVyJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoL2JvcmRlci9pLnRlc3Qoc3Bhbi5zdHlsZS5jc3NUZXh0KSAmJiBzcGFuLnBhcmVudE5vZGUudGFnTmFtZSA9PSAnU1BBTicgJiYgL2JvcmRlci9pLnRlc3Qoc3Bhbi5wYXJlbnROb2RlLnN0eWxlLmNzc1RleHQpKSB7XHJcbiAgICAgICAgICAgICAgICBzcGFuLnN0eWxlLmNzc1RleHQgPSBzcGFuLnN0eWxlLmNzc1RleHQucmVwbGFjZSgvYm9yZGVyW146XSo6W147XSs7Py9naSwgJycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKCEoY21kTmFtZT09J2ZvbnRib3JkZXInICYmIHZhbHVlPT0nbm9uZScpKXtcclxuICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gc3Bhbi5uZXh0U2libGluZztcclxuICAgICAgICAgICAgICAgIHdoaWxlIChuZXh0ICYmIG5leHQubm9kZVR5cGUgPT0gMSAmJiBuZXh0LnRhZ05hbWUgPT0gJ1NQQU4nICkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGRvbVV0aWxzLmlzQm9va21hcmtOb2RlKG5leHQpICYmIGNtZE5hbWUgPT0gJ2ZvbnRib3JkZXInKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQobmV4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5leHQgPSBzcGFuLm5leHRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5leHQuc3R5bGUuY3NzVGV4dCA9PSBzcGFuLnN0eWxlLmNzc1RleHQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMubW92ZUNoaWxkKG5leHQsIHNwYW4pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUobmV4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzcGFuLm5leHRTaWJsaW5nID09PSBuZXh0KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBuZXh0ID0gc3Bhbi5uZXh0U2libGluZztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgIG1lcmdlV2l0aFBhcmVudChzcGFuKTtcclxuICAgICAgICAgICAgaWYoYnJvd3Nlci5pZSAmJiBicm93c2VyLnZlcnNpb24gPiA4ICl7XHJcbiAgICAgICAgICAgICAgICAvL+aLt+i0neeItuS6suS7rOeahOeJueWIq+eahOWxnuaApyzov5nph4zlj6rlgZrog4zmma/popzoibLnmoTlpITnkIZcclxuICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBkb21VdGlscy5maW5kUGFyZW50KHNwYW4sZnVuY3Rpb24obil7cmV0dXJuIG4udGFnTmFtZSA9PSAnU1BBTicgJiYgL2JhY2tncm91bmQtY29sb3IvLnRlc3Qobi5zdHlsZS5jc3NUZXh0KX0pO1xyXG4gICAgICAgICAgICAgICAgaWYocGFyZW50ICYmICEvYmFja2dyb3VuZC1jb2xvci8udGVzdChzcGFuLnN0eWxlLmNzc1RleHQpKXtcclxuICAgICAgICAgICAgICAgICAgICBzcGFuLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IHBhcmVudC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3I7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcm5nLm1vdmVUb0Jvb2ttYXJrKGJrKTtcclxuICAgICAgICBtZXJnZUNoaWxkKHJuZyxjbWROYW1lLHZhbHVlKVxyXG4gICAgfVxyXG5cclxuICAgIG1lLmFkZElucHV0UnVsZShmdW5jdGlvbiAocm9vdCkge1xyXG4gICAgICAgIHV0aWxzLmVhY2gocm9vdC5nZXROb2Rlc0J5VGFnTmFtZSgndSBzIGRlbCBmb250IHN0cmlrZScpLCBmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICBpZiAobm9kZS50YWdOYW1lID09ICdmb250Jykge1xyXG4gICAgICAgICAgICAgICAgdmFyIGNzc1N0eWxlID0gW107XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBwIGluIG5vZGUuYXR0cnMpIHtcclxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc2l6ZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjc3NTdHlsZS5wdXNoKCdmb250LXNpemU6JyArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnMSc6JzEwJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnMic6JzEyJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnMyc6JzE2JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnNCc6JzE4JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnNSc6JzI0JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnNic6JzMyJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnNyc6JzQ4J1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVtub2RlLmF0dHJzW3BdXSB8fCBub2RlLmF0dHJzW3BdKSArICdweCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2NvbG9yJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNzc1N0eWxlLnB1c2goJ2NvbG9yOicgKyBub2RlLmF0dHJzW3BdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdmYWNlJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNzc1N0eWxlLnB1c2goJ2ZvbnQtZmFtaWx5OicgKyBub2RlLmF0dHJzW3BdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzdHlsZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjc3NTdHlsZS5wdXNoKG5vZGUuYXR0cnNbcF0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIG5vZGUuYXR0cnMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJ3N0eWxlJzogY3NzU3R5bGUuam9pbignOycpXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIHZhbCA9IG5vZGUudGFnTmFtZSA9PSAndScgPyAndW5kZXJsaW5lJyA6ICdsaW5lLXRocm91Z2gnO1xyXG4gICAgICAgICAgICAgICAgbm9kZS5hdHRycyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAnc3R5bGUnOiAobm9kZS5nZXRBdHRyKCdzdHlsZScpIHx8ICcnKSArICd0ZXh0LWRlY29yYXRpb246JyArIHZhbCArICc7J1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG5vZGUudGFnTmFtZSA9ICdzcGFuJztcclxuICAgICAgICB9KTtcclxuLy8gICAgICAgIHV0aWxzLmVhY2gocm9vdC5nZXROb2Rlc0J5VGFnTmFtZSgnc3BhbicpLCBmdW5jdGlvbiAobm9kZSkge1xyXG4vLyAgICAgICAgICAgIHZhciB2YWw7XHJcbi8vICAgICAgICAgICAgaWYodmFsID0gbm9kZS5nZXRBdHRyKCdjbGFzcycpKXtcclxuLy8gICAgICAgICAgICAgICAgaWYoL2ZvbnRzdHJpa2V0aHJvdWdoLy50ZXN0KHZhbCkpe1xyXG4vLyAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRTdHlsZSgndGV4dC1kZWNvcmF0aW9uJywnbGluZS10aHJvdWdoJyk7XHJcbi8vICAgICAgICAgICAgICAgICAgICBpZihub2RlLmF0dHJzWydjbGFzcyddKXtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBub2RlLmF0dHJzWydjbGFzcyddID0gbm9kZS5hdHRyc1snY2xhc3MnXS5yZXBsYWNlKC9mb250c3RyaWtldGhyb3VnaC8sJycpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyKCdjbGFzcycpXHJcbi8vICAgICAgICAgICAgICAgICAgICB9XHJcbi8vICAgICAgICAgICAgICAgIH1cclxuLy8gICAgICAgICAgICAgICAgaWYoL2ZvbnRib3JkZXIvLnRlc3QodmFsKSl7XHJcbi8vICAgICAgICAgICAgICAgICAgICBub2RlLnNldFN0eWxlKCdib3JkZXInLCcxcHggc29saWQgIzAwMCcpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgaWYobm9kZS5hdHRyc1snY2xhc3MnXSl7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5hdHRyc1snY2xhc3MnXSA9IG5vZGUuYXR0cnNbJ2NsYXNzJ10ucmVwbGFjZSgvZm9udGJvcmRlci8sJycpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyKCdjbGFzcycpXHJcbi8vICAgICAgICAgICAgICAgICAgICB9XHJcbi8vICAgICAgICAgICAgICAgIH1cclxuLy8gICAgICAgICAgICB9XHJcbi8vICAgICAgICB9KTtcclxuICAgIH0pO1xyXG4vLyAgICBtZS5hZGRPdXRwdXRSdWxlKGZ1bmN0aW9uKHJvb3Qpe1xyXG4vLyAgICAgICAgdXRpbHMuZWFjaChyb290LmdldE5vZGVzQnlUYWdOYW1lKCdzcGFuJyksIGZ1bmN0aW9uIChub2RlKSB7XHJcbi8vICAgICAgICAgICAgdmFyIHZhbDtcclxuLy8gICAgICAgICAgICBpZih2YWwgPSBub2RlLmdldFN0eWxlKCd0ZXh0LWRlY29yYXRpb24nKSl7XHJcbi8vICAgICAgICAgICAgICAgIGlmKC9saW5lLXRocm91Z2gvLnRlc3QodmFsKSl7XHJcbi8vICAgICAgICAgICAgICAgICAgICBpZihub2RlLmF0dHJzWydjbGFzcyddKXtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBub2RlLmF0dHJzWydjbGFzcyddICs9ICcgZm9udHN0cmlrZXRocm91Z2gnO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyKCdjbGFzcycsJ2ZvbnRzdHJpa2V0aHJvdWdoJylcclxuLy8gICAgICAgICAgICAgICAgICAgIH1cclxuLy8gICAgICAgICAgICAgICAgfVxyXG4vL1xyXG4vLyAgICAgICAgICAgICAgICBub2RlLnNldFN0eWxlKCd0ZXh0LWRlY29yYXRpb24nKVxyXG4vLyAgICAgICAgICAgIH1cclxuLy8gICAgICAgICAgICBpZih2YWwgPSBub2RlLmdldFN0eWxlKCdib3JkZXInKSl7XHJcbi8vICAgICAgICAgICAgICAgIGlmKC8xcHgvLnRlc3QodmFsKSAmJiAvc29saWQvLnRlc3QodmFsKSl7XHJcbi8vICAgICAgICAgICAgICAgICAgICBpZihub2RlLmF0dHJzWydjbGFzcyddKXtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBub2RlLmF0dHJzWydjbGFzcyddICs9ICcgZm9udGJvcmRlcic7XHJcbi8vXHJcbi8vICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBub2RlLnNldEF0dHIoJ2NsYXNzJywnZm9udGJvcmRlcicpXHJcbi8vICAgICAgICAgICAgICAgICAgICB9XHJcbi8vICAgICAgICAgICAgICAgIH1cclxuLy8gICAgICAgICAgICAgICAgbm9kZS5zZXRTdHlsZSgnYm9yZGVyJylcclxuLy9cclxuLy8gICAgICAgICAgICB9XHJcbi8vICAgICAgICB9KTtcclxuLy8gICAgfSk7XHJcbiAgICBmb3IgKHZhciBwIGluIGZvbnRzKSB7XHJcbiAgICAgICAgKGZ1bmN0aW9uIChjbWQsIHN0eWxlKSB7XHJcbiAgICAgICAgICAgIFVFLmNvbW1hbmRzW2NtZF0gPSB7XHJcbiAgICAgICAgICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKGNtZE5hbWUsIHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZSB8fCAodGhpcy5xdWVyeUNvbW1hbmRTdGF0ZShjbWROYW1lKSA/ICdub25lJyA6IGNtZE5hbWUgPT0gJ3VuZGVybGluZScgPyAndW5kZXJsaW5lJyA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWUgPT0gJ2ZvbnRib3JkZXInID8gJzFweCBzb2xpZCAjMDAwJyA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGluZS10aHJvdWdoJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UgPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gJ2RlZmF1bHQnKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmFuZ2UuY29sbGFwc2VkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gbWUuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJ2ZvbnQnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLmluc2VydE5vZGUodGV4dCkuc2VsZWN0KCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKCdyZW1vdmVGb3JtYXQnLCAnc3BhbixhJywgc3R5bGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGV4dCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnRCZWZvcmUodGV4dCkuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUodGV4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VzaWJsaW5nKHJhbmdlLGNtZE5hbWUsdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZWxlY3QoKVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmFuZ2UuY29sbGFwc2VkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmVlZENtZFtjbWRdICYmIG1lLnF1ZXJ5Q29tbWFuZFZhbHVlKGNtZCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5leGVjQ29tbWFuZCgncmVtb3ZlRm9ybWF0JywgJ3NwYW4sYScsIHN0eWxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UuYXBwbHlJbmxpbmVTdHlsZSgnc3BhbicsIHsnc3R5bGUnOiBzdHlsZSArICc6JyArIHZhbHVlfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXJnZXNpYmxpbmcocmFuZ2UsIGNtZE5hbWUsdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2VsZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNwYW4gPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHJhbmdlLnN0YXJ0Q29udGFpbmVyLCAnc3BhbicsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9IG1lLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCdmb250Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BhbiAmJiAhc3Bhbi5jaGlsZHJlbi5sZW5ndGggJiYgIXNwYW5bYnJvd3Nlci5pZSA/ICdpbm5lclRleHQnIDogJ3RleHRDb250ZW50J10ucmVwbGFjZShmaWxsQ2hhclJlZywgJycpLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vZm9yIGllIGhhY2sgd2hlbiBlbnRlclxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLmluc2VydE5vZGUodGV4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5lZWRDbWRbY21kXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZWxlY3ROb2RlKHRleHQpLnNlbGVjdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5leGVjQ29tbWFuZCgncmVtb3ZlRm9ybWF0JywgJ3NwYW4sYScsIHN0eWxlLCBudWxsKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4gPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHRleHQsICdzcGFuJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0QmVmb3JlKHRleHQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BhbiAmJiAoc3Bhbi5zdHlsZS5jc3NUZXh0ICs9ICc7JyArIHN0eWxlICsgJzonICsgdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLmNvbGxhcHNlKHRydWUpLnNlbGVjdCgpO1xyXG5cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLmluc2VydE5vZGUodGV4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2VsZWN0Tm9kZSh0ZXh0KS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGFuID0gcmFuZ2UuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmVlZENtZFtjbWRdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vYeagh+etvuWGheeahOS4jeWkhOeQhui3s+i/h1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZSh0ZXh0LCAnYScsIHRydWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydEJlZm9yZSh0ZXh0KS5zZXRDdXJzb3IoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZSh0ZXh0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5leGVjQ29tbWFuZCgncmVtb3ZlRm9ybWF0JywgJ3NwYW4sYScsIHN0eWxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uc3R5bGUuY3NzVGV4dCA9IHN0eWxlICsgJzonICsgdmFsdWU7XHJcblxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0LnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHNwYW4sIHRleHQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8v5L+u5aSN77yMc3BhbuWll3NwYW4g5L2G5qC35byP5LiN57un5om/55qE6Zeu6aKYXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFicm93c2VyLmllIHx8IGJyb3dzZXIuaWUgJiYgYnJvd3Nlci52ZXJzaW9uID09IDkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNwYW5QYXJlbnQgPSBzcGFuLnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICghZG9tVXRpbHMuaXNCbG9ja0VsbShzcGFuUGFyZW50KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNwYW5QYXJlbnQudGFnTmFtZSA9PSAnU1BBTicpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL29wZXJh5ZCI5bm2c3R5bGXkuI3kvJrliqDlhaVcIjtcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uc3R5bGUuY3NzVGV4dCA9IHNwYW5QYXJlbnQuc3R5bGUuY3NzVGV4dCArIFwiO1wiICsgc3Bhbi5zdHlsZS5jc3NUZXh0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BhblBhcmVudCA9IHNwYW5QYXJlbnQucGFyZW50Tm9kZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcGVyYSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KHNwYW4sIDApLmNvbGxhcHNlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VzaWJsaW5nKHJhbmdlLCBjbWROYW1lLHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNlbGVjdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydChzcGFuLCAwKS5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2VzaWJsaW5nKHJhbmdlLGNtZE5hbWUsdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vdHJhY2U6OTgxXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9kb21VdGlscy5tZXJnZVRvUGFyZW50KHNwYW4pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUodGV4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBxdWVyeUNvbW1hbmRWYWx1ZTogZnVuY3Rpb24gKGNtZE5hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgc3RhcnROb2RlID0gdGhpcy5zZWxlY3Rpb24uZ2V0U3RhcnQoKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy90cmFjZTo5NDZcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY21kTmFtZSA9PSAndW5kZXJsaW5lJyB8fCBjbWROYW1lID09ICdzdHJpa2V0aHJvdWdoJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wTm9kZSA9IHN0YXJ0Tm9kZSwgdmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICh0bXBOb2RlICYmICFkb21VdGlscy5pc0Jsb2NrRWxtKHRtcE5vZGUpICYmICFkb21VdGlscy5pc0JvZHkodG1wTm9kZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0bXBOb2RlLm5vZGVUeXBlID09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUodG1wTm9kZSwgc3R5bGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAhPSAnbm9uZScpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBOb2RlID0gdG1wTm9kZS5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnbm9uZSc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjbWROYW1lID09ICdmb250Ym9yZGVyJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wID0gc3RhcnROb2RlLCB2YWw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICh0bXAgJiYgZHRkLiRpbmxpbmVbdG1wLnRhZ05hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsID0gZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZSh0bXAsICdib3JkZXInKSkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoLzFweC8udGVzdCh2YWwpICYmIC9zb2xpZC8udGVzdCh2YWwpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gdG1wLnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiggY21kTmFtZSA9PSAnRm9udFNpemUnICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGVWYWwgPSBkb21VdGlscy5nZXRDb21wdXRlZFN0eWxlKHN0YXJ0Tm9kZSwgc3R5bGUpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gL14oW1xcZFxcLl0rKShcXHcrKSQvLmV4ZWMoIHN0eWxlVmFsICk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiggdG1wICkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKCB0bXBbMV0gKSArIHRtcFsyXTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzdHlsZVZhbDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gIGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUoc3RhcnROb2RlLCBzdHlsZSk7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6IGZ1bmN0aW9uIChjbWROYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFuZWVkQ21kW2NtZE5hbWVdKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgdmFsID0gdGhpcy5xdWVyeUNvbW1hbmRWYWx1ZShjbWROYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY21kTmFtZSA9PSAnZm9udGJvcmRlcicpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC8xcHgvLnRlc3QodmFsKSAmJiAvc29saWQvLnRlc3QodmFsKVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAgY21kTmFtZSA9PSAndW5kZXJsaW5lJyA/IC91bmRlcmxpbmUvLnRlc3QodmFsKSA6IC9saW5lXFwtdGhyb3VnaC8udGVzdCh2YWwpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0pKHAsIGZvbnRzW3BdKTtcclxuICAgIH1cclxufTtcblxuLy8gcGx1Z2lucy9saW5rLmpzXG4vKipcclxuICog6LaF6ZO+5o6lXHJcbiAqIEBmaWxlXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIOaPkuWFpei2hemTvuaOpVxyXG4gKiBAY29tbWFuZCBsaW5rXHJcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAcGFyYW0geyBPYmplY3QgfSBvcHRpb25zICAg6K6+572u6Ieq5a6a5LmJ5bGe5oCn77yM5L6L5aaC77yadXJs44CBdGl0bGXjgIF0YXJnZXRcclxuICogQGV4YW1wbGVcclxuICogYGBgamF2YXNjcmlwdFxyXG4gKiBlZGl0b3IuZXhlY0NvbW1hbmQoICdsaW5rJywgJ3tcclxuICogICAgIHVybDondWVkaXRvci5iYWlkdS5jb20nLFxyXG4gKiAgICAgdGl0bGU6J3VlZGl0b3InLFxyXG4gKiAgICAgdGFyZ2V0OidfYmxhbmsnXHJcbiAqIH0nICk7XHJcbiAqIGBgYFxyXG4gKi9cclxuLyoqXHJcbiAqIOi/lOWbnuW9k+WJjemAieS4reeahOesrOS4gOS4qui2hemTvuaOpeiKgueCuVxyXG4gKiBAY29tbWFuZCBsaW5rXHJcbiAqIEBtZXRob2QgcXVlcnlDb21tYW5kVmFsdWVcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAcmV0dXJuIHsgRWxlbWVudCB9IOi2hemTvuaOpeiKgueCuVxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGBqYXZhc2NyaXB0XHJcbiAqIGVkaXRvci5xdWVyeUNvbW1hbmRWYWx1ZSggJ2xpbmsnICk7XHJcbiAqIGBgYFxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiDlj5bmtojotoXpk77mjqVcclxuICogQGNvbW1hbmQgdW5saW5rXHJcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGBqYXZhc2NyaXB0XHJcbiAqIGVkaXRvci5leGVjQ29tbWFuZCggJ3VubGluaycpO1xyXG4gKiBgYGBcclxuICovXHJcblxyXG5VRS5wbHVnaW5zWydsaW5rJ10gPSBmdW5jdGlvbigpe1xyXG4gICAgZnVuY3Rpb24gb3B0aW1pemUoIHJhbmdlICkge1xyXG4gICAgICAgIHZhciBzdGFydCA9IHJhbmdlLnN0YXJ0Q29udGFpbmVyLGVuZCA9IHJhbmdlLmVuZENvbnRhaW5lcjtcclxuXHJcbiAgICAgICAgaWYgKCBzdGFydCA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUoIHN0YXJ0LCAnYScsIHRydWUgKSApIHtcclxuICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnRCZWZvcmUoIHN0YXJ0ICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICggZW5kID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZSggZW5kLCAnYScsIHRydWUgKSApIHtcclxuICAgICAgICAgICAgcmFuZ2Uuc2V0RW5kQWZ0ZXIoIGVuZCApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgVUUuY29tbWFuZHNbJ3VubGluayddID0ge1xyXG4gICAgICAgIGV4ZWNDb21tYW5kIDogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIHZhciByYW5nZSA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCksXHJcbiAgICAgICAgICAgICAgICBib29rbWFyaztcclxuICAgICAgICAgICAgaWYocmFuZ2UuY29sbGFwc2VkICYmICFkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKCByYW5nZS5zdGFydENvbnRhaW5lciwgJ2EnLCB0cnVlICkpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGJvb2ttYXJrID0gcmFuZ2UuY3JlYXRlQm9va21hcmsoKTtcclxuICAgICAgICAgICAgb3B0aW1pemUoIHJhbmdlICk7XHJcbiAgICAgICAgICAgIHJhbmdlLnJlbW92ZUlubGluZVN0eWxlKCAnYScgKS5tb3ZlVG9Cb29rbWFyayggYm9va21hcmsgKS5zZWxlY3QoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlIDogZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgcmV0dXJuICF0aGlzLmhpZ2hsaWdodCAmJiB0aGlzLnF1ZXJ5Q29tbWFuZFZhbHVlKCdsaW5rJykgPyAgMCA6IC0xO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9O1xyXG4gICAgZnVuY3Rpb24gZG9MaW5rKHJhbmdlLG9wdCxtZSl7XHJcbiAgICAgICAgdmFyIHJuZ0Nsb25lID0gcmFuZ2UuY2xvbmVSYW5nZSgpLFxyXG4gICAgICAgICAgICBsaW5rID0gbWUucXVlcnlDb21tYW5kVmFsdWUoJ2xpbmsnKTtcclxuICAgICAgICBvcHRpbWl6ZSggcmFuZ2UgPSByYW5nZS5hZGp1c3RtZW50Qm91bmRhcnkoKSApO1xyXG4gICAgICAgIHZhciBzdGFydCA9IHJhbmdlLnN0YXJ0Q29udGFpbmVyO1xyXG4gICAgICAgIGlmKHN0YXJ0Lm5vZGVUeXBlID09IDEgJiYgbGluayl7XHJcbiAgICAgICAgICAgIHN0YXJ0ID0gc3RhcnQuY2hpbGROb2Rlc1tyYW5nZS5zdGFydE9mZnNldF07XHJcbiAgICAgICAgICAgIGlmKHN0YXJ0ICYmIHN0YXJ0Lm5vZGVUeXBlID09IDEgJiYgc3RhcnQudGFnTmFtZSA9PSAnQScgJiYgL14oPzpodHRwcz98ZnRwfGZpbGUpXFxzKjpcXHMqXFwvXFwvLy50ZXN0KHN0YXJ0W2Jyb3dzZXIuaWU/J2lubmVyVGV4dCc6J3RleHRDb250ZW50J10pKXtcclxuICAgICAgICAgICAgICAgIHN0YXJ0W2Jyb3dzZXIuaWUgPyAnaW5uZXJUZXh0JyA6ICd0ZXh0Q29udGVudCddID0gIHV0aWxzLmh0bWwob3B0LnRleHRWYWx1ZXx8b3B0LmhyZWYpO1xyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiggIXJuZ0Nsb25lLmNvbGxhcHNlZCB8fCBsaW5rKXtcclxuICAgICAgICAgICAgcmFuZ2UucmVtb3ZlSW5saW5lU3R5bGUoICdhJyApO1xyXG4gICAgICAgICAgICBybmdDbG9uZSA9IHJhbmdlLmNsb25lUmFuZ2UoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICggcm5nQ2xvbmUuY29sbGFwc2VkICkge1xyXG4gICAgICAgICAgICB2YXIgYSA9IHJhbmdlLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdhJyksXHJcbiAgICAgICAgICAgICAgICB0ZXh0ID0gJyc7XHJcbiAgICAgICAgICAgIGlmKG9wdC50ZXh0VmFsdWUpe1xyXG5cclxuICAgICAgICAgICAgICAgIHRleHQgPSAgIHV0aWxzLmh0bWwob3B0LnRleHRWYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgb3B0LnRleHRWYWx1ZTtcclxuICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICB0ZXh0ID0gICB1dGlscy5odG1sKG9wdC5ocmVmKTtcclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZG9tVXRpbHMuc2V0QXR0cmlidXRlcyggYSwgb3B0ICk7XHJcbiAgICAgICAgICAgIHN0YXJ0ID0gIGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUoIHJuZ0Nsb25lLnN0YXJ0Q29udGFpbmVyLCAnYScsIHRydWUgKTtcclxuICAgICAgICAgICAgaWYoc3RhcnQgJiYgZG9tVXRpbHMuaXNJbk5vZGVFbmRCb3VuZGFyeShybmdDbG9uZSxzdGFydCkpe1xyXG4gICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnRBZnRlcihzdGFydCkuY29sbGFwc2UodHJ1ZSk7XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGFbYnJvd3Nlci5pZSA/ICdpbm5lclRleHQnIDogJ3RleHRDb250ZW50J10gPSB0ZXh0O1xyXG4gICAgICAgICAgICByYW5nZS5pbnNlcnROb2RlKGEpLnNlbGVjdE5vZGUoIGEgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByYW5nZS5hcHBseUlubGluZVN0eWxlKCAnYScsIG9wdCApO1xyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBVRS5jb21tYW5kc1snbGluayddID0ge1xyXG4gICAgICAgIGV4ZWNDb21tYW5kIDogZnVuY3Rpb24oIGNtZE5hbWUsIG9wdCApIHtcclxuICAgICAgICAgICAgdmFyIHJhbmdlO1xyXG4gICAgICAgICAgICBvcHQuX2hyZWYgJiYgKG9wdC5faHJlZiA9IHV0aWxzLnVuaHRtbChvcHQuX2hyZWYsL1s8XCI+XS9nKSk7XHJcbiAgICAgICAgICAgIG9wdC5ocmVmICYmIChvcHQuaHJlZiA9IHV0aWxzLnVuaHRtbChvcHQuaHJlZiwvWzxcIj5dL2cpKTtcclxuICAgICAgICAgICAgb3B0LnRleHRWYWx1ZSAmJiAob3B0LnRleHRWYWx1ZSA9IHV0aWxzLnVuaHRtbChvcHQudGV4dFZhbHVlLC9bPFwiPl0vZykpO1xyXG4gICAgICAgICAgICBkb0xpbmsocmFuZ2U9dGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxvcHQsdGhpcyk7XHJcbiAgICAgICAgICAgIC8v6Zet5ZCI6YO95LiN5Yqg5Y2g5L2N56ym77yM5aaC5p6c5Yqg5LqG5Lya5ZyoYeWQjui+ueWkmuS4quWNoOS9jeespuiKgueCue+8jOWvvOiHtGHmmK/lm77niYfog4zmma/nu4TmiJDnmoTliJfooajvvIzlh7rnjrDnqbrnmb3pl67pophcclxuICAgICAgICAgICAgcmFuZ2UuY29sbGFwc2UoKS5zZWxlY3QodHJ1ZSk7XHJcblxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcXVlcnlDb21tYW5kVmFsdWUgOiBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgdmFyIHJhbmdlID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxcclxuICAgICAgICAgICAgICAgIG5vZGU7XHJcbiAgICAgICAgICAgIGlmICggcmFuZ2UuY29sbGFwc2VkICkge1xyXG4vLyAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHRoaXMuc2VsZWN0aW9uLmdldFN0YXJ0KCk7XHJcbiAgICAgICAgICAgICAgICAvL+WcqGll5LiLZ2V0c3RhcnQoKeWPluWAvOWBj+S4iuS6hlxyXG4gICAgICAgICAgICAgICAgbm9kZSA9IHJhbmdlLnN0YXJ0Q29udGFpbmVyO1xyXG4gICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUubm9kZVR5cGUgPT0gMSA/IG5vZGUgOiBub2RlLnBhcmVudE5vZGU7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCBub2RlICYmIChub2RlID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZSggbm9kZSwgJ2EnLCB0cnVlICkpICYmICEgZG9tVXRpbHMuaXNJbk5vZGVFbmRCb3VuZGFyeShyYW5nZSxub2RlKSkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vdHJhY2U6MTExMSAg5aaC5p6c5pivPHA+PGE+eHg8L2E+PC9wPiBzdGFydENvbnRhaW5lcuaYr3DlsLHkvJrmib7kuI3liLBhXHJcbiAgICAgICAgICAgICAgICByYW5nZS5zaHJpbmtCb3VuZGFyeSgpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHN0YXJ0ID0gcmFuZ2Uuc3RhcnRDb250YWluZXIubm9kZVR5cGUgID09IDMgfHwgIXJhbmdlLnN0YXJ0Q29udGFpbmVyLmNoaWxkTm9kZXNbcmFuZ2Uuc3RhcnRPZmZzZXRdID8gcmFuZ2Uuc3RhcnRDb250YWluZXIgOiByYW5nZS5zdGFydENvbnRhaW5lci5jaGlsZE5vZGVzW3JhbmdlLnN0YXJ0T2Zmc2V0XSxcclxuICAgICAgICAgICAgICAgICAgICBlbmQgPSAgcmFuZ2UuZW5kQ29udGFpbmVyLm5vZGVUeXBlID09IDMgfHwgcmFuZ2UuZW5kT2Zmc2V0ID09IDAgPyByYW5nZS5lbmRDb250YWluZXIgOiByYW5nZS5lbmRDb250YWluZXIuY2hpbGROb2Rlc1tyYW5nZS5lbmRPZmZzZXQtMV0sXHJcbiAgICAgICAgICAgICAgICAgICAgY29tbW9uID0gcmFuZ2UuZ2V0Q29tbW9uQW5jZXN0b3IoKTtcclxuICAgICAgICAgICAgICAgIG5vZGUgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKCBjb21tb24sICdhJywgdHJ1ZSApO1xyXG4gICAgICAgICAgICAgICAgaWYgKCAhbm9kZSAmJiBjb21tb24ubm9kZVR5cGUgPT0gMSl7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBhcyA9IGNvbW1vbi5nZXRFbGVtZW50c0J5VGFnTmFtZSggJ2EnICksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBzLHBlO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBmb3IgKCB2YXIgaSA9IDAsY2k7IGNpID0gYXNbaSsrXTsgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBzID0gZG9tVXRpbHMuZ2V0UG9zaXRpb24oIGNpLCBzdGFydCApLHBlID0gZG9tVXRpbHMuZ2V0UG9zaXRpb24oIGNpLGVuZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggKHBzICYgZG9tVXRpbHMuUE9TSVRJT05fRk9MTE9XSU5HIHx8IHBzICYgZG9tVXRpbHMuUE9TSVRJT05fQ09OVEFJTlMpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKHBlICYgZG9tVXRpbHMuUE9TSVRJT05fUFJFQ0VESU5HIHx8IHBlICYgZG9tVXRpbHMuUE9TSVRJT05fQ09OVEFJTlMpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBjaTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSxcclxuICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZSA6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAvL+WIpOaWreWmguaenOaYr+inhumikeeahOivnei/nuaOpeS4jeWPr+eUqFxyXG4gICAgICAgICAgICAvL2ZpeCA4NTNcclxuICAgICAgICAgICAgdmFyIGltZyA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCkuZ2V0Q2xvc2VkTm9kZSgpLFxyXG4gICAgICAgICAgICAgICAgZmxhZyA9IGltZyAmJiAoaW1nLmNsYXNzTmFtZSA9PSBcImVkdWktZmFrZWQtdmlkZW9cIiB8fCBpbWcuY2xhc3NOYW1lLmluZGV4T2YoXCJlZHVpLXVwbG9hZC12aWRlb1wiKSE9LTEpO1xyXG4gICAgICAgICAgICByZXR1cm4gZmxhZyA/IC0xIDogMDtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59O1xuXG4vLyBwbHVnaW5zL2lmcmFtZS5qc1xuLy8vaW1wb3J0IGNvcmVcbi8vL2ltcG9ydCBwbHVnaW5zXFxpbnNlcnRodG1sLmpzXG4vLy9jb21tYW5kcyDmj5LlhaXmoYbmnrZcbi8vL2NvbW1hbmRzTmFtZSAgSW5zZXJ0RnJhbWVcbi8vL2NvbW1hbmRzVGl0bGUgIOaPkuWFpUlmcmFtZVxuLy8vY29tbWFuZHNEaWFsb2cgIGRpYWxvZ3NcXGluc2VydGZyYW1lXG5cblVFLnBsdWdpbnNbJ2luc2VydGZyYW1lJ10gPSBmdW5jdGlvbigpIHtcbiAgIHZhciBtZSA9dGhpcztcbiAgICBmdW5jdGlvbiBkZWxldGVJZnJhbWUoKXtcbiAgICAgICAgbWUuX2lmcmFtZSAmJiBkZWxldGUgbWUuX2lmcmFtZTtcbiAgICB9XG5cbiAgICBtZS5hZGRMaXN0ZW5lcihcInNlbGVjdGlvbmNoYW5nZVwiLGZ1bmN0aW9uKCl7XG4gICAgICAgIGRlbGV0ZUlmcmFtZSgpO1xuICAgIH0pO1xuXG59O1xuXG5cblxuLy8gcGx1Z2lucy9zY3Jhd2wuanNcbi8vL2ltcG9ydCBjb3JlXHJcbi8vL2NvbW1hbmRzIOa2gum4plxyXG4vLy9jb21tYW5kc05hbWUgIFNjcmF3bFxyXG4vLy9jb21tYW5kc1RpdGxlICDmtoLpuKZcclxuLy8vY29tbWFuZHNEaWFsb2cgIGRpYWxvZ3NcXHNjcmF3bFxyXG5VRS5jb21tYW5kc1snc2NyYXdsJ10gPSB7XHJcbiAgICBxdWVyeUNvbW1hbmRTdGF0ZSA6IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgcmV0dXJuICggYnJvd3Nlci5pZSAmJiBicm93c2VyLnZlcnNpb24gIDw9IDggKSA/IC0xIDowO1xyXG4gICAgfVxyXG59O1xyXG5cblxuLy8gcGx1Z2lucy9yZW1vdmVmb3JtYXQuanNcbi8qKlxyXG4gKiDmuIXpmaTmoLzlvI9cclxuICogQGZpbGVcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG4vKipcclxuICog5riF6Zmk5paH5a2X5qC35byPXHJcbiAqIEBjb21tYW5kIHJlbW92ZWZvcm1hdFxyXG4gKiBAbWV0aG9kIGV4ZWNDb21tYW5kXHJcbiAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcclxuICogQHBhcmFtICAge1N0cmluZ30gICB0YWdzICAgICDku6XpgJflj7fpmpTlvIDnmoTmoIfnrb7jgILlpoLvvJpzdHJvbmdcclxuICogQHBhcmFtICAge1N0cmluZ30gICBzdHlsZSAgICDmoLflvI/lpoLvvJpjb2xvclxyXG4gKiBAcGFyYW0gICB7U3RyaW5nfSAgIGF0dHJzICAgIOWxnuaAp+Wmgjp3aWR0aFxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGBqYXZhc2NyaXB0XHJcbiAqIGVkaXRvci5leGVjQ29tbWFuZCggJ3JlbW92ZWZvcm1hdCcsICdzdHJvbmcnLCdjb2xvcicsJ3dpZHRoJyApO1xyXG4gKiBgYGBcclxuICovXHJcblxyXG5VRS5wbHVnaW5zWydyZW1vdmVmb3JtYXQnXSA9IGZ1bmN0aW9uKCl7XHJcbiAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgbWUuc2V0T3B0KHtcclxuICAgICAgICdyZW1vdmVGb3JtYXRUYWdzJzogJ2IsYmlnLGNvZGUsZGVsLGRmbixlbSxmb250LGksaW5zLGtiZCxxLHNhbXAsc21hbGwsc3BhbixzdHJpa2Usc3Ryb25nLHN1YixzdXAsdHQsdSx2YXInLFxyXG4gICAgICAgJ3JlbW92ZUZvcm1hdEF0dHJpYnV0ZXMnOidjbGFzcyxzdHlsZSxsYW5nLHdpZHRoLGhlaWdodCxhbGlnbixoc3BhY2UsdmFsaWduJ1xyXG4gICAgfSk7XHJcbiAgICBtZS5jb21tYW5kc1sncmVtb3ZlZm9ybWF0J10gPSB7XHJcbiAgICAgICAgZXhlY0NvbW1hbmQgOiBmdW5jdGlvbiggY21kTmFtZSwgdGFncywgc3R5bGUsIGF0dHJzLG5vdEluY2x1ZGVBICkge1xyXG5cclxuICAgICAgICAgICAgdmFyIHRhZ1JlZyA9IG5ldyBSZWdFeHAoICdeKD86JyArICh0YWdzIHx8IHRoaXMub3B0aW9ucy5yZW1vdmVGb3JtYXRUYWdzKS5yZXBsYWNlKCAvLC9nLCAnfCcgKSArICcpJCcsICdpJyApICxcclxuICAgICAgICAgICAgICAgIHJlbW92ZUZvcm1hdEF0dHJpYnV0ZXMgPSBzdHlsZSA/IFtdIDogKGF0dHJzIHx8IHRoaXMub3B0aW9ucy5yZW1vdmVGb3JtYXRBdHRyaWJ1dGVzKS5zcGxpdCggJywnICksXHJcbiAgICAgICAgICAgICAgICByYW5nZSA9IG5ldyBkb20uUmFuZ2UoIHRoaXMuZG9jdW1lbnQgKSxcclxuICAgICAgICAgICAgICAgIGJvb2ttYXJrLG5vZGUscGFyZW50LFxyXG4gICAgICAgICAgICAgICAgZmlsdGVyID0gZnVuY3Rpb24oIG5vZGUgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT0gMTtcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBmdW5jdGlvbiBpc1JlZHVuZGFudFNwYW4gKG5vZGUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09IDMgfHwgbm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgIT0gJ3NwYW4nKXtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChicm93c2VyLmllKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9pZSDkuIvliKTmlq3lrp7mlYjvvIzmiYDku6Xlj6rog73nroDljZXnlKhzdHlsZeadpeWIpOaWrVxyXG4gICAgICAgICAgICAgICAgICAgIC8vcmV0dXJuIG5vZGUuc3R5bGUuY3NzVGV4dCA9PSAnJyA/IDEgOiAwO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBhdHRycyA9IG5vZGUuYXR0cmlidXRlcztcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIGF0dHJzLmxlbmd0aCApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwLGwgPSBhdHRycy5sZW5ndGg7IGk8bDsgaSsrICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCBhdHRyc1tpXS5zcGVjaWZpZWQgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuICFub2RlLmF0dHJpYnV0ZXMubGVuZ3RoO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIGRvUmVtb3ZlKCByYW5nZSApIHtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgYm9va21hcmsxID0gcmFuZ2UuY3JlYXRlQm9va21hcmsoKTtcclxuICAgICAgICAgICAgICAgIGlmICggcmFuZ2UuY29sbGFwc2VkICkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLmVubGFyZ2UoIHRydWUgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvL+S4jeiDveaKimHmoIfnrb7liIfkuoZcclxuICAgICAgICAgICAgICAgIGlmKCFub3RJbmNsdWRlQSl7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFOb2RlID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShyYW5nZS5zdGFydENvbnRhaW5lciwnYScsdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoYU5vZGUpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydEJlZm9yZShhTm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBhTm9kZSA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocmFuZ2UuZW5kQ29udGFpbmVyLCdhJyx0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICBpZihhTm9kZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldEVuZEFmdGVyKGFOb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgICAgICBib29rbWFyayA9IHJhbmdlLmNyZWF0ZUJvb2ttYXJrKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgbm9kZSA9IGJvb2ttYXJrLnN0YXJ0O1xyXG5cclxuICAgICAgICAgICAgICAgIC8v5YiH5byA5aeLXHJcbiAgICAgICAgICAgICAgICB3aGlsZSAoIChwYXJlbnQgPSBub2RlLnBhcmVudE5vZGUpICYmICFkb21VdGlscy5pc0Jsb2NrRWxtKCBwYXJlbnQgKSApIHtcclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5icmVha1BhcmVudCggbm9kZSwgcGFyZW50ICk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmNsZWFyRW1wdHlTaWJsaW5nKCBub2RlICk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoIGJvb2ttYXJrLmVuZCApIHtcclxuICAgICAgICAgICAgICAgICAgICAvL+WIh+e7k+adn1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUgPSBib29rbWFyay5lbmQ7XHJcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKCAocGFyZW50ID0gbm9kZS5wYXJlbnROb2RlKSAmJiAhZG9tVXRpbHMuaXNCbG9ja0VsbSggcGFyZW50ICkgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmJyZWFrUGFyZW50KCBub2RlLCBwYXJlbnQgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuY2xlYXJFbXB0eVNpYmxpbmcoIG5vZGUgKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8v5byA5aeL5Y676Zmk5qC35byPXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBkb21VdGlscy5nZXROZXh0RG9tTm9kZSggYm9va21hcmsuc3RhcnQsIGZhbHNlLCBmaWx0ZXIgKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV4dDtcclxuICAgICAgICAgICAgICAgICAgICB3aGlsZSAoIGN1cnJlbnQgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggY3VycmVudCA9PSBib29rbWFyay5lbmQgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCA9IGRvbVV0aWxzLmdldE5leHREb21Ob2RlKCBjdXJyZW50LCB0cnVlLCBmaWx0ZXIgKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggIWR0ZC4kZW1wdHlbY3VycmVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCldICYmICFkb21VdGlscy5pc0Jvb2ttYXJrTm9kZSggY3VycmVudCApICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCB0YWdSZWcudGVzdCggY3VycmVudC50YWdOYW1lICkgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCBzdHlsZSApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlU3R5bGUoIGN1cnJlbnQsIHN0eWxlICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggaXNSZWR1bmRhbnRTcGFuKCBjdXJyZW50ICkgJiYgc3R5bGUgIT0gJ3RleHQtZGVjb3JhdGlvbicpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKCBjdXJyZW50LCB0cnVlICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoIGN1cnJlbnQsIHRydWUgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vdHJhY2U6OTM5ICDkuI3og73miopsaXN05LiK55qE5qC35byP5Y675o6JXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWR0ZC4kdGFibGVDb250ZW50W2N1cnJlbnQudGFnTmFtZV0gJiYgIWR0ZC4kbGlzdFtjdXJyZW50LnRhZ05hbWVdKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlQXR0cmlidXRlcyggY3VycmVudCwgcmVtb3ZlRm9ybWF0QXR0cmlidXRlcyApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIGlzUmVkdW5kYW50U3BhbiggY3VycmVudCApICl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoIGN1cnJlbnQsIHRydWUgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IG5leHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy90cmFjZToxMDM1XHJcbiAgICAgICAgICAgICAgICAvL3RyYWNlOjEwOTYg5LiN6IO95oqKdGTkuIrnmoTmoLflvI/ljrvmjonvvIzmr5TlpoLovrnmoYZcclxuICAgICAgICAgICAgICAgIHZhciBwTiA9IGJvb2ttYXJrLnN0YXJ0LnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgICAgICBpZihkb21VdGlscy5pc0Jsb2NrRWxtKHBOKSAmJiAhZHRkLiR0YWJsZUNvbnRlbnRbcE4udGFnTmFtZV0gJiYgIWR0ZC4kbGlzdFtwTi50YWdOYW1lXSl7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlQXR0cmlidXRlcyggIHBOLHJlbW92ZUZvcm1hdEF0dHJpYnV0ZXMgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHBOID0gYm9va21hcmsuZW5kLnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgICAgICBpZihib29rbWFyay5lbmQgJiYgZG9tVXRpbHMuaXNCbG9ja0VsbShwTikgJiYgIWR0ZC4kdGFibGVDb250ZW50W3BOLnRhZ05hbWVdJiYgIWR0ZC4kbGlzdFtwTi50YWdOYW1lXSl7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlQXR0cmlidXRlcyggIHBOLHJlbW92ZUZvcm1hdEF0dHJpYnV0ZXMgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJhbmdlLm1vdmVUb0Jvb2ttYXJrKCBib29rbWFyayApLm1vdmVUb0Jvb2ttYXJrKGJvb2ttYXJrMSk7XHJcbiAgICAgICAgICAgICAgICAvL+a4hemZpOWGl+S9meeahOS7o+eggSA8Yj48Ym9va21hcms+PC9iPlxyXG4gICAgICAgICAgICAgICAgdmFyIG5vZGUgPSByYW5nZS5zdGFydENvbnRhaW5lcixcclxuICAgICAgICAgICAgICAgICAgICB0bXAsXHJcbiAgICAgICAgICAgICAgICAgICAgY29sbGFwc2VkID0gcmFuZ2UuY29sbGFwc2VkO1xyXG4gICAgICAgICAgICAgICAgd2hpbGUobm9kZS5ub2RlVHlwZSA9PSAxICYmIGRvbVV0aWxzLmlzRW1wdHlOb2RlKG5vZGUpICYmIGR0ZC4kcmVtb3ZlRW1wdHlbbm9kZS50YWdOYW1lXSl7XHJcbiAgICAgICAgICAgICAgICAgICAgdG1wID0gbm9kZS5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0QmVmb3JlKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vdHJhY2U6OTM3XHJcbiAgICAgICAgICAgICAgICAgICAgLy/mm7TmlrDnu5PmnZ/ovrnnlYxcclxuICAgICAgICAgICAgICAgICAgICBpZihyYW5nZS5zdGFydENvbnRhaW5lciA9PT0gcmFuZ2UuZW5kQ29udGFpbmVyKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UuZW5kT2Zmc2V0LS07XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShub2RlKTtcclxuICAgICAgICAgICAgICAgICAgICBub2RlID0gdG1wO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmKCFjb2xsYXBzZWQpe1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUgPSByYW5nZS5lbmRDb250YWluZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUobm9kZS5ub2RlVHlwZSA9PSAxICYmIGRvbVV0aWxzLmlzRW1wdHlOb2RlKG5vZGUpICYmIGR0ZC4kcmVtb3ZlRW1wdHlbbm9kZS50YWdOYW1lXSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRtcCA9IG5vZGUucGFyZW50Tm9kZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0RW5kQmVmb3JlKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUobm9kZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gdG1wO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG5cclxuXHJcbiAgICAgICAgICAgIHJhbmdlID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuICAgICAgICAgICAgZG9SZW1vdmUoIHJhbmdlICk7XHJcbiAgICAgICAgICAgIHJhbmdlLnNlbGVjdCgpO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgfTtcclxuXHJcbn07XHJcblxuXG4vLyBwbHVnaW5zL2Jsb2NrcXVvdGUuanNcbi8qKlxyXG4gKiDmt7vliqDlvJXnlKhcclxuICogQGZpbGVcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG4vKipcclxuICog5re75Yqg5byV55SoXHJcbiAqIEBjb21tYW5kIGJsb2NrcXVvdGVcclxuICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnYmxvY2txdW90ZScgKTtcclxuICogYGBgXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIOa3u+WKoOW8leeUqFxyXG4gKiBAY29tbWFuZCBibG9ja3F1b3RlXHJcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAcGFyYW0geyBPYmplY3QgfSBhdHRycyDoioLngrnlsZ7mgKdcclxuICogQGV4YW1wbGVcclxuICogYGBgamF2YXNjcmlwdFxyXG4gKiBlZGl0b3IuZXhlY0NvbW1hbmQoICdibG9ja3F1b3RlJyx7XHJcbiAqICAgICBzdHlsZTogXCJjb2xvcjogcmVkO1wiXHJcbiAqIH0gKTtcclxuICogYGBgXHJcbiAqL1xyXG5cclxuXHJcblVFLnBsdWdpbnNbJ2Jsb2NrcXVvdGUnXSA9IGZ1bmN0aW9uKCl7XHJcbiAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgZnVuY3Rpb24gZ2V0T2JqKGVkaXRvcil7XHJcbiAgICAgICAgcmV0dXJuIGRvbVV0aWxzLmZpbHRlck5vZGVMaXN0KGVkaXRvci5zZWxlY3Rpb24uZ2V0U3RhcnRFbGVtZW50UGF0aCgpLCdibG9ja3F1b3RlJyk7XHJcbiAgICB9XHJcbiAgICBtZS5jb21tYW5kc1snYmxvY2txdW90ZSddID0ge1xyXG4gICAgICAgIGV4ZWNDb21tYW5kIDogZnVuY3Rpb24oIGNtZE5hbWUsIGF0dHJzICkge1xyXG4gICAgICAgICAgICB2YXIgcmFuZ2UgPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxyXG4gICAgICAgICAgICAgICAgb2JqID0gZ2V0T2JqKHRoaXMpLFxyXG4gICAgICAgICAgICAgICAgYmxvY2txdW90ZSA9IGR0ZC5ibG9ja3F1b3RlLFxyXG4gICAgICAgICAgICAgICAgYm9va21hcmsgPSByYW5nZS5jcmVhdGVCb29rbWFyaygpO1xyXG5cclxuICAgICAgICAgICAgaWYgKCBvYmogKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IHJhbmdlLnN0YXJ0Q29udGFpbmVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydEJsb2NrID0gZG9tVXRpbHMuaXNCbG9ja0VsbShzdGFydCkgPyBzdGFydCA6IGRvbVV0aWxzLmZpbmRQYXJlbnQoc3RhcnQsZnVuY3Rpb24obm9kZSl7cmV0dXJuIGRvbVV0aWxzLmlzQmxvY2tFbG0obm9kZSl9KSxcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZCA9IHJhbmdlLmVuZENvbnRhaW5lcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgZW5kQmxvY2sgPSBkb21VdGlscy5pc0Jsb2NrRWxtKGVuZCkgPyBlbmQgOiAgZG9tVXRpbHMuZmluZFBhcmVudChlbmQsZnVuY3Rpb24obm9kZSl7cmV0dXJuIGRvbVV0aWxzLmlzQmxvY2tFbG0obm9kZSl9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy/lpITnkIbkuIDkuItsaVxyXG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0QmxvY2sgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHN0YXJ0QmxvY2ssJ2xpJyx0cnVlKSB8fCBzdGFydEJsb2NrO1xyXG4gICAgICAgICAgICAgICAgICAgIGVuZEJsb2NrID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShlbmRCbG9jaywnbGknLHRydWUpIHx8IGVuZEJsb2NrO1xyXG5cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYoc3RhcnRCbG9jay50YWdOYW1lID09ICdMSScgfHwgc3RhcnRCbG9jay50YWdOYW1lID09ICdURCcgfHwgc3RhcnRCbG9jayA9PT0gb2JqIHx8IGRvbVV0aWxzLmlzQm9keShzdGFydEJsb2NrKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShvYmosdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmJyZWFrUGFyZW50KHN0YXJ0QmxvY2ssb2JqKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmKHN0YXJ0QmxvY2sgIT09IGVuZEJsb2NrKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2JqID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShlbmRCbG9jaywnYmxvY2txdW90ZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihvYmope1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZW5kQmxvY2sudGFnTmFtZSA9PSAnTEknIHx8IGVuZEJsb2NrLnRhZ05hbWUgPT0gJ1REJ3x8IGRvbVV0aWxzLmlzQm9keShlbmRCbG9jaykpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5wYXJlbnROb2RlICYmIGRvbVV0aWxzLnJlbW92ZShvYmosdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5icmVha1BhcmVudChlbmRCbG9jayxvYmopO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJsb2NrcXVvdGVzID0gZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGhpcy5kb2N1bWVudCwnYmxvY2txdW90ZScpO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaT0wLGJpO2JpPWJsb2NrcXVvdGVzW2krK107KXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWJpLmNoaWxkTm9kZXMubGVuZ3RoKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShiaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKGRvbVV0aWxzLmdldFBvc2l0aW9uKGJpLHN0YXJ0QmxvY2spJmRvbVV0aWxzLlBPU0lUSU9OX0ZPTExPV0lORyAmJiBkb21VdGlscy5nZXRQb3NpdGlvbihiaSxlbmRCbG9jaykmZG9tVXRpbHMuUE9TSVRJT05fUFJFQ0VESU5HKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShiaSx0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG5cclxuXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIHRtcFJhbmdlID0gcmFuZ2UuY2xvbmVSYW5nZSgpLFxyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUgPSB0bXBSYW5nZS5zdGFydENvbnRhaW5lci5ub2RlVHlwZSA9PSAxID8gdG1wUmFuZ2Uuc3RhcnRDb250YWluZXIgOiB0bXBSYW5nZS5zdGFydENvbnRhaW5lci5wYXJlbnROb2RlLFxyXG4gICAgICAgICAgICAgICAgICAgIHByZU5vZGUgPSBub2RlLFxyXG4gICAgICAgICAgICAgICAgICAgIGRvRW5kID0gMTtcclxuXHJcbiAgICAgICAgICAgICAgICAvL+iwg+aVtOW8gOWni1xyXG4gICAgICAgICAgICAgICAgd2hpbGUgKCAxICkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICggZG9tVXRpbHMuaXNCb2R5KG5vZGUpICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHByZU5vZGUgIT09IG5vZGUgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHJhbmdlLmNvbGxhcHNlZCApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBSYW5nZS5zZWxlY3ROb2RlKCBwcmVOb2RlICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9FbmQgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBSYW5nZS5zZXRTdGFydEJlZm9yZSggcHJlTm9kZSApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFJhbmdlLnNldFN0YXJ0KG5vZGUsMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoICFibG9ja3F1b3RlW25vZGUudGFnTmFtZV0gKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggcmFuZ2UuY29sbGFwc2VkICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wUmFuZ2Uuc2VsZWN0Tm9kZSggcHJlTm9kZSApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBSYW5nZS5zZXRTdGFydEJlZm9yZSggcHJlTm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBwcmVOb2RlID0gbm9kZTtcclxuICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8v6LCD5pW057uT5p2fXHJcbiAgICAgICAgICAgICAgICBpZiAoIGRvRW5kICkge1xyXG4gICAgICAgICAgICAgICAgICAgIHByZU5vZGUgPSBub2RlID0gIG5vZGUgPSB0bXBSYW5nZS5lbmRDb250YWluZXIubm9kZVR5cGUgPT0gMSA/IHRtcFJhbmdlLmVuZENvbnRhaW5lciA6IHRtcFJhbmdlLmVuZENvbnRhaW5lci5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgIHdoaWxlICggMSApIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggZG9tVXRpbHMuaXNCb2R5KCBub2RlICkgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHByZU5vZGUgIT09IG5vZGUgKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFJhbmdlLnNldEVuZEFmdGVyKCBwcmVOb2RlICk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBSYW5nZS5zZXRFbmQoIG5vZGUsIG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoICFibG9ja3F1b3RlW25vZGUudGFnTmFtZV0gKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBSYW5nZS5zZXRFbmRBZnRlciggcHJlTm9kZSApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZU5vZGUgPSBub2RlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgICAgIG5vZGUgPSByYW5nZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnYmxvY2txdW90ZScgKTtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnNldEF0dHJpYnV0ZXMoIG5vZGUsIGF0dHJzICk7XHJcbiAgICAgICAgICAgICAgICBub2RlLmFwcGVuZENoaWxkKCB0bXBSYW5nZS5leHRyYWN0Q29udGVudHMoKSApO1xyXG4gICAgICAgICAgICAgICAgdG1wUmFuZ2UuaW5zZXJ0Tm9kZSggbm9kZSApO1xyXG4gICAgICAgICAgICAgICAgLy/ljrvpmaTph43lpI3nmoRcclxuICAgICAgICAgICAgICAgIHZhciBjaGlsZHMgPSBkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZShub2RlLCdibG9ja3F1b3RlJyk7XHJcbiAgICAgICAgICAgICAgICBmb3IodmFyIGk9MCxjaTtjaT1jaGlsZHNbaSsrXTspe1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGNpLnBhcmVudE5vZGUpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoY2ksdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByYW5nZS5tb3ZlVG9Cb29rbWFyayggYm9va21hcmsgKS5zZWxlY3QoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlIDogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBnZXRPYmoodGhpcykgPyAxIDogMDtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59O1xyXG5cclxuXG5cbi8vIHBsdWdpbnMvY29udmVydGNhc2UuanNcbi8qKlxyXG4gKiDlpKflsI/lhpnovazmjaJcclxuICogQGZpbGVcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG4vKipcclxuICog5oqK6YCJ5Yy65YaF5paH5pys5Y+Y5aSn5YaZ77yM5LiO4oCcdG9sb3dlcmNhc2XigJ3lkb3ku6TkupLmlqVcclxuICogQGNvbW1hbmQgdG91cHBlcmNhc2VcclxuICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogZWRpdG9yLmV4ZWNDb21tYW5kKCAndG91cHBlcmNhc2UnICk7XHJcbiAqIGBgYFxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiDmiorpgInljLrlhoXmlofmnKzlj5jlsI/lhpnvvIzkuI7igJx0b3VwcGVyY2FzZeKAneWRveS7pOS6kuaWpVxyXG4gKiBAY29tbWFuZCB0b2xvd2VyY2FzZVxyXG4gKiBAbWV0aG9kIGV4ZWNDb21tYW5kXHJcbiAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcclxuICogQGV4YW1wbGVcclxuICogYGBgamF2YXNjcmlwdFxyXG4gKiBlZGl0b3IuZXhlY0NvbW1hbmQoICd0b2xvd2VyY2FzZScgKTtcclxuICogYGBgXHJcbiAqL1xyXG5VRS5jb21tYW5kc1sndG91cHBlcmNhc2UnXSA9XHJcblVFLmNvbW1hbmRzWyd0b2xvd2VyY2FzZSddID0ge1xyXG4gICAgZXhlY0NvbW1hbmQ6ZnVuY3Rpb24gKGNtZCkge1xyXG4gICAgICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICAgICAgdmFyIHJuZyA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xyXG4gICAgICAgIGlmKHJuZy5jb2xsYXBzZWQpe1xyXG4gICAgICAgICAgICByZXR1cm4gcm5nO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgYmsgPSBybmcuY3JlYXRlQm9va21hcmsoKSxcclxuICAgICAgICAgICAgYmtFbmQgPSBiay5lbmQsXHJcbiAgICAgICAgICAgIGZpbHRlckZuID0gZnVuY3Rpb24oIG5vZGUgKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gIWRvbVV0aWxzLmlzQnIobm9kZSkgJiYgIWRvbVV0aWxzLmlzV2hpdGVzcGFjZSggbm9kZSApO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBjdXJOb2RlID0gZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoIGJrLnN0YXJ0LCBmYWxzZSwgZmlsdGVyRm4gKTtcclxuICAgICAgICB3aGlsZSAoIGN1ck5vZGUgJiYgKGRvbVV0aWxzLmdldFBvc2l0aW9uKCBjdXJOb2RlLCBia0VuZCApICYgZG9tVXRpbHMuUE9TSVRJT05fUFJFQ0VESU5HKSApIHtcclxuXHJcbiAgICAgICAgICAgIGlmICggY3VyTm9kZS5ub2RlVHlwZSA9PSAzICkge1xyXG4gICAgICAgICAgICAgICAgY3VyTm9kZS5ub2RlVmFsdWUgPSBjdXJOb2RlLm5vZGVWYWx1ZVtjbWQgPT0gJ3RvdXBwZXJjYXNlJyA/ICd0b1VwcGVyQ2FzZScgOiAndG9Mb3dlckNhc2UnXSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGN1ck5vZGUgPSBkb21VdGlscy5nZXROZXh0RG9tTm9kZSggY3VyTm9kZSwgdHJ1ZSwgZmlsdGVyRm4gKTtcclxuICAgICAgICAgICAgaWYoY3VyTm9kZSA9PT0gYmtFbmQpe1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJuZy5tb3ZlVG9Cb29rbWFyayhiaykuc2VsZWN0KCk7XHJcbiAgICB9XHJcbn07XHJcblxyXG5cblxuLy8gcGx1Z2lucy9pbmRlbnQuanNcbi8qKlxyXG4gKiDpppbooYznvKnov5tcclxuICogQGZpbGVcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG4vKipcclxuICog57yp6L+bXHJcbiAqIEBjb21tYW5kIGluZGVudFxyXG4gKiBAbWV0aG9kIGV4ZWNDb21tYW5kXHJcbiAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcclxuICogQGV4YW1wbGVcclxuICogYGBgamF2YXNjcmlwdFxyXG4gKiBlZGl0b3IuZXhlY0NvbW1hbmQoICdpbmRlbnQnICk7XHJcbiAqIGBgYFxyXG4gKi9cclxuVUUuY29tbWFuZHNbJ2luZGVudCddID0ge1xyXG4gICAgZXhlY0NvbW1hbmQgOiBmdW5jdGlvbigpIHtcclxuICAgICAgICAgdmFyIG1lID0gdGhpcyx2YWx1ZSA9IG1lLnF1ZXJ5Q29tbWFuZFN0YXRlKFwiaW5kZW50XCIpID8gXCIwZW1cIiA6IChtZS5vcHRpb25zLmluZGVudFZhbHVlIHx8ICcyZW0nKTtcclxuICAgICAgICAgbWUuZXhlY0NvbW1hbmQoJ1BhcmFncmFwaCcsJ3AnLHtzdHlsZTondGV4dC1pbmRlbnQ6JysgdmFsdWV9KTtcclxuICAgIH0sXHJcbiAgICBxdWVyeUNvbW1hbmRTdGF0ZSA6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHZhciBwTiA9IGRvbVV0aWxzLmZpbHRlck5vZGVMaXN0KHRoaXMuc2VsZWN0aW9uLmdldFN0YXJ0RWxlbWVudFBhdGgoKSwncCBoMSBoMiBoMyBoNCBoNSBoNicpO1xyXG4gICAgICAgIHJldHVybiBwTiAmJiBwTi5zdHlsZS50ZXh0SW5kZW50ICYmIHBhcnNlSW50KHBOLnN0eWxlLnRleHRJbmRlbnQpID8gIDEgOiAwO1xyXG4gICAgfVxyXG5cclxufTtcclxuXG5cbi8vIHBsdWdpbnMvcHJpbnQuanNcbi8qKlxyXG4gKiDmiZPljbBcclxuICogQGZpbGVcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG4vKipcclxuICog5omT5Y2wXHJcbiAqIEBjb21tYW5kIHByaW50XHJcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGBqYXZhc2NyaXB0XHJcbiAqIGVkaXRvci5leGVjQ29tbWFuZCggJ3ByaW50JyApO1xyXG4gKiBgYGBcclxuICovXHJcblVFLmNvbW1hbmRzWydwcmludCddID0ge1xyXG4gICAgZXhlY0NvbW1hbmQgOiBmdW5jdGlvbigpe1xyXG4gICAgICAgIHRoaXMud2luZG93LnByaW50KCk7XHJcbiAgICB9LFxyXG4gICAgbm90TmVlZFVuZG8gOiAxXHJcbn07XHJcblxyXG5cblxuLy8gcGx1Z2lucy9wcmV2aWV3LmpzXG4vKipcbiAqIOmihOiniFxuICogQGZpbGVcbiAqIEBzaW5jZSAxLjIuNi4xXG4gKi9cblxuLyoqXG4gKiDpooTop4hcbiAqIEBjb21tYW5kIHByZXZpZXdcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcbiAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcbiAqIEBleGFtcGxlXG4gKiBgYGBqYXZhc2NyaXB0XG4gKiBlZGl0b3IuZXhlY0NvbW1hbmQoICdwcmV2aWV3JyApO1xuICogYGBgXG4gKi9cblVFLmNvbW1hbmRzWydwcmV2aWV3J10gPSB7XG4gICAgZXhlY0NvbW1hbmQgOiBmdW5jdGlvbigpe1xuICAgICAgICB2YXIgdyA9IHdpbmRvdy5vcGVuKCcnLCAnX2JsYW5rJywgJycpLFxuICAgICAgICAgICAgZCA9IHcuZG9jdW1lbnQ7XG4gICAgICAgIGQub3BlbigpO1xuICAgICAgICBkLndyaXRlKCc8IURPQ1RZUEUgaHRtbD48aHRtbD48aGVhZD48bWV0YSBjaGFyc2V0PVwidXRmLThcIi8+PHNjcmlwdCBzcmM9XCInK3RoaXMub3B0aW9ucy5VRURJVE9SX0hPTUVfVVJMKyd1ZWRpdG9yLnBhcnNlLmpzXCI+PC9zY3JpcHQ+PHNjcmlwdD4nICtcbiAgICAgICAgICAgIFwic2V0VGltZW91dChmdW5jdGlvbigpe3VQYXJzZSgnZGl2Jyx7cm9vdFBhdGg6ICdcIisgdGhpcy5vcHRpb25zLlVFRElUT1JfSE9NRV9VUkwgK1wiJ30pfSwzMDApXCIgK1xuICAgICAgICAgICAgJzwvc2NyaXB0PjwvaGVhZD48Ym9keT48ZGl2PicrdGhpcy5nZXRDb250ZW50KG51bGwsbnVsbCx0cnVlKSsnPC9kaXY+PC9ib2R5PjwvaHRtbD4nKTtcbiAgICAgICAgZC5jbG9zZSgpO1xuICAgIH0sXG4gICAgbm90TmVlZFVuZG8gOiAxXG59O1xuXG5cbi8vIHBsdWdpbnMvc2VsZWN0YWxsLmpzXG4vKipcclxuICog5YWo6YCJXHJcbiAqIEBmaWxlXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIOmAieS4reaJgOacieWGheWuuVxyXG4gKiBAY29tbWFuZCBzZWxlY3RhbGxcclxuICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnc2VsZWN0YWxsJyApO1xyXG4gKiBgYGBcclxuICovXHJcblVFLnBsdWdpbnNbJ3NlbGVjdGFsbCddID0gZnVuY3Rpb24oKXtcclxuICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICBtZS5jb21tYW5kc1snc2VsZWN0YWxsJ10gPSB7XHJcbiAgICAgICAgZXhlY0NvbW1hbmQgOiBmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAvL+WOu+aOieS6huWOn+eUn+eahHNlbGVjdEFsbCzlm6DkuLrkvJrlh7rnjrDmiqXplJnlkozlvZPlhoXlrrnkuLrnqbrml7bvvIzkuI3og73lh7rnjrDpl63lkIjnirbmgIHnmoTlhYnmoIdcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcyxib2R5ID0gbWUuYm9keSxcclxuICAgICAgICAgICAgICAgIHJhbmdlID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgIHJhbmdlLnNlbGVjdE5vZGVDb250ZW50cyhib2R5KTtcclxuICAgICAgICAgICAgaWYoZG9tVXRpbHMuaXNFbXB0eUJsb2NrKGJvZHkpKXtcclxuICAgICAgICAgICAgICAgIC8vb3BlcmHkuI3og73oh6rliqjlkIjlubbliLDlhYPntKDnmoTph4zovrnvvIzopoHmiYvliqjlpITnkIbkuIDkuItcclxuICAgICAgICAgICAgICAgIGlmKGJyb3dzZXIub3BlcmEgJiYgYm9keS5maXJzdENoaWxkICYmIGJvZHkuZmlyc3RDaGlsZC5ub2RlVHlwZSA9PSAxKXtcclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydEF0Rmlyc3QoYm9keS5maXJzdENoaWxkKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJhbmdlLmNvbGxhcHNlKHRydWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJhbmdlLnNlbGVjdCh0cnVlKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG5vdE5lZWRVbmRvIDogMVxyXG4gICAgfTtcclxuXHJcblxyXG4gICAgLy/lv6vmjbfplK5cclxuICAgIG1lLmFkZHNob3J0Y3V0a2V5KHtcclxuICAgICAgICAgXCJzZWxlY3RBbGxcIiA6IFwiY3RybCs2NVwiXHJcbiAgICB9KTtcclxufTtcclxuXG5cbi8vIHBsdWdpbnMvcGFyYWdyYXBoLmpzXG4vKipcclxuICog5q616JC95qC35byPXHJcbiAqIEBmaWxlXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIOauteiQveagvOW8j1xyXG4gKiBAY29tbWFuZCBwYXJhZ3JhcGhcclxuICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEBwYXJhbSB7U3RyaW5nfSAgIHN0eWxlICAgICAgICAgICAgICAg5qCH562+5YC85Li677yaJ3AnLCAnaDEnLCAnaDInLCAnaDMnLCAnaDQnLCAnaDUnLCAnaDYnXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSAgIGF0dHJzICAgICAgICAgICAgICAg5qCH562+55qE5bGe5oCnXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnUGFyYWdyYXBoJywnaDEnLCd7XHJcbiAqICAgICBjbGFzczondGVzdCdcclxuICogfScgKTtcclxuICogYGBgXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIOi/lOWbnumAieWMuuWGheiKgueCueagh+etvuWQjVxyXG4gKiBAY29tbWFuZCBwYXJhZ3JhcGhcclxuICogQG1ldGhvZCBxdWVyeUNvbW1hbmRWYWx1ZVxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEByZXR1cm4geyBTdHJpbmcgfSDoioLngrnmoIfnrb7lkI1cclxuICogQGV4YW1wbGVcclxuICogYGBgamF2YXNjcmlwdFxyXG4gKiBlZGl0b3IucXVlcnlDb21tYW5kVmFsdWUoICdQYXJhZ3JhcGgnICk7XHJcbiAqIGBgYFxyXG4gKi9cclxuXHJcblVFLnBsdWdpbnNbJ3BhcmFncmFwaCddID0gZnVuY3Rpb24oKSB7XHJcbiAgICB2YXIgbWUgPSB0aGlzLFxyXG4gICAgICAgIGJsb2NrID0gZG9tVXRpbHMuaXNCbG9ja0VsbSxcclxuICAgICAgICBub3RFeGNoYW5nZSA9IFsnVEQnLCdMSScsJ1BSRSddLFxyXG5cclxuICAgICAgICBkb1BhcmFncmFwaCA9IGZ1bmN0aW9uKHJhbmdlLHN0eWxlLGF0dHJzLHNvdXJjZUNtZE5hbWUpe1xyXG4gICAgICAgICAgICB2YXIgYm9va21hcmsgPSByYW5nZS5jcmVhdGVCb29rbWFyaygpLFxyXG4gICAgICAgICAgICAgICAgZmlsdGVyRm4gPSBmdW5jdGlvbiggbm9kZSApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gICBub2RlLm5vZGVUeXBlID09IDEgPyBub2RlLnRhZ05hbWUudG9Mb3dlckNhc2UoKSAhPSAnYnInICYmICAhZG9tVXRpbHMuaXNCb29rbWFya05vZGUobm9kZSkgOiAhZG9tVXRpbHMuaXNXaGl0ZXNwYWNlKCBub2RlICk7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgcGFyYTtcclxuXHJcbiAgICAgICAgICAgIHJhbmdlLmVubGFyZ2UoIHRydWUgKTtcclxuICAgICAgICAgICAgdmFyIGJvb2ttYXJrMiA9IHJhbmdlLmNyZWF0ZUJvb2ttYXJrKCksXHJcbiAgICAgICAgICAgICAgICBjdXJyZW50ID0gZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoIGJvb2ttYXJrMi5zdGFydCwgZmFsc2UsIGZpbHRlckZuICksXHJcbiAgICAgICAgICAgICAgICB0bXBSYW5nZSA9IHJhbmdlLmNsb25lUmFuZ2UoKSxcclxuICAgICAgICAgICAgICAgIHRtcE5vZGU7XHJcbiAgICAgICAgICAgIHdoaWxlICggY3VycmVudCAmJiAhKGRvbVV0aWxzLmdldFBvc2l0aW9uKCBjdXJyZW50LCBib29rbWFyazIuZW5kICkgJiBkb21VdGlscy5QT1NJVElPTl9GT0xMT1dJTkcpICkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCBjdXJyZW50Lm5vZGVUeXBlID09IDMgfHwgIWJsb2NrKCBjdXJyZW50ICkgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdG1wUmFuZ2Uuc2V0U3RhcnRCZWZvcmUoIGN1cnJlbnQgKTtcclxuICAgICAgICAgICAgICAgICAgICB3aGlsZSAoIGN1cnJlbnQgJiYgY3VycmVudCAhPT0gYm9va21hcmsyLmVuZCAmJiAhYmxvY2soIGN1cnJlbnQgKSApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG1wTm9kZSA9IGN1cnJlbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBkb21VdGlscy5nZXROZXh0RG9tTm9kZSggY3VycmVudCwgZmFsc2UsIG51bGwsIGZ1bmN0aW9uKCBub2RlICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFibG9jayggbm9kZSApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9ICk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHRtcFJhbmdlLnNldEVuZEFmdGVyKCB0bXBOb2RlICk7XHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgcGFyYSA9IHJhbmdlLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIHN0eWxlICk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoYXR0cnMpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5zZXRBdHRyaWJ1dGVzKHBhcmEsYXR0cnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihzb3VyY2VDbWROYW1lICYmIHNvdXJjZUNtZE5hbWUgPT0gJ2N1c3RvbXN0eWxlJyAmJiBhdHRycy5zdHlsZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhLnN0eWxlLmNzc1RleHQgPSBhdHRycy5zdHlsZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBwYXJhLmFwcGVuZENoaWxkKCB0bXBSYW5nZS5leHRyYWN0Q29udGVudHMoKSApO1xyXG4gICAgICAgICAgICAgICAgICAgIC8v6ZyA6KaB5YaF5a655Y2g5L2NXHJcbiAgICAgICAgICAgICAgICAgICAgaWYoZG9tVXRpbHMuaXNFbXB0eU5vZGUocGFyYSkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5maWxsQ2hhcihyYW5nZS5kb2N1bWVudCxwYXJhKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB0bXBSYW5nZS5pbnNlcnROb2RlKCBwYXJhICk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBwYXJhLnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgLy/lpoLmnpxwYXJh5LiK5LiA57qn5piv5LiA5LiqYmxvY2vlhYPntKDkuJTkuI3mmK9ib2R5LHRk5bCx5Yig6Zmk5a6DXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBibG9jayggcGFyZW50ICkgJiYgIWRvbVV0aWxzLmlzQm9keSggcGFyYS5wYXJlbnROb2RlICkgJiYgdXRpbHMuaW5kZXhPZihub3RFeGNoYW5nZSxwYXJlbnQudGFnTmFtZSk9PS0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8v5a2Y5YKoZGlyLHN0eWxlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCEoc291cmNlQ21kTmFtZSAmJiBzb3VyY2VDbWROYW1lID09ICdjdXN0b21zdHlsZScpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5nZXRBdHRyaWJ1dGUoJ2RpcicpICYmIHBhcmEuc2V0QXR0cmlidXRlKCdkaXInLHBhcmVudC5nZXRBdHRyaWJ1dGUoJ2RpcicpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vdHJhY2U6MTA3MFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50LnN0eWxlLmNzc1RleHQgJiYgKHBhcmEuc3R5bGUuY3NzVGV4dCA9IHBhcmVudC5zdHlsZS5jc3NUZXh0ICsgJzsnICsgcGFyYS5zdHlsZS5jc3NUZXh0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vdHJhY2U6MTAzMFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50LnN0eWxlLnRleHRBbGlnbiAmJiAhcGFyYS5zdHlsZS50ZXh0QWxpZ24gJiYgKHBhcmEuc3R5bGUudGV4dEFsaWduID0gcGFyZW50LnN0eWxlLnRleHRBbGlnbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuc3R5bGUudGV4dEluZGVudCAmJiAhcGFyYS5zdHlsZS50ZXh0SW5kZW50ICYmIChwYXJhLnN0eWxlLnRleHRJbmRlbnQgPSBwYXJlbnQuc3R5bGUudGV4dEluZGVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuc3R5bGUucGFkZGluZyAmJiAhcGFyYS5zdHlsZS5wYWRkaW5nICYmIChwYXJhLnN0eWxlLnBhZGRpbmcgPSBwYXJlbnQuc3R5bGUucGFkZGluZyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vdHJhY2U6MTcwNiDpgInmi6nnmoTlsLHmmK9oMS026KaB5Yig6ZmkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGF0dHJzICYmIC9oXFxkL2kudGVzdChwYXJlbnQudGFnTmFtZSkgJiYgIS9oXFxkL2kudGVzdChwYXJhLnRhZ05hbWUpICl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5zZXRBdHRyaWJ1dGVzKHBhcmVudCxhdHRycyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihzb3VyY2VDbWROYW1lICYmIHNvdXJjZUNtZE5hbWUgPT0gJ2N1c3RvbXN0eWxlJyAmJiBhdHRycy5zdHlsZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50LnN0eWxlLmNzc1RleHQgPSBhdHRycy5zdHlsZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShwYXJhLHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYSA9IHBhcmVudDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoIHBhcmEucGFyZW50Tm9kZSwgdHJ1ZSApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiggIHV0aWxzLmluZGV4T2Yobm90RXhjaGFuZ2UscGFyZW50LnRhZ05hbWUpIT0tMSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBwYXJlbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHBhcmE7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGRvbVV0aWxzLmdldE5leHREb21Ob2RlKCBjdXJyZW50LCBmYWxzZSwgZmlsdGVyRm4gKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGRvbVV0aWxzLmdldE5leHREb21Ob2RlKCBjdXJyZW50LCB0cnVlLCBmaWx0ZXJGbiApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiByYW5nZS5tb3ZlVG9Cb29rbWFyayggYm9va21hcmsyICkubW92ZVRvQm9va21hcmsoIGJvb2ttYXJrICk7XHJcbiAgICAgICAgfTtcclxuICAgIG1lLnNldE9wdCgncGFyYWdyYXBoJyx7J3AnOicnLCAnaDEnOicnLCAnaDInOicnLCAnaDMnOicnLCAnaDQnOicnLCAnaDUnOicnLCAnaDYnOicnfSk7XHJcbiAgICBtZS5jb21tYW5kc1sncGFyYWdyYXBoJ10gPSB7XHJcbiAgICAgICAgZXhlY0NvbW1hbmQgOiBmdW5jdGlvbiggY21kTmFtZSwgc3R5bGUsYXR0cnMsc291cmNlQ21kTmFtZSApIHtcclxuICAgICAgICAgICAgdmFyIHJhbmdlID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuICAgICAgICAgICAgIC8v6Zet5ZCI5pe25Y2V54us5aSE55CGXHJcbiAgICAgICAgICAgIGlmKHJhbmdlLmNvbGxhcHNlZCl7XHJcbiAgICAgICAgICAgICAgICB2YXIgdHh0ID0gdGhpcy5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgncCcpO1xyXG4gICAgICAgICAgICAgICAgcmFuZ2UuaW5zZXJ0Tm9kZSh0eHQpO1xyXG4gICAgICAgICAgICAgICAgLy/ljrvmjonlhpfkvZnnmoRmaWxsY2hhclxyXG4gICAgICAgICAgICAgICAgaWYoYnJvd3Nlci5pZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0eHQucHJldmlvdXNTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKG5vZGUgJiYgZG9tVXRpbHMuaXNXaGl0ZXNwYWNlKG5vZGUpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBub2RlID0gdHh0Lm5leHRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKG5vZGUgJiYgZG9tVXRpbHMuaXNXaGl0ZXNwYWNlKG5vZGUpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmFuZ2UgPSBkb1BhcmFncmFwaChyYW5nZSxzdHlsZSxhdHRycyxzb3VyY2VDbWROYW1lKTtcclxuICAgICAgICAgICAgaWYodHh0KXtcclxuICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0QmVmb3JlKHR4dCkuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBwTiA9IHR4dC5wYXJlbnROb2RlO1xyXG5cclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZSh0eHQpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmKGRvbVV0aWxzLmlzQmxvY2tFbG0ocE4pJiZkb21VdGlscy5pc0VtcHR5Tm9kZShwTikpe1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmZpbGxOb2RlKHRoaXMuZG9jdW1lbnQscE4pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYoYnJvd3Nlci5nZWNrbyAmJiByYW5nZS5jb2xsYXBzZWQgJiYgcmFuZ2Uuc3RhcnRDb250YWluZXIubm9kZVR5cGUgPT0gMSl7XHJcbiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSByYW5nZS5zdGFydENvbnRhaW5lci5jaGlsZE5vZGVzW3JhbmdlLnN0YXJ0T2Zmc2V0XTtcclxuICAgICAgICAgICAgICAgIGlmKGNoaWxkICYmIGNoaWxkLm5vZGVUeXBlID09IDEgJiYgY2hpbGQudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09IHN0eWxlKXtcclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydChjaGlsZCwwKS5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvL3RyYWNlOjEwOTcg5Y6f5p2l5pyJdHJ1Ze+8jOWOn+WboOW/mOS6hu+8jOS9huWOu+S6huWwseS4jeiDvea4hemZpOWkmuS9meeahOWNoOS9jeespuS6hlxyXG4gICAgICAgICAgICByYW5nZS5zZWxlY3QoKTtcclxuXHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFZhbHVlIDogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIHZhciBub2RlID0gZG9tVXRpbHMuZmlsdGVyTm9kZUxpc3QodGhpcy5zZWxlY3Rpb24uZ2V0U3RhcnRFbGVtZW50UGF0aCgpLCdwIGgxIGgyIGgzIGg0IGg1IGg2Jyk7XHJcbiAgICAgICAgICAgIHJldHVybiBub2RlID8gbm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgOiAnJztcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59O1xyXG5cblxuLy8gcGx1Z2lucy9kaXJlY3Rpb25hbGl0eS5qc1xuLyoqXHJcbiAqIOiuvue9ruaWh+Wtl+i+k+WFpeeahOaWueWQkeeahOaPkuS7tlxyXG4gKiBAZmlsZVxyXG4gKiBAc2luY2UgMS4yLjYuMVxyXG4gKi9cclxuKGZ1bmN0aW9uKCkge1xyXG4gICAgdmFyIGJsb2NrID0gZG9tVXRpbHMuaXNCbG9ja0VsbSAsXHJcbiAgICAgICAgZ2V0T2JqID0gZnVuY3Rpb24oZWRpdG9yKXtcclxuLy8gICAgICAgICAgICB2YXIgc3RhcnROb2RlID0gZWRpdG9yLnNlbGVjdGlvbi5nZXRTdGFydCgpLFxyXG4vLyAgICAgICAgICAgICAgICBwYXJlbnRzO1xyXG4vLyAgICAgICAgICAgIGlmICggc3RhcnROb2RlICkge1xyXG4vLyAgICAgICAgICAgICAgICAvL+afpeaJvuaJgOacieeahOaYr2Jsb2Nr55qE54i25Lqy6IqC54K5XHJcbi8vICAgICAgICAgICAgICAgIHBhcmVudHMgPSBkb21VdGlscy5maW5kUGFyZW50cyggc3RhcnROb2RlLCB0cnVlLCBibG9jaywgdHJ1ZSApO1xyXG4vLyAgICAgICAgICAgICAgICBmb3IgKCB2YXIgaSA9IDAsY2k7IGNpID0gcGFyZW50c1tpKytdOyApIHtcclxuLy8gICAgICAgICAgICAgICAgICAgIGlmICggY2kuZ2V0QXR0cmlidXRlKCAnZGlyJyApICkge1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjaTtcclxuLy8gICAgICAgICAgICAgICAgICAgIH1cclxuLy8gICAgICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGRvbVV0aWxzLmZpbHRlck5vZGVMaXN0KGVkaXRvci5zZWxlY3Rpb24uZ2V0U3RhcnRFbGVtZW50UGF0aCgpLGZ1bmN0aW9uKG4pe3JldHVybiBuICYmIG4ubm9kZVR5cGUgPT0gMSAmJiBuLmdldEF0dHJpYnV0ZSgnZGlyJyl9KTtcclxuXHJcbiAgICAgICAgfSxcclxuICAgICAgICBkb0RpcmVjdGlvbmFsaXR5ID0gZnVuY3Rpb24ocmFuZ2UsZWRpdG9yLGZvcndhcmQpe1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdmFyIGJvb2ttYXJrLFxyXG4gICAgICAgICAgICAgICAgZmlsdGVyRm4gPSBmdW5jdGlvbiggbm9kZSApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gICBub2RlLm5vZGVUeXBlID09IDEgPyAhZG9tVXRpbHMuaXNCb29rbWFya05vZGUobm9kZSkgOiAhZG9tVXRpbHMuaXNXaGl0ZXNwYWNlKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuXHJcbiAgICAgICAgICAgICAgICBvYmogPSBnZXRPYmooIGVkaXRvciApO1xyXG5cclxuICAgICAgICAgICAgaWYgKCBvYmogJiYgcmFuZ2UuY29sbGFwc2VkICkge1xyXG4gICAgICAgICAgICAgICAgb2JqLnNldEF0dHJpYnV0ZSggJ2RpcicsIGZvcndhcmQgKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiByYW5nZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBib29rbWFyayA9IHJhbmdlLmNyZWF0ZUJvb2ttYXJrKCk7XHJcbiAgICAgICAgICAgIHJhbmdlLmVubGFyZ2UoIHRydWUgKTtcclxuICAgICAgICAgICAgdmFyIGJvb2ttYXJrMiA9IHJhbmdlLmNyZWF0ZUJvb2ttYXJrKCksXHJcbiAgICAgICAgICAgICAgICBjdXJyZW50ID0gZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoIGJvb2ttYXJrMi5zdGFydCwgZmFsc2UsIGZpbHRlckZuICksXHJcbiAgICAgICAgICAgICAgICB0bXBSYW5nZSA9IHJhbmdlLmNsb25lUmFuZ2UoKSxcclxuICAgICAgICAgICAgICAgIHRtcE5vZGU7XHJcbiAgICAgICAgICAgIHdoaWxlICggY3VycmVudCAmJiAgIShkb21VdGlscy5nZXRQb3NpdGlvbiggY3VycmVudCwgYm9va21hcmsyLmVuZCApICYgZG9tVXRpbHMuUE9TSVRJT05fRk9MTE9XSU5HKSApIHtcclxuICAgICAgICAgICAgICAgIGlmICggY3VycmVudC5ub2RlVHlwZSA9PSAzIHx8ICFibG9jayggY3VycmVudCApICkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRtcFJhbmdlLnNldFN0YXJ0QmVmb3JlKCBjdXJyZW50ICk7XHJcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKCBjdXJyZW50ICYmIGN1cnJlbnQgIT09IGJvb2ttYXJrMi5lbmQgJiYgIWJsb2NrKCBjdXJyZW50ICkgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRtcE5vZGUgPSBjdXJyZW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoIGN1cnJlbnQsIGZhbHNlLCBudWxsLCBmdW5jdGlvbiggbm9kZSApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhYmxvY2soIG5vZGUgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB0bXBSYW5nZS5zZXRFbmRBZnRlciggdG1wTm9kZSApO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjb21tb24gPSB0bXBSYW5nZS5nZXRDb21tb25BbmNlc3RvcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICggIWRvbVV0aWxzLmlzQm9keSggY29tbW9uICkgJiYgYmxvY2soIGNvbW1vbiApICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL+mBjeWOhuWIsOS6hmJsb2Nr6IqC54K5XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1vbi5zZXRBdHRyaWJ1dGUoICdkaXInLCBmb3J3YXJkICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjb21tb247XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy/msqHmnInpgY3ljobliLDvvIzmt7vliqDkuIDkuKpibG9ja+iKgueCuVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcCA9IHJhbmdlLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdwJyApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwLnNldEF0dHJpYnV0ZSggJ2RpcicsIGZvcndhcmQgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZyYWcgPSB0bXBSYW5nZS5leHRyYWN0Q29udGVudHMoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcC5hcHBlbmRDaGlsZCggZnJhZyApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bXBSYW5nZS5pbnNlcnROb2RlKCBwICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBwO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGRvbVV0aWxzLmdldE5leHREb21Ob2RlKCBjdXJyZW50LCBmYWxzZSwgZmlsdGVyRm4gKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGRvbVV0aWxzLmdldE5leHREb21Ob2RlKCBjdXJyZW50LCB0cnVlLCBmaWx0ZXJGbiApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiByYW5nZS5tb3ZlVG9Cb29rbWFyayggYm9va21hcmsyICkubW92ZVRvQm9va21hcmsoIGJvb2ttYXJrICk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOaWh+Wtl+i+k+WFpeaWueWQkVxyXG4gICAgICogQGNvbW1hbmQgZGlyZWN0aW9uYWxpdHlcclxuICAgICAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZE5hbWUg5ZG95Luk5a2X56ym5LiyXHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBmb3J3YXJkIOS8oOWFpSdsdHIn6KGo56S65LuO5bem5ZCR5Y+z6L6T5YWl77yM5Lyg5YWlJ3J0bCfooajnpLrku47lj7PlkJHlt6bovpPlhaVcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiBlZGl0b3IuZXhlY0NvbW1hbmQoICdkaXJlY3Rpb25hbGl0eScsICdsdHInKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmn6Xor6LlvZPliY3pgInljLrnmoTmloflrZfovpPlhaXmlrnlkJFcclxuICAgICAqIEBjb21tYW5kIGRpcmVjdGlvbmFsaXR5XHJcbiAgICAgKiBAbWV0aG9kIHF1ZXJ5Q29tbWFuZFZhbHVlXHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWROYW1lIOWRveS7pOWtl+espuS4slxyXG4gICAgICogQHJldHVybiB7IFN0cmluZyB9IOi/lOWbnidsdHIn6KGo56S65LuO5bem5ZCR5Y+z6L6T5YWl77yM6L+U5ZueJ3J0bCfooajnpLrku47lj7PlkJHlt6bovpPlhaVcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiBlZGl0b3IucXVlcnlDb21tYW5kVmFsdWUoICdkaXJlY3Rpb25hbGl0eScpO1xyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIFVFLmNvbW1hbmRzWydkaXJlY3Rpb25hbGl0eSddID0ge1xyXG4gICAgICAgIGV4ZWNDb21tYW5kIDogZnVuY3Rpb24oIGNtZE5hbWUsZm9yd2FyZCApIHtcclxuICAgICAgICAgICAgdmFyIHJhbmdlID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuICAgICAgICAgICAgLy/pl63lkIjml7bljZXni6zlpITnkIZcclxuICAgICAgICAgICAgaWYocmFuZ2UuY29sbGFwc2VkKXtcclxuICAgICAgICAgICAgICAgIHZhciB0eHQgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCdkJyk7XHJcbiAgICAgICAgICAgICAgICByYW5nZS5pbnNlcnROb2RlKHR4dCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZG9EaXJlY3Rpb25hbGl0eShyYW5nZSx0aGlzLGZvcndhcmQpO1xyXG4gICAgICAgICAgICBpZih0eHQpe1xyXG4gICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnRCZWZvcmUodHh0KS5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZSh0eHQpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByYW5nZS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBxdWVyeUNvbW1hbmRWYWx1ZSA6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICB2YXIgbm9kZSA9IGdldE9iaih0aGlzKTtcclxuICAgICAgICAgICAgcmV0dXJuIG5vZGUgPyBub2RlLmdldEF0dHJpYnV0ZSgnZGlyJykgOiAnbHRyJztcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59KSgpO1xyXG5cclxuXG5cbi8vIHBsdWdpbnMvaG9yaXpvbnRhbC5qc1xuLyoqXHJcbiAqIOaPkuWFpeWIhuWJsue6v+aPkuS7tlxyXG4gKiBAZmlsZVxyXG4gKiBAc2luY2UgMS4yLjYuMVxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiDmj5LlhaXliIblibLnur9cclxuICogQGNvbW1hbmQgaG9yaXpvbnRhbFxyXG4gKiBAbWV0aG9kIGV4ZWNDb21tYW5kXHJcbiAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZE5hbWUg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnaG9yaXpvbnRhbCcgKTtcclxuICogYGBgXHJcbiAqL1xyXG5VRS5wbHVnaW5zWydob3Jpem9udGFsJ10gPSBmdW5jdGlvbigpe1xyXG4gICAgdmFyIG1lID0gdGhpcztcclxuICAgIG1lLmNvbW1hbmRzWydob3Jpem9udGFsJ10gPSB7XHJcbiAgICAgICAgZXhlY0NvbW1hbmQgOiBmdW5jdGlvbiggY21kTmFtZSApIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcclxuICAgICAgICAgICAgaWYobWUucXVlcnlDb21tYW5kU3RhdGUoY21kTmFtZSkhPT0tMSl7XHJcbiAgICAgICAgICAgICAgICBtZS5leGVjQ29tbWFuZCgnaW5zZXJ0SHRtbCcsJzxocj4nKTtcclxuICAgICAgICAgICAgICAgIHZhciByYW5nZSA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxyXG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gcmFuZ2Uuc3RhcnRDb250YWluZXI7XHJcbiAgICAgICAgICAgICAgICBpZihzdGFydC5ub2RlVHlwZSA9PSAxICYmICFzdGFydC5jaGlsZE5vZGVzW3JhbmdlLnN0YXJ0T2Zmc2V0XSApe1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB2YXIgdG1wO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKHRtcCA9IHN0YXJ0LmNoaWxkTm9kZXNbcmFuZ2Uuc3RhcnRPZmZzZXQgLSAxXSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRtcC5ub2RlVHlwZSA9PSAxICYmIHRtcC50YWdOYW1lID09ICdIUicpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobWUub3B0aW9ucy5lbnRlclRhZyA9PSAncCcpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcCA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5pbnNlcnROb2RlKHRtcCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQodG1wLDApLnNldEN1cnNvcigpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcCA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2JyJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UuaW5zZXJ0Tm9kZSh0bXApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0QmVmb3JlKHRtcCkuc2V0Q3Vyc29yKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSxcclxuICAgICAgICAvL+i+ueeVjOWcqHRhYmxl6YeM5LiN6IO95Yqg5YiG6ZqU57q/XHJcbiAgICAgICAgcXVlcnlDb21tYW5kU3RhdGUgOiBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGRvbVV0aWxzLmZpbHRlck5vZGVMaXN0KHRoaXMuc2VsZWN0aW9uLmdldFN0YXJ0RWxlbWVudFBhdGgoKSwndGFibGUnKSA/IC0xIDogMDtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4vLyAgICBtZS5hZGRMaXN0ZW5lcignZGVsa2V5dXAnLGZ1bmN0aW9uKCl7XHJcbi8vICAgICAgICB2YXIgcm5nID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuLy8gICAgICAgIGlmKGJyb3dzZXIuaWUgJiYgYnJvd3Nlci52ZXJzaW9uID4gOCl7XHJcbi8vICAgICAgICAgICAgcm5nLnR4dFRvRWxtQm91bmRhcnkodHJ1ZSk7XHJcbi8vICAgICAgICAgICAgaWYoZG9tVXRpbHMuaXNTdGFydEluYmxvY2socm5nKSl7XHJcbi8vICAgICAgICAgICAgICAgIHZhciB0bXBOb2RlID0gcm5nLnN0YXJ0Q29udGFpbmVyO1xyXG4vLyAgICAgICAgICAgICAgICB2YXIgcHJlID0gdG1wTm9kZS5wcmV2aW91c1NpYmxpbmc7XHJcbi8vICAgICAgICAgICAgICAgIGlmKHByZSAmJiBkb21VdGlscy5pc1RhZ05vZGUocHJlLCdocicpKXtcclxuLy8gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShwcmUpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgcm5nLnNlbGVjdCgpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4vLyAgICAgICAgICAgICAgICB9XHJcbi8vICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgfVxyXG4vLyAgICAgICAgaWYoZG9tVXRpbHMuaXNCb2R5KHJuZy5zdGFydENvbnRhaW5lcikpe1xyXG4vLyAgICAgICAgICAgIHZhciBociA9IHJuZy5zdGFydENvbnRhaW5lci5jaGlsZE5vZGVzW3JuZy5zdGFydE9mZnNldCAtMV07XHJcbi8vICAgICAgICAgICAgaWYoaHIgJiYgaHIubm9kZU5hbWUgPT0gJ0hSJyl7XHJcbi8vICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gaHIubmV4dFNpYmxpbmc7XHJcbi8vICAgICAgICAgICAgICAgIGlmKG5leHQpe1xyXG4vLyAgICAgICAgICAgICAgICAgICAgcm5nLnNldFN0YXJ0KG5leHQsMClcclxuLy8gICAgICAgICAgICAgICAgfWVsc2UgaWYoaHIucHJldmlvdXNTaWJsaW5nKXtcclxuLy8gICAgICAgICAgICAgICAgICAgIHJuZy5zZXRTdGFydEF0TGFzdChoci5wcmV2aW91c1NpYmxpbmcpXHJcbi8vICAgICAgICAgICAgICAgIH1lbHNle1xyXG4vLyAgICAgICAgICAgICAgICAgICAgdmFyIHAgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuLy8gICAgICAgICAgICAgICAgICAgIGhyLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHAsaHIpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuZmlsbE5vZGUodGhpcy5kb2N1bWVudCxwKTtcclxuLy8gICAgICAgICAgICAgICAgICAgIHJuZy5zZXRTdGFydChwLDApO1xyXG4vLyAgICAgICAgICAgICAgICB9XHJcbi8vICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShocik7XHJcbi8vICAgICAgICAgICAgICAgIHJuZy5zZXRDdXJzb3IoZmFsc2UsdHJ1ZSk7XHJcbi8vICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgfVxyXG4vLyAgICB9KVxyXG4gICAgbWUuYWRkTGlzdGVuZXIoJ2RlbGtleWRvd24nLGZ1bmN0aW9uKG5hbWUsZXZ0KXtcclxuICAgICAgICB2YXIgcm5nID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuICAgICAgICBybmcudHh0VG9FbG1Cb3VuZGFyeSh0cnVlKTtcclxuICAgICAgICBpZihkb21VdGlscy5pc1N0YXJ0SW5ibG9jayhybmcpKXtcclxuICAgICAgICAgICAgdmFyIHRtcE5vZGUgPSBybmcuc3RhcnRDb250YWluZXI7XHJcbiAgICAgICAgICAgIHZhciBwcmUgPSB0bXBOb2RlLnByZXZpb3VzU2libGluZztcclxuICAgICAgICAgICAgaWYocHJlICYmIGRvbVV0aWxzLmlzVGFnTm9kZShwcmUsJ2hyJykpe1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHByZSk7XHJcbiAgICAgICAgICAgICAgICBybmcuc2VsZWN0KCk7XHJcbiAgICAgICAgICAgICAgICBkb21VdGlscy5wcmV2ZW50RGVmYXVsdChldnQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH0pXHJcbn07XHJcblxyXG5cblxuLy8gcGx1Z2lucy90aW1lLmpzXG4vKipcclxuICog5o+S5YWl5pe26Ze05ZKM5pel5pyfXHJcbiAqIEBmaWxlXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIOaPkuWFpeaXtumXtO+8jOm7mOiupOagvOW8j++8mjEyOjU5OjU5XHJcbiAqIEBjb21tYW5kIHRpbWVcclxuICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogZWRpdG9yLmV4ZWNDb21tYW5kKCAndGltZScpO1xyXG4gKiBgYGBcclxuICovXHJcblxyXG4vKipcclxuICog5o+S5YWl5pel5pyf77yM6buY6K6k5qC85byP77yaMjAxMy0wOC0zMFxyXG4gKiBAY29tbWFuZCBkYXRlXHJcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGBqYXZhc2NyaXB0XHJcbiAqIGVkaXRvci5leGVjQ29tbWFuZCggJ2RhdGUnKTtcclxuICogYGBgXHJcbiAqL1xyXG5VRS5jb21tYW5kc1sndGltZSddID0gVUUuY29tbWFuZHNbXCJkYXRlXCJdID0ge1xyXG4gICAgZXhlY0NvbW1hbmQgOiBmdW5jdGlvbihjbWQsIGZvcm1hdCl7XHJcbiAgICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gZm9ybWF0VGltZShkYXRlLCBmb3JtYXQpIHtcclxuICAgICAgICAgICAgdmFyIGhoID0gKCcwJyArIGRhdGUuZ2V0SG91cnMoKSkuc2xpY2UoLTIpLFxyXG4gICAgICAgICAgICAgICAgaWkgPSAoJzAnICsgZGF0ZS5nZXRNaW51dGVzKCkpLnNsaWNlKC0yKSxcclxuICAgICAgICAgICAgICAgIHNzID0gKCcwJyArIGRhdGUuZ2V0U2Vjb25kcygpKS5zbGljZSgtMik7XHJcbiAgICAgICAgICAgIGZvcm1hdCA9IGZvcm1hdCB8fCAnaGg6aWk6c3MnO1xyXG4gICAgICAgICAgICByZXR1cm4gZm9ybWF0LnJlcGxhY2UoL2hoL2lnLCBoaCkucmVwbGFjZSgvaWkvaWcsIGlpKS5yZXBsYWNlKC9zcy9pZywgc3MpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmdW5jdGlvbiBmb3JtYXREYXRlKGRhdGUsIGZvcm1hdCkge1xyXG4gICAgICAgICAgICB2YXIgeXl5eSA9ICgnMDAwJyArIGRhdGUuZ2V0RnVsbFllYXIoKSkuc2xpY2UoLTQpLFxyXG4gICAgICAgICAgICAgICAgeXkgPSB5eXl5LnNsaWNlKC0yKSxcclxuICAgICAgICAgICAgICAgIG1tID0gKCcwJyArIChkYXRlLmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKSxcclxuICAgICAgICAgICAgICAgIGRkID0gKCcwJyArIGRhdGUuZ2V0RGF0ZSgpKS5zbGljZSgtMik7XHJcbiAgICAgICAgICAgIGZvcm1hdCA9IGZvcm1hdCB8fCAneXl5eS1tbS1kZCc7XHJcbiAgICAgICAgICAgIHJldHVybiBmb3JtYXQucmVwbGFjZSgveXl5eS9pZywgeXl5eSkucmVwbGFjZSgveXkvaWcsIHl5KS5yZXBsYWNlKC9tbS9pZywgbW0pLnJlcGxhY2UoL2RkL2lnLCBkZCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmV4ZWNDb21tYW5kKCdpbnNlcnRIdG1sJyxjbWQgPT0gXCJ0aW1lXCIgPyBmb3JtYXRUaW1lKGRhdGUsIGZvcm1hdCk6Zm9ybWF0RGF0ZShkYXRlLCBmb3JtYXQpICk7XHJcbiAgICB9XHJcbn07XHJcblxuXG4vLyBwbHVnaW5zL3Jvd3NwYWNpbmcuanNcbi8qKlxyXG4gKiDmrrXliY3mrrXlkI7pl7Tot53mj5Lku7ZcclxuICogQGZpbGVcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG4vKipcclxuICog6K6+572u5q616Ze06LedXHJcbiAqIEBjb21tYW5kIHJvd3NwYWNpbmdcclxuICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEBwYXJhbSB7IFN0cmluZyB9IHZhbHVlIOautemXtOi3neeahOWAvO+8jOS7pXB45Li65Y2V5L2NXHJcbiAqIEBwYXJhbSB7IFN0cmluZyB9IGRpciDpl7Tot53kvY3nva7vvIx0b3DmiJZib3R0b23vvIzliIbliKvooajnpLrmrrXliY3lkozmrrXlkI5cclxuICogQGV4YW1wbGVcclxuICogYGBgamF2YXNjcmlwdFxyXG4gKiBlZGl0b3IuZXhlY0NvbW1hbmQoICdyb3dzcGFjaW5nJywgJzEwJywgJ3RvcCcgKTtcclxuICogYGBgXHJcbiAqL1xyXG5cclxuVUUucGx1Z2luc1sncm93c3BhY2luZyddID0gZnVuY3Rpb24oKXtcclxuICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICBtZS5zZXRPcHQoe1xyXG4gICAgICAgICdyb3dzcGFjaW5ndG9wJzpbJzUnLCAnMTAnLCAnMTUnLCAnMjAnLCAnMjUnXSxcclxuICAgICAgICAncm93c3BhY2luZ2JvdHRvbSc6Wyc1JywgJzEwJywgJzE1JywgJzIwJywgJzI1J11cclxuXHJcbiAgICB9KTtcclxuICAgIG1lLmNvbW1hbmRzWydyb3dzcGFjaW5nJ10gPSAge1xyXG4gICAgICAgIGV4ZWNDb21tYW5kIDogZnVuY3Rpb24oIGNtZE5hbWUsdmFsdWUsZGlyICkge1xyXG4gICAgICAgICAgICB0aGlzLmV4ZWNDb21tYW5kKCdwYXJhZ3JhcGgnLCdwJyx7c3R5bGU6J21hcmdpbi0nK2RpcisnOicrdmFsdWUgKyAncHgnfSk7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcXVlcnlDb21tYW5kVmFsdWUgOiBmdW5jdGlvbihjbWROYW1lLGRpcikge1xyXG4gICAgICAgICAgICB2YXIgcE4gPSBkb21VdGlscy5maWx0ZXJOb2RlTGlzdCh0aGlzLnNlbGVjdGlvbi5nZXRTdGFydEVsZW1lbnRQYXRoKCksZnVuY3Rpb24obm9kZSl7cmV0dXJuIGRvbVV0aWxzLmlzQmxvY2tFbG0obm9kZSkgfSksXHJcbiAgICAgICAgICAgICAgICB2YWx1ZTtcclxuICAgICAgICAgICAgLy90cmFjZToxMDI2XHJcbiAgICAgICAgICAgIGlmKHBOKXtcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZShwTiwnbWFyZ2luLScrZGlyKS5yZXBsYWNlKC9bXlxcZF0vZywnJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gIXZhbHVlID8gMCA6IHZhbHVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG5cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59O1xyXG5cclxuXHJcblxuXG4vLyBwbHVnaW5zL2xpbmVoZWlnaHQuanNcbi8qKlxyXG4gKiDorr7nva7ooYzlhoXpl7Tot51cclxuICogQGZpbGVcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblVFLnBsdWdpbnNbJ2xpbmVoZWlnaHQnXSA9IGZ1bmN0aW9uKCl7XHJcbiAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgbWUuc2V0T3B0KHsnbGluZWhlaWdodCc6WycxJywgJzEuNScsJzEuNzUnLCcyJywgJzMnLCAnNCcsICc1J119KTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOihjOi3nVxyXG4gICAgICogQGNvbW1hbmQgbGluZWhlaWdodFxyXG4gICAgICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gY21kTmFtZSDlkb3ku6TlrZfnrKbkuLJcclxuICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IHZhbHVlIOS8oOWFpeeahOihjOmrmOWAvO+8jCDor6XlgLzmmK/lvZPliY3lrZfkvZPnmoTlgI3mlbDvvIwg5L6L5aaC77yaIDEuNSwgMS43NVxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIGVkaXRvci5leGVjQ29tbWFuZCggJ2xpbmVoZWlnaHQnLCAxLjUpO1xyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIC8qKlxyXG4gICAgICog5p+l6K+i5b2T5YmN6YCJ5Yy65YaF5a6555qE6KGM6auY5aSn5bCPXHJcbiAgICAgKiBAY29tbWFuZCBsaW5laGVpZ2h0XHJcbiAgICAgKiBAbWV0aG9kIHF1ZXJ5Q29tbWFuZFZhbHVlXHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAgICAgKiBAcmV0dXJuIHsgU3RyaW5nIH0g6L+U5Zue5b2T5YmN6KGM6auY5aSn5bCPXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogZWRpdG9yLnF1ZXJ5Q29tbWFuZFZhbHVlKCAnbGluZWhlaWdodCcgKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgbWUuY29tbWFuZHNbJ2xpbmVoZWlnaHQnXSA9ICB7XHJcbiAgICAgICAgZXhlY0NvbW1hbmQgOiBmdW5jdGlvbiggY21kTmFtZSx2YWx1ZSApIHtcclxuICAgICAgICAgICAgdGhpcy5leGVjQ29tbWFuZCgncGFyYWdyYXBoJywncCcse3N0eWxlOidsaW5lLWhlaWdodDonKyAodmFsdWUgPT0gXCIxXCIgPyBcIm5vcm1hbFwiIDogdmFsdWUgKyAnZW0nKSB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBxdWVyeUNvbW1hbmRWYWx1ZSA6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICB2YXIgcE4gPSBkb21VdGlscy5maWx0ZXJOb2RlTGlzdCh0aGlzLnNlbGVjdGlvbi5nZXRTdGFydEVsZW1lbnRQYXRoKCksZnVuY3Rpb24obm9kZSl7cmV0dXJuIGRvbVV0aWxzLmlzQmxvY2tFbG0obm9kZSl9KTtcclxuICAgICAgICAgICAgaWYocE4pe1xyXG4gICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZShwTiwnbGluZS1oZWlnaHQnKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSAnbm9ybWFsJyA/IDEgOiB2YWx1ZS5yZXBsYWNlKC9bXlxcZC5dKi9pZyxcIlwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbn07XHJcblxyXG5cclxuXG5cbi8vIHBsdWdpbnMvaW5zZXJ0Y29kZS5qc1xuLyoqXG4gKiDmj5LlhaXku6PnoIHmj5Lku7ZcbiAqIEBmaWxlXG4gKiBAc2luY2UgMS4yLjYuMVxuICovXG5cblVFLnBsdWdpbnNbJ2luc2VydGNvZGUnXSA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciBtZSA9IHRoaXM7XG4gICAgbWUucmVhZHkoZnVuY3Rpb24oKXtcbiAgICAgICAgdXRpbHMuY3NzUnVsZSgncHJlJywncHJle21hcmdpbjouNWVtIDA7cGFkZGluZzouNGVtIC42ZW07Ym9yZGVyLXJhZGl1czo4cHg7YmFja2dyb3VuZDojZjhmOGY4O30nLFxuICAgICAgICAgICAgbWUuZG9jdW1lbnQpXG4gICAgfSk7XG4gICAgbWUuc2V0T3B0KCdpbnNlcnRjb2RlJyx7XG4gICAgICAgICAgICAnYXMzJzonQWN0aW9uU2NyaXB0MycsXG4gICAgICAgICAgICAnYmFzaCc6J0Jhc2gvU2hlbGwnLFxuICAgICAgICAgICAgJ2NwcCc6J0MvQysrJyxcbiAgICAgICAgICAgICdjc3MnOidDc3MnLFxuICAgICAgICAgICAgJ2NmJzonQ29kZUZ1bmN0aW9uJyxcbiAgICAgICAgICAgICdjIyc6J0MjJyxcbiAgICAgICAgICAgICdkZWxwaGknOidEZWxwaGknLFxuICAgICAgICAgICAgJ2RpZmYnOidEaWZmJyxcbiAgICAgICAgICAgICdlcmxhbmcnOidFcmxhbmcnLFxuICAgICAgICAgICAgJ2dyb292eSc6J0dyb292eScsXG4gICAgICAgICAgICAnaHRtbCc6J0h0bWwnLFxuICAgICAgICAgICAgJ2phdmEnOidKYXZhJyxcbiAgICAgICAgICAgICdqZngnOidKYXZhRngnLFxuICAgICAgICAgICAgJ2pzJzonSmF2YXNjcmlwdCcsXG4gICAgICAgICAgICAncGwnOidQZXJsJyxcbiAgICAgICAgICAgICdwaHAnOidQaHAnLFxuICAgICAgICAgICAgJ3BsYWluJzonUGxhaW4gVGV4dCcsXG4gICAgICAgICAgICAncHMnOidQb3dlclNoZWxsJyxcbiAgICAgICAgICAgICdweXRob24nOidQeXRob24nLFxuICAgICAgICAgICAgJ3J1YnknOidSdWJ5JyxcbiAgICAgICAgICAgICdzY2FsYSc6J1NjYWxhJyxcbiAgICAgICAgICAgICdzcWwnOidTcWwnLFxuICAgICAgICAgICAgJ3ZiJzonVmInLFxuICAgICAgICAgICAgJ3htbCc6J1htbCdcbiAgICB9KTtcblxuICAgIC8qKlxuICAgICAqIOaPkuWFpeS7o+eggVxuICAgICAqIEBjb21tYW5kIGluc2VydGNvZGVcbiAgICAgKiBAbWV0aG9kIGV4ZWNDb21tYW5kXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxuICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGxhbmcg5o+S5YWl5Luj56CB55qE6K+t6KiAXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnaW5zZXJ0Y29kZScsICdqYXZhc2NyaXB0JyApO1xuICAgICAqIGBgYFxuICAgICAqL1xuXG4gICAgLyoqXG4gICAgICog5aaC5p6c6YCJ5Yy65omA5Zyo5L2N572u5piv5o+S5YWl5o+S5YWl5Luj56CB5Yy65Z+f77yM6L+U5Zue5Luj56CB55qE6K+t6KiAXG4gICAgICogQGNvbW1hbmQgaW5zZXJ0Y29kZVxuICAgICAqIEBtZXRob2QgcXVlcnlDb21tYW5kVmFsdWVcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXG4gICAgICogQHJldHVybiB7IFN0cmluZyB9IOi/lOWbnuS7o+eggeeahOivreiogFxuICAgICAqIEBleGFtcGxlXG4gICAgICogYGBgamF2YXNjcmlwdFxuICAgICAqIGVkaXRvci5xdWVyeUNvbW1hbmRWYWx1ZSggJ2luc2VydGNvZGUnICk7XG4gICAgICogYGBgXG4gICAgICovXG5cbiAgICBtZS5jb21tYW5kc1snaW5zZXJ0Y29kZSddID0ge1xuICAgICAgICBleGVjQ29tbWFuZCA6IGZ1bmN0aW9uKGNtZCxsYW5nKXtcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXG4gICAgICAgICAgICAgICAgcm5nID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCksXG4gICAgICAgICAgICAgICAgcHJlID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShybmcuc3RhcnRDb250YWluZXIsJ3ByZScsdHJ1ZSk7XG4gICAgICAgICAgICBpZihwcmUpe1xuICAgICAgICAgICAgICAgIHByZS5jbGFzc05hbWUgPSAnYnJ1c2g6JytsYW5nKyc7dG9vbGJhcjpmYWxzZTsnO1xuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgdmFyIGNvZGUgPSAnJztcbiAgICAgICAgICAgICAgICBpZihybmcuY29sbGFwc2VkKXtcbiAgICAgICAgICAgICAgICAgICAgY29kZSA9IGJyb3dzZXIuaWUgJiYgYnJvd3Nlci5pZTExYmVsb3cgPyAoYnJvd3Nlci52ZXJzaW9uIDw9IDggPyAnJm5ic3A7JzonJyk6Jzxici8+JztcbiAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZyYWcgPSBybmcuZXh0cmFjdENvbnRlbnRzKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBkaXYgPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgICAgICAgICAgICAgZGl2LmFwcGVuZENoaWxkKGZyYWcpO1xuXG4gICAgICAgICAgICAgICAgICAgIHV0aWxzLmVhY2goVUUuZmlsdGVyTm9kZShVRS5odG1scGFyc2VyKGRpdi5pbm5lckhUTUwucmVwbGFjZSgvW1xcclxcdF0vZywnJykpLG1lLm9wdGlvbnMuZmlsdGVyVHh0UnVsZXMpLmNoaWxkcmVuLGZ1bmN0aW9uKG5vZGUpe1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYoYnJvd3Nlci5pZSAmJiBicm93c2VyLmllMTFiZWxvdyAmJiBicm93c2VyLnZlcnNpb24gPiA4KXtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5vZGUudHlwZSA9PSdlbGVtZW50Jyl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5vZGUudGFnTmFtZSA9PSAnYnInKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUgKz0gJ1xcbidcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYoIWR0ZC4kZW1wdHlbbm9kZS50YWdOYW1lXSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1dGlscy5lYWNoKG5vZGUuY2hpbGRyZW4sZnVuY3Rpb24oY24pe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGNuLnR5cGUgPT0nZWxlbWVudCcpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihjbi50YWdOYW1lID09ICdicicpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZSArPSAnXFxuJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZighZHRkLiRlbXB0eVtub2RlLnRhZ05hbWVdKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUgKz0gY24uaW5uZXJUZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZSArPSBjbi5kYXRhXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCEvXFxuJC8udGVzdChjb2RlKSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZSArPSAnXFxuJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlICs9IG5vZGUuZGF0YSArICdcXG4nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFub2RlLm5leHRTaWJsaW5nKCkgJiYgL1xcbiQvLnRlc3QoY29kZSkpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlID0gY29kZS5yZXBsYWNlKC9cXG4kLywnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoYnJvd3Nlci5pZSAmJiBicm93c2VyLmllMTFiZWxvdyl7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobm9kZS50eXBlID09J2VsZW1lbnQnKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5vZGUudGFnTmFtZSA9PSAnYnInKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlICs9ICc8YnI+J1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYoIWR0ZC4kZW1wdHlbbm9kZS50YWdOYW1lXSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXRpbHMuZWFjaChub2RlLmNoaWxkcmVuLGZ1bmN0aW9uKGNuKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoY24udHlwZSA9PSdlbGVtZW50Jyl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihjbi50YWdOYW1lID09ICdicicpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUgKz0gJzxicj4nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZighZHRkLiRlbXB0eVtub2RlLnRhZ05hbWVdKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlICs9IGNuLmlubmVyVGV4dCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUgKz0gY24uZGF0YVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIS9icj4kLy50ZXN0KGNvZGUpKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZSArPSAnPGJyPic7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUgKz0gbm9kZS5kYXRhICsgJzxicj4nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIW5vZGUubmV4dFNpYmxpbmcoKSAmJiAvPGJyPiQvLnRlc3QoY29kZSkpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZSA9IGNvZGUucmVwbGFjZSgvPGJyPiQvLCcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUgKz0gKG5vZGUudHlwZSA9PSAnZWxlbWVudCcgPyAoZHRkLiRlbXB0eVtub2RlLnRhZ05hbWVdID8gICcnIDogbm9kZS5pbm5lclRleHQoKSkgOiBub2RlLmRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighL2JyXFwvP1xccyo+JC8udGVzdChjb2RlKSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighbm9kZS5uZXh0U2libGluZygpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGUgKz0gJzxicj4nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbWUuZXhlY0NvbW1hbmQoJ2luc2VydGh0bWwnLCc8cHJlIGlkPVwiY29kZXJcImNsYXNzPVwiYnJ1c2g6JytsYW5nKyc7dG9vbGJhcjpmYWxzZVwiPicrY29kZSsnPC9wcmU+Jyx0cnVlKTtcblxuICAgICAgICAgICAgICAgIHByZSA9IG1lLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb2RlcicpO1xuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZUF0dHJpYnV0ZXMocHJlLCdpZCcpO1xuICAgICAgICAgICAgICAgIHZhciB0bXBOb2RlID0gcHJlLnByZXZpb3VzU2libGluZztcblxuICAgICAgICAgICAgICAgIGlmKHRtcE5vZGUgJiYgKHRtcE5vZGUubm9kZVR5cGUgPT0gMyAmJiB0bXBOb2RlLm5vZGVWYWx1ZS5sZW5ndGggPT0gMSAmJiBicm93c2VyLmllICYmIGJyb3dzZXIudmVyc2lvbiA9PSA2IHx8ICBkb21VdGlscy5pc0VtcHR5QmxvY2sodG1wTm9kZSkpKXtcblxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUodG1wTm9kZSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIHJuZyA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xuICAgICAgICAgICAgICAgIGlmKGRvbVV0aWxzLmlzRW1wdHlCbG9jayhwcmUpKXtcbiAgICAgICAgICAgICAgICAgICAgcm5nLnNldFN0YXJ0KHByZSwwKS5zZXRDdXJzb3IoZmFsc2UsdHJ1ZSlcbiAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgcm5nLnNlbGVjdE5vZGVDb250ZW50cyhwcmUpLnNlbGVjdCgpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG5cblxuICAgICAgICB9LFxuICAgICAgICBxdWVyeUNvbW1hbmRWYWx1ZSA6IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICB2YXIgcGF0aCA9IHRoaXMuc2VsZWN0aW9uLmdldFN0YXJ0RWxlbWVudFBhdGgoKTtcbiAgICAgICAgICAgIHZhciBsYW5nID0gJyc7XG4gICAgICAgICAgICB1dGlscy5lYWNoKHBhdGgsZnVuY3Rpb24obm9kZSl7XG4gICAgICAgICAgICAgICAgaWYobm9kZS5ub2RlTmFtZSA9PSdQUkUnKXtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gbm9kZS5jbGFzc05hbWUubWF0Y2goL2JydXNoOihbXjtdKykvKTtcbiAgICAgICAgICAgICAgICAgICAgbGFuZyA9IG1hdGNoICYmIG1hdGNoWzFdID8gbWF0Y2hbMV0gOiAnJztcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGxhbmc7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgbWUuYWRkSW5wdXRSdWxlKGZ1bmN0aW9uKHJvb3Qpe1xuICAgICAgIHV0aWxzLmVhY2gocm9vdC5nZXROb2Rlc0J5VGFnTmFtZSgncHJlJyksZnVuY3Rpb24ocHJlKXtcbiAgICAgICAgICAgdmFyIGJycyA9IHByZS5nZXROb2Rlc0J5VGFnTmFtZSgnYnInKTtcbiAgICAgICAgICAgaWYoYnJzLmxlbmd0aCl7XG4gICAgICAgICAgICAgICBicm93c2VyLmllICYmIGJyb3dzZXIuaWUxMWJlbG93ICYmIGJyb3dzZXIudmVyc2lvbiA+IDggJiYgdXRpbHMuZWFjaChicnMsZnVuY3Rpb24oYnIpe1xuICAgICAgICAgICAgICAgICAgIHZhciB0eHQgPSBVRS51Tm9kZS5jcmVhdGVUZXh0KCdcXG4nKTtcbiAgICAgICAgICAgICAgICAgICBici5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0eHQsYnIpO1xuICAgICAgICAgICAgICAgICAgIGJyLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYnIpO1xuICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgIGlmKGJyb3dzZXIuaWUgJiYgYnJvd3Nlci5pZTExYmVsb3cgJiYgYnJvd3Nlci52ZXJzaW9uID4gOClcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB2YXIgY29kZSA9IHByZS5pbm5lclRleHQoKS5zcGxpdCgvXFxuLyk7XG4gICAgICAgICAgICBwcmUuaW5uZXJIVE1MKCcnKTtcbiAgICAgICAgICAgIHV0aWxzLmVhY2goY29kZSxmdW5jdGlvbihjKXtcbiAgICAgICAgICAgICAgICBpZihjLmxlbmd0aCl7XG4gICAgICAgICAgICAgICAgICAgIHByZS5hcHBlbmRDaGlsZChVRS51Tm9kZS5jcmVhdGVUZXh0KGMpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcHJlLmFwcGVuZENoaWxkKFVFLnVOb2RlLmNyZWF0ZUVsZW1lbnQoJ2JyJykpXG4gICAgICAgICAgICB9KVxuICAgICAgIH0pXG4gICAgfSk7XG4gICAgbWUuYWRkT3V0cHV0UnVsZShmdW5jdGlvbihyb290KXtcbiAgICAgICAgdXRpbHMuZWFjaChyb290LmdldE5vZGVzQnlUYWdOYW1lKCdwcmUnKSxmdW5jdGlvbihwcmUpe1xuICAgICAgICAgICAgdmFyIGNvZGUgPSAnJztcbiAgICAgICAgICAgIHV0aWxzLmVhY2gocHJlLmNoaWxkcmVuLGZ1bmN0aW9uKG4pe1xuICAgICAgICAgICAgICAgaWYobi50eXBlID09ICd0ZXh0Jyl7XG4gICAgICAgICAgICAgICAgICAgLy/lnKhpZeS4i+aWh+acrOWGheWuueacieWPr+iDveacq+WwvuW4puaciVxcbuimgeWOu+aOiVxuICAgICAgICAgICAgICAgICAgIC8vdHJhY2U6MzM5NlxuICAgICAgICAgICAgICAgICAgIGNvZGUgKz0gbi5kYXRhLnJlcGxhY2UoL1sgXS9nLCcmbmJzcDsnKS5yZXBsYWNlKC9cXG4kLywnJyk7XG4gICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICBpZihuLnRhZ05hbWUgPT0gJ2JyJyl7XG4gICAgICAgICAgICAgICAgICAgICAgIGNvZGUgICs9ICdcXG4nXG4gICAgICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgICAgIGNvZGUgKz0gKCFkdGQuJGVtcHR5W24udGFnTmFtZV0gPyAnJyA6IG4uaW5uZXJUZXh0KCkpO1xuICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcHJlLmlubmVyVGV4dChjb2RlLnJlcGxhY2UoLygmbmJzcDt8XFxuKSskLywnJykpXG4gICAgICAgIH0pXG4gICAgfSk7XG4gICAgLy/kuI3pnIDopoHliKTmlq1oaWdobGlnaHTnmoRjb21tYW5k5YiX6KGoXG4gICAgbWUubm90TmVlZENvZGVRdWVyeSA9e1xuICAgICAgICBoZWxwOjEsXG4gICAgICAgIHVuZG86MSxcbiAgICAgICAgcmVkbzoxLFxuICAgICAgICBzb3VyY2U6MSxcbiAgICAgICAgcHJpbnQ6MSxcbiAgICAgICAgc2VhcmNocmVwbGFjZToxLFxuICAgICAgICBmdWxsc2NyZWVuOjEsXG4gICAgICAgIHByZXZpZXc6MSxcbiAgICAgICAgaW5zZXJ0cGFyYWdyYXBoOjEsXG4gICAgICAgIGVsZW1lbnRwYXRoOjEsXG4gICAgICAgIGluc2VydGNvZGU6MSxcbiAgICAgICAgaW5zZXJ0aHRtbDoxLFxuICAgICAgICBzZWxlY3RhbGw6MVxuICAgIH07XG4gICAgLy/lsIZxdWV5Q29tbWFtbmRTdGF0ZemHjee9rlxuICAgIHZhciBvcmdRdWVyeSA9IG1lLnF1ZXJ5Q29tbWFuZFN0YXRlO1xuICAgIG1lLnF1ZXJ5Q29tbWFuZFN0YXRlID0gZnVuY3Rpb24oY21kKXtcbiAgICAgICAgdmFyIG1lID0gdGhpcztcblxuICAgICAgICBpZighbWUubm90TmVlZENvZGVRdWVyeVtjbWQudG9Mb3dlckNhc2UoKV0gJiYgbWUuc2VsZWN0aW9uICYmIG1lLnF1ZXJ5Q29tbWFuZFZhbHVlKCdpbnNlcnRjb2RlJykpe1xuICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBVRS5FZGl0b3IucHJvdG90eXBlLnF1ZXJ5Q29tbWFuZFN0YXRlLmFwcGx5KHRoaXMsYXJndW1lbnRzKVxuICAgIH07XG4gICAgbWUuYWRkTGlzdGVuZXIoJ2JlZm9yZWVudGVya2V5ZG93bicsZnVuY3Rpb24oKXtcbiAgICAgICAgdmFyIHJuZyA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xuICAgICAgICB2YXIgcHJlID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShybmcuc3RhcnRDb250YWluZXIsJ3ByZScsdHJ1ZSk7XG4gICAgICAgIGlmKHByZSl7XG4gICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NhdmVTY2VuZScpO1xuICAgICAgICAgICAgaWYoIXJuZy5jb2xsYXBzZWQpe1xuICAgICAgICAgICAgICAgcm5nLmRlbGV0ZUNvbnRlbnRzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZighYnJvd3Nlci5pZSB8fCBicm93c2VyLmllOWFib3ZlKXtcbiAgICAgICAgICAgICAgICB2YXIgdG1wTm9kZSA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2JyJykscHJlO1xuICAgICAgICAgICAgICAgIHJuZy5pbnNlcnROb2RlKHRtcE5vZGUpLnNldFN0YXJ0QWZ0ZXIodG1wTm9kZSkuY29sbGFwc2UodHJ1ZSk7XG4gICAgICAgICAgICAgICAgdmFyIG5leHQgPSB0bXBOb2RlLm5leHRTaWJsaW5nO1xuICAgICAgICAgICAgICAgIGlmKCFuZXh0ICYmICghYnJvd3Nlci5pZSB8fCBicm93c2VyLnZlcnNpb24gPiAxMCkpe1xuICAgICAgICAgICAgICAgICAgICBybmcuaW5zZXJ0Tm9kZSh0bXBOb2RlLmNsb25lTm9kZShmYWxzZSkpO1xuICAgICAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgICAgICBybmcuc2V0U3RhcnRBZnRlcih0bXBOb2RlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcHJlID0gdG1wTm9kZS5wcmV2aW91c1NpYmxpbmc7XG4gICAgICAgICAgICAgICAgdmFyIHRtcDtcbiAgICAgICAgICAgICAgICB3aGlsZShwcmUgKXtcbiAgICAgICAgICAgICAgICAgICAgdG1wID0gcHJlO1xuICAgICAgICAgICAgICAgICAgICBwcmUgPSBwcmUucHJldmlvdXNTaWJsaW5nO1xuICAgICAgICAgICAgICAgICAgICBpZighcHJlIHx8IHByZS5ub2RlTmFtZSA9PSAnQlInKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZSA9IHRtcDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmKHByZSl7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzdHIgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUocHJlICYmIHByZS5ub2RlTmFtZSAhPSAnQlInICYmICBuZXcgUmVnRXhwKCdeW1xcXFxzJytkb21VdGlscy5maWxsQ2hhcisnXSokJykudGVzdChwcmUubm9kZVZhbHVlKSl7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdHIgKz0gcHJlLm5vZGVWYWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZSA9IHByZS5uZXh0U2libGluZztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZihwcmUubm9kZU5hbWUgIT0gJ0JSJyl7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBwcmUubm9kZVZhbHVlLm1hdGNoKG5ldyBSZWdFeHAoJ14oW1xcXFxzJytkb21VdGlscy5maWxsQ2hhcisnXSspJykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYobWF0Y2ggJiYgbWF0Y2hbMV0pe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ciArPSBtYXRjaFsxXVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYoc3RyKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0ciA9IG1lLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHN0cik7XG4gICAgICAgICAgICAgICAgICAgICAgICBybmcuaW5zZXJ0Tm9kZShzdHIpLnNldFN0YXJ0QWZ0ZXIoc3RyKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBybmcuY29sbGFwc2UodHJ1ZSkuc2VsZWN0KHRydWUpO1xuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgaWYoYnJvd3Nlci52ZXJzaW9uID4gOCl7XG5cbiAgICAgICAgICAgICAgICAgICAgdmFyIHR4dCA9IG1lLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCdcXG4nKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0ID0gcm5nLnN0YXJ0Q29udGFpbmVyO1xuICAgICAgICAgICAgICAgICAgICBpZihybmcuc3RhcnRPZmZzZXQgPT0gMCl7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJlTm9kZSA9IHN0YXJ0LnByZXZpb3VzU2libGluZztcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHByZU5vZGUpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJuZy5pbnNlcnROb2RlKHR4dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZpbGxjaGFyID0gbWUuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJyAnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBybmcuc2V0U3RhcnRBZnRlcih0eHQpLmluc2VydE5vZGUoZmlsbGNoYXIpLnNldFN0YXJ0KGZpbGxjaGFyLDApLmNvbGxhcHNlKHRydWUpLnNlbGVjdCh0cnVlKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJuZy5pbnNlcnROb2RlKHR4dCkuc2V0U3RhcnRBZnRlcih0eHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZpbGxjaGFyID0gbWUuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJyAnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gcm5nLnN0YXJ0Q29udGFpbmVyLmNoaWxkTm9kZXNbcm5nLnN0YXJ0T2Zmc2V0XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHN0YXJ0ICYmICEvXlxcbi8udGVzdChzdGFydC5ub2RlVmFsdWUpKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBybmcuc2V0U3RhcnRCZWZvcmUodHh0KVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcm5nLmluc2VydE5vZGUoZmlsbGNoYXIpLnNldFN0YXJ0KGZpbGxjaGFyLDApLmNvbGxhcHNlKHRydWUpLnNlbGVjdCh0cnVlKVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRtcE5vZGUgPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdicicpO1xuICAgICAgICAgICAgICAgICAgICBybmcuaW5zZXJ0Tm9kZSh0bXBOb2RlKTtcbiAgICAgICAgICAgICAgICAgICAgcm5nLmluc2VydE5vZGUobWUuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoZG9tVXRpbHMuZmlsbENoYXIpKTtcbiAgICAgICAgICAgICAgICAgICAgcm5nLnNldFN0YXJ0QWZ0ZXIodG1wTm9kZSk7XG4gICAgICAgICAgICAgICAgICAgIHByZSA9IHRtcE5vZGUucHJldmlvdXNTaWJsaW5nO1xuICAgICAgICAgICAgICAgICAgICB2YXIgdG1wO1xuICAgICAgICAgICAgICAgICAgICB3aGlsZShwcmUgKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRtcCA9IHByZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZSA9IHByZS5wcmV2aW91c1NpYmxpbmc7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZighcHJlIHx8IHByZS5ub2RlTmFtZSA9PSAnQlInKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUgPSB0bXA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYocHJlKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdHIgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKHByZSAmJiBwcmUubm9kZU5hbWUgIT0gJ0JSJyAmJiAgbmV3IFJlZ0V4cCgnXlsgJytkb21VdGlscy5maWxsQ2hhcisnXSokJykudGVzdChwcmUubm9kZVZhbHVlKSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyICs9IHByZS5ub2RlVmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlID0gcHJlLm5leHRTaWJsaW5nO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYocHJlLm5vZGVOYW1lICE9ICdCUicpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IHByZS5ub2RlVmFsdWUubWF0Y2gobmV3IFJlZ0V4cCgnXihbICcrZG9tVXRpbHMuZmlsbENoYXIrJ10rKScpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihtYXRjaCAmJiBtYXRjaFsxXSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0ciArPSBtYXRjaFsxXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBtZS5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShzdHIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcm5nLmluc2VydE5vZGUoc3RyKS5zZXRTdGFydEFmdGVyKHN0cik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcm5nLmNvbGxhcHNlKHRydWUpLnNlbGVjdCgpO1xuICAgICAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NhdmVTY2VuZScpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuXG4gICAgfSk7XG5cbiAgICBtZS5hZGRMaXN0ZW5lcigndGFia2V5ZG93bicsZnVuY3Rpb24oY21kLGV2dCl7XG4gICAgICAgIHZhciBybmcgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcbiAgICAgICAgdmFyIHByZSA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocm5nLnN0YXJ0Q29udGFpbmVyLCdwcmUnLHRydWUpO1xuICAgICAgICBpZihwcmUpe1xuICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdzYXZlU2NlbmUnKTtcbiAgICAgICAgICAgIGlmKGV2dC5zaGlmdEtleSl7XG5cbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIGlmKCFybmcuY29sbGFwc2VkKXtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJrID0gcm5nLmNyZWF0ZUJvb2ttYXJrKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IGJrLnN0YXJ0LnByZXZpb3VzU2libGluZztcblxuICAgICAgICAgICAgICAgICAgICB3aGlsZShzdGFydCl7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihwcmUuZmlyc3RDaGlsZCA9PT0gc3RhcnQgJiYgIWRvbVV0aWxzLmlzQnIoc3RhcnQpKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUuaW5zZXJ0QmVmb3JlKG1lLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCcgICAgJyksc3RhcnQpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihkb21VdGlscy5pc0JyKHN0YXJ0KSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlLmluc2VydEJlZm9yZShtZS5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnICAgICcpLHN0YXJ0Lm5leHRTaWJsaW5nKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBzdGFydC5wcmV2aW91c1NpYmxpbmc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIGVuZCA9IGJrLmVuZDtcbiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBiay5zdGFydC5uZXh0U2libGluZztcbiAgICAgICAgICAgICAgICAgICAgaWYocHJlLmZpcnN0Q2hpbGQgPT09IGJrLnN0YXJ0KXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZS5pbnNlcnRCZWZvcmUobWUuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJyAgICAnKSxzdGFydC5uZXh0U2libGluZylcblxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHdoaWxlKHN0YXJ0ICYmIHN0YXJ0ICE9PSBlbmQpe1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYoZG9tVXRpbHMuaXNCcihzdGFydCkgJiYgc3RhcnQubmV4dFNpYmxpbmcpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHN0YXJ0Lm5leHRTaWJsaW5nID09PSBlbmQpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlLmluc2VydEJlZm9yZShtZS5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnICAgICcpLHN0YXJ0Lm5leHRTaWJsaW5nKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHN0YXJ0Lm5leHRTaWJsaW5nO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJuZy5tb3ZlVG9Cb29rbWFyayhiaykuc2VsZWN0KCk7XG4gICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0bXBOb2RlID0gbWUuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJyAgICAnKTtcbiAgICAgICAgICAgICAgICAgICAgcm5nLmluc2VydE5vZGUodG1wTm9kZSkuc2V0U3RhcnRBZnRlcih0bXBOb2RlKS5jb2xsYXBzZSh0cnVlKS5zZWxlY3QodHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnc2F2ZVNjZW5lJyk7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG5cbiAgICB9KTtcblxuXG4gICAgbWUuYWRkTGlzdGVuZXIoJ2JlZm9yZWluc2VydGh0bWwnLGZ1bmN0aW9uKGV2dE5hbWUsaHRtbCl7XG4gICAgICAgIHZhciBtZSA9IHRoaXMsXG4gICAgICAgICAgICBybmcgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxcbiAgICAgICAgICAgIHByZSA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocm5nLnN0YXJ0Q29udGFpbmVyLCdwcmUnLHRydWUpO1xuICAgICAgICBpZihwcmUpe1xuICAgICAgICAgICAgaWYoIXJuZy5jb2xsYXBzZWQpe1xuICAgICAgICAgICAgICAgIHJuZy5kZWxldGVDb250ZW50cygpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgaHRtbHN0ciA9ICcnO1xuICAgICAgICAgICAgaWYoYnJvd3Nlci5pZSAmJiBicm93c2VyLnZlcnNpb24gPiA4KXtcblxuICAgICAgICAgICAgICAgIHV0aWxzLmVhY2goVUUuZmlsdGVyTm9kZShVRS5odG1scGFyc2VyKGh0bWwpLG1lLm9wdGlvbnMuZmlsdGVyVHh0UnVsZXMpLmNoaWxkcmVuLGZ1bmN0aW9uKG5vZGUpe1xuICAgICAgICAgICAgICAgICAgICBpZihub2RlLnR5cGUgPT0nZWxlbWVudCcpe1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYobm9kZS50YWdOYW1lID09ICdicicpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWxzdHIgKz0gJ1xcbidcbiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKCFkdGQuJGVtcHR5W25vZGUudGFnTmFtZV0pe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHV0aWxzLmVhY2gobm9kZS5jaGlsZHJlbixmdW5jdGlvbihjbil7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGNuLnR5cGUgPT0nZWxlbWVudCcpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoY24udGFnTmFtZSA9PSAnYnInKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sc3RyICs9ICdcXG4nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZighZHRkLiRlbXB0eVtub2RlLnRhZ05hbWVdKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sc3RyICs9IGNuLmlubmVyVGV4dCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWxzdHIgKz0gY24uZGF0YVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighL1xcbiQvLnRlc3QoaHRtbHN0cikpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sc3RyICs9ICdcXG4nO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgICAgICBodG1sc3RyICs9IG5vZGUuZGF0YSArICdcXG4nXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYoIW5vZGUubmV4dFNpYmxpbmcoKSAmJiAvXFxuJC8udGVzdChodG1sc3RyKSl7XG4gICAgICAgICAgICAgICAgICAgICAgICBodG1sc3RyID0gaHRtbHN0ci5yZXBsYWNlKC9cXG4kLywnJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB2YXIgdG1wTm9kZSA9IG1lLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHV0aWxzLmh0bWwoaHRtbHN0ci5yZXBsYWNlKC8mbmJzcDsvZywnICcpKSk7XG4gICAgICAgICAgICAgICAgcm5nLmluc2VydE5vZGUodG1wTm9kZSkuc2VsZWN0Tm9kZSh0bXBOb2RlKS5zZWxlY3QoKTtcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHZhciBmcmFnID0gbWUuZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpO1xuXG4gICAgICAgICAgICAgICAgdXRpbHMuZWFjaChVRS5maWx0ZXJOb2RlKFVFLmh0bWxwYXJzZXIoaHRtbCksbWUub3B0aW9ucy5maWx0ZXJUeHRSdWxlcykuY2hpbGRyZW4sZnVuY3Rpb24obm9kZSl7XG4gICAgICAgICAgICAgICAgICAgIGlmKG5vZGUudHlwZSA9PSdlbGVtZW50Jyl7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihub2RlLnRhZ05hbWUgPT0gJ2JyJyl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhZy5hcHBlbmRDaGlsZChtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdicicpKVxuICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYoIWR0ZC4kZW1wdHlbbm9kZS50YWdOYW1lXSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXRpbHMuZWFjaChub2RlLmNoaWxkcmVuLGZ1bmN0aW9uKGNuKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoY24udHlwZSA9PSdlbGVtZW50Jyl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihjbi50YWdOYW1lID09ICdicicpe1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhZy5hcHBlbmRDaGlsZChtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdicicpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYoIWR0ZC4kZW1wdHlbbm9kZS50YWdOYW1lXSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhZy5hcHBlbmRDaGlsZChtZS5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh1dGlscy5odG1sKGNuLmlubmVyVGV4dCgpLnJlcGxhY2UoLyZuYnNwOy9nLCcgJykpKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFnLmFwcGVuZENoaWxkKG1lLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHV0aWxzLmh0bWwoIGNuLmRhdGEucmVwbGFjZSgvJm5ic3A7L2csJyAnKSkpKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihmcmFnLmxhc3RDaGlsZC5ub2RlTmFtZSAhPSAnQlInKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhZy5hcHBlbmRDaGlsZChtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdicicpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgICAgICBmcmFnLmFwcGVuZENoaWxkKG1lLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHV0aWxzLmh0bWwoIG5vZGUuZGF0YS5yZXBsYWNlKC8mbmJzcDsvZywnICcpKSkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmKCFub2RlLm5leHRTaWJsaW5nKCkgJiYgZnJhZy5sYXN0Q2hpbGQubm9kZU5hbWUgPT0gJ0JSJyl7XG4gICAgICAgICAgICAgICAgICAgICAgIGZyYWcucmVtb3ZlQ2hpbGQoZnJhZy5sYXN0Q2hpbGQpXG4gICAgICAgICAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcm5nLmluc2VydE5vZGUoZnJhZykuc2VsZWN0KCk7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICAvL+aWueWQkemUrueahOWkhOeQhlxuICAgIG1lLmFkZExpc3RlbmVyKCdrZXlkb3duJyxmdW5jdGlvbihjbWQsZXZ0KXtcbiAgICAgICAgdmFyIG1lID0gdGhpcyxrZXlDb2RlID0gZXZ0LmtleUNvZGUgfHwgZXZ0LndoaWNoO1xuICAgICAgICBpZihrZXlDb2RlID09IDQwKXtcbiAgICAgICAgICAgIHZhciBybmcgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxwcmUsc3RhcnQgPSBybmcuc3RhcnRDb250YWluZXI7XG4gICAgICAgICAgICBpZihybmcuY29sbGFwc2VkICYmIChwcmUgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHJuZy5zdGFydENvbnRhaW5lciwncHJlJyx0cnVlKSkgJiYgIXByZS5uZXh0U2libGluZyl7XG4gICAgICAgICAgICAgICAgdmFyIGxhc3QgPSBwcmUubGFzdENoaWxkXG4gICAgICAgICAgICAgICAgd2hpbGUobGFzdCAmJiBsYXN0Lm5vZGVOYW1lID09ICdCUicpe1xuICAgICAgICAgICAgICAgICAgICBsYXN0ID0gbGFzdC5wcmV2aW91c1NpYmxpbmc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmKGxhc3QgPT09IHN0YXJ0IHx8IHJuZy5zdGFydENvbnRhaW5lciA9PT0gcHJlICYmIHJuZy5zdGFydE9mZnNldCA9PSBwcmUuY2hpbGROb2Rlcy5sZW5ndGgpe1xuICAgICAgICAgICAgICAgICAgICBtZS5leGVjQ29tbWFuZCgnaW5zZXJ0cGFyYWdyYXBoJyk7XG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnByZXZlbnREZWZhdWx0KGV2dClcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuICAgIC8vdHJhY2U6MzM5NVxuICAgIG1lLmFkZExpc3RlbmVyKCdkZWxrZXlkb3duJyxmdW5jdGlvbih0eXBlLGV2dCl7XG4gICAgICAgIHZhciBybmcgPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xuICAgICAgICBybmcudHh0VG9FbG1Cb3VuZGFyeSh0cnVlKTtcbiAgICAgICAgdmFyIHN0YXJ0ID0gcm5nLnN0YXJ0Q29udGFpbmVyO1xuICAgICAgICBpZihkb21VdGlscy5pc1RhZ05vZGUoc3RhcnQsJ3ByZScpICYmIHJuZy5jb2xsYXBzZWQgJiYgZG9tVXRpbHMuaXNTdGFydEluYmxvY2socm5nKSl7XG4gICAgICAgICAgICB2YXIgcCA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcbiAgICAgICAgICAgIGRvbVV0aWxzLmZpbGxOb2RlKG1lLmRvY3VtZW50LHApO1xuICAgICAgICAgICAgc3RhcnQucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUocCxzdGFydCk7XG4gICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoc3RhcnQpO1xuICAgICAgICAgICAgcm5nLnNldFN0YXJ0KHAsMCkuc2V0Q3Vyc29yKGZhbHNlLHRydWUpO1xuICAgICAgICAgICAgZG9tVXRpbHMucHJldmVudERlZmF1bHQoZXZ0KTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgfSlcbn07XG5cblxuLy8gcGx1Z2lucy9jbGVhcmRvYy5qc1xuLyoqXHJcbiAqIOa4heepuuaWh+aho+aPkuS7tlxyXG4gKiBAZmlsZVxyXG4gKiBAc2luY2UgMS4yLjYuMVxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiDmuIXnqbrmlofmoaNcclxuICogQGNvbW1hbmQgY2xlYXJkb2NcclxuICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogLy9lZGl0b3Ig5piv57yW6L6R5Zmo5a6e5L6LXHJcbiAqIGVkaXRvci5leGVjQ29tbWFuZCgnY2xlYXJkb2MnKTtcclxuICogYGBgXHJcbiAqL1xyXG5cclxuVUUuY29tbWFuZHNbJ2NsZWFyZG9jJ10gPSB7XHJcbiAgICBleGVjQ29tbWFuZCA6IGZ1bmN0aW9uKCBjbWROYW1lKSB7XHJcbiAgICAgICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICAgICAgZW50ZXJUYWcgPSBtZS5vcHRpb25zLmVudGVyVGFnLFxyXG4gICAgICAgICAgICByYW5nZSA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xyXG4gICAgICAgIGlmKGVudGVyVGFnID09IFwiYnJcIil7XHJcbiAgICAgICAgICAgIG1lLmJvZHkuaW5uZXJIVE1MID0gXCI8YnIvPlwiO1xyXG4gICAgICAgICAgICByYW5nZS5zZXRTdGFydChtZS5ib2R5LDApLnNldEN1cnNvcigpO1xyXG4gICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICBtZS5ib2R5LmlubmVySFRNTCA9IFwiPHA+XCIrKGllID8gXCJcIiA6IFwiPGJyLz5cIikrXCI8L3A+XCI7XHJcbiAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KG1lLmJvZHkuZmlyc3RDaGlsZCwwKS5zZXRDdXJzb3IoZmFsc2UsdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgbWUuZmlyZUV2ZW50KFwiY2xlYXJEb2NcIik7XHJcbiAgICAgICAgfSwwKTtcclxuXHJcbiAgICB9XHJcbn07XHJcblxyXG5cblxuLy8gcGx1Z2lucy9hbmNob3IuanNcbi8qKlxyXG4gKiDplJrngrnmj5Lku7bvvIzkuLpVRWRpdG9y5o+Q5L6b5o+S5YWl6ZSa54K55pSv5oyBXHJcbiAqIEBmaWxlXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqL1xyXG5VRS5wbHVnaW4ucmVnaXN0ZXIoJ2FuY2hvcicsIGZ1bmN0aW9uICgpe1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgYmluZEV2ZW50czp7XHJcbiAgICAgICAgICAgICdyZWFkeSc6ZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgIHV0aWxzLmNzc1J1bGUoJ2FuY2hvcicsXHJcbiAgICAgICAgICAgICAgICAgICAgJy5hbmNob3JjbGFzc3tiYWNrZ3JvdW5kOiB1cmwoXFwnJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICArIHRoaXMub3B0aW9ucy50aGVtZVBhdGhcclxuICAgICAgICAgICAgICAgICAgICAgICAgKyB0aGlzLm9wdGlvbnMudGhlbWUgKycvaW1hZ2VzL2FuY2hvci5naWZcXCcpIG5vLXJlcGVhdCBzY3JvbGwgbGVmdCBjZW50ZXIgdHJhbnNwYXJlbnQ7Y3Vyc29yOiBhdXRvO2Rpc3BsYXk6IGlubGluZS1ibG9jaztoZWlnaHQ6IDE2cHg7d2lkdGg6IDE1cHg7fScsXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kb2N1bWVudCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgb3V0cHV0UnVsZTogZnVuY3Rpb24ocm9vdCl7XHJcbiAgICAgICAgICAgdXRpbHMuZWFjaChyb290LmdldE5vZGVzQnlUYWdOYW1lKCdpbWcnKSxmdW5jdGlvbihhKXtcclxuICAgICAgICAgICAgICAgdmFyIHZhbDtcclxuICAgICAgICAgICAgICAgaWYodmFsID0gYS5nZXRBdHRyKCdhbmNob3JuYW1lJykpe1xyXG4gICAgICAgICAgICAgICAgICAgYS50YWdOYW1lID0gJ2EnO1xyXG4gICAgICAgICAgICAgICAgICAgYS5zZXRBdHRyKHtcclxuICAgICAgICAgICAgICAgICAgICAgICBhbmNob3JuYW1lIDogJycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA6IHZhbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAnY2xhc3MnIDogJydcclxuICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICB9KVxyXG4gICAgICAgfSxcclxuICAgICAgIGlucHV0UnVsZTpmdW5jdGlvbihyb290KXtcclxuICAgICAgICAgICB1dGlscy5lYWNoKHJvb3QuZ2V0Tm9kZXNCeVRhZ05hbWUoJ2EnKSxmdW5jdGlvbihhKXtcclxuICAgICAgICAgICAgICAgdmFyIHZhbDtcclxuICAgICAgICAgICAgICAgaWYoKHZhbCA9IGEuZ2V0QXR0cignbmFtZScpKSAmJiAhYS5nZXRBdHRyKCdocmVmJykpe1xyXG4gICAgICAgICAgICAgICAgICAgYS50YWdOYW1lID0gJ2ltZyc7XHJcbiAgICAgICAgICAgICAgICAgICBhLnNldEF0dHIoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgIGFuY2hvcm5hbWUgOmEuZ2V0QXR0cignbmFtZScpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICdjbGFzcycgOiAnYW5jaG9yY2xhc3MnXHJcbiAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgIGEuc2V0QXR0cignbmFtZScpXHJcblxyXG4gICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICB9LFxyXG4gICAgICAgY29tbWFuZHM6e1xyXG4gICAgICAgICAgIC8qKlxyXG4gICAgICAgICAgICAqIOaPkuWFpemUmueCuVxyXG4gICAgICAgICAgICAqIEBjb21tYW5kIGFuY2hvclxyXG4gICAgICAgICAgICAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICAgICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAgICAgICAgICAgICogQHBhcmFtIHsgU3RyaW5nIH0gbmFtZSDplJrngrnlkI3np7DlrZfnrKbkuLJcclxuICAgICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgICAgKiAvL2VkaXRvciDmmK/nvJbovpHlmajlrp7kvotcclxuICAgICAgICAgICAgKiBlZGl0b3IuZXhlY0NvbW1hbmQoJ2FuY2hvcicsICdhbmNob3IxJyk7XHJcbiAgICAgICAgICAgICogYGBgXHJcbiAgICAgICAgICAgICovXHJcbiAgICAgICAgICAgJ2FuY2hvcic6e1xyXG4gICAgICAgICAgICAgICBleGVjQ29tbWFuZDpmdW5jdGlvbiAoY21kLCBuYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICB2YXIgcmFuZ2UgPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZSgpLGltZyA9IHJhbmdlLmdldENsb3NlZE5vZGUoKTtcclxuICAgICAgICAgICAgICAgICAgIGlmIChpbWcgJiYgaW1nLmdldEF0dHJpYnV0ZSgnYW5jaG9ybmFtZScpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1nLnNldEF0dHJpYnV0ZSgnYW5jaG9ybmFtZScsIG5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0QmVmb3JlKGltZykuc2V0Q3Vyc29yKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShpbWcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgLy/lj6rlnKjpgInljLrnmoTlvIDlp4vmj5LlhaVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFuY2hvciA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLmNvbGxhcHNlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5zZXRBdHRyaWJ1dGVzKGFuY2hvcix7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYW5jaG9ybmFtZSc6bmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjbGFzcyc6J2FuY2hvcmNsYXNzJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UuaW5zZXJ0Tm9kZShhbmNob3IpLnNldFN0YXJ0QWZ0ZXIoYW5jaG9yKS5zZXRDdXJzb3IoZmFsc2UsdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgfVxyXG4gICAgICAgfVxyXG4gICAgfVxyXG59KTtcclxuXG5cbi8vIHBsdWdpbnMvd29yZGNvdW50LmpzXG4vLy9pbXBvcnQgY29yZVxyXG4vLy9jb21tYW5kcyDlrZfmlbDnu5/orqFcclxuLy8vY29tbWFuZHNOYW1lICBXb3JkQ291bnQsd29yZENvdW50XHJcbi8vL2NvbW1hbmRzVGl0bGUgIOWtl+aVsOe7n+iuoVxyXG4vKlxyXG4gKiBDcmVhdGVkIGJ5IEpldEJyYWlucyBXZWJTdG9ybS5cclxuICogVXNlcjogdGFvcWlsaVxyXG4gKiBEYXRlOiAxMS05LTdcclxuICogVGltZTog5LiL5Y2IODoxOFxyXG4gKiBUbyBjaGFuZ2UgdGhpcyB0ZW1wbGF0ZSB1c2UgRmlsZSB8IFNldHRpbmdzIHwgRmlsZSBUZW1wbGF0ZXMuXHJcbiAqL1xyXG5cclxuVUUucGx1Z2luc1snd29yZGNvdW50J10gPSBmdW5jdGlvbigpe1xyXG4gICAgdmFyIG1lID0gdGhpcztcclxuICAgIG1lLnNldE9wdCgnd29yZENvdW50Jyx0cnVlKTtcclxuICAgIG1lLmFkZExpc3RlbmVyKCdjb250ZW50Y2hhbmdlJyxmdW5jdGlvbigpe1xyXG4gICAgICAgIG1lLmZpcmVFdmVudCgnd29yZGNvdW50Jyk7XHJcbiAgICB9KTtcclxuICAgIHZhciB0aW1lcjtcclxuICAgIG1lLmFkZExpc3RlbmVyKCdyZWFkeScsZnVuY3Rpb24oKXtcclxuICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgIGRvbVV0aWxzLm9uKG1lLmJvZHksXCJrZXl1cFwiLGZ1bmN0aW9uKGV2dCl7XHJcbiAgICAgICAgICAgIHZhciBjb2RlID0gZXZ0LmtleUNvZGV8fGV2dC53aGljaCxcclxuICAgICAgICAgICAgICAgIC8v5b+955Wl55qE5oyJ6ZSuLGN0cixhbHQsc2hpZnQs5pa55ZCR6ZSuXHJcbiAgICAgICAgICAgICAgICBpZ25vcmVzID0ge1wiMTZcIjoxLFwiMThcIjoxLFwiMjBcIjoxLFwiMzdcIjoxLFwiMzhcIjoxLFwiMzlcIjoxLFwiNDBcIjoxfTtcclxuICAgICAgICAgICAgaWYoY29kZSBpbiBpZ25vcmVzKSByZXR1cm47XHJcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XHJcbiAgICAgICAgICAgIHRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCd3b3JkY291bnQnKTtcclxuICAgICAgICAgICAgfSwyMDApXHJcbiAgICAgICAgfSlcclxuICAgIH0pO1xyXG59O1xyXG5cblxuLy8gcGx1Z2lucy9wYWdlYnJlYWsuanNcbi8qKlxyXG4gKiDliIbpobXlip/og73mj5Lku7ZcclxuICogQGZpbGVcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblVFLnBsdWdpbnNbJ3BhZ2VicmVhayddID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICBub3RCcmVha1RhZ3MgPSBbJ3RkJ107XHJcbiAgICBtZS5zZXRPcHQoJ3BhZ2VCcmVha1RhZycsJ191ZWRpdG9yX3BhZ2VfYnJlYWtfdGFnXycpO1xyXG5cclxuICAgIGZ1bmN0aW9uIGZpbGxOb2RlKG5vZGUpe1xyXG4gICAgICAgIGlmKGRvbVV0aWxzLmlzRW1wdHlCbG9jayhub2RlKSl7XHJcbiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gbm9kZS5maXJzdENoaWxkLHRtcE5vZGU7XHJcblxyXG4gICAgICAgICAgICB3aGlsZShmaXJzdENoaWxkICYmIGZpcnN0Q2hpbGQubm9kZVR5cGUgPT0gMSAmJiBkb21VdGlscy5pc0VtcHR5QmxvY2soZmlyc3RDaGlsZCkpe1xyXG4gICAgICAgICAgICAgICAgdG1wTm9kZSA9IGZpcnN0Q2hpbGQ7XHJcbiAgICAgICAgICAgICAgICBmaXJzdENoaWxkID0gZmlyc3RDaGlsZC5maXJzdENoaWxkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICF0bXBOb2RlICYmICh0bXBOb2RlID0gbm9kZSk7XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLmZpbGxOb2RlKG1lLmRvY3VtZW50LHRtcE5vZGUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8v5YiG6aG156ym5qC35byP5re75YqgXHJcblxyXG4gICAgbWUucmVhZHkoZnVuY3Rpb24oKXtcclxuICAgICAgICB1dGlscy5jc3NSdWxlKCdwYWdlYnJlYWsnLCcucGFnZWJyZWFre2Rpc3BsYXk6YmxvY2s7Y2xlYXI6Ym90aCAhaW1wb3J0YW50O2N1cnNvcjpkZWZhdWx0ICFpbXBvcnRhbnQ7d2lkdGg6IDEwMCUgIWltcG9ydGFudDttYXJnaW46MDt9JyxtZS5kb2N1bWVudCk7XHJcbiAgICB9KTtcclxuICAgIGZ1bmN0aW9uIGlzSHIobm9kZSl7XHJcbiAgICAgICAgcmV0dXJuIG5vZGUgJiYgbm9kZS5ub2RlVHlwZSA9PSAxICYmIG5vZGUudGFnTmFtZSA9PSAnSFInICYmIG5vZGUuY2xhc3NOYW1lID09ICdwYWdlYnJlYWsnO1xyXG4gICAgfVxyXG4gICAgbWUuYWRkSW5wdXRSdWxlKGZ1bmN0aW9uKHJvb3Qpe1xyXG4gICAgICAgIHJvb3QudHJhdmVyc2FsKGZ1bmN0aW9uKG5vZGUpe1xyXG4gICAgICAgICAgICBpZihub2RlLnR5cGUgPT0gJ3RleHQnICYmIG5vZGUuZGF0YSA9PSBtZS5vcHRpb25zLnBhZ2VCcmVha1RhZyl7XHJcbiAgICAgICAgICAgICAgICB2YXIgaHIgPSBVRS51Tm9kZS5jcmVhdGVFbGVtZW50KCc8aHIgY2xhc3M9XCJwYWdlYnJlYWtcIiBub3NoYWRlPVwibm9zaGFkZVwiIHNpemU9XCI1XCIgc3R5bGU9XCItd2Via2l0LXVzZXItc2VsZWN0OiBub25lO1wiPicpO1xyXG4gICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShocixub2RlKTtcclxuICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgIH0pO1xyXG4gICAgbWUuYWRkT3V0cHV0UnVsZShmdW5jdGlvbihub2RlKXtcclxuICAgICAgICB1dGlscy5lYWNoKG5vZGUuZ2V0Tm9kZXNCeVRhZ05hbWUoJ2hyJyksZnVuY3Rpb24obil7XHJcbiAgICAgICAgICAgIGlmKG4uZ2V0QXR0cignY2xhc3MnKSA9PSAncGFnZWJyZWFrJyl7XHJcbiAgICAgICAgICAgICAgICB2YXIgdHh0ID0gVUUudU5vZGUuY3JlYXRlVGV4dChtZS5vcHRpb25zLnBhZ2VCcmVha1RhZyk7XHJcbiAgICAgICAgICAgICAgICBuLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHR4dCxuKTtcclxuICAgICAgICAgICAgICAgIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgfSk7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmj5LlhaXliIbpobXnrKZcclxuICAgICAqIEBjb21tYW5kIHBhZ2VicmVha1xyXG4gICAgICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gICAgICogQHJlbWluZCDlnKjooajmoLzkuK3mj5LlhaXliIbpobXnrKbkvJrmiorooajmoLzliIfliIbmiJDkuKTpg6jliIZcclxuICAgICAqIEByZW1pbmQg6I635Y+W57yW6L6R5Zmo5YaF55qE5pWw5o2u5pe277yMIOe8lui+keWZqOS8muaKiuWIhumhteespui9rOaNouaIkOKAnF91ZWRpdG9yX3BhZ2VfYnJlYWtfdGFnX+KAneWtl+espuS4su+8jFxyXG4gICAgICogICAgICAgICAg5Lul5L6/5LqO5o+Q5Lqk5pWw5o2u5Yiw5pyN5Yqh5Zmo56uv5ZCO5aSE55CG5YiG6aG144CCXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogZWRpdG9yLmV4ZWNDb21tYW5kKCAncGFnZWJyZWFrJyk7IC8v5o+S5YWl5LiA5LiqaHLmoIfnrb7vvIzluKbmnInmoLflvI/nsbvlkI1wYWdlYnJlYWtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgbWUuY29tbWFuZHNbJ3BhZ2VicmVhayddID0ge1xyXG4gICAgICAgIGV4ZWNDb21tYW5kOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJhbmdlID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCksaHIgPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdocicpO1xyXG4gICAgICAgICAgICBkb21VdGlscy5zZXRBdHRyaWJ1dGVzKGhyLHtcclxuICAgICAgICAgICAgICAgICdjbGFzcycgOiAncGFnZWJyZWFrJyxcclxuICAgICAgICAgICAgICAgIG5vc2hhZGU6XCJub3NoYWRlXCIsXHJcbiAgICAgICAgICAgICAgICBzaXplOlwiNVwiXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBkb21VdGlscy51blNlbGVjdGFibGUoaHIpO1xyXG4gICAgICAgICAgICAvL3RhYmxl5Y2V54us5aSE55CGXHJcbiAgICAgICAgICAgIHZhciBub2RlID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShyYW5nZS5zdGFydENvbnRhaW5lciwgbm90QnJlYWtUYWdzLCB0cnVlKSxcclxuXHJcbiAgICAgICAgICAgICAgICBwYXJlbnRzID0gW10sIHBOO1xyXG4gICAgICAgICAgICBpZiAobm9kZSkge1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChub2RlLnRhZ05hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdURCc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBOID0gbm9kZS5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXBOLnByZXZpb3VzU2libGluZykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhYmxlID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShwTiwgJ3RhYmxlJyk7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YWJsZVdyYXBEaXYgPSB0YWJsZS5wYXJlbnROb2RlO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0YWJsZVdyYXBEaXYgJiYgdGFibGVXcmFwRGl2Lm5vZGVUeXBlID09IDFcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIHRhYmxlV3JhcERpdi50YWdOYW1lID09ICdESVYnXHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiB0YWJsZVdyYXBEaXYuZ2V0QXR0cmlidXRlKCdkcm9wZHJhZycpXHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApe1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHRhYmxlV3JhcERpdix0cnVlKTtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoaHIsIHRhYmxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudHMgPSBkb21VdGlscy5maW5kUGFyZW50cyhociwgdHJ1ZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcE4ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoaHIsIHBOKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudHMgPSBkb21VdGlscy5maW5kUGFyZW50cyhocik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBOID0gcGFyZW50c1sxXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhyICE9PSBwTikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuYnJlYWtQYXJlbnQoaHIsIHBOKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy90YWJsZeimgemHjeWGmee7keWumuS4gOS4i+aLluaLvVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ2FmdGVyYWRqdXN0dGFibGUnLG1lLmRvY3VtZW50KTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCFyYW5nZS5jb2xsYXBzZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5kZWxldGVDb250ZW50cygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IHJhbmdlLnN0YXJ0Q29udGFpbmVyO1xyXG4gICAgICAgICAgICAgICAgICAgIHdoaWxlICggIWRvbVV0aWxzLmlzQm9keShzdGFydCkgJiYgZG9tVXRpbHMuaXNCbG9ja0VsbShzdGFydCkgJiYgZG9tVXRpbHMuaXNFbXB0eU5vZGUoc3RhcnQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0QmVmb3JlKHN0YXJ0KS5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHN0YXJ0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSByYW5nZS5zdGFydENvbnRhaW5lcjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmFuZ2UuaW5zZXJ0Tm9kZShocik7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIHBOID0gaHIucGFyZW50Tm9kZSwgbmV4dE5vZGU7XHJcbiAgICAgICAgICAgICAgICB3aGlsZSAoIWRvbVV0aWxzLmlzQm9keShwTikpIHtcclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5icmVha1BhcmVudChociwgcE4pO1xyXG4gICAgICAgICAgICAgICAgICAgIG5leHROb2RlID0gaHIubmV4dFNpYmxpbmc7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5leHROb2RlICYmIGRvbVV0aWxzLmlzRW1wdHlCbG9jayhuZXh0Tm9kZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKG5leHROb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcE4gPSBoci5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbmV4dE5vZGUgPSBoci5uZXh0U2libGluZztcclxuICAgICAgICAgICAgICAgIHZhciBwcmUgPSBoci5wcmV2aW91c1NpYmxpbmc7XHJcbiAgICAgICAgICAgICAgICBpZihpc0hyKHByZSkpe1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShwcmUpO1xyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJlICYmIGZpbGxOb2RlKHByZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYoIW5leHROb2RlKXtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcCA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaHIucGFyZW50Tm9kZS5hcHBlbmRDaGlsZChwKTtcclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5maWxsTm9kZShtZS5kb2N1bWVudCxwKTtcclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydChwLDApLmNvbGxhcHNlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoaXNIcihuZXh0Tm9kZSkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUobmV4dE5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWxsTm9kZShuZXh0Tm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldEVuZEFmdGVyKGhyKS5jb2xsYXBzZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmFuZ2Uuc2VsZWN0KHRydWUpO1xyXG5cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59O1xuXG4vLyBwbHVnaW5zL3dvcmRpbWFnZS5qc1xuLy8vaW1wb3J0IGNvcmVcclxuLy8vY29tbWFuZHMg5pys5Zyw5Zu+54mH5byV5a+85LiK5LygXHJcbi8vL2NvbW1hbmRzTmFtZSAgV29yZEltYWdlXHJcbi8vL2NvbW1hbmRzVGl0bGUgIOacrOWcsOWbvueJh+W8leWvvOS4iuS8oFxyXG4vLy9jb21tYW5kc0RpYWxvZyAgZGlhbG9nc1xcd29yZGltYWdlXHJcblxyXG5VRS5wbHVnaW4ucmVnaXN0ZXIoJ3dvcmRpbWFnZScsZnVuY3Rpb24oKXtcclxuICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgaW1hZ2VzID0gW107XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGNvbW1hbmRzIDoge1xyXG4gICAgICAgICAgICAnd29yZGltYWdlJzp7XHJcbiAgICAgICAgICAgICAgICBleGVjQ29tbWFuZDpmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGltYWdlcyA9IGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKG1lLmJvZHksIFwiaW1nXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB1cmxMaXN0ID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IGltYWdlc1tpKytdOykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdXJsID0gY2kuZ2V0QXR0cmlidXRlKFwid29yZF9pbWdcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybCAmJiB1cmxMaXN0LnB1c2godXJsKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVybExpc3Q7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGltYWdlcyA9IGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKG1lLmJvZHksIFwiaW1nXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSBpbWFnZXNbaSsrXTspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNpLmdldEF0dHJpYnV0ZShcIndvcmRfaW1nXCIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTE7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgbm90TmVlZFVuZG86dHJ1ZVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBpbnB1dFJ1bGUgOiBmdW5jdGlvbiAocm9vdCkge1xyXG4gICAgICAgICAgICB1dGlscy5lYWNoKHJvb3QuZ2V0Tm9kZXNCeVRhZ05hbWUoJ2ltZycpLCBmdW5jdGlvbiAoaW1nKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYXR0cnMgPSBpbWcuYXR0cnMsXHJcbiAgICAgICAgICAgICAgICAgICAgZmxhZyA9IHBhcnNlSW50KGF0dHJzLndpZHRoKSA8IDEyOCB8fCBwYXJzZUludChhdHRycy5oZWlnaHQpIDwgNDMsXHJcbiAgICAgICAgICAgICAgICAgICAgb3B0ID0gbWUub3B0aW9ucyxcclxuICAgICAgICAgICAgICAgICAgICBzcmMgPSBvcHQuVUVESVRPUl9IT01FX1VSTCArICd0aGVtZXMvZGVmYXVsdC9pbWFnZXMvc3BhY2VyLmdpZic7XHJcbiAgICAgICAgICAgICAgICBpZiAoYXR0cnNbJ3NyYyddICYmIC9eKD86KGZpbGU6XFwvKykpLy50ZXN0KGF0dHJzWydzcmMnXSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBpbWcuc2V0QXR0cih7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOmF0dHJzLndpZHRoLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6YXR0cnMuaGVpZ2h0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhbHQ6YXR0cnMuYWx0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB3b3JkX2ltZzogYXR0cnMuc3JjLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzcmM6c3JjLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAnc3R5bGUnOidiYWNrZ3JvdW5kOnVybCgnICsgKCBmbGFnID8gb3B0LnRoZW1lUGF0aCArIG9wdC50aGVtZSArICcvaW1hZ2VzL3dvcmQuZ2lmJyA6IG9wdC5sYW5nUGF0aCArIG9wdC5sYW5nICsgJy9pbWFnZXMvbG9jYWxpbWFnZS5wbmcnKSArICcpIG5vLXJlcGVhdCBjZW50ZXIgY2VudGVyO2JvcmRlcjoxcHggc29saWQgI2RkZCdcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufSk7XG5cbi8vIHBsdWdpbnMvZHJhZ2Ryb3AuanNcblVFLnBsdWdpbnNbJ2RyYWdkcm9wJ10gPSBmdW5jdGlvbiAoKXtcclxuXHJcbiAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgbWUucmVhZHkoZnVuY3Rpb24oKXtcclxuICAgICAgICBkb21VdGlscy5vbih0aGlzLmJvZHksJ2RyYWdlbmQnLGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgIHZhciBybmcgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuICAgICAgICAgICAgdmFyIG5vZGUgPSBybmcuZ2V0Q2xvc2VkTm9kZSgpfHxtZS5zZWxlY3Rpb24uZ2V0U3RhcnQoKTtcclxuXHJcbiAgICAgICAgICAgIGlmKG5vZGUgJiYgbm9kZS50YWdOYW1lID09ICdJTUcnKXtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgcHJlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcsbmV4dDtcclxuICAgICAgICAgICAgICAgIHdoaWxlKG5leHQgPSBub2RlLm5leHRTaWJsaW5nKXtcclxuICAgICAgICAgICAgICAgICAgICBpZihuZXh0Lm5vZGVUeXBlID09IDEgJiYgbmV4dC50YWdOYW1lID09ICdTUEFOJyAmJiAhbmV4dC5maXJzdENoaWxkKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKG5leHQpXHJcbiAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICAgICAgaWYoKHByZSAmJiBwcmUubm9kZVR5cGUgPT0gMSAmJiAhZG9tVXRpbHMuaXNFbXB0eUJsb2NrKHByZSkgfHwgIXByZSkgJiYgKCFuZXh0IHx8IG5leHQgJiYgIWRvbVV0aWxzLmlzRW1wdHlCbG9jayhuZXh0KSkpe1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKHByZSAmJiBwcmUudGFnTmFtZSA9PSAnUCcgJiYgIWRvbVV0aWxzLmlzRW1wdHlCbG9jayhwcmUpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJlLmFwcGVuZENoaWxkKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5tb3ZlQ2hpbGQobmV4dCxwcmUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUobmV4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfWVsc2UgIGlmKG5leHQgJiYgbmV4dC50YWdOYW1lID09ICdQJyAmJiAhZG9tVXRpbHMuaXNFbXB0eUJsb2NrKG5leHQpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV4dC5pbnNlcnRCZWZvcmUobm9kZSxuZXh0LmZpcnN0Q2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYocHJlICYmIHByZS50YWdOYW1lID09ICdQJyAmJiBkb21VdGlscy5pc0VtcHR5QmxvY2socHJlKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShwcmUpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmKG5leHQgJiYgbmV4dC50YWdOYW1lID09ICdQJyAmJiBkb21VdGlscy5pc0VtcHR5QmxvY2sobmV4dCkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUobmV4dClcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcm5nLnNlbGVjdE5vZGUobm9kZSkuc2VsZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdzYXZlU2NlbmUnKTtcclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH0pXHJcbiAgICB9KTtcclxuICAgIG1lLmFkZExpc3RlbmVyKCdrZXl1cCcsIGZ1bmN0aW9uKHR5cGUsIGV2dCkge1xyXG4gICAgICAgIHZhciBrZXlDb2RlID0gZXZ0LmtleUNvZGUgfHwgZXZ0LndoaWNoO1xyXG4gICAgICAgIGlmIChrZXlDb2RlID09IDEzKSB7XHJcbiAgICAgICAgICAgIHZhciBybmcgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxub2RlO1xyXG4gICAgICAgICAgICBpZihub2RlID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShybmcuc3RhcnRDb250YWluZXIsJ3AnLHRydWUpKXtcclxuICAgICAgICAgICAgICAgIGlmKGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUobm9kZSwndGV4dC1hbGlnbicpID09ICdjZW50ZXInKXtcclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmVTdHlsZShub2RlLCd0ZXh0LWFsaWduJylcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pXHJcbn07XHJcblxuXG4vLyBwbHVnaW5zL3VuZG8uanNcbi8qKlxyXG4gKiB1bmRvIHJlZG9cclxuICogQGZpbGVcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG4vKipcclxuICog5pKk6ZSA5LiK5LiA5qyh5omn6KGM55qE5ZG95LukXHJcbiAqIEBjb21tYW5kIHVuZG9cclxuICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYGphdmFzY3JpcHRcclxuICogZWRpdG9yLmV4ZWNDb21tYW5kKCAndW5kbycgKTtcclxuICogYGBgXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIOmHjeWBmuS4iuS4gOasoeaJp+ihjOeahOWRveS7pFxyXG4gKiBAY29tbWFuZCByZWRvXHJcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGBqYXZhc2NyaXB0XHJcbiAqIGVkaXRvci5leGVjQ29tbWFuZCggJ3JlZG8nICk7XHJcbiAqIGBgYFxyXG4gKi9cclxuXHJcblVFLnBsdWdpbnNbJ3VuZG8nXSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBzYXZlU2NlbmVUaW1lcjtcclxuICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgbWF4VW5kb0NvdW50ID0gbWUub3B0aW9ucy5tYXhVbmRvQ291bnQgfHwgMjAsXHJcbiAgICAgICAgbWF4SW5wdXRDb3VudCA9IG1lLm9wdGlvbnMubWF4SW5wdXRDb3VudCB8fCAyMCxcclxuICAgICAgICBmaWxsY2hhciA9IG5ldyBSZWdFeHAoZG9tVXRpbHMuZmlsbENoYXIgKyAnfDxcXC9ocj4nLCAnZ2knKTsvLyBpZeS8muS6p+eUn+WkmuS9meeahDwvaHI+XHJcbiAgICB2YXIgbm9OZWVkRmlsbENoYXJUYWdzID0ge1xyXG4gICAgICAgIG9sOjEsdWw6MSx0YWJsZToxLHRib2R5OjEsdHI6MSxib2R5OjFcclxuICAgIH07XHJcbiAgICB2YXIgb3JnU3RhdGUgPSBtZS5vcHRpb25zLmF1dG9DbGVhckVtcHR5Tm9kZTtcclxuICAgIGZ1bmN0aW9uIGNvbXBhcmVBZGRyKGluZGV4QSwgaW5kZXhCKSB7XHJcbiAgICAgICAgaWYgKGluZGV4QS5sZW5ndGggIT0gaW5kZXhCLmxlbmd0aClcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBpbmRleEEubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmIChpbmRleEFbaV0gIT0gaW5kZXhCW2ldKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDBcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIDE7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY29tcGFyZVJhbmdlQWRkcmVzcyhybmdBZGRyQSwgcm5nQWRkckIpIHtcclxuICAgICAgICBpZiAocm5nQWRkckEuY29sbGFwc2VkICE9IHJuZ0FkZHJCLmNvbGxhcHNlZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFjb21wYXJlQWRkcihybmdBZGRyQS5zdGFydEFkZHJlc3MsIHJuZ0FkZHJCLnN0YXJ0QWRkcmVzcykgfHwgIWNvbXBhcmVBZGRyKHJuZ0FkZHJBLmVuZEFkZHJlc3MsIHJuZ0FkZHJCLmVuZEFkZHJlc3MpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gMTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBVbmRvTWFuYWdlcigpIHtcclxuICAgICAgICB0aGlzLmxpc3QgPSBbXTtcclxuICAgICAgICB0aGlzLmluZGV4ID0gMDtcclxuICAgICAgICB0aGlzLmhhc1VuZG8gPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmhhc1JlZG8gPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnVuZG8gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmhhc1VuZG8pIHtcclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5saXN0W3RoaXMuaW5kZXggLSAxXSAmJiB0aGlzLmxpc3QubGVuZ3RoID09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgd2hpbGUgKHRoaXMubGlzdFt0aGlzLmluZGV4XS5jb250ZW50ID09IHRoaXMubGlzdFt0aGlzLmluZGV4IC0gMV0uY29udGVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5kZXgtLTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbmRleCA9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc3RvcmUoMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5yZXN0b3JlKC0tdGhpcy5pbmRleCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMucmVkbyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaGFzUmVkbykge1xyXG4gICAgICAgICAgICAgICAgd2hpbGUgKHRoaXMubGlzdFt0aGlzLmluZGV4XS5jb250ZW50ID09IHRoaXMubGlzdFt0aGlzLmluZGV4ICsgMV0uY29udGVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5kZXgrKztcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbmRleCA9PSB0aGlzLmxpc3QubGVuZ3RoIC0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5yZXN0b3JlKHRoaXMuaW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMucmVzdG9yZSgrK3RoaXMuaW5kZXgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdGhpcy5yZXN0b3JlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzLmVkaXRvcjtcclxuICAgICAgICAgICAgdmFyIHNjZW5lID0gdGhpcy5saXN0W3RoaXMuaW5kZXhdO1xyXG4gICAgICAgICAgICB2YXIgcm9vdCA9IFVFLmh0bWxwYXJzZXIoc2NlbmUuY29udGVudC5yZXBsYWNlKGZpbGxjaGFyLCAnJykpO1xyXG4gICAgICAgICAgICBtZS5vcHRpb25zLmF1dG9DbGVhckVtcHR5Tm9kZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICBtZS5maWx0ZXJJbnB1dFJ1bGUocm9vdCk7XHJcbiAgICAgICAgICAgIG1lLm9wdGlvbnMuYXV0b0NsZWFyRW1wdHlOb2RlID0gb3JnU3RhdGU7XHJcbiAgICAgICAgICAgIC8vdHJhY2U6ODczXHJcbiAgICAgICAgICAgIC8v5Y675o6J5bGV5L2N56ymXHJcbiAgICAgICAgICAgIG1lLmRvY3VtZW50LmJvZHkuaW5uZXJIVE1MID0gcm9vdC50b0h0bWwoKTtcclxuICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdhZnRlcnNjZW5jZXJlc3RvcmUnKTtcclxuICAgICAgICAgICAgLy/lpITnkIZ1bmRv5ZCO56m65qC85LiN5bGV5L2N55qE6Zeu6aKYXHJcbiAgICAgICAgICAgIGlmIChicm93c2VyLmllKSB7XHJcbiAgICAgICAgICAgICAgICB1dGlscy5lYWNoKGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKG1lLmRvY3VtZW50LCd0ZCB0aCBjYXB0aW9uIHAnKSxmdW5jdGlvbihub2RlKXtcclxuICAgICAgICAgICAgICAgICAgICBpZihkb21VdGlscy5pc0VtcHR5Tm9kZShub2RlKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmZpbGxOb2RlKG1lLmRvY3VtZW50LCBub2RlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0cnl7XHJcbiAgICAgICAgICAgICAgICB2YXIgcm5nID0gbmV3IGRvbS5SYW5nZShtZS5kb2N1bWVudCkubW92ZVRvQWRkcmVzcyhzY2VuZS5hZGRyZXNzKTtcclxuICAgICAgICAgICAgICAgIHJuZy5zZWxlY3Qobm9OZWVkRmlsbENoYXJUYWdzW3JuZy5zdGFydENvbnRhaW5lci5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpXSk7XHJcbiAgICAgICAgICAgIH1jYXRjaChlKXt9XHJcblxyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZSgpO1xyXG4gICAgICAgICAgICB0aGlzLmNsZWFyS2V5KCk7XHJcbiAgICAgICAgICAgIC8v5LiN6IO95oqK6Ieq5bexcmVzZXTkuoZcclxuICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdyZXNldCcsIHRydWUpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMuZ2V0U2NlbmUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMuZWRpdG9yO1xyXG4gICAgICAgICAgICB2YXIgcm5nID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCksXHJcbiAgICAgICAgICAgICAgICBybmdBZGRyZXNzID0gcm5nLmNyZWF0ZUFkZHJlc3MoZmFsc2UsdHJ1ZSk7XHJcbiAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnYmVmb3JlZ2V0c2NlbmUnKTtcclxuICAgICAgICAgICAgdmFyIHJvb3QgPSBVRS5odG1scGFyc2VyKG1lLmJvZHkuaW5uZXJIVE1MKTtcclxuICAgICAgICAgICAgbWUub3B0aW9ucy5hdXRvQ2xlYXJFbXB0eU5vZGUgPSBmYWxzZTtcclxuICAgICAgICAgICAgbWUuZmlsdGVyT3V0cHV0UnVsZShyb290KTtcclxuICAgICAgICAgICAgbWUub3B0aW9ucy5hdXRvQ2xlYXJFbXB0eU5vZGUgPSBvcmdTdGF0ZTtcclxuICAgICAgICAgICAgdmFyIGNvbnQgPSByb290LnRvSHRtbCgpO1xyXG4gICAgICAgICAgICAvL3RyYWNlOjM0NjFcclxuICAgICAgICAgICAgLy/ov5nkuKrkvJrlvJXotbflm57pgIDml7blr7zoh7TnqbrmoLzkuKLlpLHnmoTmg4XlhrVcclxuLy8gICAgICAgICAgICBicm93c2VyLmllICYmIChjb250ID0gY29udC5yZXBsYWNlKC8+Jm5ic3A7PC9nLCAnPjwnKS5yZXBsYWNlKC9cXHMqPC9nLCAnPCcpLnJlcGxhY2UoLz5cXHMqL2csICc+JykpO1xyXG4gICAgICAgICAgICBtZS5maXJlRXZlbnQoJ2FmdGVyZ2V0c2NlbmUnKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBhZGRyZXNzOnJuZ0FkZHJlc3MsXHJcbiAgICAgICAgICAgICAgICBjb250ZW50OmNvbnRcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5zYXZlID0gZnVuY3Rpb24gKG5vdENvbXBhcmVSYW5nZSxub3RTZXRDdXJzb3IpIHtcclxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHNhdmVTY2VuZVRpbWVyKTtcclxuICAgICAgICAgICAgdmFyIGN1cnJlbnRTY2VuZSA9IHRoaXMuZ2V0U2NlbmUobm90U2V0Q3Vyc29yKSxcclxuICAgICAgICAgICAgICAgIGxhc3RTY2VuZSA9IHRoaXMubGlzdFt0aGlzLmluZGV4XTtcclxuXHJcbiAgICAgICAgICAgIGlmKGxhc3RTY2VuZSAmJiBsYXN0U2NlbmUuY29udGVudCAhPSBjdXJyZW50U2NlbmUuY29udGVudCl7XHJcbiAgICAgICAgICAgICAgICBtZS50cmlnZ2VyKCdjb250ZW50Y2hhbmdlJylcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvL+WGheWuueebuOWQjOS9jee9ruebuOWQjOS4jeWtmFxyXG4gICAgICAgICAgICBpZiAobGFzdFNjZW5lICYmIGxhc3RTY2VuZS5jb250ZW50ID09IGN1cnJlbnRTY2VuZS5jb250ZW50ICYmXHJcbiAgICAgICAgICAgICAgICAoIG5vdENvbXBhcmVSYW5nZSA/IDEgOiBjb21wYXJlUmFuZ2VBZGRyZXNzKGxhc3RTY2VuZS5hZGRyZXNzLCBjdXJyZW50U2NlbmUuYWRkcmVzcykgKVxyXG4gICAgICAgICAgICAgICAgKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5saXN0ID0gdGhpcy5saXN0LnNsaWNlKDAsIHRoaXMuaW5kZXggKyAxKTtcclxuICAgICAgICAgICAgdGhpcy5saXN0LnB1c2goY3VycmVudFNjZW5lKTtcclxuICAgICAgICAgICAgLy/lpoLmnpzlpKfkuo7mnIDlpKfmlbDph4/kuobvvIzlsLHmiormnIDliY3nmoTliZTpmaRcclxuICAgICAgICAgICAgaWYgKHRoaXMubGlzdC5sZW5ndGggPiBtYXhVbmRvQ291bnQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubGlzdC5zaGlmdCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuaW5kZXggPSB0aGlzLmxpc3QubGVuZ3RoIC0gMTtcclxuICAgICAgICAgICAgdGhpcy5jbGVhcktleSgpO1xyXG4gICAgICAgICAgICAvL+i3n+aWsHVuZG8vcmVkb+eKtuaAgVxyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZSgpO1xyXG5cclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMudXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB0aGlzLmhhc1JlZG8gPSAhIXRoaXMubGlzdFt0aGlzLmluZGV4ICsgMV07XHJcbiAgICAgICAgICAgIHRoaXMuaGFzVW5kbyA9ICEhdGhpcy5saXN0W3RoaXMuaW5kZXggLSAxXTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMucmVzZXQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHRoaXMubGlzdCA9IFtdO1xyXG4gICAgICAgICAgICB0aGlzLmluZGV4ID0gMDtcclxuICAgICAgICAgICAgdGhpcy5oYXNVbmRvID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHRoaXMuaGFzUmVkbyA9IGZhbHNlO1xyXG4gICAgICAgICAgICB0aGlzLmNsZWFyS2V5KCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmNsZWFyS2V5ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBrZXljb250ID0gMDtcclxuICAgICAgICAgICAgbGFzdEtleUNvZGUgPSBudWxsO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgbWUudW5kb01hbmdlciA9IG5ldyBVbmRvTWFuYWdlcigpO1xyXG4gICAgbWUudW5kb01hbmdlci5lZGl0b3IgPSBtZTtcclxuICAgIGZ1bmN0aW9uIHNhdmVTY2VuZSgpIHtcclxuICAgICAgICB0aGlzLnVuZG9NYW5nZXIuc2F2ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIG1lLmFkZExpc3RlbmVyKCdzYXZlU2NlbmUnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmNhbGwoYXJndW1lbnRzLDEpO1xyXG4gICAgICAgIHRoaXMudW5kb01hbmdlci5zYXZlLmFwcGx5KHRoaXMudW5kb01hbmdlcixhcmdzKTtcclxuICAgIH0pO1xyXG5cclxuLy8gICAgbWUuYWRkTGlzdGVuZXIoJ2JlZm9yZWV4ZWNjb21tYW5kJywgc2F2ZVNjZW5lKTtcclxuLy8gICAgbWUuYWRkTGlzdGVuZXIoJ2FmdGVyZXhlY2NvbW1hbmQnLCBzYXZlU2NlbmUpO1xyXG5cclxuICAgIG1lLmFkZExpc3RlbmVyKCdyZXNldCcsIGZ1bmN0aW9uICh0eXBlLCBleGNsdWRlKSB7XHJcbiAgICAgICAgaWYgKCFleGNsdWRlKSB7XHJcbiAgICAgICAgICAgIHRoaXMudW5kb01hbmdlci5yZXNldCgpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgbWUuY29tbWFuZHNbJ3JlZG8nXSA9IG1lLmNvbW1hbmRzWyd1bmRvJ10gPSB7XHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6ZnVuY3Rpb24gKGNtZE5hbWUpIHtcclxuICAgICAgICAgICAgdGhpcy51bmRvTWFuZ2VyW2NtZE5hbWVdKCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZTpmdW5jdGlvbiAoY21kTmFtZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy51bmRvTWFuZ2VyWydoYXMnICsgKGNtZE5hbWUudG9Mb3dlckNhc2UoKSA9PSAndW5kbycgPyAnVW5kbycgOiAnUmVkbycpXSA/IDAgOiAtMTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG5vdE5lZWRVbmRvOjFcclxuICAgIH07XHJcblxyXG4gICAgdmFyIGtleXMgPSB7XHJcbiAgICAgICAgICAgIC8vICAvKkJhY2tzcGFjZSovIDg6MSwgLypEZWxldGUqLyA0NjoxLFxyXG4gICAgICAgICAgICAvKlNoaWZ0Ki8gMTY6MSwgLypDdHJsKi8gMTc6MSwgLypBbHQqLyAxODoxLFxyXG4gICAgICAgICAgICAzNzoxLCAzODoxLCAzOToxLCA0MDoxXHJcblxyXG4gICAgICAgIH0sXHJcbiAgICAgICAga2V5Y29udCA9IDAsXHJcbiAgICAgICAgbGFzdEtleUNvZGU7XHJcbiAgICAvL+i+k+WFpeazleeKtuaAgeS4i+S4jeiuoeeul+Wtl+espuaVsFxyXG4gICAgdmFyIGlucHV0VHlwZSA9IGZhbHNlO1xyXG4gICAgbWUuYWRkTGlzdGVuZXIoJ3JlYWR5JywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGRvbVV0aWxzLm9uKHRoaXMuYm9keSwgJ2NvbXBvc2l0aW9uc3RhcnQnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlucHV0VHlwZSA9IHRydWU7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgZG9tVXRpbHMub24odGhpcy5ib2R5LCAnY29tcG9zaXRpb25lbmQnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlucHV0VHlwZSA9IGZhbHNlO1xyXG4gICAgICAgIH0pXHJcbiAgICB9KTtcclxuICAgIC8v5b+r5o236ZSuXHJcbiAgICBtZS5hZGRzaG9ydGN1dGtleSh7XHJcbiAgICAgICAgXCJVbmRvXCI6XCJjdHJsKzkwXCIsIC8vdW5kb1xyXG4gICAgICAgIFwiUmVkb1wiOlwiY3RybCs4OVwiIC8vcmVkb1xyXG5cclxuICAgIH0pO1xyXG4gICAgdmFyIGlzQ29sbGFwc2VkID0gdHJ1ZTtcclxuICAgIG1lLmFkZExpc3RlbmVyKCdrZXlkb3duJywgZnVuY3Rpb24gKHR5cGUsIGV2dCkge1xyXG5cclxuICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgIHZhciBrZXlDb2RlID0gZXZ0LmtleUNvZGUgfHwgZXZ0LndoaWNoO1xyXG4gICAgICAgIGlmICgha2V5c1trZXlDb2RlXSAmJiAhZXZ0LmN0cmxLZXkgJiYgIWV2dC5tZXRhS2V5ICYmICFldnQuc2hpZnRLZXkgJiYgIWV2dC5hbHRLZXkpIHtcclxuICAgICAgICAgICAgaWYgKGlucHV0VHlwZSlcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgICAgIGlmKCFtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKS5jb2xsYXBzZWQpe1xyXG4gICAgICAgICAgICAgICAgbWUudW5kb01hbmdlci5zYXZlKGZhbHNlLHRydWUpO1xyXG4gICAgICAgICAgICAgICAgaXNDb2xsYXBzZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAobWUudW5kb01hbmdlci5saXN0Lmxlbmd0aCA9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBtZS51bmRvTWFuZ2VyLnNhdmUodHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHNhdmVTY2VuZVRpbWVyKTtcclxuICAgICAgICAgICAgZnVuY3Rpb24gc2F2ZShjb250KXtcclxuICAgICAgICAgICAgICAgIGNvbnQudW5kb01hbmdlci5zYXZlKGZhbHNlLHRydWUpO1xyXG4gICAgICAgICAgICAgICAgY29udC5maXJlRXZlbnQoJ3NlbGVjdGlvbmNoYW5nZScpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHNhdmVTY2VuZVRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgaWYoaW5wdXRUeXBlKXtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJhbFRpbWVyID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWlucHV0VHlwZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYXZlKG1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJhbFRpbWVyKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSwzMDApXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgc2F2ZShtZSk7XHJcbiAgICAgICAgICAgIH0sMjAwKTtcclxuXHJcbiAgICAgICAgICAgIGxhc3RLZXlDb2RlID0ga2V5Q29kZTtcclxuICAgICAgICAgICAga2V5Y29udCsrO1xyXG4gICAgICAgICAgICBpZiAoa2V5Y29udCA+PSBtYXhJbnB1dENvdW50ICkge1xyXG4gICAgICAgICAgICAgICAgc2F2ZShtZSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgbWUuYWRkTGlzdGVuZXIoJ2tleXVwJywgZnVuY3Rpb24gKHR5cGUsIGV2dCkge1xyXG4gICAgICAgIHZhciBrZXlDb2RlID0gZXZ0LmtleUNvZGUgfHwgZXZ0LndoaWNoO1xyXG4gICAgICAgIGlmICgha2V5c1trZXlDb2RlXSAmJiAhZXZ0LmN0cmxLZXkgJiYgIWV2dC5tZXRhS2V5ICYmICFldnQuc2hpZnRLZXkgJiYgIWV2dC5hbHRLZXkpIHtcclxuICAgICAgICAgICAgaWYgKGlucHV0VHlwZSlcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgaWYoIWlzQ29sbGFwc2VkKXtcclxuICAgICAgICAgICAgICAgIHRoaXMudW5kb01hbmdlci5zYXZlKGZhbHNlLHRydWUpO1xyXG4gICAgICAgICAgICAgICAgaXNDb2xsYXBzZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAvL+aJqeWxleWunuS+i++8jOa3u+WKoOWFs+mXreWSjOW8gOWQr+WRveS7pHVuZG9cclxuICAgIG1lLnN0b3BDbWRVbmRvID0gZnVuY3Rpb24oKXtcclxuICAgICAgICBtZS5fX2hhc0VudGVyRXhlY0NvbW1hbmQgPSB0cnVlO1xyXG4gICAgfTtcclxuICAgIG1lLnN0YXJ0Q21kVW5kbyA9IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgbWUuX19oYXNFbnRlckV4ZWNDb21tYW5kID0gZmFsc2U7XHJcbiAgICB9XHJcbn07XHJcblxuXG4vLyBwbHVnaW5zL2NvcHkuanNcblVFLnBsdWdpbi5yZWdpc3RlcignY29weScsIGZ1bmN0aW9uICgpIHtcblxuICAgIHZhciBtZSA9IHRoaXM7XG5cbiAgICBmdW5jdGlvbiBpbml0WmVyb0NsaXBib2FyZCgpIHtcblxuICAgICAgICBaZXJvQ2xpcGJvYXJkLmNvbmZpZyh7XG4gICAgICAgICAgICBkZWJ1ZzogZmFsc2UsXG4gICAgICAgICAgICBzd2ZQYXRoOiBtZS5vcHRpb25zLlVFRElUT1JfSE9NRV9VUkwgKyAndGhpcmQtcGFydHkvemVyb2NsaXBib2FyZC9aZXJvQ2xpcGJvYXJkLnN3ZidcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdmFyIGNsaWVudCA9IG1lLnplcm9jbGlwYm9hcmQgPSBuZXcgWmVyb0NsaXBib2FyZCgpO1xuXG4gICAgICAgIC8vIOWkjeWItuWGheWuuVxuICAgICAgICBjbGllbnQub24oJ2NvcHknLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgdmFyIGNsaWVudCA9IGUuY2xpZW50LFxuICAgICAgICAgICAgICAgIHJuZyA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxuICAgICAgICAgICAgICAgIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuXG4gICAgICAgICAgICBkaXYuYXBwZW5kQ2hpbGQocm5nLmNsb25lQ29udGVudHMoKSk7XG4gICAgICAgICAgICBjbGllbnQuc2V0VGV4dChkaXYuaW5uZXJUZXh0IHx8IGRpdi50ZXh0Q29udGVudCk7XG4gICAgICAgICAgICBjbGllbnQuc2V0SHRtbChkaXYuaW5uZXJIVE1MKTtcbiAgICAgICAgICAgIHJuZy5zZWxlY3QoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIGhvdmVy5LqL5Lu25Lyg6YCS5YiwdGFyZ2V0XG4gICAgICAgIGNsaWVudC5vbignbW91c2VvdmVyIG1vdXNlb3V0JywgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldDtcbiAgICAgICAgICAgIGlmIChlLnR5cGUgPT0gJ21vdXNlb3ZlcicpIHtcbiAgICAgICAgICAgICAgICBkb21VdGlscy5hZGRDbGFzcyh0YXJnZXQsICdlZHVpLXN0YXRlLWhvdmVyJyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGUudHlwZSA9PSAnbW91c2VvdXQnKSB7XG4gICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlQ2xhc3Nlcyh0YXJnZXQsICdlZHVpLXN0YXRlLWhvdmVyJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBmbGFzaOWKoOi9veS4jeaIkOWKn1xuICAgICAgICBjbGllbnQub24oJ3dyb25nZmxhc2ggbm9mbGFzaCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIFplcm9DbGlwYm9hcmQuZGVzdHJveSgpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBiaW5kRXZlbnRzOiB7XG4gICAgICAgICAgICAncmVhZHknOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFicm93c2VyLmllKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuWmVyb0NsaXBib2FyZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5pdFplcm9DbGlwYm9hcmQoKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHV0aWxzLmxvYWRGaWxlKGRvY3VtZW50LCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjOiBtZS5vcHRpb25zLlVFRElUT1JfSE9NRV9VUkwgKyBcInRoaXJkLXBhcnR5L3plcm9jbGlwYm9hcmQvWmVyb0NsaXBib2FyZC5qc1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhZzogXCJzY3JpcHRcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBcInRleHQvamF2YXNjcmlwdFwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVyOiBcImRlZmVyXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbml0WmVyb0NsaXBib2FyZCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGNvbW1hbmRzOiB7XG4gICAgICAgICAgICAnY29weSc6IHtcbiAgICAgICAgICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKGNtZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIW1lLmRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5JykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsZXJ0KG1lLmdldExhbmcoJ2NvcHltc2cnKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59KTtcblxuXG4vLyBwbHVnaW5zL3Bhc3RlLmpzXG4vLy9pbXBvcnQgY29yZVxuLy8vaW1wb3J0IHBsdWdpbnMvaW5zZXJ0aHRtbC5qc1xuLy8vaW1wb3J0IHBsdWdpbnMvdW5kby5qc1xuLy8vaW1wb3J0IHBsdWdpbnMvc2VyaWFsaXplLmpzXG4vLy9jb21tYW5kcyDnspjotLRcbi8vL2NvbW1hbmRzTmFtZSAgUGFzdGVQbGFpblxuLy8vY29tbWFuZHNUaXRsZSAg57qv5paH5pys57KY6LS05qih5byPXG4vKipcbiAqIEBkZXNjcmlwdGlvbiDnspjotLRcbiAqIEBhdXRob3IgemhhbnlpXG4gKi9cblVFLnBsdWdpbnNbJ3Bhc3RlJ10gPSBmdW5jdGlvbiAoKSB7XG4gICAgZnVuY3Rpb24gZ2V0Q2xpcGJvYXJkRGF0YShjYWxsYmFjaykge1xuICAgICAgICB2YXIgZG9jID0gdGhpcy5kb2N1bWVudDtcbiAgICAgICAgaWYgKGRvYy5nZXRFbGVtZW50QnlJZCgnYmFpZHVfcGFzdGViaW4nKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHZhciByYW5nZSA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCksXG4gICAgICAgICAgICBiayA9IHJhbmdlLmNyZWF0ZUJvb2ttYXJrKCksXG4gICAgICAgIC8v5Yib5bu65Ymq6LS055qE5a655ZmoZGl2XG4gICAgICAgICAgICBwYXN0ZWJpbiA9IGRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgcGFzdGViaW4uaWQgPSAnYmFpZHVfcGFzdGViaW4nO1xuICAgICAgICAvLyBTYWZhcmkg6KaB5rGCZGl25b+F6aG75pyJ5YaF5a6577yM5omN6IO957KY6LS05YaF5a656L+b5p2lXG4gICAgICAgIGJyb3dzZXIud2Via2l0ICYmIHBhc3RlYmluLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVUZXh0Tm9kZShkb21VdGlscy5maWxsQ2hhciArIGRvbVV0aWxzLmZpbGxDaGFyKSk7XG4gICAgICAgIGRvYy5ib2R5LmFwcGVuZENoaWxkKHBhc3RlYmluKTtcbiAgICAgICAgLy90cmFjZTo3MTcg6ZqQ6JeP55qEc3BhbuS4jeiDveW+l+WIsHRvcFxuICAgICAgICAvL2JrLnN0YXJ0LmlubmVySFRNTCA9ICcmbmJzcDsnO1xuICAgICAgICBiay5zdGFydC5zdHlsZS5kaXNwbGF5ID0gJyc7XG4gICAgICAgIHBhc3RlYmluLnN0eWxlLmNzc1RleHQgPSBcInBvc2l0aW9uOmFic29sdXRlO3dpZHRoOjFweDtoZWlnaHQ6MXB4O292ZXJmbG93OmhpZGRlbjtsZWZ0Oi0xMDAwcHg7d2hpdGUtc3BhY2U6bm93cmFwO3RvcDpcIiArXG4gICAgICAgICAgICAvL+imgeWcqOeOsOWcqOWFieagh+W5s+ihjOeahOS9jee9ruWKoOWFpe+8jOWQpuWImeS8muWHuueOsOi3s+WKqOeahOmXrumimFxuICAgICAgICAgICAgZG9tVXRpbHMuZ2V0WFkoYmsuc3RhcnQpLnkgKyAncHgnO1xuXG4gICAgICAgIHJhbmdlLnNlbGVjdE5vZGVDb250ZW50cyhwYXN0ZWJpbikuc2VsZWN0KHRydWUpO1xuXG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKGJyb3dzZXIud2Via2l0KSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIHBhc3RlYmlucyA9IGRvYy5xdWVyeVNlbGVjdG9yQWxsKCcjYmFpZHVfcGFzdGViaW4nKSwgcGk7IHBpID0gcGFzdGViaW5zW2krK107KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkb21VdGlscy5pc0VtcHR5Tm9kZShwaSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShwaSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYXN0ZWJpbiA9IHBpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHBhc3RlYmluLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocGFzdGViaW4pO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmFuZ2UubW92ZVRvQm9va21hcmsoYmspLnNlbGVjdCh0cnVlKTtcbiAgICAgICAgICAgIGNhbGxiYWNrKHBhc3RlYmluKTtcbiAgICAgICAgfSwgMCk7XG4gICAgfVxuXG4gICAgdmFyIG1lID0gdGhpcztcblxuICAgIG1lLnNldE9wdCh7XG4gICAgICAgIHJldGFpbk9ubHlMYWJlbFBhc3RlZCA6IGZhbHNlXG4gICAgfSk7XG5cbiAgICB2YXIgdHh0Q29udGVudCwgaHRtbENvbnRlbnQsIGFkZHJlc3M7XG5cbiAgICBmdW5jdGlvbiBnZXRQdXJlSHRtbChodG1sKXtcbiAgICAgICAgcmV0dXJuIGh0bWwucmVwbGFjZSgvPChcXC8/KShbXFx3XFwtXSspKFtePl0qKT4vZ2ksIGZ1bmN0aW9uIChhLCBiLCB0YWdOYW1lLCBhdHRycykge1xuICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIGlmICh7aW1nOiAxfVt0YWdOYW1lXSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBhO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXR0cnMgPSBhdHRycy5yZXBsYWNlKC8oW1xcd1xcLV0qPylcXHMqPVxccyooKFwiKFteXCJdKilcIil8KCcoW14nXSopJyl8KFteXFxzPl0rKSkvZ2ksIGZ1bmN0aW9uIChzdHIsIGF0ciwgdmFsKSB7XG4gICAgICAgICAgICAgICAgaWYgKHtcbiAgICAgICAgICAgICAgICAgICAgJ3NyYyc6IDEsXG4gICAgICAgICAgICAgICAgICAgICdocmVmJzogMSxcbiAgICAgICAgICAgICAgICAgICAgJ25hbWUnOiAxXG4gICAgICAgICAgICAgICAgfVthdHIudG9Mb3dlckNhc2UoKV0pIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF0ciArICc9JyArIHZhbCArICcgJ1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gJydcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaWYgKHtcbiAgICAgICAgICAgICAgICAnc3Bhbic6IDEsXG4gICAgICAgICAgICAgICAgJ2Rpdic6IDFcbiAgICAgICAgICAgIH1bdGFnTmFtZV0pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gJydcbiAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gJzwnICsgYiArIHRhZ05hbWUgKyAnICcgKyB1dGlscy50cmltKGF0dHJzKSArICc+J1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBmdW5jdGlvbiBmaWx0ZXIoZGl2KSB7XG4gICAgICAgIHZhciBodG1sO1xuICAgICAgICBpZiAoZGl2LmZpcnN0Q2hpbGQpIHtcbiAgICAgICAgICAgIC8v5Y675o6JY3V05Lit5re75Yqg55qE6L6555WM5YC8XG4gICAgICAgICAgICB2YXIgbm9kZXMgPSBkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZShkaXYsICdzcGFuJyk7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbmk7IG5pID0gbm9kZXNbaSsrXTspIHtcbiAgICAgICAgICAgICAgICBpZiAobmkuaWQgPT0gJ19iYWlkdV9jdXRfc3RhcnQnIHx8IG5pLmlkID09ICdfYmFpZHVfY3V0X2VuZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKG5pKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChicm93c2VyLndlYmtpdCkge1xuXG4gICAgICAgICAgICAgICAgdmFyIGJycyA9IGRpdi5xdWVyeVNlbGVjdG9yQWxsKCdkaXYgYnInKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgYmk7IGJpID0gYnJzW2krK107KSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwTiA9IGJpLnBhcmVudE5vZGU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwTi50YWdOYW1lID09ICdESVYnICYmIHBOLmNoaWxkTm9kZXMubGVuZ3RoID09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBOLmlubmVySFRNTCA9ICc8cD48YnIvPjwvcD4nO1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHBOKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgZGl2cyA9IGRpdi5xdWVyeVNlbGVjdG9yQWxsKCcjYmFpZHVfcGFzdGViaW4nKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgZGk7IGRpID0gZGl2c1tpKytdOykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdG1wUCA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcbiAgICAgICAgICAgICAgICAgICAgZGkucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodG1wUCwgZGkpO1xuICAgICAgICAgICAgICAgICAgICB3aGlsZSAoZGkuZmlyc3RDaGlsZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdG1wUC5hcHBlbmRDaGlsZChkaS5maXJzdENoaWxkKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoZGkpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHZhciBtZXRhcyA9IGRpdi5xdWVyeVNlbGVjdG9yQWxsKCdtZXRhJyk7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IG1ldGFzW2krK107KSB7XG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShjaSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdmFyIGJycyA9IGRpdi5xdWVyeVNlbGVjdG9yQWxsKCdicicpO1xuICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGNpID0gYnJzW2krK107KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgvXmFwcGxlLS9pLnRlc3QoY2kuY2xhc3NOYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKGNpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChicm93c2VyLmdlY2tvKSB7XG4gICAgICAgICAgICAgICAgdmFyIGRpcnR5Tm9kZXMgPSBkaXYucXVlcnlTZWxlY3RvckFsbCgnW19tb3pfZGlydHldJyk7XG4gICAgICAgICAgICAgICAgZm9yIChpID0gMDsgY2kgPSBkaXJ0eU5vZGVzW2krK107KSB7XG4gICAgICAgICAgICAgICAgICAgIGNpLnJlbW92ZUF0dHJpYnV0ZSgnX21vel9kaXJ0eScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghYnJvd3Nlci5pZSkge1xuICAgICAgICAgICAgICAgIHZhciBzcGFucyA9IGRpdi5xdWVyeVNlbGVjdG9yQWxsKCdzcGFuLkFwcGxlLXN0eWxlLXNwYW4nKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2k7IGNpID0gc3BhbnNbaSsrXTspIHtcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKGNpLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vaWXkuIvkvb/nlKhpbm5lckhUTUzkvJrkuqfnlJ/lpJrkvZnnmoRcXHJcXG7lrZfnrKbvvIzkuZ/kvJrkuqfnlJ8mbmJzcDvov5nph4zov4fmu6TmjolcbiAgICAgICAgICAgIGh0bWwgPSBkaXYuaW5uZXJIVE1MOy8vLnJlcGxhY2UoLz4oPzooXFxzfCZuYnNwOykqPyk8L2csJz48Jyk7XG5cbiAgICAgICAgICAgIC8v6L+H5rukd29yZOeymOi0tOi/h+adpeeahOWGl+S9meWxnuaAp1xuICAgICAgICAgICAgaHRtbCA9IFVFLmZpbHRlcldvcmQoaHRtbCk7XG4gICAgICAgICAgICAvL+WPlua2iOS6huW/veeVpeepuueZveeahOesrOS6jOS4quWPguaVsO+8jOeymOi0tOi/h+adpeeahOacieS6m+aYr+acieepuueZveeahO+8jOS8muiiq+Wll+S4iuebuOWFs+eahOagh+etvlxuICAgICAgICAgICAgdmFyIHJvb3QgPSBVRS5odG1scGFyc2VyKGh0bWwpO1xuICAgICAgICAgICAgLy/lpoLmnpznu5nkuobov4fmu6Top4TliJnlsLHlhYjov5vooYzov4fmu6RcbiAgICAgICAgICAgIGlmIChtZS5vcHRpb25zLmZpbHRlclJ1bGVzKSB7XG4gICAgICAgICAgICAgICAgVUUuZmlsdGVyTm9kZShyb290LCBtZS5vcHRpb25zLmZpbHRlclJ1bGVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8v5omn6KGM6buY6K6k55qE5aSE55CGXG4gICAgICAgICAgICBtZS5maWx0ZXJJbnB1dFJ1bGUocm9vdCk7XG4gICAgICAgICAgICAvL+mSiOWvuWNocm9tZeeahOWkhOeQhlxuICAgICAgICAgICAgaWYgKGJyb3dzZXIud2Via2l0KSB7XG4gICAgICAgICAgICAgICAgdmFyIGJyID0gcm9vdC5sYXN0Q2hpbGQoKTtcbiAgICAgICAgICAgICAgICBpZiAoYnIgJiYgYnIudHlwZSA9PSAnZWxlbWVudCcgJiYgYnIudGFnTmFtZSA9PSAnYnInKSB7XG4gICAgICAgICAgICAgICAgICAgIHJvb3QucmVtb3ZlQ2hpbGQoYnIpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHV0aWxzLmVhY2gobWUuYm9keS5xdWVyeVNlbGVjdG9yQWxsKCdkaXYnKSwgZnVuY3Rpb24gKG5vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRvbVV0aWxzLmlzRW1wdHlCbG9jayhub2RlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKG5vZGUsdHJ1ZSlcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBodG1sID0geydodG1sJzogcm9vdC50b0h0bWwoKX07XG4gICAgICAgICAgICBtZS5maXJlRXZlbnQoJ2JlZm9yZXBhc3RlJywgaHRtbCwgcm9vdCk7XG4gICAgICAgICAgICAvL+aKouS6hum7mOiupOeahOeymOi0tO+8jOmCo+WQjui+ueeahOWGheWuueWwseS4jeaJp+ihjOS6hu+8jOavlOWmguihqOagvOeymOi0tFxuICAgICAgICAgICAgaWYoIWh0bWwuaHRtbCl7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcm9vdCA9IFVFLmh0bWxwYXJzZXIoaHRtbC5odG1sLHRydWUpO1xuICAgICAgICAgICAgLy/lpoLmnpzlvIDlkK/kuobnuq/mlofmnKzmqKHlvI9cbiAgICAgICAgICAgIGlmIChtZS5xdWVyeUNvbW1hbmRTdGF0ZSgncGFzdGVwbGFpbicpID09PSAxKSB7XG4gICAgICAgICAgICAgICAgbWUuZXhlY0NvbW1hbmQoJ2luc2VydEh0bWwnLCBVRS5maWx0ZXJOb2RlKHJvb3QsIG1lLm9wdGlvbnMuZmlsdGVyVHh0UnVsZXMpLnRvSHRtbCgpLCB0cnVlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy/mlofmnKzmqKHlvI9cbiAgICAgICAgICAgICAgICBVRS5maWx0ZXJOb2RlKHJvb3QsIG1lLm9wdGlvbnMuZmlsdGVyVHh0UnVsZXMpO1xuICAgICAgICAgICAgICAgIHR4dENvbnRlbnQgPSByb290LnRvSHRtbCgpO1xuICAgICAgICAgICAgICAgIC8v5a6M5YWo5qih5byPXG4gICAgICAgICAgICAgICAgaHRtbENvbnRlbnQgPSBodG1sLmh0bWw7XG5cbiAgICAgICAgICAgICAgICBhZGRyZXNzID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCkuY3JlYXRlQWRkcmVzcyh0cnVlKTtcbiAgICAgICAgICAgICAgICBtZS5leGVjQ29tbWFuZCgnaW5zZXJ0SHRtbCcsIG1lLmdldE9wdCgncmV0YWluT25seUxhYmVsUGFzdGVkJykgPT09IHRydWUgPyAgZ2V0UHVyZUh0bWwoaHRtbENvbnRlbnQpIDogaHRtbENvbnRlbnQsIHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbWUuZmlyZUV2ZW50KFwiYWZ0ZXJwYXN0ZVwiLCBodG1sKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG1lLmFkZExpc3RlbmVyKCdwYXN0ZVRyYW5zZmVyJywgZnVuY3Rpb24gKGNtZCwgcGxhaW5UeXBlKSB7XG5cbiAgICAgICAgaWYgKGFkZHJlc3MgJiYgdHh0Q29udGVudCAmJiBodG1sQ29udGVudCAmJiB0eHRDb250ZW50ICE9IGh0bWxDb250ZW50KSB7XG4gICAgICAgICAgICB2YXIgcmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcbiAgICAgICAgICAgIHJhbmdlLm1vdmVUb0FkZHJlc3MoYWRkcmVzcywgdHJ1ZSk7XG5cbiAgICAgICAgICAgIGlmICghcmFuZ2UuY29sbGFwc2VkKSB7XG5cbiAgICAgICAgICAgICAgICB3aGlsZSAoIWRvbVV0aWxzLmlzQm9keShyYW5nZS5zdGFydENvbnRhaW5lcilcbiAgICAgICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IHJhbmdlLnN0YXJ0Q29udGFpbmVyO1xuICAgICAgICAgICAgICAgICAgICBpZihzdGFydC5ub2RlVHlwZSA9PSAxKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gc3RhcnQuY2hpbGROb2Rlc1tyYW5nZS5zdGFydE9mZnNldF07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZighc3RhcnQpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0QmVmb3JlKHJhbmdlLnN0YXJ0Q29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmUgPSBzdGFydC5wcmV2aW91c1NpYmxpbmc7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHByZSAmJiBwcmUubm9kZVR5cGUgPT0gMyAmJiBuZXcgUmVnRXhwKCdeW1xcblxcclxcdCAnK2RvbVV0aWxzLmZpbGxDaGFyKyddKiQnKS50ZXN0KHByZS5ub2RlVmFsdWUpKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydEJlZm9yZShwcmUpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYocmFuZ2Uuc3RhcnRPZmZzZXQgPT0gMCl7XG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydEJlZm9yZShyYW5nZS5zdGFydENvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB3aGlsZSAoIWRvbVV0aWxzLmlzQm9keShyYW5nZS5lbmRDb250YWluZXIpXG4gICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZW5kID0gcmFuZ2UuZW5kQ29udGFpbmVyO1xuICAgICAgICAgICAgICAgICAgICBpZihlbmQubm9kZVR5cGUgPT0gMSl7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbmQgPSBlbmQuY2hpbGROb2Rlc1tyYW5nZS5lbmRPZmZzZXRdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWVuZCl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0RW5kQWZ0ZXIocmFuZ2UuZW5kQ29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gZW5kLm5leHRTaWJsaW5nO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYobmV4dCAmJiBuZXh0Lm5vZGVUeXBlID09IDMgJiYgbmV3IFJlZ0V4cCgnXltcXG5cXHJcXHQnK2RvbVV0aWxzLmZpbGxDaGFyKyddKiQnKS50ZXN0KG5leHQubm9kZVZhbHVlKSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0RW5kQWZ0ZXIobmV4dClcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZihyYW5nZS5lbmRPZmZzZXQgPT0gcmFuZ2UuZW5kQ29udGFpbmVyW3JhbmdlLmVuZENvbnRhaW5lci5ub2RlVHlwZSA9PSAzID8gJ25vZGVWYWx1ZScgOiAnY2hpbGROb2RlcyddLmxlbmd0aCl7XG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRFbmRBZnRlcihyYW5nZS5lbmRDb250YWluZXIpO1xuICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmFuZ2UuZGVsZXRlQ29udGVudHMoKTtcbiAgICAgICAgICAgIHJhbmdlLnNlbGVjdCh0cnVlKTtcbiAgICAgICAgICAgIG1lLl9faGFzRW50ZXJFeGVjQ29tbWFuZCA9IHRydWU7XG4gICAgICAgICAgICB2YXIgaHRtbCA9IGh0bWxDb250ZW50O1xuICAgICAgICAgICAgaWYgKHBsYWluVHlwZSA9PT0gMiApIHtcbiAgICAgICAgICAgICAgICBodG1sID0gZ2V0UHVyZUh0bWwoaHRtbCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHBsYWluVHlwZSkge1xuICAgICAgICAgICAgICAgIGh0bWwgPSB0eHRDb250ZW50O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbWUuZXhlY0NvbW1hbmQoJ2luc2VydGh0bWwnLCBodG1sLCB0cnVlKTtcbiAgICAgICAgICAgIG1lLl9faGFzRW50ZXJFeGVjQ29tbWFuZCA9IGZhbHNlO1xuICAgICAgICAgICAgdmFyIHJuZyA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xuICAgICAgICAgICAgd2hpbGUgKCFkb21VdGlscy5pc0JvZHkocm5nLnN0YXJ0Q29udGFpbmVyKSAmJiAhcm5nLnN0YXJ0T2Zmc2V0ICYmXG4gICAgICAgICAgICAgICAgcm5nLnN0YXJ0Q29udGFpbmVyW3JuZy5zdGFydENvbnRhaW5lci5ub2RlVHlwZSA9PSAzID8gJ25vZGVWYWx1ZScgOiAnY2hpbGROb2RlcyddLmxlbmd0aFxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIHJuZy5zZXRTdGFydEJlZm9yZShybmcuc3RhcnRDb250YWluZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHRtcEFkZHJlc3MgPSBybmcuY3JlYXRlQWRkcmVzcyh0cnVlKTtcbiAgICAgICAgICAgIGFkZHJlc3MuZW5kQWRkcmVzcyA9IHRtcEFkZHJlc3Muc3RhcnRBZGRyZXNzO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICBtZS5hZGRMaXN0ZW5lcigncmVhZHknLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGRvbVV0aWxzLm9uKG1lLmJvZHksICdjdXQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgcmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcbiAgICAgICAgICAgIGlmICghcmFuZ2UuY29sbGFwc2VkICYmIG1lLnVuZG9NYW5nZXIpIHtcbiAgICAgICAgICAgICAgICBtZS51bmRvTWFuZ2VyLnNhdmUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9pZeS4i2JlZm9yZXBhc3Rl5Zyo54K55Ye75Y+z6ZSu5pe25Lmf5Lya6Kem5Y+R77yM5omA5Lul55So55uR5o6n6ZSu55uY5omN5aSE55CGXG4gICAgICAgIGRvbVV0aWxzLm9uKG1lLmJvZHksIGJyb3dzZXIuaWUgfHwgYnJvd3Nlci5vcGVyYSA/ICdrZXlkb3duJyA6ICdwYXN0ZScsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICBpZiAoKGJyb3dzZXIuaWUgfHwgYnJvd3Nlci5vcGVyYSkgJiYgKCghZS5jdHJsS2V5ICYmICFlLm1ldGFLZXkpIHx8IGUua2V5Q29kZSAhPSAnODYnKSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGdldENsaXBib2FyZERhdGEuY2FsbChtZSwgZnVuY3Rpb24gKGRpdikge1xuICAgICAgICAgICAgICAgIGZpbHRlcihkaXYpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgfSk7XG5cbiAgICBtZS5jb21tYW5kc1sncGFzdGUnXSA9IHtcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uIChjbWQpIHtcbiAgICAgICAgICAgIGlmIChicm93c2VyLmllKSB7XG4gICAgICAgICAgICAgICAgZ2V0Q2xpcGJvYXJkRGF0YS5jYWxsKG1lLCBmdW5jdGlvbiAoZGl2KSB7XG4gICAgICAgICAgICAgICAgICAgIGZpbHRlcihkaXYpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIG1lLmRvY3VtZW50LmV4ZWNDb21tYW5kKCdwYXN0ZScpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBhbGVydChtZS5nZXRMYW5nKCdwYXN0ZW1zZycpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5cblxuXG4vLyBwbHVnaW5zL3B1cmV0eHRwYXN0ZS5qc1xuLyoqXHJcbiAqIOe6r+aWh+acrOeymOi0tOaPkuS7tlxyXG4gKiBAZmlsZVxyXG4gKiBAc2luY2UgMS4yLjYuMVxyXG4gKi9cclxuXHJcblVFLnBsdWdpbnNbJ3Bhc3RlcGxhaW4nXSA9IGZ1bmN0aW9uKCl7XHJcbiAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgbWUuc2V0T3B0KHtcclxuICAgICAgICAncGFzdGVwbGFpbic6ZmFsc2UsXHJcbiAgICAgICAgJ2ZpbHRlclR4dFJ1bGVzJyA6IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIHRyYW5zUChub2RlKXtcclxuICAgICAgICAgICAgICAgIG5vZGUudGFnTmFtZSA9ICdwJztcclxuICAgICAgICAgICAgICAgIG5vZGUuc2V0U3R5bGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBmdW5jdGlvbiByZW1vdmVOb2RlKG5vZGUpe1xyXG4gICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUsdHJ1ZSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgLy/nm7TmjqXliKDpmaTlj4rlhbblrZfoioLngrnlhoXlrrlcclxuICAgICAgICAgICAgICAgICctJyA6ICdzY3JpcHQgc3R5bGUgb2JqZWN0IGlmcmFtZSBlbWJlZCBpbnB1dCBzZWxlY3QnLFxyXG4gICAgICAgICAgICAgICAgJ3AnOiB7JDp7fX0sXHJcbiAgICAgICAgICAgICAgICAnYnInOnskOnt9fSxcclxuICAgICAgICAgICAgICAgIGRpdjogZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgdG1wTm9kZSwgcCA9IFVFLnVOb2RlLmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuICAgICAgICAgICAgICAgICAgICB3aGlsZSAodG1wTm9kZSA9IG5vZGUuZmlyc3RDaGlsZCgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0bXBOb2RlLnR5cGUgPT0gJ3RleHQnIHx8ICFVRS5kb20uZHRkLiRibG9ja1t0bXBOb2RlLnRhZ05hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLmFwcGVuZENoaWxkKHRtcE5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAuZmlyc3RDaGlsZCgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShwLCBub2RlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwID0gVUUudU5vZGUuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRtcE5vZGUsIG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwLmZpcnN0Q2hpbGQoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHAsIG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgb2w6IHJlbW92ZU5vZGUsXHJcbiAgICAgICAgICAgICAgICB1bDogcmVtb3ZlTm9kZSxcclxuICAgICAgICAgICAgICAgIGRsOnJlbW92ZU5vZGUsXHJcbiAgICAgICAgICAgICAgICBkdDpyZW1vdmVOb2RlLFxyXG4gICAgICAgICAgICAgICAgZGQ6cmVtb3ZlTm9kZSxcclxuICAgICAgICAgICAgICAgICdsaSc6cmVtb3ZlTm9kZSxcclxuICAgICAgICAgICAgICAgICdjYXB0aW9uJzp0cmFuc1AsXHJcbiAgICAgICAgICAgICAgICAndGgnOnRyYW5zUCxcclxuICAgICAgICAgICAgICAgICd0cic6dHJhbnNQLFxyXG4gICAgICAgICAgICAgICAgJ2gxJzp0cmFuc1AsJ2gyJzp0cmFuc1AsJ2gzJzp0cmFuc1AsJ2g0Jzp0cmFuc1AsJ2g1Jzp0cmFuc1AsJ2g2Jzp0cmFuc1AsXHJcbiAgICAgICAgICAgICAgICAndGQnOmZ1bmN0aW9uKG5vZGUpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL+ayoeacieWGheWuueeahHRk55u05o6l5Yig5o6JXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0eHQgPSAhIW5vZGUuaW5uZXJUZXh0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHR4dCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUuaW5zZXJ0QWZ0ZXIoVUUudU5vZGUuY3JlYXRlVGV4dCgnICZuYnNwOyAmbmJzcDsnKSxub2RlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUsbm9kZS5pbm5lclRleHQoKSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0oKVxyXG4gICAgfSk7XHJcbiAgICAvL+aaguaXtui/memHjOaUr+aMgeS4gOS4i+iAgeeJiOacrOeahOWxnuaAp1xyXG4gICAgdmFyIHBhc3RlcGxhaW4gPSBtZS5vcHRpb25zLnBhc3RlcGxhaW47XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlkK/nlKjmiJblj5bmtojnuq/mlofmnKznspjotLTmqKHlvI9cclxuICAgICAqIEBjb21tYW5kIHBhc3RlcGxhaW5cclxuICAgICAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiBlZGl0b3IucXVlcnlDb21tYW5kU3RhdGUoICdwYXN0ZXBsYWluJyApO1xyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIOafpeivouW9k+WJjeaYr+WQpuWkhOS6jue6r+aWh+acrOeymOi0tOaooeW8j1xyXG4gICAgICogQGNvbW1hbmQgcGFzdGVwbGFpblxyXG4gICAgICogQG1ldGhvZCBxdWVyeUNvbW1hbmRTdGF0ZVxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gICAgICogQHJldHVybiB7IGludCB9IOWmguaenOWkhOS6jue6r+aWh+acrOaooeW8j++8jOi/lOWbnjHvvIzlkKbliJnvvIzov5Tlm54wXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogZWRpdG9yLnF1ZXJ5Q29tbWFuZFN0YXRlKCAncGFzdGVwbGFpbicgKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICBtZS5jb21tYW5kc1sncGFzdGVwbGFpbiddID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgcmV0dXJuIHBhc3RlcGxhaW4gPyAxIDogMDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgcGFzdGVwbGFpbiA9ICFwYXN0ZXBsYWlufDA7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBub3ROZWVkVW5kbyA6IDFcclxuICAgIH07XHJcbn07XG5cbi8vIHBsdWdpbnMvbGlzdC5qc1xuLyoqXHJcbiAqIOacieW6j+WIl+ihqCzml6Dluo/liJfooajmj5Lku7ZcclxuICogQGZpbGVcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG5VRS5wbHVnaW5zWydsaXN0J10gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgbWUgPSB0aGlzLFxyXG4gICAgICAgIG5vdEV4Y2hhbmdlID0ge1xyXG4gICAgICAgICAgICAnVEQnOjEsXHJcbiAgICAgICAgICAgICdQUkUnOjEsXHJcbiAgICAgICAgICAgICdCTE9DS1FVT1RFJzoxXHJcbiAgICAgICAgfTtcclxuICAgIHZhciBjdXN0b21TdHlsZSA9IHtcclxuICAgICAgICAnY24nIDogJ2NuLTEtJyxcclxuICAgICAgICAnY24xJyA6ICdjbi0yLScsXHJcbiAgICAgICAgJ2NuMicgOiAnY24tMy0nLFxyXG4gICAgICAgICdudW0nOiAgJ251bS0xLScsXHJcbiAgICAgICAgJ251bTEnIDogJ251bS0yLScsXHJcbiAgICAgICAgJ251bTInIDogJ251bS0zLScsXHJcbiAgICAgICAgJ2Rhc2gnICA6ICdkYXNoJyxcclxuICAgICAgICAnZG90JzonZG90J1xyXG4gICAgfTtcclxuXHJcbiAgICBtZS5zZXRPcHQoIHtcclxuICAgICAgICAnYXV0b1RyYW5zV29yZFRvTGlzdCc6ZmFsc2UsXHJcbiAgICAgICAgJ2luc2VydG9yZGVyZWRsaXN0Jzp7XHJcbiAgICAgICAgICAgICdudW0nOicnLFxyXG4gICAgICAgICAgICAnbnVtMSc6JycsXHJcbiAgICAgICAgICAgICdudW0yJzonJyxcclxuICAgICAgICAgICAgJ2NuJzonJyxcclxuICAgICAgICAgICAgJ2NuMSc6JycsXHJcbiAgICAgICAgICAgICdjbjInOicnLFxyXG4gICAgICAgICAgICAnZGVjaW1hbCc6JycsXHJcbiAgICAgICAgICAgICdsb3dlci1hbHBoYSc6JycsXHJcbiAgICAgICAgICAgICdsb3dlci1yb21hbic6JycsXHJcbiAgICAgICAgICAgICd1cHBlci1hbHBoYSc6JycsXHJcbiAgICAgICAgICAgICd1cHBlci1yb21hbic6JydcclxuICAgICAgICB9LFxyXG4gICAgICAgICdpbnNlcnR1bm9yZGVyZWRsaXN0Jzp7XHJcbiAgICAgICAgICAgICdjaXJjbGUnOicnLFxyXG4gICAgICAgICAgICAnZGlzYyc6JycsXHJcbiAgICAgICAgICAgICdzcXVhcmUnOicnLFxyXG4gICAgICAgICAgICAnZGFzaCcgOiAnJyxcclxuICAgICAgICAgICAgJ2RvdCc6JydcclxuICAgICAgICB9LFxyXG4gICAgICAgIGxpc3REZWZhdWx0UGFkZGluZ0xlZnQgOiAnMzAnLFxyXG4gICAgICAgIGxpc3RpY29ucGF0aCA6ICdodHRwOi8vYnMuYmFpZHUuY29tL2xpc3RpY29uLycsXHJcbiAgICAgICAgbWF4TGlzdExldmVsIDogLTEsLy8tMeS4jemZkOWItlxyXG4gICAgICAgIGRpc2FibGVQSW5MaXN0OmZhbHNlXHJcbiAgICB9ICk7XHJcbiAgICBmdW5jdGlvbiBsaXN0VG9BcnJheShsaXN0KXtcclxuICAgICAgICB2YXIgYXJyID0gW107XHJcbiAgICAgICAgZm9yKHZhciBwIGluIGxpc3Qpe1xyXG4gICAgICAgICAgICBhcnIucHVzaChwKVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYXJyO1xyXG4gICAgfVxyXG4gICAgdmFyIGxpc3RTdHlsZSA9IHtcclxuICAgICAgICAnT0wnOmxpc3RUb0FycmF5KG1lLm9wdGlvbnMuaW5zZXJ0b3JkZXJlZGxpc3QpLFxyXG4gICAgICAgICdVTCc6bGlzdFRvQXJyYXkobWUub3B0aW9ucy5pbnNlcnR1bm9yZGVyZWRsaXN0KVxyXG4gICAgfTtcclxuICAgIHZhciBsaWljb25wYXRoID0gbWUub3B0aW9ucy5saXN0aWNvbnBhdGg7XHJcblxyXG4gICAgLy/moLnmja7nlKjmiLfphY3nva7vvIzosIPmlbRjdXN0b21TdHlsZVxyXG4gICAgZm9yKHZhciBzIGluIGN1c3RvbVN0eWxlKXtcclxuICAgICAgICBpZighbWUub3B0aW9ucy5pbnNlcnRvcmRlcmVkbGlzdC5oYXNPd25Qcm9wZXJ0eShzKSAmJiAhbWUub3B0aW9ucy5pbnNlcnR1bm9yZGVyZWRsaXN0Lmhhc093blByb3BlcnR5KHMpKXtcclxuICAgICAgICAgICAgZGVsZXRlIGN1c3RvbVN0eWxlW3NdO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBtZS5yZWFkeShmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyIGN1c3RvbUNzcyA9IFtdO1xyXG4gICAgICAgIGZvcih2YXIgcCBpbiBjdXN0b21TdHlsZSl7XHJcbiAgICAgICAgICAgIGlmKHAgPT0gJ2Rhc2gnIHx8IHAgPT0gJ2RvdCcpe1xyXG4gICAgICAgICAgICAgICAgY3VzdG9tQ3NzLnB1c2goJ2xpLmxpc3QtJyArIGN1c3RvbVN0eWxlW3BdICsgJ3tiYWNrZ3JvdW5kLWltYWdlOnVybCgnICsgbGlpY29ucGF0aCArY3VzdG9tU3R5bGVbcF0rJy5naWYpfScpO1xyXG4gICAgICAgICAgICAgICAgY3VzdG9tQ3NzLnB1c2goJ3VsLmN1c3RvbV8nK3ArJ3tsaXN0LXN0eWxlOm5vbmU7fXVsLmN1c3RvbV8nK3ArJyBsaXtiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgM3B4O2JhY2tncm91bmQtcmVwZWF0Om5vLXJlcGVhdH0nKTtcclxuICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICBmb3IodmFyIGk9IDA7aTw5OTtpKyspe1xyXG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbUNzcy5wdXNoKCdsaS5saXN0LScgKyBjdXN0b21TdHlsZVtwXSArIGkgKyAne2JhY2tncm91bmQtaW1hZ2U6dXJsKCcgKyBsaWljb25wYXRoICsgJ2xpc3QtJytjdXN0b21TdHlsZVtwXSArIGkgKyAnLmdpZil9JylcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGN1c3RvbUNzcy5wdXNoKCdvbC5jdXN0b21fJytwKyd7bGlzdC1zdHlsZTpub25lO31vbC5jdXN0b21fJytwKycgbGl7YmFja2dyb3VuZC1wb3NpdGlvbjowIDNweDtiYWNrZ3JvdW5kLXJlcGVhdDpuby1yZXBlYXR9Jyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc3dpdGNoKHApe1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnY24nOlxyXG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbUNzcy5wdXNoKCdsaS5saXN0LScrcCsnLXBhZGRpbmdsZWZ0LTF7cGFkZGluZy1sZWZ0OjI1cHh9Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tQ3NzLnB1c2goJ2xpLmxpc3QtJytwKyctcGFkZGluZ2xlZnQtMntwYWRkaW5nLWxlZnQ6NDBweH0nKTtcclxuICAgICAgICAgICAgICAgICAgICBjdXN0b21Dc3MucHVzaCgnbGkubGlzdC0nK3ArJy1wYWRkaW5nbGVmdC0ze3BhZGRpbmctbGVmdDo1NXB4fScpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnY24xJzpcclxuICAgICAgICAgICAgICAgICAgICBjdXN0b21Dc3MucHVzaCgnbGkubGlzdC0nK3ArJy1wYWRkaW5nbGVmdC0xe3BhZGRpbmctbGVmdDozMHB4fScpO1xyXG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbUNzcy5wdXNoKCdsaS5saXN0LScrcCsnLXBhZGRpbmdsZWZ0LTJ7cGFkZGluZy1sZWZ0OjQwcHh9Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tQ3NzLnB1c2goJ2xpLmxpc3QtJytwKyctcGFkZGluZ2xlZnQtM3twYWRkaW5nLWxlZnQ6NTVweH0nKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ2NuMic6XHJcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tQ3NzLnB1c2goJ2xpLmxpc3QtJytwKyctcGFkZGluZ2xlZnQtMXtwYWRkaW5nLWxlZnQ6NDBweH0nKTtcclxuICAgICAgICAgICAgICAgICAgICBjdXN0b21Dc3MucHVzaCgnbGkubGlzdC0nK3ArJy1wYWRkaW5nbGVmdC0ye3BhZGRpbmctbGVmdDo1NXB4fScpO1xyXG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbUNzcy5wdXNoKCdsaS5saXN0LScrcCsnLXBhZGRpbmdsZWZ0LTN7cGFkZGluZy1sZWZ0OjY4cHh9Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdudW0nOlxyXG4gICAgICAgICAgICAgICAgY2FzZSAnbnVtMSc6XHJcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tQ3NzLnB1c2goJ2xpLmxpc3QtJytwKyctcGFkZGluZ2xlZnQtMXtwYWRkaW5nLWxlZnQ6MjVweH0nKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ251bTInOlxyXG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbUNzcy5wdXNoKCdsaS5saXN0LScrcCsnLXBhZGRpbmdsZWZ0LTF7cGFkZGluZy1sZWZ0OjM1cHh9Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tQ3NzLnB1c2goJ2xpLmxpc3QtJytwKyctcGFkZGluZ2xlZnQtMntwYWRkaW5nLWxlZnQ6NDBweH0nKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ2Rhc2gnOlxyXG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbUNzcy5wdXNoKCdsaS5saXN0LScrcCsnLXBhZGRpbmdsZWZ0e3BhZGRpbmctbGVmdDozNXB4fScpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnZG90JzpcclxuICAgICAgICAgICAgICAgICAgICBjdXN0b21Dc3MucHVzaCgnbGkubGlzdC0nK3ArJy1wYWRkaW5nbGVmdHtwYWRkaW5nLWxlZnQ6MjBweH0nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBjdXN0b21Dc3MucHVzaCgnLmxpc3QtcGFkZGluZ2xlZnQtMXtwYWRkaW5nLWxlZnQ6MH0nKTtcclxuICAgICAgICBjdXN0b21Dc3MucHVzaCgnLmxpc3QtcGFkZGluZ2xlZnQtMntwYWRkaW5nLWxlZnQ6JyttZS5vcHRpb25zLmxpc3REZWZhdWx0UGFkZGluZ0xlZnQrJ3B4fScpO1xyXG4gICAgICAgIGN1c3RvbUNzcy5wdXNoKCcubGlzdC1wYWRkaW5nbGVmdC0ze3BhZGRpbmctbGVmdDonK21lLm9wdGlvbnMubGlzdERlZmF1bHRQYWRkaW5nTGVmdCoyKydweH0nKTtcclxuICAgICAgICAvL+WmguaenOS4jee7meWuveW6puS8muWcqOiHquWumuW6lOagt+W8j+mHjOWHuueOsOa7muWKqOadoVxyXG4gICAgICAgIHV0aWxzLmNzc1J1bGUoJ2xpc3QnLCAnb2wsdWx7bWFyZ2luOjA7cGFkaW5nOjA7JysoYnJvd3Nlci5pZSA/ICcnIDogJ3dpZHRoOjk1JScpKyd9bGl7Y2xlYXI6Ym90aDt9JytjdXN0b21Dc3Muam9pbignXFxuJyksIG1lLmRvY3VtZW50KTtcclxuICAgIH0pO1xyXG4gICAgLy/ljZXni6zlpITnkIbliarliIfnmoTpl67pophcclxuICAgIG1lLnJlYWR5KGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgZG9tVXRpbHMub24obWUuYm9keSwnY3V0JyxmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICB2YXIgcm5nID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCksbGk7XHJcbiAgICAgICAgICAgICAgICAvL3RyYWNlOjM0MTZcclxuICAgICAgICAgICAgICAgIGlmKCFybmcuY29sbGFwc2VkKXtcclxuICAgICAgICAgICAgICAgICAgICBpZihsaSA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocm5nLnN0YXJ0Q29udGFpbmVyLCdsaScsdHJ1ZSkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZighbGkubmV4dFNpYmxpbmcgJiYgZG9tVXRpbHMuaXNFbXB0eUJsb2NrKGxpKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcG4gPSBsaS5wYXJlbnROb2RlLG5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihub2RlID0gcG4ucHJldmlvdXNTaWJsaW5nKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUocG4pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJuZy5zZXRTdGFydEF0TGFzdChub2RlKS5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBybmcuc2VsZWN0KHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYobm9kZSA9IHBuLm5leHRTaWJsaW5nKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUocG4pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJuZy5zZXRTdGFydEF0Rmlyc3Qobm9kZSkuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm5nLnNlbGVjdCh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0bXBOb2RlID0gbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmZpbGxOb2RlKG1lLmRvY3VtZW50LHRtcE5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBuLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRtcE5vZGUscG4pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShwbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm5nLnNldFN0YXJ0KHRtcE5vZGUsMCkuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm5nLnNlbGVjdCh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSlcclxuICAgIH0pO1xyXG5cclxuICAgIGZ1bmN0aW9uIGdldFN0eWxlKG5vZGUpe1xyXG4gICAgICAgIHZhciBjbHMgPSBub2RlLmNsYXNzTmFtZTtcclxuICAgICAgICBpZihkb21VdGlscy5oYXNDbGFzcyhub2RlLC9jdXN0b21fLykpe1xyXG4gICAgICAgICAgICByZXR1cm4gY2xzLm1hdGNoKC9jdXN0b21fKFxcdyspLylbMV1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGRvbVV0aWxzLmdldFN0eWxlKG5vZGUsICdsaXN0LXN0eWxlLXR5cGUnKVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBtZS5hZGRMaXN0ZW5lcignYmVmb3JlcGFzdGUnLGZ1bmN0aW9uKHR5cGUsaHRtbCl7XHJcbiAgICAgICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICAgICAgcm5nID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCksbGk7XHJcbiAgICAgICAgdmFyIHJvb3QgPSBVRS5odG1scGFyc2VyKGh0bWwuaHRtbCx0cnVlKTtcclxuICAgICAgICBpZihsaSA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocm5nLnN0YXJ0Q29udGFpbmVyLCdsaScsdHJ1ZSkpe1xyXG4gICAgICAgICAgICB2YXIgbGlzdCA9IGxpLnBhcmVudE5vZGUsdGFnTmFtZSA9IGxpc3QudGFnTmFtZSA9PSAnT0wnID8gJ3VsJzonb2wnO1xyXG4gICAgICAgICAgICB1dGlscy5lYWNoKHJvb3QuZ2V0Tm9kZXNCeVRhZ05hbWUodGFnTmFtZSksZnVuY3Rpb24obil7XHJcbiAgICAgICAgICAgICAgICBuLnRhZ05hbWUgPSBsaXN0LnRhZ05hbWU7XHJcbiAgICAgICAgICAgICAgICBuLnNldEF0dHIoKTtcclxuICAgICAgICAgICAgICAgIGlmKG4ucGFyZW50Tm9kZSA9PT0gcm9vdCl7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZSA9IGdldFN0eWxlKGxpc3QpIHx8IChsaXN0LnRhZ05hbWUgPT0gJ09MJyA/ICdkZWNpbWFsJyA6ICdkaXNjJylcclxuICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjbGFzc05hbWUgPSBuLnBhcmVudE5vZGUuZ2V0QXR0cignY2xhc3MnKTtcclxuICAgICAgICAgICAgICAgICAgICBpZihjbGFzc05hbWUgJiYgL2N1c3RvbV8vLnRlc3QoY2xhc3NOYW1lKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSBjbGFzc05hbWUubWF0Y2goL2N1c3RvbV8oXFx3KykvKVsxXVxyXG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gbi5wYXJlbnROb2RlLmdldFN0eWxlKCdsaXN0LXN0eWxlLXR5cGUnKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoIXR5cGUpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gbGlzdC50YWdOYW1lID09ICdPTCcgPyAnZGVjaW1hbCcgOiAnZGlzYyc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gdXRpbHMuaW5kZXhPZihsaXN0U3R5bGVbbGlzdC50YWdOYW1lXSwgdHlwZSk7XHJcbiAgICAgICAgICAgICAgICBpZihuLnBhcmVudE5vZGUgIT09IHJvb3QpXHJcbiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBpbmRleCArIDEgPT0gbGlzdFN0eWxlW2xpc3QudGFnTmFtZV0ubGVuZ3RoID8gMCA6IGluZGV4ICsgMTtcclxuICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U3R5bGUgPSBsaXN0U3R5bGVbbGlzdC50YWdOYW1lXVtpbmRleF07XHJcbiAgICAgICAgICAgICAgICBpZihjdXN0b21TdHlsZVtjdXJyZW50U3R5bGVdKXtcclxuICAgICAgICAgICAgICAgICAgICBuLnNldEF0dHIoJ2NsYXNzJywgJ2N1c3RvbV8nICsgY3VycmVudFN0eWxlKVxyXG5cclxuICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgIG4uc2V0U3R5bGUoJ2xpc3Qtc3R5bGUtdHlwZScsY3VycmVudFN0eWxlKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGh0bWwuaHRtbCA9IHJvb3QudG9IdG1sKCk7XHJcbiAgICB9KTtcclxuICAgIC8v5a+85Ye65pe277yM5Y675o6JcOagh+etvlxyXG4gICAgbWUuZ2V0T3B0KCdkaXNhYmxlUEluTGlzdCcpID09PSB0cnVlICYmIG1lLmFkZE91dHB1dFJ1bGUoZnVuY3Rpb24ocm9vdCl7XHJcbiAgICAgICAgdXRpbHMuZWFjaChyb290LmdldE5vZGVzQnlUYWdOYW1lKCdsaScpLGZ1bmN0aW9uKGxpKXtcclxuICAgICAgICAgICAgdmFyIG5ld0NoaWxkcmVucyA9IFtdLGluZGV4PTA7XHJcbiAgICAgICAgICAgIHV0aWxzLmVhY2gobGkuY2hpbGRyZW4sZnVuY3Rpb24obil7XHJcbiAgICAgICAgICAgICAgICBpZihuLnRhZ05hbWUgPT0gJ3AnKXtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgdG1wTm9kZTtcclxuICAgICAgICAgICAgICAgICAgICB3aGlsZSh0bXBOb2RlID0gbi5jaGlsZHJlbi5wb3AoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdDaGlsZHJlbnMuc3BsaWNlKGluZGV4LDAsdG1wTm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRtcE5vZGUucGFyZW50Tm9kZSA9IGxpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0Tm9kZSA9IHRtcE5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHRtcE5vZGUgPSBuZXdDaGlsZHJlbnNbbmV3Q2hpbGRyZW5zLmxlbmd0aC0xXTtcclxuICAgICAgICAgICAgICAgICAgICBpZighdG1wTm9kZSB8fCB0bXBOb2RlLnR5cGUgIT0gJ2VsZW1lbnQnIHx8IHRtcE5vZGUudGFnTmFtZSAhPSAnYnInKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJyID0gVUUudU5vZGUuY3JlYXRlRWxlbWVudCgnYnInKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnIucGFyZW50Tm9kZSA9IGxpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdDaGlsZHJlbnMucHVzaChicik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpbmRleCA9IG5ld0NoaWxkcmVucy5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBpZihuZXdDaGlsZHJlbnMubGVuZ3RoKXtcclxuICAgICAgICAgICAgICAgIGxpLmNoaWxkcmVuID0gbmV3Q2hpbGRyZW5zO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuICAgIC8v6L+b5YWl57yW6L6R5Zmo55qEbGnopoHlpZdw5qCH562+XHJcbiAgICBtZS5hZGRJbnB1dFJ1bGUoZnVuY3Rpb24ocm9vdCl7XHJcbiAgICAgICAgdXRpbHMuZWFjaChyb290LmdldE5vZGVzQnlUYWdOYW1lKCdsaScpLGZ1bmN0aW9uKGxpKXtcclxuICAgICAgICAgICAgdmFyIHRtcFAgPSBVRS51Tm9kZS5jcmVhdGVFbGVtZW50KCdwJyk7XHJcbiAgICAgICAgICAgIGZvcih2YXIgaT0gMCxjaTtjaT1saS5jaGlsZHJlbltpXTspe1xyXG4gICAgICAgICAgICAgICAgaWYoY2kudHlwZSA9PSAndGV4dCcgfHwgZHRkLnBbY2kudGFnTmFtZV0pe1xyXG4gICAgICAgICAgICAgICAgICAgIHRtcFAuYXBwZW5kQ2hpbGQoY2kpO1xyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYodG1wUC5maXJzdENoaWxkKCkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsaS5pbnNlcnRCZWZvcmUodG1wUCxjaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRtcFAgPSBVRS51Tm9kZS5jcmVhdGVFbGVtZW50KCdwJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGkgPSBpICsgMjtcclxuICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaSsrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYodG1wUC5maXJzdENoaWxkKCkgJiYgIXRtcFAucGFyZW50Tm9kZSB8fCAhbGkuZmlyc3RDaGlsZCgpKXtcclxuICAgICAgICAgICAgICAgIGxpLmFwcGVuZENoaWxkKHRtcFApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vdHJhY2U6MzM1N1xyXG4gICAgICAgICAgICAvL3DkuI3og73kuLrnqbpcclxuICAgICAgICAgICAgaWYgKCF0bXBQLmZpcnN0Q2hpbGQoKSkge1xyXG4gICAgICAgICAgICAgICAgdG1wUC5pbm5lckhUTUwoYnJvd3Nlci5pZSA/ICcmbmJzcDsnIDogJzxici8+JylcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvL+WOu+aOieacq+WwvueahOepuueZvVxyXG4gICAgICAgICAgICB2YXIgcCA9IGxpLmZpcnN0Q2hpbGQoKTtcclxuICAgICAgICAgICAgdmFyIGxhc3RDaGlsZCA9IHAubGFzdENoaWxkKCk7XHJcbiAgICAgICAgICAgIGlmKGxhc3RDaGlsZCAmJiBsYXN0Q2hpbGQudHlwZSA9PSAndGV4dCcgJiYgL15cXHMqJC8udGVzdChsYXN0Q2hpbGQuZGF0YSkpe1xyXG4gICAgICAgICAgICAgICAgcC5yZW1vdmVDaGlsZChsYXN0Q2hpbGQpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBpZihtZS5vcHRpb25zLmF1dG9UcmFuc1dvcmRUb0xpc3Qpe1xyXG4gICAgICAgICAgICB2YXIgb3JkZXJsaXN0dHlwZSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAnbnVtMSc6L15cXGQrXFwpLyxcclxuICAgICAgICAgICAgICAgICAgICAnZGVjaW1hbCc6L15cXGQrXFwuLyxcclxuICAgICAgICAgICAgICAgICAgICAnbG93ZXItYWxwaGEnOi9eW2Etel0rXFwpLyxcclxuICAgICAgICAgICAgICAgICAgICAndXBwZXItYWxwaGEnOi9eW0EtWl0rXFwuLyxcclxuICAgICAgICAgICAgICAgICAgICAnY24nOi9eW1xcdTRFMDBcXHU0RThDXFx1NEUwOVxcdTU2REJcXHU1MTZkXFx1NGU5NFxcdTRlMDNcXHU1MTZiXFx1NGU1ZF0rW1xcdTMwMDFdLyxcclxuICAgICAgICAgICAgICAgICAgICAnY24yJzovXlxcKFtcXHU0RTAwXFx1NEU4Q1xcdTRFMDlcXHU1NkRCXFx1NTE2ZFxcdTRlOTRcXHU0ZTAzXFx1NTE2YlxcdTRlNWRdK1xcKS9cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB1bm9yZGVybGlzdHR5cGUgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJ3NxdWFyZSc6J24nXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBmdW5jdGlvbiBjaGVja0xpc3RUeXBlKGNvbnRlbnQsY29udGFpbmVyKXtcclxuICAgICAgICAgICAgICAgIHZhciBzcGFuID0gY29udGFpbmVyLmZpcnN0Q2hpbGQoKTtcclxuICAgICAgICAgICAgICAgIGlmKHNwYW4gJiYgIHNwYW4udHlwZSA9PSAnZWxlbWVudCcgJiYgc3Bhbi50YWdOYW1lID09ICdzcGFuJyAmJiAvV2luZ2RpbmdzfFN5bWJvbC8udGVzdChzcGFuLmdldFN0eWxlKCdmb250LWZhbWlseScpKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBwIGluIHVub3JkZXJsaXN0dHlwZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHVub3JkZXJsaXN0dHlwZVtwXSA9PSBzcGFuLmRhdGEpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ2Rpc2MnXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBmb3IodmFyIHAgaW4gb3JkZXJsaXN0dHlwZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYob3JkZXJsaXN0dHlwZVtwXS50ZXN0KGNvbnRlbnQpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB1dGlscy5lYWNoKHJvb3QuZ2V0Tm9kZXNCeVRhZ05hbWUoJ3AnKSxmdW5jdGlvbihub2RlKXtcclxuICAgICAgICAgICAgICAgIGlmKG5vZGUuZ2V0QXR0cignY2xhc3MnKSAhPSAnTXNvTGlzdFBhcmFncmFwaCcpe1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vd29yZOeymOi0tOi/h+adpeeahOS8muW4puaciW1hcmdpbuimgeWOu+aOiSzkvYbov5nmoLfkuZ/lj6/og73kvJror6/lkb3kuK3kuIDkupvlpK7op4ZcclxuICAgICAgICAgICAgICAgIG5vZGUuc2V0U3R5bGUoJ21hcmdpbicsJycpO1xyXG4gICAgICAgICAgICAgICAgbm9kZS5zZXRTdHlsZSgnbWFyZ2luLWxlZnQnLCcnKTtcclxuICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cignY2xhc3MnLCcnKTtcclxuXHJcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhcHBlbmRMaShsaXN0LHAsdHlwZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYobGlzdC50YWdOYW1lID09ICdvbCcpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihicm93c2VyLmllKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmaXJzdCA9IHAuZmlyc3RDaGlsZCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZmlyc3QudHlwZSA9PSdlbGVtZW50JyAmJiBmaXJzdC50YWdOYW1lID09ICdzcGFuJyAmJiBvcmRlcmxpc3R0eXBlW3R5cGVdLnRlc3QoZmlyc3QuaW5uZXJUZXh0KCkpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnJlbW92ZUNoaWxkKGZpcnN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLmlubmVySFRNTChwLmlubmVySFRNTCgpLnJlcGxhY2Uob3JkZXJsaXN0dHlwZVt0eXBlXSwnJykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHAucmVtb3ZlQ2hpbGQocC5maXJzdENoaWxkKCkpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB2YXIgbGkgPSBVRS51Tm9kZS5jcmVhdGVFbGVtZW50KCdsaScpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxpLmFwcGVuZENoaWxkKHApO1xyXG4gICAgICAgICAgICAgICAgICAgIGxpc3QuYXBwZW5kQ2hpbGQobGkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdmFyIHRtcCA9IG5vZGUsdHlwZSxjYWNoZU5vZGUgPSBub2RlO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmKG5vZGUucGFyZW50Tm9kZS50YWdOYW1lICE9ICdsaScgJiYgKHR5cGUgPSBjaGVja0xpc3RUeXBlKG5vZGUuaW5uZXJUZXh0KCksbm9kZSkpKXtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGxpc3QgPSBVRS51Tm9kZS5jcmVhdGVFbGVtZW50KG1lLm9wdGlvbnMuaW5zZXJ0b3JkZXJlZGxpc3QuaGFzT3duUHJvcGVydHkodHlwZSkgPyAnb2wnIDogJ3VsJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoY3VzdG9tU3R5bGVbdHlwZV0pe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsaXN0LnNldEF0dHIoJ2NsYXNzJywnY3VzdG9tXycrdHlwZSlcclxuICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGlzdC5zZXRTdHlsZSgnbGlzdC1zdHlsZS10eXBlJyx0eXBlKVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB3aGlsZShub2RlICYmIG5vZGUucGFyZW50Tm9kZS50YWdOYW1lICE9ICdsaScgJiYgY2hlY2tMaXN0VHlwZShub2RlLmlubmVyVGV4dCgpLG5vZGUpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gbm9kZS5uZXh0U2libGluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZighdG1wKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobGlzdCxub2RlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGVuZExpKGxpc3Qsbm9kZSx0eXBlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHRtcDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoIWxpc3QucGFyZW50Tm9kZSAmJiBub2RlICYmIG5vZGUucGFyZW50Tm9kZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobGlzdCxub2RlKVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHZhciBzcGFuID0gY2FjaGVOb2RlLmZpcnN0Q2hpbGQoKTtcclxuICAgICAgICAgICAgICAgIGlmKHNwYW4gJiYgc3Bhbi50eXBlID09ICdlbGVtZW50JyAmJiBzcGFuLnRhZ05hbWUgPT0gJ3NwYW4nICYmIC9eXFxzKigmbmJzcDspK1xccyokLy50ZXN0KHNwYW4uaW5uZXJUZXh0KCkpKXtcclxuICAgICAgICAgICAgICAgICAgICBzcGFuLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc3BhbilcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9XHJcblxyXG4gICAgfSk7XHJcblxyXG4gICAgLy/osIPmlbTntKLlvJXmoIfnrb5cclxuICAgIG1lLmFkZExpc3RlbmVyKCdjb250ZW50Y2hhbmdlJyxmdW5jdGlvbigpe1xyXG4gICAgICAgIGFkanVzdExpc3RTdHlsZShtZS5kb2N1bWVudClcclxuICAgIH0pO1xyXG5cclxuICAgIGZ1bmN0aW9uIGFkanVzdExpc3RTdHlsZShkb2MsaWdub3JlKXtcclxuICAgICAgICB1dGlscy5lYWNoKGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKGRvYywnb2wgdWwnKSxmdW5jdGlvbihub2RlKXtcclxuXHJcbiAgICAgICAgICAgIGlmKCFkb21VdGlscy5pbkRvYyhub2RlLGRvYykpXHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcblxyXG4gICAgICAgICAgICB2YXIgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICBpZihwYXJlbnQudGFnTmFtZSA9PSBub2RlLnRhZ05hbWUpe1xyXG4gICAgICAgICAgICAgICAgdmFyIG5vZGVTdHlsZVR5cGUgPSBnZXRTdHlsZShub2RlKSB8fCAobm9kZS50YWdOYW1lID09ICdPTCcgPyAnZGVjaW1hbCcgOiAnZGlzYycpLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudFN0eWxlVHlwZSA9IGdldFN0eWxlKHBhcmVudCkgfHwgKHBhcmVudC50YWdOYW1lID09ICdPTCcgPyAnZGVjaW1hbCcgOiAnZGlzYycpO1xyXG4gICAgICAgICAgICAgICAgaWYobm9kZVN0eWxlVHlwZSA9PSBwYXJlbnRTdHlsZVR5cGUpe1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZUluZGV4ID0gdXRpbHMuaW5kZXhPZihsaXN0U3R5bGVbbm9kZS50YWdOYW1lXSwgbm9kZVN0eWxlVHlwZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgc3R5bGVJbmRleCA9IHN0eWxlSW5kZXggKyAxID09IGxpc3RTdHlsZVtub2RlLnRhZ05hbWVdLmxlbmd0aCA/IDAgOiBzdHlsZUluZGV4ICsgMTtcclxuICAgICAgICAgICAgICAgICAgICBzZXRMaXN0U3R5bGUobm9kZSxsaXN0U3R5bGVbbm9kZS50YWdOYW1lXVtzdHlsZUluZGV4XSlcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGluZGV4ID0gMCx0eXBlID0gMjtcclxuICAgICAgICAgICAgaWYoIGRvbVV0aWxzLmhhc0NsYXNzKG5vZGUsL2N1c3RvbV8vKSl7XHJcbiAgICAgICAgICAgICAgICBpZighKC9bb3VdbC9pLnRlc3QocGFyZW50LnRhZ05hbWUpICYmIGRvbVV0aWxzLmhhc0NsYXNzKHBhcmVudCwvY3VzdG9tXy8pKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZSA9IDE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgaWYoL1tvdV1sL2kudGVzdChwYXJlbnQudGFnTmFtZSkgJiYgZG9tVXRpbHMuaGFzQ2xhc3MocGFyZW50LC9jdXN0b21fLykpe1xyXG4gICAgICAgICAgICAgICAgICAgIHR5cGUgPSAzO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB2YXIgc3R5bGUgPSBkb21VdGlscy5nZXRTdHlsZShub2RlLCAnbGlzdC1zdHlsZS10eXBlJyk7XHJcbiAgICAgICAgICAgIHN0eWxlICYmIChub2RlLnN0eWxlLmNzc1RleHQgPSAnbGlzdC1zdHlsZS10eXBlOicgKyBzdHlsZSk7XHJcbiAgICAgICAgICAgIG5vZGUuY2xhc3NOYW1lID0gdXRpbHMudHJpbShub2RlLmNsYXNzTmFtZS5yZXBsYWNlKC9saXN0LXBhZGRpbmdsZWZ0LVxcdysvLCcnKSkgKyAnIGxpc3QtcGFkZGluZ2xlZnQtJyArIHR5cGU7XHJcbiAgICAgICAgICAgIHV0aWxzLmVhY2goZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUobm9kZSwnbGknKSxmdW5jdGlvbihsaSl7XHJcbiAgICAgICAgICAgICAgICBsaS5zdHlsZS5jc3NUZXh0ICYmIChsaS5zdHlsZS5jc3NUZXh0ID0gJycpO1xyXG4gICAgICAgICAgICAgICAgaWYoIWxpLmZpcnN0Q2hpbGQpe1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShsaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYobGkucGFyZW50Tm9kZSAhPT0gbm9kZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaW5kZXgrKztcclxuICAgICAgICAgICAgICAgIGlmKGRvbVV0aWxzLmhhc0NsYXNzKG5vZGUsL2N1c3RvbV8vKSApe1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBwYWRkaW5nTGVmdCA9IDEsY3VycmVudFN0eWxlID0gZ2V0U3R5bGUobm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYobm9kZS50YWdOYW1lID09ICdPTCcpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihjdXJyZW50U3R5bGUpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoKGN1cnJlbnRTdHlsZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY24nIDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjbjEnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2NuMic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGluZGV4ID4gMTAgJiYgKGluZGV4ICUgMTAgPT0gMCB8fCBpbmRleCA+IDEwICYmIGluZGV4IDwgMjApKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmdMZWZ0ID0gMlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZihpbmRleCA+IDIwKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmdMZWZ0ID0gM1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ251bTInIDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaW5kZXggPiA5KXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmdMZWZ0ID0gMlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgbGkuY2xhc3NOYW1lID0gJ2xpc3QtJytjdXN0b21TdHlsZVtjdXJyZW50U3R5bGVdKyBpbmRleCArICcgJyArICdsaXN0LScrY3VycmVudFN0eWxlKyctcGFkZGluZ2xlZnQtJyArIHBhZGRpbmdMZWZ0O1xyXG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsaS5jbGFzc05hbWUgPSAnbGlzdC0nK2N1c3RvbVN0eWxlW2N1cnJlbnRTdHlsZV0gICsgJyAnICsgJ2xpc3QtJytjdXJyZW50U3R5bGUrJy1wYWRkaW5nbGVmdCc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgbGkuY2xhc3NOYW1lID0gbGkuY2xhc3NOYW1lLnJlcGxhY2UoL2xpc3QtW1xcd1xcLV0rL2dpLCcnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHZhciBjbGFzc05hbWUgPSBsaS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJyk7XHJcbiAgICAgICAgICAgICAgICBpZihjbGFzc05hbWUgIT09IG51bGwgJiYgIWNsYXNzTmFtZS5yZXBsYWNlKC9cXHMvZywnJykpe1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZUF0dHJpYnV0ZXMobGksJ2NsYXNzJylcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICFpZ25vcmUgJiYgYWRqdXN0TGlzdChub2RlLG5vZGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpLGdldFN0eWxlKG5vZGUpfHxkb21VdGlscy5nZXRTdHlsZShub2RlLCAnbGlzdC1zdHlsZS10eXBlJyksdHJ1ZSk7XHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIGFkanVzdExpc3QobGlzdCwgdGFnLCBzdHlsZSxpZ25vcmVFbXB0eSkge1xyXG4gICAgICAgIHZhciBuZXh0TGlzdCA9IGxpc3QubmV4dFNpYmxpbmc7XHJcbiAgICAgICAgaWYgKG5leHRMaXN0ICYmIG5leHRMaXN0Lm5vZGVUeXBlID09IDEgJiYgbmV4dExpc3QudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09IHRhZyAmJiAoZ2V0U3R5bGUobmV4dExpc3QpIHx8IGRvbVV0aWxzLmdldFN0eWxlKG5leHRMaXN0LCAnbGlzdC1zdHlsZS10eXBlJykgfHwgKHRhZyA9PSAnb2wnID8gJ2RlY2ltYWwnIDogJ2Rpc2MnKSkgPT0gc3R5bGUpIHtcclxuICAgICAgICAgICAgZG9tVXRpbHMubW92ZUNoaWxkKG5leHRMaXN0LCBsaXN0KTtcclxuICAgICAgICAgICAgaWYgKG5leHRMaXN0LmNoaWxkTm9kZXMubGVuZ3RoID09IDApIHtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShuZXh0TGlzdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYobmV4dExpc3QgJiYgZG9tVXRpbHMuaXNGaWxsQ2hhcihuZXh0TGlzdCkpe1xyXG4gICAgICAgICAgICBkb21VdGlscy5yZW1vdmUobmV4dExpc3QpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgcHJlTGlzdCA9IGxpc3QucHJldmlvdXNTaWJsaW5nO1xyXG4gICAgICAgIGlmIChwcmVMaXN0ICYmIHByZUxpc3Qubm9kZVR5cGUgPT0gMSAmJiBwcmVMaXN0LnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSB0YWcgJiYgKGdldFN0eWxlKHByZUxpc3QpIHx8IGRvbVV0aWxzLmdldFN0eWxlKHByZUxpc3QsICdsaXN0LXN0eWxlLXR5cGUnKSB8fCAodGFnID09ICdvbCcgPyAnZGVjaW1hbCcgOiAnZGlzYycpKSA9PSBzdHlsZSkge1xyXG4gICAgICAgICAgICBkb21VdGlscy5tb3ZlQ2hpbGQobGlzdCwgcHJlTGlzdCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmKHByZUxpc3QgJiYgZG9tVXRpbHMuaXNGaWxsQ2hhcihwcmVMaXN0KSl7XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShwcmVMaXN0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgIWlnbm9yZUVtcHR5ICYmIGRvbVV0aWxzLmlzRW1wdHlCbG9jayhsaXN0KSAmJiBkb21VdGlscy5yZW1vdmUobGlzdCk7XHJcbiAgICAgICAgaWYoZ2V0U3R5bGUobGlzdCkpe1xyXG4gICAgICAgICAgICBhZGp1c3RMaXN0U3R5bGUobGlzdC5vd25lckRvY3VtZW50LHRydWUpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNldExpc3RTdHlsZShsaXN0LHN0eWxlKXtcclxuICAgICAgICBpZihjdXN0b21TdHlsZVtzdHlsZV0pe1xyXG4gICAgICAgICAgICBsaXN0LmNsYXNzTmFtZSA9ICdjdXN0b21fJyArIHN0eWxlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0cnl7XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLnNldFN0eWxlKGxpc3QsICdsaXN0LXN0eWxlLXR5cGUnLCBzdHlsZSk7XHJcbiAgICAgICAgfWNhdGNoKGUpe31cclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIGNsZWFyRW1wdHlTaWJsaW5nKG5vZGUpIHtcclxuICAgICAgICB2YXIgdG1wTm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nO1xyXG4gICAgICAgIGlmICh0bXBOb2RlICYmIGRvbVV0aWxzLmlzRW1wdHlCbG9jayh0bXBOb2RlKSkge1xyXG4gICAgICAgICAgICBkb21VdGlscy5yZW1vdmUodG1wTm9kZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRtcE5vZGUgPSBub2RlLm5leHRTaWJsaW5nO1xyXG4gICAgICAgIGlmICh0bXBOb2RlICYmIGRvbVV0aWxzLmlzRW1wdHlCbG9jayh0bXBOb2RlKSkge1xyXG4gICAgICAgICAgICBkb21VdGlscy5yZW1vdmUodG1wTm9kZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG1lLmFkZExpc3RlbmVyKCdrZXlkb3duJywgZnVuY3Rpb24gKHR5cGUsIGV2dCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIHByZXZlbnRBbmRTYXZlKCkge1xyXG4gICAgICAgICAgICBldnQucHJldmVudERlZmF1bHQgPyBldnQucHJldmVudERlZmF1bHQoKSA6IChldnQucmV0dXJuVmFsdWUgPSBmYWxzZSk7XHJcbiAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnY29udGVudGNoYW5nZScpO1xyXG4gICAgICAgICAgICBtZS51bmRvTWFuZ2VyICYmIG1lLnVuZG9NYW5nZXIuc2F2ZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmdW5jdGlvbiBmaW5kTGlzdChub2RlLGZpbHRlckZuKXtcclxuICAgICAgICAgICAgd2hpbGUobm9kZSAmJiAhZG9tVXRpbHMuaXNCb2R5KG5vZGUpKXtcclxuICAgICAgICAgICAgICAgIGlmKGZpbHRlckZuKG5vZGUpKXtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYobm9kZS5ub2RlVHlwZSA9PSAxICYmIC9bb3VdbC9pLnRlc3Qobm9kZS50YWdOYW1lKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIga2V5Q29kZSA9IGV2dC5rZXlDb2RlIHx8IGV2dC53aGljaDtcclxuICAgICAgICBpZiAoa2V5Q29kZSA9PSAxMyAmJiAhZXZ0LnNoaWZ0S2V5KSB7Ly/lm57ovaZcclxuICAgICAgICAgICAgdmFyIHJuZyA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxyXG4gICAgICAgICAgICAgICAgcGFyZW50ID0gZG9tVXRpbHMuZmluZFBhcmVudChybmcuc3RhcnRDb250YWluZXIsZnVuY3Rpb24obm9kZSl7cmV0dXJuIGRvbVV0aWxzLmlzQmxvY2tFbG0obm9kZSl9LHRydWUpLFxyXG4gICAgICAgICAgICAgICAgbGkgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHJuZy5zdGFydENvbnRhaW5lciwnbGknLHRydWUpO1xyXG4gICAgICAgICAgICBpZihwYXJlbnQgJiYgcGFyZW50LnRhZ05hbWUgIT0gJ1BSRScgJiYgIWxpKXtcclxuICAgICAgICAgICAgICAgIHZhciBodG1sID0gcGFyZW50LmlubmVySFRNTC5yZXBsYWNlKG5ldyBSZWdFeHAoZG9tVXRpbHMuZmlsbENoYXIsICdnJyksJycpO1xyXG4gICAgICAgICAgICAgICAgaWYoL15cXHMqMVxccypcXC5bXlxcZF0vLnRlc3QoaHRtbCkpe1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudC5pbm5lckhUTUwgPSBodG1sLnJlcGxhY2UoL15cXHMqMVxccypcXC4vLCcnKTtcclxuICAgICAgICAgICAgICAgICAgICBybmcuc2V0U3RhcnRBdExhc3QocGFyZW50KS5jb2xsYXBzZSh0cnVlKS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICBtZS5fX2hhc0VudGVyRXhlY0NvbW1hbmQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKCdpbnNlcnRvcmRlcmVkbGlzdCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLl9faGFzRW50ZXJFeGVjQ29tbWFuZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciByYW5nZSA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxyXG4gICAgICAgICAgICAgICAgc3RhcnQgPSBmaW5kTGlzdChyYW5nZS5zdGFydENvbnRhaW5lcixmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnRhZ05hbWUgPT0gJ1RBQkxFJztcclxuICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgZW5kID0gcmFuZ2UuY29sbGFwc2VkID8gc3RhcnQgOiBmaW5kTGlzdChyYW5nZS5lbmRDb250YWluZXIsZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS50YWdOYW1lID09ICdUQUJMRSc7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGlmIChzdGFydCAmJiBlbmQgJiYgc3RhcnQgPT09IGVuZCkge1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghcmFuZ2UuY29sbGFwc2VkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHJhbmdlLnN0YXJ0Q29udGFpbmVyLCAnbGknLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICBlbmQgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHJhbmdlLmVuZENvbnRhaW5lciwgJ2xpJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXJ0ICYmIGVuZCAmJiBzdGFydCA9PT0gZW5kKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLmRlbGV0ZUNvbnRlbnRzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShyYW5nZS5zdGFydENvbnRhaW5lciwgJ2xpJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsaSAmJiBkb21VdGlscy5pc0VtcHR5QmxvY2sobGkpKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlID0gbGkucHJldmlvdXNTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCA9IGxpLm5leHRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcCA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5maWxsTm9kZShtZS5kb2N1bWVudCwgcCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRMaXN0ID0gbGkucGFyZW50Tm9kZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmUgJiYgbmV4dCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KG5leHQsIDApLmNvbGxhcHNlKHRydWUpLnNlbGVjdCh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUobGkpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwcmUgJiYgIW5leHQgfHwgIXByZSkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50TGlzdC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShwLCBwYXJlbnRMaXN0KTtcclxuXHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpLnBhcmVudE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUocCwgcGFyZW50TGlzdC5uZXh0U2libGluZyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShsaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwYXJlbnRMaXN0LmZpcnN0Q2hpbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHBhcmVudExpc3QpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydChwLCAwKS5zZXRDdXJzb3IoKTtcclxuXHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmVudEFuZFNhdmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wUmFuZ2UgPSByYW5nZS5jbG9uZVJhbmdlKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiayA9IHRtcFJhbmdlLmNvbGxhcHNlKGZhbHNlKS5jcmVhdGVCb29rbWFyaygpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UuZGVsZXRlQ29udGVudHMoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG1wUmFuZ2UubW92ZVRvQm9va21hcmsoYmspO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGkgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHRtcFJhbmdlLnN0YXJ0Q29udGFpbmVyLCAnbGknLCB0cnVlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyRW1wdHlTaWJsaW5nKGxpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG1wUmFuZ2Uuc2VsZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnRBbmRTYXZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgICAgIGxpID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShyYW5nZS5zdGFydENvbnRhaW5lciwgJ2xpJywgdHJ1ZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGxpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRvbVV0aWxzLmlzRW1wdHlCbG9jayhsaSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYmsgPSByYW5nZS5jcmVhdGVCb29rbWFyaygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50TGlzdCA9IGxpLnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsaSAhPT0gcGFyZW50TGlzdC5sYXN0Q2hpbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmJyZWFrUGFyZW50KGxpLCBwYXJlbnRMaXN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyRW1wdHlTaWJsaW5nKGxpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRMaXN0LnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGxpLCBwYXJlbnRMaXN0Lm5leHRTaWJsaW5nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb21VdGlscy5pc0VtcHR5Tm9kZShwYXJlbnRMaXN0KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShwYXJlbnRMaXN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL+W1jOWll+S4jeWkhOeQhlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWR0ZC4kbGlzdFtsaS5wYXJlbnROb2RlLnRhZ05hbWVdKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb21VdGlscy5pc0Jsb2NrRWxtKGxpLmZpcnN0Q2hpbGQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcCA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShwLCBsaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxpLmZpcnN0Q2hpbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5hcHBlbmRDaGlsZChsaS5maXJzdENoaWxkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKGxpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKGxpLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5tb3ZlVG9Cb29rbWFyayhiaykuc2VsZWN0KCk7XHJcblxyXG5cclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZmlyc3QgPSBsaS5maXJzdENoaWxkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWZpcnN0IHx8ICFkb21VdGlscy5pc0Jsb2NrRWxtKGZpcnN0KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHAgPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIWxpLmZpcnN0Q2hpbGQgJiYgZG9tVXRpbHMuZmlsbE5vZGUobWUuZG9jdW1lbnQsIHApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxpLmZpcnN0Q2hpbGQpIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5hcHBlbmRDaGlsZChsaS5maXJzdENoaWxkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpLmFwcGVuZENoaWxkKHApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3QgPSBwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3BhbiA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLmluc2VydE5vZGUoc3Bhbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmJyZWFrUGFyZW50KHNwYW4sIGxpKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXh0TGkgPSBzcGFuLm5leHRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaXJzdCA9IG5leHRMaS5maXJzdENoaWxkO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFmaXJzdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcCA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5maWxsTm9kZShtZS5kb2N1bWVudCwgcCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0TGkuYXBwZW5kQ2hpbGQocCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdCA9IHA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRvbVV0aWxzLmlzRW1wdHlOb2RlKGZpcnN0KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3QuaW5uZXJIVE1MID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5maWxsTm9kZShtZS5kb2N1bWVudCwgZmlyc3QpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydChmaXJzdCwgMCkuY29sbGFwc2UodHJ1ZSkuc2hyaW5rQm91bmRhcnkoKS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHNwYW4pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJlID0gbmV4dExpLnByZXZpb3VzU2libGluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZSAmJiBkb21VdGlscy5pc0VtcHR5QmxvY2socHJlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlLmlubmVySFRNTCA9ICc8cD48L3A+JztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmZpbGxOb2RlKG1lLmRvY3VtZW50LCBwcmUuZmlyc3RDaGlsZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBwcmV2ZW50QW5kU2F2ZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoa2V5Q29kZSA9PSA4KSB7XHJcbiAgICAgICAgICAgIC8v5L+u5LitaWXkuK1saeS4i+eahOmXrumimFxyXG4gICAgICAgICAgICByYW5nZSA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xyXG4gICAgICAgICAgICBpZiAocmFuZ2UuY29sbGFwc2VkICYmIGRvbVV0aWxzLmlzU3RhcnRJbmJsb2NrKHJhbmdlKSkge1xyXG4gICAgICAgICAgICAgICAgdG1wUmFuZ2UgPSByYW5nZS5jbG9uZVJhbmdlKCkudHJpbUJvdW5kYXJ5KCk7XHJcbiAgICAgICAgICAgICAgICBsaSA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocmFuZ2Uuc3RhcnRDb250YWluZXIsICdsaScsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgLy/opoHlnKhsaeeahOacgOW3pui+ue+8jOaJjeiDveWkhOeQhlxyXG4gICAgICAgICAgICAgICAgaWYgKGxpICYmIGRvbVV0aWxzLmlzU3RhcnRJbmJsb2NrKHRtcFJhbmdlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShyYW5nZS5zdGFydENvbnRhaW5lciwgJ3AnLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhcnQgJiYgc3RhcnQgIT09IGxpLmZpcnN0Q2hpbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudExpc3QgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHN0YXJ0LFsnb2wnLCd1bCddKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuYnJlYWtQYXJlbnQoc3RhcnQscGFyZW50TGlzdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyRW1wdHlTaWJsaW5nKHN0YXJ0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdjb250ZW50Y2hhbmdlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KHN0YXJ0LDApLnNldEN1cnNvcihmYWxzZSx0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdzYXZlU2NlbmUnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucHJldmVudERlZmF1bHQoZXZ0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGxpICYmIChwcmUgPSBsaS5wcmV2aW91c1NpYmxpbmcpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlDb2RlID09IDQ2ICYmIGxpLmNoaWxkTm9kZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy/mnInlj6/og73kuIrovrnnmoTlhYTlvJ/oioLngrnmmK/kuKoy57qn6I+c5Y2V77yM6KaB6L+95Yqg5YiwMue6p+iPnOWNleeahOacgOWQjueahGxpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkdGQuJGxpc3RbcHJlLnRhZ05hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUgPSBwcmUubGFzdENoaWxkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLnVuZG9NYW5nZXIgJiYgbWUudW5kb01hbmdlci5zYXZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0ID0gbGkuZmlyc3RDaGlsZDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRvbVV0aWxzLmlzQmxvY2tFbG0oZmlyc3QpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9tVXRpbHMuaXNFbXB0eU5vZGUoZmlyc3QpKSB7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0RW5kKHByZSwgcHJlLmNoaWxkTm9kZXMubGVuZ3RoKS5zaHJpbmtCb3VuZGFyeSgpLmNvbGxhcHNlKCkuc2VsZWN0KHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZS5hcHBlbmRDaGlsZChmaXJzdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQoZmlyc3QsIDApLnNldEN1cnNvcihmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9maXJzdOS4jeaYr+WUr+S4gOeahOiKgueCuVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChsaS5maXJzdENoaWxkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZS5hcHBlbmRDaGlsZChsaS5maXJzdENoaWxkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGFuID0gbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLmluc2VydE5vZGUoc3Bhbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy/liKTmlq1wcmXmmK/lkKbmmK/nqbrnmoToioLngrks5aaC5p6c5pivPHA+PGJyLz48L3A+57G75Z6L55qE56m66IqC54K577yM5bmy5o6JcOagh+etvumYsuatouWug+WNoOS9jVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb21VdGlscy5pc0VtcHR5QmxvY2socHJlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUuaW5uZXJIVE1MID0gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLm1vdmVDaGlsZChsaSwgcHJlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydEJlZm9yZShzcGFuKS5jb2xsYXBzZSh0cnVlKS5zZWxlY3QodHJ1ZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShzcGFuKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9tVXRpbHMuaXNFbXB0eU5vZGUobGkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHAgPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlLmFwcGVuZENoaWxkKHApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KHAsIDApLnNldEN1cnNvcigpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldEVuZChwcmUsIHByZS5jaGlsZE5vZGVzLmxlbmd0aCkuc2hyaW5rQm91bmRhcnkoKS5jb2xsYXBzZSgpLnNlbGVjdCh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0RW5kKHByZSwgcHJlLmNoaWxkTm9kZXMubGVuZ3RoKS5jb2xsYXBzZSgpLnNlbGVjdCh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAobGkuZmlyc3RDaGlsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUuYXBwZW5kQ2hpbGQobGkuZmlyc3RDaGlsZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShsaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnY29udGVudGNoYW5nZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NhdmVTY2VuZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5wcmV2ZW50RGVmYXVsdChldnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAvL3RyYWNlOjk4MFxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAobGkgJiYgIWxpLnByZXZpb3VzU2libGluZykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50TGlzdCA9IGxpLnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiayA9IHJhbmdlLmNyZWF0ZUJvb2ttYXJrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGRvbVV0aWxzLmlzVGFnTm9kZShwYXJlbnRMaXN0LnBhcmVudE5vZGUsJ29sIHVsJykpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50TGlzdC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShsaSxwYXJlbnRMaXN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGRvbVV0aWxzLmlzRW1wdHlOb2RlKHBhcmVudExpc3QpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUocGFyZW50TGlzdClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUobGkuZmlyc3RDaGlsZCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50TGlzdC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShsaS5maXJzdENoaWxkLHBhcmVudExpc3QpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShsaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihkb21VdGlscy5pc0VtcHR5Tm9kZShwYXJlbnRMaXN0KSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHBhcmVudExpc3QpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLm1vdmVUb0Jvb2ttYXJrKGJrKS5zZXRDdXJzb3IoZmFsc2UsdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnY29udGVudGNoYW5nZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NhdmVTY2VuZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5wcmV2ZW50RGVmYXVsdChldnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgbWUuYWRkTGlzdGVuZXIoJ2tleXVwJyxmdW5jdGlvbih0eXBlLCBldnQpe1xyXG4gICAgICAgIHZhciBrZXlDb2RlID0gZXZ0LmtleUNvZGUgfHwgZXZ0LndoaWNoO1xyXG4gICAgICAgIGlmIChrZXlDb2RlID09IDgpIHtcclxuICAgICAgICAgICAgdmFyIHJuZyA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLGxpc3Q7XHJcbiAgICAgICAgICAgIGlmKGxpc3QgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHJuZy5zdGFydENvbnRhaW5lcixbJ29sJywgJ3VsJ10sdHJ1ZSkpe1xyXG4gICAgICAgICAgICAgICAgYWRqdXN0TGlzdChsaXN0LGxpc3QudGFnTmFtZS50b0xvd2VyQ2FzZSgpLGdldFN0eWxlKGxpc3QpfHxkb21VdGlscy5nZXRDb21wdXRlZFN0eWxlKGxpc3QsJ2xpc3Qtc3R5bGUtdHlwZScpLHRydWUpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIC8v5aSE55CGdGFi6ZSuXHJcbiAgICBtZS5hZGRMaXN0ZW5lcigndGFia2V5ZG93bicsZnVuY3Rpb24oKXtcclxuXHJcbiAgICAgICAgdmFyIHJhbmdlID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcblxyXG4gICAgICAgIC8v5o6n5Yi257qn5pWwXHJcbiAgICAgICAgZnVuY3Rpb24gY2hlY2tMZXZlbChsaSl7XHJcbiAgICAgICAgICAgIGlmKG1lLm9wdGlvbnMubWF4TGlzdExldmVsICE9IC0xKXtcclxuICAgICAgICAgICAgICAgIHZhciBsZXZlbCA9IGxpLnBhcmVudE5vZGUsbGV2ZWxOdW0gPSAwO1xyXG4gICAgICAgICAgICAgICAgd2hpbGUoL1tvdV1sL2kudGVzdChsZXZlbC50YWdOYW1lKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV2ZWxOdW0rKztcclxuICAgICAgICAgICAgICAgICAgICBsZXZlbCA9IGxldmVsLnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZihsZXZlbE51bSA+PSBtZS5vcHRpb25zLm1heExpc3RMZXZlbCl7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy/lj6rku6XlvIDlp4vkuLrlh4ZcclxuICAgICAgICAvL3RvZG8g5ZCO57ut5pS56L+bXHJcbiAgICAgICAgdmFyIGxpID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShyYW5nZS5zdGFydENvbnRhaW5lciwgJ2xpJywgdHJ1ZSk7XHJcbiAgICAgICAgaWYobGkpe1xyXG5cclxuICAgICAgICAgICAgdmFyIGJrO1xyXG4gICAgICAgICAgICBpZihyYW5nZS5jb2xsYXBzZWQpe1xyXG4gICAgICAgICAgICAgICAgaWYoY2hlY2tMZXZlbChsaSkpXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB2YXIgcGFyZW50TGkgPSBsaS5wYXJlbnROb2RlLFxyXG4gICAgICAgICAgICAgICAgICAgIGxpc3QgPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KHBhcmVudExpLnRhZ05hbWUpLFxyXG4gICAgICAgICAgICAgICAgICAgIGluZGV4ID0gdXRpbHMuaW5kZXhPZihsaXN0U3R5bGVbbGlzdC50YWdOYW1lXSwgZ2V0U3R5bGUocGFyZW50TGkpfHxkb21VdGlscy5nZXRDb21wdXRlZFN0eWxlKHBhcmVudExpLCAnbGlzdC1zdHlsZS10eXBlJykpO1xyXG4gICAgICAgICAgICAgICAgaW5kZXggPSBpbmRleCArIDEgPT0gbGlzdFN0eWxlW2xpc3QudGFnTmFtZV0ubGVuZ3RoID8gMCA6IGluZGV4ICsgMTtcclxuICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U3R5bGUgPSBsaXN0U3R5bGVbbGlzdC50YWdOYW1lXVtpbmRleF07XHJcbiAgICAgICAgICAgICAgICBzZXRMaXN0U3R5bGUobGlzdCxjdXJyZW50U3R5bGUpO1xyXG4gICAgICAgICAgICAgICAgaWYoZG9tVXRpbHMuaXNTdGFydEluYmxvY2socmFuZ2UpKXtcclxuICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NhdmVTY2VuZScpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJrID0gcmFuZ2UuY3JlYXRlQm9va21hcmsoKTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnRMaS5pbnNlcnRCZWZvcmUobGlzdCwgbGkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxpc3QuYXBwZW5kQ2hpbGQobGkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGFkanVzdExpc3QobGlzdCxsaXN0LnRhZ05hbWUudG9Mb3dlckNhc2UoKSxjdXJyZW50U3R5bGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnY29udGVudGNoYW5nZScpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLm1vdmVUb0Jvb2ttYXJrKGJrKS5zZWxlY3QodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdzYXZlU2NlbmUnKTtcclxuICAgICAgICAgICAgICAgIGJrID0gcmFuZ2UuY3JlYXRlQm9va21hcmsoKTtcclxuICAgICAgICAgICAgICAgIGZvcih2YXIgaT0gMCxjbG9zZUxpc3QscGFyZW50cyA9IGRvbVV0aWxzLmZpbmRQYXJlbnRzKGxpKSxjaTtjaT1wYXJlbnRzW2krK107KXtcclxuICAgICAgICAgICAgICAgICAgICBpZihkb21VdGlscy5pc1RhZ05vZGUoY2ksJ29sIHVsJykpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbG9zZUxpc3QgPSBjaTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBsaTtcclxuICAgICAgICAgICAgICAgIGlmKGJrLmVuZCl7XHJcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUoY3VycmVudCAmJiAhKGRvbVV0aWxzLmdldFBvc2l0aW9uKGN1cnJlbnQsIGJrLmVuZCkgJiBkb21VdGlscy5QT1NJVElPTl9GT0xMT1dJTkcpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoY2hlY2tMZXZlbChjdXJyZW50KSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoY3VycmVudCxmYWxzZSxudWxsLGZ1bmN0aW9uKG5vZGUpe3JldHVybiBub2RlICE9PSBjbG9zZUxpc3R9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRMaSA9IGN1cnJlbnQucGFyZW50Tm9kZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QgPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KHBhcmVudExpLnRhZ05hbWUpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSB1dGlscy5pbmRleE9mKGxpc3RTdHlsZVtsaXN0LnRhZ05hbWVdLCBnZXRTdHlsZShwYXJlbnRMaSl8fGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUocGFyZW50TGksICdsaXN0LXN0eWxlLXR5cGUnKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50SW5kZXggPSBpbmRleCArIDEgPT0gbGlzdFN0eWxlW2xpc3QudGFnTmFtZV0ubGVuZ3RoID8gMCA6IGluZGV4ICsgMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRTdHlsZSA9IGxpc3RTdHlsZVtsaXN0LnRhZ05hbWVdW2N1cnJlbnRJbmRleF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldExpc3RTdHlsZShsaXN0LGN1cnJlbnRTdHlsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudExpLmluc2VydEJlZm9yZShsaXN0LCBjdXJyZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoY3VycmVudCAmJiAhKGRvbVV0aWxzLmdldFBvc2l0aW9uKGN1cnJlbnQsIGJrLmVuZCkgJiBkb21VdGlscy5QT1NJVElPTl9GT0xMT1dJTkcpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpID0gY3VycmVudC5uZXh0U2libGluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QuYXBwZW5kQ2hpbGQoY3VycmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighbGkgfHwgZG9tVXRpbHMuaXNUYWdOb2RlKGxpLCdvbCB1bCcpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihsaSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKGxpID0gbGkuZmlyc3RDaGlsZCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihsaS50YWdOYW1lID09ICdMSScpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpID0gZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoY3VycmVudCxmYWxzZSxudWxsLGZ1bmN0aW9uKG5vZGUpe3JldHVybiBub2RlICE9PSBjbG9zZUxpc3R9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gbGk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgYWRqdXN0TGlzdChsaXN0LGxpc3QudGFnTmFtZS50b0xvd2VyQ2FzZSgpLGN1cnJlbnRTdHlsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBsaTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ2NvbnRlbnRjaGFuZ2UnKTtcclxuICAgICAgICAgICAgICAgIHJhbmdlLm1vdmVUb0Jvb2ttYXJrKGJrKS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH0pO1xyXG4gICAgZnVuY3Rpb24gZ2V0TGkoc3RhcnQpe1xyXG4gICAgICAgIHdoaWxlKHN0YXJ0ICYmICFkb21VdGlscy5pc0JvZHkoc3RhcnQpKXtcclxuICAgICAgICAgICAgaWYoc3RhcnQubm9kZU5hbWUgPT0gJ1RBQkxFJyl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZihzdGFydC5ub2RlTmFtZSA9PSAnTEknKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiBzdGFydFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHN0YXJ0ID0gc3RhcnQucGFyZW50Tm9kZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmnInluo/liJfooajvvIzkuI7igJxpbnNlcnR1bm9yZGVyZWRsaXN04oCd5ZG95Luk5LqS5palXHJcbiAgICAgKiBAY29tbWFuZCBpbnNlcnRvcmRlcmVkbGlzdFxyXG4gICAgICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gY29tbWFuZCDlkb3ku6TlrZfnrKbkuLJcclxuICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IHN0eWxlIOaPkuWFpeeahOacieW6j+WIl+ihqOexu+Wei++8jOWAvOS4uu+8mmRlY2ltYWwsbG93ZXItYWxwaGEsbG93ZXItcm9tYW4sdXBwZXItYWxwaGEsdXBwZXItcm9tYW4sY24sY24xLGNuMixudW0sbnVtMSxudW0yXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnaW5zZXJ0b3JkZXJlZGxpc3QnLCdkZWNpbWFsJyk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgLyoqXHJcbiAgICAgKiDmn6Xor6LlvZPliY3pgInljLrlhoXlrrnmmK/lkKbmnInluo/liJfooahcclxuICAgICAqIEBjb21tYW5kIGluc2VydG9yZGVyZWRsaXN0XHJcbiAgICAgKiBAbWV0aG9kIHF1ZXJ5Q29tbWFuZFN0YXRlXHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAgICAgKiBAcmV0dXJuIHsgaW50IH0g5aaC5p6c5b2T5YmN6YCJ5Yy65piv5pyJ5bqP5YiX6KGo6L+U5ZueMe+8jOWQpuWImei/lOWbnjBcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiBlZGl0b3IucXVlcnlDb21tYW5kU3RhdGUoICdpbnNlcnRvcmRlcmVkbGlzdCcgKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICAvKipcclxuICAgICAqIOafpeivouW9k+WJjemAieWMuuWGheWuueaYr+WQpuacieW6j+WIl+ihqFxyXG4gICAgICogQGNvbW1hbmQgaW5zZXJ0b3JkZXJlZGxpc3RcclxuICAgICAqIEBtZXRob2QgcXVlcnlDb21tYW5kVmFsdWVcclxuICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcclxuICAgICAqIEByZXR1cm4geyBTdHJpbmcgfSDov5Tlm57lvZPliY3mnInluo/liJfooajnmoTnsbvlnovvvIzlgLzkuLpudWxs5oiWZGVjaW1hbCxsb3dlci1hbHBoYSxsb3dlci1yb21hbix1cHBlci1hbHBoYSx1cHBlci1yb21hbixjbixjbjEsY24yLG51bSxudW0xLG51bTJcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiBlZGl0b3IucXVlcnlDb21tYW5kVmFsdWUoICdpbnNlcnRvcmRlcmVkbGlzdCcgKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDml6Dluo/liJfooajvvIzkuI7igJxpbnNlcnRvcmRlcmVkbGlzdOKAneWRveS7pOS6kuaWpVxyXG4gICAgICogQGNvbW1hbmQgaW5zZXJ0dW5vcmRlcmVkbGlzdFxyXG4gICAgICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gY29tbWFuZCDlkb3ku6TlrZfnrKbkuLJcclxuICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IHN0eWxlIOaPkuWFpeeahOaXoOW6j+WIl+ihqOexu+Wei++8jOWAvOS4uu+8mmNpcmNsZSxkaXNjLHNxdWFyZSxkYXNoLGRvdFxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIGVkaXRvci5leGVjQ29tbWFuZCggJ2luc2VydHVub3JkZXJlZGxpc3QnLCdjaXJjbGUnKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcbiAgICAvKipcclxuICAgICAqIOafpeivouW9k+WJjeaYr+WQpuaciXdvcmTmlofmoaPnspjotLTov5vmnaXnmoTlm77niYdcclxuICAgICAqIEBjb21tYW5kIGluc2VydHVub3JkZXJlZGxpc3RcclxuICAgICAqIEBtZXRob2QgaW5zZXJ0dW5vcmRlcmVkbGlzdFxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gY29tbWFuZCDlkb3ku6TlrZfnrKbkuLJcclxuICAgICAqIEByZXR1cm4geyBpbnQgfSDlpoLmnpzlvZPliY3pgInljLrmmK/ml6Dluo/liJfooajov5Tlm54x77yM5ZCm5YiZ6L+U5ZueMFxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIGVkaXRvci5xdWVyeUNvbW1hbmRTdGF0ZSggJ2luc2VydHVub3JkZXJlZGxpc3QnICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgLyoqXHJcbiAgICAgKiDmn6Xor6LlvZPliY3pgInljLrlhoXlrrnmmK/lkKbmnInluo/liJfooahcclxuICAgICAqIEBjb21tYW5kIGluc2VydHVub3JkZXJlZGxpc3RcclxuICAgICAqIEBtZXRob2QgcXVlcnlDb21tYW5kVmFsdWVcclxuICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGNvbW1hbmQg5ZG95Luk5a2X56ym5LiyXHJcbiAgICAgKiBAcmV0dXJuIHsgU3RyaW5nIH0g6L+U5Zue5b2T5YmN5peg5bqP5YiX6KGo55qE57G75Z6L77yM5YC85Li6bnVsbOaIlmNpcmNsZSxkaXNjLHNxdWFyZSxkYXNoLGRvdFxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqIGVkaXRvci5xdWVyeUNvbW1hbmRWYWx1ZSggJ2luc2VydHVub3JkZXJlZGxpc3QnICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG5cclxuICAgIG1lLmNvbW1hbmRzWydpbnNlcnRvcmRlcmVkbGlzdCddID1cclxuICAgIG1lLmNvbW1hbmRzWydpbnNlcnR1bm9yZGVyZWRsaXN0J10gPSB7XHJcbiAgICAgICAgICAgIGV4ZWNDb21tYW5kOmZ1bmN0aW9uIChjb21tYW5kLCBzdHlsZSkge1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghc3R5bGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBzdHlsZSA9IGNvbW1hbmQudG9Mb3dlckNhc2UoKSA9PSAnaW5zZXJ0b3JkZXJlZGxpc3QnID8gJ2RlY2ltYWwnIDogJ2Rpc2MnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICAgICAgICAgICAgICByYW5nZSA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCksXHJcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyRm4gPSBmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gICBub2RlLm5vZGVUeXBlID09IDEgPyBub2RlLnRhZ05hbWUudG9Mb3dlckNhc2UoKSAhPSAnYnInIDogIWRvbVV0aWxzLmlzV2hpdGVzcGFjZShub2RlKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHRhZyA9IGNvbW1hbmQudG9Mb3dlckNhc2UoKSA9PSAnaW5zZXJ0b3JkZXJlZGxpc3QnID8gJ29sJyA6ICd1bCcsXHJcbiAgICAgICAgICAgICAgICAgICAgZnJhZyA9IG1lLmRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTtcclxuICAgICAgICAgICAgICAgIC8v5Y675o6J5piv5Zug5Li65Lya5Ye6546w6YCJ5Yiw5pyr5bC+77yM5a+86Ie0YWRqdXN0bWVudEJvdW5kYXJ557yp5Yiwb2wvdWznmoTkvY3nva5cclxuICAgICAgICAgICAgICAgIC8vcmFuZ2Uuc2hyaW5rQm91bmRhcnkoKTsvLy5hZGp1c3RtZW50Qm91bmRhcnkoKTtcclxuICAgICAgICAgICAgICAgIHJhbmdlLmFkanVzdG1lbnRCb3VuZGFyeSgpLnNocmlua0JvdW5kYXJ5KCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgYmtvID0gcmFuZ2UuY3JlYXRlQm9va21hcmsodHJ1ZSksXHJcbiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBnZXRMaShtZS5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChia28uc3RhcnQpKSxcclxuICAgICAgICAgICAgICAgICAgICBtb2RpZnlTdGFydCA9IDAsXHJcbiAgICAgICAgICAgICAgICAgICAgZW5kID0gIGdldExpKG1lLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGJrby5lbmQpKSxcclxuICAgICAgICAgICAgICAgICAgICBtb2RpZnlFbmQgPSAwLFxyXG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0UGFyZW50LCBlbmRQYXJlbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgbGlzdCwgdG1wO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChzdGFydCB8fCBlbmQpIHtcclxuICAgICAgICAgICAgICAgICAgICBzdGFydCAmJiAoc3RhcnRQYXJlbnQgPSBzdGFydC5wYXJlbnROb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWJrby5lbmQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZW5kID0gc3RhcnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVuZCAmJiAoZW5kUGFyZW50ID0gZW5kLnBhcmVudE5vZGUpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhcnRQYXJlbnQgPT09IGVuZFBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoc3RhcnQgIT09IGVuZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gc3RhcnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHN0YXJ0Lm5leHRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb21VdGlscy5pc0Jsb2NrRWxtKHRtcC5maXJzdENoaWxkKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwID0gbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICh0bXAuZmlyc3RDaGlsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLmFwcGVuZENoaWxkKHRtcC5maXJzdENoaWxkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wLmFwcGVuZENoaWxkKHApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhZy5hcHBlbmRDaGlsZCh0bXApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRtcCA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRQYXJlbnQuaW5zZXJ0QmVmb3JlKHRtcCwgZW5kKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb21VdGlscy5pc0Jsb2NrRWxtKGVuZC5maXJzdENoaWxkKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcCA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChlbmQuZmlyc3RDaGlsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuYXBwZW5kQ2hpbGQoZW5kLmZpcnN0Q2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kLmFwcGVuZENoaWxkKHApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZyYWcuYXBwZW5kQ2hpbGQoZW5kKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuYnJlYWtQYXJlbnQodG1wLCBzdGFydFBhcmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb21VdGlscy5pc0VtcHR5Tm9kZSh0bXAucHJldmlvdXNTaWJsaW5nKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHRtcC5wcmV2aW91c1NpYmxpbmcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb21VdGlscy5pc0VtcHR5Tm9kZSh0bXAubmV4dFNpYmxpbmcpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUodG1wLm5leHRTaWJsaW5nKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlU3R5bGUgPSBnZXRTdHlsZShzdGFydFBhcmVudCkgfHwgZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZShzdGFydFBhcmVudCwgJ2xpc3Qtc3R5bGUtdHlwZScpIHx8IChjb21tYW5kLnRvTG93ZXJDYXNlKCkgPT0gJ2luc2VydG9yZGVyZWRsaXN0JyA/ICdkZWNpbWFsJyA6ICdkaXNjJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGFydFBhcmVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT0gdGFnICYmIG5vZGVTdHlsZSA9PSBzdHlsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpLCB0bXBGcmFnID0gbWUuZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOyBjaSA9IGZyYWcuZmlyc3RDaGlsZDspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihkb21VdGlscy5pc1RhZ05vZGUoY2ksJ29sIHVsJykpe1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICDliKDpmaTml7bvvIzlrZDliJfooajkuI3lpITnkIZcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXRpbHMuZWFjaChkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZShjaSwnbGknKSxmdW5jdGlvbihsaSl7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKGxpLmZpcnN0Q2hpbGQpe1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wRnJhZy5hcHBlbmRDaGlsZChsaS5maXJzdENoaWxkKTtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4vL1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBGcmFnLmFwcGVuZENoaWxkKGNpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGNpLmZpcnN0Q2hpbGQpIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBGcmFnLmFwcGVuZENoaWxkKGNpLmZpcnN0Q2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKGNpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXAucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodG1wRnJhZywgdG1wKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3QgPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRMaXN0U3R5bGUobGlzdCxzdHlsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0LmFwcGVuZENoaWxkKGZyYWcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGxpc3QsIHRtcCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZSh0bXApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsaXN0ICYmIGFkanVzdExpc3QobGlzdCwgdGFnLCBzdHlsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLm1vdmVUb0Jvb2ttYXJrKGJrbykuc2VsZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgLy/lvIDlp4tcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhcnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHN0YXJ0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXAgPSBzdGFydC5uZXh0U2libGluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb21VdGlscy5pc1RhZ05vZGUoc3RhcnQsICdvbCB1bCcpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhZy5hcHBlbmRDaGlsZChzdGFydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0bXBmcmFnID0gbWUuZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNCbG9jayA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHN0YXJ0LmZpcnN0Q2hpbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRvbVV0aWxzLmlzQmxvY2tFbG0oc3RhcnQuZmlyc3RDaGlsZCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc0Jsb2NrID0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBmcmFnLmFwcGVuZENoaWxkKHN0YXJ0LmZpcnN0Q2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWhhc0Jsb2NrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0bXBQID0gbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBQLmFwcGVuZENoaWxkKHRtcGZyYWcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFnLmFwcGVuZENoaWxkKHRtcFApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYWcuYXBwZW5kQ2hpbGQodG1wZnJhZyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShzdGFydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0bXA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRQYXJlbnQucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoZnJhZywgc3RhcnRQYXJlbnQubmV4dFNpYmxpbmcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9tVXRpbHMuaXNFbXB0eU5vZGUoc3RhcnRQYXJlbnQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydEJlZm9yZShzdGFydFBhcmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoc3RhcnRQYXJlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnRBZnRlcihzdGFydFBhcmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZ5U3RhcnQgPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVuZCAmJiBkb21VdGlscy5pbkRvYyhlbmRQYXJlbnQsIG1lLmRvY3VtZW50KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL+e7k+adn1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IGVuZFBhcmVudC5maXJzdENoaWxkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoc3RhcnQgJiYgc3RhcnQgIT09IGVuZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gc3RhcnQubmV4dFNpYmxpbmc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9tVXRpbHMuaXNUYWdOb2RlKHN0YXJ0LCAnb2wgdWwnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYWcuYXBwZW5kQ2hpbGQoc3RhcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBmcmFnID0gbWUuZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc0Jsb2NrID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoc3RhcnQuZmlyc3RDaGlsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9tVXRpbHMuaXNCbG9ja0VsbShzdGFydC5maXJzdENoaWxkKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzQmxvY2sgPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcGZyYWcuYXBwZW5kQ2hpbGQoc3RhcnQuZmlyc3RDaGlsZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaGFzQmxvY2spIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wUCA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wUC5hcHBlbmRDaGlsZCh0bXBmcmFnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhZy5hcHBlbmRDaGlsZCh0bXBQKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFnLmFwcGVuZENoaWxkKHRtcGZyYWcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoc3RhcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0bXA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRtcERpdiA9IGRvbVV0aWxzLmNyZWF0ZUVsZW1lbnQobWUuZG9jdW1lbnQsICdkaXYnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndG1wRGl2JzoxXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5tb3ZlQ2hpbGQoZW5kLCB0bXBEaXYpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgZnJhZy5hcHBlbmRDaGlsZCh0bXBEaXYpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoZW5kKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZW5kUGFyZW50LnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGZyYWcsIGVuZFBhcmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldEVuZEJlZm9yZShlbmRQYXJlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9tVXRpbHMuaXNFbXB0eU5vZGUoZW5kUGFyZW50KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKGVuZFBhcmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmeUVuZCA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCFtb2RpZnlTdGFydCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0QmVmb3JlKG1lLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGJrby5zdGFydCkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGJrby5lbmQgJiYgIW1vZGlmeUVuZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldEVuZEFmdGVyKG1lLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGJrby5lbmQpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJhbmdlLmVubGFyZ2UodHJ1ZSwgZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm90RXhjaGFuZ2Vbbm9kZS50YWdOYW1lXTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGZyYWcgPSBtZS5kb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIGJrID0gcmFuZ2UuY3JlYXRlQm9va21hcmsoKSxcclxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoYmsuc3RhcnQsIGZhbHNlLCBmaWx0ZXJGbiksXHJcbiAgICAgICAgICAgICAgICAgICAgdG1wUmFuZ2UgPSByYW5nZS5jbG9uZVJhbmdlKCksXHJcbiAgICAgICAgICAgICAgICAgICAgdG1wTm9kZSxcclxuICAgICAgICAgICAgICAgICAgICBibG9jayA9IGRvbVV0aWxzLmlzQmxvY2tFbG07XHJcblxyXG4gICAgICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQgJiYgY3VycmVudCAhPT0gYmsuZW5kICYmIChkb21VdGlscy5nZXRQb3NpdGlvbihjdXJyZW50LCBiay5lbmQpICYgZG9tVXRpbHMuUE9TSVRJT05fUFJFQ0VESU5HKSkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudC5ub2RlVHlwZSA9PSAzIHx8IGR0ZC5saVtjdXJyZW50LnRhZ05hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Lm5vZGVUeXBlID09IDEgJiYgZHRkLiRsaXN0W2N1cnJlbnQudGFnTmFtZV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChjdXJyZW50LmZpcnN0Q2hpbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFnLmFwcGVuZENoaWxkKGN1cnJlbnQuZmlyc3RDaGlsZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBOb2RlID0gZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUoY3VycmVudCwgZmFsc2UsIGZpbHRlckZuKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShjdXJyZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0bXBOb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRtcE5vZGUgPSBjdXJyZW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bXBSYW5nZS5zZXRTdGFydEJlZm9yZShjdXJyZW50KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChjdXJyZW50ICYmIGN1cnJlbnQgIT09IGJrLmVuZCAmJiAoIWJsb2NrKGN1cnJlbnQpIHx8IGRvbVV0aWxzLmlzQm9va21hcmtOb2RlKGN1cnJlbnQpICkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcE5vZGUgPSBjdXJyZW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGRvbVV0aWxzLmdldE5leHREb21Ob2RlKGN1cnJlbnQsIGZhbHNlLCBudWxsLCBmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhbm90RXhjaGFuZ2Vbbm9kZS50YWdOYW1lXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCAmJiBibG9jayhjdXJyZW50KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gZG9tVXRpbHMuZ2V0TmV4dERvbU5vZGUodG1wTm9kZSwgZmFsc2UsIGZpbHRlckZuKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0bXAgJiYgZG9tVXRpbHMuaXNCb29rbWFya05vZGUodG1wKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBkb21VdGlscy5nZXROZXh0RG9tTm9kZSh0bXAsIGZhbHNlLCBmaWx0ZXJGbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wTm9kZSA9IHRtcDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bXBSYW5nZS5zZXRFbmRBZnRlcih0bXBOb2RlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBkb21VdGlscy5nZXROZXh0RG9tTm9kZSh0bXBOb2RlLCBmYWxzZSwgZmlsdGVyRm4pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxpID0gcmFuZ2UuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpLmFwcGVuZENoaWxkKHRtcFJhbmdlLmV4dHJhY3RDb250ZW50cygpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoZG9tVXRpbHMuaXNFbXB0eU5vZGUobGkpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0bXBOb2RlID0gcmFuZ2UuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUobGkuZmlyc3RDaGlsZCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wTm9kZS5hcHBlbmRDaGlsZChsaS5maXJzdENoaWxkKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGkuYXBwZW5kQ2hpbGQodG1wTm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZnJhZy5hcHBlbmRDaGlsZChsaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGRvbVV0aWxzLmdldE5leHREb21Ob2RlKGN1cnJlbnQsIHRydWUsIGZpbHRlckZuKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByYW5nZS5tb3ZlVG9Cb29rbWFyayhiaykuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBsaXN0ID0gbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWcpO1xyXG4gICAgICAgICAgICAgICAgc2V0TGlzdFN0eWxlKGxpc3Qsc3R5bGUpO1xyXG4gICAgICAgICAgICAgICAgbGlzdC5hcHBlbmRDaGlsZChmcmFnKTtcclxuICAgICAgICAgICAgICAgIHJhbmdlLmluc2VydE5vZGUobGlzdCk7XHJcbiAgICAgICAgICAgICAgICAvL+W9k+WJjWxpc3TkuIrkuIvnnIvog73lkKblkIjlubZcclxuICAgICAgICAgICAgICAgIGFkanVzdExpc3QobGlzdCwgdGFnLCBzdHlsZSk7XHJcbiAgICAgICAgICAgICAgICAvL+WOu+aOieWGl+S9meeahHRtcERpdlxyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpLCB0bXBEaXZzID0gZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUobGlzdCwgJ2RpdicpOyBjaSA9IHRtcERpdnNbaSsrXTspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY2kuZ2V0QXR0cmlidXRlKCd0bXBEaXYnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoY2ksIHRydWUpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmFuZ2UubW92ZVRvQm9va21hcmsoYmtvKS5zZWxlY3QoKTtcclxuXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOmZ1bmN0aW9uIChjb21tYW5kKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdGFnID0gY29tbWFuZC50b0xvd2VyQ2FzZSgpID09ICdpbnNlcnRvcmRlcmVkbGlzdCcgPyAnb2wnIDogJ3VsJztcclxuICAgICAgICAgICAgICAgIHZhciBwYXRoID0gdGhpcy5zZWxlY3Rpb24uZ2V0U3RhcnRFbGVtZW50UGF0aCgpO1xyXG4gICAgICAgICAgICAgICAgZm9yKHZhciBpPSAwLGNpO2NpID0gcGF0aFtpKytdOyl7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoY2kubm9kZU5hbWUgPT0gJ1RBQkxFJyl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmKHRhZyA9PSBjaS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDFcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XHJcblxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBxdWVyeUNvbW1hbmRWYWx1ZTpmdW5jdGlvbiAoY29tbWFuZCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHRhZyA9IGNvbW1hbmQudG9Mb3dlckNhc2UoKSA9PSAnaW5zZXJ0b3JkZXJlZGxpc3QnID8gJ29sJyA6ICd1bCc7XHJcbiAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IHRoaXMuc2VsZWN0aW9uLmdldFN0YXJ0RWxlbWVudFBhdGgoKSxcclxuICAgICAgICAgICAgICAgICAgICBub2RlO1xyXG4gICAgICAgICAgICAgICAgZm9yKHZhciBpPSAwLGNpO2NpID0gcGF0aFtpKytdOyl7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoY2kubm9kZU5hbWUgPT0gJ1RBQkxFJyl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYodGFnID09IGNpLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gY2k7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZSA/IGdldFN0eWxlKG5vZGUpIHx8IGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUobm9kZSwgJ2xpc3Qtc3R5bGUtdHlwZScpIDogbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbn07XHJcblxyXG5cblxuLy8gcGx1Z2lucy9zb3VyY2UuanNcbi8qKlxyXG4gKiDmupDnoIHnvJbovpHmj5Lku7ZcclxuICogQGZpbGVcclxuICogQHNpbmNlIDEuMi42LjFcclxuICovXHJcblxyXG4oZnVuY3Rpb24gKCl7XHJcbiAgICB2YXIgc291cmNlRWRpdG9ycyA9IHtcclxuICAgICAgICB0ZXh0YXJlYTogZnVuY3Rpb24gKGVkaXRvciwgaG9sZGVyKXtcclxuICAgICAgICAgICAgdmFyIHRleHRhcmVhID0gaG9sZGVyLm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGV4dGFyZWEnKTtcclxuICAgICAgICAgICAgdGV4dGFyZWEuc3R5bGUuY3NzVGV4dCA9ICdwb3NpdGlvbjphYnNvbHV0ZTtyZXNpemU6bm9uZTt3aWR0aDoxMDAlO2hlaWdodDoxMDAlO2JvcmRlcjowO3BhZGRpbmc6MDttYXJnaW46MDtvdmVyZmxvdy15OmF1dG87JztcclxuICAgICAgICAgICAgLy8gdG9kbzogSUXkuIvlj6rmnIlvbnJlc2l6ZeWxnuaAp+WPr+eUqC4uLiDlvojnuqDnu5NcclxuICAgICAgICAgICAgaWYgKGJyb3dzZXIuaWUgJiYgYnJvd3Nlci52ZXJzaW9uIDwgOCkge1xyXG4gICAgICAgICAgICAgICAgdGV4dGFyZWEuc3R5bGUud2lkdGggPSBob2xkZXIub2Zmc2V0V2lkdGggKyAncHgnO1xyXG4gICAgICAgICAgICAgICAgdGV4dGFyZWEuc3R5bGUuaGVpZ2h0ID0gaG9sZGVyLm9mZnNldEhlaWdodCArICdweCc7XHJcbiAgICAgICAgICAgICAgICBob2xkZXIub25yZXNpemUgPSBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgICAgICAgICB0ZXh0YXJlYS5zdHlsZS53aWR0aCA9IGhvbGRlci5vZmZzZXRXaWR0aCArICdweCc7XHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dGFyZWEuc3R5bGUuaGVpZ2h0ID0gaG9sZGVyLm9mZnNldEhlaWdodCArICdweCc7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGhvbGRlci5hcHBlbmRDaGlsZCh0ZXh0YXJlYSk7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBzZXRDb250ZW50OiBmdW5jdGlvbiAoY29udGVudCl7XHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dGFyZWEudmFsdWUgPSBjb250ZW50O1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGdldENvbnRlbnQ6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZXh0YXJlYS52YWx1ZTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciByYW5nZTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYnJvd3Nlci5pZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZSA9IHRleHRhcmVhLmNyZWF0ZVRleHRSYW5nZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2VsZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy90b2RvOiBjaHJvbWXkuIvml6Dms5Xorr7nva7nhKbngrlcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dGFyZWEuc2V0U2VsZWN0aW9uUmFuZ2UoMCwgMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHRhcmVhLmZvY3VzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGRpc3Bvc2U6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICAgICAgICAgIGhvbGRlci5yZW1vdmVDaGlsZCh0ZXh0YXJlYSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gdG9kb1xyXG4gICAgICAgICAgICAgICAgICAgIGhvbGRlci5vbnJlc2l6ZSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dGFyZWEgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIGhvbGRlciA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSxcclxuICAgICAgICBjb2RlbWlycm9yOiBmdW5jdGlvbiAoZWRpdG9yLCBob2xkZXIpe1xyXG5cclxuICAgICAgICAgICAgdmFyIGNvZGVFZGl0b3IgPSB3aW5kb3cuQ29kZU1pcnJvcihob2xkZXIsIHtcclxuICAgICAgICAgICAgICAgIG1vZGU6IFwidGV4dC9odG1sXCIsXHJcbiAgICAgICAgICAgICAgICB0YWJNb2RlOiBcImluZGVudFwiLFxyXG4gICAgICAgICAgICAgICAgbGluZU51bWJlcnM6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBsaW5lV3JhcHBpbmc6dHJ1ZVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdmFyIGRvbSA9IGNvZGVFZGl0b3IuZ2V0V3JhcHBlckVsZW1lbnQoKTtcclxuICAgICAgICAgICAgZG9tLnN0eWxlLmNzc1RleHQgPSAncG9zaXRpb246YWJzb2x1dGU7bGVmdDowO3RvcDowO3dpZHRoOjEwMCU7aGVpZ2h0OjEwMCU7Zm9udC1mYW1pbHk6Y29uc29sYXMsXCJDb3VyaWVyIG5ld1wiLG1vbm9zcGFjZTtmb250LXNpemU6MTNweDsnO1xyXG4gICAgICAgICAgICBjb2RlRWRpdG9yLmdldFNjcm9sbGVyRWxlbWVudCgpLnN0eWxlLmNzc1RleHQgPSAncG9zaXRpb246YWJzb2x1dGU7bGVmdDowO3RvcDowO3dpZHRoOjEwMCU7aGVpZ2h0OjEwMCU7JztcclxuICAgICAgICAgICAgY29kZUVkaXRvci5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBnZXRDb2RlTWlycm9yOmZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvZGVFZGl0b3I7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgc2V0Q29udGVudDogZnVuY3Rpb24gKGNvbnRlbnQpe1xyXG4gICAgICAgICAgICAgICAgICAgIGNvZGVFZGl0b3Iuc2V0VmFsdWUoY29udGVudCk7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgZ2V0Q29udGVudDogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvZGVFZGl0b3IuZ2V0VmFsdWUoKTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICAgICAgICAgIGNvZGVFZGl0b3IuZm9jdXMoKTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBkaXNwb3NlOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgICAgICAgICBob2xkZXIucmVtb3ZlQ2hpbGQoZG9tKTtcclxuICAgICAgICAgICAgICAgICAgICBkb20gPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvZGVFZGl0b3IgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgVUUucGx1Z2luc1snc291cmNlJ10gPSBmdW5jdGlvbiAoKXtcclxuICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgIHZhciBvcHQgPSB0aGlzLm9wdGlvbnM7XHJcbiAgICAgICAgdmFyIHNvdXJjZU1vZGUgPSBmYWxzZTtcclxuICAgICAgICB2YXIgc291cmNlRWRpdG9yO1xyXG4gICAgICAgIHZhciBvcmdTZXRDb250ZW50O1xyXG4gICAgICAgIG9wdC5zb3VyY2VFZGl0b3IgPSBicm93c2VyLmllICA/ICd0ZXh0YXJlYScgOiAob3B0LnNvdXJjZUVkaXRvciB8fCAnY29kZW1pcnJvcicpO1xyXG5cclxuICAgICAgICBtZS5zZXRPcHQoe1xyXG4gICAgICAgICAgICBzb3VyY2VFZGl0b3JGaXJzdDpmYWxzZVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNvdXJjZUVkaXRvcihob2xkZXIpe1xyXG4gICAgICAgICAgICByZXR1cm4gc291cmNlRWRpdG9yc1tvcHQuc291cmNlRWRpdG9yID09ICdjb2RlbWlycm9yJyAmJiB3aW5kb3cuQ29kZU1pcnJvciA/ICdjb2RlbWlycm9yJyA6ICd0ZXh0YXJlYSddKG1lLCBob2xkZXIpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdmFyIGJha0Nzc1RleHQ7XHJcbiAgICAgICAgLy/op6PlhrPlnKjmupDnoIHmqKHlvI/kuItnZXRDb250ZW505LiN6IO95b6X5Yiw5pyA5paw55qE5YaF5a656Zeu6aKYXHJcbiAgICAgICAgdmFyIG9sZEdldENvbnRlbnQsXHJcbiAgICAgICAgICAgIGJha0FkZHJlc3M7XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOWIh+aNoua6kOeggeaooeW8j+WSjOe8lui+keaooeW8j1xyXG4gICAgICAgICAqIEBjb21tYW5kIHNvdXJjZVxyXG4gICAgICAgICAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnc291cmNlJyk7XHJcbiAgICAgICAgICogYGBgXHJcbiAgICAgICAgICovXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOafpeivouW9k+WJjee8lui+keWMuuWfn+eahOeKtuaAgeaYr+a6kOeggeaooeW8j+i/mOaYr+WPr+inhuWMluaooeW8j1xyXG4gICAgICAgICAqIEBjb21tYW5kIHNvdXJjZVxyXG4gICAgICAgICAqIEBtZXRob2QgcXVlcnlDb21tYW5kU3RhdGVcclxuICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAgICAgICAgICogQHJldHVybiB7IGludCB9IOWmguaenOW9k+WJjeaYr+a6kOeggee8lui+keaooeW8j++8jOi/lOWbnjHvvIzlkKbliJnov5Tlm54wXHJcbiAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICogZWRpdG9yLnF1ZXJ5Q29tbWFuZFN0YXRlKCAnc291cmNlJyApO1xyXG4gICAgICAgICAqIGBgYFxyXG4gICAgICAgICAqL1xyXG5cclxuICAgICAgICBtZS5jb21tYW5kc1snc291cmNlJ10gPSB7XHJcbiAgICAgICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoKXtcclxuXHJcbiAgICAgICAgICAgICAgICBzb3VyY2VNb2RlID0gIXNvdXJjZU1vZGU7XHJcbiAgICAgICAgICAgICAgICBpZiAoc291cmNlTW9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGJha0FkZHJlc3MgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKS5jcmVhdGVBZGRyZXNzKGZhbHNlLHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLnVuZG9NYW5nZXIgJiYgbWUudW5kb01hbmdlci5zYXZlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGJyb3dzZXIuZ2Vja28pe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5ib2R5LmNvbnRlbnRFZGl0YWJsZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgYmFrQ3NzVGV4dCA9IG1lLmlmcmFtZS5zdHlsZS5jc3NUZXh0O1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmlmcmFtZS5zdHlsZS5jc3NUZXh0ICs9ICdwb3NpdGlvbjphYnNvbHV0ZTtsZWZ0Oi0zMjc2OHB4O3RvcDotMzI3NjhweDsnO1xyXG5cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdiZWZvcmVnZXRjb250ZW50Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJvb3QgPSBVRS5odG1scGFyc2VyKG1lLmJvZHkuaW5uZXJIVE1MKTtcclxuICAgICAgICAgICAgICAgICAgICBtZS5maWx0ZXJPdXRwdXRSdWxlKHJvb3QpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJvb3QudHJhdmVyc2FsKGZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnR5cGUgPT0gJ2VsZW1lbnQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG5vZGUudGFnTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RkJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd0aCc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY2FwdGlvbic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobm9kZS5jaGlsZHJlbiAmJiBub2RlLmNoaWxkcmVuLmxlbmd0aCA9PSAxKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobm9kZS5maXJzdENoaWxkKCkudGFnTmFtZSA9PSAnYnInICl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnJlbW92ZUNoaWxkKG5vZGUuZmlyc3RDaGlsZCgpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdwcmUnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmlubmVyVGV4dChub2RlLmlubmVyVGV4dCgpLnJlcGxhY2UoLyZuYnNwOy9nLCcgJykpXHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnYWZ0ZXJnZXRjb250ZW50Jyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjb250ZW50ID0gcm9vdC50b0h0bWwodHJ1ZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZUVkaXRvciA9IGNyZWF0ZVNvdXJjZUVkaXRvcihtZS5pZnJhbWUucGFyZW50Tm9kZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZUVkaXRvci5zZXRDb250ZW50KGNvbnRlbnQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBvcmdTZXRDb250ZW50ID0gbWUuc2V0Q29udGVudDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbWUuc2V0Q29udGVudCA9IGZ1bmN0aW9uKGh0bWwpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL+i/memHjOaaguaXtuS4jeinpuWPkeS6i+S7tu+8jOmYsuatouaKpemUmVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm9vdCA9IFVFLmh0bWxwYXJzZXIoaHRtbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmZpbHRlcklucHV0UnVsZShyb290KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaHRtbCA9IHJvb3QudG9IdG1sKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZUVkaXRvci5zZXRDb250ZW50KGh0bWwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZUVkaXRvci5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuYWRkTGlzdGVuZXIoJ2Z1bGxzY3JlZW5jaGFuZ2VkJywgZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VFZGl0b3IuZ2V0Q29kZU1pcnJvcigpLnJlZnJlc2goKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGUpe31cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8v6YeN572uZ2V0Q29udGVudO+8jOa6kOeggeaooeW8j+S4i+WPluWAvOS5n+iDveaYr+acgOaWsOeahOaVsOaNrlxyXG4gICAgICAgICAgICAgICAgICAgIG9sZEdldENvbnRlbnQgPSBtZS5nZXRDb250ZW50O1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmdldENvbnRlbnQgPSBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNvdXJjZUVkaXRvci5nZXRDb250ZW50KCkgfHwgJzxwPicgKyAoYnJvd3Nlci5pZSA/ICcnIDogJzxici8+JykrJzwvcD4nO1xyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmlmcmFtZS5zdHlsZS5jc3NUZXh0ID0gYmFrQ3NzVGV4dDtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgY29udCA9IHNvdXJjZUVkaXRvci5nZXRDb250ZW50KCkgfHwgJzxwPicgKyAoYnJvd3Nlci5pZSA/ICcnIDogJzxici8+JykrJzwvcD4nO1xyXG4gICAgICAgICAgICAgICAgICAgIC8v5aSE55CG5o6JYmxvY2voioLngrnliY3lkI7nmoTnqbrmoLws5pyJ5Y+v6IO95Lya6K+v5ZG95Lit77yM5pqC5pe25LiN6ICD6JmRXHJcbiAgICAgICAgICAgICAgICAgICAgY29udCA9IGNvbnQucmVwbGFjZShuZXcgUmVnRXhwKCdbXFxcXHJcXFxcdFxcXFxuIF0qPFxcLz8oXFxcXHcrKVxcXFxzKig/OltePl0qKT4nLCdnJyksIGZ1bmN0aW9uKGEsYil7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGIgJiYgIWR0ZC4kaW5saW5lV2l0aEFbYi50b0xvd2VyQ2FzZSgpXSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS5yZXBsYWNlKC8oXltcXG5cXHJcXHQgXSopfChbXFxuXFxyXFx0IF0qJCkvZywnJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEucmVwbGFjZSgvKF5bXFxuXFxyXFx0XSopfChbXFxuXFxyXFx0XSokKS9nLCcnKVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBtZS5zZXRDb250ZW50ID0gb3JnU2V0Q29udGVudDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbWUuc2V0Q29udGVudChjb250KTtcclxuICAgICAgICAgICAgICAgICAgICBzb3VyY2VFZGl0b3IuZGlzcG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZUVkaXRvciA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgLy/ov5jljp9nZXRDb250ZW505pa55rOVXHJcbiAgICAgICAgICAgICAgICAgICAgbWUuZ2V0Q29udGVudCA9IG9sZEdldENvbnRlbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0ID0gbWUuYm9keS5maXJzdENoaWxkO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vdHJhY2U6MTEwNiDpg73liKDpmaTnqbrkuobvvIzkuIvovrnkvJrmiqXplJnvvIzmiYDku6XooaXlhYXkuIDkuKpw5Y2g5L2NXHJcbiAgICAgICAgICAgICAgICAgICAgaWYoIWZpcnN0KXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuYm9keS5pbm5lckhUTUwgPSAnPHA+JysoYnJvd3Nlci5pZT8nJzonPGJyLz4nKSsnPC9wPic7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0ID0gbWUuYm9keS5maXJzdENoaWxkO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8v6KaB5ZyoaWZt5Li65pi+56S65pe2ZmbmiY3og73lj5bliLBzZWxlY3Rpb24s5ZCm5YiZ5oql6ZSZXHJcbiAgICAgICAgICAgICAgICAgICAgLy/ov5nph4zkuI3og73mr5TovoPkvY3nva7kuoZcclxuICAgICAgICAgICAgICAgICAgICBtZS51bmRvTWFuZ2VyICYmIG1lLnVuZG9NYW5nZXIuc2F2ZSh0cnVlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYoYnJvd3Nlci5nZWNrbyl7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC5zdHlsZS5jc3NUZXh0ID0gJ3Bvc2l0aW9uOmFic29sdXRlO2xlZnQ6MDt0b3A6LTMyNzY4cHgnO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChpbnB1dCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5ib2R5LmNvbnRlbnRFZGl0YWJsZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5zZXRWaWV3cG9ydE9mZnNldChpbnB1dCwgeyBsZWZ0OiAtMzI3NjgsIHRvcDogMCB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0LmZvY3VzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuYm9keS5jb250ZW50RWRpdGFibGUgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLm1vdmVUb0FkZHJlc3MoYmFrQWRkcmVzcykuc2VsZWN0KHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShpbnB1dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL2ll5LiL5pyJ5Y+v6IO95oql6ZSZ77yM5q+U5aaC5Zyo5Luj56CB6aG25aS055qE5oOF5Ya1XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyeXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLm1vdmVUb0FkZHJlc3MoYmFrQWRkcmVzcykuc2VsZWN0KHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZSl7fVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnc291cmNlbW9kZWNoYW5nZWQnLCBzb3VyY2VNb2RlKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHNvdXJjZU1vZGV8MDtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgbm90TmVlZFVuZG8gOiAxXHJcbiAgICAgICAgfTtcclxuICAgICAgICB2YXIgb2xkUXVlcnlDb21tYW5kU3RhdGUgPSBtZS5xdWVyeUNvbW1hbmRTdGF0ZTtcclxuXHJcbiAgICAgICAgbWUucXVlcnlDb21tYW5kU3RhdGUgPSBmdW5jdGlvbiAoY21kTmFtZSl7XHJcbiAgICAgICAgICAgIGNtZE5hbWUgPSBjbWROYW1lLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgIGlmIChzb3VyY2VNb2RlKSB7XHJcbiAgICAgICAgICAgICAgICAvL+a6kOeggeaooeW8j+S4i+WPr+S7peW8gOWQr+eahOWRveS7pFxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNtZE5hbWUgaW4ge1xyXG4gICAgICAgICAgICAgICAgICAgICdzb3VyY2UnIDogMSxcclxuICAgICAgICAgICAgICAgICAgICAnZnVsbHNjcmVlbicgOiAxXHJcbiAgICAgICAgICAgICAgICB9ID8gMSA6IC0xXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG9sZFF1ZXJ5Q29tbWFuZFN0YXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaWYob3B0LnNvdXJjZUVkaXRvciA9PSBcImNvZGVtaXJyb3JcIil7XHJcblxyXG4gICAgICAgICAgICBtZS5hZGRMaXN0ZW5lcihcInJlYWR5XCIsZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgIHV0aWxzLmxvYWRGaWxlKGRvY3VtZW50LHtcclxuICAgICAgICAgICAgICAgICAgICBzcmMgOiBvcHQuY29kZU1pcnJvckpzVXJsIHx8IG9wdC5VRURJVE9SX0hPTUVfVVJMICsgXCJ0aGlyZC1wYXJ0eS9jb2RlbWlycm9yL2NvZGVtaXJyb3IuanNcIixcclxuICAgICAgICAgICAgICAgICAgICB0YWcgOiBcInNjcmlwdFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGUgOiBcInRleHQvamF2YXNjcmlwdFwiLFxyXG4gICAgICAgICAgICAgICAgICAgIGRlZmVyIDogXCJkZWZlclwiXHJcbiAgICAgICAgICAgICAgICB9LGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYob3B0LnNvdXJjZUVkaXRvckZpcnN0KXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuZXhlY0NvbW1hbmQoXCJzb3VyY2VcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB1dGlscy5sb2FkRmlsZShkb2N1bWVudCx7XHJcbiAgICAgICAgICAgICAgICAgICAgdGFnIDogXCJsaW5rXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVsIDogXCJzdHlsZXNoZWV0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZSA6IFwidGV4dC9jc3NcIixcclxuICAgICAgICAgICAgICAgICAgICBocmVmIDogb3B0LmNvZGVNaXJyb3JDc3NVcmwgfHwgb3B0LlVFRElUT1JfSE9NRV9VUkwgKyBcInRoaXJkLXBhcnR5L2NvZGVtaXJyb3IvY29kZW1pcnJvci5jc3NcIlxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfTtcclxuXHJcbn0pKCk7XG5cbi8vIHBsdWdpbnMvZW50ZXJrZXkuanNcbi8vL2ltcG9ydCBjb3JlXHJcbi8vL2ltcG9ydCBwbHVnaW5zL3VuZG8uanNcclxuLy8vY29tbWFuZHMg6K6+572u5Zue6L2m5qCH562+cOaIlmJyXHJcbi8vL2NvbW1hbmRzTmFtZSAgRW50ZXJLZXlcclxuLy8vY29tbWFuZHNUaXRsZSAg6K6+572u5Zue6L2m5qCH562+cOaIlmJyXHJcbi8qKlxyXG4gKiBAZGVzY3JpcHRpb24g5aSE55CG5Zue6L2mXHJcbiAqIEBhdXRob3IgemhhbnlpXHJcbiAqL1xyXG5VRS5wbHVnaW5zWydlbnRlcmtleSddID0gZnVuY3Rpb24oKSB7XHJcbiAgICB2YXIgaFRhZyxcclxuICAgICAgICBtZSA9IHRoaXMsXHJcbiAgICAgICAgdGFnID0gbWUub3B0aW9ucy5lbnRlclRhZztcclxuICAgIG1lLmFkZExpc3RlbmVyKCdrZXl1cCcsIGZ1bmN0aW9uKHR5cGUsIGV2dCkge1xyXG5cclxuICAgICAgICB2YXIga2V5Q29kZSA9IGV2dC5rZXlDb2RlIHx8IGV2dC53aGljaDtcclxuICAgICAgICBpZiAoa2V5Q29kZSA9PSAxMykge1xyXG4gICAgICAgICAgICB2YXIgcmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxcclxuICAgICAgICAgICAgICAgIHN0YXJ0ID0gcmFuZ2Uuc3RhcnRDb250YWluZXIsXHJcbiAgICAgICAgICAgICAgICBkb1NhdmU7XHJcblxyXG4gICAgICAgICAgICAvL+S/ruato+WcqGgxLWg26YeM6L655Zue6L2m5ZCO5LiN6IO95bWM5aWXcOeahOmXrumimFxyXG4gICAgICAgICAgICBpZiAoIWJyb3dzZXIuaWUpIHtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoL2hcXGQvaS50ZXN0KGhUYWcpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJyb3dzZXIuZ2Vja28pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGggPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHN0YXJ0LCBbICdoMScsICdoMicsICdoMycsICdoNCcsICdoNScsICdoNicsJ2Jsb2NrcXVvdGUnLCdjYXB0aW9uJywndGFibGUnXSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2Zvcm1hdEJsb2NrJywgZmFsc2UsICc8cD4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvU2F2ZSA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL2Nocm9tZSByZW1vdmUgZGl2XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGFydC5ub2RlVHlwZSA9PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wID0gbWUuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJycpLGRpdjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLmluc2VydE5vZGUodG1wKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpdiA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUodG1wLCAnZGl2JywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGl2KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHAgPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGRpdi5maXJzdENoaWxkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuYXBwZW5kQ2hpbGQoZGl2LmZpcnN0Q2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXYucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUocCwgZGl2KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoZGl2KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydEJlZm9yZSh0bXApLnNldEN1cnNvcigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvU2F2ZSA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUodG1wKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChtZS51bmRvTWFuZ2VyICYmIGRvU2F2ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS51bmRvTWFuZ2VyLnNhdmUoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvL+ayoeacieermeS9jeespu+8jOS8muWHuueOsOWkmuihjOeahOmXrumimFxyXG4gICAgICAgICAgICAgICAgYnJvd3Nlci5vcGVyYSAmJiAgcmFuZ2Uuc2VsZWN0KCk7XHJcbiAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdzYXZlU2NlbmUnLHRydWUsdHJ1ZSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIG1lLmFkZExpc3RlbmVyKCdrZXlkb3duJywgZnVuY3Rpb24odHlwZSwgZXZ0KSB7XHJcbiAgICAgICAgdmFyIGtleUNvZGUgPSBldnQua2V5Q29kZSB8fCBldnQud2hpY2g7XHJcbiAgICAgICAgaWYgKGtleUNvZGUgPT0gMTMpIHsvL+Wbnui9plxyXG4gICAgICAgICAgICBpZihtZS5maXJlRXZlbnQoJ2JlZm9yZWVudGVya2V5ZG93bicpKXtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnByZXZlbnREZWZhdWx0KGV2dCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdzYXZlU2NlbmUnLHRydWUsdHJ1ZSk7XHJcbiAgICAgICAgICAgIGhUYWcgPSAnJztcclxuXHJcblxyXG4gICAgICAgICAgICB2YXIgcmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghcmFuZ2UuY29sbGFwc2VkKSB7XHJcbiAgICAgICAgICAgICAgICAvL+i3qHRk5LiN6IO95YigXHJcbiAgICAgICAgICAgICAgICB2YXIgc3RhcnQgPSByYW5nZS5zdGFydENvbnRhaW5lcixcclxuICAgICAgICAgICAgICAgICAgICBlbmQgPSByYW5nZS5lbmRDb250YWluZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgc3RhcnRUZCA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUoc3RhcnQsICd0ZCcsIHRydWUpLFxyXG4gICAgICAgICAgICAgICAgICAgIGVuZFRkID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShlbmQsICd0ZCcsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHN0YXJ0VGQgJiYgZW5kVGQgJiYgc3RhcnRUZCAhPT0gZW5kVGQgfHwgIXN0YXJ0VGQgJiYgZW5kVGQgfHwgc3RhcnRUZCAmJiAhZW5kVGQpIHtcclxuICAgICAgICAgICAgICAgICAgICBldnQucHJldmVudERlZmF1bHQgPyBldnQucHJldmVudERlZmF1bHQoKSA6ICggZXZ0LnJldHVyblZhbHVlID0gZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodGFnID09ICdwJykge1xyXG5cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIWJyb3dzZXIuaWUpIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHJhbmdlLnN0YXJ0Q29udGFpbmVyLCBbJ29sJywndWwnLCdwJywgJ2gxJywgJ2gyJywgJ2gzJywgJ2g0JywgJ2g1JywgJ2g2JywnYmxvY2txdW90ZScsJ2NhcHRpb24nXSwgdHJ1ZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vb3BlcmHkuIvmiafooYxmb3JtYXRibG9ja+S8muWcqHRhYmxl55qE5Zy65pmv5LiL5pyJ6Zeu6aKY77yM5Zue6L2m5Zyob3BlcmHljp/nlJ/mlK/mjIHlvojlpb3vvIzmiYDku6XmmoLml7blnKhvcGVyYeWOu+aOieiwg+eUqOi/meS4quWOn+eUn+eahGNvbW1hbmRcclxuICAgICAgICAgICAgICAgICAgICAvL3RyYWNlOjI0MzFcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXJ0ICYmICFicm93c2VyLm9wZXJhKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5kb2N1bWVudC5leGVjQ29tbWFuZCgnZm9ybWF0QmxvY2snLCBmYWxzZSwgJzxwPicpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJyb3dzZXIuZ2Vja28pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocmFuZ2Uuc3RhcnRDb250YWluZXIsICdwJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydCAmJiBkb21VdGlscy5yZW1vdmVEaXJ0eUF0dHIoc3RhcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBoVGFnID0gc3RhcnQudGFnTmFtZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09ICdwJyAmJiBicm93c2VyLmdlY2tvICYmIGRvbVV0aWxzLnJlbW92ZURpcnR5QXR0cihzdGFydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBldnQucHJldmVudERlZmF1bHQgPyBldnQucHJldmVudERlZmF1bHQoKSA6ICggZXZ0LnJldHVyblZhbHVlID0gZmFsc2UpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghcmFuZ2UuY29sbGFwc2VkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2UuZGVsZXRlQ29udGVudHMoKTtcclxuICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHJhbmdlLnN0YXJ0Q29udGFpbmVyO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGFydC5ub2RlVHlwZSA9PSAxICYmIChzdGFydCA9IHN0YXJ0LmNoaWxkTm9kZXNbcmFuZ2Uuc3RhcnRPZmZzZXRdKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoc3RhcnQubm9kZVR5cGUgPT0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGR0ZC4kZW1wdHlbc3RhcnQudGFnTmFtZV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydEJlZm9yZShzdGFydCkuc2V0Q3Vyc29yKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lLnVuZG9NYW5nZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUudW5kb01hbmdlci5zYXZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhcnQuZmlyc3RDaGlsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiciA9IHJhbmdlLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2JyJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQuYXBwZW5kQ2hpbGQoYnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KHN0YXJ0LCAwKS5zZXRDdXJzb3IoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWUudW5kb01hbmdlcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS51bmRvTWFuZ2VyLnNhdmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBzdGFydC5maXJzdENoaWxkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGFydCA9PT0gcmFuZ2Uuc3RhcnRDb250YWluZXIuY2hpbGROb2Rlc1tyYW5nZS5zdGFydE9mZnNldF0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyID0gcmFuZ2UuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnInKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLmluc2VydE5vZGUoYnIpLnNldEN1cnNvcigpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KHN0YXJ0LCAwKS5zZXRDdXJzb3IoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnIgPSByYW5nZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdicicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5pbnNlcnROb2RlKGJyKS5zZXRTdGFydEFmdGVyKGJyKS5zZXRDdXJzb3IoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYnIgPSByYW5nZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdicicpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLmluc2VydE5vZGUoYnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBici5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQubGFzdENoaWxkID09PSBicikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBici5wYXJlbnROb2RlLmluc2VydEJlZm9yZShici5jbG9uZU5vZGUodHJ1ZSksIGJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnRCZWZvcmUoYnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0QWZ0ZXIoYnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRDdXJzb3IoKTtcclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59O1xyXG5cblxuLy8gcGx1Z2lucy9rZXlzdHJva2VzLmpzXG4vKiDlpITnkIbnibnmrorplK7nmoTlhbzlrrnmgKfpl67popggKi9cclxuVUUucGx1Z2luc1sna2V5c3Ryb2tlcyddID0gZnVuY3Rpb24oKSB7XHJcbiAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgdmFyIGNvbGxhcHNlZCA9IHRydWU7XHJcbiAgICBtZS5hZGRMaXN0ZW5lcigna2V5ZG93bicsIGZ1bmN0aW9uKHR5cGUsIGV2dCkge1xyXG4gICAgICAgIHZhciBrZXlDb2RlID0gZXZ0LmtleUNvZGUgfHwgZXZ0LndoaWNoLFxyXG4gICAgICAgICAgICBybmcgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuXHJcbiAgICAgICAgLy/lpITnkIblhajpgInnmoTmg4XlhrVcclxuICAgICAgICBpZighcm5nLmNvbGxhcHNlZCAmJiAhKGV2dC5jdHJsS2V5IHx8IGV2dC5zaGlmdEtleSB8fCBldnQuYWx0S2V5IHx8IGV2dC5tZXRhS2V5KSAmJiAoa2V5Q29kZSA+PSA2NSAmJiBrZXlDb2RlIDw9OTBcclxuICAgICAgICAgICAgfHwga2V5Q29kZSA+PSA0OCAmJiBrZXlDb2RlIDw9IDU3IHx8XHJcbiAgICAgICAgICAgIGtleUNvZGUgPj0gOTYgJiYga2V5Q29kZSA8PSAxMTEgfHwge1xyXG4gICAgICAgICAgICAgICAgICAgIDEzOjEsXHJcbiAgICAgICAgICAgICAgICAgICAgODoxLFxyXG4gICAgICAgICAgICAgICAgICAgIDQ2OjFcclxuICAgICAgICAgICAgICAgIH1ba2V5Q29kZV0pXHJcbiAgICAgICAgICAgICl7XHJcblxyXG4gICAgICAgICAgICB2YXIgdG1wTm9kZSA9IHJuZy5zdGFydENvbnRhaW5lcjtcclxuICAgICAgICAgICAgaWYoZG9tVXRpbHMuaXNGaWxsQ2hhcih0bXBOb2RlKSl7XHJcbiAgICAgICAgICAgICAgICBybmcuc2V0U3RhcnRCZWZvcmUodG1wTm9kZSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0bXBOb2RlID0gcm5nLmVuZENvbnRhaW5lcjtcclxuICAgICAgICAgICAgaWYoZG9tVXRpbHMuaXNGaWxsQ2hhcih0bXBOb2RlKSl7XHJcbiAgICAgICAgICAgICAgICBybmcuc2V0RW5kQWZ0ZXIodG1wTm9kZSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBybmcudHh0VG9FbG1Cb3VuZGFyeSgpO1xyXG4gICAgICAgICAgICAvL+e7k+adn+i+ueeVjOWPr+iDveaUvuWIsOS6hmJy55qE5YmN6L6577yM6KaB5oqKYnLljIXlkKvov5vmnaVcclxuICAgICAgICAgICAgLy8geFt4eHhdPGJyLz5cclxuICAgICAgICAgICAgaWYocm5nLmVuZENvbnRhaW5lciAmJiBybmcuZW5kQ29udGFpbmVyLm5vZGVUeXBlID09IDEpe1xyXG4gICAgICAgICAgICAgICAgdG1wTm9kZSA9IHJuZy5lbmRDb250YWluZXIuY2hpbGROb2Rlc1tybmcuZW5kT2Zmc2V0XTtcclxuICAgICAgICAgICAgICAgIGlmKHRtcE5vZGUgJiYgZG9tVXRpbHMuaXNCcih0bXBOb2RlKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgcm5nLnNldEVuZEFmdGVyKHRtcE5vZGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmKHJuZy5zdGFydE9mZnNldCA9PSAwKXtcclxuICAgICAgICAgICAgICAgIHRtcE5vZGUgPSBybmcuc3RhcnRDb250YWluZXI7XHJcbiAgICAgICAgICAgICAgICBpZihkb21VdGlscy5pc0JvdW5kYXJ5Tm9kZSh0bXBOb2RlLCdmaXJzdENoaWxkJykgKXtcclxuICAgICAgICAgICAgICAgICAgICB0bXBOb2RlID0gcm5nLmVuZENvbnRhaW5lcjtcclxuICAgICAgICAgICAgICAgICAgICBpZihybmcuZW5kT2Zmc2V0ID09ICh0bXBOb2RlLm5vZGVUeXBlID09IDMgPyB0bXBOb2RlLm5vZGVWYWx1ZS5sZW5ndGggOiB0bXBOb2RlLmNoaWxkTm9kZXMubGVuZ3RoKSAmJiBkb21VdGlscy5pc0JvdW5kYXJ5Tm9kZSh0bXBOb2RlLCdsYXN0Q2hpbGQnKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnc2F2ZVNjZW5lJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmJvZHkuaW5uZXJIVE1MID0gJzxwPicrKGJyb3dzZXIuaWUgPyAnJyA6ICc8YnIvPicpKyc8L3A+JztcclxuICAgICAgICAgICAgICAgICAgICAgICAgcm5nLnNldFN0YXJ0KG1lLmJvZHkuZmlyc3RDaGlsZCwwKS5zZXRDdXJzb3IoZmFsc2UsdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLl9zZWxlY3Rpb25DaGFuZ2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy/lpITnkIZiYWNrc3BhY2VcclxuICAgICAgICBpZiAoa2V5Q29kZSA9PSBrZXltYXAuQmFja3NwYWNlKSB7XHJcbiAgICAgICAgICAgIHJuZyA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xyXG4gICAgICAgICAgICBjb2xsYXBzZWQgPSBybmcuY29sbGFwc2VkO1xyXG4gICAgICAgICAgICBpZihtZS5maXJlRXZlbnQoJ2RlbGtleWRvd24nLGV2dCkpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBzdGFydCxlbmQ7XHJcbiAgICAgICAgICAgIC8v6YG/5YWN5oyJ5Lik5qyh5Yig6Zmk5omN6IO955Sf5pWI55qE6Zeu6aKYXHJcbiAgICAgICAgICAgIGlmKHJuZy5jb2xsYXBzZWQgJiYgcm5nLmluRmlsbENoYXIoKSl7XHJcbiAgICAgICAgICAgICAgICBzdGFydCA9IHJuZy5zdGFydENvbnRhaW5lcjtcclxuXHJcbiAgICAgICAgICAgICAgICBpZihkb21VdGlscy5pc0ZpbGxDaGFyKHN0YXJ0KSl7XHJcbiAgICAgICAgICAgICAgICAgICAgcm5nLnNldFN0YXJ0QmVmb3JlKHN0YXJ0KS5zaHJpbmtCb3VuZGFyeSh0cnVlKS5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoc3RhcnQpXHJcbiAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICBzdGFydC5ub2RlVmFsdWUgPSBzdGFydC5ub2RlVmFsdWUucmVwbGFjZShuZXcgUmVnRXhwKCdeJyArIGRvbVV0aWxzLmZpbGxDaGFyICksJycpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJuZy5zdGFydE9mZnNldC0tO1xyXG4gICAgICAgICAgICAgICAgICAgIHJuZy5jb2xsYXBzZSh0cnVlKS5zZWxlY3QodHJ1ZSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy/op6PlhrPpgInkuK1jb250cm9s5YWD57Sg5LiN6IO95Yig6Zmk55qE6Zeu6aKYXHJcbiAgICAgICAgICAgIGlmIChzdGFydCA9IHJuZy5nZXRDbG9zZWROb2RlKCkpIHtcclxuICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnc2F2ZVNjZW5lJyk7XHJcbiAgICAgICAgICAgICAgICBybmcuc2V0U3RhcnRCZWZvcmUoc3RhcnQpO1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHN0YXJ0KTtcclxuICAgICAgICAgICAgICAgIHJuZy5zZXRDdXJzb3IoKTtcclxuICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnc2F2ZVNjZW5lJyk7XHJcbiAgICAgICAgICAgICAgICBkb21VdGlscy5wcmV2ZW50RGVmYXVsdChldnQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8v6Zi75q2i5ZyodGFibGXkuIrnmoTliKDpmaRcclxuICAgICAgICAgICAgaWYgKCFicm93c2VyLmllKSB7XHJcbiAgICAgICAgICAgICAgICBzdGFydCA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocm5nLnN0YXJ0Q29udGFpbmVyLCAndGFibGUnLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgIGVuZCA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocm5nLmVuZENvbnRhaW5lciwgJ3RhYmxlJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3RhcnQgJiYgIWVuZCB8fCAhc3RhcnQgJiYgZW5kIHx8IHN0YXJ0ICE9PSBlbmQpIHtcclxuICAgICAgICAgICAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8v5aSE55CGdGFi6ZSu55qE6YC76L6RXHJcbiAgICAgICAgaWYgKGtleUNvZGUgPT0ga2V5bWFwLlRhYikge1xyXG4gICAgICAgICAgICAvL+S4jeWkhOeQhuS7peS4i+agh+etvlxyXG4gICAgICAgICAgICB2YXIgZXhjbHVkZVRhZ05hbWVGb3JUYWJLZXkgPSB7XHJcbiAgICAgICAgICAgICAgICAnb2wnIDogMSxcclxuICAgICAgICAgICAgICAgICd1bCcgOiAxLFxyXG4gICAgICAgICAgICAgICAgJ3RhYmxlJzoxXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIC8v5aSE55CG57uE5Lu26YeM55qEdGFi5oyJ5LiL5LqL5Lu2XHJcbiAgICAgICAgICAgIGlmKG1lLmZpcmVFdmVudCgndGFia2V5ZG93bicsZXZ0KSl7XHJcbiAgICAgICAgICAgICAgICBkb21VdGlscy5wcmV2ZW50RGVmYXVsdChldnQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciByYW5nZSA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xyXG4gICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NhdmVTY2VuZScpO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCx0eHQgPSAnJyx0YWJTaXplID0gbWUub3B0aW9ucy50YWJTaXplfHwgNCx0YWJOb2RlID0gIG1lLm9wdGlvbnMudGFiTm9kZSB8fCAnJm5ic3A7JzsgaSA8IHRhYlNpemU7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgdHh0ICs9IHRhYk5vZGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHNwYW4gPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XHJcbiAgICAgICAgICAgIHNwYW4uaW5uZXJIVE1MID0gdHh0ICsgZG9tVXRpbHMuZmlsbENoYXI7XHJcbiAgICAgICAgICAgIGlmIChyYW5nZS5jb2xsYXBzZWQpIHtcclxuICAgICAgICAgICAgICAgIHJhbmdlLmluc2VydE5vZGUoc3Bhbi5jbG9uZU5vZGUodHJ1ZSkuZmlyc3RDaGlsZCkuc2V0Q3Vyc29yKHRydWUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIGZpbHRlckZuID0gZnVuY3Rpb24obm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkb21VdGlscy5pc0Jsb2NrRWxtKG5vZGUpICYmICFleGNsdWRlVGFnTmFtZUZvclRhYktleVtub2RlLnRhZ05hbWUudG9Mb3dlckNhc2UoKV1cclxuXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgLy/mma7pgJrnmoTmg4XlhrVcclxuICAgICAgICAgICAgICAgIHN0YXJ0ID0gZG9tVXRpbHMuZmluZFBhcmVudChyYW5nZS5zdGFydENvbnRhaW5lciwgZmlsdGVyRm4sdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBlbmQgPSBkb21VdGlscy5maW5kUGFyZW50KHJhbmdlLmVuZENvbnRhaW5lciwgZmlsdGVyRm4sdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3RhcnQgJiYgZW5kICYmIHN0YXJ0ID09PSBlbmQpIHtcclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5kZWxldGVDb250ZW50cygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLmluc2VydE5vZGUoc3Bhbi5jbG9uZU5vZGUodHJ1ZSkuZmlyc3RDaGlsZCkuc2V0Q3Vyc29yKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYm9va21hcmsgPSByYW5nZS5jcmVhdGVCb29rbWFyaygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLmVubGFyZ2UodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJvb2ttYXJrMiA9IHJhbmdlLmNyZWF0ZUJvb2ttYXJrKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBkb21VdGlscy5nZXROZXh0RG9tTm9kZShib29rbWFyazIuc3RhcnQsIGZhbHNlLCBmaWx0ZXJGbik7XHJcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQgJiYgIShkb21VdGlscy5nZXRQb3NpdGlvbihjdXJyZW50LCBib29rbWFyazIuZW5kKSAmIGRvbVV0aWxzLlBPU0lUSU9OX0ZPTExPV0lORykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudC5pbnNlcnRCZWZvcmUoc3Bhbi5jbG9uZU5vZGUodHJ1ZSkuZmlyc3RDaGlsZCwgY3VycmVudC5maXJzdENoaWxkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGRvbVV0aWxzLmdldE5leHREb21Ob2RlKGN1cnJlbnQsIGZhbHNlLCBmaWx0ZXJGbik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLm1vdmVUb0Jvb2ttYXJrKGJvb2ttYXJrMikubW92ZVRvQm9va21hcmsoYm9va21hcmspLnNlbGVjdCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLnByZXZlbnREZWZhdWx0KGV2dClcclxuICAgICAgICB9XHJcbiAgICAgICAgLy90cmFjZToxNjM0XHJcbiAgICAgICAgLy9mZueahGRlbOmUruWcqOWuueWZqOepuueahOaXtuWAme+8jOS5n+S8muWIoOmZpFxyXG4gICAgICAgIGlmKGJyb3dzZXIuZ2Vja28gJiYga2V5Q29kZSA9PSA0Nil7XHJcbiAgICAgICAgICAgIHJhbmdlID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgIGlmKHJhbmdlLmNvbGxhcHNlZCl7XHJcbiAgICAgICAgICAgICAgICBzdGFydCA9IHJhbmdlLnN0YXJ0Q29udGFpbmVyO1xyXG4gICAgICAgICAgICAgICAgaWYoZG9tVXRpbHMuaXNFbXB0eUJsb2NrKHN0YXJ0KSl7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IHN0YXJ0LnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUoZG9tVXRpbHMuZ2V0Q2hpbGRDb3VudChwYXJlbnQpID09IDEgJiYgIWRvbVV0aWxzLmlzQm9keShwYXJlbnQpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBwYXJlbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZihzdGFydCA9PT0gcGFyZW50Lmxhc3RDaGlsZClcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBtZS5hZGRMaXN0ZW5lcigna2V5dXAnLCBmdW5jdGlvbih0eXBlLCBldnQpIHtcclxuICAgICAgICB2YXIga2V5Q29kZSA9IGV2dC5rZXlDb2RlIHx8IGV2dC53aGljaCxcclxuICAgICAgICAgICAgcm5nLG1lID0gdGhpcztcclxuICAgICAgICBpZihrZXlDb2RlID09IGtleW1hcC5CYWNrc3BhY2Upe1xyXG4gICAgICAgICAgICBpZihtZS5maXJlRXZlbnQoJ2RlbGtleXVwJykpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJuZyA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xyXG4gICAgICAgICAgICBpZihybmcuY29sbGFwc2VkKXtcclxuICAgICAgICAgICAgICAgIHZhciB0bXBOb2RlLFxyXG4gICAgICAgICAgICAgICAgICAgIGF1dG9DbGVhclRhZ05hbWUgPSBbJ2gxJywnaDInLCdoMycsJ2g0JywnaDUnLCdoNiddO1xyXG4gICAgICAgICAgICAgICAgaWYodG1wTm9kZSA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocm5nLnN0YXJ0Q29udGFpbmVyLGF1dG9DbGVhclRhZ05hbWUsdHJ1ZSkpe1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGRvbVV0aWxzLmlzRW1wdHlCbG9jayh0bXBOb2RlKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmUgPSB0bXBOb2RlLnByZXZpb3VzU2libGluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYocHJlICYmIHByZS5ub2RlTmFtZSAhPSAnVEFCTEUnKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZSh0bXBOb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJuZy5zZXRTdGFydEF0TGFzdChwcmUpLnNldEN1cnNvcihmYWxzZSx0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHRtcE5vZGUubmV4dFNpYmxpbmc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihuZXh0ICYmIG5leHQubm9kZU5hbWUgIT0gJ1RBQkxFJyl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHRtcE5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJuZy5zZXRTdGFydEF0Rmlyc3QobmV4dCkuc2V0Q3Vyc29yKGZhbHNlLHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8v5aSE55CG5b2T5Yig6Zmk5YiwYm9keeaXtu+8jOimgemHjeaWsOe7mXDmoIfnrb7lsZXkvY1cclxuICAgICAgICAgICAgICAgIGlmKGRvbVV0aWxzLmlzQm9keShybmcuc3RhcnRDb250YWluZXIpKXtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgdG1wTm9kZSA9IGRvbVV0aWxzLmNyZWF0ZUVsZW1lbnQobWUuZG9jdW1lbnQsJ3AnLHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJ2lubmVySFRNTCcgOiBicm93c2VyLmllID8gZG9tVXRpbHMuZmlsbENoYXIgOiAnPGJyLz4nXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcm5nLmluc2VydE5vZGUodG1wTm9kZSkuc2V0U3RhcnQodG1wTm9kZSwwKS5zZXRDdXJzb3IoZmFsc2UsdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICAvL2Nocm9tZeS4i+WmguaenOWIoOmZpOS6hmlubGluZeagh+etvu+8jOa1j+iniOWZqOS8muacieiusOW/hu+8jOWcqOi+k+WFpeaWh+Wtl+i/mOaYr+S8muWll+S4iuWImuaJjeWIoOmZpOeahOagh+etvu+8jOaJgOS7pei/memHjOWGjemAieS4gOasoeWwseS4jeS8muS6hlxyXG4gICAgICAgICAgICBpZiggIWNvbGxhcHNlZCAmJiAocm5nLnN0YXJ0Q29udGFpbmVyLm5vZGVUeXBlID09IDMgfHwgcm5nLnN0YXJ0Q29udGFpbmVyLm5vZGVUeXBlID09IDEgJiYgZG9tVXRpbHMuaXNFbXB0eUJsb2NrKHJuZy5zdGFydENvbnRhaW5lcikpKXtcclxuICAgICAgICAgICAgICAgIGlmKGJyb3dzZXIuaWUpe1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzcGFuID0gcm5nLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcclxuICAgICAgICAgICAgICAgICAgICBybmcuaW5zZXJ0Tm9kZShzcGFuKS5zZXRTdGFydEJlZm9yZShzcGFuKS5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICBybmcuc2VsZWN0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHNwYW4pXHJcbiAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICBybmcuc2VsZWN0KClcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG5cclxuICAgIH0pXHJcbn07XG5cbi8vIHBsdWdpbnMvZml4aW1nY2xpY2suanNcbi8vL2ltcG9ydCBjb3JlXG4vLy9jb21tYW5kcyDkv67lpI1jaHJvbWXkuIvlm77niYfkuI3og73ngrnlh7vnmoTpl67popjvvIzlh7rnjrDlhavkuKrop5Llj6/mlLnlj5jlpKflsI9cbi8vL2NvbW1hbmRzTmFtZSAgRml4SW1nQ2xpY2tcbi8vL2NvbW1hbmRzVGl0bGUgIOS/ruWkjWNocm9tZeS4i+WbvueJh+S4jeiDveeCueWHu+eahOmXrumimO+8jOWHuueOsOWFq+S4quinkuWPr+aUueWPmOWkp+Wwj1xuLy/kv67lpI1jaHJvbWXkuIvlm77niYfkuI3og73ngrnlh7vnmoTpl67popjvvIzlh7rnjrDlhavkuKrop5Llj6/mlLnlj5jlpKflsI9cblxuVUUucGx1Z2luc1snZml4aW1nY2xpY2snXSA9IChmdW5jdGlvbiAoKSB7XG5cbiAgICB2YXIgZWxlbWVudFVwZGF0ZWQgPSBmYWxzZTtcbiAgICBmdW5jdGlvbiBTY2FsZSgpIHtcbiAgICAgICAgdGhpcy5lZGl0b3IgPSBudWxsO1xuICAgICAgICB0aGlzLnJlc2l6ZXIgPSBudWxsO1xuICAgICAgICB0aGlzLmNvdmVyID0gbnVsbDtcbiAgICAgICAgdGhpcy5kb2MgPSBkb2N1bWVudDtcbiAgICAgICAgdGhpcy5wcmVQb3MgPSB7eDogMCwgeTogMH07XG4gICAgICAgIHRoaXMuc3RhcnRQb3MgPSB7eDogMCwgeTogMH07XG4gICAgfVxuXG4gICAgKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIHJlY3QgPSBbXG4gICAgICAgICAgICAvL1tsZWZ0LCB0b3AsIHdpZHRoLCBoZWlnaHRdXG4gICAgICAgICAgICBbMCwgMCwgLTEsIC0xXSxcbiAgICAgICAgICAgIFswLCAwLCAwLCAtMV0sXG4gICAgICAgICAgICBbMCwgMCwgMSwgLTFdLFxuICAgICAgICAgICAgWzAsIDAsIC0xLCAwXSxcbiAgICAgICAgICAgIFswLCAwLCAxLCAwXSxcbiAgICAgICAgICAgIFswLCAwLCAtMSwgMV0sXG4gICAgICAgICAgICBbMCwgMCwgMCwgMV0sXG4gICAgICAgICAgICBbMCwgMCwgMSwgMV1cbiAgICAgICAgXTtcblxuICAgICAgICBTY2FsZS5wcm90b3R5cGUgPSB7XG4gICAgICAgICAgICBpbml0OiBmdW5jdGlvbiAoZWRpdG9yKSB7XG4gICAgICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcbiAgICAgICAgICAgICAgICBtZS5lZGl0b3IgPSBlZGl0b3I7XG4gICAgICAgICAgICAgICAgbWUuc3RhcnRQb3MgPSB0aGlzLnByZVBvcyA9IHt4OiAwLCB5OiAwfTtcbiAgICAgICAgICAgICAgICBtZS5kcmFnSWQgPSAtMTtcblxuICAgICAgICAgICAgICAgIHZhciBoYW5kcyA9IFtdLFxuICAgICAgICAgICAgICAgICAgICBjb3ZlciA9IG1lLmNvdmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksXG4gICAgICAgICAgICAgICAgICAgIHJlc2l6ZXIgPSBtZS5yZXNpemVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cbiAgICAgICAgICAgICAgICBjb3Zlci5pZCA9IG1lLmVkaXRvci51aS5pZCArICdfaW1hZ2VzY2FsZV9jb3Zlcic7XG4gICAgICAgICAgICAgICAgY292ZXIuc3R5bGUuY3NzVGV4dCA9ICdwb3NpdGlvbjphYnNvbHV0ZTtkaXNwbGF5Om5vbmU7ei1pbmRleDonICsgKG1lLmVkaXRvci5vcHRpb25zLnpJbmRleCkgKyAnO2ZpbHRlcjphbHBoYShvcGFjaXR5PTApOyBvcGFjaXR5OjA7YmFja2dyb3VuZDojQ0NDOyc7XG4gICAgICAgICAgICAgICAgZG9tVXRpbHMub24oY292ZXIsICdtb3VzZWRvd24gY2xpY2snLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIG1lLmhpZGUoKTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCA4OyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaGFuZHMucHVzaCgnPHNwYW4gY2xhc3M9XCJlZHVpLWVkaXRvci1pbWFnZXNjYWxlLWhhbmQnICsgaSArICdcIj48L3NwYW4+Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJlc2l6ZXIuaWQgPSBtZS5lZGl0b3IudWkuaWQgKyAnX2ltYWdlc2NhbGUnO1xuICAgICAgICAgICAgICAgIHJlc2l6ZXIuY2xhc3NOYW1lID0gJ2VkdWktZWRpdG9yLWltYWdlc2NhbGUnO1xuICAgICAgICAgICAgICAgIHJlc2l6ZXIuaW5uZXJIVE1MID0gaGFuZHMuam9pbignJyk7XG4gICAgICAgICAgICAgICAgcmVzaXplci5zdHlsZS5jc3NUZXh0ICs9ICc7ZGlzcGxheTpub25lO2JvcmRlcjoxcHggc29saWQgIzNiNzdmZjt6LWluZGV4OicgKyAobWUuZWRpdG9yLm9wdGlvbnMuekluZGV4KSArICc7JztcblxuICAgICAgICAgICAgICAgIG1lLmVkaXRvci51aS5nZXREb20oKS5hcHBlbmRDaGlsZChjb3Zlcik7XG4gICAgICAgICAgICAgICAgbWUuZWRpdG9yLnVpLmdldERvbSgpLmFwcGVuZENoaWxkKHJlc2l6ZXIpO1xuXG4gICAgICAgICAgICAgICAgbWUuaW5pdFN0eWxlKCk7XG4gICAgICAgICAgICAgICAgbWUuaW5pdEV2ZW50cygpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGluaXRTdHlsZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHV0aWxzLmNzc1J1bGUoJ2ltYWdlc2NhbGUnLCAnLmVkdWktZWRpdG9yLWltYWdlc2NhbGV7ZGlzcGxheTpub25lO3Bvc2l0aW9uOmFic29sdXRlO2JvcmRlcjoxcHggc29saWQgIzM4QjJDRTtjdXJzb3I6aGFuZDstd2Via2l0LWJveC1zaXppbmc6IGNvbnRlbnQtYm94Oy1tb3otYm94LXNpemluZzogY29udGVudC1ib3g7Ym94LXNpemluZzogY29udGVudC1ib3g7fScgK1xuICAgICAgICAgICAgICAgICAgICAnLmVkdWktZWRpdG9yLWltYWdlc2NhbGUgc3Bhbntwb3NpdGlvbjphYnNvbHV0ZTt3aWR0aDo2cHg7aGVpZ2h0OjZweDtvdmVyZmxvdzpoaWRkZW47Zm9udC1zaXplOjBweDtkaXNwbGF5OmJsb2NrO2JhY2tncm91bmQtY29sb3I6IzNDOUREMDt9J1xuICAgICAgICAgICAgICAgICAgICArICcuZWR1aS1lZGl0b3ItaW1hZ2VzY2FsZSAuZWR1aS1lZGl0b3ItaW1hZ2VzY2FsZS1oYW5kMHtjdXJzb3I6bnctcmVzaXplO3RvcDowO21hcmdpbi10b3A6LTRweDtsZWZ0OjA7bWFyZ2luLWxlZnQ6LTRweDt9J1xuICAgICAgICAgICAgICAgICAgICArICcuZWR1aS1lZGl0b3ItaW1hZ2VzY2FsZSAuZWR1aS1lZGl0b3ItaW1hZ2VzY2FsZS1oYW5kMXtjdXJzb3I6bi1yZXNpemU7dG9wOjA7bWFyZ2luLXRvcDotNHB4O2xlZnQ6NTAlO21hcmdpbi1sZWZ0Oi00cHg7fSdcbiAgICAgICAgICAgICAgICAgICAgKyAnLmVkdWktZWRpdG9yLWltYWdlc2NhbGUgLmVkdWktZWRpdG9yLWltYWdlc2NhbGUtaGFuZDJ7Y3Vyc29yOm5lLXJlc2l6ZTt0b3A6MDttYXJnaW4tdG9wOi00cHg7bGVmdDoxMDAlO21hcmdpbi1sZWZ0Oi0zcHg7fSdcbiAgICAgICAgICAgICAgICAgICAgKyAnLmVkdWktZWRpdG9yLWltYWdlc2NhbGUgLmVkdWktZWRpdG9yLWltYWdlc2NhbGUtaGFuZDN7Y3Vyc29yOnctcmVzaXplO3RvcDo1MCU7bWFyZ2luLXRvcDotNHB4O2xlZnQ6MDttYXJnaW4tbGVmdDotNHB4O30nXG4gICAgICAgICAgICAgICAgICAgICsgJy5lZHVpLWVkaXRvci1pbWFnZXNjYWxlIC5lZHVpLWVkaXRvci1pbWFnZXNjYWxlLWhhbmQ0e2N1cnNvcjplLXJlc2l6ZTt0b3A6NTAlO21hcmdpbi10b3A6LTRweDtsZWZ0OjEwMCU7bWFyZ2luLWxlZnQ6LTNweDt9J1xuICAgICAgICAgICAgICAgICAgICArICcuZWR1aS1lZGl0b3ItaW1hZ2VzY2FsZSAuZWR1aS1lZGl0b3ItaW1hZ2VzY2FsZS1oYW5kNXtjdXJzb3I6c3ctcmVzaXplO3RvcDoxMDAlO21hcmdpbi10b3A6LTNweDtsZWZ0OjA7bWFyZ2luLWxlZnQ6LTRweDt9J1xuICAgICAgICAgICAgICAgICAgICArICcuZWR1aS1lZGl0b3ItaW1hZ2VzY2FsZSAuZWR1aS1lZGl0b3ItaW1hZ2VzY2FsZS1oYW5kNntjdXJzb3I6cy1yZXNpemU7dG9wOjEwMCU7bWFyZ2luLXRvcDotM3B4O2xlZnQ6NTAlO21hcmdpbi1sZWZ0Oi00cHg7fSdcbiAgICAgICAgICAgICAgICAgICAgKyAnLmVkdWktZWRpdG9yLWltYWdlc2NhbGUgLmVkdWktZWRpdG9yLWltYWdlc2NhbGUtaGFuZDd7Y3Vyc29yOnNlLXJlc2l6ZTt0b3A6MTAwJTttYXJnaW4tdG9wOi0zcHg7bGVmdDoxMDAlO21hcmdpbi1sZWZ0Oi0zcHg7fScpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGluaXRFdmVudHM6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xuXG4gICAgICAgICAgICAgICAgbWUuc3RhcnRQb3MueCA9IG1lLnN0YXJ0UG9zLnkgPSAwO1xuICAgICAgICAgICAgICAgIG1lLmlzRHJhZ2luZyA9IGZhbHNlO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF9ldmVudEhhbmRsZXI6IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKGUudHlwZSkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlICdtb3VzZWRvd24nOlxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhhbmQgPSBlLnRhcmdldCB8fCBlLnNyY0VsZW1lbnQsIGhhbmQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFuZC5jbGFzc05hbWUuaW5kZXhPZignZWR1aS1lZGl0b3ItaW1hZ2VzY2FsZS1oYW5kJykgIT0gLTEgJiYgbWUuZHJhZ0lkID09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuZHJhZ0lkID0gaGFuZC5jbGFzc05hbWUuc2xpY2UoLTEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLnN0YXJ0UG9zLnggPSBtZS5wcmVQb3MueCA9IGUuY2xpZW50WDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5zdGFydFBvcy55ID0gbWUucHJlUG9zLnkgPSBlLmNsaWVudFk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMub24obWUuZG9jLCdtb3VzZW1vdmUnLCBtZS5wcm94eShtZS5fZXZlbnRIYW5kbGVyLCBtZSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ21vdXNlbW92ZSc6XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobWUuZHJhZ0lkICE9IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUudXBkYXRlQ29udGFpbmVyU3R5bGUobWUuZHJhZ0lkLCB7eDogZS5jbGllbnRYIC0gbWUucHJlUG9zLngsIHk6IGUuY2xpZW50WSAtIG1lLnByZVBvcy55fSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUucHJlUG9zLnggPSBlLmNsaWVudFg7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUucHJlUG9zLnkgPSBlLmNsaWVudFk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFVwZGF0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLnVwZGF0ZVRhcmdldEVsZW1lbnQoKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ21vdXNldXAnOlxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lLmRyYWdJZCAhPSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLnVwZGF0ZUNvbnRhaW5lclN0eWxlKG1lLmRyYWdJZCwge3g6IGUuY2xpZW50WCAtIG1lLnByZVBvcy54LCB5OiBlLmNsaWVudFkgLSBtZS5wcmVQb3MueX0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLnVwZGF0ZVRhcmdldEVsZW1lbnQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWUudGFyZ2V0LnBhcmVudE5vZGUpIG1lLmF0dGFjaFRvKG1lLnRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuZHJhZ0lkID0gLTE7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy51bihtZS5kb2MsJ21vdXNlbW92ZScsIG1lLnByb3h5KG1lLl9ldmVudEhhbmRsZXIsIG1lKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL+S/ruWkjeWPquaYr+eCueWHu+aMquWKqOeCue+8jOS9huayoeacieaUueWPmOWkp+Wwj++8jOS4jeW6lOivpeinpuWPkWNvbnRlbnRjaGFuZ2VcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGVsZW1lbnRVcGRhdGVkKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50VXBkYXRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLmVkaXRvci5maXJlRXZlbnQoJ2NvbnRlbnRjaGFuZ2UnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdXBkYXRlVGFyZ2V0RWxlbWVudDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgZG9tVXRpbHMuc2V0U3R5bGVzKG1lLnRhcmdldCwge1xuICAgICAgICAgICAgICAgICAgICAnd2lkdGgnOiBtZS5yZXNpemVyLnN0eWxlLndpZHRoLFxuICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JzogbWUucmVzaXplci5zdHlsZS5oZWlnaHRcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBtZS50YXJnZXQud2lkdGggPSBwYXJzZUludChtZS5yZXNpemVyLnN0eWxlLndpZHRoKTtcbiAgICAgICAgICAgICAgICBtZS50YXJnZXQuaGVpZ2h0ID0gcGFyc2VJbnQobWUucmVzaXplci5zdHlsZS5oZWlnaHQpO1xuICAgICAgICAgICAgICAgIG1lLmF0dGFjaFRvKG1lLnRhcmdldCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyU3R5bGU6IGZ1bmN0aW9uIChkaXIsIG9mZnNldCkge1xuICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXG4gICAgICAgICAgICAgICAgICAgIGRvbSA9IG1lLnJlc2l6ZXIsIHRtcDtcblxuICAgICAgICAgICAgICAgIGlmIChyZWN0W2Rpcl1bMF0gIT0gMCkge1xuICAgICAgICAgICAgICAgICAgICB0bXAgPSBwYXJzZUludChkb20uc3R5bGUubGVmdCkgKyBvZmZzZXQueDtcbiAgICAgICAgICAgICAgICAgICAgZG9tLnN0eWxlLmxlZnQgPSBtZS5fdmFsaWRTY2FsZWRQcm9wKCdsZWZ0JywgdG1wKSArICdweCc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChyZWN0W2Rpcl1bMV0gIT0gMCkge1xuICAgICAgICAgICAgICAgICAgICB0bXAgPSBwYXJzZUludChkb20uc3R5bGUudG9wKSArIG9mZnNldC55O1xuICAgICAgICAgICAgICAgICAgICBkb20uc3R5bGUudG9wID0gbWUuX3ZhbGlkU2NhbGVkUHJvcCgndG9wJywgdG1wKSArICdweCc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChyZWN0W2Rpcl1bMl0gIT0gMCkge1xuICAgICAgICAgICAgICAgICAgICB0bXAgPSBkb20uY2xpZW50V2lkdGggKyByZWN0W2Rpcl1bMl0gKiBvZmZzZXQueDtcbiAgICAgICAgICAgICAgICAgICAgZG9tLnN0eWxlLndpZHRoID0gbWUuX3ZhbGlkU2NhbGVkUHJvcCgnd2lkdGgnLCB0bXApICsgJ3B4JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHJlY3RbZGlyXVszXSAhPSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRtcCA9IGRvbS5jbGllbnRIZWlnaHQgKyByZWN0W2Rpcl1bM10gKiBvZmZzZXQueTtcbiAgICAgICAgICAgICAgICAgICAgZG9tLnN0eWxlLmhlaWdodCA9IG1lLl92YWxpZFNjYWxlZFByb3AoJ2hlaWdodCcsIHRtcCkgKyAncHgnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBfdmFsaWRTY2FsZWRQcm9wOiBmdW5jdGlvbiAocHJvcCwgdmFsdWUpIHtcbiAgICAgICAgICAgICAgICB2YXIgZWxlID0gdGhpcy5yZXNpemVyLFxuICAgICAgICAgICAgICAgICAgICB3cmFwID0gZG9jdW1lbnQ7XG5cbiAgICAgICAgICAgICAgICB2YWx1ZSA9IGlzTmFOKHZhbHVlKSA/IDAgOiB2YWx1ZTtcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKHByb3ApIHtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbGVmdCc6XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPCAwID8gMCA6ICh2YWx1ZSArIGVsZS5jbGllbnRXaWR0aCkgPiB3cmFwLmNsaWVudFdpZHRoID8gd3JhcC5jbGllbnRXaWR0aCAtIGVsZS5jbGllbnRXaWR0aCA6IHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICBjYXNlICd0b3AnOlxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlIDwgMCA/IDAgOiAodmFsdWUgKyBlbGUuY2xpZW50SGVpZ2h0KSA+IHdyYXAuY2xpZW50SGVpZ2h0ID8gd3JhcC5jbGllbnRIZWlnaHQgLSBlbGUuY2xpZW50SGVpZ2h0IDogdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3dpZHRoJzpcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA8PSAwID8gMSA6ICh2YWx1ZSArIGVsZS5vZmZzZXRMZWZ0KSA+IHdyYXAuY2xpZW50V2lkdGggPyB3cmFwLmNsaWVudFdpZHRoIC0gZWxlLm9mZnNldExlZnQgOiB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnaGVpZ2h0JzpcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA8PSAwID8gMSA6ICh2YWx1ZSArIGVsZS5vZmZzZXRUb3ApID4gd3JhcC5jbGllbnRIZWlnaHQgPyB3cmFwLmNsaWVudEhlaWdodCAtIGVsZS5vZmZzZXRUb3AgOiB2YWx1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaGlkZUNvdmVyOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb3Zlci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNob3dDb3ZlcjogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXG4gICAgICAgICAgICAgICAgICAgIGVkaXRvclBvcyA9IGRvbVV0aWxzLmdldFhZKG1lLmVkaXRvci51aS5nZXREb20oKSksXG4gICAgICAgICAgICAgICAgICAgIGlmcmFtZVBvcyA9IGRvbVV0aWxzLmdldFhZKG1lLmVkaXRvci5pZnJhbWUpO1xuXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMuc2V0U3R5bGVzKG1lLmNvdmVyLCB7XG4gICAgICAgICAgICAgICAgICAgICd3aWR0aCc6IG1lLmVkaXRvci5pZnJhbWUub2Zmc2V0V2lkdGggKyAncHgnLFxuICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JzogbWUuZWRpdG9yLmlmcmFtZS5vZmZzZXRIZWlnaHQgKyAncHgnLFxuICAgICAgICAgICAgICAgICAgICAndG9wJzogaWZyYW1lUG9zLnkgLSBlZGl0b3JQb3MueSArICdweCcsXG4gICAgICAgICAgICAgICAgICAgICdsZWZ0JzogaWZyYW1lUG9zLnggLSBlZGl0b3JQb3MueCArICdweCcsXG4gICAgICAgICAgICAgICAgICAgICdwb3NpdGlvbic6ICdhYnNvbHV0ZScsXG4gICAgICAgICAgICAgICAgICAgICdkaXNwbGF5JzogJydcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNob3c6IGZ1bmN0aW9uICh0YXJnZXRPYmopIHtcbiAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xuICAgICAgICAgICAgICAgIG1lLnJlc2l6ZXIuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XG4gICAgICAgICAgICAgICAgaWYodGFyZ2V0T2JqKSBtZS5hdHRhY2hUbyh0YXJnZXRPYmopO1xuXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMub24odGhpcy5yZXNpemVyLCAnbW91c2Vkb3duJywgbWUucHJveHkobWUuX2V2ZW50SGFuZGxlciwgbWUpKTtcbiAgICAgICAgICAgICAgICBkb21VdGlscy5vbihtZS5kb2MsICdtb3VzZXVwJywgbWUucHJveHkobWUuX2V2ZW50SGFuZGxlciwgbWUpKTtcblxuICAgICAgICAgICAgICAgIG1lLnNob3dDb3ZlcigpO1xuICAgICAgICAgICAgICAgIG1lLmVkaXRvci5maXJlRXZlbnQoJ2FmdGVyc2NhbGVzaG93JywgbWUpO1xuICAgICAgICAgICAgICAgIG1lLmVkaXRvci5maXJlRXZlbnQoJ3NhdmVTY2VuZScpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGhpZGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xuICAgICAgICAgICAgICAgIG1lLmhpZGVDb3ZlcigpO1xuICAgICAgICAgICAgICAgIG1lLnJlc2l6ZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJztcblxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnVuKG1lLnJlc2l6ZXIsICdtb3VzZWRvd24nLCBtZS5wcm94eShtZS5fZXZlbnRIYW5kbGVyLCBtZSkpO1xuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnVuKG1lLmRvYywgJ21vdXNldXAnLCBtZS5wcm94eShtZS5fZXZlbnRIYW5kbGVyLCBtZSkpO1xuICAgICAgICAgICAgICAgIG1lLmVkaXRvci5maXJlRXZlbnQoJ2FmdGVyc2NhbGVoaWRlJywgbWUpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHByb3h5OiBmdW5jdGlvbiggZm4sIGNvbnRleHQgKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KCBjb250ZXh0IHx8IHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBhdHRhY2hUbzogZnVuY3Rpb24gKHRhcmdldE9iaikge1xuICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldCA9IG1lLnRhcmdldCA9IHRhcmdldE9iaixcbiAgICAgICAgICAgICAgICAgICAgcmVzaXplciA9IHRoaXMucmVzaXplcixcbiAgICAgICAgICAgICAgICAgICAgaW1nUG9zID0gZG9tVXRpbHMuZ2V0WFkodGFyZ2V0KSxcbiAgICAgICAgICAgICAgICAgICAgaWZyYW1lUG9zID0gZG9tVXRpbHMuZ2V0WFkobWUuZWRpdG9yLmlmcmFtZSksXG4gICAgICAgICAgICAgICAgICAgIGVkaXRvclBvcyA9IGRvbVV0aWxzLmdldFhZKHJlc2l6ZXIucGFyZW50Tm9kZSk7XG5cbiAgICAgICAgICAgICAgICBkb21VdGlscy5zZXRTdHlsZXMocmVzaXplciwge1xuICAgICAgICAgICAgICAgICAgICAnd2lkdGgnOiB0YXJnZXQud2lkdGggKyAncHgnLFxuICAgICAgICAgICAgICAgICAgICAnaGVpZ2h0JzogdGFyZ2V0LmhlaWdodCArICdweCcsXG4gICAgICAgICAgICAgICAgICAgICdsZWZ0JzogaWZyYW1lUG9zLnggKyBpbWdQb3MueCAtIG1lLmVkaXRvci5kb2N1bWVudC5ib2R5LnNjcm9sbExlZnQgLSBlZGl0b3JQb3MueCAtIHBhcnNlSW50KHJlc2l6ZXIuc3R5bGUuYm9yZGVyTGVmdFdpZHRoKSArICdweCcsXG4gICAgICAgICAgICAgICAgICAgICd0b3AnOiBpZnJhbWVQb3MueSArIGltZ1Bvcy55IC0gbWUuZWRpdG9yLmRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wIC0gZWRpdG9yUG9zLnkgLSBwYXJzZUludChyZXNpemVyLnN0eWxlLmJvcmRlclRvcFdpZHRoKSArICdweCdcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pKCk7XG5cbiAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgbWUgPSB0aGlzLFxuICAgICAgICAgICAgaW1hZ2VTY2FsZTtcblxuICAgICAgICBtZS5zZXRPcHQoJ2ltYWdlU2NhbGVFbmFibGVkJywgdHJ1ZSk7XG5cbiAgICAgICAgaWYgKCAhYnJvd3Nlci5pZSAmJiBtZS5vcHRpb25zLmltYWdlU2NhbGVFbmFibGVkKSB7XG4gICAgICAgICAgICBtZS5hZGRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAodHlwZSwgZSkge1xuXG4gICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCksXG4gICAgICAgICAgICAgICAgICAgIGltZyA9IHJhbmdlLmdldENsb3NlZE5vZGUoKTtcblxuICAgICAgICAgICAgICAgIGlmIChpbWcgJiYgaW1nLnRhZ05hbWUgPT0gJ0lNRycgJiYgbWUuYm9keS5jb250ZW50RWRpdGFibGUhPVwiZmFsc2VcIikge1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChpbWcuY2xhc3NOYW1lLmluZGV4T2YoXCJlZHVpLWZha2VkLW11c2ljXCIpICE9IC0xIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICBpbWcuZ2V0QXR0cmlidXRlKFwiYW5jaG9ybmFtZVwiKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuaGFzQ2xhc3MoaW1nLCAnbG9hZGluZ2NsYXNzJykgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmhhc0NsYXNzKGltZywgJ2xvYWRlcnJvcmNsYXNzJykpIHsgcmV0dXJuIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoIWltYWdlU2NhbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlU2NhbGUgPSBuZXcgU2NhbGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlU2NhbGUuaW5pdChtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZS51aS5nZXREb20oKS5hcHBlbmRDaGlsZChpbWFnZVNjYWxlLnJlc2l6ZXIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2tleURvd25IYW5kbGVyID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWFnZVNjYWxlLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpbWFnZVNjYWxlLnRhcmdldCkgbWUuc2VsZWN0aW9uLmdldFJhbmdlKCkuc2VsZWN0Tm9kZShpbWFnZVNjYWxlLnRhcmdldCkuc2VsZWN0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9LCBfbW91c2VEb3duSGFuZGxlciA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVsZSA9IGUudGFyZ2V0IHx8IGUuc3JjRWxlbWVudDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlICYmIChlbGUuY2xhc3NOYW1lPT09dW5kZWZpbmVkIHx8IGVsZS5jbGFzc05hbWUuaW5kZXhPZignZWR1aS1lZGl0b3ItaW1hZ2VzY2FsZScpID09IC0xKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfa2V5RG93bkhhbmRsZXIoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSwgdGltZXI7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmFkZExpc3RlbmVyKCdhZnRlcnNjYWxlc2hvdycsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuYWRkTGlzdGVuZXIoJ2JlZm9yZWtleWRvd24nLCBfa2V5RG93bkhhbmRsZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLmFkZExpc3RlbmVyKCdiZWZvcmVtb3VzZWRvd24nLCBfbW91c2VEb3duSGFuZGxlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMub24oZG9jdW1lbnQsICdrZXlkb3duJywgX2tleURvd25IYW5kbGVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5vbihkb2N1bWVudCwnbW91c2Vkb3duJywgX21vdXNlRG93bkhhbmRsZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLnNlbGVjdGlvbi5nZXROYXRpdmUoKS5yZW1vdmVBbGxSYW5nZXMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgbWUuYWRkTGlzdGVuZXIoJ2FmdGVyc2NhbGVoaWRlJywgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5yZW1vdmVMaXN0ZW5lcignYmVmb3Jla2V5ZG93bicsIF9rZXlEb3duSGFuZGxlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUucmVtb3ZlTGlzdGVuZXIoJ2JlZm9yZW1vdXNlZG93bicsIF9tb3VzZURvd25IYW5kbGVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy51bihkb2N1bWVudCwgJ2tleWRvd24nLCBfa2V5RG93bkhhbmRsZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnVuKGRvY3VtZW50LCdtb3VzZWRvd24nLCBfbW91c2VEb3duSGFuZGxlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IGltYWdlU2NhbGUudGFyZ2V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQucGFyZW50Tm9kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKS5zZWxlY3ROb2RlKHRhcmdldCkuc2VsZWN0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL1RPRE8g5pyJaWZyYW1l55qE5oOF5Ya177yMbW91c2Vkb3du5LiN6IO95b6A5LiL5Lyg44CC44CCXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5vbihpbWFnZVNjYWxlLnJlc2l6ZXIsICdtb3VzZWRvd24nLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLnNlbGVjdGlvbi5nZXROYXRpdmUoKS5yZW1vdmVBbGxSYW5nZXMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZWxlID0gZS50YXJnZXQgfHwgZS5zcmNFbGVtZW50O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbGUgJiYgZWxlLmNsYXNzTmFtZS5pbmRleE9mKCdlZHVpLWVkaXRvci1pbWFnZXNjYWxlLWhhbmQnKSA9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VTY2FsZS5oaWRlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpbWFnZVNjYWxlLnRhcmdldCkgbWUuc2VsZWN0aW9uLmdldFJhbmdlKCkuc2VsZWN0Tm9kZShlbGUpLnNlbGVjdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAyMDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMub24oaW1hZ2VTY2FsZS5yZXNpemVyLCAnbW91c2V1cCcsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVsZSA9IGUudGFyZ2V0IHx8IGUuc3JjRWxlbWVudDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxlICYmIGVsZS5jbGFzc05hbWUuaW5kZXhPZignZWR1aS1lZGl0b3ItaW1hZ2VzY2FsZS1oYW5kJykgPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpbWFnZVNjYWxlLnNob3coaW1nKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW1hZ2VTY2FsZSAmJiBpbWFnZVNjYWxlLnJlc2l6ZXIuc3R5bGUuZGlzcGxheSAhPSAnbm9uZScpIGltYWdlU2NhbGUuaGlkZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGJyb3dzZXIud2Via2l0KSB7XG4gICAgICAgICAgICBtZS5hZGRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAodHlwZSwgZSkge1xuICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC50YWdOYW1lID09ICdJTUcnICYmIG1lLmJvZHkuY29udGVudEVkaXRhYmxlIT1cImZhbHNlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gbmV3IGRvbS5SYW5nZShtZS5kb2N1bWVudCk7XG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLnNlbGVjdE5vZGUoZS50YXJnZXQpLnNlbGVjdCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxufSkoKTtcblxuLy8gcGx1Z2lucy9hdXRvbGluay5qc1xuLy8vaW1wb3J0IGNvcmVcclxuLy8vY29tbWFuZHMg5Li66Z2eaWXmtY/op4jlmajoh6rliqjmt7vliqBh5qCH562+XHJcbi8vL2NvbW1hbmRzTmFtZSAgQXV0b0xpbmtcclxuLy8vY29tbWFuZHNUaXRsZSAg6Ieq5Yqo5aKe5Yqg6ZO+5o6lXHJcbi8qKlxyXG4gKiBAZGVzY3JpcHRpb24g5Li66Z2eaWXmtY/op4jlmajoh6rliqjmt7vliqBh5qCH562+XHJcbiAqIEBhdXRob3IgemhhbnlpXHJcbiAqL1xyXG5cclxuVUUucGx1Z2luLnJlZ2lzdGVyKCdhdXRvbGluaycsZnVuY3Rpb24oKXtcclxuICAgIHZhciBjb250ID0gMDtcclxuXHJcbiAgICByZXR1cm4gIWJyb3dzZXIuaWUgPyB7XHJcblxyXG4gICAgICAgICAgICBiaW5kRXZlbnRzOntcclxuICAgICAgICAgICAgICAgICdyZXNldCcgOiBmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICdrZXlkb3duJzpmdW5jdGlvbih0eXBlLCBldnQpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBrZXlDb2RlID0gZXZ0LmtleUNvZGUgfHwgZXZ0LndoaWNoO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoa2V5Q29kZSA9PSAzMiB8fCBrZXlDb2RlID09IDEzKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2VsID0gbWUuc2VsZWN0aW9uLmdldE5hdGl2ZSgpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UgPSBzZWwuZ2V0UmFuZ2VBdCgwKS5jbG9uZVJhbmdlKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFyQ29kZTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IHJhbmdlLnN0YXJ0Q29udGFpbmVyO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoc3RhcnQubm9kZVR5cGUgPT0gMSAmJiByYW5nZS5zdGFydE9mZnNldCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gcmFuZ2Uuc3RhcnRDb250YWluZXIuY2hpbGROb2Rlc1tyYW5nZS5zdGFydE9mZnNldCAtIDFdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdGFydCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydChzdGFydCwgc3RhcnQubm9kZVR5cGUgPT0gMSA/IHN0YXJ0LmNoaWxkTm9kZXMubGVuZ3RoIDogc3RhcnQubm9kZVZhbHVlLmxlbmd0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5jb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gcmFuZ2Uuc3RhcnRDb250YWluZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRve1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJhbmdlLnN0YXJ0T2Zmc2V0ID09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHJhbmdlLnN0YXJ0Q29udGFpbmVyLnByZXZpb3VzU2libGluZztcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHN0YXJ0ICYmIHN0YXJ0Lm5vZGVUeXBlID09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBzdGFydC5sYXN0Q2hpbGQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RhcnQgfHwgZG9tVXRpbHMuaXNGaWxsQ2hhcihzdGFydCkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ID0gc3RhcnQubm9kZVZhbHVlLmxlbmd0aDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSByYW5nZS5zdGFydENvbnRhaW5lcjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXQgPSByYW5nZS5zdGFydE9mZnNldDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KHN0YXJ0LCBvZmZzZXQgLSAxKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYXJDb2RlID0gcmFuZ2UudG9TdHJpbmcoKS5jaGFyQ29kZUF0KDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChjaGFyQ29kZSAhPSAxNjAgJiYgY2hhckNvZGUgIT0gMzIpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJhbmdlLnRvU3RyaW5nKCkucmVwbGFjZShuZXcgUmVnRXhwKGRvbVV0aWxzLmZpbGxDaGFyLCAnZycpLCAnJykubWF0Y2goLyg/Omh0dHBzPzpcXC9cXC98c3NoOlxcL1xcL3xmdHA6XFwvXFwvfGZpbGU6XFwvfHd3d1xcLikvaSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKHJhbmdlLnRvU3RyaW5nKCkubGVuZ3RoKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZigvXig/Omh0dHBzPzpcXC9cXC98c3NoOlxcL1xcL3xmdHA6XFwvXFwvfGZpbGU6XFwvfHd3d1xcLikvaS50ZXN0KHJhbmdlLnRvU3RyaW5nKCkpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQocmFuZ2Uuc3RhcnRDb250YWluZXIscmFuZ2Uuc3RhcnRPZmZzZXQrMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGUpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3RyYWNlOjIxMjFcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0ID0gcmFuZ2Uuc3RhcnRDb250YWluZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKCEobmV4dCA9IHN0YXJ0Lm5leHRTaWJsaW5nKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihkb21VdGlscy5pc0JvZHkoc3RhcnQpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHN0YXJ0LnBhcmVudE5vZGU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KG5leHQsMCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3Jhbmdl55qE5byA5aeL6L6555WM5bey57uP5ZyoYeagh+etvumHjOeahOS4jeWGjeWkhOeQhlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShyYW5nZS5zdGFydENvbnRhaW5lciwnYScsdHJ1ZSkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhID0gbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpLHRleHQgPSBtZS5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnICcpLGhyZWY7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUudW5kb01hbmdlciAmJiBtZS51bmRvTWFuZ2VyLnNhdmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEuYXBwZW5kQ2hpbGQocmFuZ2UuZXh0cmFjdENvbnRlbnRzKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5ocmVmID0gYS5pbm5lckhUTUwgPSBhLmlubmVySFRNTC5yZXBsYWNlKC88W14+XSs+L2csJycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaHJlZiA9IGEuZ2V0QXR0cmlidXRlKFwiaHJlZlwiKS5yZXBsYWNlKG5ldyBSZWdFeHAoZG9tVXRpbHMuZmlsbENoYXIsJ2cnKSwnJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBocmVmID0gL14oPzpodHRwcz86XFwvXFwvKS9pZy50ZXN0KGhyZWYpID8gaHJlZiA6IFwiaHR0cDovL1wiKyBocmVmO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5zZXRBdHRyaWJ1dGUoJ19zcmMnLHV0aWxzLmh0bWwoaHJlZikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5ocmVmID0gdXRpbHMuaHRtbChocmVmKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5pbnNlcnROb2RlKGEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0ZXh0LCBhLm5leHRTaWJsaW5nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KHRleHQsIDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWwucmVtb3ZlQWxsUmFuZ2VzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWwuYWRkUmFuZ2UocmFuZ2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUudW5kb01hbmdlciAmJiBtZS51bmRvTWFuZ2VyLnNhdmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH06e31cclxuICAgIH0sZnVuY3Rpb24oKXtcclxuICAgICAgICB2YXIga2V5Q29kZXMgPSB7XHJcbiAgICAgICAgICAgIDM3OjEsIDM4OjEsIDM5OjEsIDQwOjEsXHJcbiAgICAgICAgICAgIDEzOjEsMzI6MVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgZnVuY3Rpb24gY2hlY2tJc0NsdWRlTGluayhub2RlKXtcclxuICAgICAgICAgICAgaWYobm9kZS5ub2RlVHlwZSA9PSAzKXtcclxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYobm9kZS5ub2RlTmFtZSA9PSAnQScpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGxhc3RDaGlsZCA9IG5vZGUubGFzdENoaWxkO1xyXG5cclxuICAgICAgICAgICAgd2hpbGUobGFzdENoaWxkKXtcclxuICAgICAgICAgICAgICAgIGlmKGxhc3RDaGlsZC5ub2RlTmFtZSA9PSAnQScpe1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBsYXN0Q2hpbGQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZihsYXN0Q2hpbGQubm9kZVR5cGUgPT0gMyl7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoZG9tVXRpbHMuaXNXaGl0ZXNwYWNlKGxhc3RDaGlsZCkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0Q2hpbGQgPSBsYXN0Q2hpbGQucHJldmlvdXNTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGxcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGxhc3RDaGlsZCA9IGxhc3RDaGlsZC5sYXN0Q2hpbGQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgYnJvd3Nlci5pZSAmJiB0aGlzLmFkZExpc3RlbmVyKCdrZXl1cCcsZnVuY3Rpb24oY21kLGV2dCl7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsa2V5Q29kZSA9IGV2dC5rZXlDb2RlO1xyXG4gICAgICAgICAgICBpZihrZXlDb2Rlc1trZXlDb2RlXSl7XHJcbiAgICAgICAgICAgICAgICB2YXIgcm5nID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgc3RhcnQgPSBybmcuc3RhcnRDb250YWluZXI7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYoa2V5Q29kZSA9PSAxMyl7XHJcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUoc3RhcnQgJiYgIWRvbVV0aWxzLmlzQm9keShzdGFydCkgJiYgIWRvbVV0aWxzLmlzQmxvY2tFbG0oc3RhcnQpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBzdGFydC5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZihzdGFydCAmJiAhZG9tVXRpbHMuaXNCb2R5KHN0YXJ0KSAmJiBzdGFydC5ub2RlTmFtZSA9PSAnUCcpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJlID0gc3RhcnQucHJldmlvdXNTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihwcmUgJiYgcHJlLm5vZGVUeXBlID09IDEpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByZSA9IGNoZWNrSXNDbHVkZUxpbmsocHJlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHByZSAmJiAhcHJlLmdldEF0dHJpYnV0ZSgnX2hyZWYnKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHByZSx0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1lbHNlIGlmKGtleUNvZGUgPT0gMzIgKXtcclxuICAgICAgICAgICAgICAgICAgICBpZihzdGFydC5ub2RlVHlwZSA9PSAzICYmIC9eXFxzJC8udGVzdChzdGFydC5ub2RlVmFsdWUpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBzdGFydC5wcmV2aW91c1NpYmxpbmc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHN0YXJ0ICYmIHN0YXJ0Lm5vZGVOYW1lID09ICdBJyAmJiAhc3RhcnQuZ2V0QXR0cmlidXRlKCdfaHJlZicpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShzdGFydCx0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1lbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBzdGFydCA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUoc3RhcnQsJ2EnLHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKHN0YXJ0ICYmICFzdGFydC5nZXRBdHRyaWJ1dGUoJ19ocmVmJykpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmsgPSBybmcuY3JlYXRlQm9va21hcmsoKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShzdGFydCx0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcm5nLm1vdmVUb0Jvb2ttYXJrKGJrKS5zZWxlY3QodHJ1ZSlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuKTtcblxuLy8gcGx1Z2lucy9hdXRvaGVpZ2h0LmpzXG4vLy9pbXBvcnQgY29yZVxyXG4vLy9jb21tYW5kcyDlvZPovpPlhaXlhoXlrrnotoXov4fnvJbovpHlmajpq5jluqbml7bvvIznvJbovpHlmajoh6rliqjlop7pq5hcclxuLy8vY29tbWFuZHNOYW1lICBBdXRvSGVpZ2h0LGF1dG9IZWlnaHRFbmFibGVkXHJcbi8vL2NvbW1hbmRzVGl0bGUgIOiHquWKqOWinumrmFxyXG4vKipcclxuICogQGRlc2NyaXB0aW9uIOiHquWKqOS8uOWxlVxyXG4gKiBAYXV0aG9yIHpoYW55aVxyXG4gKi9cclxuVUUucGx1Z2luc1snYXV0b2hlaWdodCddID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIG1lID0gdGhpcztcclxuICAgIC8v5o+Q5L6b5byA5YWz77yM5bCx566X5Yqg6L295Lmf5Y+v5Lul5YWz6ZetXHJcbiAgICBtZS5hdXRvSGVpZ2h0RW5hYmxlZCA9IG1lLm9wdGlvbnMuYXV0b0hlaWdodEVuYWJsZWQgIT09IGZhbHNlO1xyXG4gICAgaWYgKCFtZS5hdXRvSGVpZ2h0RW5hYmxlZCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB2YXIgYmFrT3ZlcmZsb3csXHJcbiAgICAgICAgbGFzdEhlaWdodCA9IDAsXHJcbiAgICAgICAgb3B0aW9ucyA9IG1lLm9wdGlvbnMsXHJcbiAgICAgICAgY3VycmVudEhlaWdodCxcclxuICAgICAgICB0aW1lcjtcclxuXHJcbiAgICBmdW5jdGlvbiBhZGp1c3RIZWlnaHQoKSB7XHJcbiAgICAgICAgdmFyIG1lID0gdGhpcztcclxuICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xyXG4gICAgICAgIGlmKGlzRnVsbHNjcmVlbilyZXR1cm47XHJcbiAgICAgICAgaWYgKCFtZS5xdWVyeUNvbW1hbmRTdGF0ZSB8fCBtZS5xdWVyeUNvbW1hbmRTdGF0ZSAmJiBtZS5xdWVyeUNvbW1hbmRTdGF0ZSgnc291cmNlJykgIT0gMSkge1xyXG4gICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IG1lLmJvZHkubGFzdENoaWxkO1xyXG4gICAgICAgICAgICAgICAgd2hpbGUobm9kZSAmJiBub2RlLm5vZGVUeXBlICE9IDEpe1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmKG5vZGUgJiYgbm9kZS5ub2RlVHlwZSA9PSAxKXtcclxuICAgICAgICAgICAgICAgICAgICBub2RlLnN0eWxlLmNsZWFyID0gJ2JvdGgnO1xyXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRIZWlnaHQgPSBNYXRoLm1heChkb21VdGlscy5nZXRYWShub2RlKS55ICsgbm9kZS5vZmZzZXRIZWlnaHQgKyAyNSAsTWF0aC5tYXgob3B0aW9ucy5taW5GcmFtZUhlaWdodCwgb3B0aW9ucy5pbml0aWFsRnJhbWVIZWlnaHQpKSA7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRIZWlnaHQgIT0gbGFzdEhlaWdodCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudEhlaWdodCAhPT0gcGFyc2VJbnQobWUuaWZyYW1lLnBhcmVudE5vZGUuc3R5bGUuaGVpZ2h0KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuaWZyYW1lLnBhcmVudE5vZGUuc3R5bGUuaGVpZ2h0ID0gY3VycmVudEhlaWdodCArICdweCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuYm9keS5zdHlsZS5oZWlnaHQgPSBjdXJyZW50SGVpZ2h0ICsgJ3B4JztcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEhlaWdodCA9IGN1cnJlbnRIZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZVN0eWxlKG5vZGUsJ2NsZWFyJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgfSw1MClcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICB2YXIgaXNGdWxsc2NyZWVuO1xyXG4gICAgbWUuYWRkTGlzdGVuZXIoJ2Z1bGxzY3JlZW5jaGFuZ2VkJyxmdW5jdGlvbihjbWQsZil7XHJcbiAgICAgICAgaXNGdWxsc2NyZWVuID0gZlxyXG4gICAgfSk7XHJcbiAgICBtZS5hZGRMaXN0ZW5lcignZGVzdHJveScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBtZS5yZW1vdmVMaXN0ZW5lcignY29udGVudGNoYW5nZSBhZnRlcmluc2VydGh0bWwga2V5dXAgbW91c2V1cCcsYWRqdXN0SGVpZ2h0KVxyXG4gICAgfSk7XHJcbiAgICBtZS5lbmFibGVBdXRvSGVpZ2h0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICAgICAgaWYgKCFtZS5hdXRvSGVpZ2h0RW5hYmxlZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBkb2MgPSBtZS5kb2N1bWVudDtcclxuICAgICAgICBtZS5hdXRvSGVpZ2h0RW5hYmxlZCA9IHRydWU7XHJcbiAgICAgICAgYmFrT3ZlcmZsb3cgPSBkb2MuYm9keS5zdHlsZS5vdmVyZmxvd1k7XHJcbiAgICAgICAgZG9jLmJvZHkuc3R5bGUub3ZlcmZsb3dZID0gJ2hpZGRlbic7XHJcbiAgICAgICAgbWUuYWRkTGlzdGVuZXIoJ2NvbnRlbnRjaGFuZ2UgYWZ0ZXJpbnNlcnRodG1sIGtleXVwIG1vdXNldXAnLGFkanVzdEhlaWdodCk7XHJcbiAgICAgICAgLy9mZuS4jee7meS6i+S7tueul+W+l+S4jeWvuVxyXG5cclxuICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgYWRqdXN0SGVpZ2h0LmNhbGwobWUpO1xyXG4gICAgICAgIH0sIGJyb3dzZXIuZ2Vja28gPyAxMDAgOiAwKTtcclxuICAgICAgICBtZS5maXJlRXZlbnQoJ2F1dG9oZWlnaHRjaGFuZ2VkJywgbWUuYXV0b0hlaWdodEVuYWJsZWQpO1xyXG4gICAgfTtcclxuICAgIG1lLmRpc2FibGVBdXRvSGVpZ2h0ID0gZnVuY3Rpb24gKCkge1xyXG5cclxuICAgICAgICBtZS5ib2R5LnN0eWxlLm92ZXJmbG93WSA9IGJha092ZXJmbG93IHx8ICcnO1xyXG5cclxuICAgICAgICBtZS5yZW1vdmVMaXN0ZW5lcignY29udGVudGNoYW5nZScsIGFkanVzdEhlaWdodCk7XHJcbiAgICAgICAgbWUucmVtb3ZlTGlzdGVuZXIoJ2tleXVwJywgYWRqdXN0SGVpZ2h0KTtcclxuICAgICAgICBtZS5yZW1vdmVMaXN0ZW5lcignbW91c2V1cCcsIGFkanVzdEhlaWdodCk7XHJcbiAgICAgICAgbWUuYXV0b0hlaWdodEVuYWJsZWQgPSBmYWxzZTtcclxuICAgICAgICBtZS5maXJlRXZlbnQoJ2F1dG9oZWlnaHRjaGFuZ2VkJywgbWUuYXV0b0hlaWdodEVuYWJsZWQpO1xyXG4gICAgfTtcclxuXHJcbiAgICBtZS5vbignc2V0SGVpZ2h0JyxmdW5jdGlvbigpe1xyXG4gICAgICAgIG1lLmRpc2FibGVBdXRvSGVpZ2h0KClcclxuICAgIH0pO1xyXG4gICAgbWUuYWRkTGlzdGVuZXIoJ3JlYWR5JywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIG1lLmVuYWJsZUF1dG9IZWlnaHQoKTtcclxuICAgICAgICAvL3RyYWNlOjE3NjRcclxuICAgICAgICB2YXIgdGltZXI7XHJcbiAgICAgICAgZG9tVXRpbHMub24oYnJvd3Nlci5pZSA/IG1lLmJvZHkgOiBtZS5kb2N1bWVudCwgYnJvd3Nlci53ZWJraXQgPyAnZHJhZ292ZXInIDogJ2Ryb3AnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XHJcbiAgICAgICAgICAgIHRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAvL3RyYWNlOjM2ODFcclxuICAgICAgICAgICAgICAgIGFkanVzdEhlaWdodC5jYWxsKG1lKTtcclxuICAgICAgICAgICAgfSwgMTAwKTtcclxuXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy/kv67lpI3lhoXlrrnov4flpJrml7bvvIzlm57liLDpobbpg6jvvIzpobbpg6jlhoXlrrnooqvlt6XlhbfmoI/pga7mjKHpl67pophcclxuICAgICAgICB2YXIgbGFzdFNjcm9sbFk7XHJcbiAgICAgICAgd2luZG93Lm9uc2Nyb2xsID0gZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgaWYobGFzdFNjcm9sbFkgPT09IG51bGwpe1xyXG4gICAgICAgICAgICAgICAgbGFzdFNjcm9sbFkgPSB0aGlzLnNjcm9sbFlcclxuICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5zY3JvbGxZID09IDAgJiYgbGFzdFNjcm9sbFkgIT0gMCl7XHJcbiAgICAgICAgICAgICAgICBtZS53aW5kb3cuc2Nyb2xsVG8oMCwwKTtcclxuICAgICAgICAgICAgICAgIGxhc3RTY3JvbGxZID0gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuXHJcbn07XHJcblxyXG5cblxuLy8gcGx1Z2lucy9hdXRvZmxvYXQuanNcbi8vL2ltcG9ydCBjb3JlXHJcbi8vL2NvbW1hbmRzIOaCrOa1ruW3peWFt+agj1xyXG4vLy9jb21tYW5kc05hbWUgIEF1dG9GbG9hdCxhdXRvRmxvYXRFbmFibGVkXHJcbi8vL2NvbW1hbmRzVGl0bGUgIOaCrOa1ruW3peWFt+agj1xyXG4vKipcclxuICogIG1vZGlmaWVkIGJ5IGNoZW5nY2hhbzAxXHJcbiAqICDms6jmhI/vvJog5byV5YWl5q2k5Yqf6IO95ZCO77yM5ZyoSUU25LiL5Lya5bCGYm9keeeahOiDjOaZr+WbvueJh+imhuebluaOie+8gVxyXG4gKi9cclxuVUUucGx1Z2luc1snYXV0b2Zsb2F0J10gPSBmdW5jdGlvbigpIHtcclxuICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgbGFuZyA9IG1lLmdldExhbmcoKTtcclxuICAgIG1lLnNldE9wdCh7XHJcbiAgICAgICAgdG9wT2Zmc2V0OjBcclxuICAgIH0pO1xyXG4gICAgdmFyIG9wdHNBdXRvRmxvYXRFbmFibGVkID0gbWUub3B0aW9ucy5hdXRvRmxvYXRFbmFibGVkICE9PSBmYWxzZSxcclxuICAgICAgICB0b3BPZmZzZXQgPSBtZS5vcHRpb25zLnRvcE9mZnNldDtcclxuXHJcblxyXG4gICAgLy/lpoLmnpzkuI3lm7rlrpp0b29sYmFy55qE5L2N572u77yM5YiZ55u05o6l6YCA5Ye6XHJcbiAgICBpZighb3B0c0F1dG9GbG9hdEVuYWJsZWQpe1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHZhciB1aVV0aWxzID0gVUUudWkudWlVdGlscyxcclxuICAgICAgICBMdGVJRTYgPSBicm93c2VyLmllICYmIGJyb3dzZXIudmVyc2lvbiA8PSA2LFxyXG4gICAgICAgIHF1aXJrcyA9IGJyb3dzZXIucXVpcmtzO1xyXG5cclxuICAgIGZ1bmN0aW9uIGNoZWNrSGFzVUkoKXtcclxuICAgICAgICBpZighVUUudWkpe1xyXG4gICAgICAgICAgICBhbGVydChsYW5nLmF1dG9mbG9hdE1zZyk7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gMTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIGZpeElFNkZpeGVkUG9zKCl7XHJcbiAgICAgICAgdmFyIGRvY1N0eWxlID0gZG9jdW1lbnQuYm9keS5zdHlsZTtcclxuICAgICAgICBkb2NTdHlsZS5iYWNrZ3JvdW5kSW1hZ2UgPSAndXJsKFwiYWJvdXQ6YmxhbmtcIiknO1xyXG4gICAgICAgIGRvY1N0eWxlLmJhY2tncm91bmRBdHRhY2htZW50ID0gJ2ZpeGVkJztcclxuICAgIH1cclxuICAgIHZhclx0YmFrQ3NzVGV4dCxcclxuICAgICAgICBwbGFjZUhvbGRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLFxyXG4gICAgICAgIHRvb2xiYXJCb3gsb3JnVG9wLFxyXG4gICAgICAgIGdldFBvc2l0aW9uLFxyXG4gICAgICAgIGZsYWcgPXRydWU7ICAgLy9pZTfmqKHlvI/kuIvpnIDopoHlgY/np7tcclxuICAgIGZ1bmN0aW9uIHNldEZsb2F0aW5nKCl7XHJcbiAgICAgICAgdmFyIHRvb2JhckJveFBvcyA9IGRvbVV0aWxzLmdldFhZKHRvb2xiYXJCb3gpLFxyXG4gICAgICAgICAgICBvcmlnYWxGbG9hdCA9IGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUodG9vbGJhckJveCwncG9zaXRpb24nKSxcclxuICAgICAgICAgICAgb3JpZ2FsTGVmdCA9IGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUodG9vbGJhckJveCwnbGVmdCcpO1xyXG4gICAgICAgIHRvb2xiYXJCb3guc3R5bGUud2lkdGggPSB0b29sYmFyQm94Lm9mZnNldFdpZHRoICsgJ3B4JztcclxuICAgICAgICB0b29sYmFyQm94LnN0eWxlLnpJbmRleCA9IG1lLm9wdGlvbnMuekluZGV4ICogMSArIDE7XHJcbiAgICAgICAgdG9vbGJhckJveC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShwbGFjZUhvbGRlciwgdG9vbGJhckJveCk7XHJcbiAgICAgICAgaWYgKEx0ZUlFNiB8fCAocXVpcmtzICYmIGJyb3dzZXIuaWUpKSB7XHJcbiAgICAgICAgICAgIGlmKHRvb2xiYXJCb3guc3R5bGUucG9zaXRpb24gIT0gJ2Fic29sdXRlJyl7XHJcbiAgICAgICAgICAgICAgICB0b29sYmFyQm94LnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0b29sYmFyQm94LnN0eWxlLnRvcCA9IChkb2N1bWVudC5ib2R5LnNjcm9sbFRvcHx8ZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCkgLSBvcmdUb3AgKyB0b3BPZmZzZXQgICsgJ3B4JztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoYnJvd3Nlci5pZTdDb21wYXQgJiYgZmxhZykge1xyXG4gICAgICAgICAgICAgICAgZmxhZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgdG9vbGJhckJveC5zdHlsZS5sZWZ0ID0gIGRvbVV0aWxzLmdldFhZKHRvb2xiYXJCb3gpLnggLSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdCsyICArICdweCc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYodG9vbGJhckJveC5zdHlsZS5wb3NpdGlvbiAhPSAnZml4ZWQnKXtcclxuICAgICAgICAgICAgICAgIHRvb2xiYXJCb3guc3R5bGUucG9zaXRpb24gPSAnZml4ZWQnO1xyXG4gICAgICAgICAgICAgICAgdG9vbGJhckJveC5zdHlsZS50b3AgPSB0b3BPZmZzZXQgK1wicHhcIjtcclxuICAgICAgICAgICAgICAgICgob3JpZ2FsRmxvYXQgPT0gJ2Fic29sdXRlJyB8fCBvcmlnYWxGbG9hdCA9PSAncmVsYXRpdmUnKSAmJiBwYXJzZUZsb2F0KG9yaWdhbExlZnQpKSAmJiAodG9vbGJhckJveC5zdHlsZS5sZWZ0ID0gdG9vYmFyQm94UG9zLnggKyAncHgnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIHVuc2V0RmxvYXRpbmcoKXtcclxuICAgICAgICBmbGFnID0gdHJ1ZTtcclxuICAgICAgICBpZihwbGFjZUhvbGRlci5wYXJlbnROb2RlKXtcclxuICAgICAgICAgICAgcGxhY2VIb2xkZXIucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChwbGFjZUhvbGRlcik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0b29sYmFyQm94LnN0eWxlLmNzc1RleHQgPSBiYWtDc3NUZXh0O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHVwZGF0ZUZsb2F0aW5nKCl7XHJcbiAgICAgICAgdmFyIHJlY3QzID0gZ2V0UG9zaXRpb24obWUuY29udGFpbmVyKTtcclxuICAgICAgICB2YXIgb2Zmc2V0PW1lLm9wdGlvbnMudG9vbGJhclRvcE9mZnNldHx8MDtcclxuICAgICAgICBpZiAocmVjdDMudG9wIDwgMCAmJiByZWN0My5ib3R0b20gLSB0b29sYmFyQm94Lm9mZnNldEhlaWdodCA+IG9mZnNldCkge1xyXG4gICAgICAgICAgICBzZXRGbG9hdGluZygpO1xyXG4gICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICB1bnNldEZsb2F0aW5nKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgdmFyIGRlZmVyX3VwZGF0ZUZsb2F0aW5nID0gdXRpbHMuZGVmZXIoZnVuY3Rpb24oKXtcclxuICAgICAgICB1cGRhdGVGbG9hdGluZygpO1xyXG4gICAgfSxicm93c2VyLmllID8gMjAwIDogMTAwLHRydWUpO1xyXG5cclxuICAgIG1lLmFkZExpc3RlbmVyKCdkZXN0cm95JyxmdW5jdGlvbigpe1xyXG4gICAgICAgIGRvbVV0aWxzLnVuKHdpbmRvdywgWydzY3JvbGwnLCdyZXNpemUnXSwgdXBkYXRlRmxvYXRpbmcpO1xyXG4gICAgICAgIG1lLnJlbW92ZUxpc3RlbmVyKCdrZXlkb3duJywgZGVmZXJfdXBkYXRlRmxvYXRpbmcpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgbWUuYWRkTGlzdGVuZXIoJ3JlYWR5JywgZnVuY3Rpb24oKXtcclxuICAgICAgICBpZihjaGVja0hhc1VJKG1lKSl7XHJcbiAgICAgICAgICAgIC8v5Yqg6L295LqGdWnnu4Tku7bvvIzkvYblnKhuZXfml7bvvIzmsqHmnInliqDovb11ae+8jOWvvOiHtOe8lui+keWZqOWunuS+i+S4iuayoeaciXVp57G777yM5omA5Lul6L+Z6YeM5YGa5Yik5patXHJcbiAgICAgICAgICAgIGlmKCFtZS51aSl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZ2V0UG9zaXRpb24gPSB1aVV0aWxzLmdldENsaWVudFJlY3Q7XHJcbiAgICAgICAgICAgIHRvb2xiYXJCb3ggPSBtZS51aS5nZXREb20oJ3Rvb2xiYXJib3gnKTtcclxuICAgICAgICAgICAgb3JnVG9wID0gZ2V0UG9zaXRpb24odG9vbGJhckJveCkudG9wO1xyXG4gICAgICAgICAgICBiYWtDc3NUZXh0ID0gdG9vbGJhckJveC5zdHlsZS5jc3NUZXh0O1xyXG4gICAgICAgICAgICBwbGFjZUhvbGRlci5zdHlsZS5oZWlnaHQgPSB0b29sYmFyQm94Lm9mZnNldEhlaWdodCArICdweCc7XHJcbiAgICAgICAgICAgIGlmKEx0ZUlFNil7XHJcbiAgICAgICAgICAgICAgICBmaXhJRTZGaXhlZFBvcygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLm9uKHdpbmRvdywgWydzY3JvbGwnLCdyZXNpemUnXSwgdXBkYXRlRmxvYXRpbmcpO1xyXG4gICAgICAgICAgICBtZS5hZGRMaXN0ZW5lcigna2V5ZG93bicsIGRlZmVyX3VwZGF0ZUZsb2F0aW5nKTtcclxuXHJcbiAgICAgICAgICAgIG1lLmFkZExpc3RlbmVyKCdiZWZvcmVmdWxsc2NyZWVuY2hhbmdlJywgZnVuY3Rpb24gKHQsIGVuYWJsZWQpe1xyXG4gICAgICAgICAgICAgICAgaWYgKGVuYWJsZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB1bnNldEZsb2F0aW5nKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBtZS5hZGRMaXN0ZW5lcignZnVsbHNjcmVlbmNoYW5nZWQnLCBmdW5jdGlvbiAodCwgZW5hYmxlZCl7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWVuYWJsZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB1cGRhdGVGbG9hdGluZygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgbWUuYWRkTGlzdGVuZXIoJ3NvdXJjZW1vZGVjaGFuZ2VkJywgZnVuY3Rpb24gKHQsIGVuYWJsZWQpe1xyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgICAgICAgICB1cGRhdGVGbG9hdGluZygpO1xyXG4gICAgICAgICAgICAgICAgfSwwKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIG1lLmFkZExpc3RlbmVyKFwiY2xlYXJEb2NcIixmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZUZsb2F0aW5nKCk7XHJcbiAgICAgICAgICAgICAgICB9LDApO1xyXG5cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufTtcclxuXG5cbi8vIHBsdWdpbnMvdmlkZW8uanNcbi8qKlxyXG4gKiB2aWRlb+aPkuS7tu+8jCDkuLpVRWRpdG9y5o+Q5L6b6KeG6aKR5o+S5YWl5pSv5oyBXHJcbiAqIEBmaWxlXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqL1xyXG5cclxuVUUucGx1Z2luc1sndmlkZW8nXSA9IGZ1bmN0aW9uICgpe1xyXG4gICAgdmFyIG1lID10aGlzO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yib5bu65o+S5YWl6KeG6aKR5a2X56ym56qcXHJcbiAgICAgKiBAcGFyYW0gdXJsIOinhumikeWcsOWdgFxyXG4gICAgICogQHBhcmFtIHdpZHRoIOinhumikeWuveW6plxyXG4gICAgICogQHBhcmFtIGhlaWdodCDop4bpopHpq5jluqZcclxuICAgICAqIEBwYXJhbSBhbGlnbiDop4bpopHlr7npvZBcclxuICAgICAqIEBwYXJhbSB0b0VtYmVkIOaYr+WQpuS7pWZsYXNo5Luj5pu/5pi+56S6XHJcbiAgICAgKiBAcGFyYW0gYWRkUGFyYWdyYXBoICDmmK/lkKbpnIDopoHmt7vliqBQIOagh+etvlxyXG4gICAgICovXHJcbiAgICBmdW5jdGlvbiBjcmVhdEluc2VydFN0cih1cmwsd2lkdGgsaGVpZ2h0LGlkLGFsaWduLGNsYXNzbmFtZSx0eXBlKXtcclxuXHJcbiAgICAgICAgdXJsID0gdXRpbHMudW5odG1sRm9yVXJsKHVybCk7XHJcbiAgICAgICAgYWxpZ24gPSB1dGlscy51bmh0bWwoYWxpZ24pO1xyXG4gICAgICAgIGNsYXNzbmFtZSA9IHV0aWxzLnVuaHRtbChjbGFzc25hbWUpO1xyXG5cclxuICAgICAgICB3aWR0aCA9IHBhcnNlSW50KHdpZHRoLCAxMCkgfHwgMDtcclxuICAgICAgICBoZWlnaHQgPSBwYXJzZUludChoZWlnaHQsIDEwKSB8fCAwO1xyXG5cclxuICAgICAgICB2YXIgc3RyO1xyXG4gICAgICAgIHN3aXRjaCAodHlwZSl7XHJcbiAgICAgICAgICAgIGNhc2UgJ2ltYWdlJzpcclxuICAgICAgICAgICAgICAgIHN0ciA9ICc8aW1nICcgKyAoaWQgPyAnaWQ9XCInICsgaWQrJ1wiJyA6ICcnKSArICcgd2lkdGg9XCInKyB3aWR0aCArJ1wiIGhlaWdodD1cIicgKyBoZWlnaHQgKyAnXCIgX3VybD1cIicrdXJsKydcIiBjbGFzcz1cIicgKyBjbGFzc25hbWUucmVwbGFjZSgvXFxidmlkZW8tanNcXGIvLCAnJykgKyAnXCInICArXHJcbiAgICAgICAgICAgICAgICAgICAgJyBzcmM9XCInICsgbWUub3B0aW9ucy5VRURJVE9SX0hPTUVfVVJMKyd0aGVtZXMvZGVmYXVsdC9pbWFnZXMvc3BhY2VyLmdpZlwiIHN0eWxlPVwiYmFja2dyb3VuZDp1cmwoJyttZS5vcHRpb25zLlVFRElUT1JfSE9NRV9VUkwrJ3RoZW1lcy9kZWZhdWx0L2ltYWdlcy92aWRlb2xvZ28uZ2lmKSBuby1yZXBlYXQgY2VudGVyIGNlbnRlcjsgYm9yZGVyOjFweCBzb2xpZCBncmF5OycrKGFsaWduID8gJ2Zsb2F0OicgKyBhbGlnbiArICc7JzogJycpKydcIiAvPidcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdlbWJlZCc6XHJcbiAgICAgICAgICAgICAgICBzdHIgPSAnPGVtYmVkIHR5cGU9XCJhcHBsaWNhdGlvbi94LXNob2Nrd2F2ZS1mbGFzaFwiIGNsYXNzPVwiJyArIGNsYXNzbmFtZSArICdcIiBwbHVnaW5zcGFnZT1cImh0dHA6Ly93d3cubWFjcm9tZWRpYS5jb20vZ28vZ2V0Zmxhc2hwbGF5ZXJcIicgK1xyXG4gICAgICAgICAgICAgICAgICAgICcgc3JjPVwiJyArICB1dGlscy5odG1sKHVybCkgKyAnXCIgd2lkdGg9XCInICsgd2lkdGggICsgJ1wiIGhlaWdodD1cIicgKyBoZWlnaHQgICsgJ1wiJyAgKyAoYWxpZ24gPyAnIHN0eWxlPVwiZmxvYXQ6JyArIGFsaWduICsgJ1wiJzogJycpICtcclxuICAgICAgICAgICAgICAgICAgICAnIHdtb2RlPVwidHJhbnNwYXJlbnRcIiBwbGF5PVwidHJ1ZVwiIGxvb3A9XCJmYWxzZVwiIG1lbnU9XCJmYWxzZVwiIGFsbG93c2NyaXB0YWNjZXNzPVwibmV2ZXJcIiBhbGxvd2Z1bGxzY3JlZW49XCJ0cnVlXCIgPic7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAndmlkZW8nOlxyXG4gICAgICAgICAgICAgICAgdmFyIGV4dCA9IHVybC5zdWJzdHIodXJsLmxhc3RJbmRleE9mKCcuJykgKyAxKTtcclxuICAgICAgICAgICAgICAgIGlmKGV4dCA9PSAnb2d2JykgZXh0ID0gJ29nZyc7XHJcbiAgICAgICAgICAgICAgICBzdHIgPSAnPHZpZGVvJyArIChpZCA/ICcgaWQ9XCInICsgaWQgKyAnXCInIDogJycpICsgJyBjbGFzcz1cIicgKyBjbGFzc25hbWUgKyAnIHZpZGVvLWpzXCIgJyArIChhbGlnbiA/ICcgc3R5bGU9XCJmbG9hdDonICsgYWxpZ24gKyAnXCInOiAnJykgK1xyXG4gICAgICAgICAgICAgICAgICAgICcgY29udHJvbHMgcHJlbG9hZD1cIm5vbmVcIiB3aWR0aD1cIicgKyB3aWR0aCArICdcIiBoZWlnaHQ9XCInICsgaGVpZ2h0ICsgJ1wiIHNyYz1cIicgKyB1cmwgKyAnXCIgZGF0YS1zZXR1cD1cInt9XCI+JyArXHJcbiAgICAgICAgICAgICAgICAgICAgJzxzb3VyY2Ugc3JjPVwiJyArIHVybCArICdcIiB0eXBlPVwidmlkZW8vJyArIGV4dCArICdcIiAvPjwvdmlkZW8+JztcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc3RyO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHN3aXRjaEltZ0FuZFZpZGVvKHJvb3QsaW1nMnZpZGVvKXtcclxuICAgICAgICB1dGlscy5lYWNoKHJvb3QuZ2V0Tm9kZXNCeVRhZ05hbWUoaW1nMnZpZGVvID8gJ2ltZycgOiAnZW1iZWQgdmlkZW8nKSxmdW5jdGlvbihub2RlKXtcclxuICAgICAgICAgICAgdmFyIGNsYXNzTmFtZSA9IG5vZGUuZ2V0QXR0cignY2xhc3MnKTtcclxuICAgICAgICAgICAgaWYoY2xhc3NOYW1lICYmIGNsYXNzTmFtZS5pbmRleE9mKCdlZHVpLWZha2VkLXZpZGVvJykgIT0gLTEpe1xyXG4gICAgICAgICAgICAgICAgdmFyIGh0bWwgPSBjcmVhdEluc2VydFN0ciggaW1nMnZpZGVvID8gbm9kZS5nZXRBdHRyKCdfdXJsJykgOiBub2RlLmdldEF0dHIoJ3NyYycpLG5vZGUuZ2V0QXR0cignd2lkdGgnKSxub2RlLmdldEF0dHIoJ2hlaWdodCcpLG51bGwsbm9kZS5nZXRTdHlsZSgnZmxvYXQnKSB8fCAnJyxjbGFzc05hbWUsaW1nMnZpZGVvID8gJ2VtYmVkJzonaW1hZ2UnKTtcclxuICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoVUUudU5vZGUuY3JlYXRlRWxlbWVudChodG1sKSxub2RlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZihjbGFzc05hbWUgJiYgY2xhc3NOYW1lLmluZGV4T2YoJ2VkdWktdXBsb2FkLXZpZGVvJykgIT0gLTEpe1xyXG4gICAgICAgICAgICAgICAgdmFyIGh0bWwgPSBjcmVhdEluc2VydFN0ciggaW1nMnZpZGVvID8gbm9kZS5nZXRBdHRyKCdfdXJsJykgOiBub2RlLmdldEF0dHIoJ3NyYycpLG5vZGUuZ2V0QXR0cignd2lkdGgnKSxub2RlLmdldEF0dHIoJ2hlaWdodCcpLG51bGwsbm9kZS5nZXRTdHlsZSgnZmxvYXQnKSB8fCAnJyxjbGFzc05hbWUsaW1nMnZpZGVvID8gJ3ZpZGVvJzonaW1hZ2UnKTtcclxuICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoVUUudU5vZGUuY3JlYXRlRWxlbWVudChodG1sKSxub2RlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgbWUuYWRkT3V0cHV0UnVsZShmdW5jdGlvbihyb290KXtcclxuICAgICAgICBzd2l0Y2hJbWdBbmRWaWRlbyhyb290LHRydWUpXHJcbiAgICB9KTtcclxuICAgIG1lLmFkZElucHV0UnVsZShmdW5jdGlvbihyb290KXtcclxuICAgICAgICBzd2l0Y2hJbWdBbmRWaWRlbyhyb290KVxyXG4gICAgfSk7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmj5LlhaXop4bpopFcclxuICAgICAqIEBjb21tYW5kIGluc2VydHZpZGVvXHJcbiAgICAgKiBAbWV0aG9kIGV4ZWNDb21tYW5kXHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAgICAgKiBAcGFyYW0geyBPYmplY3QgfSB2aWRlb0F0dHIg6ZSu5YC85a+55a+56LGh77yMIOaPj+i/sOS4gOS4quinhumikeeahOaJgOacieWxnuaAp1xyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqXHJcbiAgICAgKiB2YXIgdmlkZW9BdHRyID0ge1xyXG4gICAgICogICAgICAvL+inhumikeWcsOWdgFxyXG4gICAgICogICAgICB1cmw6ICdodHRwOi8vd3d3LnlvdWt1LmNvbS94eHgnLFxyXG4gICAgICogICAgICAvL+inhumikeWuvemrmOWAvO+8jCDljZXkvY1weFxyXG4gICAgICogICAgICB3aWR0aDogMjAwLFxyXG4gICAgICogICAgICBoZWlnaHQ6IDEwMFxyXG4gICAgICogfTtcclxuICAgICAqXHJcbiAgICAgKiAvL2VkaXRvciDmmK/nvJbovpHlmajlrp7kvotcclxuICAgICAqIC8v5ZCR57yW6L6R5Zmo5o+S5YWl5Y2V5Liq6KeG6aKRXHJcbiAgICAgKiBlZGl0b3IuZXhlY0NvbW1hbmQoICdpbnNlcnR2aWRlbycsIHZpZGVvQXR0ciApO1xyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIOaPkuWFpeinhumikVxyXG4gICAgICogQGNvbW1hbmQgaW5zZXJ0dmlkZW9cclxuICAgICAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcclxuICAgICAqIEBwYXJhbSB7IEFycmF5IH0gdmlkZW9BcnIg6ZyA6KaB5o+S5YWl55qE6KeG6aKR55qE5pWw57uE77yMIOWFtuS4reeahOavj+S4gOS4quWFg+e0oOmDveaYr+S4gOS4qumUruWAvOWvueWvueixoe+8jCDmj4/ov7DkuobkuIDkuKrop4bpopHnmoTmiYDmnInlsZ7mgKdcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKlxyXG4gICAgICogdmFyIHZpZGVvQXR0cjEgPSB7XHJcbiAgICAgKiAgICAgIC8v6KeG6aKR5Zyw5Z2AXHJcbiAgICAgKiAgICAgIHVybDogJ2h0dHA6Ly93d3cueW91a3UuY29tL3h4eCcsXHJcbiAgICAgKiAgICAgIC8v6KeG6aKR5a696auY5YC877yMIOWNleS9jXB4XHJcbiAgICAgKiAgICAgIHdpZHRoOiAyMDAsXHJcbiAgICAgKiAgICAgIGhlaWdodDogMTAwXHJcbiAgICAgKiB9LFxyXG4gICAgICogdmlkZW9BdHRyMiA9IHtcclxuICAgICAqICAgICAgLy/op4bpopHlnLDlnYBcclxuICAgICAqICAgICAgdXJsOiAnaHR0cDovL3d3dy55b3VrdS5jb20veHh4JyxcclxuICAgICAqICAgICAgLy/op4bpopHlrr3pq5jlgLzvvIwg5Y2V5L2NcHhcclxuICAgICAqICAgICAgd2lkdGg6IDIwMCxcclxuICAgICAqICAgICAgaGVpZ2h0OiAxMDBcclxuICAgICAqIH1cclxuICAgICAqXHJcbiAgICAgKiAvL2VkaXRvciDmmK/nvJbovpHlmajlrp7kvotcclxuICAgICAqIC8v6K+l5pa55rOV5bCG5Lya5ZCR57yW6L6R5Zmo5YaF5o+S5YWl5Lik5Liq6KeG6aKRXHJcbiAgICAgKiBlZGl0b3IuZXhlY0NvbW1hbmQoICdpbnNlcnR2aWRlbycsIFsgdmlkZW9BdHRyMSwgdmlkZW9BdHRyMiBdICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5p+l6K+i5b2T5YmN5YWJ5qCH5omA5Zyo5aSE5piv5ZCm5piv5LiA5Liq6KeG6aKRXHJcbiAgICAgKiBAY29tbWFuZCBpbnNlcnR2aWRlb1xyXG4gICAgICogQG1ldGhvZCBxdWVyeUNvbW1hbmRTdGF0ZVxyXG4gICAgICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOmcgOimgeafpeivoueahOWRveS7pOWtl+espuS4slxyXG4gICAgICogQHJldHVybiB7IGludCB9IOWmguaenOW9k+WJjeWFieagh+aJgOWcqOWkhOeahOWFg+e0oOaYr+S4gOS4quinhumikeWvueixoe+8jCDliJnov5Tlm54x77yM5ZCm5YiZ6L+U5ZueMFxyXG4gICAgICogQGV4YW1wbGVcclxuICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAqXHJcbiAgICAgKiAvL2VkaXRvciDmmK/nvJbovpHlmajlrp7kvotcclxuICAgICAqIGVkaXRvci5xdWVyeUNvbW1hbmRTdGF0ZSggJ2luc2VydHZpZGVvJyApO1xyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuICAgIG1lLmNvbW1hbmRzW1wiaW5zZXJ0dmlkZW9cIl0gPSB7XHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uIChjbWQsIHZpZGVvT2JqcywgdHlwZSl7XHJcbiAgICAgICAgICAgIHZpZGVvT2JqcyA9IHV0aWxzLmlzQXJyYXkodmlkZW9PYmpzKT92aWRlb09ianM6W3ZpZGVvT2Jqc107XHJcbiAgICAgICAgICAgIHZhciBodG1sID0gW10saWQgPSAndG1wVmVkaW8nLCBjbDtcclxuICAgICAgICAgICAgZm9yKHZhciBpPTAsdmksbGVuID0gdmlkZW9PYmpzLmxlbmd0aDtpPGxlbjtpKyspe1xyXG4gICAgICAgICAgICAgICAgdmkgPSB2aWRlb09ianNbaV07XHJcbiAgICAgICAgICAgICAgICBjbCA9ICh0eXBlID09ICd1cGxvYWQnID8gJ2VkdWktdXBsb2FkLXZpZGVvIHZpZGVvLWpzIHZqcy1kZWZhdWx0LXNraW4nOidlZHVpLWZha2VkLXZpZGVvJyk7XHJcbiAgICAgICAgICAgICAgICBodG1sLnB1c2goY3JlYXRJbnNlcnRTdHIoIHZpLnVybCwgdmkud2lkdGggfHwgNDIwLCAgdmkuaGVpZ2h0IHx8IDI4MCwgaWQgKyBpLCBudWxsLCBjbCwgJ2ltYWdlJykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKFwiaW5zZXJ0aHRtbFwiLGh0bWwuam9pbihcIlwiKSx0cnVlKTtcclxuICAgICAgICAgICAgdmFyIHJuZyA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgIGZvcih2YXIgaT0gMCxsZW49dmlkZW9PYmpzLmxlbmd0aDtpPGxlbjtpKyspe1xyXG4gICAgICAgICAgICAgICAgdmFyIGltZyA9IHRoaXMuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RtcFZlZGlvJytpKTtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZUF0dHJpYnV0ZXMoaW1nLCdpZCcpO1xyXG4gICAgICAgICAgICAgICAgcm5nLnNlbGVjdE5vZGUoaW1nKS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKCdpbWFnZWZsb2F0Jyx2aWRlb09ianNbaV0uYWxpZ24pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlIDogZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgdmFyIGltZyA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLmdldENsb3NlZE5vZGUoKSxcclxuICAgICAgICAgICAgICAgIGZsYWcgPSBpbWcgJiYgKGltZy5jbGFzc05hbWUgPT0gXCJlZHVpLWZha2VkLXZpZGVvXCIgfHwgaW1nLmNsYXNzTmFtZS5pbmRleE9mKFwiZWR1aS11cGxvYWQtdmlkZW9cIikhPS0xKTtcclxuICAgICAgICAgICAgcmV0dXJuIGZsYWcgPyAxIDogMDtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59O1xyXG5cblxuLy8gcGx1Z2lucy90YWJsZS5jb3JlLmpzXG4vKipcclxuICogQ3JlYXRlZCB3aXRoIEpldEJyYWlucyBXZWJTdG9ybS5cclxuICogVXNlcjogdGFvcWlsaVxyXG4gKiBEYXRlOiAxMy0xLTE4XHJcbiAqIFRpbWU6IOS4iuWNiDExOjA5XHJcbiAqIFRvIGNoYW5nZSB0aGlzIHRlbXBsYXRlIHVzZSBGaWxlIHwgU2V0dGluZ3MgfCBGaWxlIFRlbXBsYXRlcy5cclxuICovXHJcbi8qKlxyXG4gKiBVReihqOagvOaTjeS9nOexu1xyXG4gKiBAcGFyYW0gdGFibGVcclxuICogQGNvbnN0cnVjdG9yXHJcbiAqL1xyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIFVFVGFibGUgPSBVRS5VRVRhYmxlID0gZnVuY3Rpb24gKHRhYmxlKSB7XHJcbiAgICAgICAgdGhpcy50YWJsZSA9IHRhYmxlO1xyXG4gICAgICAgIHRoaXMuaW5kZXhUYWJsZSA9IFtdO1xyXG4gICAgICAgIHRoaXMuc2VsZWN0ZWRUZHMgPSBbXTtcclxuICAgICAgICB0aGlzLmNlbGxzUmFuZ2UgPSB7fTtcclxuICAgICAgICB0aGlzLnVwZGF0ZSh0YWJsZSk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vPT095Lul5LiL5Li66Z2Z5oCB5bel5YW35pa55rOVPT09XHJcbiAgICBVRVRhYmxlLnJlbW92ZVNlbGVjdGVkQ2xhc3MgPSBmdW5jdGlvbiAoY2VsbHMpIHtcclxuICAgICAgICB1dGlscy5lYWNoKGNlbGxzLCBmdW5jdGlvbiAoY2VsbCkge1xyXG4gICAgICAgICAgICBkb21VdGlscy5yZW1vdmVDbGFzc2VzKGNlbGwsIFwic2VsZWN0VGRDbGFzc1wiKTtcclxuICAgICAgICB9KVxyXG4gICAgfTtcclxuICAgIFVFVGFibGUuYWRkU2VsZWN0ZWRDbGFzcyA9IGZ1bmN0aW9uIChjZWxscykge1xyXG4gICAgICAgIHV0aWxzLmVhY2goY2VsbHMsIGZ1bmN0aW9uIChjZWxsKSB7XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLmFkZENsYXNzKGNlbGwsIFwic2VsZWN0VGRDbGFzc1wiKTtcclxuICAgICAgICB9KVxyXG4gICAgfTtcclxuICAgIFVFVGFibGUuaXNFbXB0eUJsb2NrID0gZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICB2YXIgcmVnID0gbmV3IFJlZ0V4cChkb21VdGlscy5maWxsQ2hhciwgJ2cnKTtcclxuICAgICAgICBpZiAobm9kZVticm93c2VyLmllID8gJ2lubmVyVGV4dCcgOiAndGV4dENvbnRlbnQnXS5yZXBsYWNlKC9eXFxzKiQvLCAnJykucmVwbGFjZShyZWcsICcnKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKHZhciBpIGluIGR0ZC4kaXNOb3RFbXB0eSkgaWYgKGR0ZC4kaXNOb3RFbXB0eS5oYXNPd25Qcm9wZXJ0eShpKSkge1xyXG4gICAgICAgICAgICBpZiAobm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZShpKS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAxO1xyXG4gICAgfTtcclxuICAgIFVFVGFibGUuZ2V0V2lkdGggPSBmdW5jdGlvbiAoY2VsbCkge1xyXG4gICAgICAgIGlmICghY2VsbClyZXR1cm4gMDtcclxuICAgICAgICByZXR1cm4gcGFyc2VJbnQoZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZShjZWxsLCBcIndpZHRoXCIpLCAxMCk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog6I635Y+W5Y2V5YWD5qC85oiW6ICF5Y2V5YWD5qC857uE55qE4oCc5a+56b2Q4oCd54q25oCB44CCIOWmguaenOW9k+WJjeeahOajgOa1i+WvueixoeaYr+S4gOS4quWNleWFg+agvOe7hO+8jCDlj6rmnInlnKjmu6HotrPmiYDmnInljZXlhYPmoLznmoQg5rC05bmz5ZKM56uW55u0IOWvuem9kOWxnuaAp+mDveebuOWQjOeahFxyXG4gICAgICog5p2h5Lu25pe25omN5Lya6L+U5Zue5YW254q25oCB5YC877yM5ZCm5YiZ5bCG6L+U5ZuebnVsbO+8myDlpoLmnpzlvZPliY3lj6rmo4DmtYvkuobkuIDkuKrljZXlhYPmoLzvvIwg5YiZ55u05o6l6L+U5Zue5b2T5YmN5Y2V5YWD5qC855qE5a+56b2Q54q25oCB77ybXHJcbiAgICAgKiBAcGFyYW0gdGFibGUgY2VsbCBvciB0YWJsZSBjZWxscyAsIOaUr+aMgeWNleS4quWNleWFg+agvGRvbeWvueixoSDmiJbogIUg5Y2V5YWD5qC8ZG9t5a+56LGh5pWw57uEXHJcbiAgICAgKiBAcmV0dXJuIHsgYWxpZ246ICdsZWZ0JyB8fCAncmlnaHQnIHx8ICdjZW50ZXInLCB2YWxpZ246ICd0b3AnIHx8ICdtaWRkbGUnIHx8ICdib3R0b20nIH0g5oiW6ICFIG51bGxcclxuICAgICAqL1xyXG4gICAgVUVUYWJsZS5nZXRUYWJsZUNlbGxBbGlnblN0YXRlID0gZnVuY3Rpb24gKCBjZWxscyApIHtcclxuXHJcbiAgICAgICAgIXV0aWxzLmlzQXJyYXkoIGNlbGxzICkgJiYgKCBjZWxscyA9IFtjZWxsc10gKTtcclxuXHJcbiAgICAgICAgdmFyIHJlc3VsdCA9IHt9LFxyXG4gICAgICAgICAgICBzdGF0dXMgPSBbJ2FsaWduJywgJ3ZhbGlnbiddLFxyXG4gICAgICAgICAgICB0ZW1wU3RhdHVzID0gbnVsbCxcclxuICAgICAgICAgICAgaXNTYW1lID0gdHJ1ZTsvL+eKtuaAgeaYr+WQpuebuOWQjFxyXG5cclxuICAgICAgICB1dGlscy5lYWNoKCBjZWxscywgZnVuY3Rpb24oIGNlbGxOb2RlICl7XHJcblxyXG4gICAgICAgICAgICB1dGlscy5lYWNoKCBzdGF0dXMsIGZ1bmN0aW9uKCBjdXJyZW50U3RhdGUgKXtcclxuXHJcbiAgICAgICAgICAgICAgICB0ZW1wU3RhdHVzID0gY2VsbE5vZGUuZ2V0QXR0cmlidXRlKCBjdXJyZW50U3RhdGUgKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiggIXJlc3VsdFsgY3VycmVudFN0YXRlIF0gJiYgdGVtcFN0YXR1cyApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHRbIGN1cnJlbnRTdGF0ZSBdID0gdGVtcFN0YXR1cztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiggIXJlc3VsdFsgY3VycmVudFN0YXRlIF0gfHwgKCB0ZW1wU3RhdHVzICE9PSByZXN1bHRbIGN1cnJlbnRTdGF0ZSBdICkgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaXNTYW1lID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfSApO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIGlzU2FtZTtcclxuXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBpc1NhbWUgPyByZXN1bHQgOiBudWxsO1xyXG5cclxuICAgIH07XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmoLnmja7lvZPliY3pgInljLrojrflj5bnm7jlhbPnmoR0YWJsZeS/oeaBr1xyXG4gICAgICogQHJldHVybiB7T2JqZWN0fVxyXG4gICAgICovXHJcbiAgICBVRVRhYmxlLmdldFRhYmxlSXRlbXNCeVJhbmdlID0gZnVuY3Rpb24gKGVkaXRvcikge1xyXG4gICAgICAgIHZhciBzdGFydCA9IGVkaXRvci5zZWxlY3Rpb24uZ2V0U3RhcnQoKTtcclxuXHJcbiAgICAgICAgLy9mZuS4i+S8mumAieS4rWJvb2ttYXJrXHJcbiAgICAgICAgaWYoIHN0YXJ0ICYmIHN0YXJ0LmlkICYmIHN0YXJ0LmlkLmluZGV4T2YoJ19iYWlkdV9ib29rbWFya19zdGFydF8nKSA9PT0gMCAmJiBzdGFydC5uZXh0U2libGluZykge1xyXG4gICAgICAgICAgICBzdGFydCA9IHN0YXJ0Lm5leHRTaWJsaW5nO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy/lnKh0YWJsZeaIluiAhXRk6L6557yY5pyJ5Y+v6IO95a2Y5Zyo6YCJ5LitdHLnmoTmg4XlhrVcclxuICAgICAgICB2YXIgY2VsbCA9IHN0YXJ0ICYmIGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUoc3RhcnQsIFtcInRkXCIsIFwidGhcIl0sIHRydWUpLFxyXG4gICAgICAgICAgICB0ciA9IGNlbGwgJiYgY2VsbC5wYXJlbnROb2RlLFxyXG4gICAgICAgICAgICBjYXB0aW9uID0gc3RhcnQgJiYgZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShzdGFydCwgJ2NhcHRpb24nLCB0cnVlKSxcclxuICAgICAgICAgICAgdGFibGUgPSBjYXB0aW9uID8gY2FwdGlvbi5wYXJlbnROb2RlIDogdHIgJiYgdHIucGFyZW50Tm9kZS5wYXJlbnROb2RlO1xyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBjZWxsOmNlbGwsXHJcbiAgICAgICAgICAgIHRyOnRyLFxyXG4gICAgICAgICAgICB0YWJsZTp0YWJsZSxcclxuICAgICAgICAgICAgY2FwdGlvbjpjYXB0aW9uXHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFVFVGFibGUuZ2V0VUVUYWJsZUJ5U2VsZWN0ZWQgPSBmdW5jdGlvbiAoZWRpdG9yKSB7XHJcbiAgICAgICAgdmFyIHRhYmxlID0gVUVUYWJsZS5nZXRUYWJsZUl0ZW1zQnlSYW5nZShlZGl0b3IpLnRhYmxlO1xyXG4gICAgICAgIGlmICh0YWJsZSAmJiB0YWJsZS51ZVRhYmxlICYmIHRhYmxlLnVlVGFibGUuc2VsZWN0ZWRUZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0YWJsZS51ZVRhYmxlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH07XHJcblxyXG4gICAgVUVUYWJsZS5nZXREZWZhdWx0VmFsdWUgPSBmdW5jdGlvbiAoZWRpdG9yLCB0YWJsZSkge1xyXG4gICAgICAgIHZhciBib3JkZXJNYXAgPSB7XHJcbiAgICAgICAgICAgICAgICB0aGluOicwcHgnLFxyXG4gICAgICAgICAgICAgICAgbWVkaXVtOicxcHgnLFxyXG4gICAgICAgICAgICAgICAgdGhpY2s6JzJweCdcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgdGFibGVCb3JkZXIsIHRkUGFkZGluZywgdGRCb3JkZXIsIHRtcFZhbHVlO1xyXG4gICAgICAgIGlmICghdGFibGUpIHtcclxuICAgICAgICAgICAgdGFibGUgPSBlZGl0b3IuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGFibGUnKTtcclxuICAgICAgICAgICAgdGFibGUuaW5zZXJ0Um93KDApLmluc2VydENlbGwoMCkuaW5uZXJIVE1MID0gJ3h4eCc7XHJcbiAgICAgICAgICAgIGVkaXRvci5ib2R5LmFwcGVuZENoaWxkKHRhYmxlKTtcclxuICAgICAgICAgICAgdmFyIHRkID0gdGFibGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3RkJylbMF07XHJcbiAgICAgICAgICAgIHRtcFZhbHVlID0gZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZSh0YWJsZSwgJ2JvcmRlci1sZWZ0LXdpZHRoJyk7XHJcbiAgICAgICAgICAgIHRhYmxlQm9yZGVyID0gcGFyc2VJbnQoYm9yZGVyTWFwW3RtcFZhbHVlXSB8fCB0bXBWYWx1ZSwgMTApO1xyXG4gICAgICAgICAgICB0bXBWYWx1ZSA9IGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUodGQsICdwYWRkaW5nLWxlZnQnKTtcclxuICAgICAgICAgICAgdGRQYWRkaW5nID0gcGFyc2VJbnQoYm9yZGVyTWFwW3RtcFZhbHVlXSB8fCB0bXBWYWx1ZSwgMTApO1xyXG4gICAgICAgICAgICB0bXBWYWx1ZSA9IGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUodGQsICdib3JkZXItbGVmdC13aWR0aCcpO1xyXG4gICAgICAgICAgICB0ZEJvcmRlciA9IHBhcnNlSW50KGJvcmRlck1hcFt0bXBWYWx1ZV0gfHwgdG1wVmFsdWUsIDEwKTtcclxuICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHRhYmxlKTtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIHRhYmxlQm9yZGVyOnRhYmxlQm9yZGVyLFxyXG4gICAgICAgICAgICAgICAgdGRQYWRkaW5nOnRkUGFkZGluZyxcclxuICAgICAgICAgICAgICAgIHRkQm9yZGVyOnRkQm9yZGVyXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGQgPSB0YWJsZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgndGQnKVswXTtcclxuICAgICAgICAgICAgdG1wVmFsdWUgPSBkb21VdGlscy5nZXRDb21wdXRlZFN0eWxlKHRhYmxlLCAnYm9yZGVyLWxlZnQtd2lkdGgnKTtcclxuICAgICAgICAgICAgdGFibGVCb3JkZXIgPSBwYXJzZUludChib3JkZXJNYXBbdG1wVmFsdWVdIHx8IHRtcFZhbHVlLCAxMCk7XHJcbiAgICAgICAgICAgIHRtcFZhbHVlID0gZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZSh0ZCwgJ3BhZGRpbmctbGVmdCcpO1xyXG4gICAgICAgICAgICB0ZFBhZGRpbmcgPSBwYXJzZUludChib3JkZXJNYXBbdG1wVmFsdWVdIHx8IHRtcFZhbHVlLCAxMCk7XHJcbiAgICAgICAgICAgIHRtcFZhbHVlID0gZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZSh0ZCwgJ2JvcmRlci1sZWZ0LXdpZHRoJyk7XHJcbiAgICAgICAgICAgIHRkQm9yZGVyID0gcGFyc2VJbnQoYm9yZGVyTWFwW3RtcFZhbHVlXSB8fCB0bXBWYWx1ZSwgMTApO1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgdGFibGVCb3JkZXI6dGFibGVCb3JkZXIsXHJcbiAgICAgICAgICAgICAgICB0ZFBhZGRpbmc6dGRQYWRkaW5nLFxyXG4gICAgICAgICAgICAgICAgdGRCb3JkZXI6dGRCb3JkZXJcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgLyoqXHJcbiAgICAgKiDmoLnmja7lvZPliY3ngrnlh7vnmoR0ZOaIluiAhXRhYmxl6I635Y+W57Si5byV5a+56LGhXHJcbiAgICAgKiBAcGFyYW0gdGRPclRhYmxlXHJcbiAgICAgKi9cclxuICAgIFVFVGFibGUuZ2V0VUVUYWJsZSA9IGZ1bmN0aW9uICh0ZE9yVGFibGUpIHtcclxuICAgICAgICB2YXIgdGFnID0gdGRPclRhYmxlLnRhZ05hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICB0ZE9yVGFibGUgPSAodGFnID09IFwidGRcIiB8fCB0YWcgPT0gXCJ0aFwiIHx8IHRhZyA9PSAnY2FwdGlvbicpID8gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZSh0ZE9yVGFibGUsIFwidGFibGVcIiwgdHJ1ZSkgOiB0ZE9yVGFibGU7XHJcbiAgICAgICAgaWYgKCF0ZE9yVGFibGUudWVUYWJsZSkge1xyXG4gICAgICAgICAgICB0ZE9yVGFibGUudWVUYWJsZSA9IG5ldyBVRVRhYmxlKHRkT3JUYWJsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0ZE9yVGFibGUudWVUYWJsZTtcclxuICAgIH07XHJcblxyXG4gICAgVUVUYWJsZS5jbG9uZUNlbGwgPSBmdW5jdGlvbihjZWxsLGlnbm9yZU1lcmdlLGtlZXBQcm8pe1xyXG4gICAgICAgIGlmICghY2VsbCB8fCB1dGlscy5pc1N0cmluZyhjZWxsKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy50YWJsZS5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoY2VsbCB8fCAndGQnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGZsYWcgPSBkb21VdGlscy5oYXNDbGFzcyhjZWxsLCBcInNlbGVjdFRkQ2xhc3NcIik7XHJcbiAgICAgICAgZmxhZyAmJiBkb21VdGlscy5yZW1vdmVDbGFzc2VzKGNlbGwsIFwic2VsZWN0VGRDbGFzc1wiKTtcclxuICAgICAgICB2YXIgdG1wQ2VsbCA9IGNlbGwuY2xvbmVOb2RlKHRydWUpO1xyXG4gICAgICAgIGlmIChpZ25vcmVNZXJnZSkge1xyXG4gICAgICAgICAgICB0bXBDZWxsLnJvd1NwYW4gPSB0bXBDZWxsLmNvbFNwYW4gPSAxO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvL+WOu+aOieWuvemrmFxyXG4gICAgICAgICFrZWVwUHJvICYmIGRvbVV0aWxzLnJlbW92ZUF0dHJpYnV0ZXModG1wQ2VsbCwnd2lkdGggaGVpZ2h0Jyk7XHJcbiAgICAgICAgIWtlZXBQcm8gJiYgZG9tVXRpbHMucmVtb3ZlQXR0cmlidXRlcyh0bXBDZWxsLCdzdHlsZScpO1xyXG5cclxuICAgICAgICB0bXBDZWxsLnN0eWxlLmJvcmRlckxlZnRTdHlsZSA9IFwiXCI7XHJcbiAgICAgICAgdG1wQ2VsbC5zdHlsZS5ib3JkZXJUb3BTdHlsZSA9IFwiXCI7XHJcbiAgICAgICAgdG1wQ2VsbC5zdHlsZS5ib3JkZXJMZWZ0Q29sb3IgPSBjZWxsLnN0eWxlLmJvcmRlclJpZ2h0Q29sb3I7XHJcbiAgICAgICAgdG1wQ2VsbC5zdHlsZS5ib3JkZXJMZWZ0V2lkdGggPSBjZWxsLnN0eWxlLmJvcmRlclJpZ2h0V2lkdGg7XHJcbiAgICAgICAgdG1wQ2VsbC5zdHlsZS5ib3JkZXJUb3BDb2xvciA9IGNlbGwuc3R5bGUuYm9yZGVyQm90dG9tQ29sb3I7XHJcbiAgICAgICAgdG1wQ2VsbC5zdHlsZS5ib3JkZXJUb3BXaWR0aCA9IGNlbGwuc3R5bGUuYm9yZGVyQm90dG9tV2lkdGg7XHJcbiAgICAgICAgZmxhZyAmJiBkb21VdGlscy5hZGRDbGFzcyhjZWxsLCBcInNlbGVjdFRkQ2xhc3NcIik7XHJcbiAgICAgICAgcmV0dXJuIHRtcENlbGw7XHJcbiAgICB9XHJcblxyXG4gICAgVUVUYWJsZS5wcm90b3R5cGUgPSB7XHJcbiAgICAgICAgZ2V0TWF4Um93czpmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciByb3dzID0gdGhpcy50YWJsZS5yb3dzLCBtYXhMZW4gPSAxO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgcm93OyByb3cgPSByb3dzW2ldOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciBjdXJyZW50TWF4ID0gMTtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBjajsgY2ogPSByb3cuY2VsbHNbaisrXTspIHtcclxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50TWF4ID0gTWF0aC5tYXgoY2oucm93U3BhbiB8fCAxLCBjdXJyZW50TWF4KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIG1heExlbiA9IE1hdGgubWF4KGN1cnJlbnRNYXggKyBpLCBtYXhMZW4pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBtYXhMZW47XHJcbiAgICAgICAgfSxcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDojrflj5blvZPliY3ooajmoLznmoTmnIDlpKfliJfmlbBcclxuICAgICAgICAgKi9cclxuICAgICAgICBnZXRNYXhDb2xzOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJvd3MgPSB0aGlzLnRhYmxlLnJvd3MsIG1heExlbiA9IDAsIGNlbGxSb3dzID0ge307XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCByb3c7IHJvdyA9IHJvd3NbaV07IGkrKykge1xyXG4gICAgICAgICAgICAgICAgdmFyIGNlbGxzTnVtID0gMDtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBjajsgY2ogPSByb3cuY2VsbHNbaisrXTspIHtcclxuICAgICAgICAgICAgICAgICAgICBjZWxsc051bSArPSAoY2ouY29sU3BhbiB8fCAxKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY2oucm93U3BhbiAmJiBjai5yb3dTcGFuID4gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMTsgayA8IGNqLnJvd1NwYW47IGsrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjZWxsUm93c1sncm93XycgKyAoaSArIGspXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNlbGxSb3dzWydyb3dfJyArIChpICsgayldID0gKGNqLmNvbFNwYW4gfHwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNlbGxSb3dzWydyb3dfJyArIChpICsgayldKytcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjZWxsc051bSArPSBjZWxsUm93c1sncm93XycgKyBpXSB8fCAwO1xyXG4gICAgICAgICAgICAgICAgbWF4TGVuID0gTWF0aC5tYXgoY2VsbHNOdW0sIG1heExlbik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG1heExlbjtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldENlbGxDb2xJbmRleDpmdW5jdGlvbiAoY2VsbCkge1xyXG5cclxuICAgICAgICB9LFxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOiOt+WPluW9k+WJjWNlbGzml4HovrnnmoTljZXlhYPmoLzvvIxcclxuICAgICAgICAgKiBAcGFyYW0gY2VsbFxyXG4gICAgICAgICAqIEBwYXJhbSByaWdodFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGdldEhTaWRlQ2VsbDpmdW5jdGlvbiAoY2VsbCwgcmlnaHQpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHZhciBjZWxsSW5mbyA9IHRoaXMuZ2V0Q2VsbEluZm8oY2VsbCksXHJcbiAgICAgICAgICAgICAgICAgICAgcHJldmlld1Jvd0luZGV4LCBwcmV2aWV3Q29sSW5kZXg7XHJcbiAgICAgICAgICAgICAgICB2YXIgbGVuID0gdGhpcy5zZWxlY3RlZFRkcy5sZW5ndGgsXHJcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2UgPSB0aGlzLmNlbGxzUmFuZ2U7XHJcbiAgICAgICAgICAgICAgICAvL+mmluihjOaIluiAhemmluWIl+ayoeacieWJjee9ruWNleWFg+agvFxyXG4gICAgICAgICAgICAgICAgaWYgKCghcmlnaHQgJiYgKCFsZW4gPyAhY2VsbEluZm8uY29sSW5kZXggOiAhcmFuZ2UuYmVnaW5Db2xJbmRleCkpIHx8IChyaWdodCAmJiAoIWxlbiA/IChjZWxsSW5mby5jb2xJbmRleCA9PSAodGhpcy5jb2xzTnVtIC0gMSkpIDogKHJhbmdlLmVuZENvbEluZGV4ID09IHRoaXMuY29sc051bSAtIDEpKSkpIHJldHVybiBudWxsO1xyXG5cclxuICAgICAgICAgICAgICAgIHByZXZpZXdSb3dJbmRleCA9ICFsZW4gPyBjZWxsSW5mby5yb3dJbmRleCA6IHJhbmdlLmJlZ2luUm93SW5kZXg7XHJcbiAgICAgICAgICAgICAgICBwcmV2aWV3Q29sSW5kZXggPSAhcmlnaHQgPyAoICFsZW4gPyAoY2VsbEluZm8uY29sSW5kZXggPCAxID8gMCA6IChjZWxsSW5mby5jb2xJbmRleCAtIDEpKSA6IHJhbmdlLmJlZ2luQ29sSW5kZXggLSAxKVxyXG4gICAgICAgICAgICAgICAgICAgIDogKCAhbGVuID8gY2VsbEluZm8uY29sSW5kZXggKyAxIDogcmFuZ2UuZW5kQ29sSW5kZXggKyAxKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENlbGwodGhpcy5pbmRleFRhYmxlW3ByZXZpZXdSb3dJbmRleF1bcHJldmlld0NvbEluZGV4XS5yb3dJbmRleCwgdGhpcy5pbmRleFRhYmxlW3ByZXZpZXdSb3dJbmRleF1bcHJldmlld0NvbEluZGV4XS5jZWxsSW5kZXgpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBzaG93RXJyb3IoZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldFRhYk5leHRDZWxsOmZ1bmN0aW9uIChjZWxsLCBwcmVSb3dJbmRleCkge1xyXG4gICAgICAgICAgICB2YXIgY2VsbEluZm8gPSB0aGlzLmdldENlbGxJbmZvKGNlbGwpLFxyXG4gICAgICAgICAgICAgICAgcm93SW5kZXggPSBwcmVSb3dJbmRleCB8fCBjZWxsSW5mby5yb3dJbmRleCxcclxuICAgICAgICAgICAgICAgIGNvbEluZGV4ID0gY2VsbEluZm8uY29sSW5kZXggKyAxICsgKGNlbGxJbmZvLmNvbFNwYW4gLSAxKSxcclxuICAgICAgICAgICAgICAgIG5leHRDZWxsO1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgbmV4dENlbGwgPSB0aGlzLmdldENlbGwodGhpcy5pbmRleFRhYmxlW3Jvd0luZGV4XVtjb2xJbmRleF0ucm93SW5kZXgsIHRoaXMuaW5kZXhUYWJsZVtyb3dJbmRleF1bY29sSW5kZXhdLmNlbGxJbmRleCk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcm93SW5kZXggPSByb3dJbmRleCAqIDEgKyAxO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbEluZGV4ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICBuZXh0Q2VsbCA9IHRoaXMuZ2V0Q2VsbCh0aGlzLmluZGV4VGFibGVbcm93SW5kZXhdW2NvbEluZGV4XS5yb3dJbmRleCwgdGhpcy5pbmRleFRhYmxlW3Jvd0luZGV4XVtjb2xJbmRleF0uY2VsbEluZGV4KTtcclxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gbmV4dENlbGw7XHJcblxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6I635Y+W6KeG6KeJ5LiK55qE5ZCO572u5Y2V5YWD5qC8XHJcbiAgICAgICAgICogQHBhcmFtIGNlbGxcclxuICAgICAgICAgKiBAcGFyYW0gYm90dG9tXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0VlNpZGVDZWxsOmZ1bmN0aW9uIChjZWxsLCBib3R0b20sIGlnbm9yZVJhbmdlKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgY2VsbEluZm8gPSB0aGlzLmdldENlbGxJbmZvKGNlbGwpLFxyXG4gICAgICAgICAgICAgICAgICAgIG5leHRSb3dJbmRleCwgbmV4dENvbEluZGV4O1xyXG4gICAgICAgICAgICAgICAgdmFyIGxlbiA9IHRoaXMuc2VsZWN0ZWRUZHMubGVuZ3RoICYmICFpZ25vcmVSYW5nZSxcclxuICAgICAgICAgICAgICAgICAgICByYW5nZSA9IHRoaXMuY2VsbHNSYW5nZTtcclxuICAgICAgICAgICAgICAgIC8v5pyr6KGM5oiW6ICF5pyr5YiX5rKh5pyJ5ZCO572u5Y2V5YWD5qC8XHJcbiAgICAgICAgICAgICAgICBpZiAoKCFib3R0b20gJiYgKGNlbGxJbmZvLnJvd0luZGV4ID09IDApKSB8fCAoYm90dG9tICYmICghbGVuID8gKGNlbGxJbmZvLnJvd0luZGV4ICsgY2VsbEluZm8ucm93U3BhbiA+IHRoaXMucm93c051bSAtIDEpIDogKHJhbmdlLmVuZFJvd0luZGV4ID09IHRoaXMucm93c051bSAtIDEpKSkpIHJldHVybiBudWxsO1xyXG5cclxuICAgICAgICAgICAgICAgIG5leHRSb3dJbmRleCA9ICFib3R0b20gPyAoICFsZW4gPyBjZWxsSW5mby5yb3dJbmRleCAtIDEgOiByYW5nZS5iZWdpblJvd0luZGV4IC0gMSlcclxuICAgICAgICAgICAgICAgICAgICA6ICggIWxlbiA/IChjZWxsSW5mby5yb3dJbmRleCArIGNlbGxJbmZvLnJvd1NwYW4pIDogcmFuZ2UuZW5kUm93SW5kZXggKyAxKTtcclxuICAgICAgICAgICAgICAgIG5leHRDb2xJbmRleCA9ICFsZW4gPyBjZWxsSW5mby5jb2xJbmRleCA6IHJhbmdlLmJlZ2luQ29sSW5kZXg7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDZWxsKHRoaXMuaW5kZXhUYWJsZVtuZXh0Um93SW5kZXhdW25leHRDb2xJbmRleF0ucm93SW5kZXgsIHRoaXMuaW5kZXhUYWJsZVtuZXh0Um93SW5kZXhdW25leHRDb2xJbmRleF0uY2VsbEluZGV4KTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgc2hvd0Vycm9yKGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDojrflj5bnm7jlkIznu5PmnZ/kvY3nva7nmoTljZXlhYPmoLzvvIx4T3JZ5oyH5Luj5LqG5piv6I635Y+WeOi9tOebuOWQjOi/mOaYr3novbTnm7jlkIxcclxuICAgICAgICAgKi9cclxuICAgICAgICBnZXRTYW1lRW5kUG9zQ2VsbHM6ZnVuY3Rpb24gKGNlbGwsIHhPclkpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHZhciBmbGFnID0gKHhPclkudG9Mb3dlckNhc2UoKSA9PT0gXCJ4XCIpLFxyXG4gICAgICAgICAgICAgICAgICAgIGVuZCA9IGRvbVV0aWxzLmdldFhZKGNlbGwpW2ZsYWcgPyAneCcgOiAneSddICsgY2VsbFtcIm9mZnNldFwiICsgKGZsYWcgPyAnV2lkdGgnIDogJ0hlaWdodCcpXSxcclxuICAgICAgICAgICAgICAgICAgICByb3dzID0gdGhpcy50YWJsZS5yb3dzLFxyXG4gICAgICAgICAgICAgICAgICAgIGNlbGxzID0gbnVsbCwgcmV0dXJucyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnJvd3NOdW07IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNlbGxzID0gcm93c1tpXS5jZWxscztcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgdG1wQ2VsbDsgdG1wQ2VsbCA9IGNlbGxzW2orK107KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0bXBFbmQgPSBkb21VdGlscy5nZXRYWSh0bXBDZWxsKVtmbGFnID8gJ3gnIDogJ3knXSArIHRtcENlbGxbXCJvZmZzZXRcIiArIChmbGFnID8gJ1dpZHRoJyA6ICdIZWlnaHQnKV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8v5a+55bqU6KGM55qEdGTlt7Lnu4/ooqvkuIrpnaLooYxyb3dTcGFu5LqGXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0bXBFbmQgPiBlbmQgJiYgZmxhZykgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjZWxsID09IHRtcENlbGwgfHwgZW5kID09IHRtcEVuZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy/lj6rojrflj5bljZXkuIDnmoTljZXlhYPmoLxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vdG9kbyDku4Xojrflj5bljZXkuIDljZXlhYPmoLzlnKjnibnlrprmg4XlhrXkuIvkvJrpgKDmiJByZXR1cm5z5Li656m677yM5LuO6ICM5b2x5ZON5ZCO57ut55qE5ouW5ou95a6e546w77yM5L+u5q2j6L+Z5Liq44CC6ZyA6ICD6JmR5oCn6IO9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG1wQ2VsbFtmbGFnID8gXCJjb2xTcGFuXCIgOiBcInJvd1NwYW5cIl0gPT0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybnMucHVzaCh0bXBDZWxsKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbGFnKSBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5zO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBzaG93RXJyb3IoZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIHNldENlbGxDb250ZW50OmZ1bmN0aW9uIChjZWxsLCBjb250ZW50KSB7XHJcbiAgICAgICAgICAgIGNlbGwuaW5uZXJIVE1MID0gY29udGVudCB8fCAoYnJvd3Nlci5pZSA/IGRvbVV0aWxzLmZpbGxDaGFyIDogXCI8YnIgLz5cIik7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBjbG9uZUNlbGw6VUVUYWJsZS5jbG9uZUNlbGwsXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6I635Y+W6Lef5b2T5YmN5Y2V5YWD5qC855qE5Y+z6L6556uW57q/5Li65bem6L6555qE5omA5pyJ5pyq5ZCI5bm25Y2V5YWD5qC8XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0U2FtZVN0YXJ0UG9zWENlbGxzOmZ1bmN0aW9uIChjZWxsKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgc3RhcnQgPSBkb21VdGlscy5nZXRYWShjZWxsKS54ICsgY2VsbC5vZmZzZXRXaWR0aCxcclxuICAgICAgICAgICAgICAgICAgICByb3dzID0gdGhpcy50YWJsZS5yb3dzLCBjZWxscyAsIHJldHVybnMgPSBbXTtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5yb3dzTnVtOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBjZWxscyA9IHJvd3NbaV0uY2VsbHM7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIHRtcENlbGw7IHRtcENlbGwgPSBjZWxsc1tqKytdOykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wU3RhcnQgPSBkb21VdGlscy5nZXRYWSh0bXBDZWxsKS54O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodG1wU3RhcnQgPiBzdGFydCkgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0bXBTdGFydCA9PSBzdGFydCAmJiB0bXBDZWxsLmNvbFNwYW4gPT0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJucy5wdXNoKHRtcENlbGwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmV0dXJucztcclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgc2hvd0Vycm9yKGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDmm7TmlrB0YWJsZeWvueW6lOeahOe0ouW8leihqFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHVwZGF0ZTpmdW5jdGlvbiAodGFibGUpIHtcclxuICAgICAgICAgICAgdGhpcy50YWJsZSA9IHRhYmxlIHx8IHRoaXMudGFibGU7XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRUZHMgPSBbXTtcclxuICAgICAgICAgICAgdGhpcy5jZWxsc1JhbmdlID0ge307XHJcbiAgICAgICAgICAgIHRoaXMuaW5kZXhUYWJsZSA9IFtdO1xyXG4gICAgICAgICAgICB2YXIgcm93cyA9IHRoaXMudGFibGUucm93cyxcclxuICAgICAgICAgICAgICAgIHJvd3NOdW0gPSB0aGlzLmdldE1heFJvd3MoKSxcclxuICAgICAgICAgICAgICAgIGROdW0gPSByb3dzTnVtIC0gcm93cy5sZW5ndGgsXHJcbiAgICAgICAgICAgICAgICBjb2xzTnVtID0gdGhpcy5nZXRNYXhDb2xzKCk7XHJcbiAgICAgICAgICAgIHdoaWxlIChkTnVtLS0pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudGFibGUuaW5zZXJ0Um93KHJvd3MubGVuZ3RoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnJvd3NOdW0gPSByb3dzTnVtO1xyXG4gICAgICAgICAgICB0aGlzLmNvbHNOdW0gPSBjb2xzTnVtO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gcm93cy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbmRleFRhYmxlW2ldID0gbmV3IEFycmF5KGNvbHNOdW0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8v5aGr5YWF57Si5byV6KGoXHJcbiAgICAgICAgICAgIGZvciAodmFyIHJvd0luZGV4ID0gMCwgcm93OyByb3cgPSByb3dzW3Jvd0luZGV4XTsgcm93SW5kZXgrKykge1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgY2VsbEluZGV4ID0gMCwgY2VsbCwgY2VsbHMgPSByb3cuY2VsbHM7IGNlbGwgPSBjZWxsc1tjZWxsSW5kZXhdOyBjZWxsSW5kZXgrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIC8v5L+u5q2j5pW06KGM6KKrcm93U3BhbuaXtuWvvOiHtOeahOihjOaVsOiuoeeul+mUmeivr1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjZWxsLnJvd1NwYW4gPiByb3dzTnVtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNlbGwucm93U3BhbiA9IHJvd3NOdW07XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjb2xJbmRleCA9IGNlbGxJbmRleCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcm93U3BhbiA9IGNlbGwucm93U3BhbiB8fCAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xTcGFuID0gY2VsbC5jb2xTcGFuIHx8IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgLy/lvZPlt7Lnu4/ooqvkuIrkuIDooYxyb3dTcGFu5oiW6ICF6KKr5YmN5LiA5YiXY29sU3BhbuS6hu+8jOWImei3s+WIsOS4i+S4gOS4quWNleWFg+agvOi/m+ihjFxyXG4gICAgICAgICAgICAgICAgICAgIHdoaWxlICh0aGlzLmluZGV4VGFibGVbcm93SW5kZXhdW2NvbEluZGV4XSkgY29sSW5kZXgrKztcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJvd1NwYW47IGorKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IGNvbFNwYW47IGsrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbmRleFRhYmxlW3Jvd0luZGV4ICsgal1bY29sSW5kZXggKyBrXSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3dJbmRleDpyb3dJbmRleCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZWxsSW5kZXg6Y2VsbEluZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbEluZGV4OmNvbEluZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvd1NwYW46cm93U3BhbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xTcGFuOmNvbFNwYW5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvL+S/ruWkjeaui+e8unRkXHJcbiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCByb3dzTnVtOyBqKyspIHtcclxuICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBjb2xzTnVtOyBrKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbmRleFRhYmxlW2pdW2tdID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcm93ID0gcm93c1tqXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2VsbCA9IHJvdy5jZWxsc1tyb3cuY2VsbHMubGVuZ3RoIC0gMV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNlbGwgPSBjZWxsID8gY2VsbC5jbG9uZU5vZGUodHJ1ZSkgOiB0aGlzLnRhYmxlLm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInRkXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldENlbGxDb250ZW50KGNlbGwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2VsbC5jb2xTcGFuICE9PSAxKWNlbGwuY29sU3BhbiA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjZWxsLnJvd1NwYW4gIT09IDEpY2VsbC5yb3dTcGFuID0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcm93LmFwcGVuZENoaWxkKGNlbGwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluZGV4VGFibGVbal1ba10gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3dJbmRleDpqLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VsbEluZGV4OmNlbGwuY2VsbEluZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sSW5kZXg6ayxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvd1NwYW46MSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbFNwYW46MVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8v5b2T5qGG6YCJ5ZCO5Yig6Zmk6KGM5oiW6ICF5YiX5ZCO5pKk6ZSA77yM6ZyA6KaB6YeN5bu66YCJ5Yy644CCXHJcbiAgICAgICAgICAgIHZhciB0ZHMgPSBkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZSh0aGlzLnRhYmxlLCBcInRkXCIpLFxyXG4gICAgICAgICAgICAgICAgc2VsZWN0VGRzID0gW107XHJcbiAgICAgICAgICAgIHV0aWxzLmVhY2godGRzLCBmdW5jdGlvbiAodGQpIHtcclxuICAgICAgICAgICAgICAgIGlmIChkb21VdGlscy5oYXNDbGFzcyh0ZCwgXCJzZWxlY3RUZENsYXNzXCIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0VGRzLnB1c2godGQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgaWYgKHNlbGVjdFRkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IHNlbGVjdFRkc1swXSxcclxuICAgICAgICAgICAgICAgICAgICBlbmQgPSBzZWxlY3RUZHNbc2VsZWN0VGRzLmxlbmd0aCAtIDFdLFxyXG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0SW5mbyA9IHRoaXMuZ2V0Q2VsbEluZm8oc3RhcnQpLFxyXG4gICAgICAgICAgICAgICAgICAgIGVuZEluZm8gPSB0aGlzLmdldENlbGxJbmZvKGVuZCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkVGRzID0gc2VsZWN0VGRzO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jZWxsc1JhbmdlID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGJlZ2luUm93SW5kZXg6c3RhcnRJbmZvLnJvd0luZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgIGJlZ2luQ29sSW5kZXg6c3RhcnRJbmZvLmNvbEluZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgIGVuZFJvd0luZGV4OmVuZEluZm8ucm93SW5kZXggKyBlbmRJbmZvLnJvd1NwYW4gLSAxLFxyXG4gICAgICAgICAgICAgICAgICAgIGVuZENvbEluZGV4OmVuZEluZm8uY29sSW5kZXggKyBlbmRJbmZvLmNvbFNwYW4gLSAxXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8v57uZ56ys5LiA6KGM6K6+572uZmlyc3RSb3fnmoTmoLflvI/lkI3np7As5Zyo5o6S5bqP5Zu+5qCH55qE5qC35byP5LiK5L2/55So5YiwXHJcbiAgICAgICAgICAgIGlmKCFkb21VdGlscy5oYXNDbGFzcyh0aGlzLnRhYmxlLnJvd3NbMF0sIFwiZmlyc3RSb3dcIikpIHtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLmFkZENsYXNzKHRoaXMudGFibGUucm93c1swXSwgXCJmaXJzdFJvd1wiKTtcclxuICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDE7IGk8IHRoaXMudGFibGUucm93cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZUNsYXNzZXModGhpcy50YWJsZS5yb3dzW2ldLCBcImZpcnN0Um93XCIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDojrflj5bljZXlhYPmoLznmoTntKLlvJXkv6Hmga9cclxuICAgICAgICAgKi9cclxuICAgICAgICBnZXRDZWxsSW5mbzpmdW5jdGlvbiAoY2VsbCkge1xyXG4gICAgICAgICAgICBpZiAoIWNlbGwpIHJldHVybjtcclxuICAgICAgICAgICAgdmFyIGNlbGxJbmRleCA9IGNlbGwuY2VsbEluZGV4LFxyXG4gICAgICAgICAgICAgICAgcm93SW5kZXggPSBjZWxsLnBhcmVudE5vZGUucm93SW5kZXgsXHJcbiAgICAgICAgICAgICAgICByb3dJbmZvID0gdGhpcy5pbmRleFRhYmxlW3Jvd0luZGV4XSxcclxuICAgICAgICAgICAgICAgIG51bUNvbHMgPSB0aGlzLmNvbHNOdW07XHJcbiAgICAgICAgICAgIGZvciAodmFyIGNvbEluZGV4ID0gY2VsbEluZGV4OyBjb2xJbmRleCA8IG51bUNvbHM7IGNvbEluZGV4KyspIHtcclxuICAgICAgICAgICAgICAgIHZhciBjZWxsSW5mbyA9IHJvd0luZm9bY29sSW5kZXhdO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNlbGxJbmZvLnJvd0luZGV4ID09PSByb3dJbmRleCAmJiBjZWxsSW5mby5jZWxsSW5kZXggPT09IGNlbGxJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjZWxsSW5mbztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5qC55o2u6KGM5YiX5Y+36I635Y+W5Y2V5YWD5qC8XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0Q2VsbDpmdW5jdGlvbiAocm93SW5kZXgsIGNlbGxJbmRleCkge1xyXG4gICAgICAgICAgICByZXR1cm4gcm93SW5kZXggPCB0aGlzLnJvd3NOdW0gJiYgdGhpcy50YWJsZS5yb3dzW3Jvd0luZGV4XS5jZWxsc1tjZWxsSW5kZXhdIHx8IG51bGw7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDliKDpmaTljZXlhYPmoLxcclxuICAgICAgICAgKi9cclxuICAgICAgICBkZWxldGVDZWxsOmZ1bmN0aW9uIChjZWxsLCByb3dJbmRleCkge1xyXG4gICAgICAgICAgICByb3dJbmRleCA9IHR5cGVvZiByb3dJbmRleCA9PSAnbnVtYmVyJyA/IHJvd0luZGV4IDogY2VsbC5wYXJlbnROb2RlLnJvd0luZGV4O1xyXG4gICAgICAgICAgICB2YXIgcm93ID0gdGhpcy50YWJsZS5yb3dzW3Jvd0luZGV4XTtcclxuICAgICAgICAgICAgcm93LmRlbGV0ZUNlbGwoY2VsbC5jZWxsSW5kZXgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5qC55o2u5aeL5pyr5Lik5Liq5Y2V5YWD5qC86I635Y+W6KKr5qGG6YCJ55qE5omA5pyJ5Y2V5YWD5qC86IyD5Zu0XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0Q2VsbHNSYW5nZTpmdW5jdGlvbiAoY2VsbEEsIGNlbGxCKSB7XHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrUmFuZ2UoYmVnaW5Sb3dJbmRleCwgYmVnaW5Db2xJbmRleCwgZW5kUm93SW5kZXgsIGVuZENvbEluZGV4KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdG1wQmVnaW5Sb3dJbmRleCA9IGJlZ2luUm93SW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgdG1wQmVnaW5Db2xJbmRleCA9IGJlZ2luQ29sSW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgdG1wRW5kUm93SW5kZXggPSBlbmRSb3dJbmRleCxcclxuICAgICAgICAgICAgICAgICAgICB0bXBFbmRDb2xJbmRleCA9IGVuZENvbEluZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgIGNlbGxJbmZvLCBjb2xJbmRleCwgcm93SW5kZXg7XHJcbiAgICAgICAgICAgICAgICAvLyDpgJrov4dpbmRleFRhYmxl5qOA5p+l5piv5ZCm5a2Y5Zyo6LaF5Ye6VGFibGVSYW5nZeS4iui+ueeVjOeahOaDheWGtVxyXG4gICAgICAgICAgICAgICAgaWYgKGJlZ2luUm93SW5kZXggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChjb2xJbmRleCA9IGJlZ2luQ29sSW5kZXg7IGNvbEluZGV4IDwgZW5kQ29sSW5kZXg7IGNvbEluZGV4KyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2VsbEluZm8gPSBtZS5pbmRleFRhYmxlW2JlZ2luUm93SW5kZXhdW2NvbEluZGV4XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcm93SW5kZXggPSBjZWxsSW5mby5yb3dJbmRleDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJvd0luZGV4IDwgYmVnaW5Sb3dJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wQmVnaW5Sb3dJbmRleCA9IE1hdGgubWluKHJvd0luZGV4LCB0bXBCZWdpblJvd0luZGV4KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIOmAmui/h2luZGV4VGFibGXmo4Dmn6XmmK/lkKblrZjlnKjotoXlh7pUYWJsZVJhbmdl5Y+z6L6555WM55qE5oOF5Ya1XHJcbiAgICAgICAgICAgICAgICBpZiAoZW5kQ29sSW5kZXggPCBtZS5jb2xzTnVtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChyb3dJbmRleCA9IGJlZ2luUm93SW5kZXg7IHJvd0luZGV4IDwgZW5kUm93SW5kZXg7IHJvd0luZGV4KyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2VsbEluZm8gPSBtZS5pbmRleFRhYmxlW3Jvd0luZGV4XVtlbmRDb2xJbmRleF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbEluZGV4ID0gY2VsbEluZm8uY29sSW5kZXggKyBjZWxsSW5mby5jb2xTcGFuIC0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbEluZGV4ID4gZW5kQ29sSW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcEVuZENvbEluZGV4ID0gTWF0aC5tYXgoY29sSW5kZXgsIHRtcEVuZENvbEluZGV4KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIOajgOafpeaYr+WQpuaciei2heWHulRhYmxlUmFuZ2XkuIvovrnnlYznmoTmg4XlhrVcclxuICAgICAgICAgICAgICAgIGlmIChlbmRSb3dJbmRleCA8IG1lLnJvd3NOdW0pIHtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbEluZGV4ID0gYmVnaW5Db2xJbmRleDsgY29sSW5kZXggPCBlbmRDb2xJbmRleDsgY29sSW5kZXgrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjZWxsSW5mbyA9IG1lLmluZGV4VGFibGVbZW5kUm93SW5kZXhdW2NvbEluZGV4XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcm93SW5kZXggPSBjZWxsSW5mby5yb3dJbmRleCArIGNlbGxJbmZvLnJvd1NwYW4gLSAxO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocm93SW5kZXggPiBlbmRSb3dJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wRW5kUm93SW5kZXggPSBNYXRoLm1heChyb3dJbmRleCwgdG1wRW5kUm93SW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8g5qOA5p+l5piv5ZCm5pyJ6LaF5Ye6VGFibGVSYW5nZeW3pui+ueeVjOeahOaDheWGtVxyXG4gICAgICAgICAgICAgICAgaWYgKGJlZ2luQ29sSW5kZXggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChyb3dJbmRleCA9IGJlZ2luUm93SW5kZXg7IHJvd0luZGV4IDwgZW5kUm93SW5kZXg7IHJvd0luZGV4KyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2VsbEluZm8gPSBtZS5pbmRleFRhYmxlW3Jvd0luZGV4XVtiZWdpbkNvbEluZGV4XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sSW5kZXggPSBjZWxsSW5mby5jb2xJbmRleDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbEluZGV4IDwgYmVnaW5Db2xJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wQmVnaW5Db2xJbmRleCA9IE1hdGgubWluKGNlbGxJbmZvLmNvbEluZGV4LCB0bXBCZWdpbkNvbEluZGV4KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8v6YCS5b2S6LCD55So55u06Iez5omA5pyJ5a6M5oiQ5omA5pyJ5qGG6YCJ5Y2V5YWD5qC855qE5omp5bGVXHJcbiAgICAgICAgICAgICAgICBpZiAodG1wQmVnaW5Sb3dJbmRleCAhPSBiZWdpblJvd0luZGV4IHx8IHRtcEJlZ2luQ29sSW5kZXggIT0gYmVnaW5Db2xJbmRleCB8fCB0bXBFbmRSb3dJbmRleCAhPSBlbmRSb3dJbmRleCB8fCB0bXBFbmRDb2xJbmRleCAhPSBlbmRDb2xJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjaGVja1JhbmdlKHRtcEJlZ2luUm93SW5kZXgsIHRtcEJlZ2luQ29sSW5kZXgsIHRtcEVuZFJvd0luZGV4LCB0bXBFbmRDb2xJbmRleCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOS4jemcgOimgeaJqeWxlVRhYmxlUmFuZ2XnmoTmg4XlhrVcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBiZWdpblJvd0luZGV4OmJlZ2luUm93SW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJlZ2luQ29sSW5kZXg6YmVnaW5Db2xJbmRleCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZW5kUm93SW5kZXg6ZW5kUm93SW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZENvbEluZGV4OmVuZENvbEluZGV4XHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgICAgICAgICAgICAgY2VsbEFJbmZvID0gbWUuZ2V0Q2VsbEluZm8oY2VsbEEpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNlbGxBID09PSBjZWxsQikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJlZ2luUm93SW5kZXg6Y2VsbEFJbmZvLnJvd0luZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBiZWdpbkNvbEluZGV4OmNlbGxBSW5mby5jb2xJbmRleCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZW5kUm93SW5kZXg6Y2VsbEFJbmZvLnJvd0luZGV4ICsgY2VsbEFJbmZvLnJvd1NwYW4gLSAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmRDb2xJbmRleDpjZWxsQUluZm8uY29sSW5kZXggKyBjZWxsQUluZm8uY29sU3BhbiAtIDFcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdmFyIGNlbGxCSW5mbyA9IG1lLmdldENlbGxJbmZvKGNlbGxCKTtcclxuICAgICAgICAgICAgICAgIC8vIOiuoeeul1RhYmxlUmFuZ2XnmoTlm5vkuKrovrlcclxuICAgICAgICAgICAgICAgIHZhciBiZWdpblJvd0luZGV4ID0gTWF0aC5taW4oY2VsbEFJbmZvLnJvd0luZGV4LCBjZWxsQkluZm8ucm93SW5kZXgpLFxyXG4gICAgICAgICAgICAgICAgICAgIGJlZ2luQ29sSW5kZXggPSBNYXRoLm1pbihjZWxsQUluZm8uY29sSW5kZXgsIGNlbGxCSW5mby5jb2xJbmRleCksXHJcbiAgICAgICAgICAgICAgICAgICAgZW5kUm93SW5kZXggPSBNYXRoLm1heChjZWxsQUluZm8ucm93SW5kZXggKyBjZWxsQUluZm8ucm93U3BhbiAtIDEsIGNlbGxCSW5mby5yb3dJbmRleCArIGNlbGxCSW5mby5yb3dTcGFuIC0gMSksXHJcbiAgICAgICAgICAgICAgICAgICAgZW5kQ29sSW5kZXggPSBNYXRoLm1heChjZWxsQUluZm8uY29sSW5kZXggKyBjZWxsQUluZm8uY29sU3BhbiAtIDEsIGNlbGxCSW5mby5jb2xJbmRleCArIGNlbGxCSW5mby5jb2xTcGFuIC0gMSk7XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNoZWNrUmFuZ2UoYmVnaW5Sb3dJbmRleCwgYmVnaW5Db2xJbmRleCwgZW5kUm93SW5kZXgsIGVuZENvbEluZGV4KTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgLy90aHJvdyBlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDkvp3mja5jZWxsc1Jhbmdl6I635Y+W5a+55bqU55qE5Y2V5YWD5qC86ZuG5ZCIXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0Q2VsbHM6ZnVuY3Rpb24gKHJhbmdlKSB7XHJcbiAgICAgICAgICAgIC8v5q+P5qyh6I635Y+WY2VsbHPkuYvliY3lv4XpobvlhYjmuIXpmaTkuIrmrKHnmoTpgInmi6nvvIzlkKbliJnkvJrlr7nlkI7nu63ojrflj5bmk43kvZzpgKDmiJDlvbHlk41cclxuICAgICAgICAgICAgdGhpcy5jbGVhclNlbGVjdGVkKCk7XHJcbiAgICAgICAgICAgIHZhciBiZWdpblJvd0luZGV4ID0gcmFuZ2UuYmVnaW5Sb3dJbmRleCxcclxuICAgICAgICAgICAgICAgIGJlZ2luQ29sSW5kZXggPSByYW5nZS5iZWdpbkNvbEluZGV4LFxyXG4gICAgICAgICAgICAgICAgZW5kUm93SW5kZXggPSByYW5nZS5lbmRSb3dJbmRleCxcclxuICAgICAgICAgICAgICAgIGVuZENvbEluZGV4ID0gcmFuZ2UuZW5kQ29sSW5kZXgsXHJcbiAgICAgICAgICAgICAgICBjZWxsSW5mbywgcm93SW5kZXgsIGNvbEluZGV4LCB0ZEhhc2ggPSB7fSwgcmV0dXJuVGRzID0gW107XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSBiZWdpblJvd0luZGV4OyBpIDw9IGVuZFJvd0luZGV4OyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSBiZWdpbkNvbEluZGV4OyBqIDw9IGVuZENvbEluZGV4OyBqKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBjZWxsSW5mbyA9IHRoaXMuaW5kZXhUYWJsZVtpXVtqXTtcclxuICAgICAgICAgICAgICAgICAgICByb3dJbmRleCA9IGNlbGxJbmZvLnJvd0luZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbEluZGV4ID0gY2VsbEluZm8uY29sSW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5aaC5p6cQ2VsbHPph4zlt7Lnu4/ljIXlkKvkuobmraRDZWxs5YiZ6Lez6L+HXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IHJvd0luZGV4ICsgJ3wnICsgY29sSW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRkSGFzaFtrZXldKSBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgICAgICB0ZEhhc2hba2V5XSA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJvd0luZGV4IDwgaSB8fCBjb2xJbmRleCA8IGogfHwgcm93SW5kZXggKyBjZWxsSW5mby5yb3dTcGFuIC0gMSA+IGVuZFJvd0luZGV4IHx8IGNvbEluZGV4ICsgY2VsbEluZm8uY29sU3BhbiAtIDEgPiBlbmRDb2xJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuVGRzLnB1c2godGhpcy5nZXRDZWxsKHJvd0luZGV4LCBjZWxsSW5mby5jZWxsSW5kZXgpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gcmV0dXJuVGRzO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5riF55CG5bey57uP6YCJ5Lit55qE5Y2V5YWD5qC8XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgY2xlYXJTZWxlY3RlZDpmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIFVFVGFibGUucmVtb3ZlU2VsZWN0ZWRDbGFzcyh0aGlzLnNlbGVjdGVkVGRzKTtcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFRkcyA9IFtdO1xyXG4gICAgICAgICAgICB0aGlzLmNlbGxzUmFuZ2UgPSB7fTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOagueaNrnJhbmdl6K6+572u5bey57uP6YCJ5Lit55qE5Y2V5YWD5qC8XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgc2V0U2VsZWN0ZWQ6ZnVuY3Rpb24gKHJhbmdlKSB7XHJcbiAgICAgICAgICAgIHZhciBjZWxscyA9IHRoaXMuZ2V0Q2VsbHMocmFuZ2UpO1xyXG4gICAgICAgICAgICBVRVRhYmxlLmFkZFNlbGVjdGVkQ2xhc3MoY2VsbHMpO1xyXG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkVGRzID0gY2VsbHM7XHJcbiAgICAgICAgICAgIHRoaXMuY2VsbHNSYW5nZSA9IHJhbmdlO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgaXNGdWxsUm93OmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJhbmdlID0gdGhpcy5jZWxsc1JhbmdlO1xyXG4gICAgICAgICAgICByZXR1cm4gKHJhbmdlLmVuZENvbEluZGV4IC0gcmFuZ2UuYmVnaW5Db2xJbmRleCArIDEpID09IHRoaXMuY29sc051bTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGlzRnVsbENvbDpmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciByYW5nZSA9IHRoaXMuY2VsbHNSYW5nZSxcclxuICAgICAgICAgICAgICAgIHRhYmxlID0gdGhpcy50YWJsZSxcclxuICAgICAgICAgICAgICAgIHRocyA9IHRhYmxlLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwidGhcIiksXHJcbiAgICAgICAgICAgICAgICByb3dzID0gcmFuZ2UuZW5kUm93SW5kZXggLSByYW5nZS5iZWdpblJvd0luZGV4ICsgMTtcclxuICAgICAgICAgICAgcmV0dXJuICAhdGhzLmxlbmd0aCA/IHJvd3MgPT0gdGhpcy5yb3dzTnVtIDogcm93cyA9PSB0aGlzLnJvd3NOdW0gfHwgKHJvd3MgPT0gdGhpcy5yb3dzTnVtIC0gMSk7XHJcblxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6I635Y+W6KeG6KeJ5LiK55qE5YmN572u5Y2V5YWD5qC877yM6buY6K6k5piv5bem6L6577yMdG9w5Lyg5YWl5pe2XHJcbiAgICAgICAgICogQHBhcmFtIGNlbGxcclxuICAgICAgICAgKiBAcGFyYW0gdG9wXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZ2V0TmV4dENlbGw6ZnVuY3Rpb24gKGNlbGwsIGJvdHRvbSwgaWdub3JlUmFuZ2UpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHZhciBjZWxsSW5mbyA9IHRoaXMuZ2V0Q2VsbEluZm8oY2VsbCksXHJcbiAgICAgICAgICAgICAgICAgICAgbmV4dFJvd0luZGV4LCBuZXh0Q29sSW5kZXg7XHJcbiAgICAgICAgICAgICAgICB2YXIgbGVuID0gdGhpcy5zZWxlY3RlZFRkcy5sZW5ndGggJiYgIWlnbm9yZVJhbmdlLFxyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlID0gdGhpcy5jZWxsc1JhbmdlO1xyXG4gICAgICAgICAgICAgICAgLy/mnKvooYzmiJbogIXmnKvliJfmsqHmnInlkI7nva7ljZXlhYPmoLxcclxuICAgICAgICAgICAgICAgIGlmICgoIWJvdHRvbSAmJiAoY2VsbEluZm8ucm93SW5kZXggPT0gMCkpIHx8IChib3R0b20gJiYgKCFsZW4gPyAoY2VsbEluZm8ucm93SW5kZXggKyBjZWxsSW5mby5yb3dTcGFuID4gdGhpcy5yb3dzTnVtIC0gMSkgOiAocmFuZ2UuZW5kUm93SW5kZXggPT0gdGhpcy5yb3dzTnVtIC0gMSkpKSkgcmV0dXJuIG51bGw7XHJcblxyXG4gICAgICAgICAgICAgICAgbmV4dFJvd0luZGV4ID0gIWJvdHRvbSA/ICggIWxlbiA/IGNlbGxJbmZvLnJvd0luZGV4IC0gMSA6IHJhbmdlLmJlZ2luUm93SW5kZXggLSAxKVxyXG4gICAgICAgICAgICAgICAgICAgIDogKCAhbGVuID8gKGNlbGxJbmZvLnJvd0luZGV4ICsgY2VsbEluZm8ucm93U3BhbikgOiByYW5nZS5lbmRSb3dJbmRleCArIDEpO1xyXG4gICAgICAgICAgICAgICAgbmV4dENvbEluZGV4ID0gIWxlbiA/IGNlbGxJbmZvLmNvbEluZGV4IDogcmFuZ2UuYmVnaW5Db2xJbmRleDtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENlbGwodGhpcy5pbmRleFRhYmxlW25leHRSb3dJbmRleF1bbmV4dENvbEluZGV4XS5yb3dJbmRleCwgdGhpcy5pbmRleFRhYmxlW25leHRSb3dJbmRleF1bbmV4dENvbEluZGV4XS5jZWxsSW5kZXgpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBzaG93RXJyb3IoZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldFByZXZpZXdDZWxsOmZ1bmN0aW9uIChjZWxsLCB0b3ApIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHZhciBjZWxsSW5mbyA9IHRoaXMuZ2V0Q2VsbEluZm8oY2VsbCksXHJcbiAgICAgICAgICAgICAgICAgICAgcHJldmlld1Jvd0luZGV4LCBwcmV2aWV3Q29sSW5kZXg7XHJcbiAgICAgICAgICAgICAgICB2YXIgbGVuID0gdGhpcy5zZWxlY3RlZFRkcy5sZW5ndGgsXHJcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2UgPSB0aGlzLmNlbGxzUmFuZ2U7XHJcbiAgICAgICAgICAgICAgICAvL+mmluihjOaIluiAhemmluWIl+ayoeacieWJjee9ruWNleWFg+agvFxyXG4gICAgICAgICAgICAgICAgaWYgKCghdG9wICYmICghbGVuID8gIWNlbGxJbmZvLmNvbEluZGV4IDogIXJhbmdlLmJlZ2luQ29sSW5kZXgpKSB8fCAodG9wICYmICghbGVuID8gKGNlbGxJbmZvLnJvd0luZGV4ID4gKHRoaXMuY29sc051bSAtIDEpKSA6IChyYW5nZS5lbmRDb2xJbmRleCA9PSB0aGlzLmNvbHNOdW0gLSAxKSkpKSByZXR1cm4gbnVsbDtcclxuXHJcbiAgICAgICAgICAgICAgICBwcmV2aWV3Um93SW5kZXggPSAhdG9wID8gKCAhbGVuID8gY2VsbEluZm8ucm93SW5kZXggOiByYW5nZS5iZWdpblJvd0luZGV4IClcclxuICAgICAgICAgICAgICAgICAgICA6ICggIWxlbiA/IChjZWxsSW5mby5yb3dJbmRleCA8IDEgPyAwIDogKGNlbGxJbmZvLnJvd0luZGV4IC0gMSkpIDogcmFuZ2UuYmVnaW5Sb3dJbmRleCk7XHJcbiAgICAgICAgICAgICAgICBwcmV2aWV3Q29sSW5kZXggPSAhdG9wID8gKCAhbGVuID8gKGNlbGxJbmZvLmNvbEluZGV4IDwgMSA/IDAgOiAoY2VsbEluZm8uY29sSW5kZXggLSAxKSkgOiByYW5nZS5iZWdpbkNvbEluZGV4IC0gMSlcclxuICAgICAgICAgICAgICAgICAgICA6ICggIWxlbiA/IGNlbGxJbmZvLmNvbEluZGV4IDogcmFuZ2UuZW5kQ29sSW5kZXggKyAxKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENlbGwodGhpcy5pbmRleFRhYmxlW3ByZXZpZXdSb3dJbmRleF1bcHJldmlld0NvbEluZGV4XS5yb3dJbmRleCwgdGhpcy5pbmRleFRhYmxlW3ByZXZpZXdSb3dJbmRleF1bcHJldmlld0NvbEluZGV4XS5jZWxsSW5kZXgpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBzaG93RXJyb3IoZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOenu+WKqOWNleWFg+agvOS4reeahOWGheWuuVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIG1vdmVDb250ZW50OmZ1bmN0aW9uIChjZWxsVG8sIGNlbGxGcm9tKSB7XHJcbiAgICAgICAgICAgIGlmIChVRVRhYmxlLmlzRW1wdHlCbG9jayhjZWxsRnJvbSkpIHJldHVybjtcclxuICAgICAgICAgICAgaWYgKFVFVGFibGUuaXNFbXB0eUJsb2NrKGNlbGxUbykpIHtcclxuICAgICAgICAgICAgICAgIGNlbGxUby5pbm5lckhUTUwgPSBjZWxsRnJvbS5pbm5lckhUTUw7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGNoaWxkID0gY2VsbFRvLmxhc3RDaGlsZDtcclxuICAgICAgICAgICAgaWYgKGNoaWxkLm5vZGVUeXBlID09IDMgfHwgIWR0ZC4kYmxvY2tbY2hpbGQudGFnTmFtZV0pIHtcclxuICAgICAgICAgICAgICAgIGNlbGxUby5hcHBlbmRDaGlsZChjZWxsVG8ub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCdicicpKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHdoaWxlIChjaGlsZCA9IGNlbGxGcm9tLmZpcnN0Q2hpbGQpIHtcclxuICAgICAgICAgICAgICAgIGNlbGxUby5hcHBlbmRDaGlsZChjaGlsZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOWQkeWPs+WQiOW5tuWNleWFg+agvFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIG1lcmdlUmlnaHQ6ZnVuY3Rpb24gKGNlbGwpIHtcclxuICAgICAgICAgICAgdmFyIGNlbGxJbmZvID0gdGhpcy5nZXRDZWxsSW5mbyhjZWxsKSxcclxuICAgICAgICAgICAgICAgIHJpZ2h0Q29sSW5kZXggPSBjZWxsSW5mby5jb2xJbmRleCArIGNlbGxJbmZvLmNvbFNwYW4sXHJcbiAgICAgICAgICAgICAgICByaWdodENlbGxJbmZvID0gdGhpcy5pbmRleFRhYmxlW2NlbGxJbmZvLnJvd0luZGV4XVtyaWdodENvbEluZGV4XSxcclxuICAgICAgICAgICAgICAgIHJpZ2h0Q2VsbCA9IHRoaXMuZ2V0Q2VsbChyaWdodENlbGxJbmZvLnJvd0luZGV4LCByaWdodENlbGxJbmZvLmNlbGxJbmRleCk7XHJcbiAgICAgICAgICAgIC8v5ZCI5bm2XHJcbiAgICAgICAgICAgIGNlbGwuY29sU3BhbiA9IGNlbGxJbmZvLmNvbFNwYW4gKyByaWdodENlbGxJbmZvLmNvbFNwYW47XHJcbiAgICAgICAgICAgIC8v6KKr5ZCI5bm255qE5Y2V5YWD5qC85LiN5bqU5a2Y5Zyo5a695bqm5bGe5oCnXHJcbiAgICAgICAgICAgIGNlbGwucmVtb3ZlQXR0cmlidXRlKFwid2lkdGhcIik7XHJcbiAgICAgICAgICAgIC8v56e75Yqo5YaF5a65XHJcbiAgICAgICAgICAgIHRoaXMubW92ZUNvbnRlbnQoY2VsbCwgcmlnaHRDZWxsKTtcclxuICAgICAgICAgICAgLy/liKDmjonooqvlkIjlubbnmoRDZWxsXHJcbiAgICAgICAgICAgIHRoaXMuZGVsZXRlQ2VsbChyaWdodENlbGwsIHJpZ2h0Q2VsbEluZm8ucm93SW5kZXgpO1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZSgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5ZCR5LiL5ZCI5bm25Y2V5YWD5qC8XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgbWVyZ2VEb3duOmZ1bmN0aW9uIChjZWxsKSB7XHJcbiAgICAgICAgICAgIHZhciBjZWxsSW5mbyA9IHRoaXMuZ2V0Q2VsbEluZm8oY2VsbCksXHJcbiAgICAgICAgICAgICAgICBkb3duUm93SW5kZXggPSBjZWxsSW5mby5yb3dJbmRleCArIGNlbGxJbmZvLnJvd1NwYW4sXHJcbiAgICAgICAgICAgICAgICBkb3duQ2VsbEluZm8gPSB0aGlzLmluZGV4VGFibGVbZG93blJvd0luZGV4XVtjZWxsSW5mby5jb2xJbmRleF0sXHJcbiAgICAgICAgICAgICAgICBkb3duQ2VsbCA9IHRoaXMuZ2V0Q2VsbChkb3duQ2VsbEluZm8ucm93SW5kZXgsIGRvd25DZWxsSW5mby5jZWxsSW5kZXgpO1xyXG4gICAgICAgICAgICBjZWxsLnJvd1NwYW4gPSBjZWxsSW5mby5yb3dTcGFuICsgZG93bkNlbGxJbmZvLnJvd1NwYW47XHJcbiAgICAgICAgICAgIGNlbGwucmVtb3ZlQXR0cmlidXRlKFwiaGVpZ2h0XCIpO1xyXG4gICAgICAgICAgICB0aGlzLm1vdmVDb250ZW50KGNlbGwsIGRvd25DZWxsKTtcclxuICAgICAgICAgICAgdGhpcy5kZWxldGVDZWxsKGRvd25DZWxsLCBkb3duQ2VsbEluZm8ucm93SW5kZXgpO1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZSgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5ZCI5bm25pW05LiqcmFuZ2XkuK3nmoTlhoXlrrlcclxuICAgICAgICAgKi9cclxuICAgICAgICBtZXJnZVJhbmdlOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgLy/nlLHkuo7lkIjlubbmk43kvZzlj6/ku6XlnKjku7vmhI/ml7bliLvov5vooYzvvIzmiYDku6Xml6Dms5XpgJrov4fpvKDmoIfkvY3nva7nrYnkv6Hmga/lrp7ml7bnlJ/miJByYW5nZe+8jOWPquiDvemAmui/h+e8k+WtmOWunuS+i+S4reeahGNlbGxzUmFuZ2Xlr7nosaHmnaXorr/pl65cclxuICAgICAgICAgICAgdmFyIHJhbmdlID0gdGhpcy5jZWxsc1JhbmdlLFxyXG4gICAgICAgICAgICAgICAgbGVmdFRvcENlbGwgPSB0aGlzLmdldENlbGwocmFuZ2UuYmVnaW5Sb3dJbmRleCwgdGhpcy5pbmRleFRhYmxlW3JhbmdlLmJlZ2luUm93SW5kZXhdW3JhbmdlLmJlZ2luQ29sSW5kZXhdLmNlbGxJbmRleCk7XHJcblxyXG4gICAgICAgICAgICBpZiAobGVmdFRvcENlbGwudGFnTmFtZSA9PSBcIlRIXCIgJiYgcmFuZ2UuZW5kUm93SW5kZXggIT09IHJhbmdlLmJlZ2luUm93SW5kZXgpIHtcclxuICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuaW5kZXhUYWJsZSxcclxuICAgICAgICAgICAgICAgICAgICBpbmZvID0gdGhpcy5nZXRDZWxsSW5mbyhsZWZ0VG9wQ2VsbCk7XHJcbiAgICAgICAgICAgICAgICBsZWZ0VG9wQ2VsbCA9IHRoaXMuZ2V0Q2VsbCgxLCBpbmRleFsxXVtpbmZvLmNvbEluZGV4XS5jZWxsSW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgcmFuZ2UgPSB0aGlzLmdldENlbGxzUmFuZ2UobGVmdFRvcENlbGwsIHRoaXMuZ2V0Q2VsbChpbmRleFt0aGlzLnJvd3NOdW0gLSAxXVtpbmZvLmNvbEluZGV4XS5yb3dJbmRleCwgaW5kZXhbdGhpcy5yb3dzTnVtIC0gMV1baW5mby5jb2xJbmRleF0uY2VsbEluZGV4KSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIOWIoOmZpOWJqeS9meeahENlbGxzXHJcbiAgICAgICAgICAgIHZhciBjZWxscyA9IHRoaXMuZ2V0Q2VsbHMocmFuZ2UpO1xyXG4gICAgICAgICAgICBmb3IodmFyIGk9IDAsY2k7Y2k9Y2VsbHNbaSsrXTspe1xyXG4gICAgICAgICAgICAgICAgaWYgKGNpICE9PSBsZWZ0VG9wQ2VsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubW92ZUNvbnRlbnQobGVmdFRvcENlbGwsIGNpKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRlbGV0ZUNlbGwoY2kpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIOS/ruaUueW3puS4iuinkkNlbGznmoRyb3dTcGFu5ZKMY29sU3Bhbu+8jOW5tuiwg+aVtOWuveW6puWxnuaAp+iuvue9rlxyXG4gICAgICAgICAgICBsZWZ0VG9wQ2VsbC5yb3dTcGFuID0gcmFuZ2UuZW5kUm93SW5kZXggLSByYW5nZS5iZWdpblJvd0luZGV4ICsgMTtcclxuICAgICAgICAgICAgbGVmdFRvcENlbGwucm93U3BhbiA+IDEgJiYgbGVmdFRvcENlbGwucmVtb3ZlQXR0cmlidXRlKFwiaGVpZ2h0XCIpO1xyXG4gICAgICAgICAgICBsZWZ0VG9wQ2VsbC5jb2xTcGFuID0gcmFuZ2UuZW5kQ29sSW5kZXggLSByYW5nZS5iZWdpbkNvbEluZGV4ICsgMTtcclxuICAgICAgICAgICAgbGVmdFRvcENlbGwuY29sU3BhbiA+IDEgJiYgbGVmdFRvcENlbGwucmVtb3ZlQXR0cmlidXRlKFwid2lkdGhcIik7XHJcbiAgICAgICAgICAgIGlmIChsZWZ0VG9wQ2VsbC5yb3dTcGFuID09IHRoaXMucm93c051bSAmJiBsZWZ0VG9wQ2VsbC5jb2xTcGFuICE9IDEpIHtcclxuICAgICAgICAgICAgICAgIGxlZnRUb3BDZWxsLmNvbFNwYW4gPSAxO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAobGVmdFRvcENlbGwuY29sU3BhbiA9PSB0aGlzLmNvbHNOdW0gJiYgbGVmdFRvcENlbGwucm93U3BhbiAhPSAxKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcm93SW5kZXggPSBsZWZ0VG9wQ2VsbC5wYXJlbnROb2RlLnJvd0luZGV4O1xyXG4gICAgICAgICAgICAgICAgLy/op6PlhrNJReS4i+eahOihqOagvOaTjeS9nOmXrumimFxyXG4gICAgICAgICAgICAgICAgaWYoIHRoaXMudGFibGUuZGVsZXRlUm93ICkge1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSByb3dJbmRleCsgMSwgY3VySW5kZXg9cm93SW5kZXgrIDEsIGxlbj1sZWZ0VG9wQ2VsbC5yb3dTcGFuOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50YWJsZS5kZWxldGVSb3coY3VySW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbj1sZWZ0VG9wQ2VsbC5yb3dTcGFuIC0gMTsgaSA8IGxlbjsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByb3cgPSB0aGlzLnRhYmxlLnJvd3Nbcm93SW5kZXggKyAxXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcm93LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocm93KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBsZWZ0VG9wQ2VsbC5yb3dTcGFuID0gMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZSgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5o+S5YWl5LiA6KGM5Y2V5YWD5qC8XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgaW5zZXJ0Um93OmZ1bmN0aW9uIChyb3dJbmRleCwgc291cmNlQ2VsbCkge1xyXG4gICAgICAgICAgICB2YXIgbnVtQ29scyA9IHRoaXMuY29sc051bSxcclxuICAgICAgICAgICAgICAgIHRhYmxlID0gdGhpcy50YWJsZSxcclxuICAgICAgICAgICAgICAgIHJvdyA9IHRhYmxlLmluc2VydFJvdyhyb3dJbmRleCksIGNlbGwsXHJcbiAgICAgICAgICAgICAgICBpc0luc2VydFRpdGxlID0gdHlwZW9mIHNvdXJjZUNlbGwgPT0gJ3N0cmluZycgJiYgc291cmNlQ2VsbC50b1VwcGVyQ2FzZSgpID09ICdUSCc7XHJcblxyXG4gICAgICAgICAgICBmdW5jdGlvbiByZXBsYWNlVGRUb1RoKGNvbEluZGV4LCBjZWxsLCB0YWJsZVJvdykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvbEluZGV4ID09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgdHIgPSB0YWJsZVJvdy5uZXh0U2libGluZyB8fCB0YWJsZVJvdy5wcmV2aW91c1NpYmxpbmcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoID0gdHIuY2VsbHNbY29sSW5kZXhdO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aC50YWdOYW1lID09ICdUSCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGggPSBjZWxsLm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInRoXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aC5hcHBlbmRDaGlsZChjZWxsLmZpcnN0Q2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWJsZVJvdy5pbnNlcnRCZWZvcmUodGgsIGNlbGwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoY2VsbClcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY2VsbC50YWdOYW1lID09ICdUSCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRkID0gY2VsbC5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJ0ZFwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGQuYXBwZW5kQ2hpbGQoY2VsbC5maXJzdENoaWxkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVSb3cuaW5zZXJ0QmVmb3JlKHRkLCBjZWxsKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKGNlbGwpXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvL+mmluihjOebtOaOpeaPkuWFpSzml6DpnIDogIPomZHpg6jliIbljZXlhYPmoLzooqtyb3dzcGFu55qE5oOF5Ya1XHJcbiAgICAgICAgICAgIGlmIChyb3dJbmRleCA9PSAwIHx8IHJvd0luZGV4ID09IHRoaXMucm93c051bSkge1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgY29sSW5kZXggPSAwOyBjb2xJbmRleCA8IG51bUNvbHM7IGNvbEluZGV4KyspIHtcclxuICAgICAgICAgICAgICAgICAgICBjZWxsID0gdGhpcy5jbG9uZUNlbGwoc291cmNlQ2VsbCwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDZWxsQ29udGVudChjZWxsKTtcclxuICAgICAgICAgICAgICAgICAgICBjZWxsLmdldEF0dHJpYnV0ZSgndkFsaWduJykgJiYgY2VsbC5zZXRBdHRyaWJ1dGUoJ3ZBbGlnbicsIGNlbGwuZ2V0QXR0cmlidXRlKCd2QWxpZ24nKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcm93LmFwcGVuZENoaWxkKGNlbGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKCFpc0luc2VydFRpdGxlKSByZXBsYWNlVGRUb1RoKGNvbEluZGV4LCBjZWxsLCByb3cpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIGluZm9Sb3cgPSB0aGlzLmluZGV4VGFibGVbcm93SW5kZXhdLFxyXG4gICAgICAgICAgICAgICAgICAgIGNlbGxJbmRleCA9IDA7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGNvbEluZGV4ID0gMDsgY29sSW5kZXggPCBudW1Db2xzOyBjb2xJbmRleCsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNlbGxJbmZvID0gaW5mb1Jvd1tjb2xJbmRleF07XHJcbiAgICAgICAgICAgICAgICAgICAgLy/lpoLmnpzlrZjlnKjmn5DkuKrljZXlhYPmoLznmoRyb3dzcGFu56m/6L+H5b6F5o+S5YWl6KGM55qE5L2N572u77yM5YiZ5L+u5pS56K+l5Y2V5YWD5qC855qEcm93c3BhbuWNs+WPr++8jOaXoOmcgOaPkuWFpeWNleWFg+agvFxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjZWxsSW5mby5yb3dJbmRleCA8IHJvd0luZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNlbGwgPSB0aGlzLmdldENlbGwoY2VsbEluZm8ucm93SW5kZXgsIGNlbGxJbmZvLmNlbGxJbmRleCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNlbGwucm93U3BhbiA9IGNlbGxJbmZvLnJvd1NwYW4gKyAxO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNlbGwgPSB0aGlzLmNsb25lQ2VsbChzb3VyY2VDZWxsLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDZWxsQ29udGVudChjZWxsKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcm93LmFwcGVuZENoaWxkKGNlbGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZighaXNJbnNlcnRUaXRsZSkgcmVwbGFjZVRkVG9UaChjb2xJbmRleCwgY2VsbCwgcm93KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvL+ahhumAieaXtuaPkuWFpeS4jeinpuWPkWNvbnRlbnRjaGFuZ2XvvIzpnIDopoHmiYvliqjmm7TmlrDntKLlvJXjgIJcclxuICAgICAgICAgICAgdGhpcy51cGRhdGUoKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJvdztcclxuICAgICAgICB9LFxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOWIoOmZpOS4gOihjOWNleWFg+agvFxyXG4gICAgICAgICAqIEBwYXJhbSByb3dJbmRleFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGRlbGV0ZVJvdzpmdW5jdGlvbiAocm93SW5kZXgpIHtcclxuICAgICAgICAgICAgdmFyIHJvdyA9IHRoaXMudGFibGUucm93c1tyb3dJbmRleF0sXHJcbiAgICAgICAgICAgICAgICBpbmZvUm93ID0gdGhpcy5pbmRleFRhYmxlW3Jvd0luZGV4XSxcclxuICAgICAgICAgICAgICAgIGNvbHNOdW0gPSB0aGlzLmNvbHNOdW0sXHJcbiAgICAgICAgICAgICAgICBjb3VudCA9IDA7ICAgICAvL+WkhOeQhuiuoeaVsFxyXG4gICAgICAgICAgICBmb3IgKHZhciBjb2xJbmRleCA9IDA7IGNvbEluZGV4IDwgY29sc051bTspIHtcclxuICAgICAgICAgICAgICAgIHZhciBjZWxsSW5mbyA9IGluZm9Sb3dbY29sSW5kZXhdLFxyXG4gICAgICAgICAgICAgICAgICAgIGNlbGwgPSB0aGlzLmdldENlbGwoY2VsbEluZm8ucm93SW5kZXgsIGNlbGxJbmZvLmNlbGxJbmRleCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2VsbC5yb3dTcGFuID4gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjZWxsSW5mby5yb3dJbmRleCA9PSByb3dJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSBjZWxsLmNsb25lTm9kZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xvbmUucm93U3BhbiA9IGNlbGwucm93U3BhbiAtIDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsb25lLmlubmVySFRNTCA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNlbGwucm93U3BhbiA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXh0Um93SW5kZXggPSByb3dJbmRleCArIDEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0Um93ID0gdGhpcy50YWJsZS5yb3dzW25leHRSb3dJbmRleF0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnNlcnRDZWxsSW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVNZXJnZWQgPSB0aGlzLmdldFByZXZpZXdNZXJnZWRDZWxsc051bShuZXh0Um93SW5kZXgsIGNvbEluZGV4KSAtIGNvdW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJlTWVyZ2VkIDwgY29sSW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydENlbGxJbmRleCA9IGNvbEluZGV4IC0gcHJlTWVyZ2VkIC0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vbmV4dFJvdy5pbnNlcnRDZWxsKGluc2VydENlbGxJbmRleCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5pbnNlcnRBZnRlcihuZXh0Um93LmNlbGxzW2luc2VydENlbGxJbmRleF0sIGNsb25lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0Um93LmNlbGxzLmxlbmd0aCkgbmV4dFJvdy5pbnNlcnRCZWZvcmUoY2xvbmUsIG5leHRSb3cuY2VsbHNbMF0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgY291bnQgKz0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy9jZWxsLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoY2VsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29sSW5kZXggKz0gY2VsbC5jb2xTcGFuIHx8IDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGRlbGV0ZVRkcyA9IFtdLCBjYWNoZU1hcCA9IHt9O1xyXG4gICAgICAgICAgICBmb3IgKGNvbEluZGV4ID0gMDsgY29sSW5kZXggPCBjb2xzTnVtOyBjb2xJbmRleCsrKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdG1wUm93SW5kZXggPSBpbmZvUm93W2NvbEluZGV4XS5yb3dJbmRleCxcclxuICAgICAgICAgICAgICAgICAgICB0bXBDZWxsSW5kZXggPSBpbmZvUm93W2NvbEluZGV4XS5jZWxsSW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAga2V5ID0gdG1wUm93SW5kZXggKyBcIl9cIiArIHRtcENlbGxJbmRleDtcclxuICAgICAgICAgICAgICAgIGlmIChjYWNoZU1hcFtrZXldKWNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgY2FjaGVNYXBba2V5XSA9IDE7XHJcbiAgICAgICAgICAgICAgICBjZWxsID0gdGhpcy5nZXRDZWxsKHRtcFJvd0luZGV4LCB0bXBDZWxsSW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlVGRzLnB1c2goY2VsbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIG1lcmdlVGRzID0gW107XHJcbiAgICAgICAgICAgIHV0aWxzLmVhY2goZGVsZXRlVGRzLCBmdW5jdGlvbiAodGQpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0ZC5yb3dTcGFuID09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICB0ZC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRkKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWVyZ2VUZHMucHVzaCh0ZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB1dGlscy5lYWNoKG1lcmdlVGRzLCBmdW5jdGlvbiAodGQpIHtcclxuICAgICAgICAgICAgICAgIHRkLnJvd1NwYW4tLTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJvdy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHJvdyk7XHJcbiAgICAgICAgICAgIC8v5rWP6KeI5Zmo5pa55rOV5pys6Lqr5a2Y5ZyoYnVnLOmHh+eUqOiHquWumuS5ieaWueazleWIoOmZpFxyXG4gICAgICAgICAgICAvL3RoaXMudGFibGUuZGVsZXRlUm93KHJvd0luZGV4KTtcclxuICAgICAgICAgICAgdGhpcy51cGRhdGUoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGluc2VydENvbDpmdW5jdGlvbiAoY29sSW5kZXgsIHNvdXJjZUNlbGwsIGRlZmF1bHRWYWx1ZSkge1xyXG4gICAgICAgICAgICB2YXIgcm93c051bSA9IHRoaXMucm93c051bSxcclxuICAgICAgICAgICAgICAgIHJvd0luZGV4ID0gMCxcclxuICAgICAgICAgICAgICAgIHRhYmxlUm93LCBjZWxsLFxyXG4gICAgICAgICAgICAgICAgYmFja1dpZHRoID0gcGFyc2VJbnQoKHRoaXMudGFibGUub2Zmc2V0V2lkdGggLSAodGhpcy5jb2xzTnVtICsgMSkgKiAyMCAtICh0aGlzLmNvbHNOdW0gKyAxKSkgLyAodGhpcy5jb2xzTnVtICsgMSksIDEwKSxcclxuICAgICAgICAgICAgICAgIGlzSW5zZXJ0VGl0bGVDb2wgPSB0eXBlb2Ygc291cmNlQ2VsbCA9PSAnc3RyaW5nJyAmJiBzb3VyY2VDZWxsLnRvVXBwZXJDYXNlKCkgPT0gJ1RIJztcclxuXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIHJlcGxhY2VUZFRvVGgocm93SW5kZXgsIGNlbGwsIHRhYmxlUm93KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAocm93SW5kZXggPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB0aCA9IGNlbGwubmV4dFNpYmxpbmcgfHwgY2VsbC5wcmV2aW91c1NpYmxpbmc7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoLnRhZ05hbWUgPT0gJ1RIJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aCA9IGNlbGwub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KFwidGhcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoLmFwcGVuZENoaWxkKGNlbGwuZmlyc3RDaGlsZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlUm93Lmluc2VydEJlZm9yZSh0aCwgY2VsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShjZWxsKVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjZWxsLnRhZ05hbWUgPT0gJ1RIJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGQgPSBjZWxsLm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInRkXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZC5hcHBlbmRDaGlsZChjZWxsLmZpcnN0Q2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWJsZVJvdy5pbnNlcnRCZWZvcmUodGQsIGNlbGwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoY2VsbClcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHZhciBwcmVDZWxsO1xyXG4gICAgICAgICAgICBpZiAoY29sSW5kZXggPT0gMCB8fCBjb2xJbmRleCA9PSB0aGlzLmNvbHNOdW0pIHtcclxuICAgICAgICAgICAgICAgIGZvciAoOyByb3dJbmRleCA8IHJvd3NOdW07IHJvd0luZGV4KyspIHtcclxuICAgICAgICAgICAgICAgICAgICB0YWJsZVJvdyA9IHRoaXMudGFibGUucm93c1tyb3dJbmRleF07XHJcbiAgICAgICAgICAgICAgICAgICAgcHJlQ2VsbCA9IHRhYmxlUm93LmNlbGxzW2NvbEluZGV4ID09IDAgPyBjb2xJbmRleCA6IHRhYmxlUm93LmNlbGxzLmxlbmd0aF07XHJcbiAgICAgICAgICAgICAgICAgICAgY2VsbCA9IHRoaXMuY2xvbmVDZWxsKHNvdXJjZUNlbGwsIHRydWUpOyAvL3RhYmxlUm93Lmluc2VydENlbGwoY29sSW5kZXggPT0gMCA/IGNvbEluZGV4IDogdGFibGVSb3cuY2VsbHMubGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldENlbGxDb250ZW50KGNlbGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNlbGwuc2V0QXR0cmlidXRlKCd2QWxpZ24nLCBjZWxsLmdldEF0dHJpYnV0ZSgndkFsaWduJykpO1xyXG4gICAgICAgICAgICAgICAgICAgIHByZUNlbGwgJiYgY2VsbC5zZXRBdHRyaWJ1dGUoJ3dpZHRoJywgcHJlQ2VsbC5nZXRBdHRyaWJ1dGUoJ3dpZHRoJykpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghY29sSW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVSb3cuaW5zZXJ0QmVmb3JlKGNlbGwsIHRhYmxlUm93LmNlbGxzWzBdKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5pbnNlcnRBZnRlcih0YWJsZVJvdy5jZWxsc1t0YWJsZVJvdy5jZWxscy5sZW5ndGggLSAxXSwgY2VsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmKCFpc0luc2VydFRpdGxlQ29sKSByZXBsYWNlVGRUb1RoKHJvd0luZGV4LCBjZWxsLCB0YWJsZVJvdylcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGZvciAoOyByb3dJbmRleCA8IHJvd3NOdW07IHJvd0luZGV4KyspIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgY2VsbEluZm8gPSB0aGlzLmluZGV4VGFibGVbcm93SW5kZXhdW2NvbEluZGV4XTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY2VsbEluZm8uY29sSW5kZXggPCBjb2xJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjZWxsID0gdGhpcy5nZXRDZWxsKGNlbGxJbmZvLnJvd0luZGV4LCBjZWxsSW5mby5jZWxsSW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjZWxsLmNvbFNwYW4gPSBjZWxsSW5mby5jb2xTcGFuICsgMTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWJsZVJvdyA9IHRoaXMudGFibGUucm93c1tyb3dJbmRleF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZUNlbGwgPSB0YWJsZVJvdy5jZWxsc1tjZWxsSW5mby5jZWxsSW5kZXhdO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgY2VsbCA9IHRoaXMuY2xvbmVDZWxsKHNvdXJjZUNlbGwsIHRydWUpOy8vdGFibGVSb3cuaW5zZXJ0Q2VsbChjZWxsSW5mby5jZWxsSW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldENlbGxDb250ZW50KGNlbGwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjZWxsLnNldEF0dHJpYnV0ZSgndkFsaWduJywgY2VsbC5nZXRBdHRyaWJ1dGUoJ3ZBbGlnbicpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJlQ2VsbCAmJiBjZWxsLnNldEF0dHJpYnV0ZSgnd2lkdGgnLCBwcmVDZWxsLmdldEF0dHJpYnV0ZSgnd2lkdGgnKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8v6Ziy5q2iSUXkuIvmiqXplJlcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJlQ2VsbCA/IHRhYmxlUm93Lmluc2VydEJlZm9yZShjZWxsLCBwcmVDZWxsKSA6IHRhYmxlUm93LmFwcGVuZENoaWxkKGNlbGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZighaXNJbnNlcnRUaXRsZUNvbCkgcmVwbGFjZVRkVG9UaChyb3dJbmRleCwgY2VsbCwgdGFibGVSb3cpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8v5qGG6YCJ5pe25o+S5YWl5LiN6Kem5Y+RY29udGVudGNoYW5nZe+8jOmcgOimgeaJi+WKqOabtOaWsOe0ouW8lVxyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZSgpO1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVdpZHRoKGJhY2tXaWR0aCwgZGVmYXVsdFZhbHVlIHx8IHt0ZFBhZGRpbmc6MTAsIHRkQm9yZGVyOjF9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHVwZGF0ZVdpZHRoOmZ1bmN0aW9uICh3aWR0aCwgZGVmYXVsdFZhbHVlKSB7XHJcbiAgICAgICAgICAgIHZhciB0YWJsZSA9IHRoaXMudGFibGUsXHJcbiAgICAgICAgICAgICAgICB0bXBXaWR0aCA9IFVFVGFibGUuZ2V0V2lkdGgodGFibGUpIC0gZGVmYXVsdFZhbHVlLnRkUGFkZGluZyAqIDIgLSBkZWZhdWx0VmFsdWUudGRCb3JkZXIgKyB3aWR0aDtcclxuICAgICAgICAgICAgaWYgKHRtcFdpZHRoIDwgdGFibGUub3duZXJEb2N1bWVudC5ib2R5Lm9mZnNldFdpZHRoKSB7XHJcbiAgICAgICAgICAgICAgICB0YWJsZS5zZXRBdHRyaWJ1dGUoXCJ3aWR0aFwiLCB0bXBXaWR0aCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHRkcyA9IGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRoaXMudGFibGUsIFwidGQgdGhcIik7XHJcbiAgICAgICAgICAgIHV0aWxzLmVhY2godGRzLCBmdW5jdGlvbiAodGQpIHtcclxuICAgICAgICAgICAgICAgIHRkLnNldEF0dHJpYnV0ZShcIndpZHRoXCIsIHdpZHRoKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9LFxyXG4gICAgICAgIGRlbGV0ZUNvbDpmdW5jdGlvbiAoY29sSW5kZXgpIHtcclxuICAgICAgICAgICAgdmFyIGluZGV4VGFibGUgPSB0aGlzLmluZGV4VGFibGUsXHJcbiAgICAgICAgICAgICAgICB0YWJsZVJvd3MgPSB0aGlzLnRhYmxlLnJvd3MsXHJcbiAgICAgICAgICAgICAgICBiYWNrVGFibGVXaWR0aCA9IHRoaXMudGFibGUuZ2V0QXR0cmlidXRlKFwid2lkdGhcIiksXHJcbiAgICAgICAgICAgICAgICBiYWNrVGRXaWR0aCA9IDAsXHJcbiAgICAgICAgICAgICAgICByb3dzTnVtID0gdGhpcy5yb3dzTnVtLFxyXG4gICAgICAgICAgICAgICAgY2FjaGVNYXAgPSB7fTtcclxuICAgICAgICAgICAgZm9yICh2YXIgcm93SW5kZXggPSAwOyByb3dJbmRleCA8IHJvd3NOdW07KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgaW5mb1JvdyA9IGluZGV4VGFibGVbcm93SW5kZXhdLFxyXG4gICAgICAgICAgICAgICAgICAgIGNlbGxJbmZvID0gaW5mb1Jvd1tjb2xJbmRleF0sXHJcbiAgICAgICAgICAgICAgICAgICAga2V5ID0gY2VsbEluZm8ucm93SW5kZXggKyAnXycgKyBjZWxsSW5mby5jb2xJbmRleDtcclxuICAgICAgICAgICAgICAgIC8vIOi3s+i/h+W3sue7j+WkhOeQhui/h+eahENlbGxcclxuICAgICAgICAgICAgICAgIGlmIChjYWNoZU1hcFtrZXldKWNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgY2FjaGVNYXBba2V5XSA9IDE7XHJcbiAgICAgICAgICAgICAgICB2YXIgY2VsbCA9IHRoaXMuZ2V0Q2VsbChjZWxsSW5mby5yb3dJbmRleCwgY2VsbEluZm8uY2VsbEluZGV4KTtcclxuICAgICAgICAgICAgICAgIGlmICghYmFja1RkV2lkdGgpIGJhY2tUZFdpZHRoID0gY2VsbCAmJiBwYXJzZUludChjZWxsLm9mZnNldFdpZHRoIC8gY2VsbC5jb2xTcGFuLCAxMCkudG9GaXhlZCgwKTtcclxuICAgICAgICAgICAgICAgIC8vIOWmguaenENlbGznmoRjb2xTcGFu5aSn5LqOMSwg5bCx5L+u5pS5Y29sU3Bhbiwg5ZCm5YiZ5bCx5Yig5o6J6L+Z5LiqQ2VsbFxyXG4gICAgICAgICAgICAgICAgaWYgKGNlbGwuY29sU3BhbiA+IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICBjZWxsLmNvbFNwYW4tLTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGFibGVSb3dzW3Jvd0luZGV4XS5kZWxldGVDZWxsKGNlbGxJbmZvLmNlbGxJbmRleCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByb3dJbmRleCArPSBjZWxsSW5mby5yb3dTcGFuIHx8IDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy50YWJsZS5zZXRBdHRyaWJ1dGUoXCJ3aWR0aFwiLCBiYWNrVGFibGVXaWR0aCAtIGJhY2tUZFdpZHRoKTtcclxuICAgICAgICAgICAgdGhpcy51cGRhdGUoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNwbGl0VG9DZWxsczpmdW5jdGlvbiAoY2VsbCkge1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzLFxyXG4gICAgICAgICAgICAgICAgY2VsbHMgPSB0aGlzLnNwbGl0VG9Sb3dzKGNlbGwpO1xyXG4gICAgICAgICAgICB1dGlscy5lYWNoKGNlbGxzLCBmdW5jdGlvbiAoY2VsbCkge1xyXG4gICAgICAgICAgICAgICAgbWUuc3BsaXRUb0NvbHMoY2VsbCk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSxcclxuICAgICAgICBzcGxpdFRvUm93czpmdW5jdGlvbiAoY2VsbCkge1xyXG4gICAgICAgICAgICB2YXIgY2VsbEluZm8gPSB0aGlzLmdldENlbGxJbmZvKGNlbGwpLFxyXG4gICAgICAgICAgICAgICAgcm93SW5kZXggPSBjZWxsSW5mby5yb3dJbmRleCxcclxuICAgICAgICAgICAgICAgIGNvbEluZGV4ID0gY2VsbEluZm8uY29sSW5kZXgsXHJcbiAgICAgICAgICAgICAgICByZXN1bHRzID0gW107XHJcbiAgICAgICAgICAgIC8vIOS/ruaUuUNlbGznmoRyb3dTcGFuXHJcbiAgICAgICAgICAgIGNlbGwucm93U3BhbiA9IDE7XHJcbiAgICAgICAgICAgIHJlc3VsdHMucHVzaChjZWxsKTtcclxuICAgICAgICAgICAgLy8g6KGl6b2Q5Y2V5YWD5qC8XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSByb3dJbmRleCwgZW5kUm93ID0gcm93SW5kZXggKyBjZWxsSW5mby5yb3dTcGFuOyBpIDwgZW5kUm93OyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGlmIChpID09IHJvd0luZGV4KWNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgdmFyIHRhYmxlUm93ID0gdGhpcy50YWJsZS5yb3dzW2ldLFxyXG4gICAgICAgICAgICAgICAgICAgIHRtcENlbGwgPSB0YWJsZVJvdy5pbnNlcnRDZWxsKGNvbEluZGV4IC0gdGhpcy5nZXRQcmV2aWV3TWVyZ2VkQ2VsbHNOdW0oaSwgY29sSW5kZXgpKTtcclxuICAgICAgICAgICAgICAgIHRtcENlbGwuY29sU3BhbiA9IGNlbGxJbmZvLmNvbFNwYW47XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldENlbGxDb250ZW50KHRtcENlbGwpO1xyXG4gICAgICAgICAgICAgICAgdG1wQ2VsbC5zZXRBdHRyaWJ1dGUoJ3ZBbGlnbicsIGNlbGwuZ2V0QXR0cmlidXRlKCd2QWxpZ24nKSk7XHJcbiAgICAgICAgICAgICAgICB0bXBDZWxsLnNldEF0dHJpYnV0ZSgnYWxpZ24nLCBjZWxsLmdldEF0dHJpYnV0ZSgnYWxpZ24nKSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2VsbC5zdHlsZS5jc3NUZXh0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdG1wQ2VsbC5zdHlsZS5jc3NUZXh0ID0gY2VsbC5zdHlsZS5jc3NUZXh0O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHRtcENlbGwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlKCk7XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHRzO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0UHJldmlld01lcmdlZENlbGxzTnVtOmZ1bmN0aW9uIChyb3dJbmRleCwgY29sSW5kZXgpIHtcclxuICAgICAgICAgICAgdmFyIGluZGV4Um93ID0gdGhpcy5pbmRleFRhYmxlW3Jvd0luZGV4XSxcclxuICAgICAgICAgICAgICAgIG51bSA9IDA7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY29sSW5kZXg7KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgY29sU3BhbiA9IGluZGV4Um93W2ldLmNvbFNwYW4sXHJcbiAgICAgICAgICAgICAgICAgICAgdG1wUm93SW5kZXggPSBpbmRleFJvd1tpXS5yb3dJbmRleDtcclxuICAgICAgICAgICAgICAgIG51bSArPSAoY29sU3BhbiAtICh0bXBSb3dJbmRleCA9PSByb3dJbmRleCA/IDEgOiAwKSk7XHJcbiAgICAgICAgICAgICAgICBpICs9IGNvbFNwYW47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG51bTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNwbGl0VG9Db2xzOmZ1bmN0aW9uIChjZWxsKSB7XHJcbiAgICAgICAgICAgIHZhciBiYWNrV2lkdGggPSAoY2VsbC5vZmZzZXRXaWR0aCAvIGNlbGwuY29sU3BhbiAtIDIyKS50b0ZpeGVkKDApLFxyXG5cclxuICAgICAgICAgICAgICAgIGNlbGxJbmZvID0gdGhpcy5nZXRDZWxsSW5mbyhjZWxsKSxcclxuICAgICAgICAgICAgICAgIHJvd0luZGV4ID0gY2VsbEluZm8ucm93SW5kZXgsXHJcbiAgICAgICAgICAgICAgICBjb2xJbmRleCA9IGNlbGxJbmZvLmNvbEluZGV4LFxyXG4gICAgICAgICAgICAgICAgcmVzdWx0cyA9IFtdO1xyXG4gICAgICAgICAgICAvLyDkv67mlLlDZWxs55qEcm93U3BhblxyXG4gICAgICAgICAgICBjZWxsLmNvbFNwYW4gPSAxO1xyXG4gICAgICAgICAgICBjZWxsLnNldEF0dHJpYnV0ZShcIndpZHRoXCIsIGJhY2tXaWR0aCk7XHJcbiAgICAgICAgICAgIHJlc3VsdHMucHVzaChjZWxsKTtcclxuICAgICAgICAgICAgLy8g6KGl6b2Q5Y2V5YWD5qC8XHJcbiAgICAgICAgICAgIGZvciAodmFyIGogPSBjb2xJbmRleCwgZW5kQ29sID0gY29sSW5kZXggKyBjZWxsSW5mby5jb2xTcGFuOyBqIDwgZW5kQ29sOyBqKyspIHtcclxuICAgICAgICAgICAgICAgIGlmIChqID09IGNvbEluZGV4KWNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgdmFyIHRhYmxlUm93ID0gdGhpcy50YWJsZS5yb3dzW3Jvd0luZGV4XSxcclxuICAgICAgICAgICAgICAgICAgICB0bXBDZWxsID0gdGFibGVSb3cuaW5zZXJ0Q2VsbCh0aGlzLmluZGV4VGFibGVbcm93SW5kZXhdW2pdLmNlbGxJbmRleCArIDEpO1xyXG4gICAgICAgICAgICAgICAgdG1wQ2VsbC5yb3dTcGFuID0gY2VsbEluZm8ucm93U3BhbjtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0Q2VsbENvbnRlbnQodG1wQ2VsbCk7XHJcbiAgICAgICAgICAgICAgICB0bXBDZWxsLnNldEF0dHJpYnV0ZSgndkFsaWduJywgY2VsbC5nZXRBdHRyaWJ1dGUoJ3ZBbGlnbicpKTtcclxuICAgICAgICAgICAgICAgIHRtcENlbGwuc2V0QXR0cmlidXRlKCdhbGlnbicsIGNlbGwuZ2V0QXR0cmlidXRlKCdhbGlnbicpKTtcclxuICAgICAgICAgICAgICAgIHRtcENlbGwuc2V0QXR0cmlidXRlKCd3aWR0aCcsIGJhY2tXaWR0aCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2VsbC5zdHlsZS5jc3NUZXh0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdG1wQ2VsbC5zdHlsZS5jc3NUZXh0ID0gY2VsbC5zdHlsZS5jc3NUZXh0O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy/lpITnkIZ0aOeahOaDheWGtVxyXG4gICAgICAgICAgICAgICAgaWYgKGNlbGwudGFnTmFtZSA9PSAnVEgnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRoID0gY2VsbC5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RoJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGguYXBwZW5kQ2hpbGQodG1wQ2VsbC5maXJzdENoaWxkKTtcclxuICAgICAgICAgICAgICAgICAgICB0aC5zZXRBdHRyaWJ1dGUoJ3ZBbGlnbicsIGNlbGwuZ2V0QXR0cmlidXRlKCd2QWxpZ24nKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGgucm93U3BhbiA9IHRtcENlbGwucm93U3BhbjtcclxuICAgICAgICAgICAgICAgICAgICB0YWJsZVJvdy5pbnNlcnRCZWZvcmUodGgsIHRtcENlbGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZSh0bXBDZWxsKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaCh0bXBDZWxsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZSgpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0cztcclxuICAgICAgICB9LFxyXG4gICAgICAgIGlzTGFzdENlbGw6ZnVuY3Rpb24gKGNlbGwsIHJvd3NOdW0sIGNvbHNOdW0pIHtcclxuICAgICAgICAgICAgcm93c051bSA9IHJvd3NOdW0gfHwgdGhpcy5yb3dzTnVtO1xyXG4gICAgICAgICAgICBjb2xzTnVtID0gY29sc051bSB8fCB0aGlzLmNvbHNOdW07XHJcbiAgICAgICAgICAgIHZhciBjZWxsSW5mbyA9IHRoaXMuZ2V0Q2VsbEluZm8oY2VsbCk7XHJcbiAgICAgICAgICAgIHJldHVybiAoKGNlbGxJbmZvLnJvd0luZGV4ICsgY2VsbEluZm8ucm93U3BhbikgPT0gcm93c051bSkgJiZcclxuICAgICAgICAgICAgICAgICgoY2VsbEluZm8uY29sSW5kZXggKyBjZWxsSW5mby5jb2xTcGFuKSA9PSBjb2xzTnVtKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldExhc3RDZWxsOmZ1bmN0aW9uIChjZWxscykge1xyXG4gICAgICAgICAgICBjZWxscyA9IGNlbGxzIHx8IHRoaXMudGFibGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJ0ZFwiKTtcclxuICAgICAgICAgICAgdmFyIGZpcnN0SW5mbyA9IHRoaXMuZ2V0Q2VsbEluZm8oY2VsbHNbMF0pO1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzLCBsYXN0ID0gY2VsbHNbMF0sXHJcbiAgICAgICAgICAgICAgICB0ciA9IGxhc3QucGFyZW50Tm9kZSxcclxuICAgICAgICAgICAgICAgIGNlbGxzTnVtID0gMCwgY29scyA9IDAsIHJvd3M7XHJcbiAgICAgICAgICAgIHV0aWxzLmVhY2goY2VsbHMsIGZ1bmN0aW9uIChjZWxsKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2VsbC5wYXJlbnROb2RlID09IHRyKWNvbHMgKz0gY2VsbC5jb2xTcGFuIHx8IDE7XHJcbiAgICAgICAgICAgICAgICBjZWxsc051bSArPSBjZWxsLnJvd1NwYW4gKiBjZWxsLmNvbFNwYW4gfHwgMTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJvd3MgPSBjZWxsc051bSAvIGNvbHM7XHJcbiAgICAgICAgICAgIHV0aWxzLmVhY2goY2VsbHMsIGZ1bmN0aW9uIChjZWxsKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAobWUuaXNMYXN0Q2VsbChjZWxsLCByb3dzLCBjb2xzKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxhc3QgPSBjZWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBsYXN0O1xyXG5cclxuICAgICAgICB9LFxyXG4gICAgICAgIHNlbGVjdFJvdzpmdW5jdGlvbiAocm93SW5kZXgpIHtcclxuICAgICAgICAgICAgdmFyIGluZGV4Um93ID0gdGhpcy5pbmRleFRhYmxlW3Jvd0luZGV4XSxcclxuICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5nZXRDZWxsKGluZGV4Um93WzBdLnJvd0luZGV4LCBpbmRleFJvd1swXS5jZWxsSW5kZXgpLFxyXG4gICAgICAgICAgICAgICAgZW5kID0gdGhpcy5nZXRDZWxsKGluZGV4Um93W3RoaXMuY29sc051bSAtIDFdLnJvd0luZGV4LCBpbmRleFJvd1t0aGlzLmNvbHNOdW0gLSAxXS5jZWxsSW5kZXgpLFxyXG4gICAgICAgICAgICAgICAgcmFuZ2UgPSB0aGlzLmdldENlbGxzUmFuZ2Uoc3RhcnQsIGVuZCk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0U2VsZWN0ZWQocmFuZ2UpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2VsZWN0VGFibGU6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgdGRzID0gdGhpcy50YWJsZS5nZXRFbGVtZW50c0J5VGFnTmFtZShcInRkXCIpLFxyXG4gICAgICAgICAgICAgICAgcmFuZ2UgPSB0aGlzLmdldENlbGxzUmFuZ2UodGRzWzBdLCB0ZHNbdGRzLmxlbmd0aCAtIDFdKTtcclxuICAgICAgICAgICAgdGhpcy5zZXRTZWxlY3RlZChyYW5nZSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXRCYWNrZ3JvdW5kOmZ1bmN0aW9uIChjZWxscywgdmFsdWUpIHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgICAgICAgdXRpbHMuZWFjaChjZWxscywgZnVuY3Rpb24gKGNlbGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBjZWxsLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09IFwib2JqZWN0XCIpIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gdXRpbHMuZXh0ZW5kKHtcclxuICAgICAgICAgICAgICAgICAgICByZXBlYXQ6dHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICBjb2xvckxpc3Q6W1wiI2RkZFwiLCBcIiNmZmZcIl1cclxuICAgICAgICAgICAgICAgIH0sIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIHZhciByb3dJbmRleCA9IHRoaXMuZ2V0Q2VsbEluZm8oY2VsbHNbMF0pLnJvd0luZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgIGNvdW50ID0gMCxcclxuICAgICAgICAgICAgICAgICAgICBjb2xvcnMgPSB2YWx1ZS5jb2xvckxpc3QsXHJcbiAgICAgICAgICAgICAgICAgICAgZ2V0Q29sb3IgPSBmdW5jdGlvbiAobGlzdCwgaW5kZXgsIHJlcGVhdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGlzdFtpbmRleF0gPyBsaXN0W2luZGV4XSA6IHJlcGVhdCA/IGxpc3RbaW5kZXggJSBsaXN0Lmxlbmd0aF0gOiBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2VsbDsgY2VsbCA9IGNlbGxzW2krK107KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNlbGxJbmZvID0gdGhpcy5nZXRDZWxsSW5mbyhjZWxsKTtcclxuICAgICAgICAgICAgICAgICAgICBjZWxsLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGdldENvbG9yKGNvbG9ycywgKChyb3dJbmRleCArIGNvdW50KSA9PSBjZWxsSW5mby5yb3dJbmRleCkgPyBjb3VudCA6ICsrY291bnQsIHZhbHVlLnJlcGVhdCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIHJlbW92ZUJhY2tncm91bmQ6ZnVuY3Rpb24gKGNlbGxzKSB7XHJcbiAgICAgICAgICAgIHV0aWxzLmVhY2goY2VsbHMsIGZ1bmN0aW9uIChjZWxsKSB7XHJcbiAgICAgICAgICAgICAgICBjZWxsLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IFwiXCI7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICB9O1xyXG4gICAgZnVuY3Rpb24gc2hvd0Vycm9yKGUpIHtcclxuICAgIH1cclxufSkoKTtcblxuLy8gcGx1Z2lucy90YWJsZS5jbWRzLmpzXG4vKipcclxuICogQ3JlYXRlZCB3aXRoIEpldEJyYWlucyBQaHBTdG9ybS5cclxuICogVXNlcjogdGFvcWlsaVxyXG4gKiBEYXRlOiAxMy0yLTIwXHJcbiAqIFRpbWU6IOS4i+WNiDY6MjVcclxuICogVG8gY2hhbmdlIHRoaXMgdGVtcGxhdGUgdXNlIEZpbGUgfCBTZXR0aW5ncyB8IEZpbGUgVGVtcGxhdGVzLlxyXG4gKi9cclxuO1xyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIFVUID0gVUUuVUVUYWJsZSxcclxuICAgICAgICBnZXRUYWJsZUl0ZW1zQnlSYW5nZSA9IGZ1bmN0aW9uIChlZGl0b3IpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFVULmdldFRhYmxlSXRlbXNCeVJhbmdlKGVkaXRvcik7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRVRVRhYmxlQnlTZWxlY3RlZCA9IGZ1bmN0aW9uIChlZGl0b3IpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFVULmdldFVFVGFibGVCeVNlbGVjdGVkKGVkaXRvcilcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldERlZmF1bHRWYWx1ZSA9IGZ1bmN0aW9uIChlZGl0b3IsIHRhYmxlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBVVC5nZXREZWZhdWx0VmFsdWUoZWRpdG9yLCB0YWJsZSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRVRVRhYmxlID0gZnVuY3Rpb24gKHRkT3JUYWJsZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gVVQuZ2V0VUVUYWJsZSh0ZE9yVGFibGUpO1xyXG4gICAgICAgIH07XHJcblxyXG5cclxuICAgIFVFLmNvbW1hbmRzWydpbnNlcnR0YWJsZSddID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKS50YWJsZSA/IC0xIDogMDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoY21kLCBvcHQpIHtcclxuICAgICAgICAgICAgZnVuY3Rpb24gY3JlYXRlVGFibGUob3B0LCB0ZFdpZHRoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgaHRtbCA9IFtdLFxyXG4gICAgICAgICAgICAgICAgICAgIHJvd3NOdW0gPSBvcHQubnVtUm93cyxcclxuICAgICAgICAgICAgICAgICAgICBjb2xzTnVtID0gb3B0Lm51bUNvbHM7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciByID0gMDsgciA8IHJvd3NOdW07IHIrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGh0bWwucHVzaCgnPHRyJyArIChyID09IDAgPyAnIGNsYXNzPVwiZmlyc3RSb3dcIic6JycpICsgJz4nKTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBjID0gMDsgYyA8IGNvbHNOdW07IGMrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBodG1sLnB1c2goJzx0ZCB3aWR0aD1cIicgKyB0ZFdpZHRoICsgJ1wiICB2QWxpZ249XCInICsgb3B0LnRkdmFsaWduICsgJ1wiID4nICsgKGJyb3dzZXIuaWUgJiYgYnJvd3Nlci52ZXJzaW9uIDwgMTEgPyBkb21VdGlscy5maWxsQ2hhciA6ICc8YnIvPicpICsgJzwvdGQ+JylcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaHRtbC5wdXNoKCc8L3RyPicpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvL+emgeatouaMh+WumnRhYmxlLXdpZHRoXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJzx0YWJsZT48dGJvZHk+JyArIGh0bWwuam9pbignJykgKyAnPC90Ym9keT48L3RhYmxlPidcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKCFvcHQpIHtcclxuICAgICAgICAgICAgICAgIG9wdCA9IHV0aWxzLmV4dGVuZCh7fSwge1xyXG4gICAgICAgICAgICAgICAgICAgIG51bUNvbHM6IHRoaXMub3B0aW9ucy5kZWZhdWx0Q29scyxcclxuICAgICAgICAgICAgICAgICAgICBudW1Sb3dzOiB0aGlzLm9wdGlvbnMuZGVmYXVsdFJvd3MsXHJcbiAgICAgICAgICAgICAgICAgICAgdGR2YWxpZ246IHRoaXMub3B0aW9ucy50ZHZhbGlnblxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICB2YXIgcmFuZ2UgPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxyXG4gICAgICAgICAgICAgICAgc3RhcnQgPSByYW5nZS5zdGFydENvbnRhaW5lcixcclxuICAgICAgICAgICAgICAgIGZpcnN0UGFyZW50QmxvY2sgPSBkb21VdGlscy5maW5kUGFyZW50KHN0YXJ0LCBmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkb21VdGlscy5pc0Jsb2NrRWxtKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgfSwgdHJ1ZSkgfHwgbWUuYm9keTtcclxuXHJcbiAgICAgICAgICAgIHZhciBkZWZhdWx0VmFsdWUgPSBnZXREZWZhdWx0VmFsdWUobWUpLFxyXG4gICAgICAgICAgICAgICAgdGFibGVXaWR0aCA9IGZpcnN0UGFyZW50QmxvY2sub2Zmc2V0V2lkdGgsXHJcbiAgICAgICAgICAgICAgICB0ZFdpZHRoID0gTWF0aC5mbG9vcih0YWJsZVdpZHRoIC8gb3B0Lm51bUNvbHMgLSBkZWZhdWx0VmFsdWUudGRQYWRkaW5nICogMiAtIGRlZmF1bHRWYWx1ZS50ZEJvcmRlcik7XHJcblxyXG4gICAgICAgICAgICAvL3RvZG/lhbbku5blsZ7mgKdcclxuICAgICAgICAgICAgIW9wdC50ZHZhbGlnbiAmJiAob3B0LnRkdmFsaWduID0gbWUub3B0aW9ucy50ZHZhbGlnbik7XHJcbiAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKFwiaW5zZXJ0aHRtbFwiLCBjcmVhdGVUYWJsZShvcHQsIHRkV2lkdGgpKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIFVFLmNvbW1hbmRzWydpbnNlcnRwYXJhZ3JhcGhiZWZvcmV0YWJsZSddID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKS5jZWxsID8gMCA6IC0xO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHRhYmxlID0gZ2V0VGFibGVJdGVtc0J5UmFuZ2UodGhpcykudGFibGU7XHJcbiAgICAgICAgICAgIGlmICh0YWJsZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHAgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJwXCIpO1xyXG4gICAgICAgICAgICAgICAgcC5pbm5lckhUTUwgPSBicm93c2VyLmllID8gJyZuYnNwOycgOiAnPGJyIC8+JztcclxuICAgICAgICAgICAgICAgIHRhYmxlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHAsIHRhYmxlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCkuc2V0U3RhcnQocCwgMCkuc2V0Q3Vyc29yKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIFVFLmNvbW1hbmRzWydkZWxldGV0YWJsZSddID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBybmcgPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xyXG4gICAgICAgICAgICByZXR1cm4gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShybmcuc3RhcnRDb250YWluZXIsICd0YWJsZScsIHRydWUpID8gMCA6IC0xO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uIChjbWQsIHRhYmxlKSB7XHJcbiAgICAgICAgICAgIHZhciBybmcgPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xyXG4gICAgICAgICAgICB0YWJsZSA9IHRhYmxlIHx8IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocm5nLnN0YXJ0Q29udGFpbmVyLCAndGFibGUnLCB0cnVlKTtcclxuICAgICAgICAgICAgaWYgKHRhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHRhYmxlLm5leHRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFuZXh0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV4dCA9IGRvbVV0aWxzLmNyZWF0ZUVsZW1lbnQodGhpcy5kb2N1bWVudCwgJ3AnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICdpbm5lckhUTUwnOiBicm93c2VyLmllID8gZG9tVXRpbHMuZmlsbENoYXIgOiAnPGJyLz4nXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGFibGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobmV4dCwgdGFibGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHRhYmxlKTtcclxuICAgICAgICAgICAgICAgIHJuZyA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAobmV4dC5ub2RlVHlwZSA9PSAzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcm5nLnNldFN0YXJ0QmVmb3JlKG5leHQpXHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJuZy5zZXRTdGFydChuZXh0LCAwKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcm5nLnNldEN1cnNvcihmYWxzZSwgdHJ1ZSlcclxuICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KFwidGFibGVoYXNkZWxldGVkXCIpXHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBVRS5jb21tYW5kc1snY2VsbGFsaWduJ10gPSB7XHJcbiAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGdldFNlbGVjdGVkQXJyKHRoaXMpLmxlbmd0aCA/IDAgOiAtMVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uIChjbWQsIGFsaWduKSB7XHJcbiAgICAgICAgICAgIHZhciBzZWxlY3RlZFRkcyA9IGdldFNlbGVjdGVkQXJyKHRoaXMpO1xyXG4gICAgICAgICAgICBpZiAoc2VsZWN0ZWRUZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2k7IGNpID0gc2VsZWN0ZWRUZHNbaSsrXTspIHtcclxuICAgICAgICAgICAgICAgICAgICBjaS5zZXRBdHRyaWJ1dGUoJ2FsaWduJywgYWxpZ24pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFVFLmNvbW1hbmRzWydjZWxsdmFsaWduJ10gPSB7XHJcbiAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGdldFNlbGVjdGVkQXJyKHRoaXMpLmxlbmd0aCA/IDAgOiAtMTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoY21kLCB2YWxpZ24pIHtcclxuICAgICAgICAgICAgdmFyIHNlbGVjdGVkVGRzID0gZ2V0U2VsZWN0ZWRBcnIodGhpcyk7XHJcbiAgICAgICAgICAgIGlmIChzZWxlY3RlZFRkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSBzZWxlY3RlZFRkc1tpKytdOykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNpLnNldEF0dHJpYnV0ZSgndkFsaWduJywgdmFsaWduKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBVRS5jb21tYW5kc1snaW5zZXJ0Y2FwdGlvbiddID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciB0YWJsZSA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLnRhYmxlO1xyXG4gICAgICAgICAgICBpZiAodGFibGUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0YWJsZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnY2FwdGlvbicpLmxlbmd0aCA9PSAwID8gMSA6IC0xO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiAtMTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciB0YWJsZSA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLnRhYmxlO1xyXG4gICAgICAgICAgICBpZiAodGFibGUpIHtcclxuICAgICAgICAgICAgICAgIHZhciBjYXB0aW9uID0gdGhpcy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYXB0aW9uJyk7XHJcbiAgICAgICAgICAgICAgICBjYXB0aW9uLmlubmVySFRNTCA9IGJyb3dzZXIuaWUgPyBkb21VdGlscy5maWxsQ2hhciA6ICc8YnIvPic7XHJcbiAgICAgICAgICAgICAgICB0YWJsZS5pbnNlcnRCZWZvcmUoY2FwdGlvbiwgdGFibGUuZmlyc3RDaGlsZCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmFuZ2UgPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xyXG4gICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQoY2FwdGlvbiwgMCkuc2V0Q3Vyc29yKCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFVFLmNvbW1hbmRzWydkZWxldGVjYXB0aW9uJ10gPSB7XHJcbiAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJuZyA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCksXHJcbiAgICAgICAgICAgICAgICB0YWJsZSA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocm5nLnN0YXJ0Q29udGFpbmVyLCAndGFibGUnKTtcclxuICAgICAgICAgICAgaWYgKHRhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGFibGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2NhcHRpb24nKS5sZW5ndGggPT0gMCA/IC0xIDogMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gLTE7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcm5nID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxcclxuICAgICAgICAgICAgICAgIHRhYmxlID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShybmcuc3RhcnRDb250YWluZXIsICd0YWJsZScpO1xyXG4gICAgICAgICAgICBpZiAodGFibGUpIHtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZSh0YWJsZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnY2FwdGlvbicpWzBdKTtcclxuICAgICAgICAgICAgICAgIHZhciByYW5nZSA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydCh0YWJsZS5yb3dzWzBdLmNlbGxzWzBdLCAwKS5zZXRDdXJzb3IoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgVUUuY29tbWFuZHNbJ2luc2VydHRpdGxlJ10gPSB7XHJcbiAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHRhYmxlID0gZ2V0VGFibGVJdGVtc0J5UmFuZ2UodGhpcykudGFibGU7XHJcbiAgICAgICAgICAgIGlmICh0YWJsZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGZpcnN0Um93ID0gdGFibGUucm93c1swXTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmaXJzdFJvdy5jZWxsc1tmaXJzdFJvdy5jZWxscy5sZW5ndGgtMV0udGFnTmFtZS50b0xvd2VyQ2FzZSgpICE9ICd0aCcgPyAwIDogLTFcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gLTE7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgdGFibGUgPSBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKS50YWJsZTtcclxuICAgICAgICAgICAgaWYgKHRhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICBnZXRVRVRhYmxlKHRhYmxlKS5pbnNlcnRSb3coMCwgJ3RoJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHRoID0gdGFibGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3RoJylbMF07XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCkuc2V0U3RhcnQodGgsIDApLnNldEN1cnNvcihmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFVFLmNvbW1hbmRzWydkZWxldGV0aXRsZSddID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciB0YWJsZSA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLnRhYmxlO1xyXG4gICAgICAgICAgICBpZiAodGFibGUpIHtcclxuICAgICAgICAgICAgICAgIHZhciBmaXJzdFJvdyA9IHRhYmxlLnJvd3NbMF07XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmlyc3RSb3cuY2VsbHNbZmlyc3RSb3cuY2VsbHMubGVuZ3RoLTFdLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAndGgnID8gMCA6IC0xXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHRhYmxlID0gZ2V0VGFibGVJdGVtc0J5UmFuZ2UodGhpcykudGFibGU7XHJcbiAgICAgICAgICAgIGlmICh0YWJsZSkge1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHRhYmxlLnJvd3NbMF0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHRkID0gdGFibGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3RkJylbMF07XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCkuc2V0U3RhcnQodGQsIDApLnNldEN1cnNvcihmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFVFLmNvbW1hbmRzWydpbnNlcnR0aXRsZWNvbCddID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciB0YWJsZSA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLnRhYmxlO1xyXG4gICAgICAgICAgICBpZiAodGFibGUpIHtcclxuICAgICAgICAgICAgICAgIHZhciBsYXN0Um93ID0gdGFibGUucm93c1t0YWJsZS5yb3dzLmxlbmd0aC0xXTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBsYXN0Um93LmdldEVsZW1lbnRzQnlUYWdOYW1lKCd0aCcpLmxlbmd0aCA/IC0xIDogMDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gLTE7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKGNtZCkge1xyXG4gICAgICAgICAgICB2YXIgdGFibGUgPSBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKS50YWJsZTtcclxuICAgICAgICAgICAgaWYgKHRhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICBnZXRVRVRhYmxlKHRhYmxlKS5pbnNlcnRDb2woMCwgJ3RoJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmVzZXRUZFdpZHRoKHRhYmxlLCB0aGlzKTtcclxuICAgICAgICAgICAgdmFyIHRoID0gdGFibGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3RoJylbMF07XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCkuc2V0U3RhcnQodGgsIDApLnNldEN1cnNvcihmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFVFLmNvbW1hbmRzWydkZWxldGV0aXRsZWNvbCddID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciB0YWJsZSA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLnRhYmxlO1xyXG4gICAgICAgICAgICBpZiAodGFibGUpIHtcclxuICAgICAgICAgICAgICAgIHZhciBsYXN0Um93ID0gdGFibGUucm93c1t0YWJsZS5yb3dzLmxlbmd0aC0xXTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBsYXN0Um93LmdldEVsZW1lbnRzQnlUYWdOYW1lKCd0aCcpLmxlbmd0aCA/IDAgOiAtMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gLTE7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgdGFibGUgPSBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKS50YWJsZTtcclxuICAgICAgICAgICAgaWYgKHRhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpPCB0YWJsZS5yb3dzLmxlbmd0aDsgaSsrICl7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHRhYmxlLnJvd3NbaV0uY2hpbGRyZW5bMF0pXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmVzZXRUZFdpZHRoKHRhYmxlLCB0aGlzKTtcclxuICAgICAgICAgICAgdmFyIHRkID0gdGFibGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3RkJylbMF07XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCkuc2V0U3RhcnQodGQsIDApLnNldEN1cnNvcihmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBVRS5jb21tYW5kc1tcIm1lcmdlcmlnaHRcIl0gPSB7XHJcbiAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6IGZ1bmN0aW9uIChjbWQpIHtcclxuICAgICAgICAgICAgdmFyIHRhYmxlSXRlbXMgPSBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKSxcclxuICAgICAgICAgICAgICAgIHRhYmxlID0gdGFibGVJdGVtcy50YWJsZSxcclxuICAgICAgICAgICAgICAgIGNlbGwgPSB0YWJsZUl0ZW1zLmNlbGw7XHJcblxyXG4gICAgICAgICAgICBpZiAoIXRhYmxlIHx8ICFjZWxsKSByZXR1cm4gLTE7XHJcbiAgICAgICAgICAgIHZhciB1dCA9IGdldFVFVGFibGUodGFibGUpO1xyXG4gICAgICAgICAgICBpZiAodXQuc2VsZWN0ZWRUZHMubGVuZ3RoKSByZXR1cm4gLTE7XHJcblxyXG4gICAgICAgICAgICB2YXIgY2VsbEluZm8gPSB1dC5nZXRDZWxsSW5mbyhjZWxsKSxcclxuICAgICAgICAgICAgICAgIHJpZ2h0Q29sSW5kZXggPSBjZWxsSW5mby5jb2xJbmRleCArIGNlbGxJbmZvLmNvbFNwYW47XHJcbiAgICAgICAgICAgIGlmIChyaWdodENvbEluZGV4ID49IHV0LmNvbHNOdW0pIHJldHVybiAtMTsgLy8g5aaC5p6c5aSE5LqO5pyA5Y+z6L655YiZ5LiN6IO95ZCR5Y+z5ZCI5bm2XHJcblxyXG4gICAgICAgICAgICB2YXIgcmlnaHRDZWxsSW5mbyA9IHV0LmluZGV4VGFibGVbY2VsbEluZm8ucm93SW5kZXhdW3JpZ2h0Q29sSW5kZXhdLFxyXG4gICAgICAgICAgICAgICAgcmlnaHRDZWxsID0gdGFibGUucm93c1tyaWdodENlbGxJbmZvLnJvd0luZGV4XS5jZWxsc1tyaWdodENlbGxJbmZvLmNlbGxJbmRleF07XHJcbiAgICAgICAgICAgIGlmICghcmlnaHRDZWxsIHx8IGNlbGwudGFnTmFtZSAhPSByaWdodENlbGwudGFnTmFtZSkgcmV0dXJuIC0xOyAvLyBUSOWSjFRE5LiN6IO955u45LqS5ZCI5bm2XHJcblxyXG4gICAgICAgICAgICAvLyDlvZPkuJTku4XlvZPkuKTkuKpDZWxs55qE5byA5aeL5YiX5Y+35ZKM57uT5p2f5YiX5Y+35LiA6Ie05pe26IO96L+b6KGM5ZCI5bm2XHJcbiAgICAgICAgICAgIHJldHVybiAocmlnaHRDZWxsSW5mby5yb3dJbmRleCA9PSBjZWxsSW5mby5yb3dJbmRleCAmJiByaWdodENlbGxJbmZvLnJvd1NwYW4gPT0gY2VsbEluZm8ucm93U3BhbikgPyAwIDogLTE7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKGNtZCkge1xyXG4gICAgICAgICAgICB2YXIgcm5nID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxcclxuICAgICAgICAgICAgICAgIGJrID0gcm5nLmNyZWF0ZUJvb2ttYXJrKHRydWUpO1xyXG4gICAgICAgICAgICB2YXIgY2VsbCA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLmNlbGwsXHJcbiAgICAgICAgICAgICAgICB1dCA9IGdldFVFVGFibGUoY2VsbCk7XHJcbiAgICAgICAgICAgIHV0Lm1lcmdlUmlnaHQoY2VsbCk7XHJcbiAgICAgICAgICAgIHJuZy5tb3ZlVG9Cb29rbWFyayhiaykuc2VsZWN0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFVFLmNvbW1hbmRzW1wibWVyZ2Vkb3duXCJdID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoY21kKSB7XHJcbiAgICAgICAgICAgIHZhciB0YWJsZUl0ZW1zID0gZ2V0VGFibGVJdGVtc0J5UmFuZ2UodGhpcyksXHJcbiAgICAgICAgICAgICAgICB0YWJsZSA9IHRhYmxlSXRlbXMudGFibGUsXHJcbiAgICAgICAgICAgICAgICBjZWxsID0gdGFibGVJdGVtcy5jZWxsO1xyXG5cclxuICAgICAgICAgICAgaWYgKCF0YWJsZSB8fCAhY2VsbCkgcmV0dXJuIC0xO1xyXG4gICAgICAgICAgICB2YXIgdXQgPSBnZXRVRVRhYmxlKHRhYmxlKTtcclxuICAgICAgICAgICAgaWYgKHV0LnNlbGVjdGVkVGRzLmxlbmd0aClyZXR1cm4gLTE7XHJcblxyXG4gICAgICAgICAgICB2YXIgY2VsbEluZm8gPSB1dC5nZXRDZWxsSW5mbyhjZWxsKSxcclxuICAgICAgICAgICAgICAgIGRvd25Sb3dJbmRleCA9IGNlbGxJbmZvLnJvd0luZGV4ICsgY2VsbEluZm8ucm93U3BhbjtcclxuICAgICAgICAgICAgaWYgKGRvd25Sb3dJbmRleCA+PSB1dC5yb3dzTnVtKSByZXR1cm4gLTE7IC8vIOWmguaenOWkhOS6juacgOS4i+i+ueWImeS4jeiDveWQkeS4i+WQiOW5tlxyXG5cclxuICAgICAgICAgICAgdmFyIGRvd25DZWxsSW5mbyA9IHV0LmluZGV4VGFibGVbZG93blJvd0luZGV4XVtjZWxsSW5mby5jb2xJbmRleF0sXHJcbiAgICAgICAgICAgICAgICBkb3duQ2VsbCA9IHRhYmxlLnJvd3NbZG93bkNlbGxJbmZvLnJvd0luZGV4XS5jZWxsc1tkb3duQ2VsbEluZm8uY2VsbEluZGV4XTtcclxuICAgICAgICAgICAgaWYgKCFkb3duQ2VsbCB8fCBjZWxsLnRhZ05hbWUgIT0gZG93bkNlbGwudGFnTmFtZSkgcmV0dXJuIC0xOyAvLyBUSOWSjFRE5LiN6IO955u45LqS5ZCI5bm2XHJcblxyXG4gICAgICAgICAgICAvLyDlvZPkuJTku4XlvZPkuKTkuKpDZWxs55qE5byA5aeL5YiX5Y+35ZKM57uT5p2f5YiX5Y+35LiA6Ie05pe26IO96L+b6KGM5ZCI5bm2XHJcbiAgICAgICAgICAgIHJldHVybiAoZG93bkNlbGxJbmZvLmNvbEluZGV4ID09IGNlbGxJbmZvLmNvbEluZGV4ICYmIGRvd25DZWxsSW5mby5jb2xTcGFuID09IGNlbGxJbmZvLmNvbFNwYW4pID8gMCA6IC0xO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJuZyA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCksXHJcbiAgICAgICAgICAgICAgICBiayA9IHJuZy5jcmVhdGVCb29rbWFyayh0cnVlKTtcclxuICAgICAgICAgICAgdmFyIGNlbGwgPSBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKS5jZWxsLFxyXG4gICAgICAgICAgICAgICAgdXQgPSBnZXRVRVRhYmxlKGNlbGwpO1xyXG4gICAgICAgICAgICB1dC5tZXJnZURvd24oY2VsbCk7XHJcbiAgICAgICAgICAgIHJuZy5tb3ZlVG9Cb29rbWFyayhiaykuc2VsZWN0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFVFLmNvbW1hbmRzW1wibWVyZ2VjZWxsc1wiXSA9IHtcclxuICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZTogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZ2V0VUVUYWJsZUJ5U2VsZWN0ZWQodGhpcykgPyAwIDogLTE7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgdXQgPSBnZXRVRVRhYmxlQnlTZWxlY3RlZCh0aGlzKTtcclxuICAgICAgICAgICAgaWYgKHV0ICYmIHV0LnNlbGVjdGVkVGRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGNlbGwgPSB1dC5zZWxlY3RlZFRkc1swXTtcclxuICAgICAgICAgICAgICAgIHV0Lm1lcmdlUmFuZ2UoKTtcclxuICAgICAgICAgICAgICAgIHZhciBybmcgPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGRvbVV0aWxzLmlzRW1wdHlCbG9jayhjZWxsKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJuZy5zZXRTdGFydChjZWxsLCAwKS5jb2xsYXBzZSh0cnVlKVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBybmcuc2VsZWN0Tm9kZUNvbnRlbnRzKGNlbGwpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBybmcuc2VsZWN0KCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBVRS5jb21tYW5kc1tcImluc2VydHJvd1wiXSA9IHtcclxuICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZTogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgdGFibGVJdGVtcyA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLFxyXG4gICAgICAgICAgICAgICAgY2VsbCA9IHRhYmxlSXRlbXMuY2VsbDtcclxuICAgICAgICAgICAgcmV0dXJuIGNlbGwgJiYgKGNlbGwudGFnTmFtZSA9PSBcIlREXCIgfHwgKGNlbGwudGFnTmFtZSA9PSAnVEgnICYmIHRhYmxlSXRlbXMudHIgIT09IHRhYmxlSXRlbXMudGFibGUucm93c1swXSkpICYmXHJcbiAgICAgICAgICAgICAgICBnZXRVRVRhYmxlKHRhYmxlSXRlbXMudGFibGUpLnJvd3NOdW0gPCB0aGlzLm9wdGlvbnMubWF4Um93TnVtID8gMCA6IC0xO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJuZyA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCksXHJcbiAgICAgICAgICAgICAgICBiayA9IHJuZy5jcmVhdGVCb29rbWFyayh0cnVlKTtcclxuICAgICAgICAgICAgdmFyIHRhYmxlSXRlbXMgPSBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKSxcclxuICAgICAgICAgICAgICAgIGNlbGwgPSB0YWJsZUl0ZW1zLmNlbGwsXHJcbiAgICAgICAgICAgICAgICB0YWJsZSA9IHRhYmxlSXRlbXMudGFibGUsXHJcbiAgICAgICAgICAgICAgICB1dCA9IGdldFVFVGFibGUodGFibGUpLFxyXG4gICAgICAgICAgICAgICAgY2VsbEluZm8gPSB1dC5nZXRDZWxsSW5mbyhjZWxsKTtcclxuICAgICAgICAgICAgLy91dC5pbnNlcnRSb3coIXV0LnNlbGVjdGVkVGRzLmxlbmd0aCA/IGNlbGxJbmZvLnJvd0luZGV4OnV0LmNlbGxzUmFuZ2UuYmVnaW5Sb3dJbmRleCwnJyk7XHJcbiAgICAgICAgICAgIGlmICghdXQuc2VsZWN0ZWRUZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICB1dC5pbnNlcnRSb3coY2VsbEluZm8ucm93SW5kZXgsIGNlbGwpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gdXQuY2VsbHNSYW5nZTtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSByYW5nZS5lbmRSb3dJbmRleCAtIHJhbmdlLmJlZ2luUm93SW5kZXggKyAxOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICB1dC5pbnNlcnRSb3cocmFuZ2UuYmVnaW5Sb3dJbmRleCwgY2VsbCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcm5nLm1vdmVUb0Jvb2ttYXJrKGJrKS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgaWYgKHRhYmxlLmdldEF0dHJpYnV0ZShcImludGVybGFjZWRcIikgPT09IFwiZW5hYmxlZFwiKXRoaXMuZmlyZUV2ZW50KFwiaW50ZXJsYWNldGFibGVcIiwgdGFibGUpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICAvL+WQjuaPkuWFpeihjFxyXG4gICAgVUUuY29tbWFuZHNbXCJpbnNlcnRyb3duZXh0XCJdID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciB0YWJsZUl0ZW1zID0gZ2V0VGFibGVJdGVtc0J5UmFuZ2UodGhpcyksXHJcbiAgICAgICAgICAgICAgICBjZWxsID0gdGFibGVJdGVtcy5jZWxsO1xyXG4gICAgICAgICAgICByZXR1cm4gY2VsbCAmJiAoY2VsbC50YWdOYW1lID09IFwiVERcIikgJiYgZ2V0VUVUYWJsZSh0YWJsZUl0ZW1zLnRhYmxlKS5yb3dzTnVtIDwgdGhpcy5vcHRpb25zLm1heFJvd051bSA/IDAgOiAtMTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBybmcgPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxyXG4gICAgICAgICAgICAgICAgYmsgPSBybmcuY3JlYXRlQm9va21hcmsodHJ1ZSk7XHJcbiAgICAgICAgICAgIHZhciB0YWJsZUl0ZW1zID0gZ2V0VGFibGVJdGVtc0J5UmFuZ2UodGhpcyksXHJcbiAgICAgICAgICAgICAgICBjZWxsID0gdGFibGVJdGVtcy5jZWxsLFxyXG4gICAgICAgICAgICAgICAgdGFibGUgPSB0YWJsZUl0ZW1zLnRhYmxlLFxyXG4gICAgICAgICAgICAgICAgdXQgPSBnZXRVRVRhYmxlKHRhYmxlKSxcclxuICAgICAgICAgICAgICAgIGNlbGxJbmZvID0gdXQuZ2V0Q2VsbEluZm8oY2VsbCk7XHJcbiAgICAgICAgICAgIC8vdXQuaW5zZXJ0Um93KCF1dC5zZWxlY3RlZFRkcy5sZW5ndGg/IGNlbGxJbmZvLnJvd0luZGV4ICsgY2VsbEluZm8ucm93U3BhbiA6IHV0LmNlbGxzUmFuZ2UuZW5kUm93SW5kZXggKyAxLCcnKTtcclxuICAgICAgICAgICAgaWYgKCF1dC5zZWxlY3RlZFRkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHV0Lmluc2VydFJvdyhjZWxsSW5mby5yb3dJbmRleCArIGNlbGxJbmZvLnJvd1NwYW4sIGNlbGwpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gdXQuY2VsbHNSYW5nZTtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSByYW5nZS5lbmRSb3dJbmRleCAtIHJhbmdlLmJlZ2luUm93SW5kZXggKyAxOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICB1dC5pbnNlcnRSb3cocmFuZ2UuZW5kUm93SW5kZXggKyAxLCBjZWxsKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBybmcubW92ZVRvQm9va21hcmsoYmspLnNlbGVjdCgpO1xyXG4gICAgICAgICAgICBpZiAodGFibGUuZ2V0QXR0cmlidXRlKFwiaW50ZXJsYWNlZFwiKSA9PT0gXCJlbmFibGVkXCIpdGhpcy5maXJlRXZlbnQoXCJpbnRlcmxhY2V0YWJsZVwiLCB0YWJsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFVFLmNvbW1hbmRzW1wiZGVsZXRlcm93XCJdID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciB0YWJsZUl0ZW1zID0gZ2V0VGFibGVJdGVtc0J5UmFuZ2UodGhpcyk7XHJcbiAgICAgICAgICAgIHJldHVybiB0YWJsZUl0ZW1zLmNlbGwgPyAwIDogLTE7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgY2VsbCA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLmNlbGwsXHJcbiAgICAgICAgICAgICAgICB1dCA9IGdldFVFVGFibGUoY2VsbCksXHJcbiAgICAgICAgICAgICAgICBjZWxsc1JhbmdlID0gdXQuY2VsbHNSYW5nZSxcclxuICAgICAgICAgICAgICAgIGNlbGxJbmZvID0gdXQuZ2V0Q2VsbEluZm8oY2VsbCksXHJcbiAgICAgICAgICAgICAgICBwcmVDZWxsID0gdXQuZ2V0VlNpZGVDZWxsKGNlbGwpLFxyXG4gICAgICAgICAgICAgICAgbmV4dENlbGwgPSB1dC5nZXRWU2lkZUNlbGwoY2VsbCwgdHJ1ZSksXHJcbiAgICAgICAgICAgICAgICBybmcgPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xyXG4gICAgICAgICAgICBpZiAodXRpbHMuaXNFbXB0eU9iamVjdChjZWxsc1JhbmdlKSkge1xyXG4gICAgICAgICAgICAgICAgdXQuZGVsZXRlUm93KGNlbGxJbmZvLnJvd0luZGV4KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBjZWxsc1JhbmdlLmJlZ2luUm93SW5kZXg7IGkgPCBjZWxsc1JhbmdlLmVuZFJvd0luZGV4ICsgMTsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXQuZGVsZXRlUm93KGNlbGxzUmFuZ2UuYmVnaW5Sb3dJbmRleCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHRhYmxlID0gdXQudGFibGU7XHJcbiAgICAgICAgICAgIGlmICghdGFibGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3RkJykubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbmV4dFNpYmxpbmcgPSB0YWJsZS5uZXh0U2libGluZztcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZSh0YWJsZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAobmV4dFNpYmxpbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICBybmcuc2V0U3RhcnQobmV4dFNpYmxpbmcsIDApLnNldEN1cnNvcihmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2VsbEluZm8ucm93U3BhbiA9PSAxIHx8IGNlbGxJbmZvLnJvd1NwYW4gPT0gY2VsbHNSYW5nZS5lbmRSb3dJbmRleCAtIGNlbGxzUmFuZ2UuYmVnaW5Sb3dJbmRleCArIDEpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobmV4dENlbGwgfHwgcHJlQ2VsbCkgcm5nLnNlbGVjdE5vZGVDb250ZW50cyhuZXh0Q2VsbCB8fCBwcmVDZWxsKS5zZXRDdXJzb3IoZmFsc2UsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3Q2VsbCA9IHV0LmdldENlbGwoY2VsbEluZm8ucm93SW5kZXgsIHV0LmluZGV4VGFibGVbY2VsbEluZm8ucm93SW5kZXhdW2NlbGxJbmZvLmNvbEluZGV4XS5jZWxsSW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChuZXdDZWxsKSBybmcuc2VsZWN0Tm9kZUNvbnRlbnRzKG5ld0NlbGwpLnNldEN1cnNvcihmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHRhYmxlLmdldEF0dHJpYnV0ZShcImludGVybGFjZWRcIikgPT09IFwiZW5hYmxlZFwiKXRoaXMuZmlyZUV2ZW50KFwiaW50ZXJsYWNldGFibGVcIiwgdGFibGUpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBVRS5jb21tYW5kc1tcImluc2VydGNvbFwiXSA9IHtcclxuICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZTogZnVuY3Rpb24gKGNtZCkge1xyXG4gICAgICAgICAgICB2YXIgdGFibGVJdGVtcyA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLFxyXG4gICAgICAgICAgICAgICAgY2VsbCA9IHRhYmxlSXRlbXMuY2VsbDtcclxuICAgICAgICAgICAgcmV0dXJuIGNlbGwgJiYgKGNlbGwudGFnTmFtZSA9PSBcIlREXCIgfHwgKGNlbGwudGFnTmFtZSA9PSAnVEgnICYmIGNlbGwgIT09IHRhYmxlSXRlbXMudHIuY2VsbHNbMF0pKSAmJlxyXG4gICAgICAgICAgICAgICAgZ2V0VUVUYWJsZSh0YWJsZUl0ZW1zLnRhYmxlKS5jb2xzTnVtIDwgdGhpcy5vcHRpb25zLm1heENvbE51bSA/IDAgOiAtMTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoY21kKSB7XHJcbiAgICAgICAgICAgIHZhciBybmcgPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxyXG4gICAgICAgICAgICAgICAgYmsgPSBybmcuY3JlYXRlQm9va21hcmsodHJ1ZSk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnF1ZXJ5Q29tbWFuZFN0YXRlKGNtZCkgPT0gLTEpcmV0dXJuO1xyXG4gICAgICAgICAgICB2YXIgY2VsbCA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLmNlbGwsXHJcbiAgICAgICAgICAgICAgICB1dCA9IGdldFVFVGFibGUoY2VsbCksXHJcbiAgICAgICAgICAgICAgICBjZWxsSW5mbyA9IHV0LmdldENlbGxJbmZvKGNlbGwpO1xyXG5cclxuICAgICAgICAgICAgLy91dC5pbnNlcnRDb2woIXV0LnNlbGVjdGVkVGRzLmxlbmd0aCA/IGNlbGxJbmZvLmNvbEluZGV4OnV0LmNlbGxzUmFuZ2UuYmVnaW5Db2xJbmRleCk7XHJcbiAgICAgICAgICAgIGlmICghdXQuc2VsZWN0ZWRUZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICB1dC5pbnNlcnRDb2woY2VsbEluZm8uY29sSW5kZXgsIGNlbGwpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gdXQuY2VsbHNSYW5nZTtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSByYW5nZS5lbmRDb2xJbmRleCAtIHJhbmdlLmJlZ2luQ29sSW5kZXggKyAxOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICB1dC5pbnNlcnRDb2wocmFuZ2UuYmVnaW5Db2xJbmRleCwgY2VsbCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcm5nLm1vdmVUb0Jvb2ttYXJrKGJrKS5zZWxlY3QodHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFVFLmNvbW1hbmRzW1wiaW5zZXJ0Y29sbmV4dFwiXSA9IHtcclxuICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZTogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgdGFibGVJdGVtcyA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLFxyXG4gICAgICAgICAgICAgICAgY2VsbCA9IHRhYmxlSXRlbXMuY2VsbDtcclxuICAgICAgICAgICAgcmV0dXJuIGNlbGwgJiYgZ2V0VUVUYWJsZSh0YWJsZUl0ZW1zLnRhYmxlKS5jb2xzTnVtIDwgdGhpcy5vcHRpb25zLm1heENvbE51bSA/IDAgOiAtMTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBybmcgPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxyXG4gICAgICAgICAgICAgICAgYmsgPSBybmcuY3JlYXRlQm9va21hcmsodHJ1ZSk7XHJcbiAgICAgICAgICAgIHZhciBjZWxsID0gZ2V0VGFibGVJdGVtc0J5UmFuZ2UodGhpcykuY2VsbCxcclxuICAgICAgICAgICAgICAgIHV0ID0gZ2V0VUVUYWJsZShjZWxsKSxcclxuICAgICAgICAgICAgICAgIGNlbGxJbmZvID0gdXQuZ2V0Q2VsbEluZm8oY2VsbCk7XHJcbiAgICAgICAgICAgIC8vdXQuaW5zZXJ0Q29sKCF1dC5zZWxlY3RlZFRkcy5sZW5ndGggPyBjZWxsSW5mby5jb2xJbmRleCArIGNlbGxJbmZvLmNvbFNwYW46dXQuY2VsbHNSYW5nZS5lbmRDb2xJbmRleCArMSk7XHJcbiAgICAgICAgICAgIGlmICghdXQuc2VsZWN0ZWRUZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICB1dC5pbnNlcnRDb2woY2VsbEluZm8uY29sSW5kZXggKyBjZWxsSW5mby5jb2xTcGFuLCBjZWxsKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHZhciByYW5nZSA9IHV0LmNlbGxzUmFuZ2U7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gcmFuZ2UuZW5kQ29sSW5kZXggLSByYW5nZS5iZWdpbkNvbEluZGV4ICsgMTsgaSA8IGxlbjsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXQuaW5zZXJ0Q29sKHJhbmdlLmVuZENvbEluZGV4ICsgMSwgY2VsbCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcm5nLm1vdmVUb0Jvb2ttYXJrKGJrKS5zZWxlY3QoKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIFVFLmNvbW1hbmRzW1wiZGVsZXRlY29sXCJdID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciB0YWJsZUl0ZW1zID0gZ2V0VGFibGVJdGVtc0J5UmFuZ2UodGhpcyk7XHJcbiAgICAgICAgICAgIHJldHVybiB0YWJsZUl0ZW1zLmNlbGwgPyAwIDogLTE7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgY2VsbCA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLmNlbGwsXHJcbiAgICAgICAgICAgICAgICB1dCA9IGdldFVFVGFibGUoY2VsbCksXHJcbiAgICAgICAgICAgICAgICByYW5nZSA9IHV0LmNlbGxzUmFuZ2UsXHJcbiAgICAgICAgICAgICAgICBjZWxsSW5mbyA9IHV0LmdldENlbGxJbmZvKGNlbGwpLFxyXG4gICAgICAgICAgICAgICAgcHJlQ2VsbCA9IHV0LmdldEhTaWRlQ2VsbChjZWxsKSxcclxuICAgICAgICAgICAgICAgIG5leHRDZWxsID0gdXQuZ2V0SFNpZGVDZWxsKGNlbGwsIHRydWUpO1xyXG4gICAgICAgICAgICBpZiAodXRpbHMuaXNFbXB0eU9iamVjdChyYW5nZSkpIHtcclxuICAgICAgICAgICAgICAgIHV0LmRlbGV0ZUNvbChjZWxsSW5mby5jb2xJbmRleCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gcmFuZ2UuYmVnaW5Db2xJbmRleDsgaSA8IHJhbmdlLmVuZENvbEluZGV4ICsgMTsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXQuZGVsZXRlQ29sKHJhbmdlLmJlZ2luQ29sSW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciB0YWJsZSA9IHV0LnRhYmxlLFxyXG4gICAgICAgICAgICAgICAgcm5nID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghdGFibGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3RkJykubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbmV4dFNpYmxpbmcgPSB0YWJsZS5uZXh0U2libGluZztcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZSh0YWJsZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAobmV4dFNpYmxpbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICBybmcuc2V0U3RhcnQobmV4dFNpYmxpbmcsIDApLnNldEN1cnNvcihmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZG9tVXRpbHMuaW5Eb2MoY2VsbCwgdGhpcy5kb2N1bWVudCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBybmcuc2V0U3RhcnQoY2VsbCwgMCkuc2V0Q3Vyc29yKGZhbHNlLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRDZWxsICYmIGRvbVV0aWxzLmluRG9jKG5leHRDZWxsLCB0aGlzLmRvY3VtZW50KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBybmcuc2VsZWN0Tm9kZUNvbnRlbnRzKG5leHRDZWxsKS5zZXRDdXJzb3IoZmFsc2UsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmVDZWxsICYmIGRvbVV0aWxzLmluRG9jKHByZUNlbGwsIHRoaXMuZG9jdW1lbnQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBybmcuc2VsZWN0Tm9kZUNvbnRlbnRzKHByZUNlbGwpLnNldEN1cnNvcih0cnVlLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBVRS5jb21tYW5kc1tcInNwbGl0dG9jZWxsc1wiXSA9IHtcclxuICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZTogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgdGFibGVJdGVtcyA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLFxyXG4gICAgICAgICAgICAgICAgY2VsbCA9IHRhYmxlSXRlbXMuY2VsbDtcclxuICAgICAgICAgICAgaWYgKCFjZWxsKSByZXR1cm4gLTE7XHJcbiAgICAgICAgICAgIHZhciB1dCA9IGdldFVFVGFibGUodGFibGVJdGVtcy50YWJsZSk7XHJcbiAgICAgICAgICAgIGlmICh1dC5zZWxlY3RlZFRkcy5sZW5ndGggPiAwKSByZXR1cm4gLTE7XHJcbiAgICAgICAgICAgIHJldHVybiBjZWxsICYmIChjZWxsLmNvbFNwYW4gPiAxIHx8IGNlbGwucm93U3BhbiA+IDEpID8gMCA6IC0xO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJuZyA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCksXHJcbiAgICAgICAgICAgICAgICBiayA9IHJuZy5jcmVhdGVCb29rbWFyayh0cnVlKTtcclxuICAgICAgICAgICAgdmFyIGNlbGwgPSBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKS5jZWxsLFxyXG4gICAgICAgICAgICAgICAgdXQgPSBnZXRVRVRhYmxlKGNlbGwpO1xyXG4gICAgICAgICAgICB1dC5zcGxpdFRvQ2VsbHMoY2VsbCk7XHJcbiAgICAgICAgICAgIHJuZy5tb3ZlVG9Cb29rbWFyayhiaykuc2VsZWN0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIFVFLmNvbW1hbmRzW1wic3BsaXR0b3Jvd3NcIl0gPSB7XHJcbiAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHRhYmxlSXRlbXMgPSBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKSxcclxuICAgICAgICAgICAgICAgIGNlbGwgPSB0YWJsZUl0ZW1zLmNlbGw7XHJcbiAgICAgICAgICAgIGlmICghY2VsbCkgcmV0dXJuIC0xO1xyXG4gICAgICAgICAgICB2YXIgdXQgPSBnZXRVRVRhYmxlKHRhYmxlSXRlbXMudGFibGUpO1xyXG4gICAgICAgICAgICBpZiAodXQuc2VsZWN0ZWRUZHMubGVuZ3RoID4gMCkgcmV0dXJuIC0xO1xyXG4gICAgICAgICAgICByZXR1cm4gY2VsbCAmJiBjZWxsLnJvd1NwYW4gPiAxID8gMCA6IC0xO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIHJuZyA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCksXHJcbiAgICAgICAgICAgICAgICBiayA9IHJuZy5jcmVhdGVCb29rbWFyayh0cnVlKTtcclxuICAgICAgICAgICAgdmFyIGNlbGwgPSBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKS5jZWxsLFxyXG4gICAgICAgICAgICAgICAgdXQgPSBnZXRVRVRhYmxlKGNlbGwpO1xyXG4gICAgICAgICAgICB1dC5zcGxpdFRvUm93cyhjZWxsKTtcclxuICAgICAgICAgICAgcm5nLm1vdmVUb0Jvb2ttYXJrKGJrKS5zZWxlY3QoKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgVUUuY29tbWFuZHNbXCJzcGxpdHRvY29sc1wiXSA9IHtcclxuICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZTogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgdGFibGVJdGVtcyA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLFxyXG4gICAgICAgICAgICAgICAgY2VsbCA9IHRhYmxlSXRlbXMuY2VsbDtcclxuICAgICAgICAgICAgaWYgKCFjZWxsKSByZXR1cm4gLTE7XHJcbiAgICAgICAgICAgIHZhciB1dCA9IGdldFVFVGFibGUodGFibGVJdGVtcy50YWJsZSk7XHJcbiAgICAgICAgICAgIGlmICh1dC5zZWxlY3RlZFRkcy5sZW5ndGggPiAwKSByZXR1cm4gLTE7XHJcbiAgICAgICAgICAgIHJldHVybiBjZWxsICYmIGNlbGwuY29sU3BhbiA+IDEgPyAwIDogLTE7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcm5nID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxcclxuICAgICAgICAgICAgICAgIGJrID0gcm5nLmNyZWF0ZUJvb2ttYXJrKHRydWUpO1xyXG4gICAgICAgICAgICB2YXIgY2VsbCA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLmNlbGwsXHJcbiAgICAgICAgICAgICAgICB1dCA9IGdldFVFVGFibGUoY2VsbCk7XHJcbiAgICAgICAgICAgIHV0LnNwbGl0VG9Db2xzKGNlbGwpO1xyXG4gICAgICAgICAgICBybmcubW92ZVRvQm9va21hcmsoYmspLnNlbGVjdCgpO1xyXG5cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIFVFLmNvbW1hbmRzW1wiYWRhcHRieXRleHRcIl0gPVxyXG4gICAgICAgIFVFLmNvbW1hbmRzW1wiYWRhcHRieXdpbmRvd1wiXSA9IHtcclxuICAgICAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKS50YWJsZSA/IDAgOiAtMVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKGNtZCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHRhYmxlSXRlbXMgPSBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKSxcclxuICAgICAgICAgICAgICAgICAgICB0YWJsZSA9IHRhYmxlSXRlbXMudGFibGU7XHJcbiAgICAgICAgICAgICAgICBpZiAodGFibGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY21kID09ICdhZGFwdGJ5d2luZG93Jykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNldFRkV2lkdGgodGFibGUsIHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjZWxscyA9IGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhYmxlLCBcInRkIHRoXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1dGlscy5lYWNoKGNlbGxzLCBmdW5jdGlvbiAoY2VsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VsbC5yZW1vdmVBdHRyaWJ1dGUoXCJ3aWR0aFwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlLnJlbW92ZUF0dHJpYnV0ZShcIndpZHRoXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgLy/lubPlnYfliIbphY3lkITliJdcclxuICAgIFVFLmNvbW1hbmRzWydhdmVyYWdlZGlzdHJpYnV0ZWNvbCddID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciB1dCA9IGdldFVFVGFibGVCeVNlbGVjdGVkKHRoaXMpO1xyXG4gICAgICAgICAgICBpZiAoIXV0KSByZXR1cm4gLTE7XHJcbiAgICAgICAgICAgIHJldHVybiB1dC5pc0Z1bGxSb3coKSB8fCB1dC5pc0Z1bGxDb2woKSA/IDAgOiAtMTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoY21kKSB7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgICAgICAgICB1dCA9IGdldFVFVGFibGVCeVNlbGVjdGVkKG1lKTtcclxuXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIGdldEF2ZXJhZ2VXaWR0aCgpIHtcclxuICAgICAgICAgICAgICAgIHZhciB0YiA9IHV0LnRhYmxlLFxyXG4gICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2VXaWR0aCwgc3VtV2lkdGggPSAwLCBjb2xzTnVtID0gMCxcclxuICAgICAgICAgICAgICAgICAgICB0YkF0dHIgPSBnZXREZWZhdWx0VmFsdWUobWUsIHRiKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodXQuaXNGdWxsUm93KCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBzdW1XaWR0aCA9IHRiLm9mZnNldFdpZHRoO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbHNOdW0gPSB1dC5jb2xzTnVtO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYmVnaW4gPSB1dC5jZWxsc1JhbmdlLmJlZ2luQ29sSW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZCA9IHV0LmNlbGxzUmFuZ2UuZW5kQ29sSW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IGJlZ2luOyBpIDw9IGVuZDspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHV0LnNlbGVjdGVkVGRzW2ldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdW1XaWR0aCArPSBub2RlLm9mZnNldFdpZHRoO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpICs9IG5vZGUuY29sU3BhbjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sc051bSArPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGF2ZXJhZ2VXaWR0aCA9IE1hdGguY2VpbChzdW1XaWR0aCAvIGNvbHNOdW0pIC0gdGJBdHRyLnRkQm9yZGVyICogMiAtIHRiQXR0ci50ZFBhZGRpbmcgKiAyO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGF2ZXJhZ2VXaWR0aDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZnVuY3Rpb24gc2V0QXZlcmFnZVdpZHRoKGF2ZXJhZ2VXaWR0aCkge1xyXG4gICAgICAgICAgICAgICAgdXRpbHMuZWFjaChkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZSh1dC50YWJsZSwgXCJ0aFwiKSwgZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZShcIndpZHRoXCIsIFwiXCIpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB2YXIgY2VsbHMgPSB1dC5pc0Z1bGxSb3coKSA/IGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKHV0LnRhYmxlLCBcInRkXCIpIDogdXQuc2VsZWN0ZWRUZHM7XHJcblxyXG4gICAgICAgICAgICAgICAgdXRpbHMuZWFjaChjZWxscywgZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5jb2xTcGFuID09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoXCJ3aWR0aFwiLCBhdmVyYWdlV2lkdGgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodXQgJiYgdXQuc2VsZWN0ZWRUZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBzZXRBdmVyYWdlV2lkdGgoZ2V0QXZlcmFnZVdpZHRoKCkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIC8v5bmz5Z2H5YiG6YWN5ZCE6KGMXHJcbiAgICBVRS5jb21tYW5kc1snYXZlcmFnZWRpc3RyaWJ1dGVyb3cnXSA9IHtcclxuICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZTogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgdXQgPSBnZXRVRVRhYmxlQnlTZWxlY3RlZCh0aGlzKTtcclxuICAgICAgICAgICAgaWYgKCF1dCkgcmV0dXJuIC0xO1xyXG4gICAgICAgICAgICBpZiAodXQuc2VsZWN0ZWRUZHMgJiYgL3RoL2lnLnRlc3QodXQuc2VsZWN0ZWRUZHNbMF0udGFnTmFtZSkpIHJldHVybiAtMTtcclxuICAgICAgICAgICAgcmV0dXJuIHV0LmlzRnVsbFJvdygpIHx8IHV0LmlzRnVsbENvbCgpID8gMCA6IC0xO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uIChjbWQpIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICAgICAgICAgIHV0ID0gZ2V0VUVUYWJsZUJ5U2VsZWN0ZWQobWUpO1xyXG5cclxuICAgICAgICAgICAgZnVuY3Rpb24gZ2V0QXZlcmFnZUhlaWdodCgpIHtcclxuICAgICAgICAgICAgICAgIHZhciBhdmVyYWdlSGVpZ2h0LCByb3dOdW0sIHN1bUhlaWdodCA9IDAsXHJcbiAgICAgICAgICAgICAgICAgICAgdGIgPSB1dC50YWJsZSxcclxuICAgICAgICAgICAgICAgICAgICB0YkF0dHIgPSBnZXREZWZhdWx0VmFsdWUobWUsIHRiKSxcclxuICAgICAgICAgICAgICAgICAgICB0ZHBhZGRpbmcgPSBwYXJzZUludChkb21VdGlscy5nZXRDb21wdXRlZFN0eWxlKHRiLmdldEVsZW1lbnRzQnlUYWdOYW1lKCd0ZCcpWzBdLCBcInBhZGRpbmctdG9wXCIpKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodXQuaXNGdWxsQ29sKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgY2FwdGlvbkFyciA9IGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRiLCBcImNhcHRpb25cIiksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoQXJyID0gZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGIsIFwidGhcIiksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHRpb25IZWlnaHQsIHRoSGVpZ2h0O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoY2FwdGlvbkFyci5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHRpb25IZWlnaHQgPSBjYXB0aW9uQXJyWzBdLm9mZnNldEhlaWdodDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoQXJyLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhIZWlnaHQgPSB0aEFyclswXS5vZmZzZXRIZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBzdW1IZWlnaHQgPSB0Yi5vZmZzZXRIZWlnaHQgLSAoY2FwdGlvbkhlaWdodCB8fCAwKSAtICh0aEhlaWdodCB8fCAwKTtcclxuICAgICAgICAgICAgICAgICAgICByb3dOdW0gPSB0aEFyci5sZW5ndGggPT0gMCA/IHV0LnJvd3NOdW0gOiAodXQucm93c051bSAtIDEpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYmVnaW4gPSB1dC5jZWxsc1JhbmdlLmJlZ2luUm93SW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZCA9IHV0LmNlbGxzUmFuZ2UuZW5kUm93SW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50ID0gMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHJzID0gZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGIsIFwidHJcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IGJlZ2luOyBpIDw9IGVuZDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1bUhlaWdodCArPSB0cnNbaV0ub2Zmc2V0SGVpZ2h0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb3VudCArPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByb3dOdW0gPSBjb3VudDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vaWU45LiL5piv5re35p2C5qih5byPXHJcbiAgICAgICAgICAgICAgICBpZiAoYnJvd3Nlci5pZSAmJiBicm93c2VyLnZlcnNpb24gPCA5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXZlcmFnZUhlaWdodCA9IE1hdGguY2VpbChzdW1IZWlnaHQgLyByb3dOdW0pO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBhdmVyYWdlSGVpZ2h0ID0gTWF0aC5jZWlsKHN1bUhlaWdodCAvIHJvd051bSkgLSB0YkF0dHIudGRCb3JkZXIgKiAyIC0gdGRwYWRkaW5nICogMjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBhdmVyYWdlSGVpZ2h0O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBmdW5jdGlvbiBzZXRBdmVyYWdlSGVpZ2h0KGF2ZXJhZ2VIZWlnaHQpIHtcclxuICAgICAgICAgICAgICAgIHZhciBjZWxscyA9IHV0LmlzRnVsbENvbCgpID8gZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUodXQudGFibGUsIFwidGRcIikgOiB1dC5zZWxlY3RlZFRkcztcclxuICAgICAgICAgICAgICAgIHV0aWxzLmVhY2goY2VsbHMsIGZ1bmN0aW9uIChub2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUucm93U3BhbiA9PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKFwiaGVpZ2h0XCIsIGF2ZXJhZ2VIZWlnaHQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodXQgJiYgdXQuc2VsZWN0ZWRUZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBzZXRBdmVyYWdlSGVpZ2h0KGdldEF2ZXJhZ2VIZWlnaHQoKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIC8v5Y2V5YWD5qC85a+56b2Q5pa55byPXHJcbiAgICBVRS5jb21tYW5kc1snY2VsbGFsaWdubWVudCddID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKS50YWJsZSA/IDAgOiAtMVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uIChjbWQsIGRhdGEpIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICAgICAgICAgIHV0ID0gZ2V0VUVUYWJsZUJ5U2VsZWN0ZWQobWUpO1xyXG5cclxuICAgICAgICAgICAgaWYgKCF1dCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHN0YXJ0ID0gbWUuc2VsZWN0aW9uLmdldFN0YXJ0KCksXHJcbiAgICAgICAgICAgICAgICAgICAgY2VsbCA9IHN0YXJ0ICYmIGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUoc3RhcnQsIFtcInRkXCIsIFwidGhcIiwgXCJjYXB0aW9uXCJdLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgIGlmICghL2NhcHRpb24vaWcudGVzdChjZWxsLnRhZ05hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuc2V0QXR0cmlidXRlcyhjZWxsLCBkYXRhKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2VsbC5zdHlsZS50ZXh0QWxpZ24gPSBkYXRhLmFsaWduO1xyXG4gICAgICAgICAgICAgICAgICAgIGNlbGwuc3R5bGUudmVydGljYWxBbGlnbiA9IGRhdGEudkFsaWduO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbWUuc2VsZWN0aW9uLmdldFJhbmdlKCkuc2V0Q3Vyc29yKHRydWUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdXRpbHMuZWFjaCh1dC5zZWxlY3RlZFRkcywgZnVuY3Rpb24gKGNlbGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5zZXRBdHRyaWJ1dGVzKGNlbGwsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOafpeivouW9k+WJjeeCueWHu+eahOWNleWFg+agvOeahOWvuem9kOeKtuaAge+8jCDlpoLmnpzlvZPliY3lt7Lnu4/pgInmi6nkuoblpJrkuKrljZXlhYPmoLzvvIwg5YiZ5Lya6L+U5Zue5omA5pyJ5Y2V5YWD5qC857uP6L+H57uf5LiA5Y2P6LCD6L+H5ZCO55qE54q25oCBXHJcbiAgICAgICAgICogQHNlZSBVRS5VRVRhYmxlLmdldFRhYmxlQ2VsbEFsaWduU3RhdGVcclxuICAgICAgICAgKi9cclxuICAgICAgICBxdWVyeUNvbW1hbmRWYWx1ZTogZnVuY3Rpb24gKGNtZCkge1xyXG5cclxuICAgICAgICAgICAgdmFyIGFjdGl2ZU1lbnVDZWxsID0gZ2V0VGFibGVJdGVtc0J5UmFuZ2UoIHRoaXMpLmNlbGw7XHJcblxyXG4gICAgICAgICAgICBpZiggIWFjdGl2ZU1lbnVDZWxsICkge1xyXG4gICAgICAgICAgICAgICAgYWN0aXZlTWVudUNlbGwgPSBnZXRTZWxlY3RlZEFycih0aGlzKVswXTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKCFhY3RpdmVNZW51Q2VsbCkge1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG5cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuXHJcbiAgICAgICAgICAgICAgICAvL+iOt+WPluWQjOaXtumAieS4reeahOWFtuS7luWNleWFg+agvFxyXG4gICAgICAgICAgICAgICAgdmFyIGNlbGxzID0gVUUuVUVUYWJsZS5nZXRVRVRhYmxlKGFjdGl2ZU1lbnVDZWxsKS5zZWxlY3RlZFRkcztcclxuXHJcbiAgICAgICAgICAgICAgICAhY2VsbHMubGVuZ3RoICYmICggY2VsbHMgPSBhY3RpdmVNZW51Q2VsbCApO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBVRS5VRVRhYmxlLmdldFRhYmxlQ2VsbEFsaWduU3RhdGUoY2VsbHMpO1xyXG5cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgLy/ooajmoLzlr7npvZDmlrnlvI9cclxuICAgIFVFLmNvbW1hbmRzWyd0YWJsZWFsaWdubWVudCddID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmIChicm93c2VyLmllICYmIGJyb3dzZXIudmVyc2lvbiA8IDgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAtMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZ2V0VGFibGVJdGVtc0J5UmFuZ2UodGhpcykudGFibGUgPyAwIDogLTFcclxuICAgICAgICB9LFxyXG4gICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoY21kLCB2YWx1ZSkge1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzLFxyXG4gICAgICAgICAgICAgICAgc3RhcnQgPSBtZS5zZWxlY3Rpb24uZ2V0U3RhcnQoKSxcclxuICAgICAgICAgICAgICAgIHRhYmxlID0gc3RhcnQgJiYgZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShzdGFydCwgW1widGFibGVcIl0sIHRydWUpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICB0YWJsZS5zZXRBdHRyaWJ1dGUoXCJhbGlnblwiLHZhbHVlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgLy/ooajmoLzlsZ7mgKdcclxuICAgIFVFLmNvbW1hbmRzWydlZGl0dGFibGUnXSA9IHtcclxuICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZTogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZ2V0VGFibGVJdGVtc0J5UmFuZ2UodGhpcykudGFibGUgPyAwIDogLTFcclxuICAgICAgICB9LFxyXG4gICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoY21kLCBjb2xvcikge1xyXG4gICAgICAgICAgICB2YXIgcm5nID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxcclxuICAgICAgICAgICAgICAgIHRhYmxlID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShybmcuc3RhcnRDb250YWluZXIsICd0YWJsZScpO1xyXG4gICAgICAgICAgICBpZiAodGFibGUpIHtcclxuICAgICAgICAgICAgICAgIHZhciBhcnIgPSBkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWJsZSwgXCJ0ZFwiKS5jb25jYXQoXHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFibGUsIFwidGhcIiksXHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFibGUsIFwiY2FwdGlvblwiKVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgIHV0aWxzLmVhY2goYXJyLCBmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUuc3R5bGUuYm9yZGVyQ29sb3IgPSBjb2xvcjtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIC8v5Y2V5YWD5qC85bGe5oCnXHJcbiAgICBVRS5jb21tYW5kc1snZWRpdHRkJ10gPSB7XHJcbiAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLnRhYmxlID8gMCA6IC0xXHJcbiAgICAgICAgfSxcclxuICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKGNtZCwgYmtDb2xvcikge1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzLFxyXG4gICAgICAgICAgICAgICAgdXQgPSBnZXRVRVRhYmxlQnlTZWxlY3RlZChtZSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoIXV0KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgc3RhcnQgPSBtZS5zZWxlY3Rpb24uZ2V0U3RhcnQoKSxcclxuICAgICAgICAgICAgICAgICAgICBjZWxsID0gc3RhcnQgJiYgZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShzdGFydCwgW1widGRcIiwgXCJ0aFwiLCBcImNhcHRpb25cIl0sIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNlbGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBjZWxsLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGJrQ29sb3I7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB1dGlscy5lYWNoKHV0LnNlbGVjdGVkVGRzLCBmdW5jdGlvbiAoY2VsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNlbGwuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gYmtDb2xvcjtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBVRS5jb21tYW5kc1tcInNldHRhYmxlYmFja2dyb3VuZFwiXSA9IHtcclxuICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZTogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZ2V0U2VsZWN0ZWRBcnIodGhpcykubGVuZ3RoID4gMSA/IDAgOiAtMTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoY21kLCB2YWx1ZSkge1xyXG4gICAgICAgICAgICB2YXIgY2VsbHMsIHV0O1xyXG4gICAgICAgICAgICBjZWxscyA9IGdldFNlbGVjdGVkQXJyKHRoaXMpO1xyXG4gICAgICAgICAgICB1dCA9IGdldFVFVGFibGUoY2VsbHNbMF0pO1xyXG4gICAgICAgICAgICB1dC5zZXRCYWNrZ3JvdW5kKGNlbGxzLCB2YWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBVRS5jb21tYW5kc1tcImNsZWFydGFibGViYWNrZ3JvdW5kXCJdID0ge1xyXG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBjZWxscyA9IGdldFNlbGVjdGVkQXJyKHRoaXMpO1xyXG4gICAgICAgICAgICBpZiAoIWNlbGxzLmxlbmd0aClyZXR1cm4gLTE7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjZWxsOyBjZWxsID0gY2VsbHNbaSsrXTspIHtcclxuICAgICAgICAgICAgICAgIGlmIChjZWxsLnN0eWxlLmJhY2tncm91bmRDb2xvciAhPT0gXCJcIikgcmV0dXJuIDA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGNlbGxzID0gZ2V0U2VsZWN0ZWRBcnIodGhpcyksXHJcbiAgICAgICAgICAgICAgICB1dCA9IGdldFVFVGFibGUoY2VsbHNbMF0pO1xyXG4gICAgICAgICAgICB1dC5yZW1vdmVCYWNrZ3JvdW5kKGNlbGxzKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIFVFLmNvbW1hbmRzW1wiaW50ZXJsYWNldGFibGVcIl0gPSBVRS5jb21tYW5kc1tcInVuaW50ZXJsYWNldGFibGVcIl0gPSB7XHJcbiAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6IGZ1bmN0aW9uIChjbWQpIHtcclxuICAgICAgICAgICAgdmFyIHRhYmxlID0gZ2V0VGFibGVJdGVtc0J5UmFuZ2UodGhpcykudGFibGU7XHJcbiAgICAgICAgICAgIGlmICghdGFibGUpIHJldHVybiAtMTtcclxuICAgICAgICAgICAgdmFyIGludGVybGFjZWQgPSB0YWJsZS5nZXRBdHRyaWJ1dGUoXCJpbnRlcmxhY2VkXCIpO1xyXG4gICAgICAgICAgICBpZiAoY21kID09IFwiaW50ZXJsYWNldGFibGVcIikge1xyXG4gICAgICAgICAgICAgICAgLy9UT0RPIOW+heWumlxyXG4gICAgICAgICAgICAgICAgLy/mmK/lkKbpnIDopoHlvoXlrprvvIzlpoLmnpzorr7nva7vvIzliJnlkb3ku6Tlj6rog73ljZXmrKHmiafooYzmiJDlip/vvIzkvYblj43lsITlhbflpId0b2dnbGXmlYjmnpzvvJvlkKbliJnlj6/ku6Xopobnm5bliY3mrKHlkb3ku6TvvIzkvYblj43lsITlsIbkuI3lrZjlnKh0b2dnbGXmlYjmnpxcclxuICAgICAgICAgICAgICAgIHJldHVybiAoaW50ZXJsYWNlZCA9PT0gXCJlbmFibGVkXCIpID8gLTEgOiAwO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICghaW50ZXJsYWNlZCB8fCBpbnRlcmxhY2VkID09PSBcImRpc2FibGVkXCIpID8gLTEgOiAwO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKGNtZCwgY2xhc3NMaXN0KSB7XHJcbiAgICAgICAgICAgIHZhciB0YWJsZSA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKHRoaXMpLnRhYmxlO1xyXG4gICAgICAgICAgICBpZiAoY21kID09IFwiaW50ZXJsYWNldGFibGVcIikge1xyXG4gICAgICAgICAgICAgICAgdGFibGUuc2V0QXR0cmlidXRlKFwiaW50ZXJsYWNlZFwiLCBcImVuYWJsZWRcIik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudChcImludGVybGFjZXRhYmxlXCIsIHRhYmxlLCBjbGFzc0xpc3QpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGFibGUuc2V0QXR0cmlidXRlKFwiaW50ZXJsYWNlZFwiLCBcImRpc2FibGVkXCIpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoXCJ1bmludGVybGFjZXRhYmxlXCIsIHRhYmxlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBVRS5jb21tYW5kc1tcInNldGJvcmRlcnZpc2libGVcIl0gPSB7XHJcbiAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6IGZ1bmN0aW9uIChjbWQpIHtcclxuICAgICAgICAgICAgdmFyIHRhYmxlID0gZ2V0VGFibGVJdGVtc0J5UmFuZ2UodGhpcykudGFibGU7XHJcbiAgICAgICAgICAgIGlmICghdGFibGUpIHJldHVybiAtMTtcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgdGFibGUgPSBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKS50YWJsZTtcclxuICAgICAgICAgICAgdXRpbHMuZWFjaChkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWJsZSwndGQnKSxmdW5jdGlvbih0ZCl7XHJcbiAgICAgICAgICAgICAgICB0ZC5zdHlsZS5ib3JkZXJXaWR0aCA9ICcxcHgnO1xyXG4gICAgICAgICAgICAgICAgdGQuc3R5bGUuYm9yZGVyU3R5bGUgPSAnc29saWQnO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBmdW5jdGlvbiByZXNldFRkV2lkdGgodGFibGUsIGVkaXRvcikge1xyXG4gICAgICAgIHZhciB0ZHMgPSBkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWJsZSwndGQgdGgnKTtcclxuICAgICAgICB1dGlscy5lYWNoKHRkcywgZnVuY3Rpb24gKHRkKSB7XHJcbiAgICAgICAgICAgIHRkLnJlbW92ZUF0dHJpYnV0ZShcIndpZHRoXCIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRhYmxlLnNldEF0dHJpYnV0ZSgnd2lkdGgnLCBnZXRUYWJsZVdpZHRoKGVkaXRvciwgdHJ1ZSwgZ2V0RGVmYXVsdFZhbHVlKGVkaXRvciwgdGFibGUpKSk7XHJcbiAgICAgICAgdmFyIHRkc1dpZHRocyA9IFtdO1xyXG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB1dGlscy5lYWNoKHRkcywgZnVuY3Rpb24gKHRkKSB7XHJcbiAgICAgICAgICAgICAgICAodGQuY29sU3BhbiA9PSAxKSAmJiB0ZHNXaWR0aHMucHVzaCh0ZC5vZmZzZXRXaWR0aClcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgdXRpbHMuZWFjaCh0ZHMsIGZ1bmN0aW9uICh0ZCxpKSB7XHJcbiAgICAgICAgICAgICAgICAodGQuY29sU3BhbiA9PSAxKSAmJiB0ZC5zZXRBdHRyaWJ1dGUoXCJ3aWR0aFwiLCB0ZHNXaWR0aHNbaV0gKyBcIlwiKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9LCAwKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRUYWJsZVdpZHRoKGVkaXRvciwgbmVlZElFSGFjaywgZGVmYXVsdFZhbHVlKSB7XHJcbiAgICAgICAgdmFyIGJvZHkgPSBlZGl0b3IuYm9keTtcclxuICAgICAgICByZXR1cm4gYm9keS5vZmZzZXRXaWR0aCAtIChuZWVkSUVIYWNrID8gcGFyc2VJbnQoZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZShib2R5LCAnbWFyZ2luLWxlZnQnKSwgMTApICogMiA6IDApIC0gZGVmYXVsdFZhbHVlLnRhYmxlQm9yZGVyICogMiAtIChlZGl0b3Iub3B0aW9ucy5vZmZzZXRXaWR0aCB8fCAwKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRTZWxlY3RlZEFycihlZGl0b3IpIHtcclxuICAgICAgICB2YXIgY2VsbCA9IGdldFRhYmxlSXRlbXNCeVJhbmdlKGVkaXRvcikuY2VsbDtcclxuICAgICAgICBpZiAoY2VsbCkge1xyXG4gICAgICAgICAgICB2YXIgdXQgPSBnZXRVRVRhYmxlKGNlbGwpO1xyXG4gICAgICAgICAgICByZXR1cm4gdXQuc2VsZWN0ZWRUZHMubGVuZ3RoID8gdXQuc2VsZWN0ZWRUZHMgOiBbY2VsbF07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSkoKTtcclxuXG5cbi8vIHBsdWdpbnMvdGFibGUuYWN0aW9uLmpzXG4vKipcclxuICogQ3JlYXRlZCB3aXRoIEpldEJyYWlucyBQaHBTdG9ybS5cclxuICogVXNlcjogdGFvcWlsaVxyXG4gKiBEYXRlOiAxMi0xMC0xMlxyXG4gKiBUaW1lOiDkuIrljYgxMDowNVxyXG4gKiBUbyBjaGFuZ2UgdGhpcyB0ZW1wbGF0ZSB1c2UgRmlsZSB8IFNldHRpbmdzIHwgRmlsZSBUZW1wbGF0ZXMuXHJcbiAqL1xyXG5VRS5wbHVnaW5zWyd0YWJsZSddID0gZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICB0YWJUaW1lciA9IG51bGwsXHJcbiAgICAgICAgLy/mi5bliqjorqHml7blmahcclxuICAgICAgICB0YWJsZURyYWdUaW1lciA9IG51bGwsXHJcbiAgICAgICAgLy/lj4zlh7vorqHml7blmahcclxuICAgICAgICB0YWJsZVJlc2l6ZVRpbWVyID0gbnVsbCxcclxuICAgICAgICAvL+WNleWFg+agvOacgOWwj+WuveW6plxyXG4gICAgICAgIGNlbGxNaW5XaWR0aCA9IDUsXHJcbiAgICAgICAgaXNJblJlc2l6ZUJ1ZmZlciA9IGZhbHNlLFxyXG4gICAgICAgIC8v5Y2V5YWD5qC86L655qGG5aSn5bCPXHJcbiAgICAgICAgY2VsbEJvcmRlcldpZHRoID0gNSxcclxuICAgICAgICAvL+m8oOagh+WBj+enu+i3neemu1xyXG4gICAgICAgIG9mZnNldE9mVGFibGVDZWxsID0gMTAsXHJcbiAgICAgICAgLy/orrDlvZXlnKjmnInpmZDml7bpl7TlhoXnmoTngrnlh7vnirbmgIHvvIwg5YWx5pyJM+S4quWPluWAvO+8jCAwLCAxLCAy44CCIDDku6PooajmnKrliJ3lp4vljJbvvIwgMeS7o+ihqOWNleWHu+S6hjHmrKHvvIwy5Luj6KGoMuasoVxyXG4gICAgICAgIHNpbmdsZUNsaWNrU3RhdGUgPSAwLFxyXG4gICAgICAgIHVzZXJBY3Rpb25TdGF0dXMgPSBudWxsLFxyXG4gICAgICAgIC8v5Y+M5Ye75YWB6K6455qE5pe26Ze06IyD5Zu0XHJcbiAgICAgICAgZGJsY2xpY2tUaW1lID0gMzYwLFxyXG4gICAgICAgIFVUID0gVUUuVUVUYWJsZSxcclxuICAgICAgICBnZXRVRVRhYmxlID0gZnVuY3Rpb24gKHRkT3JUYWJsZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gVVQuZ2V0VUVUYWJsZSh0ZE9yVGFibGUpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0VUVUYWJsZUJ5U2VsZWN0ZWQgPSBmdW5jdGlvbiAoZWRpdG9yKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBVVC5nZXRVRVRhYmxlQnlTZWxlY3RlZChlZGl0b3IpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0RGVmYXVsdFZhbHVlID0gZnVuY3Rpb24gKGVkaXRvciwgdGFibGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFVULmdldERlZmF1bHRWYWx1ZShlZGl0b3IsIHRhYmxlKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHJlbW92ZVNlbGVjdGVkQ2xhc3MgPSBmdW5jdGlvbiAoY2VsbHMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFVULnJlbW92ZVNlbGVjdGVkQ2xhc3MoY2VsbHMpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gc2hvd0Vycm9yKGUpIHtcclxuLy8gICAgICAgIHRocm93IGU7XHJcbiAgICB9XHJcbiAgICBtZS5yZWFkeShmdW5jdGlvbigpe1xyXG4gICAgICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICAgICAgdmFyIG9yZ0dldFRleHQgPSBtZS5zZWxlY3Rpb24uZ2V0VGV4dDtcclxuICAgICAgICBtZS5zZWxlY3Rpb24uZ2V0VGV4dCA9IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgIHZhciB0YWJsZSA9IGdldFVFVGFibGVCeVNlbGVjdGVkKG1lKTtcclxuICAgICAgICAgICAgaWYodGFibGUpe1xyXG4gICAgICAgICAgICAgICAgdmFyIHN0ciA9ICcnO1xyXG4gICAgICAgICAgICAgICAgdXRpbHMuZWFjaCh0YWJsZS5zZWxlY3RlZFRkcyxmdW5jdGlvbih0ZCl7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RyICs9IHRkW2Jyb3dzZXIuaWU/J2lubmVyVGV4dCc6J3RleHRDb250ZW50J107XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0cjtcclxuICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb3JnR2V0VGV4dC5jYWxsKG1lLnNlbGVjdGlvbilcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICB9KVxyXG5cclxuICAgIC8v5aSE55CG5ouW5Yqo5Y+K5qGG6YCJ55u45YWz5pa55rOVXHJcbiAgICB2YXIgc3RhcnRUZCA9IG51bGwsIC8v6byg5qCH5oyJ5LiL5pe255qE6ZSa54K5dGRcclxuICAgICAgICBjdXJyZW50VGQgPSBudWxsLCAvL+W9k+WJjem8oOagh+e7j+i/h+aXtueahHRkXHJcbiAgICAgICAgb25EcmFnID0gXCJcIiwgLy/mjIfnpLrlvZPliY3mi5bliqjnirbmgIHvvIzlhbblgLzlj6/kuLpcIlwiLFwiaFwiLFwidlwiICzliIbliKvooajnpLrmnKrmi5bliqjnirbmgIHvvIzmqKrlkJHmi5bliqjnirbmgIHvvIznurXlkJHmi5bliqjnirbmgIHvvIznlKjkuo7pvKDmoIfnp7vliqjov4fnqIvkuK3nmoTliKTmlq1cclxuICAgICAgICBvbkJvcmRlciA9IGZhbHNlLCAvL+ajgOa1i+m8oOagh+aMieS4i+aXtuaYr+WQpuWkhOWcqOWNleWFg+agvOi+uee8mOS9jee9rlxyXG4gICAgICAgIGRyYWdCdXR0b24gPSBudWxsLFxyXG4gICAgICAgIGRyYWdPdmVyID0gZmFsc2UsXHJcbiAgICAgICAgZHJhZ0xpbmUgPSBudWxsLCAvL+aooeaLn+eahOaLluWKqOe6v1xyXG4gICAgICAgIGRyYWdUZCA9IG51bGw7ICAgIC8v5Y+R55Sf5ouW5Yqo55qE55uu5qCHdGRcclxuXHJcbiAgICB2YXIgbW91c2Vkb3duID0gZmFsc2UsXHJcbiAgICAvL3RvZG8g5Yik5pat5re35Lmx5qih5byPXHJcbiAgICAgICAgbmVlZElFSGFjayA9IHRydWU7XHJcblxyXG4gICAgbWUuc2V0T3B0KHtcclxuICAgICAgICAnbWF4Q29sTnVtJzoyMCxcclxuICAgICAgICAnbWF4Um93TnVtJzoxMDAsXHJcbiAgICAgICAgJ2RlZmF1bHRDb2xzJzo1LFxyXG4gICAgICAgICdkZWZhdWx0Um93cyc6NSxcclxuICAgICAgICAndGR2YWxpZ24nOid0b3AnLFxyXG4gICAgICAgICdjdXJzb3JwYXRoJzptZS5vcHRpb25zLlVFRElUT1JfSE9NRV9VUkwgKyBcInRoZW1lcy9kZWZhdWx0L2ltYWdlcy9jdXJzb3JfXCIsXHJcbiAgICAgICAgJ3RhYmxlRHJhZ2FibGUnOmZhbHNlLFxyXG4gICAgICAgICdjbGFzc0xpc3QnOltcInVlLXRhYmxlLWludGVybGFjZS1jb2xvci1zaW5nbGVcIixcInVlLXRhYmxlLWludGVybGFjZS1jb2xvci1kb3VibGVcIl1cclxuICAgIH0pO1xyXG4gICAgbWUuZ2V0VUVUYWJsZSA9IGdldFVFVGFibGU7XHJcbiAgICB2YXIgY29tbWFuZHMgPSB7XHJcbiAgICAgICAgJ2RlbGV0ZXRhYmxlJzoxLFxyXG4gICAgICAgICdpbnNlcnR0YWJsZSc6MSxcclxuICAgICAgICAnY2VsbHZhbGlnbic6MSxcclxuICAgICAgICAnaW5zZXJ0Y2FwdGlvbic6MSxcclxuICAgICAgICAnZGVsZXRlY2FwdGlvbic6MSxcclxuICAgICAgICAnaW5zZXJ0dGl0bGUnOjEsXHJcbiAgICAgICAgJ2RlbGV0ZXRpdGxlJzoxLFxyXG4gICAgICAgIFwibWVyZ2VyaWdodFwiOjEsXHJcbiAgICAgICAgXCJtZXJnZWRvd25cIjoxLFxyXG4gICAgICAgIFwibWVyZ2VjZWxsc1wiOjEsXHJcbiAgICAgICAgXCJpbnNlcnRyb3dcIjoxLFxyXG4gICAgICAgIFwiaW5zZXJ0cm93bmV4dFwiOjEsXHJcbiAgICAgICAgXCJkZWxldGVyb3dcIjoxLFxyXG4gICAgICAgIFwiaW5zZXJ0Y29sXCI6MSxcclxuICAgICAgICBcImluc2VydGNvbG5leHRcIjoxLFxyXG4gICAgICAgIFwiZGVsZXRlY29sXCI6MSxcclxuICAgICAgICBcInNwbGl0dG9jZWxsc1wiOjEsXHJcbiAgICAgICAgXCJzcGxpdHRvcm93c1wiOjEsXHJcbiAgICAgICAgXCJzcGxpdHRvY29sc1wiOjEsXHJcbiAgICAgICAgXCJhZGFwdGJ5dGV4dFwiOjEsXHJcbiAgICAgICAgXCJhZGFwdGJ5d2luZG93XCI6MSxcclxuICAgICAgICBcImFkYXB0YnljdXN0b21lclwiOjEsXHJcbiAgICAgICAgXCJpbnNlcnRwYXJhZ3JhcGhcIjoxLFxyXG4gICAgICAgIFwiaW5zZXJ0cGFyYWdyYXBoYmVmb3JldGFibGVcIjoxLFxyXG4gICAgICAgIFwiYXZlcmFnZWRpc3RyaWJ1dGVjb2xcIjoxLFxyXG4gICAgICAgIFwiYXZlcmFnZWRpc3RyaWJ1dGVyb3dcIjoxXHJcbiAgICB9O1xyXG4gICAgbWUucmVhZHkoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHV0aWxzLmNzc1J1bGUoJ3RhYmxlJyxcclxuICAgICAgICAgICAgLy/pgInkuK3nmoR0ZOS4iueahOagt+W8j1xyXG4gICAgICAgICAgICAnLnNlbGVjdFRkQ2xhc3N7YmFja2dyb3VuZC1jb2xvcjojZWRmNWZhICFpbXBvcnRhbnR9JyArXHJcbiAgICAgICAgICAgICAgICAndGFibGUubm9Cb3JkZXJUYWJsZSB0ZCx0YWJsZS5ub0JvcmRlclRhYmxlIHRoLHRhYmxlLm5vQm9yZGVyVGFibGUgY2FwdGlvbntib3JkZXI6MXB4IGRhc2hlZCAjZGRkICFpbXBvcnRhbnR9JyArXHJcbiAgICAgICAgICAgICAgICAvL+aPkuWFpeeahOihqOagvOeahOm7mOiupOagt+W8j1xyXG4gICAgICAgICAgICAgICAgJ3RhYmxle21hcmdpbi1ib3R0b206MTBweDtib3JkZXItY29sbGFwc2U6Y29sbGFwc2U7ZGlzcGxheTp0YWJsZTt9JyArXHJcbiAgICAgICAgICAgICAgICAndGQsdGh7cGFkZGluZzogNXB4IDEwcHg7Ym9yZGVyOiAxcHggc29saWQgI0RERDt9JyArXHJcbiAgICAgICAgICAgICAgICAnY2FwdGlvbntib3JkZXI6MXB4IGRhc2hlZCAjREREO2JvcmRlci1ib3R0b206MDtwYWRkaW5nOjNweDt0ZXh0LWFsaWduOmNlbnRlcjt9JyArXHJcbiAgICAgICAgICAgICAgICAndGh7Ym9yZGVyLXRvcDoxcHggc29saWQgI0JCQjtiYWNrZ3JvdW5kLWNvbG9yOiNGN0Y3Rjc7fScgK1xyXG4gICAgICAgICAgICAgICAgJ3RhYmxlIHRyLmZpcnN0Um93IHRoe2JvcmRlci10b3Atd2lkdGg6MnB4O30nICtcclxuICAgICAgICAgICAgICAgICcudWUtdGFibGUtaW50ZXJsYWNlLWNvbG9yLXNpbmdsZXsgYmFja2dyb3VuZC1jb2xvcjogI2ZjZmNmYzsgfSAudWUtdGFibGUtaW50ZXJsYWNlLWNvbG9yLWRvdWJsZXsgYmFja2dyb3VuZC1jb2xvcjogI2Y3ZmFmZjsgfScgK1xyXG4gICAgICAgICAgICAgICAgJ3RkIHB7bWFyZ2luOjA7cGFkZGluZzowO30nLCBtZS5kb2N1bWVudCk7XHJcblxyXG4gICAgICAgIHZhciB0YWJsZUNvcHlMaXN0LCBpc0Z1bGxDb2wsIGlzRnVsbFJvdztcclxuICAgICAgICAvL+azqOWGjGRlbC9iYWNrc3BhY2Xkuovku7ZcclxuICAgICAgICBtZS5hZGRMaXN0ZW5lcigna2V5ZG93bicsIGZ1bmN0aW9uIChjbWQsIGV2dCkge1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICB2YXIga2V5Q29kZSA9IGV2dC5rZXlDb2RlIHx8IGV2dC53aGljaDtcclxuXHJcbiAgICAgICAgICAgIGlmIChrZXlDb2RlID09IDgpIHtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgdXQgPSBnZXRVRVRhYmxlQnlTZWxlY3RlZChtZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAodXQgJiYgdXQuc2VsZWN0ZWRUZHMubGVuZ3RoKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh1dC5pc0Z1bGxDb2woKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5leGVjQ29tbWFuZCgnZGVsZXRlY29sJylcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHV0LmlzRnVsbFJvdygpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKCdkZWxldGVyb3cnKVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnZGVsY2VsbHMnKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucHJldmVudERlZmF1bHQoZXZ0KTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgY2FwdGlvbiA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUobWUuc2VsZWN0aW9uLmdldFN0YXJ0KCksICdjYXB0aW9uJywgdHJ1ZSksXHJcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuICAgICAgICAgICAgICAgIGlmIChyYW5nZS5jb2xsYXBzZWQgJiYgY2FwdGlvbiAmJiBpc0VtcHR5QmxvY2soY2FwdGlvbikpIHtcclxuICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NhdmVTY2VuZScpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB0YWJsZSA9IGNhcHRpb24ucGFyZW50Tm9kZTtcclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoY2FwdGlvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KHRhYmxlLnJvd3NbMF0uY2VsbHNbMF0sIDApLnNldEN1cnNvcihmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnc2F2ZVNjZW5lJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoa2V5Q29kZSA9PSA0Nikge1xyXG5cclxuICAgICAgICAgICAgICAgIHV0ID0gZ2V0VUVUYWJsZUJ5U2VsZWN0ZWQobWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHV0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdzYXZlU2NlbmUnKTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2k7IGNpID0gdXQuc2VsZWN0ZWRUZHNbaSsrXTspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuZmlsbE5vZGUobWUuZG9jdW1lbnQsIGNpKVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NhdmVTY2VuZScpO1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnByZXZlbnREZWZhdWx0KGV2dCk7XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoa2V5Q29kZSA9PSAxMykge1xyXG5cclxuICAgICAgICAgICAgICAgIHZhciBybmcgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxcclxuICAgICAgICAgICAgICAgICAgICBjYXB0aW9uID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShybmcuc3RhcnRDb250YWluZXIsICdjYXB0aW9uJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2FwdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB0YWJsZSA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUoY2FwdGlvbiwgJ3RhYmxlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFybmcuY29sbGFwc2VkKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBybmcuZGVsZXRlQ29udGVudHMoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdzYXZlU2NlbmUnKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FwdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcm5nLnNldFN0YXJ0KHRhYmxlLnJvd3NbMF0uY2VsbHNbMF0sIDApLnNldEN1cnNvcihmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucHJldmVudERlZmF1bHQoZXZ0KTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAocm5nLmNvbGxhcHNlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB0YWJsZSA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocm5nLnN0YXJ0Q29udGFpbmVyLCAndGFibGUnKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGFibGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNlbGwgPSB0YWJsZS5yb3dzWzBdLmNlbGxzWzBdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKG1lLnNlbGVjdGlvbi5nZXRTdGFydCgpLCBbJ3RkJywgJ3RoJ10sIHRydWUpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlTm9kZSA9IHRhYmxlLnByZXZpb3VzU2libGluZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNlbGwgPT09IHN0YXJ0ICYmICghcHJlTm9kZSB8fCBwcmVOb2RlLm5vZGVUeXBlID09IDEgJiYgcHJlTm9kZS50YWdOYW1lID09ICdUQUJMRScgKSAmJiBkb21VdGlscy5pc1N0YXJ0SW5ibG9jayhybmcpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZmlyc3QgPSBkb21VdGlscy5maW5kUGFyZW50KG1lLnNlbGVjdGlvbi5nZXRTdGFydCgpLCBmdW5jdGlvbihuKXtyZXR1cm4gZG9tVXRpbHMuaXNCbG9ja0VsbShuKX0sIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZmlyc3QgJiYgKCAvdChofGQpL2kudGVzdChmaXJzdC50YWdOYW1lKSB8fCBmaXJzdCA9PT0gIHN0YXJ0LmZpcnN0Q2hpbGQgKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuZXhlY0NvbW1hbmQoJ2luc2VydHBhcmFncmFwaGJlZm9yZXRhYmxlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucHJldmVudERlZmF1bHQoZXZ0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICgoZXZ0LmN0cmxLZXkgfHwgZXZ0Lm1ldGFLZXkpICYmIGV2dC5rZXlDb2RlID09ICc2NycpIHtcclxuICAgICAgICAgICAgICAgIHRhYmxlQ29weUxpc3QgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgdmFyIHV0ID0gZ2V0VUVUYWJsZUJ5U2VsZWN0ZWQobWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHV0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRkcyA9IHV0LnNlbGVjdGVkVGRzO1xyXG4gICAgICAgICAgICAgICAgICAgIGlzRnVsbENvbCA9IHV0LmlzRnVsbENvbCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlzRnVsbFJvdyA9IHV0LmlzRnVsbFJvdygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRhYmxlQ29weUxpc3QgPSBbXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFt1dC5jbG9uZUNlbGwodGRzWzBdLG51bGwsdHJ1ZSldXHJcbiAgICAgICAgICAgICAgICAgICAgXTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMSwgY2k7IGNpID0gdGRzW2ldOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNpLnBhcmVudE5vZGUgIT09IHRkc1tpIC0gMV0ucGFyZW50Tm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVDb3B5TGlzdC5wdXNoKFt1dC5jbG9uZUNlbGwoY2ksbnVsbCx0cnVlKV0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVDb3B5TGlzdFt0YWJsZUNvcHlMaXN0Lmxlbmd0aCAtIDFdLnB1c2godXQuY2xvbmVDZWxsKGNpLG51bGwsdHJ1ZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIG1lLmFkZExpc3RlbmVyKFwidGFibGVoYXNkZWxldGVkXCIsZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgdG9nZ2xlRHJhZ2dhYmxlU3RhdGUodGhpcywgZmFsc2UsIFwiXCIsIG51bGwpO1xyXG4gICAgICAgICAgICBpZiAoZHJhZ0J1dHRvbilkb21VdGlscy5yZW1vdmUoZHJhZ0J1dHRvbik7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIG1lLmFkZExpc3RlbmVyKCdiZWZvcmVwYXN0ZScsIGZ1bmN0aW9uIChjbWQsIGh0bWwpIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcclxuICAgICAgICAgICAgdmFyIHJuZyA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xyXG4gICAgICAgICAgICBpZiAoZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShybmcuc3RhcnRDb250YWluZXIsICdjYXB0aW9uJywgdHJ1ZSkpIHtcclxuICAgICAgICAgICAgICAgIHZhciBkaXYgPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9IGh0bWwuaHRtbDtcclxuICAgICAgICAgICAgICAgIC8vdHJhY2U6MzcyOVxyXG4gICAgICAgICAgICAgICAgaHRtbC5odG1sID0gZGl2W2Jyb3dzZXIuaWU5YmVsb3cgPyAnaW5uZXJUZXh0JyA6ICd0ZXh0Q29udGVudCddO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciB0YWJsZSA9IGdldFVFVGFibGVCeVNlbGVjdGVkKG1lKTtcclxuICAgICAgICAgICAgaWYgKHRhYmxlQ29weUxpc3QpIHtcclxuICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnc2F2ZVNjZW5lJyk7XHJcbiAgICAgICAgICAgICAgICB2YXIgcm5nID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgdGQgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHJuZy5zdGFydENvbnRhaW5lciwgWyd0ZCcsICd0aCddLCB0cnVlKSwgdG1wTm9kZSwgcHJlTm9kZTtcclxuICAgICAgICAgICAgICAgIGlmICh0ZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB1dCA9IGdldFVFVGFibGUodGQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bGxSb3cpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvd0luZGV4ID0gdXQuZ2V0Q2VsbEluZm8odGQpLnJvd0luZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGQudGFnTmFtZSA9PSAnVEgnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3dJbmRleCsrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSB0YWJsZUNvcHlMaXN0W2krK107KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHIgPSB1dC5pbnNlcnRSb3cocm93SW5kZXgrKywgXCJ0ZFwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBjajsgY2ogPSBjaVtqXTsgaisrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNlbGwgPSB0ci5jZWxsc1tqXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNlbGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VsbCA9IHRyLmluc2VydENlbGwoailcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VsbC5pbm5lckhUTUwgPSBjai5pbm5lckhUTUw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2ouZ2V0QXR0cmlidXRlKCd3aWR0aCcpICYmIGNlbGwuc2V0QXR0cmlidXRlKCd3aWR0aCcsIGNqLmdldEF0dHJpYnV0ZSgnd2lkdGgnKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2ouZ2V0QXR0cmlidXRlKCd2QWxpZ24nKSAmJiBjZWxsLnNldEF0dHJpYnV0ZSgndkFsaWduJywgY2ouZ2V0QXR0cmlidXRlKCd2QWxpZ24nKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2ouZ2V0QXR0cmlidXRlKCdhbGlnbicpICYmIGNlbGwuc2V0QXR0cmlidXRlKCdhbGlnbicsIGNqLmdldEF0dHJpYnV0ZSgnYWxpZ24nKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2ouc3R5bGUuY3NzVGV4dCAmJiAoY2VsbC5zdHlsZS5jc3NUZXh0ID0gY2ouc3R5bGUuY3NzVGV4dClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBjajsgY2ogPSB0ci5jZWxsc1tqXTsgaisrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjaVtqXSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2ouaW5uZXJIVE1MID0gY2lbal0uaW5uZXJIVE1MO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNpW2pdLmdldEF0dHJpYnV0ZSgnd2lkdGgnKSAmJiBjai5zZXRBdHRyaWJ1dGUoJ3dpZHRoJywgY2lbal0uZ2V0QXR0cmlidXRlKCd3aWR0aCcpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaVtqXS5nZXRBdHRyaWJ1dGUoJ3ZBbGlnbicpICYmIGNqLnNldEF0dHJpYnV0ZSgndkFsaWduJywgY2lbal0uZ2V0QXR0cmlidXRlKCd2QWxpZ24nKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2lbal0uZ2V0QXR0cmlidXRlKCdhbGlnbicpICYmIGNqLnNldEF0dHJpYnV0ZSgnYWxpZ24nLCBjaVtqXS5nZXRBdHRyaWJ1dGUoJ2FsaWduJykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNpW2pdLnN0eWxlLmNzc1RleHQgJiYgKGNqLnN0eWxlLmNzc1RleHQgPSBjaVtqXS5zdHlsZS5jc3NUZXh0KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVsbENvbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VsbEluZm8gPSB1dC5nZXRDZWxsSW5mbyh0ZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWF4Q29sTnVtID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBjaSA9IHRhYmxlQ29weUxpc3RbMF0sIGNqOyBjaiA9IGNpW2orK107KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4Q29sTnVtICs9IGNqLmNvbFNwYW4gfHwgMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLl9faGFzRW50ZXJFeGVjQ29tbWFuZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbWF4Q29sTnVtOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5leGVjQ29tbWFuZCgnaW5zZXJ0Y29sJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5fX2hhc0VudGVyRXhlY0NvbW1hbmQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRkID0gdXQudGFibGUucm93c1swXS5jZWxsc1tjZWxsSW5mby5jZWxsSW5kZXhdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRkLnRhZ05hbWUgPT0gJ1RIJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRkID0gdXQudGFibGUucm93c1sxXS5jZWxsc1tjZWxsSW5mby5jZWxsSW5kZXhdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSB0YWJsZUNvcHlMaXN0W2krK107KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBOb2RlID0gdGQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgY2o7IGNqID0gY2lbaisrXTspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGQuaW5uZXJIVE1MID0gY2ouaW5uZXJIVE1MO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3RvZG8g5a6a5Yi25aSE55CGXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNqLmdldEF0dHJpYnV0ZSgnd2lkdGgnKSAmJiB0ZC5zZXRBdHRyaWJ1dGUoJ3dpZHRoJywgY2ouZ2V0QXR0cmlidXRlKCd3aWR0aCcpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2ouZ2V0QXR0cmlidXRlKCd2QWxpZ24nKSAmJiB0ZC5zZXRBdHRyaWJ1dGUoJ3ZBbGlnbicsIGNqLmdldEF0dHJpYnV0ZSgndkFsaWduJykpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjai5nZXRBdHRyaWJ1dGUoJ2FsaWduJykgJiYgdGQuc2V0QXR0cmlidXRlKCdhbGlnbicsIGNqLmdldEF0dHJpYnV0ZSgnYWxpZ24nKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNqLnN0eWxlLmNzc1RleHQgJiYgKHRkLnN0eWxlLmNzc1RleHQgPSBjai5zdHlsZS5jc3NUZXh0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlTm9kZSA9IHRkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZCA9IHRkLm5leHRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjbG9uZVRkID0gY2ouY2xvbmVOb2RlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmVBdHRyaWJ1dGVzKGNsb25lVGQsIFsnY2xhc3MnLCAncm93U3BhbicsICdjb2xTcGFuJ10pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlTm9kZS5wYXJlbnROb2RlLmFwcGVuZENoaWxkKGNsb25lVGQpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGQgPSB1dC5nZXROZXh0Q2VsbCh0bXBOb2RlLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGFibGVDb3B5TGlzdFtpXSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2VsbEluZm8gPSB1dC5nZXRDZWxsSW5mbyh0bXBOb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1dC50YWJsZS5pbnNlcnRSb3codXQudGFibGUucm93cy5sZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHV0LnVwZGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRkID0gdXQuZ2V0VlNpZGVDZWxsKHRtcE5vZGUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHV0LnVwZGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0YWJsZSA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IHRhYmxlQ29weUxpc3RbaSsrXTspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRyID0gdGFibGUuaW5zZXJ0Um93KHRhYmxlLnJvd3MubGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGNqOyBjaiA9IGNpW2orK107KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbG9uZVRkID0gVVQuY2xvbmVDZWxsKGNqLG51bGwsdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmVBdHRyaWJ1dGVzKGNsb25lVGQsIFsnY2xhc3MnXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ci5hcHBlbmRDaGlsZChjbG9uZVRkKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqID09IDIgJiYgY2xvbmVUZC5yb3dTcGFuID4gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xvbmVUZC5yb3dTcGFuID0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IGdldERlZmF1bHRWYWx1ZShtZSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoID0gbWUuYm9keS5vZmZzZXRXaWR0aCAtXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAobmVlZElFSGFjayA/IHBhcnNlSW50KGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUobWUuYm9keSwgJ21hcmdpbi1sZWZ0JyksIDEwKSAqIDIgOiAwKSAtIGRlZmF1bHRWYWx1ZS50YWJsZUJvcmRlciAqIDIgLSAobWUub3B0aW9ucy5vZmZzZXRXaWR0aCB8fCAwKTtcclxuICAgICAgICAgICAgICAgICAgICBtZS5leGVjQ29tbWFuZCgnaW5zZXJ0SFRNTCcsICc8dGFibGUgICcgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAoIGlzRnVsbENvbCAmJiBpc0Z1bGxSb3cgPyAnd2lkdGg9XCInICsgd2lkdGggKyAnXCInIDogJycpICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJz4nICsgdGFibGUuaW5uZXJIVE1MLnJlcGxhY2UoLz5cXHMqPC9nLCAnPjwnKS5yZXBsYWNlKC9cXGJ0aFxcYi9naSwgXCJ0ZFwiKSArICc8L3RhYmxlPicpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ2NvbnRlbnRjaGFuZ2UnKTtcclxuICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnc2F2ZVNjZW5lJyk7XHJcbiAgICAgICAgICAgICAgICBodG1sLmh0bWwgPSAnJztcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIGRpdiA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiksIHRhYmxlcztcclxuICAgICAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSBodG1sLmh0bWw7XHJcbiAgICAgICAgICAgICAgICB0YWJsZXMgPSBkaXYuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJ0YWJsZVwiKTtcclxuICAgICAgICAgICAgICAgIGlmIChkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKG1lLnNlbGVjdGlvbi5nZXRTdGFydCgpLCAndGFibGUnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHV0aWxzLmVhY2godGFibGVzLCBmdW5jdGlvbiAodCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUodClcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShtZS5zZWxlY3Rpb24uZ2V0U3RhcnQoKSwgJ2NhcHRpb24nLCB0cnVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gZGl2W2Jyb3dzZXIuaWUgPyAnaW5uZXJUZXh0JyA6ICd0ZXh0Q29udGVudCddO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXRpbHMuZWFjaCh0YWJsZXMsIGZ1bmN0aW9uICh0YWJsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVTdHlsZVNpemUodGFibGUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmVBdHRyaWJ1dGVzKHRhYmxlLCBbJ3N0eWxlJywgJ2JvcmRlciddKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXRpbHMuZWFjaChkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWJsZSwgXCJ0ZFwiKSwgZnVuY3Rpb24gKHRkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNFbXB0eUJsb2NrKHRkKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmZpbGxOb2RlKG1lLmRvY3VtZW50LCB0ZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVTdHlsZVNpemUodGQsIHRydWUpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmVBdHRyaWJ1dGVzKHRkLCBbJ3N0eWxlJ10pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaHRtbC5odG1sID0gZGl2LmlubmVySFRNTDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBtZS5hZGRMaXN0ZW5lcignYWZ0ZXJwYXN0ZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdXRpbHMuZWFjaChkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZShtZS5ib2R5LCBcInRhYmxlXCIpLCBmdW5jdGlvbiAodGFibGUpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0YWJsZS5vZmZzZXRXaWR0aCA+IG1lLmJvZHkub2Zmc2V0V2lkdGgpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZGVmYXVsdFZhbHVlID0gZ2V0RGVmYXVsdFZhbHVlKG1lLCB0YWJsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGFibGUuc3R5bGUud2lkdGggPSBtZS5ib2R5Lm9mZnNldFdpZHRoIC0gKG5lZWRJRUhhY2sgPyBwYXJzZUludChkb21VdGlscy5nZXRDb21wdXRlZFN0eWxlKG1lLmJvZHksICdtYXJnaW4tbGVmdCcpLCAxMCkgKiAyIDogMCkgLSBkZWZhdWx0VmFsdWUudGFibGVCb3JkZXIgKiAyIC0gKG1lLm9wdGlvbnMub2Zmc2V0V2lkdGggfHwgMCkgKyAncHgnXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbWUuYWRkTGlzdGVuZXIoJ2JsdXInLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHRhYmxlQ29weUxpc3QgPSBudWxsO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHZhciB0aW1lcjtcclxuICAgICAgICBtZS5hZGRMaXN0ZW5lcigna2V5ZG93bicsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcclxuICAgICAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHZhciBybmcgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxcclxuICAgICAgICAgICAgICAgICAgICBjZWxsID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShybmcuc3RhcnRDb250YWluZXIsIFsndGgnLCAndGQnXSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2VsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB0YWJsZSA9IGNlbGwucGFyZW50Tm9kZS5wYXJlbnROb2RlLnBhcmVudE5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhYmxlLm9mZnNldFdpZHRoID4gdGFibGUuZ2V0QXR0cmlidXRlKFwid2lkdGhcIikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2VsbC5zdHlsZS53b3JkQnJlYWsgPSBcImJyZWFrLWFsbFwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIH0sIDEwMCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbWUuYWRkTGlzdGVuZXIoXCJzZWxlY3Rpb25jaGFuZ2VcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB0b2dnbGVEcmFnZ2FibGVTdGF0ZShtZSwgZmFsc2UsIFwiXCIsIG51bGwpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgLy/lhoXlrrnlj5jljJbml7bop6blj5HntKLlvJXmm7TmlrBcclxuICAgICAgICAvL3RvZG8g5Y+v5ZCm6ICD6JmR5qCH6K6w5qOA5rWL77yM5aaC5p6c5LiN5raJ5Y+K6KGo5qC855qE5Y+Y5YyW5bCx5LiN6L+b6KGM57Si5byV6YeN5bu65ZKM5pu05pawXHJcbiAgICAgICAgbWUuYWRkTGlzdGVuZXIoXCJjb250ZW50Y2hhbmdlXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcclxuICAgICAgICAgICAgLy/lsL3lj6/og73mjpLpmaTkuIDkupvkuI3pnIDopoHmm7TmlrDnmoTnirblhrVcclxuICAgICAgICAgICAgaGlkZURyYWdMaW5lKG1lKTtcclxuICAgICAgICAgICAgaWYgKGdldFVFVGFibGVCeVNlbGVjdGVkKG1lKSlyZXR1cm47XHJcbiAgICAgICAgICAgIHZhciBybmcgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuICAgICAgICAgICAgdmFyIHN0YXJ0ID0gcm5nLnN0YXJ0Q29udGFpbmVyO1xyXG4gICAgICAgICAgICBzdGFydCA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUoc3RhcnQsIFsndGQnLCAndGgnXSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIHV0aWxzLmVhY2goZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUobWUuZG9jdW1lbnQsICd0YWJsZScpLCBmdW5jdGlvbiAodGFibGUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChtZS5maXJlRXZlbnQoXCJleGNsdWRldGFibGVcIiwgdGFibGUpID09PSB0cnVlKSByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB0YWJsZS51ZVRhYmxlID0gbmV3IFVUKHRhYmxlKTtcclxuICAgICAgICAgICAgICAgIC8vdHJhY2U6Mzc0MlxyXG4vLyAgICAgICAgICAgICAgICB1dGlscy5lYWNoKGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKG1lLmRvY3VtZW50LCAndGQnKSwgZnVuY3Rpb24gKHRkKSB7XHJcbi8vXHJcbi8vICAgICAgICAgICAgICAgICAgICBpZiAoZG9tVXRpbHMuaXNFbXB0eUJsb2NrKHRkKSAmJiB0ZCAhPT0gc3RhcnQpIHtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5maWxsTm9kZShtZS5kb2N1bWVudCwgdGQpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgIGlmIChicm93c2VyLmllICYmIGJyb3dzZXIudmVyc2lvbiA9PSA2KSB7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRkLmlubmVySFRNTCA9ICcmbmJzcDsnXHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgICAgICAgICB9KTtcclxuLy8gICAgICAgICAgICAgICAgdXRpbHMuZWFjaChkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZShtZS5kb2N1bWVudCwgJ3RoJyksIGZ1bmN0aW9uICh0aCkge1xyXG4vLyAgICAgICAgICAgICAgICAgICAgaWYgKGRvbVV0aWxzLmlzRW1wdHlCbG9jayh0aCkgJiYgdGggIT09IHN0YXJ0KSB7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuZmlsbE5vZGUobWUuZG9jdW1lbnQsIHRoKTtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnJvd3Nlci5pZSAmJiBicm93c2VyLnZlcnNpb24gPT0gNikge1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aC5pbm5lckhUTUwgPSAnJm5ic3A7J1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuLy8gICAgICAgICAgICAgICAgICAgIH1cclxuLy8gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB0YWJsZS5vbm1vdXNlb3ZlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3RhYmxlbW91c2VvdmVyJywgdGFibGUpO1xyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHRhYmxlLm9ubW91c2Vtb3ZlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgndGFibGVtb3VzZW1vdmUnLCB0YWJsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUub3B0aW9ucy50YWJsZURyYWdhYmxlICYmIHRvZ2dsZURyYWdCdXR0b24odHJ1ZSwgdGhpcywgbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHV0aWxzLmRlZmVyKGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnY29udGVudGNoYW5nZScsNTApXHJcbiAgICAgICAgICAgICAgICAgICAgfSx0cnVlKVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHRhYmxlLm9ubW91c2VvdXQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCd0YWJsZW1vdXNlb3V0JywgdGFibGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRvZ2dsZURyYWdnYWJsZVN0YXRlKG1lLCBmYWxzZSwgXCJcIiwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaGlkZURyYWdMaW5lKG1lKTtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB0YWJsZS5vbmNsaWNrID0gZnVuY3Rpb24gKGV2dCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGV2dCA9IG1lLndpbmRvdy5ldmVudCB8fCBldnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IGdldFBhcmVudFRkT3JUaChldnQudGFyZ2V0IHx8IGV2dC5zcmNFbGVtZW50KTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXRhcmdldClyZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHV0ID0gZ2V0VUVUYWJsZSh0YXJnZXQpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWJsZSA9IHV0LnRhYmxlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjZWxsSW5mbyA9IHV0LmdldENlbGxJbmZvKHRhcmdldCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNlbGxzUmFuZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJuZyA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgaWYgKFwidG9wTGVmdFwiID09IGluUG9zaXRpb24odGFibGUsIG1vdXNlQ29vcmRzKGV2dCkpKSB7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgY2VsbHNSYW5nZSA9IHV0LmdldENlbGxzUmFuZ2UodXQudGFibGUucm93c1swXS5jZWxsc1swXSwgdXQuZ2V0TGFzdENlbGwoKSk7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgdXQuc2V0U2VsZWN0ZWQoY2VsbHNSYW5nZSk7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgICAgICAgICAgICAgaWYgKFwiYm90dG9tUmlnaHRcIiA9PSBpblBvc2l0aW9uKHRhYmxlLCBtb3VzZUNvb3JkcyhldnQpKSkge1xyXG4vL1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuLy8gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoaW5UYWJsZVNpZGUodGFibGUsIHRhcmdldCwgZXZ0LCB0cnVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW5kVGRDb2wgPSB1dC5nZXRDZWxsKHV0LmluZGV4VGFibGVbdXQucm93c051bSAtIDFdW2NlbGxJbmZvLmNvbEluZGV4XS5yb3dJbmRleCwgdXQuaW5kZXhUYWJsZVt1dC5yb3dzTnVtIC0gMV1bY2VsbEluZm8uY29sSW5kZXhdLmNlbGxJbmRleCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldnQuc2hpZnRLZXkgJiYgdXQuc2VsZWN0ZWRUZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodXQuc2VsZWN0ZWRUZHNbMF0gIT09IGVuZFRkQ29sKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VsbHNSYW5nZSA9IHV0LmdldENlbGxzUmFuZ2UodXQuc2VsZWN0ZWRUZHNbMF0sIGVuZFRkQ29sKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1dC5zZXRTZWxlY3RlZChjZWxsc1JhbmdlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm5nICYmIHJuZy5zZWxlY3ROb2RlQ29udGVudHMoZW5kVGRDb2wpLnNlbGVjdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldCAhPT0gZW5kVGRDb2wpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZWxsc1JhbmdlID0gdXQuZ2V0Q2VsbHNSYW5nZSh0YXJnZXQsIGVuZFRkQ29sKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1dC5zZXRTZWxlY3RlZChjZWxsc1JhbmdlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm5nICYmIHJuZy5zZWxlY3ROb2RlQ29udGVudHMoZW5kVGRDb2wpLnNlbGVjdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluVGFibGVTaWRlKHRhYmxlLCB0YXJnZXQsIGV2dCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVuZFRkUm93ID0gdXQuZ2V0Q2VsbCh1dC5pbmRleFRhYmxlW2NlbGxJbmZvLnJvd0luZGV4XVt1dC5jb2xzTnVtIC0gMV0ucm93SW5kZXgsIHV0LmluZGV4VGFibGVbY2VsbEluZm8ucm93SW5kZXhdW3V0LmNvbHNOdW0gLSAxXS5jZWxsSW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZ0LnNoaWZ0S2V5ICYmIHV0LnNlbGVjdGVkVGRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHV0LnNlbGVjdGVkVGRzWzBdICE9PSBlbmRUZFJvdykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNlbGxzUmFuZ2UgPSB1dC5nZXRDZWxsc1JhbmdlKHV0LnNlbGVjdGVkVGRzWzBdLCBlbmRUZFJvdyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXQuc2V0U2VsZWN0ZWQoY2VsbHNSYW5nZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJuZyAmJiBybmcuc2VsZWN0Tm9kZUNvbnRlbnRzKGVuZFRkUm93KS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQgIT09IGVuZFRkUm93KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VsbHNSYW5nZSA9IHV0LmdldENlbGxzUmFuZ2UodGFyZ2V0LCBlbmRUZFJvdyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXQuc2V0U2VsZWN0ZWQoY2VsbHNSYW5nZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJuZyAmJiBybmcuc2VsZWN0Tm9kZUNvbnRlbnRzKGVuZFRkUm93KS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgc3dpdGNoQm9yZGVyQ29sb3IobWUsIHRydWUpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkb21VdGlscy5vbihtZS5kb2N1bWVudCwgXCJtb3VzZW1vdmVcIiwgbW91c2VNb3ZlRXZlbnQpO1xyXG5cclxuICAgICAgICBkb21VdGlscy5vbihtZS5kb2N1bWVudCwgXCJtb3VzZW91dFwiLCBmdW5jdGlvbiAoZXZ0KSB7XHJcbiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBldnQudGFyZ2V0IHx8IGV2dC5zcmNFbGVtZW50O1xyXG4gICAgICAgICAgICBpZiAodGFyZ2V0LnRhZ05hbWUgPT0gXCJUQUJMRVwiKSB7XHJcbiAgICAgICAgICAgICAgICB0b2dnbGVEcmFnZ2FibGVTdGF0ZShtZSwgZmFsc2UsIFwiXCIsIG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog6KGo5qC86ZqU6KGM5Y+Y6ImyXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgbWUuYWRkTGlzdGVuZXIoXCJpbnRlcmxhY2V0YWJsZVwiLGZ1bmN0aW9uKHR5cGUsdGFibGUsY2xhc3NMaXN0KXtcclxuICAgICAgICAgICAgaWYoIXRhYmxlKSByZXR1cm47XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgICAgICAgICByb3dzID0gdGFibGUucm93cyxcclxuICAgICAgICAgICAgICAgIGxlbiA9IHJvd3MubGVuZ3RoLFxyXG4gICAgICAgICAgICAgICAgZ2V0Q2xhc3MgPSBmdW5jdGlvbihsaXN0LGluZGV4LHJlcGVhdCl7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxpc3RbaW5kZXhdID8gbGlzdFtpbmRleF0gOiByZXBlYXQgPyBsaXN0W2luZGV4ICUgbGlzdC5sZW5ndGhdOiBcIlwiO1xyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgZm9yKHZhciBpID0gMDtpPGxlbjtpKyspe1xyXG4gICAgICAgICAgICAgICAgcm93c1tpXS5jbGFzc05hbWUgPSBnZXRDbGFzcyggY2xhc3NMaXN0fHwgbWUub3B0aW9ucy5jbGFzc0xpc3QsaSx0cnVlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIG1lLmFkZExpc3RlbmVyKFwidW5pbnRlcmxhY2V0YWJsZVwiLGZ1bmN0aW9uKHR5cGUsdGFibGUpe1xyXG4gICAgICAgICAgICBpZighdGFibGUpIHJldHVybjtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICAgICAgICAgIHJvd3MgPSB0YWJsZS5yb3dzLFxyXG4gICAgICAgICAgICAgICAgY2xhc3NMaXN0ID0gbWUub3B0aW9ucy5jbGFzc0xpc3QsXHJcbiAgICAgICAgICAgICAgICBsZW4gPSByb3dzLmxlbmd0aDtcclxuICAgICAgICAgICAgZm9yKHZhciBpID0gMDtpPGxlbjtpKyspe1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlQ2xhc3Nlcyggcm93c1tpXSwgY2xhc3NMaXN0ICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbWUuYWRkTGlzdGVuZXIoXCJtb3VzZWRvd25cIiwgbW91c2VEb3duRXZlbnQpO1xyXG4gICAgICAgIG1lLmFkZExpc3RlbmVyKFwibW91c2V1cFwiLCBtb3VzZVVwRXZlbnQpO1xyXG4gICAgICAgIC8v5ouW5Yqo55qE5pe25YCZ6Kem5Y+RbW91c2V1cFxyXG4gICAgICAgIGRvbVV0aWxzLm9uKCBtZS5ib2R5LCAnZHJhZ3N0YXJ0JywgZnVuY3Rpb24oIGV2dCApe1xyXG4gICAgICAgICAgICBtb3VzZVVwRXZlbnQuY2FsbCggbWUsICdkcmFnc3RhcnQnLCBldnQgKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBtZS5hZGRPdXRwdXRSdWxlKGZ1bmN0aW9uKHJvb3Qpe1xyXG4gICAgICAgICAgICB1dGlscy5lYWNoKHJvb3QuZ2V0Tm9kZXNCeVRhZ05hbWUoJ2RpdicpLGZ1bmN0aW9uKG4pe1xyXG4gICAgICAgICAgICAgICAgaWYgKG4uZ2V0QXR0cignaWQnKSA9PSAndWVfdGFibGVEcmFnTGluZScpIHtcclxuICAgICAgICAgICAgICAgICAgICBuLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB2YXIgY3VycmVudFJvd0luZGV4ID0gMDtcclxuICAgICAgICBtZS5hZGRMaXN0ZW5lcihcIm1vdXNlZG93blwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGN1cnJlbnRSb3dJbmRleCA9IDA7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbWUuYWRkTGlzdGVuZXIoJ3RhYmtleWRvd24nLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciByYW5nZSA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCksXHJcbiAgICAgICAgICAgICAgICBjb21tb24gPSByYW5nZS5nZXRDb21tb25BbmNlc3Rvcih0cnVlLCB0cnVlKSxcclxuICAgICAgICAgICAgICAgIHRhYmxlID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShjb21tb24sICd0YWJsZScpO1xyXG4gICAgICAgICAgICBpZiAodGFibGUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKGNvbW1vbiwgJ2NhcHRpb24nLCB0cnVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjZWxsID0gZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFibGUsICd0aCB0ZCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjZWxsICYmIGNlbGwubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KGNlbGxbMF0sIDApLnNldEN1cnNvcihmYWxzZSwgdHJ1ZSlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjZWxsID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShjb21tb24sIFsndGQnLCAndGgnXSwgdHJ1ZSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVhID0gZ2V0VUVUYWJsZShjZWxsKTtcclxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50Um93SW5kZXggPSBjZWxsLnJvd1NwYW4gPiAxID8gY3VycmVudFJvd0luZGV4IDogdWEuZ2V0Q2VsbEluZm8oY2VsbCkucm93SW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5leHRDZWxsID0gdWEuZ2V0VGFiTmV4dENlbGwoY2VsbCwgY3VycmVudFJvd0luZGV4KTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobmV4dENlbGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRW1wdHlCbG9jayhuZXh0Q2VsbCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KG5leHRDZWxsLCAwKS5zZXRDdXJzb3IoZmFsc2UsIHRydWUpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZWxlY3ROb2RlQ29udGVudHMobmV4dENlbGwpLnNlbGVjdCgpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NhdmVTY2VuZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5fX2hhc0VudGVyRXhlY0NvbW1hbmQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWNDb21tYW5kKCdpbnNlcnRyb3duZXh0Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLl9faGFzRW50ZXJFeGVjQ29tbWFuZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZSA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KHRhYmxlLnJvd3NbdGFibGUucm93cy5sZW5ndGggLSAxXS5jZWxsc1swXSwgMCkuc2V0Q3Vyc29yKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnc2F2ZVNjZW5lJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgYnJvd3Nlci5pZSAmJiBtZS5hZGRMaXN0ZW5lcignc2VsZWN0aW9uY2hhbmdlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB0b2dnbGVEcmFnZ2FibGVTdGF0ZSh0aGlzLCBmYWxzZSwgXCJcIiwgbnVsbCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbWUuYWRkTGlzdGVuZXIoXCJrZXlkb3duXCIsIGZ1bmN0aW9uICh0eXBlLCBldnQpIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcclxuICAgICAgICAgICAgLy/lpITnkIblnKjooajmoLznmoTmnIDlkI7kuIDkuKrovpPlhaV0YWLkuqfnlJ/mlrDnmoTooajmoLxcclxuICAgICAgICAgICAgdmFyIGtleUNvZGUgPSBldnQua2V5Q29kZSB8fCBldnQud2hpY2g7XHJcbiAgICAgICAgICAgIGlmIChrZXlDb2RlID09IDggfHwga2V5Q29kZSA9PSA0Nikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBub3RDdHJsS2V5ID0gIWV2dC5jdHJsS2V5ICYmICFldnQubWV0YUtleSAmJiAhZXZ0LnNoaWZ0S2V5ICYmICFldnQuYWx0S2V5O1xyXG4gICAgICAgICAgICBub3RDdHJsS2V5ICYmIHJlbW92ZVNlbGVjdGVkQ2xhc3MoZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUobWUuYm9keSwgXCJ0ZFwiKSk7XHJcbiAgICAgICAgICAgIHZhciB1dCA9IGdldFVFVGFibGVCeVNlbGVjdGVkKG1lKTtcclxuICAgICAgICAgICAgaWYgKCF1dCkgcmV0dXJuO1xyXG4gICAgICAgICAgICBub3RDdHJsS2V5ICYmIHV0LmNsZWFyU2VsZWN0ZWQoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbWUuYWRkTGlzdGVuZXIoXCJiZWZvcmVnZXRjb250ZW50XCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgc3dpdGNoQm9yZGVyQ29sb3IodGhpcywgZmFsc2UpO1xyXG4gICAgICAgICAgICBicm93c2VyLmllICYmIHV0aWxzLmVhY2godGhpcy5kb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnY2FwdGlvbicpLCBmdW5jdGlvbiAoY2kpIHtcclxuICAgICAgICAgICAgICAgIGlmIChkb21VdGlscy5pc0VtcHR5Tm9kZShjaSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBjaS5pbm5lckhUTUwgPSAnJm5ic3A7J1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBtZS5hZGRMaXN0ZW5lcihcImFmdGVyZ2V0Y29udGVudFwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHN3aXRjaEJvcmRlckNvbG9yKHRoaXMsIHRydWUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIG1lLmFkZExpc3RlbmVyKFwiZ2V0QWxsSHRtbFwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJlbW92ZVNlbGVjdGVkQ2xhc3MobWUuZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJ0ZFwiKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy/kv67mraPlhajlsY/nirbmgIHkuIvmj5LlhaXnmoTooajmoLzlrr3luqblnKjpnZ7lhajlsY/nirbmgIHkuIvmkpHlvIDnvJbovpHlmajnmoTmg4XlhrVcclxuICAgICAgICBtZS5hZGRMaXN0ZW5lcihcImZ1bGxzY3JlZW5jaGFuZ2VkXCIsIGZ1bmN0aW9uICh0eXBlLCBmdWxsc2NyZWVuKSB7XHJcbiAgICAgICAgICAgIGlmICghZnVsbHNjcmVlbikge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJhdGlvID0gdGhpcy5ib2R5Lm9mZnNldFdpZHRoIC8gZG9jdW1lbnQuYm9keS5vZmZzZXRXaWR0aCxcclxuICAgICAgICAgICAgICAgICAgICB0YWJsZXMgPSBkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZSh0aGlzLmJvZHksIFwidGFibGVcIik7XHJcbiAgICAgICAgICAgICAgICB1dGlscy5lYWNoKHRhYmxlcywgZnVuY3Rpb24gKHRhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhYmxlLm9mZnNldFdpZHRoIDwgbWUuYm9keS5vZmZzZXRXaWR0aCkgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB0ZHMgPSBkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWJsZSwgXCJ0ZFwiKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYmFja1dpZHRocyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIHV0aWxzLmVhY2godGRzLCBmdW5jdGlvbiAodGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYmFja1dpZHRocy5wdXNoKHRkLm9mZnNldFdpZHRoKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgdGQ7IHRkID0gdGRzW2ldOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGQuc2V0QXR0cmlidXRlKFwid2lkdGhcIiwgTWF0aC5mbG9vcihiYWNrV2lkdGhzW2ldICogcmF0aW8pKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGFibGUuc2V0QXR0cmlidXRlKFwid2lkdGhcIiwgTWF0aC5mbG9vcihnZXRUYWJsZVdpZHRoKG1lLCBuZWVkSUVIYWNrLCBnZXREZWZhdWx0VmFsdWUobWUpKSkpXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvL+mHjeWGmWV4ZWNDb21tYW5k5ZG95Luk77yM55So5LqO5aSE55CG5qGG6YCJ5pe255qE5aSE55CGXHJcbiAgICAgICAgdmFyIG9sZEV4ZWNDb21tYW5kID0gbWUuZXhlY0NvbW1hbmQ7XHJcbiAgICAgICAgbWUuZXhlY0NvbW1hbmQgPSBmdW5jdGlvbiAoY21kLCBkYXRhdGF0KSB7XHJcblxyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzLFxyXG4gICAgICAgICAgICAgICAgYXJncyA9IGFyZ3VtZW50cztcclxuXHJcbiAgICAgICAgICAgIGNtZCA9IGNtZC50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICB2YXIgdXQgPSBnZXRVRVRhYmxlQnlTZWxlY3RlZChtZSksIHRkcyxcclxuICAgICAgICAgICAgICAgIHJhbmdlID0gbmV3IGRvbS5SYW5nZShtZS5kb2N1bWVudCksXHJcbiAgICAgICAgICAgICAgICBjbWRGdW4gPSBtZS5jb21tYW5kc1tjbWRdIHx8IFVFLmNvbW1hbmRzW2NtZF0sXHJcbiAgICAgICAgICAgICAgICByZXN1bHQ7XHJcbiAgICAgICAgICAgIGlmICghY21kRnVuKSByZXR1cm47XHJcbiAgICAgICAgICAgIGlmICh1dCAmJiAhY29tbWFuZHNbY21kXSAmJiAhY21kRnVuLm5vdE5lZWRVbmRvICYmICFtZS5fX2hhc0VudGVyRXhlY0NvbW1hbmQpIHtcclxuICAgICAgICAgICAgICAgIG1lLl9faGFzRW50ZXJFeGVjQ29tbWFuZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoXCJiZWZvcmVleGVjY29tbWFuZFwiLCBjbWQpO1xyXG4gICAgICAgICAgICAgICAgdGRzID0gdXQuc2VsZWN0ZWRUZHM7XHJcbiAgICAgICAgICAgICAgICB2YXIgbGFzdFN0YXRlID0gLTIsIGxhc3RWYWx1ZSA9IC0yLCB2YWx1ZSwgc3RhdGU7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgdGQ7IHRkID0gdGRzW2ldOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXNFbXB0eUJsb2NrKHRkKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydCh0ZCwgMCkuc2V0Q3Vyc29yKGZhbHNlLCB0cnVlKVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNlbGVjdE5vZGUodGQpLnNlbGVjdCh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUgPSBtZS5xdWVyeUNvbW1hbmRTdGF0ZShjbWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gbWUucXVlcnlDb21tYW5kVmFsdWUoY21kKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUgIT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RTdGF0ZSAhPT0gc3RhdGUgfHwgbGFzdFZhbHVlICE9PSB2YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuX2lnbm9yZUNvbnRlbnRDaGFuZ2UgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gb2xkRXhlY0NvbW1hbmQuYXBwbHkobWUsIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5faWdub3JlQ29udGVudENoYW5nZSA9IGZhbHNlO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0U3RhdGUgPSBtZS5xdWVyeUNvbW1hbmRTdGF0ZShjbWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBtZS5xdWVyeUNvbW1hbmRWYWx1ZShjbWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9tVXRpbHMuaXNFbXB0eUJsb2NrKHRkKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuZmlsbE5vZGUobWUuZG9jdW1lbnQsIHRkKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQodGRzWzBdLCAwKS5zaHJpbmtCb3VuZGFyeSh0cnVlKS5zZXRDdXJzb3IoZmFsc2UsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdjb250ZW50Y2hhbmdlJyk7XHJcbiAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoXCJhZnRlcmV4ZWNjb21tYW5kXCIsIGNtZCk7XHJcbiAgICAgICAgICAgICAgICBtZS5fX2hhc0VudGVyRXhlY0NvbW1hbmQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIG1lLl9zZWxlY3Rpb25DaGFuZ2UoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdCA9IG9sZEV4ZWNDb21tYW5kLmFwcGx5KG1lLCBhcmd1bWVudHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfTtcclxuXHJcblxyXG4gICAgfSk7XHJcbiAgICAvKipcclxuICAgICAqIOWIoOmZpG9iaueahOWuvemrmHN0eWxl77yM5pS55oiQ5bGe5oCn5a696auYXHJcbiAgICAgKiBAcGFyYW0gb2JqXHJcbiAgICAgKiBAcGFyYW0gcmVwbGFjZVRvUHJvcGVydHlcclxuICAgICAqL1xyXG4gICAgZnVuY3Rpb24gcmVtb3ZlU3R5bGVTaXplKG9iaiwgcmVwbGFjZVRvUHJvcGVydHkpIHtcclxuICAgICAgICByZW1vdmVTdHlsZShvYmosIFwid2lkdGhcIiwgdHJ1ZSk7XHJcbiAgICAgICAgcmVtb3ZlU3R5bGUob2JqLCBcImhlaWdodFwiLCB0cnVlKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiByZW1vdmVTdHlsZShvYmosIHN0eWxlTmFtZSwgcmVwbGFjZVRvUHJvcGVydHkpIHtcclxuICAgICAgICBpZiAob2JqLnN0eWxlW3N0eWxlTmFtZV0pIHtcclxuICAgICAgICAgICAgcmVwbGFjZVRvUHJvcGVydHkgJiYgb2JqLnNldEF0dHJpYnV0ZShzdHlsZU5hbWUsIHBhcnNlSW50KG9iai5zdHlsZVtzdHlsZU5hbWVdLCAxMCkpO1xyXG4gICAgICAgICAgICBvYmouc3R5bGVbc3R5bGVOYW1lXSA9IFwiXCI7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldFBhcmVudFRkT3JUaChlbGUpIHtcclxuICAgICAgICBpZiAoZWxlLnRhZ05hbWUgPT0gXCJURFwiIHx8IGVsZS50YWdOYW1lID09IFwiVEhcIikgcmV0dXJuIGVsZTtcclxuICAgICAgICB2YXIgdGQ7XHJcbiAgICAgICAgaWYgKHRkID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShlbGUsIFwidGRcIiwgdHJ1ZSkgfHwgZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShlbGUsIFwidGhcIiwgdHJ1ZSkpIHJldHVybiB0ZDtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBpc0VtcHR5QmxvY2sobm9kZSkge1xyXG4gICAgICAgIHZhciByZWcgPSBuZXcgUmVnRXhwKGRvbVV0aWxzLmZpbGxDaGFyLCAnZycpO1xyXG4gICAgICAgIGlmIChub2RlW2Jyb3dzZXIuaWUgPyAnaW5uZXJUZXh0JyA6ICd0ZXh0Q29udGVudCddLnJlcGxhY2UoL15cXHMqJC8sICcnKS5yZXBsYWNlKHJlZywgJycpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAodmFyIG4gaW4gZHRkLiRpc05vdEVtcHR5KSB7XHJcbiAgICAgICAgICAgIGlmIChub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKG4pLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIDE7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGZ1bmN0aW9uIG1vdXNlQ29vcmRzKGV2dCkge1xyXG4gICAgICAgIGlmIChldnQucGFnZVggfHwgZXZ0LnBhZ2VZKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHg6ZXZ0LnBhZ2VYLCB5OmV2dC5wYWdlWSB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB4OmV2dC5jbGllbnRYICsgbWUuZG9jdW1lbnQuYm9keS5zY3JvbGxMZWZ0IC0gbWUuZG9jdW1lbnQuYm9keS5jbGllbnRMZWZ0LFxyXG4gICAgICAgICAgICB5OmV2dC5jbGllbnRZICsgbWUuZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgLSBtZS5kb2N1bWVudC5ib2R5LmNsaWVudFRvcFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbW91c2VNb3ZlRXZlbnQoZXZ0KSB7XHJcblxyXG4gICAgICAgIGlmKCBpc0VkaXRvckRpc2FibGVkKCkgKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRyeSB7XHJcblxyXG4gICAgICAgICAgICAvL+aZrumAmueKtuaAgeS4i+m8oOagh+enu+WKqFxyXG4gICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZ2V0UGFyZW50VGRPclRoKGV2dC50YXJnZXQgfHwgZXZ0LnNyY0VsZW1lbnQpLFxyXG4gICAgICAgICAgICAgICAgcG9zO1xyXG5cclxuICAgICAgICAgICAgLy/ljLrliIbnlKjmiLfnmoTooYzkuLrmmK/mi5bliqjov5jmmK/lj4zlh7tcclxuICAgICAgICAgICAgaWYoIGlzSW5SZXNpemVCdWZmZXIgICkge1xyXG5cclxuICAgICAgICAgICAgICAgIG1lLmJvZHkuc3R5bGUud2Via2l0VXNlclNlbGVjdCA9ICdub25lJztcclxuXHJcbiAgICAgICAgICAgICAgICBpZiggTWF0aC5hYnMoIHVzZXJBY3Rpb25TdGF0dXMueCAtIGV2dC5jbGllbnRYICkgPiBvZmZzZXRPZlRhYmxlQ2VsbCB8fCBNYXRoLmFicyggdXNlckFjdGlvblN0YXR1cy55IC0gZXZ0LmNsaWVudFkgKSA+IG9mZnNldE9mVGFibGVDZWxsICkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNsZWFyVGFibGVEcmFnVGltZXIoKTtcclxuICAgICAgICAgICAgICAgICAgICBpc0luUmVzaXplQnVmZmVyID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgc2luZ2xlQ2xpY2tTdGF0ZSA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9kcmFnIGFjdGlvblxyXG4gICAgICAgICAgICAgICAgICAgIHRhYmxlQm9yZGVyRHJhZyhldnQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvL+S/ruaUueWNleWFg+agvOWkp+Wwj+aXtueahOm8oOagh+enu+WKqFxyXG4gICAgICAgICAgICBpZiAob25EcmFnICYmIGRyYWdUZCkge1xyXG4gICAgICAgICAgICAgICAgc2luZ2xlQ2xpY2tTdGF0ZSA9IDA7XHJcbiAgICAgICAgICAgICAgICBtZS5ib2R5LnN0eWxlLndlYmtpdFVzZXJTZWxlY3QgPSAnbm9uZSc7XHJcbiAgICAgICAgICAgICAgICBtZS5zZWxlY3Rpb24uZ2V0TmF0aXZlKClbYnJvd3Nlci5pZTliZWxvdyA/ICdlbXB0eScgOiAncmVtb3ZlQWxsUmFuZ2VzJ10oKTtcclxuICAgICAgICAgICAgICAgIHBvcyA9IG1vdXNlQ29vcmRzKGV2dCk7XHJcbiAgICAgICAgICAgICAgICB0b2dnbGVEcmFnZ2FibGVTdGF0ZShtZSwgdHJ1ZSwgb25EcmFnLCBwb3MsIHRhcmdldCk7XHJcbiAgICAgICAgICAgICAgICBpZiAob25EcmFnID09IFwiaFwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZHJhZ0xpbmUuc3R5bGUubGVmdCA9IGdldFBlcm1pc3Npb25YKGRyYWdUZCwgZXZ0KSArIFwicHhcIjtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob25EcmFnID09IFwidlwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZHJhZ0xpbmUuc3R5bGUudG9wID0gZ2V0UGVybWlzc2lvblkoZHJhZ1RkLCBldnQpICsgXCJweFwiO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8v5b2T6byg5qCH5aSE5LqOdGFibGXkuIrml7bvvIzkv67mlLnnp7vliqjov4fnqIvkuK3nmoTlhYnmoIfnirbmgIFcclxuICAgICAgICAgICAgaWYgKHRhcmdldCkge1xyXG4gICAgICAgICAgICAgICAgLy/pkojlr7nkvb/nlKh0YWJsZeS9nOS4uuWuueWZqOeahOe7hOS7tuS4jeinpuWPkeaLluaLveaViOaenFxyXG4gICAgICAgICAgICAgICAgaWYgKG1lLmZpcmVFdmVudCgnZXhjbHVkZXRhYmxlJywgdGFyZ2V0KSA9PT0gdHJ1ZSlcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICBwb3MgPSBtb3VzZUNvb3JkcyhldnQpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gZ2V0UmVsYXRpb24odGFyZ2V0LCBwb3MpLFxyXG4gICAgICAgICAgICAgICAgICAgIHRhYmxlID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZSh0YXJnZXQsIFwidGFibGVcIiwgdHJ1ZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGluVGFibGVTaWRlKHRhYmxlLCB0YXJnZXQsIGV2dCwgdHJ1ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobWUuZmlyZUV2ZW50KFwiZXhjbHVkZXRhYmxlXCIsIHRhYmxlKSA9PT0gdHJ1ZSkgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmJvZHkuc3R5bGUuY3Vyc29yID0gXCJ1cmwoXCIgKyBtZS5vcHRpb25zLmN1cnNvcnBhdGggKyBcImgucG5nKSxwb2ludGVyXCI7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluVGFibGVTaWRlKHRhYmxlLCB0YXJnZXQsIGV2dCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobWUuZmlyZUV2ZW50KFwiZXhjbHVkZXRhYmxlXCIsIHRhYmxlKSA9PT0gdHJ1ZSkgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmJvZHkuc3R5bGUuY3Vyc29yID0gXCJ1cmwoXCIgKyBtZS5vcHRpb25zLmN1cnNvcnBhdGggKyBcInYucG5nKSxwb2ludGVyXCI7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmJvZHkuc3R5bGUuY3Vyc29yID0gXCJ0ZXh0XCI7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGN1ckNlbGwgPSB0YXJnZXQ7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKC9cXGQvLnRlc3Qoc3RhdGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlID0gc3RhdGUucmVwbGFjZSgvXFxkLywgJycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQgPSBnZXRVRVRhYmxlKHRhcmdldCkuZ2V0UHJldmlld0NlbGwodGFyZ2V0LCBzdGF0ZSA9PSBcInZcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIC8v5L2N5LqO56ys5LiA6KGM55qE6aG26YOo5oiW6ICF56ys5LiA5YiX55qE5bem6L655pe25LiN5Y+v5ouW5YqoXHJcbiAgICAgICAgICAgICAgICAgICAgdG9nZ2xlRHJhZ2dhYmxlU3RhdGUobWUsIHRhcmdldCA/ICEhc3RhdGUgOiBmYWxzZSwgdGFyZ2V0ID8gc3RhdGUgOiAnJywgcG9zLCB0YXJnZXQpO1xyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRvZ2dsZURyYWdCdXR0b24oZmFsc2UsIHRhYmxlLCBtZSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICBzaG93RXJyb3IoZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHZhciBkcmFnQnV0dG9uVGltZXI7XHJcblxyXG4gICAgZnVuY3Rpb24gdG9nZ2xlRHJhZ0J1dHRvbihzaG93LCB0YWJsZSwgZWRpdG9yKSB7XHJcbiAgICAgICAgaWYgKCFzaG93KSB7XHJcbiAgICAgICAgICAgIGlmIChkcmFnT3ZlcilyZXR1cm47XHJcbiAgICAgICAgICAgIGRyYWdCdXR0b25UaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgIWRyYWdPdmVyICYmIGRyYWdCdXR0b24gJiYgZHJhZ0J1dHRvbi5wYXJlbnROb2RlICYmIGRyYWdCdXR0b24ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChkcmFnQnV0dG9uKTtcclxuICAgICAgICAgICAgfSwgMjAwMCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY3JlYXRlRHJhZ0J1dHRvbih0YWJsZSwgZWRpdG9yKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY3JlYXRlRHJhZ0J1dHRvbih0YWJsZSwgZWRpdG9yKSB7XHJcbiAgICAgICAgdmFyIHBvcyA9IGRvbVV0aWxzLmdldFhZKHRhYmxlKSxcclxuICAgICAgICAgICAgZG9jID0gdGFibGUub3duZXJEb2N1bWVudDtcclxuICAgICAgICBpZiAoZHJhZ0J1dHRvbiAmJiBkcmFnQnV0dG9uLnBhcmVudE5vZGUpcmV0dXJuIGRyYWdCdXR0b247XHJcbiAgICAgICAgZHJhZ0J1dHRvbiA9IGRvYy5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgIGRyYWdCdXR0b24uY29udGVudEVkaXRhYmxlID0gZmFsc2U7XHJcbiAgICAgICAgZHJhZ0J1dHRvbi5pbm5lckhUTUwgPSBcIlwiO1xyXG4gICAgICAgIGRyYWdCdXR0b24uc3R5bGUuY3NzVGV4dCA9IFwid2lkdGg6MTVweDtoZWlnaHQ6MTVweDtiYWNrZ3JvdW5kLWltYWdlOnVybChcIiArIGVkaXRvci5vcHRpb25zLlVFRElUT1JfSE9NRV9VUkwgKyBcImRpYWxvZ3MvdGFibGUvZHJhZ2ljb24ucG5nKTtwb3NpdGlvbjogYWJzb2x1dGU7Y3Vyc29yOm1vdmU7dG9wOlwiICsgKHBvcy55IC0gMTUpICsgXCJweDtsZWZ0OlwiICsgKHBvcy54KSArIFwicHg7XCI7XHJcbiAgICAgICAgZG9tVXRpbHMudW5TZWxlY3RhYmxlKGRyYWdCdXR0b24pO1xyXG4gICAgICAgIGRyYWdCdXR0b24ub25tb3VzZW92ZXIgPSBmdW5jdGlvbiAoZXZ0KSB7XHJcbiAgICAgICAgICAgIGRyYWdPdmVyID0gdHJ1ZTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIGRyYWdCdXR0b24ub25tb3VzZW91dCA9IGZ1bmN0aW9uIChldnQpIHtcclxuICAgICAgICAgICAgZHJhZ092ZXIgPSBmYWxzZTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIGRvbVV0aWxzLm9uKGRyYWdCdXR0b24sICdjbGljaycsIGZ1bmN0aW9uICh0eXBlLCBldnQpIHtcclxuICAgICAgICAgICAgZG9DbGljayhldnQsIHRoaXMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGRvbVV0aWxzLm9uKGRyYWdCdXR0b24sICdkYmxjbGljaycsIGZ1bmN0aW9uICh0eXBlLCBldnQpIHtcclxuICAgICAgICAgICAgZG9EYmxDbGljayhldnQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGRvbVV0aWxzLm9uKGRyYWdCdXR0b24sICdkcmFnc3RhcnQnLCBmdW5jdGlvbiAodHlwZSwgZXZ0KSB7XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLnByZXZlbnREZWZhdWx0KGV2dCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdmFyIHRpbWVyO1xyXG5cclxuICAgICAgICBmdW5jdGlvbiBkb0NsaWNrKGV2dCwgYnV0dG9uKSB7XHJcbiAgICAgICAgICAgIC8vIOmDqOWIhua1j+iniOWZqOS4i+mcgOimgea4heeQhlxyXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xyXG4gICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgZWRpdG9yLmZpcmVFdmVudChcInRhYmxlQ2xpY2tlZFwiLCB0YWJsZSwgYnV0dG9uKTtcclxuICAgICAgICAgICAgfSwgMzAwKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIGRvRGJsQ2xpY2soZXZ0KSB7XHJcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XHJcbiAgICAgICAgICAgIHZhciB1dCA9IGdldFVFVGFibGUodGFibGUpLFxyXG4gICAgICAgICAgICAgICAgc3RhcnQgPSB0YWJsZS5yb3dzWzBdLmNlbGxzWzBdLFxyXG4gICAgICAgICAgICAgICAgZW5kID0gdXQuZ2V0TGFzdENlbGwoKSxcclxuICAgICAgICAgICAgICAgIHJhbmdlID0gdXQuZ2V0Q2VsbHNSYW5nZShzdGFydCwgZW5kKTtcclxuICAgICAgICAgICAgZWRpdG9yLnNlbGVjdGlvbi5nZXRSYW5nZSgpLnNldFN0YXJ0KHN0YXJ0LCAwKS5zZXRDdXJzb3IoZmFsc2UsIHRydWUpO1xyXG4gICAgICAgICAgICB1dC5zZXRTZWxlY3RlZChyYW5nZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBkb2MuYm9keS5hcHBlbmRDaGlsZChkcmFnQnV0dG9uKTtcclxuICAgIH1cclxuXHJcblxyXG4vLyAgICBmdW5jdGlvbiBpblBvc2l0aW9uKHRhYmxlLCBwb3MpIHtcclxuLy8gICAgICAgIHZhciB0YWJsZVBvcyA9IGRvbVV0aWxzLmdldFhZKHRhYmxlKSxcclxuLy8gICAgICAgICAgICB3aWR0aCA9IHRhYmxlLm9mZnNldFdpZHRoLFxyXG4vLyAgICAgICAgICAgIGhlaWdodCA9IHRhYmxlLm9mZnNldEhlaWdodDtcclxuLy8gICAgICAgIGlmIChwb3MueCAtIHRhYmxlUG9zLnggPCA1ICYmIHBvcy55IC0gdGFibGVQb3MueSA8IDUpIHtcclxuLy8gICAgICAgICAgICByZXR1cm4gXCJ0b3BMZWZ0XCI7XHJcbi8vICAgICAgICB9IGVsc2UgaWYgKHRhYmxlUG9zLnggKyB3aWR0aCAtIHBvcy54IDwgNSAmJiB0YWJsZVBvcy55ICsgaGVpZ2h0IC0gcG9zLnkgPCA1KSB7XHJcbi8vICAgICAgICAgICAgcmV0dXJuIFwiYm90dG9tUmlnaHRcIjtcclxuLy8gICAgICAgIH1cclxuLy8gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGluVGFibGVTaWRlKHRhYmxlLCBjZWxsLCBldnQsIHRvcCkge1xyXG4gICAgICAgIHZhciBwb3MgPSBtb3VzZUNvb3JkcyhldnQpLFxyXG4gICAgICAgICAgICBzdGF0ZSA9IGdldFJlbGF0aW9uKGNlbGwsIHBvcyk7XHJcblxyXG4gICAgICAgIGlmICh0b3ApIHtcclxuICAgICAgICAgICAgdmFyIGNhcHRpb24gPSB0YWJsZS5nZXRFbGVtZW50c0J5VGFnTmFtZShcImNhcHRpb25cIilbMF0sXHJcbiAgICAgICAgICAgICAgICBjYXBIZWlnaHQgPSBjYXB0aW9uID8gY2FwdGlvbi5vZmZzZXRIZWlnaHQgOiAwO1xyXG4gICAgICAgICAgICByZXR1cm4gKHN0YXRlID09IFwidjFcIikgJiYgKChwb3MueSAtIGRvbVV0aWxzLmdldFhZKHRhYmxlKS55IC0gY2FwSGVpZ2h0KSA8IDgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiAoc3RhdGUgPT0gXCJoMVwiKSAmJiAoKHBvcy54IC0gZG9tVXRpbHMuZ2V0WFkodGFibGUpLngpIDwgOCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6I635Y+W5ouW5Yqo5pe25YWB6K6455qEWOi9tOWdkOagh1xyXG4gICAgICogQHBhcmFtIGRyYWdUZFxyXG4gICAgICogQHBhcmFtIGV2dFxyXG4gICAgICovXHJcbiAgICBmdW5jdGlvbiBnZXRQZXJtaXNzaW9uWChkcmFnVGQsIGV2dCkge1xyXG4gICAgICAgIHZhciB1dCA9IGdldFVFVGFibGUoZHJhZ1RkKTtcclxuICAgICAgICBpZiAodXQpIHtcclxuICAgICAgICAgICAgdmFyIHByZVRkID0gdXQuZ2V0U2FtZUVuZFBvc0NlbGxzKGRyYWdUZCwgXCJ4XCIpWzBdLFxyXG4gICAgICAgICAgICAgICAgbmV4dFRkID0gdXQuZ2V0U2FtZVN0YXJ0UG9zWENlbGxzKGRyYWdUZClbMF0sXHJcbiAgICAgICAgICAgICAgICBtb3VzZVggPSBtb3VzZUNvb3JkcyhldnQpLngsXHJcbiAgICAgICAgICAgICAgICBsZWZ0ID0gKHByZVRkID8gZG9tVXRpbHMuZ2V0WFkocHJlVGQpLnggOiBkb21VdGlscy5nZXRYWSh1dC50YWJsZSkueCkgKyAyMCAsXHJcbiAgICAgICAgICAgICAgICByaWdodCA9IG5leHRUZCA/IGRvbVV0aWxzLmdldFhZKG5leHRUZCkueCArIG5leHRUZC5vZmZzZXRXaWR0aCAtIDIwIDogKG1lLmJvZHkub2Zmc2V0V2lkdGggKyA1IHx8IHBhcnNlSW50KGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUobWUuYm9keSwgXCJ3aWR0aFwiKSwgMTApKTtcclxuXHJcbiAgICAgICAgICAgIGxlZnQgKz0gY2VsbE1pbldpZHRoO1xyXG4gICAgICAgICAgICByaWdodCAtPSBjZWxsTWluV2lkdGg7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gbW91c2VYIDwgbGVmdCA/IGxlZnQgOiBtb3VzZVggPiByaWdodCA/IHJpZ2h0IDogbW91c2VYO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluaLluWKqOaXtuWFgeiuuOeahFnovbTlnZDmoIdcclxuICAgICAqL1xyXG4gICAgZnVuY3Rpb24gZ2V0UGVybWlzc2lvblkoZHJhZ1RkLCBldnQpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB2YXIgdG9wID0gZG9tVXRpbHMuZ2V0WFkoZHJhZ1RkKS55LFxyXG4gICAgICAgICAgICAgICAgbW91c2VQb3NZID0gbW91c2VDb29yZHMoZXZ0KS55O1xyXG4gICAgICAgICAgICByZXR1cm4gbW91c2VQb3NZIDwgdG9wID8gdG9wIDogbW91c2VQb3NZO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgc2hvd0Vycm9yKGUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOenu+WKqOeKtuaAgeWIh+aNolxyXG4gICAgICovXHJcbiAgICBmdW5jdGlvbiB0b2dnbGVEcmFnZ2FibGVTdGF0ZShlZGl0b3IsIGRyYWdnYWJsZSwgZGlyLCBtb3VzZVBvcywgY2VsbCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGVkaXRvci5ib2R5LnN0eWxlLmN1cnNvciA9IGRpciA9PSBcImhcIiA/IFwiY29sLXJlc2l6ZVwiIDogZGlyID09IFwidlwiID8gXCJyb3ctcmVzaXplXCIgOiBcInRleHRcIjtcclxuICAgICAgICAgICAgaWYgKGJyb3dzZXIuaWUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChkaXIgJiYgIW1vdXNlZG93biAmJiAhZ2V0VUVUYWJsZUJ5U2VsZWN0ZWQoZWRpdG9yKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGdldERyYWdMaW5lKGVkaXRvciwgZWRpdG9yLmRvY3VtZW50KTtcclxuICAgICAgICAgICAgICAgICAgICBzaG93RHJhZ0xpbmVBdChkaXIsIGNlbGwpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBoaWRlRHJhZ0xpbmUoZWRpdG9yKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG9uQm9yZGVyID0gZHJhZ2dhYmxlO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgc2hvd0Vycm9yKGUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluS4jlVFVGFibGXnm7jlhbPnmoRyZXNpemUgbGluZVxyXG4gICAgICogQHBhcmFtIHVldGFibGUgVUVUYWJsZeWvueixoVxyXG4gICAgICovXHJcbiAgICBmdW5jdGlvbiBnZXRSZXNpemVMaW5lQnlVRVRhYmxlKCkge1xyXG5cclxuICAgICAgICB2YXIgbGluZUlkID0gJ19VRVRhYmxlUmVzaXplTGluZScsXHJcbiAgICAgICAgICAgIGxpbmUgPSB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBsaW5lSWQgKTtcclxuXHJcbiAgICAgICAgaWYoICFsaW5lICkge1xyXG4gICAgICAgICAgICBsaW5lID0gdGhpcy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG4gICAgICAgICAgICBsaW5lLmlkID0gbGluZUlkO1xyXG4gICAgICAgICAgICBsaW5lLmNvbnRuZXRFZGl0YWJsZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICBsaW5lLnNldEF0dHJpYnV0ZShcInVuc2VsZWN0YWJsZVwiLCBcIm9uXCIpO1xyXG5cclxuICAgICAgICAgICAgdmFyIHN0eWxlcyA9IHtcclxuICAgICAgICAgICAgICAgIHdpZHRoOiAyKmNlbGxCb3JkZXJXaWR0aCArIDEgKyAncHgnLFxyXG4gICAgICAgICAgICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsXHJcbiAgICAgICAgICAgICAgICAnei1pbmRleCc6IDEwMDAwMCxcclxuICAgICAgICAgICAgICAgIGN1cnNvcjogJ2NvbC1yZXNpemUnLFxyXG4gICAgICAgICAgICAgICAgYmFja2dyb3VuZDogJ3JlZCcsXHJcbiAgICAgICAgICAgICAgICBkaXNwbGF5OiAnbm9uZSdcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIC8v5YiH5o2i54q25oCBXHJcbiAgICAgICAgICAgIGxpbmUub25tb3VzZW91dCA9IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICB1dGlscy5leHRlbmQoIGxpbmUuc3R5bGUsIHN0eWxlcyApO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKCBsaW5lICk7XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGxpbmU7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5pu05pawcmVzaXplLWxpbmVcclxuICAgICAqL1xyXG4gICAgZnVuY3Rpb24gdXBkYXRlUmVzaXplTGluZSggY2VsbCwgdWV0YWJsZSApIHtcclxuXHJcbiAgICAgICAgdmFyIGxpbmUgPSBnZXRSZXNpemVMaW5lQnlVRVRhYmxlLmNhbGwoIHRoaXMgKSxcclxuICAgICAgICAgICAgdGFibGUgPSB1ZXRhYmxlLnRhYmxlLFxyXG4gICAgICAgICAgICBzdHlsZXMgPSB7XHJcbiAgICAgICAgICAgICAgICB0b3A6IGRvbVV0aWxzLmdldFhZKCB0YWJsZSApLnkgKyAncHgnLFxyXG4gICAgICAgICAgICAgICAgbGVmdDogZG9tVXRpbHMuZ2V0WFkoIGNlbGwpLnggKyBjZWxsLm9mZnNldFdpZHRoIC0gY2VsbEJvcmRlcldpZHRoICsgJ3B4JyxcclxuICAgICAgICAgICAgICAgIGRpc3BsYXk6ICdibG9jaycsXHJcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IHRhYmxlLm9mZnNldEhlaWdodCArICdweCdcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdXRpbHMuZXh0ZW5kKCBsaW5lLnN0eWxlLCBzdHlsZXMgKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmmL7npLpyZXNpemUtbGluZVxyXG4gICAgICovXHJcbiAgICBmdW5jdGlvbiBzaG93UmVzaXplTGluZSggY2VsbCApIHtcclxuXHJcbiAgICAgICAgdmFyIHVldGFibGUgPSBnZXRVRVRhYmxlKCBjZWxsICk7XHJcblxyXG4gICAgICAgIHVwZGF0ZVJlc2l6ZUxpbmUuY2FsbCggdGhpcywgY2VsbCwgdWV0YWJsZSApO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPlum8oOagh+S4juW9k+WJjeWNleWFg+agvOeahOebuOWvueS9jee9rlxyXG4gICAgICogQHBhcmFtIGVsZVxyXG4gICAgICogQHBhcmFtIG1vdXNlUG9zXHJcbiAgICAgKi9cclxuICAgIGZ1bmN0aW9uIGdldFJlbGF0aW9uKGVsZSwgbW91c2VQb3MpIHtcclxuICAgICAgICB2YXIgZWxlUG9zID0gZG9tVXRpbHMuZ2V0WFkoZWxlKTtcclxuXHJcbiAgICAgICAgaWYoICFlbGVQb3MgKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnJztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChlbGVQb3MueCArIGVsZS5vZmZzZXRXaWR0aCAtIG1vdXNlUG9zLnggPCBjZWxsQm9yZGVyV2lkdGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFwiaFwiO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobW91c2VQb3MueCAtIGVsZVBvcy54IDwgY2VsbEJvcmRlcldpZHRoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnaDEnXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChlbGVQb3MueSArIGVsZS5vZmZzZXRIZWlnaHQgLSBtb3VzZVBvcy55IDwgY2VsbEJvcmRlcldpZHRoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBcInZcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1vdXNlUG9zLnkgLSBlbGVQb3MueSA8IGNlbGxCb3JkZXJXaWR0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gJ3YxJ1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbW91c2VEb3duRXZlbnQodHlwZSwgZXZ0KSB7XHJcblxyXG4gICAgICAgIGlmKCBpc0VkaXRvckRpc2FibGVkKCkgKSB7XHJcbiAgICAgICAgICAgIHJldHVybiA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB1c2VyQWN0aW9uU3RhdHVzID0ge1xyXG4gICAgICAgICAgICB4OiBldnQuY2xpZW50WCxcclxuICAgICAgICAgICAgeTogZXZ0LmNsaWVudFlcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvL+WPs+mUruiPnOWNleWNleeLrOWkhOeQhlxyXG4gICAgICAgIGlmIChldnQuYnV0dG9uID09IDIpIHtcclxuICAgICAgICAgICAgdmFyIHV0ID0gZ2V0VUVUYWJsZUJ5U2VsZWN0ZWQobWUpLFxyXG4gICAgICAgICAgICAgICAgZmxhZyA9IGZhbHNlO1xyXG5cclxuICAgICAgICAgICAgaWYgKHV0KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdGQgPSBnZXRUYXJnZXRUZChtZSwgZXZ0KTtcclxuICAgICAgICAgICAgICAgIHV0aWxzLmVhY2godXQuc2VsZWN0ZWRUZHMsIGZ1bmN0aW9uICh0aSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aSA9PT0gdGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmxhZyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWZsYWcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZW1vdmVTZWxlY3RlZENsYXNzKGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKG1lLmJvZHksIFwidGggdGRcIikpO1xyXG4gICAgICAgICAgICAgICAgICAgIHV0LmNsZWFyU2VsZWN0ZWQoKVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0ZCA9IHV0LnNlbGVjdGVkVGRzWzBdO1xyXG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKS5zZXRTdGFydCh0ZCwgMCkuc2V0Q3Vyc29yKGZhbHNlLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICB9LCAwKTtcclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0YWJsZUNsaWNrSGFuZGVyKCBldnQgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8v5riF6Zmk6KGo5qC855qE6K6h5pe25ZmoXHJcbiAgICBmdW5jdGlvbiBjbGVhclRhYmxlVGltZXIoKSB7XHJcbiAgICAgICAgdGFiVGltZXIgJiYgY2xlYXJUaW1lb3V0KCB0YWJUaW1lciApO1xyXG4gICAgICAgIHRhYlRpbWVyID0gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICAvL+WPjOWHu+aUtue8qVxyXG4gICAgZnVuY3Rpb24gdGFibGVEYmNsaWNrSGFuZGxlcihldnQpIHtcclxuICAgICAgICBzaW5nbGVDbGlja1N0YXRlID0gMDtcclxuICAgICAgICBldnQgPSBldnQgfHwgbWUud2luZG93LmV2ZW50O1xyXG4gICAgICAgIHZhciB0YXJnZXQgPSBnZXRQYXJlbnRUZE9yVGgoZXZ0LnRhcmdldCB8fCBldnQuc3JjRWxlbWVudCk7XHJcbiAgICAgICAgaWYgKHRhcmdldCkge1xyXG4gICAgICAgICAgICB2YXIgaDtcclxuICAgICAgICAgICAgaWYgKGggPSBnZXRSZWxhdGlvbih0YXJnZXQsIG1vdXNlQ29vcmRzKGV2dCkpKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgaGlkZURyYWdMaW5lKCBtZSApO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChoID09ICdoMScpIHtcclxuICAgICAgICAgICAgICAgICAgICBoID0gJ2gnO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpblRhYmxlU2lkZShkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHRhcmdldCwgXCJ0YWJsZVwiKSwgdGFyZ2V0LCBldnQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKCdhZGFwdGJ5d2luZG93Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0ID0gZ2V0VUVUYWJsZSh0YXJnZXQpLmdldFByZXZpZXdDZWxsKHRhcmdldCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBybmcgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJuZy5zZWxlY3ROb2RlQ29udGVudHModGFyZ2V0KS5zZXRDdXJzb3IodHJ1ZSwgdHJ1ZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChoID09ICdoJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB1dCA9IGdldFVFVGFibGUodGFyZ2V0KSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFibGUgPSB1dC50YWJsZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2VsbHMgPSBnZXRDZWxsc0J5TW92ZUJvcmRlciggdGFyZ2V0LCB0YWJsZSwgdHJ1ZSApO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjZWxscyA9IGV4dHJhY3RBcnJheSggY2VsbHMsICdsZWZ0JyApO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB1dC53aWR0aCA9IHV0Lm9mZnNldFdpZHRoO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB2YXIgb2xkV2lkdGggPSBbXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3V2lkdGggPSBbXTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdXRpbHMuZWFjaCggY2VsbHMsIGZ1bmN0aW9uKCBjZWxsICl7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBvbGRXaWR0aC5wdXNoKCBjZWxsLm9mZnNldFdpZHRoICk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH0gKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdXRpbHMuZWFjaCggY2VsbHMsIGZ1bmN0aW9uKCBjZWxsICl7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjZWxsLnJlbW92ZUF0dHJpYnV0ZShcIndpZHRoXCIpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB9ICk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpe1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy/mmK/lkKblhYHorrjmlLnlj5hcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoYW5nZWFibGUgPSB0cnVlO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgdXRpbHMuZWFjaCggY2VsbHMsIGZ1bmN0aW9uKCBjZWxsLCBpbmRleCApe1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3aWR0aCA9IGNlbGwub2Zmc2V0V2lkdGg7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIHdpZHRoID4gb2xkV2lkdGhbaW5kZXhdICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZWFibGUgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3V2lkdGgucHVzaCggd2lkdGggKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGFuZ2UgPSBjaGFuZ2VhYmxlID8gbmV3V2lkdGggOiBvbGRXaWR0aDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHV0aWxzLmVhY2goIGNlbGxzLCBmdW5jdGlvbiggY2VsbCwgaW5kZXggKXtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZWxsLndpZHRoID0gY2hhbmdlW2luZGV4XSAtIGdldFRhYmNlbGxTcGFjZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSApO1xyXG5cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgfSwgMCApO1xyXG5cclxuLy8gICAgICAgICAgICAgICAgICAgIG1pbldpZHRoIC09IGNlbGxNaW5XaWR0aDtcclxuLy9cclxuLy8gICAgICAgICAgICAgICAgICAgIHRhYmxlLnJlbW92ZUF0dHJpYnV0ZShcIndpZHRoXCIpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgdXRpbHMuZWFjaChjZWxscywgZnVuY3Rpb24gKGNlbGwpIHtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBjZWxsLnN0eWxlLndpZHRoID0gXCJcIjtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICBjZWxsLndpZHRoIC09IG1pbldpZHRoO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHRhYmxlQ2xpY2tIYW5kZXIoIGV2dCApIHtcclxuXHJcbiAgICAgICAgcmVtb3ZlU2VsZWN0ZWRDbGFzcyhkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZShtZS5ib2R5LCBcInRkIHRoXCIpKTtcclxuICAgICAgICAvL3RyYWNlOjMxMTNcclxuICAgICAgICAvL+mAieS4reWNleWFg+agvO+8jOeCueWHu3RhYmxl5aSW6YOo77yM5LiN5Lya5riF5o6JdGFibGXkuIrmjILnmoR1ZVRhYmxlLOS8muW8lei1t2dldFVFVGFibGVCeVNlbGVjdGVk5pa55rOV6L+U5Zue5YC8XHJcbiAgICAgICAgdXRpbHMuZWFjaChtZS5kb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgndGFibGUnKSwgZnVuY3Rpb24gKHQpIHtcclxuICAgICAgICAgICAgdC51ZVRhYmxlID0gbnVsbDtcclxuICAgICAgICB9KTtcclxuICAgICAgICBzdGFydFRkID0gZ2V0VGFyZ2V0VGQobWUsIGV2dCk7XHJcbiAgICAgICAgaWYoICFzdGFydFRkICkgcmV0dXJuO1xyXG4gICAgICAgIHZhciB0YWJsZSA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUoc3RhcnRUZCwgXCJ0YWJsZVwiLCB0cnVlKTtcclxuICAgICAgICB1dCA9IGdldFVFVGFibGUodGFibGUpO1xyXG4gICAgICAgIHV0ICYmIHV0LmNsZWFyU2VsZWN0ZWQoKTtcclxuXHJcbiAgICAgICAgLy/liKTmlq3lvZPliY3pvKDmoIfnirbmgIFcclxuICAgICAgICBpZiAoIW9uQm9yZGVyKSB7XHJcbiAgICAgICAgICAgIG1lLmRvY3VtZW50LmJvZHkuc3R5bGUud2Via2l0VXNlclNlbGVjdCA9ICcnO1xyXG4gICAgICAgICAgICBtb3VzZWRvd24gPSB0cnVlO1xyXG4gICAgICAgICAgICBtZS5hZGRMaXN0ZW5lcignbW91c2VvdmVyJywgbW91c2VPdmVyRXZlbnQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8v6L655qGG5LiK55qE5Yqo5L2c5aSE55CGXHJcbiAgICAgICAgICAgIGJvcmRlckFjdGlvbkhhbmRsZXIoIGV2dCApO1xyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8v5aSE55CG6KGo5qC86L655qGG5LiK55qE5Yqo5L2cLCDov5nph4zlgZrlu7bml7blpITnkIbvvIzpgb/lhY3kuKTnp43liqjkvZzkupLnm7jlvbHlk41cclxuICAgIGZ1bmN0aW9uIGJvcmRlckFjdGlvbkhhbmRsZXIoIGV2dCApIHtcclxuXHJcbiAgICAgICAgaWYgKCBicm93c2VyLmllICkge1xyXG4gICAgICAgICAgICBldnQgPSByZWNvbnN0cnVjdChldnQgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNsZWFyVGFibGVEcmFnVGltZXIoKTtcclxuXHJcbiAgICAgICAgLy/mmK/lkKbmraPlnKjnrYnlvoVyZXNpemXnmoTnvJPlhrLkuK1cclxuICAgICAgICBpc0luUmVzaXplQnVmZmVyID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgdGFibGVEcmFnVGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgIHRhYmxlQm9yZGVyRHJhZyggZXZ0ICk7XHJcbiAgICAgICAgfSwgZGJsY2xpY2tUaW1lKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZXh0cmFjdEFycmF5KCBvcmlnaW5BcnIsIGtleSApIHtcclxuXHJcbiAgICAgICAgdmFyIHJlc3VsdCA9IFtdLFxyXG4gICAgICAgICAgICB0bXAgPSBudWxsO1xyXG5cclxuICAgICAgICBmb3IoIHZhciBpID0gMCwgbGVuID0gb3JpZ2luQXJyLmxlbmd0aDsgaTxsZW47IGkrKyApIHtcclxuXHJcbiAgICAgICAgICAgIHRtcCA9IG9yaWdpbkFyclsgaSBdWyBrZXkgXTtcclxuXHJcbiAgICAgICAgICAgIGlmKCB0bXAgKSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCggdG1wICk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBjbGVhclRhYmxlRHJhZ1RpbWVyKCkge1xyXG4gICAgICAgIHRhYmxlRHJhZ1RpbWVyICYmIGNsZWFyVGltZW91dCh0YWJsZURyYWdUaW1lcik7XHJcbiAgICAgICAgdGFibGVEcmFnVGltZXIgPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJlY29uc3RydWN0KCBvYmogKSB7XHJcblxyXG4gICAgICAgIHZhciBhdHRycyA9IFsncGFnZVgnLCAncGFnZVknLCAnY2xpZW50WCcsICdjbGllbnRZJywgJ3NyY0VsZW1lbnQnLCAndGFyZ2V0J10sXHJcbiAgICAgICAgICAgIG5ld09iaiA9IHt9O1xyXG5cclxuICAgICAgICBpZiggb2JqICkge1xyXG5cclxuICAgICAgICAgICAgZm9yKCB2YXIgaSA9IDAsIGtleSwgdmFsOyBrZXkgPSBhdHRyc1tpXTsgaSsrICkge1xyXG4gICAgICAgICAgICAgICAgdmFsPW9ialsga2V5IF07XHJcbiAgICAgICAgICAgICAgICB2YWwgJiYgKG5ld09ialsga2V5IF0gPSB2YWwpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG5ld09iajtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgLy/ovrnmoYbmi5bliqhcclxuICAgIGZ1bmN0aW9uIHRhYmxlQm9yZGVyRHJhZyggZXZ0ICkge1xyXG5cclxuICAgICAgICBpc0luUmVzaXplQnVmZmVyID0gZmFsc2U7XHJcblxyXG4gICAgICAgIHN0YXJ0VGQgPSBldnQudGFyZ2V0IHx8IGV2dC5zcmNFbGVtZW50O1xyXG4gICAgICAgIGlmKCAhc3RhcnRUZCApIHJldHVybjtcclxuICAgICAgICB2YXIgc3RhdGUgPSBnZXRSZWxhdGlvbihzdGFydFRkLCBtb3VzZUNvb3JkcyhldnQpKTtcclxuICAgICAgICBpZiAoL1xcZC8udGVzdChzdGF0ZSkpIHtcclxuICAgICAgICAgICAgc3RhdGUgPSBzdGF0ZS5yZXBsYWNlKC9cXGQvLCAnJyk7XHJcbiAgICAgICAgICAgIHN0YXJ0VGQgPSBnZXRVRVRhYmxlKHN0YXJ0VGQpLmdldFByZXZpZXdDZWxsKHN0YXJ0VGQsIHN0YXRlID09ICd2Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGhpZGVEcmFnTGluZShtZSk7XHJcbiAgICAgICAgZ2V0RHJhZ0xpbmUobWUsIG1lLmRvY3VtZW50KTtcclxuICAgICAgICBtZS5maXJlRXZlbnQoJ3NhdmVTY2VuZScpO1xyXG4gICAgICAgIHNob3dEcmFnTGluZUF0KHN0YXRlLCBzdGFydFRkKTtcclxuICAgICAgICBtb3VzZWRvd24gPSB0cnVlO1xyXG4gICAgICAgIC8v5ouW5Yqo5byA5aeLXHJcbiAgICAgICAgb25EcmFnID0gc3RhdGU7XHJcbiAgICAgICAgZHJhZ1RkID0gc3RhcnRUZDtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtb3VzZVVwRXZlbnQodHlwZSwgZXZ0KSB7XHJcblxyXG4gICAgICAgIGlmKCBpc0VkaXRvckRpc2FibGVkKCkgKSB7XHJcbiAgICAgICAgICAgIHJldHVybiA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjbGVhclRhYmxlRHJhZ1RpbWVyKCk7XHJcblxyXG4gICAgICAgIGlzSW5SZXNpemVCdWZmZXIgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgaWYoIG9uQm9yZGVyICkge1xyXG4gICAgICAgICAgICBzaW5nbGVDbGlja1N0YXRlID0gKytzaW5nbGVDbGlja1N0YXRlICUgMztcclxuXHJcbiAgICAgICAgICAgIHVzZXJBY3Rpb25TdGF0dXMgPSB7XHJcbiAgICAgICAgICAgICAgICB4OiBldnQuY2xpZW50WCxcclxuICAgICAgICAgICAgICAgIHk6IGV2dC5jbGllbnRZXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICB0YWJsZVJlc2l6ZVRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgc2luZ2xlQ2xpY2tTdGF0ZSA+IDAgJiYgc2luZ2xlQ2xpY2tTdGF0ZS0tO1xyXG4gICAgICAgICAgICB9LCBkYmxjbGlja1RpbWUgKTtcclxuXHJcbiAgICAgICAgICAgIGlmKCBzaW5nbGVDbGlja1N0YXRlID09PSAyICkge1xyXG5cclxuICAgICAgICAgICAgICAgIHNpbmdsZUNsaWNrU3RhdGUgPSAwO1xyXG4gICAgICAgICAgICAgICAgdGFibGVEYmNsaWNrSGFuZGxlcihldnQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChldnQuYnV0dG9uID09IDIpcmV0dXJuO1xyXG4gICAgICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICAgICAgLy/muIXpmaTooajmoLzkuIrljp/nlJ/ot6jpgInpl67pophcclxuICAgICAgICB2YXIgcmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxcclxuICAgICAgICAgICAgc3RhcnQgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHJhbmdlLnN0YXJ0Q29udGFpbmVyLCAndGFibGUnLCB0cnVlKSxcclxuICAgICAgICAgICAgZW5kID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShyYW5nZS5lbmRDb250YWluZXIsICd0YWJsZScsIHRydWUpO1xyXG5cclxuICAgICAgICBpZiAoc3RhcnQgfHwgZW5kKSB7XHJcbiAgICAgICAgICAgIGlmIChzdGFydCA9PT0gZW5kKSB7XHJcbiAgICAgICAgICAgICAgICBzdGFydCA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocmFuZ2Uuc3RhcnRDb250YWluZXIsIFsndGQnLCAndGgnLCAnY2FwdGlvbiddLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgIGVuZCA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUocmFuZ2UuZW5kQ29udGFpbmVyLCBbJ3RkJywgJ3RoJywgJ2NhcHRpb24nXSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3RhcnQgIT09IGVuZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLnNlbGVjdGlvbi5jbGVhclJhbmdlKClcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG1lLnNlbGVjdGlvbi5jbGVhclJhbmdlKClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBtb3VzZWRvd24gPSBmYWxzZTtcclxuICAgICAgICBtZS5kb2N1bWVudC5ib2R5LnN0eWxlLndlYmtpdFVzZXJTZWxlY3QgPSAnJztcclxuICAgICAgICAvL+aLluaLveeKtuaAgeS4i+eahG1vdXNlVVBcclxuICAgICAgICBpZiAoIG9uRHJhZyAmJiBkcmFnVGQgKSB7XHJcblxyXG4gICAgICAgICAgICBtZS5zZWxlY3Rpb24uZ2V0TmF0aXZlKClbYnJvd3Nlci5pZTliZWxvdyA/ICdlbXB0eScgOiAncmVtb3ZlQWxsUmFuZ2VzJ10oKTtcclxuXHJcbiAgICAgICAgICAgIHNpbmdsZUNsaWNrU3RhdGUgPSAwO1xyXG4gICAgICAgICAgICBkcmFnTGluZSA9IG1lLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1ZV90YWJsZURyYWdMaW5lJyk7XHJcblxyXG4gICAgICAgICAgICAvLyB0cmFjZSAzOTczXHJcbiAgICAgICAgICAgIGlmIChkcmFnTGluZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGRyYWdUZFBvcyA9IGRvbVV0aWxzLmdldFhZKGRyYWdUZCksXHJcbiAgICAgICAgICAgICAgICAgICAgZHJhZ0xpbmVQb3MgPSBkb21VdGlscy5nZXRYWShkcmFnTGluZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChvbkRyYWcpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIFwiaFwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VDb2xXaWR0aChkcmFnVGQsIGRyYWdMaW5lUG9zLnggLSBkcmFnVGRQb3MueCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgXCJ2XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZVJvd0hlaWdodChkcmFnVGQsIGRyYWdMaW5lUG9zLnkgLSBkcmFnVGRQb3MueSAtIGRyYWdUZC5vZmZzZXRIZWlnaHQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgb25EcmFnID0gXCJcIjtcclxuICAgICAgICAgICAgICAgIGRyYWdUZCA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICAgICAgaGlkZURyYWdMaW5lKG1lKTtcclxuICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnc2F2ZVNjZW5lJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy/mraPluLjnirbmgIHkuIvnmoRtb3VzZXVwXHJcbiAgICAgICAgaWYgKCFzdGFydFRkKSB7XHJcbiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKGV2dC50YXJnZXQgfHwgZXZ0LnNyY0VsZW1lbnQsIFwidGRcIiwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIGlmICghdGFyZ2V0KSB0YXJnZXQgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKGV2dC50YXJnZXQgfHwgZXZ0LnNyY0VsZW1lbnQsIFwidGhcIiwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgKHRhcmdldC50YWdOYW1lID09IFwiVERcIiB8fCB0YXJnZXQudGFnTmFtZSA9PSBcIlRIXCIpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAobWUuZmlyZUV2ZW50KFwiZXhjbHVkZXRhYmxlXCIsIHRhcmdldCkgPT09IHRydWUpIHJldHVybjtcclxuICAgICAgICAgICAgICAgIHJhbmdlID0gbmV3IGRvbS5SYW5nZShtZS5kb2N1bWVudCk7XHJcbiAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydCh0YXJnZXQsIDApLnNldEN1cnNvcihmYWxzZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB2YXIgdXQgPSBnZXRVRVRhYmxlKHN0YXJ0VGQpLFxyXG4gICAgICAgICAgICAgICAgY2VsbCA9IHV0ID8gdXQuc2VsZWN0ZWRUZHNbMF0gOiBudWxsO1xyXG4gICAgICAgICAgICBpZiAoY2VsbCkge1xyXG4gICAgICAgICAgICAgICAgcmFuZ2UgPSBuZXcgZG9tLlJhbmdlKG1lLmRvY3VtZW50KTtcclxuICAgICAgICAgICAgICAgIGlmIChkb21VdGlscy5pc0VtcHR5QmxvY2soY2VsbCkpIHtcclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydChjZWxsLCAwKS5zZXRDdXJzb3IoZmFsc2UsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5zZWxlY3ROb2RlQ29udGVudHMoY2VsbCkuc2hyaW5rQm91bmRhcnkoKS5zZXRDdXJzb3IoZmFsc2UsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKS5zaHJpbmtCb3VuZGFyeSgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFyYW5nZS5jb2xsYXBzZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgc3RhcnQgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHJhbmdlLnN0YXJ0Q29udGFpbmVyLCBbJ3RkJywgJ3RoJ10sIHRydWUpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmQgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHJhbmdlLmVuZENvbnRhaW5lciwgWyd0ZCcsICd0aCddLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAvL+WcqHRhYmxl6YeM6L6555qE5LiN6IO95riF6ZmkXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXJ0ICYmICFlbmQgfHwgIXN0YXJ0ICYmIGVuZCB8fCBzdGFydCAmJiBlbmQgJiYgc3RhcnQgIT09IGVuZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRDdXJzb3IoZmFsc2UsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBzdGFydFRkID0gbnVsbDtcclxuICAgICAgICAgICAgbWUucmVtb3ZlTGlzdGVuZXIoJ21vdXNlb3ZlcicsIG1vdXNlT3ZlckV2ZW50KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbWUuX3NlbGVjdGlvbkNoYW5nZSgyNTAsIGV2dCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbW91c2VPdmVyRXZlbnQodHlwZSwgZXZ0KSB7XHJcblxyXG4gICAgICAgIGlmKCBpc0VkaXRvckRpc2FibGVkKCkgKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgICAgIHRhciA9IGV2dC50YXJnZXQgfHwgZXZ0LnNyY0VsZW1lbnQ7XHJcbiAgICAgICAgY3VycmVudFRkID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZSh0YXIsIFwidGRcIiwgdHJ1ZSkgfHwgZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZSh0YXIsIFwidGhcIiwgdHJ1ZSk7XHJcbiAgICAgICAgLy/pnIDopoHliKTmlq3kuKTkuKpUROaYr+WQpuS9jeS6juWQjOS4gOS4quihqOagvOWGhVxyXG4gICAgICAgIGlmIChzdGFydFRkICYmIGN1cnJlbnRUZCAmJlxyXG4gICAgICAgICAgICAoKHN0YXJ0VGQudGFnTmFtZSA9PSBcIlREXCIgJiYgY3VycmVudFRkLnRhZ05hbWUgPT0gXCJURFwiKSB8fCAoc3RhcnRUZC50YWdOYW1lID09IFwiVEhcIiAmJiBjdXJyZW50VGQudGFnTmFtZSA9PSBcIlRIXCIpKSAmJlxyXG4gICAgICAgICAgICBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHN0YXJ0VGQsICd0YWJsZScpID09IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUoY3VycmVudFRkLCAndGFibGUnKSkge1xyXG4gICAgICAgICAgICB2YXIgdXQgPSBnZXRVRVRhYmxlKGN1cnJlbnRUZCk7XHJcbiAgICAgICAgICAgIGlmIChzdGFydFRkICE9IGN1cnJlbnRUZCkge1xyXG4gICAgICAgICAgICAgICAgbWUuZG9jdW1lbnQuYm9keS5zdHlsZS53ZWJraXRVc2VyU2VsZWN0ID0gJ25vbmUnO1xyXG4gICAgICAgICAgICAgICAgbWUuc2VsZWN0aW9uLmdldE5hdGl2ZSgpW2Jyb3dzZXIuaWU5YmVsb3cgPyAnZW1wdHknIDogJ3JlbW92ZUFsbFJhbmdlcyddKCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmFuZ2UgPSB1dC5nZXRDZWxsc1JhbmdlKHN0YXJ0VGQsIGN1cnJlbnRUZCk7XHJcbiAgICAgICAgICAgICAgICB1dC5zZXRTZWxlY3RlZChyYW5nZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBtZS5kb2N1bWVudC5ib2R5LnN0eWxlLndlYmtpdFVzZXJTZWxlY3QgPSAnJztcclxuICAgICAgICAgICAgICAgIHV0LmNsZWFyU2VsZWN0ZWQoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0ID8gZXZ0LnByZXZlbnREZWZhdWx0KCkgOiAoZXZ0LnJldHVyblZhbHVlID0gZmFsc2UpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHNldENlbGxIZWlnaHQoY2VsbCwgaGVpZ2h0LCBiYWNrSGVpZ2h0KSB7XHJcbiAgICAgICAgdmFyIGxpbmVIaWdodCA9IHBhcnNlSW50KGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUoY2VsbCwgXCJsaW5lLWhlaWdodFwiKSwgMTApLFxyXG4gICAgICAgICAgICB0bXBIZWlnaHQgPSBiYWNrSGVpZ2h0ICsgaGVpZ2h0O1xyXG4gICAgICAgIGhlaWdodCA9IHRtcEhlaWdodCA8IGxpbmVIaWdodCA/IGxpbmVIaWdodCA6IHRtcEhlaWdodDtcclxuICAgICAgICBpZiAoY2VsbC5zdHlsZS5oZWlnaHQpIGNlbGwuc3R5bGUuaGVpZ2h0ID0gXCJcIjtcclxuICAgICAgICBjZWxsLnJvd1NwYW4gPT0gMSA/IGNlbGwuc2V0QXR0cmlidXRlKFwiaGVpZ2h0XCIsIGhlaWdodCkgOiAoY2VsbC5yZW1vdmVBdHRyaWJ1dGUgJiYgY2VsbC5yZW1vdmVBdHRyaWJ1dGUoXCJoZWlnaHRcIikpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldFdpZHRoKGNlbGwpIHtcclxuICAgICAgICBpZiAoIWNlbGwpcmV0dXJuIDA7XHJcbiAgICAgICAgcmV0dXJuIHBhcnNlSW50KGRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUoY2VsbCwgXCJ3aWR0aFwiKSwgMTApO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNoYW5nZUNvbFdpZHRoKGNlbGwsIGNoYW5nZVZhbHVlKSB7XHJcblxyXG4gICAgICAgIHZhciB1dCA9IGdldFVFVGFibGUoY2VsbCk7XHJcbiAgICAgICAgaWYgKHV0KSB7XHJcblxyXG4gICAgICAgICAgICAvL+agueaNruW9k+WJjeenu+WKqOeahOi+ueahhuiOt+WPluebuOWFs+eahOWNleWFg+agvFxyXG4gICAgICAgICAgICB2YXIgdGFibGUgPSB1dC50YWJsZSxcclxuICAgICAgICAgICAgICAgIGNlbGxzID0gZ2V0Q2VsbHNCeU1vdmVCb3JkZXIoIGNlbGwsIHRhYmxlICk7XHJcblxyXG4gICAgICAgICAgICB0YWJsZS5zdHlsZS53aWR0aCA9IFwiXCI7XHJcbiAgICAgICAgICAgIHRhYmxlLnJlbW92ZUF0dHJpYnV0ZShcIndpZHRoXCIpO1xyXG5cclxuICAgICAgICAgICAgLy/kv67mraPmlLnlj5jph49cclxuICAgICAgICAgICAgY2hhbmdlVmFsdWUgPSBjb3JyZWN0Q2hhbmdlVmFsdWUoIGNoYW5nZVZhbHVlLCBjZWxsLCBjZWxscyApO1xyXG5cclxuICAgICAgICAgICAgaWYgKGNlbGwubmV4dFNpYmxpbmcpIHtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgaT0wO1xyXG5cclxuICAgICAgICAgICAgICAgIHV0aWxzLmVhY2goIGNlbGxzLCBmdW5jdGlvbiggY2VsbEdyb3VwICl7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNlbGxHcm91cC5sZWZ0LndpZHRoID0gKCtjZWxsR3JvdXAubGVmdC53aWR0aCkrY2hhbmdlVmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgY2VsbEdyb3VwLnJpZ2h0ICYmICggY2VsbEdyb3VwLnJpZ2h0LndpZHRoID0gKCtjZWxsR3JvdXAucmlnaHQud2lkdGgpLWNoYW5nZVZhbHVlICk7XHJcblxyXG4gICAgICAgICAgICAgICAgfSApO1xyXG5cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuXHJcbiAgICAgICAgICAgICAgICB1dGlscy5lYWNoKCBjZWxscywgZnVuY3Rpb24oIGNlbGxHcm91cCApe1xyXG4gICAgICAgICAgICAgICAgICAgIGNlbGxHcm91cC5sZWZ0LndpZHRoIC09IC1jaGFuZ2VWYWx1ZTtcclxuICAgICAgICAgICAgICAgIH0gKTtcclxuXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGlzRWRpdG9yRGlzYWJsZWQoKSB7XHJcbiAgICAgICAgcmV0dXJuIG1lLmJvZHkuY29udGVudEVkaXRhYmxlID09PSBcImZhbHNlXCI7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY2hhbmdlUm93SGVpZ2h0KHRkLCBjaGFuZ2VWYWx1ZSkge1xyXG4gICAgICAgIGlmIChNYXRoLmFicyhjaGFuZ2VWYWx1ZSkgPCAxMCkgcmV0dXJuO1xyXG4gICAgICAgIHZhciB1dCA9IGdldFVFVGFibGUodGQpO1xyXG4gICAgICAgIGlmICh1dCkge1xyXG4gICAgICAgICAgICB2YXIgY2VsbHMgPSB1dC5nZXRTYW1lRW5kUG9zQ2VsbHModGQsIFwieVwiKSxcclxuICAgICAgICAgICAgLy/lpIfku73pnIDopoHov57luKblj5jljJbnmoR0ZOeahOWOn+Wni+mrmOW6pu+8jOWQpuWImeWQjuacn+aXoOazleiOt+WPluato+ehrueahOWAvFxyXG4gICAgICAgICAgICAgICAgYmFja0hlaWdodCA9IGNlbGxzWzBdID8gY2VsbHNbMF0ub2Zmc2V0SGVpZ2h0IDogMDtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNlbGw7IGNlbGwgPSBjZWxsc1tpKytdOykge1xyXG4gICAgICAgICAgICAgICAgc2V0Q2VsbEhlaWdodChjZWxsLCBjaGFuZ2VWYWx1ZSwgYmFja0hlaWdodCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6I635Y+W6LCD5pW05Y2V5YWD5qC85aSn5bCP55qE55u45YWz5Y2V5YWD5qC8XHJcbiAgICAgKiBAaXNDb250YWluTWVyZ2VDZWxsIOi/lOWbnueahOe7k+aenOS4reaYr+WQpuWMheWQq+WPkeeUn+WQiOW5tuWQjueahOWNleWFg+agvFxyXG4gICAgICovXHJcbiAgICBmdW5jdGlvbiBnZXRDZWxsc0J5TW92ZUJvcmRlciggY2VsbCwgdGFibGUsIGlzQ29udGFpbk1lcmdlQ2VsbCApIHtcclxuXHJcbiAgICAgICAgaWYoICF0YWJsZSApIHtcclxuICAgICAgICAgICAgdGFibGUgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKCBjZWxsLCAndGFibGUnICk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiggIXRhYmxlICkge1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8v6I635Y+W5Yiw6K+l5Y2V5YWD5qC85omA5Zyo6KGM55qE5bqP5YiX5Y+3XHJcbiAgICAgICAgdmFyIGluZGV4ID0gZG9tVXRpbHMuZ2V0Tm9kZUluZGV4KCBjZWxsICksXHJcbiAgICAgICAgICAgIHRlbXAgPSBjZWxsLFxyXG4gICAgICAgICAgICByb3dzID0gdGFibGUucm93cyxcclxuICAgICAgICAgICAgY29sSW5kZXggPSAwO1xyXG5cclxuICAgICAgICB3aGlsZSggdGVtcCApIHtcclxuICAgICAgICAgICAgLy/ojrflj5bliLDlvZPliY3ljZXlhYPmoLzlnKjmnKrlj5HnlJ/ljZXlhYPmoLzlkIjlubbml7bnmoTluo/liJdcclxuICAgICAgICAgICAgaWYoIHRlbXAubm9kZVR5cGUgPT09IDEgKSB7XHJcbiAgICAgICAgICAgICAgICBjb2xJbmRleCArPSAodGVtcC5jb2xTcGFuIHx8IDEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRlbXAgPSB0ZW1wLnByZXZpb3VzU2libGluZztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRlbXAgPSBudWxsO1xyXG5cclxuICAgICAgICAvL+iusOW9leaDs+WFs+eahOWNleWFg+agvFxyXG4gICAgICAgIHZhciBib3JkZXJDZWxscyA9IFtdO1xyXG5cclxuICAgICAgICB1dGlscy5lYWNoKHJvd3MsIGZ1bmN0aW9uKCB0YWJSb3cgKXtcclxuXHJcbiAgICAgICAgICAgIHZhciBjZWxscyA9IHRhYlJvdy5jZWxscyxcclxuICAgICAgICAgICAgICAgIGN1cnJJbmRleCA9IDA7XHJcblxyXG4gICAgICAgICAgICB1dGlscy5lYWNoKCBjZWxscywgZnVuY3Rpb24oIHRhYkNlbGwgKXtcclxuXHJcbiAgICAgICAgICAgICAgICBjdXJySW5kZXggKz0gKHRhYkNlbGwuY29sU3BhbiB8fCAxKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiggY3VyckluZGV4ID09PSBjb2xJbmRleCApIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgYm9yZGVyQ2VsbHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IHRhYkNlbGwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0OiB0YWJDZWxsLm5leHRTaWJsaW5nIHx8IG51bGxcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG5cclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiggY3VyckluZGV4ID4gY29sSW5kZXggKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmKCBpc0NvbnRhaW5NZXJnZUNlbGwgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckNlbGxzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogdGFiQ2VsbFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICB9ICk7XHJcblxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gYm9yZGVyQ2VsbHM7XHJcblxyXG4gICAgfVxyXG5cclxuXHJcbiAgICAvKipcclxuICAgICAqIOmAmui/h+e7meWumueahOWNleWFg+agvOmbhuWQiOiOt+WPluacgOWwj+eahOWNleWFg+agvHdpZHRoXHJcbiAgICAgKi9cclxuICAgIGZ1bmN0aW9uIGdldE1pbldpZHRoQnlUYWJsZUNlbGxzKCBjZWxscyApIHtcclxuXHJcbiAgICAgICAgdmFyIG1pbldpZHRoID0gTnVtYmVyLk1BWF9WQUxVRTtcclxuXHJcbiAgICAgICAgZm9yKCB2YXIgaSA9IDAsIGN1ckNlbGw7IGN1ckNlbGwgPSBjZWxsc1sgaSBdIDsgaSsrICkge1xyXG5cclxuICAgICAgICAgICAgbWluV2lkdGggPSBNYXRoLm1pbiggbWluV2lkdGgsIGN1ckNlbGwud2lkdGggfHwgZ2V0VGFibGVDZWxsV2lkdGgoIGN1ckNlbGwgKSApO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBtaW5XaWR0aDtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gY29ycmVjdENoYW5nZVZhbHVlKCBjaGFuZ2VWYWx1ZSwgcmVsYXRlZENlbGwsIGNlbGxzICkge1xyXG5cclxuICAgICAgICAvL+S4uuWNleWFg+agvOeahHBhYWRpbmfpooTnlZnnqbrpl7RcclxuICAgICAgICBjaGFuZ2VWYWx1ZSAtPSBnZXRUYWJjZWxsU3BhY2UoKTtcclxuXHJcbiAgICAgICAgaWYoIGNoYW5nZVZhbHVlIDwgMCApIHtcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjaGFuZ2VWYWx1ZSAtPSBnZXRUYWJsZUNlbGxXaWR0aCggcmVsYXRlZENlbGwgKTtcclxuXHJcbiAgICAgICAgLy/noa7lrprmlrnlkJFcclxuICAgICAgICB2YXIgZGlyZWN0aW9uID0gY2hhbmdlVmFsdWUgPCAwID8gJ2xlZnQnOidyaWdodCc7XHJcblxyXG4gICAgICAgIGNoYW5nZVZhbHVlID0gTWF0aC5hYnMoY2hhbmdlVmFsdWUpO1xyXG5cclxuICAgICAgICAvL+WPquWFs+W/g+mdnuacgOWQjuS4gOS4quWNleWFg+agvOWwseWPr+S7pVxyXG4gICAgICAgIHV0aWxzLmVhY2goIGNlbGxzLCBmdW5jdGlvbiggY2VsbEdyb3VwICl7XHJcblxyXG4gICAgICAgICAgICB2YXIgY3VyQ2VsbCA9IGNlbGxHcm91cFtkaXJlY3Rpb25dO1xyXG5cclxuICAgICAgICAgICAgLy/kuLrljZXlhYPmoLzkv53nlZnmnIDlsI/nqbrpl7RcclxuICAgICAgICAgICAgaWYoIGN1ckNlbGwgKSB7XHJcbiAgICAgICAgICAgICAgICBjaGFuZ2VWYWx1ZSA9IE1hdGgubWluKCBjaGFuZ2VWYWx1ZSwgZ2V0VGFibGVDZWxsV2lkdGgoIGN1ckNlbGwgKS1jZWxsTWluV2lkdGggKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgfSApO1xyXG5cclxuXHJcbiAgICAgICAgLy/kv67mraPotornlYxcclxuICAgICAgICBjaGFuZ2VWYWx1ZSA9IGNoYW5nZVZhbHVlIDwgMCA/IDAgOiBjaGFuZ2VWYWx1ZTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGRpcmVjdGlvbiA9PT0gJ2xlZnQnID8gLWNoYW5nZVZhbHVlIDogY2hhbmdlVmFsdWU7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldFRhYmxlQ2VsbFdpZHRoKCBjZWxsICkge1xyXG5cclxuICAgICAgICB2YXIgd2lkdGggPSAwLFxyXG4gICAgICAgICAgICAvL+WBj+enu+e6oOato+mHj1xyXG4gICAgICAgICAgICBvZmZzZXQgPSAwLFxyXG4gICAgICAgICAgICB3aWR0aCA9IGNlbGwub2Zmc2V0V2lkdGggLSBnZXRUYWJjZWxsU3BhY2UoKTtcclxuXHJcbiAgICAgICAgLy/mnIDlkI7kuIDkuKroioLngrnnuqDmraPkuIDkuItcclxuICAgICAgICBpZiggIWNlbGwubmV4dFNpYmxpbmcgKSB7XHJcblxyXG4gICAgICAgICAgICB3aWR0aCAtPSBnZXRUYWJsZUNlbGxPZmZzZXQoIGNlbGwgKTtcclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB3aWR0aCA9IHdpZHRoIDwgMCA/IDAgOiB3aWR0aDtcclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY2VsbC53aWR0aCA9IHdpZHRoO1xyXG4gICAgICAgIH0gY2F0Y2goZSkge1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHdpZHRoO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluWNleWFg+agvOaJgOWcqOihqOagvOeahOacgOacq+WNleWFg+agvOeahOWBj+enu+mHj1xyXG4gICAgICovXHJcbiAgICBmdW5jdGlvbiBnZXRUYWJsZUNlbGxPZmZzZXQoIGNlbGwgKSB7XHJcblxyXG4gICAgICAgIHRhYiA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUoIGNlbGwsIFwidGFibGVcIiwgZmFsc2UpO1xyXG5cclxuICAgICAgICBpZiggdGFiLm9mZnNldFZhbCA9PT0gdW5kZWZpbmVkICkge1xyXG5cclxuICAgICAgICAgICAgdmFyIHByZXYgPSBjZWxsLnByZXZpb3VzU2libGluZztcclxuXHJcbiAgICAgICAgICAgIGlmKCBwcmV2ICkge1xyXG5cclxuICAgICAgICAgICAgICAgIC8v5pyA5ZCO5LiA5Liq5Y2V5YWD5qC85ZKM5YmN5LiA5Liq5Y2V5YWD5qC855qEd2lkdGggZGlmZue7k+aenCDlpoLmnpzmgbDlpb3kuLrkuIDkuKpib3JkZXIgd2lkdGjvvIwg5YiZ5p2h5Lu25oiQ56uLXHJcbiAgICAgICAgICAgICAgICB0YWIub2Zmc2V0VmFsID0gY2VsbC5vZmZzZXRXaWR0aCAtIHByZXYub2Zmc2V0V2lkdGggPT09IFVULmJvcmRlcldpZHRoID8gVVQuYm9yZGVyV2lkdGggOiAwO1xyXG5cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRhYi5vZmZzZXRWYWwgPSAwO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHRhYi5vZmZzZXRWYWw7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldFRhYmNlbGxTcGFjZSgpIHtcclxuXHJcbiAgICAgICAgaWYoIFVULnRhYmNlbGxTcGFjZSA9PT0gdW5kZWZpbmVkICkge1xyXG5cclxuICAgICAgICAgICAgdmFyIGNlbGwgPSBudWxsLFxyXG4gICAgICAgICAgICAgICAgdGFiID0gbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInRhYmxlXCIpLFxyXG4gICAgICAgICAgICAgICAgdGJvZHkgPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KFwidGJvZHlcIiksXHJcbiAgICAgICAgICAgICAgICB0cm93ID0gbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInRyXCIpLFxyXG4gICAgICAgICAgICAgICAgdGFiY2VsbCA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJ0ZFwiKSxcclxuICAgICAgICAgICAgICAgIG1pcnJvciA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICB0YWJjZWxsLnN0eWxlLmNzc1RleHQgPSAnYm9yZGVyOiAwOyc7XHJcbiAgICAgICAgICAgIHRhYmNlbGwud2lkdGggPSAxO1xyXG5cclxuICAgICAgICAgICAgdHJvdy5hcHBlbmRDaGlsZCggdGFiY2VsbCApO1xyXG4gICAgICAgICAgICB0cm93LmFwcGVuZENoaWxkKCBtaXJyb3IgPSB0YWJjZWxsLmNsb25lTm9kZSggZmFsc2UgKSApO1xyXG5cclxuICAgICAgICAgICAgdGJvZHkuYXBwZW5kQ2hpbGQoIHRyb3cgKTtcclxuXHJcbiAgICAgICAgICAgIHRhYi5hcHBlbmRDaGlsZCggdGJvZHkgKTtcclxuXHJcbiAgICAgICAgICAgIHRhYi5zdHlsZS5jc3NUZXh0ID0gXCJ2aXNpYmlsaXR5OiBoaWRkZW47XCI7XHJcblxyXG4gICAgICAgICAgICBtZS5ib2R5LmFwcGVuZENoaWxkKCB0YWIgKTtcclxuXHJcbiAgICAgICAgICAgIFVULnBhZGRpbmdTcGFjZSA9IHRhYmNlbGwub2Zmc2V0V2lkdGggLSAxO1xyXG5cclxuICAgICAgICAgICAgdmFyIHRtcFRhYldpZHRoID0gdGFiLm9mZnNldFdpZHRoO1xyXG5cclxuICAgICAgICAgICAgdGFiY2VsbC5zdHlsZS5jc3NUZXh0ID0gJyc7XHJcbiAgICAgICAgICAgIG1pcnJvci5zdHlsZS5jc3NUZXh0ID0gJyc7XHJcblxyXG4gICAgICAgICAgICBVVC5ib3JkZXJXaWR0aCA9ICggdGFiLm9mZnNldFdpZHRoIC0gdG1wVGFiV2lkdGggKSAvIDM7XHJcblxyXG4gICAgICAgICAgICBVVC50YWJjZWxsU3BhY2UgPSBVVC5wYWRkaW5nU3BhY2UgKyBVVC5ib3JkZXJXaWR0aDtcclxuXHJcbiAgICAgICAgICAgIG1lLmJvZHkucmVtb3ZlQ2hpbGQoIHRhYiApO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGdldFRhYmNlbGxTcGFjZSA9IGZ1bmN0aW9uKCl7IHJldHVybiBVVC50YWJjZWxsU3BhY2U7IH07XHJcblxyXG4gICAgICAgIHJldHVybiBVVC50YWJjZWxsU3BhY2U7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldERyYWdMaW5lKGVkaXRvciwgZG9jKSB7XHJcbiAgICAgICAgaWYgKG1vdXNlZG93bilyZXR1cm47XHJcbiAgICAgICAgZHJhZ0xpbmUgPSBlZGl0b3IuZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgICBkb21VdGlscy5zZXRBdHRyaWJ1dGVzKGRyYWdMaW5lLCB7XHJcbiAgICAgICAgICAgIGlkOlwidWVfdGFibGVEcmFnTGluZVwiLFxyXG4gICAgICAgICAgICB1bnNlbGVjdGFibGU6J29uJyxcclxuICAgICAgICAgICAgY29udGVudGVkaXRhYmxlOmZhbHNlLFxyXG4gICAgICAgICAgICAnb25yZXNpemVzdGFydCc6J3JldHVybiBmYWxzZScsXHJcbiAgICAgICAgICAgICdvbmRyYWdzdGFydCc6J3JldHVybiBmYWxzZScsXHJcbiAgICAgICAgICAgICdvbnNlbGVjdHN0YXJ0JzoncmV0dXJuIGZhbHNlJyxcclxuICAgICAgICAgICAgc3R5bGU6XCJiYWNrZ3JvdW5kLWNvbG9yOmJsdWU7cG9zaXRpb246YWJzb2x1dGU7cGFkZGluZzowO21hcmdpbjowO2JhY2tncm91bmQtaW1hZ2U6bm9uZTtib3JkZXI6MHB4IG5vbmU7b3BhY2l0eTowO2ZpbHRlcjphbHBoYShvcGFjaXR5PTApXCJcclxuICAgICAgICB9KTtcclxuICAgICAgICBlZGl0b3IuYm9keS5hcHBlbmRDaGlsZChkcmFnTGluZSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gaGlkZURyYWdMaW5lKGVkaXRvcikge1xyXG4gICAgICAgIGlmIChtb3VzZWRvd24pcmV0dXJuO1xyXG4gICAgICAgIHZhciBsaW5lO1xyXG4gICAgICAgIHdoaWxlIChsaW5lID0gZWRpdG9yLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1ZV90YWJsZURyYWdMaW5lJykpIHtcclxuICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKGxpbmUpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5L6d5o2uc3RhdGXvvIh2fGjvvInlnKhjZWxs5L2N572u5pi+56S65qiq57q/XHJcbiAgICAgKiBAcGFyYW0gc3RhdGVcclxuICAgICAqIEBwYXJhbSBjZWxsXHJcbiAgICAgKi9cclxuICAgIGZ1bmN0aW9uIHNob3dEcmFnTGluZUF0KHN0YXRlLCBjZWxsKSB7XHJcbiAgICAgICAgaWYgKCFjZWxsKSByZXR1cm47XHJcbiAgICAgICAgdmFyIHRhYmxlID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShjZWxsLCBcInRhYmxlXCIpLFxyXG4gICAgICAgICAgICBjYXB0aW9uID0gdGFibGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2NhcHRpb24nKSxcclxuICAgICAgICAgICAgd2lkdGggPSB0YWJsZS5vZmZzZXRXaWR0aCxcclxuICAgICAgICAgICAgaGVpZ2h0ID0gdGFibGUub2Zmc2V0SGVpZ2h0IC0gKGNhcHRpb24ubGVuZ3RoID4gMCA/IGNhcHRpb25bMF0ub2Zmc2V0SGVpZ2h0IDogMCksXHJcbiAgICAgICAgICAgIHRhYmxlUG9zID0gZG9tVXRpbHMuZ2V0WFkodGFibGUpLFxyXG4gICAgICAgICAgICBjZWxsUG9zID0gZG9tVXRpbHMuZ2V0WFkoY2VsbCksIGNzcztcclxuICAgICAgICBzd2l0Y2ggKHN0YXRlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgXCJoXCI6XHJcbiAgICAgICAgICAgICAgICBjc3MgPSAnaGVpZ2h0OicgKyBoZWlnaHQgKyAncHg7dG9wOicgKyAodGFibGVQb3MueSArIChjYXB0aW9uLmxlbmd0aCA+IDAgPyBjYXB0aW9uWzBdLm9mZnNldEhlaWdodCA6IDApKSArICdweDtsZWZ0OicgKyAoY2VsbFBvcy54ICsgY2VsbC5vZmZzZXRXaWR0aCk7XHJcbiAgICAgICAgICAgICAgICBkcmFnTGluZS5zdHlsZS5jc3NUZXh0ID0gY3NzICsgJ3B4O3Bvc2l0aW9uOiBhYnNvbHV0ZTtkaXNwbGF5OmJsb2NrO2JhY2tncm91bmQtY29sb3I6Ymx1ZTt3aWR0aDoxcHg7Ym9yZGVyOjA7IGNvbG9yOmJsdWU7b3BhY2l0eTouMztmaWx0ZXI6YWxwaGEob3BhY2l0eT0zMCknO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJ2XCI6XHJcbiAgICAgICAgICAgICAgICBjc3MgPSAnd2lkdGg6JyArIHdpZHRoICsgJ3B4O2xlZnQ6JyArIHRhYmxlUG9zLnggKyAncHg7dG9wOicgKyAoY2VsbFBvcy55ICsgY2VsbC5vZmZzZXRIZWlnaHQgKTtcclxuICAgICAgICAgICAgICAgIC8v5b+F6aG75Yqg5LiKYm9yZGVyOjDlkoxjb2xvcjpibHVl77yM5ZCm5YiZ5L2O54mIaWXkuI3mlK/mjIHog4zmma/oibLmmL7npLpcclxuICAgICAgICAgICAgICAgIGRyYWdMaW5lLnN0eWxlLmNzc1RleHQgPSBjc3MgKyAncHg7b3ZlcmZsb3c6aGlkZGVuO3Bvc2l0aW9uOiBhYnNvbHV0ZTtkaXNwbGF5OmJsb2NrO2JhY2tncm91bmQtY29sb3I6Ymx1ZTtoZWlnaHQ6MXB4O2JvcmRlcjowO2NvbG9yOmJsdWU7b3BhY2l0eTouMjtmaWx0ZXI6YWxwaGEob3BhY2l0eT0yMCknO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5b2T6KGo5qC86L655qGG6aKc6Imy5Li655m96Imy5pe26K6+572u5Li66Jma57q/LHRydWXkuLrmt7vliqDomZrnur9cclxuICAgICAqIEBwYXJhbSBlZGl0b3JcclxuICAgICAqIEBwYXJhbSBmbGFnXHJcbiAgICAgKi9cclxuICAgIGZ1bmN0aW9uIHN3aXRjaEJvcmRlckNvbG9yKGVkaXRvciwgZmxhZykge1xyXG4gICAgICAgIHZhciB0YWJsZUFyciA9IGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKGVkaXRvci5ib2R5LCBcInRhYmxlXCIpLCBjb2xvcjtcclxuICAgICAgICBmb3IgKHZhciBpID0gMCwgbm9kZTsgbm9kZSA9IHRhYmxlQXJyW2krK107KSB7XHJcbiAgICAgICAgICAgIHZhciB0ZCA9IGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKG5vZGUsIFwidGRcIik7XHJcbiAgICAgICAgICAgIGlmICh0ZFswXSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGZsYWcpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb2xvciA9ICh0ZFswXS5zdHlsZS5ib3JkZXJDb2xvcikucmVwbGFjZSgvXFxzL2csIFwiXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICgvKCNmZmZmZmYpfChyZ2JcXCgyNTUsMjU1LDI1NVxcKSkvaWcudGVzdChjb2xvcikpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmFkZENsYXNzKG5vZGUsIFwibm9Cb3JkZXJUYWJsZVwiKVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmVDbGFzc2VzKG5vZGUsIFwibm9Cb3JkZXJUYWJsZVwiKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRUYWJsZVdpZHRoKGVkaXRvciwgbmVlZElFSGFjaywgZGVmYXVsdFZhbHVlKSB7XHJcbiAgICAgICAgdmFyIGJvZHkgPSBlZGl0b3IuYm9keTtcclxuICAgICAgICByZXR1cm4gYm9keS5vZmZzZXRXaWR0aCAtIChuZWVkSUVIYWNrID8gcGFyc2VJbnQoZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZShib2R5LCAnbWFyZ2luLWxlZnQnKSwgMTApICogMiA6IDApIC0gZGVmYXVsdFZhbHVlLnRhYmxlQm9yZGVyICogMiAtIChlZGl0b3Iub3B0aW9ucy5vZmZzZXRXaWR0aCB8fCAwKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPluW9k+WJjeaLluWKqOeahOWNleWFg+agvFxyXG4gICAgICovXHJcbiAgICBmdW5jdGlvbiBnZXRUYXJnZXRUZChlZGl0b3IsIGV2dCkge1xyXG5cclxuICAgICAgICB2YXIgdGFyZ2V0ID0gZG9tVXRpbHMuZmluZFBhcmVudEJ5VGFnTmFtZShldnQudGFyZ2V0IHx8IGV2dC5zcmNFbGVtZW50LCBbXCJ0ZFwiLCBcInRoXCJdLCB0cnVlKSxcclxuICAgICAgICAgICAgZGlyID0gbnVsbDtcclxuXHJcbiAgICAgICAgaWYoICF0YXJnZXQgKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZGlyID0gZ2V0UmVsYXRpb24oIHRhcmdldCwgbW91c2VDb29yZHMoIGV2dCApICk7XHJcblxyXG4gICAgICAgIC8v5aaC5p6c5pyJ5YmN5LiA5Liq6IqC54K577yMIOmcgOimgeWBmuS4gOS4quS/ruato++8jCDlkKbliJnlj6/og73kvJrlvpfliLDkuIDkuKrplJnor6/nmoR0ZFxyXG5cclxuICAgICAgICBpZiggIXRhcmdldCApIHtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiggZGlyID09PSAnaDEnICYmIHRhcmdldC5wcmV2aW91c1NpYmxpbmcgKSB7XHJcblxyXG4gICAgICAgICAgICB2YXIgcG9zaXRpb24gPSBkb21VdGlscy5nZXRYWSggdGFyZ2V0KSxcclxuICAgICAgICAgICAgICAgIGNlbGxXaWR0aCA9IHRhcmdldC5vZmZzZXRXaWR0aDtcclxuXHJcbiAgICAgICAgICAgIGlmKCBNYXRoLmFicyggcG9zaXRpb24ueCArIGNlbGxXaWR0aCAtIGV2dC5jbGllbnRYICkgPiBjZWxsV2lkdGggLyAzICkge1xyXG4gICAgICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnByZXZpb3VzU2libGluZztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9IGVsc2UgaWYoIGRpciA9PT0gJ3YxJyAmJiB0YXJnZXQucGFyZW50Tm9kZS5wcmV2aW91c1NpYmxpbmcgKSB7XHJcblxyXG4gICAgICAgICAgICB2YXIgcG9zaXRpb24gPSBkb21VdGlscy5nZXRYWSggdGFyZ2V0KSxcclxuICAgICAgICAgICAgICAgIGNlbGxIZWlnaHQgPSB0YXJnZXQub2Zmc2V0SGVpZ2h0O1xyXG5cclxuICAgICAgICAgICAgaWYoIE1hdGguYWJzKCBwb3NpdGlvbi55ICsgY2VsbEhlaWdodCAtIGV2dC5jbGllbnRZICkgPiBjZWxsSGVpZ2h0IC8gMyApIHtcclxuICAgICAgICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlLnByZXZpb3VzU2libGluZy5maXJzdENoaWxkO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIC8v5o6S6Zmk5LqG6Z2edGTlhoXpg6jku6Xlj4rnlKjkuo7ku6PnoIHpq5jkuq7pg6jliIbnmoR0ZFxyXG4gICAgICAgIHJldHVybiB0YXJnZXQgJiYgIShlZGl0b3IuZmlyZUV2ZW50KFwiZXhjbHVkZXRhYmxlXCIsIHRhcmdldCkgPT09IHRydWUpID8gdGFyZ2V0IDogbnVsbDtcclxuICAgIH1cclxuXHJcbn07XHJcblxuXG4vLyBwbHVnaW5zL3RhYmxlLnNvcnQuanNcbi8qKlxuICogQ3JlYXRlZCB3aXRoIEpldEJyYWlucyBQaHBTdG9ybS5cbiAqIFVzZXI6IEppbnFuXG4gKiBEYXRlOiAxMy0xMC0xMlxuICogVGltZTog5LiK5Y2IMTA6MjBcbiAqIFRvIGNoYW5nZSB0aGlzIHRlbXBsYXRlIHVzZSBGaWxlIHwgU2V0dGluZ3MgfCBGaWxlIFRlbXBsYXRlcy5cbiAqL1xuXG5VRS5VRVRhYmxlLnByb3RvdHlwZS5zb3J0VGFibGUgPSBmdW5jdGlvbiAoc29ydEJ5Q2VsbEluZGV4LCBjb21wYXJlRm4pIHtcbiAgICB2YXIgdGFibGUgPSB0aGlzLnRhYmxlLFxuICAgICAgICByb3dzID0gdGFibGUucm93cyxcbiAgICAgICAgdHJBcnJheSA9IFtdLFxuICAgICAgICBmbGFnID0gcm93c1swXS5jZWxsc1swXS50YWdOYW1lID09PSBcIlRIXCIsXG4gICAgICAgIGxhc3RSb3dJbmRleCA9IDA7XG4gICAgaWYodGhpcy5zZWxlY3RlZFRkcy5sZW5ndGgpe1xuICAgICAgICB2YXIgcmFuZ2UgPSB0aGlzLmNlbGxzUmFuZ2UsXG4gICAgICAgICAgICBsZW4gPSByYW5nZS5lbmRSb3dJbmRleCArIDE7XG4gICAgICAgIGZvciAodmFyIGkgPSByYW5nZS5iZWdpblJvd0luZGV4OyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgICAgIHRyQXJyYXlbaV0gPSByb3dzW2ldO1xuICAgICAgICB9XG4gICAgICAgIHRyQXJyYXkuc3BsaWNlKDAscmFuZ2UuYmVnaW5Sb3dJbmRleCk7XG4gICAgICAgIGxhc3RSb3dJbmRleCA9IChyYW5nZS5lbmRSb3dJbmRleCArMSkgPT09IHRoaXMucm93c051bSA/IDAgOiByYW5nZS5lbmRSb3dJbmRleCArMTtcbiAgICB9ZWxzZXtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsbGVuID0gcm93cy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgICAgICAgdHJBcnJheVtpXSA9IHJvd3NbaV07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB2YXIgRm4gPSB7XG4gICAgICAgICdyZXZlcnNlY3VycmVudCc6IGZ1bmN0aW9uKHRkMSx0ZDIpe1xuICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgIH0sXG4gICAgICAgICdvcmRlcmJ5YXNjJzogZnVuY3Rpb24odGQxLHRkMil7XG4gICAgICAgICAgICB2YXIgdmFsdWUxID0gdGQxLmlubmVyVGV4dHx8dGQxLnRleHRDb250ZW50LFxuICAgICAgICAgICAgICAgIHZhbHVlMiA9IHRkMi5pbm5lclRleHR8fHRkMi50ZXh0Q29udGVudDtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTEubG9jYWxlQ29tcGFyZSh2YWx1ZTIpO1xuICAgICAgICB9LFxuICAgICAgICAncmV2ZXJzZWJ5YXNjJzogZnVuY3Rpb24odGQxLHRkMil7XG4gICAgICAgICAgICB2YXIgdmFsdWUxID0gdGQxLmlubmVySFRNTCxcbiAgICAgICAgICAgICAgICB2YWx1ZTIgPSB0ZDIuaW5uZXJIVE1MO1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlMi5sb2NhbGVDb21wYXJlKHZhbHVlMSk7XG4gICAgICAgIH0sXG4gICAgICAgICdvcmRlcmJ5bnVtJzogZnVuY3Rpb24odGQxLHRkMil7XG4gICAgICAgICAgICB2YXIgdmFsdWUxID0gdGQxW2Jyb3dzZXIuaWUgPyAnaW5uZXJUZXh0JzondGV4dENvbnRlbnQnXS5tYXRjaCgvXFxkKy8pLFxuICAgICAgICAgICAgICAgIHZhbHVlMiA9IHRkMlticm93c2VyLmllID8gJ2lubmVyVGV4dCc6J3RleHRDb250ZW50J10ubWF0Y2goL1xcZCsvKTtcbiAgICAgICAgICAgIGlmKHZhbHVlMSkgdmFsdWUxID0gK3ZhbHVlMVswXTtcbiAgICAgICAgICAgIGlmKHZhbHVlMikgdmFsdWUyID0gK3ZhbHVlMlswXTtcbiAgICAgICAgICAgIHJldHVybiAodmFsdWUxfHwwKSAtICh2YWx1ZTJ8fDApO1xuICAgICAgICB9LFxuICAgICAgICAncmV2ZXJzZWJ5bnVtJzogZnVuY3Rpb24odGQxLHRkMil7XG4gICAgICAgICAgICB2YXIgdmFsdWUxID0gdGQxW2Jyb3dzZXIuaWUgPyAnaW5uZXJUZXh0JzondGV4dENvbnRlbnQnXS5tYXRjaCgvXFxkKy8pLFxuICAgICAgICAgICAgICAgIHZhbHVlMiA9IHRkMlticm93c2VyLmllID8gJ2lubmVyVGV4dCc6J3RleHRDb250ZW50J10ubWF0Y2goL1xcZCsvKTtcbiAgICAgICAgICAgIGlmKHZhbHVlMSkgdmFsdWUxID0gK3ZhbHVlMVswXTtcbiAgICAgICAgICAgIGlmKHZhbHVlMikgdmFsdWUyID0gK3ZhbHVlMlswXTtcbiAgICAgICAgICAgIHJldHVybiAodmFsdWUyfHwwKSAtICh2YWx1ZTF8fDApO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIC8v5a+56KGo5qC86K6+572u5o6S5bqP55qE5qCH6K6wZGF0YS1zb3J0LXR5cGVcbiAgICB0YWJsZS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc29ydC10eXBlJywgY29tcGFyZUZuICYmIHR5cGVvZiBjb21wYXJlRm4gPT09IFwic3RyaW5nXCIgJiYgRm5bY29tcGFyZUZuXSA/IGNvbXBhcmVGbjonJyk7XG5cbiAgICAvL3Ro5LiN5Y+C5LiO5o6S5bqPXG4gICAgZmxhZyAmJiB0ckFycmF5LnNwbGljZSgwLCAxKTtcbiAgICB0ckFycmF5ID0gdXRpbHMuc29ydCh0ckFycmF5LGZ1bmN0aW9uICh0cjEsIHRyMikge1xuICAgICAgICB2YXIgcmVzdWx0O1xuICAgICAgICBpZiAoY29tcGFyZUZuICYmIHR5cGVvZiBjb21wYXJlRm4gPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgcmVzdWx0ID0gY29tcGFyZUZuLmNhbGwodGhpcywgdHIxLmNlbGxzW3NvcnRCeUNlbGxJbmRleF0sIHRyMi5jZWxsc1tzb3J0QnlDZWxsSW5kZXhdKTtcbiAgICAgICAgfSBlbHNlIGlmIChjb21wYXJlRm4gJiYgdHlwZW9mIGNvbXBhcmVGbiA9PT0gXCJudW1iZXJcIikge1xuICAgICAgICAgICAgcmVzdWx0ID0gMTtcbiAgICAgICAgfSBlbHNlIGlmIChjb21wYXJlRm4gJiYgdHlwZW9mIGNvbXBhcmVGbiA9PT0gXCJzdHJpbmdcIiAmJiBGbltjb21wYXJlRm5dKSB7XG4gICAgICAgICAgICByZXN1bHQgPSBGbltjb21wYXJlRm5dLmNhbGwodGhpcywgdHIxLmNlbGxzW3NvcnRCeUNlbGxJbmRleF0sIHRyMi5jZWxsc1tzb3J0QnlDZWxsSW5kZXhdKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IEZuWydvcmRlcmJ5YXNjJ10uY2FsbCh0aGlzLCB0cjEuY2VsbHNbc29ydEJ5Q2VsbEluZGV4XSwgdHIyLmNlbGxzW3NvcnRCeUNlbGxJbmRleF0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSk7XG4gICAgdmFyIGZyYWdtZW50ID0gdGFibGUub3duZXJEb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG4gICAgZm9yICh2YXIgaiA9IDAsIGxlbiA9IHRyQXJyYXkubGVuZ3RoOyBqIDwgbGVuOyBqKyspIHtcbiAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQodHJBcnJheVtqXSk7XG4gICAgfVxuICAgIHZhciB0Ym9keSA9IHRhYmxlLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwidGJvZHlcIilbMF07XG4gICAgaWYoIWxhc3RSb3dJbmRleCl7XG4gICAgICAgIHRib2R5LmFwcGVuZENoaWxkKGZyYWdtZW50KTtcbiAgICB9ZWxzZXtcbiAgICAgICAgdGJvZHkuaW5zZXJ0QmVmb3JlKGZyYWdtZW50LHJvd3NbbGFzdFJvd0luZGV4LSByYW5nZS5lbmRSb3dJbmRleCArIHJhbmdlLmJlZ2luUm93SW5kZXggLSAxXSlcbiAgICB9XG59O1xuXG5VRS5wbHVnaW5zWyd0YWJsZXNvcnQnXSA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgbWUgPSB0aGlzLFxuICAgICAgICBVVCA9IFVFLlVFVGFibGUsXG4gICAgICAgIGdldFVFVGFibGUgPSBmdW5jdGlvbiAodGRPclRhYmxlKSB7XG4gICAgICAgICAgICByZXR1cm4gVVQuZ2V0VUVUYWJsZSh0ZE9yVGFibGUpO1xuICAgICAgICB9LFxuICAgICAgICBnZXRUYWJsZUl0ZW1zQnlSYW5nZSA9IGZ1bmN0aW9uIChlZGl0b3IpIHtcbiAgICAgICAgICAgIHJldHVybiBVVC5nZXRUYWJsZUl0ZW1zQnlSYW5nZShlZGl0b3IpO1xuICAgICAgICB9O1xuXG5cbiAgICBtZS5yZWFkeShmdW5jdGlvbiAoKSB7XG4gICAgICAgIC8v5re75Yqg6KGo5qC85Y+v5o6S5bqP55qE5qC35byPXG4gICAgICAgIHV0aWxzLmNzc1J1bGUoJ3RhYmxlc29ydCcsXG4gICAgICAgICAgICAndGFibGUuc29ydEVuYWJsZWQgdHIuZmlyc3RSb3cgdGgsdGFibGUuc29ydEVuYWJsZWQgdHIuZmlyc3RSb3cgdGR7cGFkZGluZy1yaWdodDoyMHB4O2JhY2tncm91bmQtcmVwZWF0OiBuby1yZXBlYXQ7YmFja2dyb3VuZC1wb3NpdGlvbjogY2VudGVyIHJpZ2h0OycgK1xuICAgICAgICAgICAgICAgICcgICBiYWNrZ3JvdW5kLWltYWdlOnVybCgnICsgbWUub3B0aW9ucy50aGVtZVBhdGggKyBtZS5vcHRpb25zLnRoZW1lICsgJy9pbWFnZXMvc29ydGFibGUucG5nKTt9JyxcbiAgICAgICAgICAgIG1lLmRvY3VtZW50KTtcblxuICAgICAgICAvL+WBmuWNleWFg+agvOWQiOW5tuaTjeS9nOaXtizmuIXpmaTlj6/mjpLluo/moIfor4ZcbiAgICAgICAgbWUuYWRkTGlzdGVuZXIoXCJhZnRlcmV4ZWNjb21tYW5kXCIsIGZ1bmN0aW9uICh0eXBlLCBjbWQpIHtcbiAgICAgICAgICAgIGlmKCBjbWQgPT0gJ21lcmdlcmlnaHQnIHx8IGNtZCA9PSAnbWVyZ2Vkb3duJyB8fCBjbWQgPT0gJ21lcmdlY2VsbHMnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5leGVjQ29tbWFuZCgnZGlzYWJsZXNvcnQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG5cblxuXG4gICAgLy/ooajmoLzmjpLluo9cbiAgICBVRS5jb21tYW5kc1snc29ydHRhYmxlJ10gPSB7XG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzLFxuICAgICAgICAgICAgICAgIHRhYmxlSXRlbXMgPSBnZXRUYWJsZUl0ZW1zQnlSYW5nZShtZSk7XG4gICAgICAgICAgICBpZiAoIXRhYmxlSXRlbXMuY2VsbCkgcmV0dXJuIC0xO1xuICAgICAgICAgICAgdmFyIHRhYmxlID0gdGFibGVJdGVtcy50YWJsZSxcbiAgICAgICAgICAgICAgICBjZWxscyA9IHRhYmxlLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwidGRcIik7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2VsbDsgY2VsbCA9IGNlbGxzW2krK107KSB7XG4gICAgICAgICAgICAgICAgaWYgKGNlbGwucm93U3BhbiAhPSAxIHx8IGNlbGwuY29sU3BhbiAhPSAxKSByZXR1cm4gLTE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfSxcbiAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uIChjbWQsIGZuKSB7XG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzLFxuICAgICAgICAgICAgICAgIHJhbmdlID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCksXG4gICAgICAgICAgICAgICAgYmsgPSByYW5nZS5jcmVhdGVCb29rbWFyayh0cnVlKSxcbiAgICAgICAgICAgICAgICB0YWJsZUl0ZW1zID0gZ2V0VGFibGVJdGVtc0J5UmFuZ2UobWUpLFxuICAgICAgICAgICAgICAgIGNlbGwgPSB0YWJsZUl0ZW1zLmNlbGwsXG4gICAgICAgICAgICAgICAgdXQgPSBnZXRVRVRhYmxlKHRhYmxlSXRlbXMudGFibGUpLFxuICAgICAgICAgICAgICAgIGNlbGxJbmZvID0gdXQuZ2V0Q2VsbEluZm8oY2VsbCk7XG4gICAgICAgICAgICB1dC5zb3J0VGFibGUoY2VsbEluZm8uY2VsbEluZGV4LCBmbik7XG4gICAgICAgICAgICByYW5nZS5tb3ZlVG9Cb29rbWFyayhiayk7XG4gICAgICAgICAgICB0cnl7XG4gICAgICAgICAgICAgICAgcmFuZ2Uuc2VsZWN0KCk7XG4gICAgICAgICAgICB9Y2F0Y2goZSl7fVxuICAgICAgICB9XG4gICAgfTtcblxuICAgIC8v6K6+572u6KGo5qC85Y+v5o6S5bqPLOa4hemZpOihqOagvOWPr+aOkuW6j1xuICAgIFVFLmNvbW1hbmRzW1wiZW5hYmxlc29ydFwiXSA9IFVFLmNvbW1hbmRzW1wiZGlzYWJsZXNvcnRcIl0gPSB7XG4gICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoY21kKSB7XG4gICAgICAgICAgICB2YXIgdGFibGUgPSBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKS50YWJsZTtcbiAgICAgICAgICAgIGlmKHRhYmxlICYmIGNtZD09J2VuYWJsZXNvcnQnKSB7XG4gICAgICAgICAgICAgICAgdmFyIGNlbGxzID0gZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFibGUsICd0aCB0ZCcpO1xuICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGk8Y2VsbHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYoY2VsbHNbaV0uZ2V0QXR0cmlidXRlKCdjb2xzcGFuJyk+MSB8fCBjZWxsc1tpXS5nZXRBdHRyaWJ1dGUoJ3Jvd3NwYW4nKT4xKSByZXR1cm4gLTE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gIXRhYmxlID8gLTE6IGNtZD09J2VuYWJsZXNvcnQnIF4gdGFibGUuZ2V0QXR0cmlidXRlKCdkYXRhLXNvcnQnKSE9J3NvcnRFbmFibGVkJyA/IC0xOjA7XG4gICAgICAgIH0sXG4gICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoY21kKSB7XG4gICAgICAgICAgICB2YXIgdGFibGUgPSBnZXRUYWJsZUl0ZW1zQnlSYW5nZSh0aGlzKS50YWJsZTtcbiAgICAgICAgICAgIHRhYmxlLnNldEF0dHJpYnV0ZShcImRhdGEtc29ydFwiLCBjbWQgPT0gXCJlbmFibGVzb3J0XCIgPyBcInNvcnRFbmFibGVkXCIgOiBcInNvcnREaXNhYmxlZFwiKTtcbiAgICAgICAgICAgIGNtZCA9PSBcImVuYWJsZXNvcnRcIiA/IGRvbVV0aWxzLmFkZENsYXNzKHRhYmxlLFwic29ydEVuYWJsZWRcIik6ZG9tVXRpbHMucmVtb3ZlQ2xhc3Nlcyh0YWJsZSxcInNvcnRFbmFibGVkXCIpO1xuICAgICAgICB9XG4gICAgfTtcbn07XG5cblxuLy8gcGx1Z2lucy9jb250ZXh0bWVudS5qc1xuLy8vaW1wb3J0IGNvcmVcclxuLy8vY29tbWFuZHMg5Y+z6ZSu6I+c5Y2VXHJcbi8vL2NvbW1hbmRzTmFtZSAgQ29udGV4dE1lbnVcclxuLy8vY29tbWFuZHNUaXRsZSAg5Y+z6ZSu6I+c5Y2VXHJcbi8qKlxyXG4gKiDlj7PplK7oj5zljZVcclxuICogQGZ1bmN0aW9uXHJcbiAqIEBuYW1lIGJhaWR1LmVkaXRvci5wbHVnaW5zLmNvbnRleHRtZW51XHJcbiAqIEBhdXRob3IgemhhbnlpXHJcbiAqL1xyXG5cclxuVUUucGx1Z2luc1snY29udGV4dG1lbnUnXSA9IGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICBtZS5zZXRPcHQoJ2VuYWJsZUNvbnRleHRNZW51Jyx0cnVlKTtcclxuICAgIGlmKG1lLmdldE9wdCgnZW5hYmxlQ29udGV4dE1lbnUnKSA9PT0gZmFsc2Upe1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHZhciBsYW5nID0gbWUuZ2V0TGFuZyggXCJjb250ZXh0TWVudVwiICksXHJcbiAgICAgICAgICAgIG1lbnUsXHJcbiAgICAgICAgICAgIGl0ZW1zID0gbWUub3B0aW9ucy5jb250ZXh0TWVudSB8fCBbXHJcbiAgICAgICAgICAgICAgICB7bGFiZWw6bGFuZ1snc2VsZWN0YWxsJ10sIGNtZE5hbWU6J3NlbGVjdGFsbCd9LFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcuY2xlYXJkb2MsXHJcbiAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonY2xlYXJkb2MnLFxyXG4gICAgICAgICAgICAgICAgICAgIGV4ZWM6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIGNvbmZpcm0oIGxhbmcuY29uZmlybWNsZWFyICkgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWNDb21tYW5kKCAnY2xlYXJkb2MnICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgJy0nLFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcudW5saW5rLFxyXG4gICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J3VubGluaydcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAnLScsXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgZ3JvdXA6bGFuZy5wYXJhZ3JhcGgsXHJcbiAgICAgICAgICAgICAgICAgICAgaWNvbjonanVzdGlmeWp1c3RpZnknLFxyXG4gICAgICAgICAgICAgICAgICAgIHN1Yk1lbnU6W1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLmp1c3RpZnlsZWZ0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonanVzdGlmeScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTonbGVmdCdcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6bGFuZy5qdXN0aWZ5cmlnaHQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidqdXN0aWZ5JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOidyaWdodCdcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6bGFuZy5qdXN0aWZ5Y2VudGVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonanVzdGlmeScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTonY2VudGVyJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLmp1c3RpZnlqdXN0aWZ5LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonanVzdGlmeScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTonanVzdGlmeSdcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAnLScsXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgZ3JvdXA6bGFuZy50YWJsZSxcclxuICAgICAgICAgICAgICAgICAgICBpY29uOid0YWJsZScsXHJcbiAgICAgICAgICAgICAgICAgICAgc3ViTWVudTpbXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcuaW5zZXJ0dGFibGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidpbnNlcnR0YWJsZSdcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6bGFuZy5kZWxldGV0YWJsZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J2RlbGV0ZXRhYmxlJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAnLScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcuZGVsZXRlcm93LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonZGVsZXRlcm93J1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLmRlbGV0ZWNvbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J2RlbGV0ZWNvbCdcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6bGFuZy5pbnNlcnRjb2wsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidpbnNlcnRjb2wnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcuaW5zZXJ0Y29sbmV4dCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J2luc2VydGNvbG5leHQnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcuaW5zZXJ0cm93LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonaW5zZXJ0cm93J1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLmluc2VydHJvd25leHQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidpbnNlcnRyb3duZXh0J1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAnLScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcuaW5zZXJ0Y2FwdGlvbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J2luc2VydGNhcHRpb24nXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcuZGVsZXRlY2FwdGlvbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J2RlbGV0ZWNhcHRpb24nXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcuaW5zZXJ0dGl0bGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidpbnNlcnR0aXRsZSdcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6bGFuZy5kZWxldGV0aXRsZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J2RlbGV0ZXRpdGxlJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLmluc2VydHRpdGxlY29sLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonaW5zZXJ0dGl0bGVjb2wnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcuZGVsZXRldGl0bGVjb2wsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidkZWxldGV0aXRsZWNvbCdcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgJy0nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLm1lcmdlY2VsbHMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidtZXJnZWNlbGxzJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLm1lcmdlcmlnaHQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidtZXJnZXJpZ2h0J1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLm1lcmdlZG93bixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J21lcmdlZG93bidcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgJy0nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLnNwbGl0dG9yb3dzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonc3BsaXR0b3Jvd3MnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcuc3BsaXR0b2NvbHMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidzcGxpdHRvY29scydcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6bGFuZy5zcGxpdHRvY2VsbHMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidzcGxpdHRvY2VsbHMnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICctJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6bGFuZy5hdmVyYWdlRGlzZVJvdyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J2F2ZXJhZ2VkaXN0cmlidXRlcm93J1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLmF2ZXJhZ2VEaXNDb2wsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidhdmVyYWdlZGlzdHJpYnV0ZWNvbCdcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgJy0nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLmVkaXR0ZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J2VkaXR0ZCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGVjOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIFVFLnVpWydlZGl0dGQnXSApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3IFVFLnVpWydlZGl0dGQnXSggdGhpcyApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldERpYWxvZygnZWRpdHRkJykub3BlbigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLmVkaXR0YWJsZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J2VkaXR0YWJsZScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGVjOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIFVFLnVpWydlZGl0dGFibGUnXSApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3IFVFLnVpWydlZGl0dGFibGUnXSggdGhpcyApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldERpYWxvZygnZWRpdHRhYmxlJykub3BlbigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLnNldGJvcmRlcnZpc2libGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidzZXRib3JkZXJ2aXNpYmxlJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBncm91cDpsYW5nLnRhYmxlc29ydCxcclxuICAgICAgICAgICAgICAgICAgICBpY29uOid0YWJsZXNvcnQnLFxyXG4gICAgICAgICAgICAgICAgICAgIHN1Yk1lbnU6W1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLmVuYWJsZXNvcnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidlbmFibGVzb3J0J1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLmRpc2FibGVzb3J0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonZGlzYWJsZXNvcnQnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICctJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6bGFuZy5yZXZlcnNlY3VycmVudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J3NvcnR0YWJsZScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZToncmV2ZXJzZWN1cnJlbnQnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcub3JkZXJieWFzYyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J3NvcnR0YWJsZScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTonb3JkZXJieWFzYydcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6bGFuZy5yZXZlcnNlYnlhc2MsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidzb3J0dGFibGUnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6J3JldmVyc2VieWFzYydcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6bGFuZy5vcmRlcmJ5bnVtLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonc29ydHRhYmxlJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOidvcmRlcmJ5bnVtJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLnJldmVyc2VieW51bSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J3NvcnR0YWJsZScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZToncmV2ZXJzZWJ5bnVtJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBncm91cDpsYW5nLmJvcmRlcmJrLFxyXG4gICAgICAgICAgICAgICAgICAgIGljb246J2JvcmRlckJhY2snLFxyXG4gICAgICAgICAgICAgICAgICAgIHN1Yk1lbnU6W1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLnNldGNvbG9yLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTpcImludGVybGFjZXRhYmxlXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGVjOmZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5leGVjQ29tbWFuZChcImludGVybGFjZXRhYmxlXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLnVuc2V0Y29sb3IsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOlwidW5pbnRlcmxhY2V0YWJsZVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhlYzpmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlY0NvbW1hbmQoXCJ1bmludGVybGFjZXRhYmxlXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLnNldGJhY2tncm91bmQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOlwic2V0dGFibGViYWNrZ3JvdW5kXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGVjOmZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5leGVjQ29tbWFuZChcInNldHRhYmxlYmFja2dyb3VuZFwiLHtyZXBlYXQ6dHJ1ZSxjb2xvckxpc3Q6W1wiI2JiYlwiLFwiI2NjY1wiXX0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLnVuc2V0YmFja2dyb3VuZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6XCJjbGVhcnRhYmxlYmFja2dyb3VuZFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhlYzpmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlY0NvbW1hbmQoXCJjbGVhcnRhYmxlYmFja2dyb3VuZFwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6bGFuZy5yZWRhbmRibHVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTpcInNldHRhYmxlYmFja2dyb3VuZFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhlYzpmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlY0NvbW1hbmQoXCJzZXR0YWJsZWJhY2tncm91bmRcIix7cmVwZWF0OnRydWUsY29sb3JMaXN0OltcInJlZFwiLFwiYmx1ZVwiXX0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLnRocmVlY29sb3JncmFkaWVudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6XCJzZXR0YWJsZWJhY2tncm91bmRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWM6ZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWNDb21tYW5kKFwic2V0dGFibGViYWNrZ3JvdW5kXCIse3JlcGVhdDp0cnVlLGNvbG9yTGlzdDpbXCIjYWFhXCIsXCIjYmJiXCIsXCIjY2NjXCJdfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBdXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGdyb3VwOmxhbmcuYWxpZ250ZCxcclxuICAgICAgICAgICAgICAgICAgICBpY29uOidhbGlnbnRkJyxcclxuICAgICAgICAgICAgICAgICAgICBzdWJNZW51OltcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonY2VsbGFsaWdubWVudCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTp7YWxpZ246J2xlZnQnLHZBbGlnbjondG9wJ31cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonY2VsbGFsaWdubWVudCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTp7YWxpZ246J2NlbnRlcicsdkFsaWduOid0b3AnfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidjZWxsYWxpZ25tZW50JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOnthbGlnbjoncmlnaHQnLHZBbGlnbjondG9wJ31cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonY2VsbGFsaWdubWVudCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTp7YWxpZ246J2xlZnQnLHZBbGlnbjonbWlkZGxlJ31cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonY2VsbGFsaWdubWVudCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTp7YWxpZ246J2NlbnRlcicsdkFsaWduOidtaWRkbGUnfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidjZWxsYWxpZ25tZW50JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOnthbGlnbjoncmlnaHQnLHZBbGlnbjonbWlkZGxlJ31cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonY2VsbGFsaWdubWVudCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTp7YWxpZ246J2xlZnQnLHZBbGlnbjonYm90dG9tJ31cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTonY2VsbGFsaWdubWVudCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTp7YWxpZ246J2NlbnRlcicsdkFsaWduOidib3R0b20nfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidjZWxsYWxpZ25tZW50JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOnthbGlnbjoncmlnaHQnLHZBbGlnbjonYm90dG9tJ31cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgZ3JvdXA6bGFuZy5hbGlnbnRhYmxlLFxyXG4gICAgICAgICAgICAgICAgICAgIGljb246J2FsaWdudGFibGUnLFxyXG4gICAgICAgICAgICAgICAgICAgIHN1Yk1lbnU6W1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbWROYW1lOid0YWJsZWFsaWdubWVudCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6ICdsZWZ0JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcudGFibGVsZWZ0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6XCJsZWZ0XCJcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY21kTmFtZTondGFibGVhbGlnbm1lbnQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOiAnY2VudGVyJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcudGFibGVjZW50ZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTpcImNlbnRlclwiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J3RhYmxlYWxpZ25tZW50JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogJ3JpZ2h0JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmcudGFibGVyaWdodCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOlwicmlnaHRcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICctJyxcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nLmluc2VydHBhcmFncmFwaGJlZm9yZSxcclxuICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidpbnNlcnRwYXJhZ3JhcGgnLFxyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOnRydWVcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6bGFuZy5pbnNlcnRwYXJhZ3JhcGhhZnRlcixcclxuICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidpbnNlcnRwYXJhZ3JhcGgnXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGxhYmVsOmxhbmdbJ2NvcHknXSxcclxuICAgICAgICAgICAgICAgICAgICBjbWROYW1lOidjb3B5J1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBsYWJlbDpsYW5nWydwYXN0ZSddLFxyXG4gICAgICAgICAgICAgICAgICAgIGNtZE5hbWU6J3Bhc3RlJ1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBdO1xyXG4gICAgaWYgKCAhaXRlbXMubGVuZ3RoICkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHZhciB1aVV0aWxzID0gVUUudWkudWlVdGlscztcclxuXHJcbiAgICBtZS5hZGRMaXN0ZW5lciggJ2NvbnRleHRtZW51JywgZnVuY3Rpb24gKCB0eXBlLCBldnQgKSB7XHJcblxyXG4gICAgICAgIHZhciBvZmZzZXQgPSB1aVV0aWxzLmdldFZpZXdwb3J0T2Zmc2V0QnlFdmVudCggZXZ0ICk7XHJcbiAgICAgICAgbWUuZmlyZUV2ZW50KCAnYmVmb3Jlc2VsZWN0aW9uY2hhbmdlJyApO1xyXG4gICAgICAgIGlmICggbWVudSApIHtcclxuICAgICAgICAgICAgbWVudS5kZXN0cm95KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAoIHZhciBpID0gMCwgdGksIGNvbnRleHRJdGVtcyA9IFtdOyB0aSA9IGl0ZW1zW2ldOyBpKysgKSB7XHJcbiAgICAgICAgICAgIHZhciBsYXN0O1xyXG4gICAgICAgICAgICAoZnVuY3Rpb24gKCBpdGVtICkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCBpdGVtID09ICctJyApIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIChsYXN0ID0gY29udGV4dEl0ZW1zW2NvbnRleHRJdGVtcy5sZW5ndGggLSAxIF0gKSAmJiBsYXN0ICE9PSAnLScgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHRJdGVtcy5wdXNoKCAnLScgKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBpdGVtLmhhc093blByb3BlcnR5KCBcImdyb3VwXCIgKSApIHtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKCB2YXIgaiA9IDAsIGNqLCBzdWJNZW51ID0gW107IGNqID0gaXRlbS5zdWJNZW51W2pdOyBqKysgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAoIHN1Ykl0ZW0gKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHN1Ykl0ZW0gPT0gJy0nICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggKGxhc3QgPSBzdWJNZW51W3N1Yk1lbnUubGVuZ3RoIC0gMSBdICkgJiYgbGFzdCAhPT0gJy0nICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJNZW51LnB1c2goICctJyApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJNZW51LnNwbGljZShzdWJNZW51Lmxlbmd0aC0xKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggKG1lLmNvbW1hbmRzW3N1Ykl0ZW0uY21kTmFtZV0gfHwgVUUuY29tbWFuZHNbc3ViSXRlbS5jbWROYW1lXSB8fCBzdWJJdGVtLnF1ZXJ5KSAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHN1Ykl0ZW0ucXVlcnkgPyBzdWJJdGVtLnF1ZXJ5KCkgOiBtZS5xdWVyeUNvbW1hbmRTdGF0ZSggc3ViSXRlbS5jbWROYW1lICkpID4gLTEgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1Yk1lbnUucHVzaCgge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsJzpzdWJJdGVtLmxhYmVsIHx8IG1lLmdldExhbmcoIFwiY29udGV4dE1lbnUuXCIgKyBzdWJJdGVtLmNtZE5hbWUgKyAoc3ViSXRlbS52YWx1ZSB8fCAnJykgKXx8XCJcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjbGFzc05hbWUnOidlZHVpLWZvci0nICtzdWJJdGVtLmNtZE5hbWUgKyAoIHN1Ykl0ZW0uY2xhc3NOYW1lID8gKCAnIGVkdWktZm9yLScgKyBzdWJJdGVtLmNtZE5hbWUgKyAnLScgKyBzdWJJdGVtLmNsYXNzTmFtZSApIDogJycgKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uY2xpY2s6c3ViSXRlbS5leGVjID8gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJJdGVtLmV4ZWMuY2FsbCggbWUgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuZXhlY0NvbW1hbmQoIHN1Ykl0ZW0uY21kTmFtZSwgc3ViSXRlbS52YWx1ZSApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KSggY2ogKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBzdWJNZW51Lmxlbmd0aCApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0TGFiZWwoKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoaXRlbS5pY29uKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwidGFibGVcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lLmdldExhbmcoIFwiY29udGV4dE1lbnUudGFibGVcIiApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJqdXN0aWZ5anVzdGlmeVwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWUuZ2V0TGFuZyggXCJjb250ZXh0TWVudS5wYXJhZ3JhcGhcIiApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJhbGlnbnRkXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtZS5nZXRMYW5nKFwiY29udGV4dE1lbnUuYWxpZ250ZFwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwiYWxpZ250YWJsZVwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWUuZ2V0TGFuZyhcImNvbnRleHRNZW51LmFsaWdudGFibGVcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcInRhYmxlc29ydFwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGFuZy50YWJsZXNvcnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcImJvcmRlckJhY2tcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxhbmcuYm9yZGVyYms7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdCA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0SXRlbXMucHVzaCgge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy90b2RvIOS/ruato+aIkOiHquWKqOiOt+WPluaWueW8j1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xhYmVsJzpnZXRMYWJlbCgpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOidlZHVpLWZvci0nICsgaXRlbS5pY29uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N1Yk1lbnUnOntcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtczpzdWJNZW51LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvcjptZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9ICk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy/mnInlj6/og71jb21tbWFuZOayoeacieWKoOi9veWPs+mUruS4jeiDveWHuuadpe+8jOaIluiAheayoeaciWNvbW1hbmTkuZ/mg7Pog73lsZXnpLrlh7rmnaXmt7vliqBxdWVyeeaWueazlVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICggKG1lLmNvbW1hbmRzW2l0ZW0uY21kTmFtZV0gfHwgVUUuY29tbWFuZHNbaXRlbS5jbWROYW1lXSB8fCBpdGVtLnF1ZXJ5KSAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKGl0ZW0ucXVlcnkgPyBpdGVtLnF1ZXJ5LmNhbGwobWUpIDogbWUucXVlcnlDb21tYW5kU3RhdGUoIGl0ZW0uY21kTmFtZSApKSA+IC0xICkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dEl0ZW1zLnB1c2goIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYWJlbCc6aXRlbS5sYWJlbCB8fCBtZS5nZXRMYW5nKCBcImNvbnRleHRNZW51LlwiICsgaXRlbS5jbWROYW1lICksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6J2VkdWktZm9yLScgKyAoaXRlbS5pY29uID8gaXRlbS5pY29uIDogaXRlbS5jbWROYW1lICsgKGl0ZW0udmFsdWUgfHwgJycpKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uY2xpY2s6aXRlbS5leGVjID8gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0uZXhlYy5jYWxsKCBtZSApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSA6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5leGVjQ29tbWFuZCggaXRlbS5jbWROYW1lLCBpdGVtLnZhbHVlICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfSkoIHRpICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICggY29udGV4dEl0ZW1zW2NvbnRleHRJdGVtcy5sZW5ndGggLSAxXSA9PSAnLScgKSB7XHJcbiAgICAgICAgICAgIGNvbnRleHRJdGVtcy5wb3AoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIG1lbnUgPSBuZXcgVUUudWkuTWVudSgge1xyXG4gICAgICAgICAgICBpdGVtczpjb250ZXh0SXRlbXMsXHJcbiAgICAgICAgICAgIGNsYXNzTmFtZTpcImVkdWktY29udGV4dG1lbnVcIixcclxuICAgICAgICAgICAgZWRpdG9yOm1lXHJcbiAgICAgICAgfSApO1xyXG4gICAgICAgIG1lbnUucmVuZGVyKCk7XHJcbiAgICAgICAgbWVudS5zaG93QXQoIG9mZnNldCApO1xyXG5cclxuICAgICAgICBtZS5maXJlRXZlbnQoXCJhZnRlcnNob3djb250ZXh0bWVudVwiLG1lbnUpO1xyXG5cclxuICAgICAgICBkb21VdGlscy5wcmV2ZW50RGVmYXVsdCggZXZ0ICk7XHJcbiAgICAgICAgaWYgKCBicm93c2VyLmllICkge1xyXG4gICAgICAgICAgICB2YXIgaWVSYW5nZTtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGllUmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0TmF0aXZlKCkuY3JlYXRlUmFuZ2UoKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoIGUgKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCBpZVJhbmdlLml0ZW0gKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmFuZ2UgPSBuZXcgZG9tLlJhbmdlKCBtZS5kb2N1bWVudCApO1xyXG4gICAgICAgICAgICAgICAgcmFuZ2Uuc2VsZWN0Tm9kZSggaWVSYW5nZS5pdGVtKCAwICkgKS5zZWxlY3QoIHRydWUsIHRydWUgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOa3u+WKoOWkjeWItueahGZsYXNo5oyJ6ZKuXHJcbiAgICBtZS5hZGRMaXN0ZW5lcignYWZ0ZXJzaG93Y29udGV4dG1lbnUnLCBmdW5jdGlvbih0eXBlLCBtZW51KSB7XHJcbiAgICAgICAgaWYgKG1lLnplcm9jbGlwYm9hcmQpIHtcclxuICAgICAgICAgICAgdmFyIGl0ZW1zID0gbWVudS5pdGVtcztcclxuICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGl0ZW1zKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXRlbXNba2V5XS5jbGFzc05hbWUgPT0gJ2VkdWktZm9yLWNvcHknKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuemVyb2NsaXBib2FyZC5jbGlwKGl0ZW1zW2tleV0uZ2V0RG9tKCkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG59O1xyXG5cblxuLy8gcGx1Z2lucy9zaG9ydGN1dG1lbnUuanNcbi8vL2ltcG9ydCBjb3JlXG4vLy9jb21tYW5kcyAgICAgICDlvLnlh7roj5zljZVcbi8vIGNvbW1hbmRzTmFtZSAgcG9wdXBtZW51XG4vLy9jb21tYW5kc1RpdGxlICDlvLnlh7roj5zljZVcbi8qKlxuICog5by55Ye66I+c5Y2VXG4gKiBAZnVuY3Rpb25cbiAqIEBuYW1lIGJhaWR1LmVkaXRvci5wbHVnaW5zLnBvcHVwbWVudVxuICogQGF1dGhvciB4dWhlbmdcbiAqL1xuXG5VRS5wbHVnaW5zWydzaG9ydGN1dG1lbnUnXSA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgbWUgPSB0aGlzLFxuICAgICAgICBtZW51LFxuICAgICAgICBpdGVtcyA9IG1lLm9wdGlvbnMuc2hvcnRjdXRNZW51IHx8IFtdO1xuXG4gICAgaWYgKCFpdGVtcy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIG1lLmFkZExpc3RlbmVyICgnY29udGV4dG1lbnUgbW91c2V1cCcgLCBmdW5jdGlvbiAodHlwZSAsIGUpIHtcbiAgICAgICAgdmFyIG1lID0gdGhpcyxcbiAgICAgICAgICAgIGN1c3RvbUV2dCA9IHtcbiAgICAgICAgICAgICAgICB0eXBlIDogdHlwZSAsXG4gICAgICAgICAgICAgICAgdGFyZ2V0IDogZS50YXJnZXQgfHwgZS5zcmNFbGVtZW50ICxcbiAgICAgICAgICAgICAgICBzY3JlZW5YIDogZS5zY3JlZW5YICxcbiAgICAgICAgICAgICAgICBzY3JlZW5ZIDogZS5zY3JlZW5ZICxcbiAgICAgICAgICAgICAgICBjbGllbnRYIDogZS5jbGllbnRYICxcbiAgICAgICAgICAgICAgICBjbGllbnRZIDogZS5jbGllbnRZXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIHNldFRpbWVvdXQgKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBybmcgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UgKCk7XG4gICAgICAgICAgICBpZiAocm5nLmNvbGxhcHNlZCA9PT0gZmFsc2UgfHwgdHlwZSA9PSBcImNvbnRleHRtZW51XCIpIHtcblxuICAgICAgICAgICAgICAgIGlmICghbWVudSkge1xuICAgICAgICAgICAgICAgICAgICBtZW51ID0gbmV3IGJhaWR1LmVkaXRvci51aS5TaG9ydEN1dE1lbnUgKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvciA6IG1lICxcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zIDogaXRlbXMgLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhlbWUgOiBtZS5vcHRpb25zLnRoZW1lICxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA6ICdlZHVpLXNob3J0Y3V0bWVudSdcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgbWVudS5yZW5kZXIgKCk7XG4gICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCAoXCJhZnRlcnJlbmRlcnNob3J0Y3V0bWVudVwiICwgbWVudSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbWVudS5zaG93IChjdXN0b21FdnQgLCAhIVVFLnBsdWdpbnNbJ2NvbnRleHRtZW51J10pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAodHlwZSA9PSAnY29udGV4dG1lbnUnKSB7XG4gICAgICAgICAgICBkb21VdGlscy5wcmV2ZW50RGVmYXVsdCAoZSk7XG4gICAgICAgICAgICBpZiAoYnJvd3Nlci5pZTliZWxvdykge1xuICAgICAgICAgICAgICAgIHZhciBpZVJhbmdlO1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGllUmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0TmF0aXZlKCkuY3JlYXRlUmFuZ2UoKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGllUmFuZ2UuaXRlbSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcmFuZ2UgPSBuZXcgZG9tLlJhbmdlIChtZS5kb2N1bWVudCk7XG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLnNlbGVjdE5vZGUgKGllUmFuZ2UuaXRlbSAoMCkpLnNlbGVjdCAodHJ1ZSAsIHRydWUpO1xuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICBtZS5hZGRMaXN0ZW5lciAoJ2tleWRvd24nICwgZnVuY3Rpb24gKHR5cGUpIHtcbiAgICAgICAgaWYgKHR5cGUgPT0gXCJrZXlkb3duXCIpIHtcbiAgICAgICAgICAgIG1lbnUgJiYgIW1lbnUuaXNIaWRkZW4gJiYgbWVudS5oaWRlICgpO1xuICAgICAgICB9XG5cbiAgICB9KTtcblxufTtcblxuXG5cblxuLy8gcGx1Z2lucy9iYXNlc3R5bGUuanNcbi8qKlxyXG4gKiBC44CBSeOAgXN1YuOAgXN1cGVy5ZG95Luk5pSv5oyBXHJcbiAqIEBmaWxlXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqL1xyXG5cclxuVUUucGx1Z2luc1snYmFzZXN0eWxlJ10gPSBmdW5jdGlvbigpe1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5a2X5L2T5Yqg57KXXHJcbiAgICAgKiBAY29tbWFuZCBib2xkXHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAgICAgKiBAcmVtaW5kIOWvueW3suWKoOeyl+eahOaWh+acrOWGheWuueaJp+ihjOivpeWRveS7pO+8jCDlsIblj5bmtojliqDnspdcclxuICAgICAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiAvL2VkaXRvcuaYr+e8lui+keWZqOWunuS+i1xyXG4gICAgICogLy/lr7nlvZPliY3pgInkuK3nmoTmlofmnKzlhoXlrrnmiafooYzliqDnspfmk43kvZxcclxuICAgICAqIC8v56ys5LiA5qyh5omn6KGM77yMIOaWh+acrOWGheWuueWKoOeyl1xyXG4gICAgICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnYm9sZCcgKTtcclxuICAgICAqXHJcbiAgICAgKiAvL+esrOS6jOasoeaJp+ihjO+8jCDmlofmnKzlhoXlrrnlj5bmtojliqDnspdcclxuICAgICAqIGVkaXRvci5leGVjQ29tbWFuZCggJ2JvbGQnICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG5cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWtl+S9k+WAvuaWnFxyXG4gICAgICogQGNvbW1hbmQgaXRhbGljXHJcbiAgICAgKiBAbWV0aG9kIGV4ZWNDb21tYW5kXHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAgICAgKiBAcmVtaW5kIOWvueW3suWAvuaWnOeahOaWh+acrOWGheWuueaJp+ihjOivpeWRveS7pO+8jCDlsIblj5bmtojlgL7mlpxcclxuICAgICAqIEBleGFtcGxlXHJcbiAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgKiAvL2VkaXRvcuaYr+e8lui+keWZqOWunuS+i1xyXG4gICAgICogLy/lr7nlvZPliY3pgInkuK3nmoTmlofmnKzlhoXlrrnmiafooYzmlpzkvZPmk43kvZxcclxuICAgICAqIC8v56ys5LiA5qyh5pON5L2c77yMIOaWh+acrOWGheWuueWwhuWPmOaIkOaWnOS9k1xyXG4gICAgICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnaXRhbGljJyApO1xyXG4gICAgICpcclxuICAgICAqIC8v5YaN5qyh5a+55ZCM5LiA5paH5pys5YaF5a655omn6KGM77yMIOWImeaWh+acrOWGheWuueWwhuaBouWkjeato+W4uFxyXG4gICAgICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnaXRhbGljJyApO1xyXG4gICAgICogYGBgXHJcbiAgICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIOS4i+agh+aWh+acrO+8jOS4juKAnHN1cGVyc2NyaXB04oCd5ZG95Luk5LqS5palXHJcbiAgICAgKiBAY29tbWFuZCBzdWJzY3JpcHRcclxuICAgICAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICAgICAqIEByZW1pbmQgIOaKiumAieS4reeahOaWh+acrOWGheWuueWIh+aNouaIkOS4i+agh+aWh+acrO+8jCDlpoLmnpzlvZPliY3pgInkuK3nmoTmlofmnKzlt7Lnu4/mmK/kuIvmoIfvvIwg5YiZ6K+l5pON5L2c5Lya5oqK5paH5pys5YaF5a656L+Y5Y6f5oiQ5q2j5bi45paH5pysXHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogLy9lZGl0b3LmmK/nvJbovpHlmajlrp7kvotcclxuICAgICAqIC8v5a+55b2T5YmN6YCJ5Lit55qE5paH5pys5YaF5a655omn6KGM5LiL5qCH5pON5L2cXHJcbiAgICAgKiAvL+esrOS4gOasoeaTjeS9nO+8jCDmlofmnKzlhoXlrrnlsIblj5jmiJDkuIvmoIfmlofmnKxcclxuICAgICAqIGVkaXRvci5leGVjQ29tbWFuZCggJ3N1YnNjcmlwdCcgKTtcclxuICAgICAqXHJcbiAgICAgKiAvL+WGjeasoeWvueWQjOS4gOaWh+acrOWGheWuueaJp+ihjO+8jCDliJnmlofmnKzlhoXlrrnlsIbmgaLlpI3mraPluLhcclxuICAgICAqIGVkaXRvci5leGVjQ29tbWFuZCggJ3N1YnNjcmlwdCcgKTtcclxuICAgICAqIGBgYFxyXG4gICAgICovXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDkuIrmoIfmlofmnKzvvIzkuI7igJxzdWJzY3JpcHTigJ3lkb3ku6TkupLmlqVcclxuICAgICAqIEBjb21tYW5kIHN1cGVyc2NyaXB0XHJcbiAgICAgKiBAbWV0aG9kIGV4ZWNDb21tYW5kXHJcbiAgICAgKiBAcmVtaW5kIOaKiumAieS4reeahOaWh+acrOWGheWuueWIh+aNouaIkOS4iuagh+aWh+acrO+8jCDlpoLmnpzlvZPliY3pgInkuK3nmoTmlofmnKzlt7Lnu4/mmK/kuIrmoIfvvIwg5YiZ6K+l5pON5L2c5Lya5oqK5paH5pys5YaF5a656L+Y5Y6f5oiQ5q2j5bi45paH5pysXHJcbiAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXHJcbiAgICAgKiBAZXhhbXBsZVxyXG4gICAgICogYGBgamF2YXNjcmlwdFxyXG4gICAgICogLy9lZGl0b3LmmK/nvJbovpHlmajlrp7kvotcclxuICAgICAqIC8v5a+55b2T5YmN6YCJ5Lit55qE5paH5pys5YaF5a655omn6KGM5LiK5qCH5pON5L2cXHJcbiAgICAgKiAvL+esrOS4gOasoeaTjeS9nO+8jCDmlofmnKzlhoXlrrnlsIblj5jmiJDkuIrmoIfmlofmnKxcclxuICAgICAqIGVkaXRvci5leGVjQ29tbWFuZCggJ3N1cGVyc2NyaXB0JyApO1xyXG4gICAgICpcclxuICAgICAqIC8v5YaN5qyh5a+55ZCM5LiA5paH5pys5YaF5a655omn6KGM77yMIOWImeaWh+acrOWGheWuueWwhuaBouWkjeato+W4uFxyXG4gICAgICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnc3VwZXJzY3JpcHQnICk7XHJcbiAgICAgKiBgYGBcclxuICAgICAqL1xyXG4gICAgdmFyIGJhc2VzdHlsZXMgPSB7XHJcbiAgICAgICAgICAgICdib2xkJzpbJ3N0cm9uZycsJ2InXSxcclxuICAgICAgICAgICAgJ2l0YWxpYyc6WydlbScsJ2knXSxcclxuICAgICAgICAgICAgJ3N1YnNjcmlwdCc6WydzdWInXSxcclxuICAgICAgICAgICAgJ3N1cGVyc2NyaXB0JzpbJ3N1cCddXHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRPYmogPSBmdW5jdGlvbihlZGl0b3IsdGFnTmFtZXMpe1xyXG4gICAgICAgICAgICByZXR1cm4gZG9tVXRpbHMuZmlsdGVyTm9kZUxpc3QoZWRpdG9yLnNlbGVjdGlvbi5nZXRTdGFydEVsZW1lbnRQYXRoKCksdGFnTmFtZXMpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbWUgPSB0aGlzO1xyXG4gICAgLy/mt7vliqDlv6vmjbfplK5cclxuICAgIG1lLmFkZHNob3J0Y3V0a2V5KHtcclxuICAgICAgICBcIkJvbGRcIiA6IFwiY3RybCs2NlwiLC8vXkJcclxuICAgICAgICBcIkl0YWxpY1wiIDogXCJjdHJsKzczXCIsIC8vXklcclxuICAgICAgICBcIlVuZGVybGluZVwiIDogXCJjdHJsKzg1XCIvL15VXHJcbiAgICB9KTtcclxuICAgIG1lLmFkZElucHV0UnVsZShmdW5jdGlvbihyb290KXtcclxuICAgICAgICB1dGlscy5lYWNoKHJvb3QuZ2V0Tm9kZXNCeVRhZ05hbWUoJ2IgaScpLGZ1bmN0aW9uKG5vZGUpe1xyXG4gICAgICAgICAgICBzd2l0Y2ggKG5vZGUudGFnTmFtZSl7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdiJzpcclxuICAgICAgICAgICAgICAgICAgICBub2RlLnRhZ05hbWUgPSAnc3Ryb25nJztcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ2knOlxyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUudGFnTmFtZSA9ICdlbSc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgZm9yICggdmFyIHN0eWxlIGluIGJhc2VzdHlsZXMgKSB7XHJcbiAgICAgICAgKGZ1bmN0aW9uKCBjbWQsIHRhZ05hbWVzICkge1xyXG4gICAgICAgICAgICBtZS5jb21tYW5kc1tjbWRdID0ge1xyXG4gICAgICAgICAgICAgICAgZXhlY0NvbW1hbmQgOiBmdW5jdGlvbiggY21kTmFtZSApIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxvYmogPSBnZXRPYmoodGhpcyx0YWdOYW1lcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCByYW5nZS5jb2xsYXBzZWQgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggb2JqICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRtcFRleHQgPSAgbWUuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UuaW5zZXJ0Tm9kZSggdG1wVGV4dCApLnJlbW92ZUlubGluZVN0eWxlKCB0YWdOYW1lcyApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnRCZWZvcmUodG1wVGV4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUodG1wVGV4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wTm9kZSA9IHJhbmdlLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIHRhZ05hbWVzWzBdICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihjbWROYW1lID09ICdzdXBlcnNjcmlwdCcgfHwgY21kTmFtZSA9PSAnc3Vic2NyaXB0Jyl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wVGV4dCA9IG1lLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCcnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5pbnNlcnROb2RlKHRtcFRleHQpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZW1vdmVJbmxpbmVTdHlsZShbJ3N1YicsJ3N1cCddKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc2V0U3RhcnRCZWZvcmUodG1wVGV4dClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNvbGxhcHNlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UuaW5zZXJ0Tm9kZSggdG1wTm9kZSApLnNldFN0YXJ0KCB0bXBOb2RlLCAwICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UuY29sbGFwc2UoIHRydWUgKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihjbWROYW1lID09ICdzdXBlcnNjcmlwdCcgfHwgY21kTmFtZSA9PSAnc3Vic2NyaXB0Jyl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighb2JqIHx8IG9iai50YWdOYW1lLnRvTG93ZXJDYXNlKCkgIT0gY21kTmFtZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UucmVtb3ZlSW5saW5lU3R5bGUoWydzdWInLCdzdXAnXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgb2JqID8gcmFuZ2UucmVtb3ZlSW5saW5lU3R5bGUoIHRhZ05hbWVzICkgOiByYW5nZS5hcHBseUlubGluZVN0eWxlKCB0YWdOYW1lc1swXSApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByYW5nZS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZSA6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldE9iaih0aGlzLHRhZ05hbWVzKSA/IDEgOiAwO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0pKCBzdHlsZSwgYmFzZXN0eWxlc1tzdHlsZV0gKTtcclxuICAgIH1cclxufTtcclxuXHJcblxuXG4vLyBwbHVnaW5zL2VsZW1lbnRwYXRoLmpzXG4vKipcclxuICog6YCJ5Y+W6Lev5b6E5ZG95LukXHJcbiAqIEBmaWxlXHJcbiAqL1xyXG5VRS5wbHVnaW5zWydlbGVtZW50cGF0aCddID0gZnVuY3Rpb24oKXtcclxuICAgIHZhciBjdXJyZW50TGV2ZWwsXHJcbiAgICAgICAgdGFnTmFtZXMsXHJcbiAgICAgICAgbWUgPSB0aGlzO1xyXG4gICAgbWUuc2V0T3B0KCdlbGVtZW50UGF0aEVuYWJsZWQnLHRydWUpO1xyXG4gICAgaWYoIW1lLm9wdGlvbnMuZWxlbWVudFBhdGhFbmFibGVkKXtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBtZS5jb21tYW5kc1snZWxlbWVudHBhdGgnXSA9IHtcclxuICAgICAgICBleGVjQ29tbWFuZCA6IGZ1bmN0aW9uKCBjbWROYW1lLCBsZXZlbCApIHtcclxuICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGFnTmFtZXNbbGV2ZWxdLFxyXG4gICAgICAgICAgICAgICAgcmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuICAgICAgICAgICAgY3VycmVudExldmVsID0gbGV2ZWwqMTtcclxuICAgICAgICAgICAgcmFuZ2Uuc2VsZWN0Tm9kZShzdGFydCkuc2VsZWN0KCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBxdWVyeUNvbW1hbmRWYWx1ZSA6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAvL+S6p+eUn+S4gOS4quWJr+acrO+8jOS4jeiDveS/ruaUueWOn+adpeeahHN0YXJ0RWxlbWVudFBhdGg7XHJcbiAgICAgICAgICAgIHZhciBwYXJlbnRzID0gW10uY29uY2F0KHRoaXMuc2VsZWN0aW9uLmdldFN0YXJ0RWxlbWVudFBhdGgoKSkucmV2ZXJzZSgpLFxyXG4gICAgICAgICAgICAgICAgbmFtZXMgPSBbXTtcclxuICAgICAgICAgICAgdGFnTmFtZXMgPSBwYXJlbnRzO1xyXG4gICAgICAgICAgICBmb3IodmFyIGk9MCxjaTtjaT1wYXJlbnRzW2ldO2krKyl7XHJcbiAgICAgICAgICAgICAgICBpZihjaS5ub2RlVHlwZSA9PSAzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IGNpLnRhZ05hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgICAgIGlmKG5hbWUgPT0gJ2ltZycgJiYgY2kuZ2V0QXR0cmlidXRlKCdhbmNob3JuYW1lJykpe1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWUgPSAnYW5jaG9yJztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIG5hbWVzW2ldID0gbmFtZTtcclxuICAgICAgICAgICAgICAgIGlmKGN1cnJlbnRMZXZlbCA9PSBpKXtcclxuICAgICAgICAgICAgICAgICAgIGN1cnJlbnRMZXZlbCA9IC0xO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBuYW1lcztcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59O1xyXG5cclxuXG5cbi8vIHBsdWdpbnMvZm9ybWF0bWF0Y2guanNcbi8qKlxuICog5qC85byP5Yi377yM5Y+q5qC85byPaW5saW5l55qEXG4gKiBAZmlsZVxuICogQHNpbmNlIDEuMi42LjFcbiAqL1xuXG4vKipcbiAqIOagvOW8j+WIt1xuICogQGNvbW1hbmQgZm9ybWF0bWF0Y2hcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcbiAqIEByZW1pbmQg6K+l5pON5L2c5LiN6IO95aSN5Yi25q616JC95qC85byPXG4gKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXG4gKiBAZXhhbXBsZVxuICogYGBgamF2YXNjcmlwdFxuICogLy9lZGl0b3LmmK/nvJbovpHlmajlrp7kvotcbiAqIC8v6I635Y+W5qC85byP5Yi3XG4gKiBlZGl0b3IuZXhlY0NvbW1hbmQoICdmb3JtYXRtYXRjaCcgKTtcbiAqIGBgYFxuICovXG5VRS5wbHVnaW5zWydmb3JtYXRtYXRjaCddID0gZnVuY3Rpb24oKXtcblxuICAgIHZhciBtZSA9IHRoaXMsXG4gICAgICAgIGxpc3QgPSBbXSxpbWcsXG4gICAgICAgIGZsYWcgPSAwO1xuXG4gICAgIG1lLmFkZExpc3RlbmVyKCdyZXNldCcsZnVuY3Rpb24oKXtcbiAgICAgICAgIGxpc3QgPSBbXTtcbiAgICAgICAgIGZsYWcgPSAwO1xuICAgICB9KTtcblxuICAgIGZ1bmN0aW9uIGFkZExpc3QodHlwZSxldnQpe1xuICAgICAgICBcbiAgICAgICAgaWYoYnJvd3Nlci53ZWJraXQpe1xuICAgICAgICAgICAgdmFyIHRhcmdldCA9IGV2dC50YXJnZXQudGFnTmFtZSA9PSAnSU1HJyA/IGV2dC50YXJnZXQgOiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gYWRkRm9ybWF0KHJhbmdlKXtcblxuICAgICAgICAgICAgaWYodGV4dCl7XG4gICAgICAgICAgICAgICAgcmFuZ2Uuc2VsZWN0Tm9kZSh0ZXh0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByYW5nZS5hcHBseUlubGluZVN0eWxlKGxpc3RbbGlzdC5sZW5ndGgtMV0udGFnTmFtZSxudWxsLGxpc3QpO1xuXG4gICAgICAgIH1cblxuICAgICAgICBtZS51bmRvTWFuZ2VyICYmIG1lLnVuZG9NYW5nZXIuc2F2ZSgpO1xuXG4gICAgICAgIHZhciByYW5nZSA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxuICAgICAgICAgICAgaW1nVCA9IHRhcmdldCB8fCByYW5nZS5nZXRDbG9zZWROb2RlKCk7XG4gICAgICAgIGlmKGltZyAmJiBpbWdUICYmIGltZ1QudGFnTmFtZSA9PSAnSU1HJyl7XG4gICAgICAgICAgICAvL3RyYWNlOjk2NFxuXG4gICAgICAgICAgICBpbWdULnN0eWxlLmNzc1RleHQgKz0gJztmbG9hdDonICsgKGltZy5zdHlsZS5jc3NGbG9hdCB8fCBpbWcuc3R5bGUuc3R5bGVGbG9hdCB8fCdub25lJykgKyAnO2Rpc3BsYXk6JyArIChpbWcuc3R5bGUuZGlzcGxheXx8J2lubGluZScpO1xuXG4gICAgICAgICAgICBpbWcgPSBudWxsO1xuICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgIGlmKCFpbWcpe1xuICAgICAgICAgICAgICAgIHZhciBjb2xsYXBzZWQgPSByYW5nZS5jb2xsYXBzZWQ7XG4gICAgICAgICAgICAgICAgaWYoY29sbGFwc2VkKXtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSBtZS5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnbWF0Y2gnKTtcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2UuaW5zZXJ0Tm9kZSh0ZXh0KS5zZWxlY3QoKTtcblxuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG1lLl9faGFzRW50ZXJFeGVjQ29tbWFuZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgLy/kuI3og73miopibG9ja+S4iueahOWxnuaAp+W5suaOiVxuICAgICAgICAgICAgICAgIC8vdHJhY2U6MTU1M1xuICAgICAgICAgICAgICAgIHZhciByZW1vdmVGb3JtYXRBdHRyaWJ1dGVzID0gbWUub3B0aW9ucy5yZW1vdmVGb3JtYXRBdHRyaWJ1dGVzO1xuICAgICAgICAgICAgICAgIG1lLm9wdGlvbnMucmVtb3ZlRm9ybWF0QXR0cmlidXRlcyA9ICcnO1xuICAgICAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKCdyZW1vdmVmb3JtYXQnKTtcbiAgICAgICAgICAgICAgICBtZS5vcHRpb25zLnJlbW92ZUZvcm1hdEF0dHJpYnV0ZXMgPSByZW1vdmVGb3JtYXRBdHRyaWJ1dGVzO1xuICAgICAgICAgICAgICAgIG1lLl9faGFzRW50ZXJFeGVjQ29tbWFuZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIC8vdHJhY2U6OTY5XG4gICAgICAgICAgICAgICAgcmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcbiAgICAgICAgICAgICAgICBpZihsaXN0Lmxlbmd0aCl7XG4gICAgICAgICAgICAgICAgICAgIGFkZEZvcm1hdChyYW5nZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmKHRleHQpe1xuICAgICAgICAgICAgICAgICAgICByYW5nZS5zZXRTdGFydEJlZm9yZSh0ZXh0KS5jb2xsYXBzZSh0cnVlKTtcblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByYW5nZS5zZWxlY3QoKTtcbiAgICAgICAgICAgICAgICB0ZXh0ICYmIGRvbVV0aWxzLnJlbW92ZSh0ZXh0KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9XG5cblxuXG5cbiAgICAgICAgbWUudW5kb01hbmdlciAmJiBtZS51bmRvTWFuZ2VyLnNhdmUoKTtcbiAgICAgICAgbWUucmVtb3ZlTGlzdGVuZXIoJ21vdXNldXAnLGFkZExpc3QpO1xuICAgICAgICBmbGFnID0gMDtcbiAgICB9XG5cbiAgICBtZS5jb21tYW5kc1snZm9ybWF0bWF0Y2gnXSA9IHtcbiAgICAgICAgZXhlY0NvbW1hbmQgOiBmdW5jdGlvbiggY21kTmFtZSApIHtcbiAgICAgICAgICBcbiAgICAgICAgICAgIGlmKGZsYWcpe1xuICAgICAgICAgICAgICAgIGZsYWcgPSAwO1xuICAgICAgICAgICAgICAgIGxpc3QgPSBbXTtcbiAgICAgICAgICAgICAgICAgbWUucmVtb3ZlTGlzdGVuZXIoJ21vdXNldXAnLGFkZExpc3QpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICAgIFxuICAgICAgICAgICAgdmFyIHJhbmdlID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCk7XG4gICAgICAgICAgICBpbWcgPSByYW5nZS5nZXRDbG9zZWROb2RlKCk7XG4gICAgICAgICAgICBpZighaW1nIHx8IGltZy50YWdOYW1lICE9ICdJTUcnKXtcbiAgICAgICAgICAgICAgIHJhbmdlLmNvbGxhcHNlKHRydWUpLnNocmlua0JvdW5kYXJ5KCk7XG4gICAgICAgICAgICAgICB2YXIgc3RhcnQgPSByYW5nZS5zdGFydENvbnRhaW5lcjtcbiAgICAgICAgICAgICAgIGxpc3QgPSBkb21VdGlscy5maW5kUGFyZW50cyhzdGFydCx0cnVlLGZ1bmN0aW9uKG5vZGUpe1xuICAgICAgICAgICAgICAgICAgIHJldHVybiAhZG9tVXRpbHMuaXNCbG9ja0VsbShub2RlKSAmJiBub2RlLm5vZGVUeXBlID09IDE7XG4gICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgIC8vYeS4jeiDveWKoOWFpeagvOW8j+WItywg5bm25LiU5YWL6ZqG6IqC54K5XG4gICAgICAgICAgICAgICBmb3IodmFyIGk9MCxjaTtjaT1saXN0W2ldO2krKyl7XG4gICAgICAgICAgICAgICAgICAgaWYoY2kudGFnTmFtZSA9PSAnQScpe1xuICAgICAgICAgICAgICAgICAgICAgICBsaXN0LnNwbGljZShpLDEpO1xuICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbWUuYWRkTGlzdGVuZXIoJ21vdXNldXAnLGFkZExpc3QpO1xuICAgICAgICAgICAgZmxhZyA9IDE7XG5cblxuICAgICAgICB9LFxuICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZSA6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgcmV0dXJuIGZsYWc7XG4gICAgICAgIH0sXG4gICAgICAgIG5vdE5lZWRVbmRvIDogMVxuICAgIH07XG59O1xuXG5cblxuLy8gcGx1Z2lucy9zZWFyY2hyZXBsYWNlLmpzXG4vLy9pbXBvcnQgY29yZVxyXG4vLy9jb21tYW5kcyDmn6Xmib7mm7/mjaJcclxuLy8vY29tbWFuZHNOYW1lICBTZWFyY2hSZXBsYWNlXHJcbi8vL2NvbW1hbmRzVGl0bGUgIOafpeivouabv+aNolxyXG4vLy9jb21tYW5kc0RpYWxvZyAgZGlhbG9nc1xcc2VhcmNocmVwbGFjZVxyXG4vKipcclxuICogQGRlc2NyaXB0aW9uIOafpeaJvuabv+aNolxyXG4gKiBAYXV0aG9yIHpoYW55aVxyXG4gKi9cclxuXHJcblVFLnBsdWdpbi5yZWdpc3Rlcignc2VhcmNocmVwbGFjZScsZnVuY3Rpb24oKXtcclxuICAgIHZhciBtZSA9IHRoaXM7XHJcblxyXG4gICAgdmFyIF9ibG9ja0VsbSA9IHsndGFibGUnOjEsJ3Rib2R5JzoxLCd0cic6MSwnb2wnOjEsJ3VsJzoxfTtcclxuXHJcbiAgICBmdW5jdGlvbiBmaW5kVGV4dEluU3RyaW5nKHRleHRDb250ZW50LG9wdCxjdXJyZW50SW5kZXgpe1xyXG4gICAgICAgIHZhciBzdHIgPSBvcHQuc2VhcmNoU3RyO1xyXG4gICAgICAgIGlmKG9wdC5kaXIgPT0gLTEpe1xyXG4gICAgICAgICAgICB0ZXh0Q29udGVudCA9IHRleHRDb250ZW50LnNwbGl0KCcnKS5yZXZlcnNlKCkuam9pbignJyk7XHJcbiAgICAgICAgICAgIHN0ciA9IHN0ci5zcGxpdCgnJykucmV2ZXJzZSgpLmpvaW4oJycpO1xyXG4gICAgICAgICAgICBjdXJyZW50SW5kZXggPSB0ZXh0Q29udGVudC5sZW5ndGggLSBjdXJyZW50SW5kZXg7XHJcblxyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgcmVnID0gbmV3IFJlZ0V4cChzdHIsJ2cnICsgKG9wdC5jYXNlc2Vuc2l0aXZlID8gJycgOiAnaScpKSxtYXRjaDtcclxuXHJcbiAgICAgICAgd2hpbGUobWF0Y2ggPSByZWcuZXhlYyh0ZXh0Q29udGVudCkpe1xyXG4gICAgICAgICAgICBpZihtYXRjaC5pbmRleCA+PSBjdXJyZW50SW5kZXgpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9wdC5kaXIgPT0gLTEgPyB0ZXh0Q29udGVudC5sZW5ndGggLSBtYXRjaC5pbmRleCAtIG9wdC5zZWFyY2hTdHIubGVuZ3RoIDogbWF0Y2guaW5kZXg7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuICAtMVxyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gZmluZFRleHRCbG9ja0VsbShub2RlLGN1cnJlbnRJbmRleCxvcHQpe1xyXG4gICAgICAgIHZhciB0ZXh0Q29udGVudCxpbmRleCxtZXRob2ROYW1lID0gb3B0LmFsbCB8fCBvcHQuZGlyID09IDEgPyAnZ2V0TmV4dERvbU5vZGUnIDogJ2dldFByZURvbU5vZGUnO1xyXG4gICAgICAgIGlmKGRvbVV0aWxzLmlzQm9keShub2RlKSl7XHJcbiAgICAgICAgICAgIG5vZGUgPSBub2RlLmZpcnN0Q2hpbGQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBmaXJzdCA9IDE7XHJcbiAgICAgICAgd2hpbGUobm9kZSl7XHJcbiAgICAgICAgICAgIHRleHRDb250ZW50ID0gbm9kZS5ub2RlVHlwZSA9PSAzID8gbm9kZS5ub2RlVmFsdWUgOiBub2RlW2Jyb3dzZXIuaWUgPyAnaW5uZXJUZXh0JyA6ICd0ZXh0Q29udGVudCddO1xyXG4gICAgICAgICAgICBpbmRleCA9IGZpbmRUZXh0SW5TdHJpbmcodGV4dENvbnRlbnQsb3B0LGN1cnJlbnRJbmRleCApO1xyXG4gICAgICAgICAgICBmaXJzdCA9IDA7XHJcbiAgICAgICAgICAgIGlmKGluZGV4IT0tMSl7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgICdub2RlJzpub2RlLFxyXG4gICAgICAgICAgICAgICAgICAgICdpbmRleCc6aW5kZXhcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBub2RlID0gZG9tVXRpbHNbbWV0aG9kTmFtZV0obm9kZSk7XHJcbiAgICAgICAgICAgIHdoaWxlKG5vZGUgJiYgX2Jsb2NrRWxtW25vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKV0pe1xyXG4gICAgICAgICAgICAgICAgbm9kZSA9IGRvbVV0aWxzW21ldGhvZE5hbWVdKG5vZGUsdHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYobm9kZSl7XHJcbiAgICAgICAgICAgICAgICBjdXJyZW50SW5kZXggPSBvcHQuZGlyID09IC0xID8gKG5vZGUubm9kZVR5cGUgPT0gMyA/IG5vZGUubm9kZVZhbHVlIDogbm9kZVticm93c2VyLmllID8gJ2lubmVyVGV4dCcgOiAndGV4dENvbnRlbnQnXSkubGVuZ3RoIDogMDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiBmaW5kTlRleHRJbkJsb2NrRWxtKG5vZGUsaW5kZXgsc3RyKXtcclxuICAgICAgICB2YXIgY3VycmVudEluZGV4ID0gMCxcclxuICAgICAgICAgICAgY3VycmVudE5vZGUgPSBub2RlLmZpcnN0Q2hpbGQsXHJcbiAgICAgICAgICAgIGN1cnJlbnROb2RlTGVuZ3RoID0gMCxcclxuICAgICAgICAgICAgcmVzdWx0O1xyXG4gICAgICAgIHdoaWxlKGN1cnJlbnROb2RlKXtcclxuICAgICAgICAgICAgaWYoY3VycmVudE5vZGUubm9kZVR5cGUgPT0gMyl7XHJcbiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZUxlbmd0aCA9IGN1cnJlbnROb2RlLm5vZGVWYWx1ZS5yZXBsYWNlKC8oXltcXHRcXHJcXG5dKyl8KFtcXHRcXHJcXG5dKyQpLywnJykubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgY3VycmVudEluZGV4ICs9IGN1cnJlbnROb2RlTGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgaWYoY3VycmVudEluZGV4ID49IGluZGV4KXtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAnbm9kZSc6Y3VycmVudE5vZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICdpbmRleCc6IGN1cnJlbnROb2RlTGVuZ3RoIC0gKGN1cnJlbnRJbmRleCAtIGluZGV4KVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfWVsc2UgaWYoIWR0ZC4kZW1wdHlbY3VycmVudE5vZGUudGFnTmFtZV0pe1xyXG4gICAgICAgICAgICAgICAgY3VycmVudE5vZGVMZW5ndGggPSBjdXJyZW50Tm9kZVticm93c2VyLmllID8gJ2lubmVyVGV4dCcgOiAndGV4dENvbnRlbnQnXS5yZXBsYWNlKC8oXltcXHRcXHJcXG5dKyl8KFtcXHRcXHJcXG5dKyQpLywnJykubGVuZ3RoXHJcbiAgICAgICAgICAgICAgICBjdXJyZW50SW5kZXggKz0gY3VycmVudE5vZGVMZW5ndGg7XHJcbiAgICAgICAgICAgICAgICBpZihjdXJyZW50SW5kZXggPj0gaW5kZXgpe1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpbmROVGV4dEluQmxvY2tFbG0oY3VycmVudE5vZGUsY3VycmVudE5vZGVMZW5ndGggLSAoY3VycmVudEluZGV4IC0gaW5kZXgpLHN0cik7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYocmVzdWx0KXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY3VycmVudE5vZGUgPSBkb21VdGlscy5nZXROZXh0RG9tTm9kZShjdXJyZW50Tm9kZSk7XHJcblxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzZWFyY2hSZXBsYWNlKG1lLG9wdCl7XHJcblxyXG4gICAgICAgIHZhciBybmcgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxcclxuICAgICAgICAgICAgc3RhcnRCbG9ja05vZGUsXHJcbiAgICAgICAgICAgIHNlYXJjaFN0ciA9IG9wdC5zZWFyY2hTdHIsXHJcbiAgICAgICAgICAgIHNwYW4gPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XHJcbiAgICAgICAgc3Bhbi5pbm5lckhUTUwgPSAnJCR1ZWRpdG9yX3NlYXJjaHJlcGxhY2Vfa2V5JCQnO1xyXG5cclxuICAgICAgICBybmcuc2hyaW5rQm91bmRhcnkodHJ1ZSk7XHJcblxyXG4gICAgICAgIC8v5Yik5pat5piv5LiN5piv56ys5LiA5qyh6YCJ5LitXHJcbiAgICAgICAgaWYoIXJuZy5jb2xsYXBzZWQpe1xyXG4gICAgICAgICAgICBybmcuc2VsZWN0KCk7XHJcbiAgICAgICAgICAgIHZhciBybmdUZXh0ID0gbWUuc2VsZWN0aW9uLmdldFRleHQoKTtcclxuICAgICAgICAgICAgaWYobmV3IFJlZ0V4cCgnXicgKyBvcHQuc2VhcmNoU3RyICsgJyQnLChvcHQuY2FzZXNlbnNpdGl2ZSA/ICcnIDogJ2knKSkudGVzdChybmdUZXh0KSl7XHJcbiAgICAgICAgICAgICAgICBpZihvcHQucmVwbGFjZVN0ciAhPSB1bmRlZmluZWQpe1xyXG4gICAgICAgICAgICAgICAgICAgIHJlcGxhY2VUZXh0KHJuZyxvcHQucmVwbGFjZVN0cik7XHJcbiAgICAgICAgICAgICAgICAgICAgcm5nLnNlbGVjdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgcm5nLmNvbGxhcHNlKG9wdC5kaXIgPT0gLTEpXHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgcm5nLmluc2VydE5vZGUoc3Bhbik7XHJcbiAgICAgICAgcm5nLmVubGFyZ2VUb0Jsb2NrRWxtKHRydWUpO1xyXG4gICAgICAgIHN0YXJ0QmxvY2tOb2RlID0gcm5nLnN0YXJ0Q29udGFpbmVyO1xyXG4gICAgICAgIHZhciBjdXJyZW50SW5kZXggPSBzdGFydEJsb2NrTm9kZVticm93c2VyLmllID8gJ2lubmVyVGV4dCcgOiAndGV4dENvbnRlbnQnXS5pbmRleE9mKCckJHVlZGl0b3Jfc2VhcmNocmVwbGFjZV9rZXkkJCcpO1xyXG4gICAgICAgIHJuZy5zZXRTdGFydEJlZm9yZShzcGFuKTtcclxuICAgICAgICBkb21VdGlscy5yZW1vdmUoc3Bhbik7XHJcbiAgICAgICAgdmFyIHJlc3VsdCA9IGZpbmRUZXh0QmxvY2tFbG0oc3RhcnRCbG9ja05vZGUsY3VycmVudEluZGV4LG9wdCk7XHJcbiAgICAgICAgaWYocmVzdWx0KXtcclxuICAgICAgICAgICAgdmFyIHJuZ1N0YXJ0ID0gZmluZE5UZXh0SW5CbG9ja0VsbShyZXN1bHQubm9kZSxyZXN1bHQuaW5kZXgsc2VhcmNoU3RyKTtcclxuICAgICAgICAgICAgdmFyIHJuZ0VuZCA9IGZpbmROVGV4dEluQmxvY2tFbG0ocmVzdWx0Lm5vZGUscmVzdWx0LmluZGV4ICsgc2VhcmNoU3RyLmxlbmd0aCxzZWFyY2hTdHIpO1xyXG4gICAgICAgICAgICBybmcuc2V0U3RhcnQocm5nU3RhcnQubm9kZSxybmdTdGFydC5pbmRleCkuc2V0RW5kKHJuZ0VuZC5ub2RlLHJuZ0VuZC5pbmRleCk7XHJcblxyXG4gICAgICAgICAgICBpZihvcHQucmVwbGFjZVN0ciAhPT0gdW5kZWZpbmVkKXtcclxuICAgICAgICAgICAgICAgIHJlcGxhY2VUZXh0KHJuZyxvcHQucmVwbGFjZVN0cilcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBybmcuc2VsZWN0KCk7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICBybmcuc2V0Q3Vyc29yKClcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gcmVwbGFjZVRleHQocm5nLHN0cil7XHJcblxyXG4gICAgICAgIHN0ciA9IG1lLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHN0cik7XHJcbiAgICAgICAgcm5nLmRlbGV0ZUNvbnRlbnRzKCkuaW5zZXJ0Tm9kZShzdHIpO1xyXG5cclxuICAgIH1cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgY29tbWFuZHM6e1xyXG4gICAgICAgICAgICAnc2VhcmNocmVwbGFjZSc6e1xyXG4gICAgICAgICAgICAgICAgZXhlY0NvbW1hbmQ6ZnVuY3Rpb24oY21kTmFtZSxvcHQpe1xyXG4gICAgICAgICAgICAgICAgICAgIHV0aWxzLmV4dGVuZChvcHQse1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhbGwgOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZXNlbnNpdGl2ZSA6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXIgOiAxXHJcbiAgICAgICAgICAgICAgICAgICAgfSx0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbnVtID0gMDtcclxuICAgICAgICAgICAgICAgICAgICBpZihvcHQuYWxsKXtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBybmcgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0ID0gbWUuYm9keS5maXJzdENoaWxkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihmaXJzdCAmJiBmaXJzdC5ub2RlVHlwZSA9PSAxKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJuZy5zZXRTdGFydChmaXJzdCwwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJuZy5zaHJpbmtCb3VuZGFyeSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYoZmlyc3Qubm9kZVR5cGUgPT0gMyl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBybmcuc2V0U3RhcnRCZWZvcmUoZmlyc3QpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcm5nLmNvbGxhcHNlKHRydWUpLnNlbGVjdCh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYob3B0LnJlcGxhY2VTdHIgIT09IHVuZGVmaW5lZCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NhdmVTY2VuZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKHNlYXJjaFJlcGxhY2UodGhpcyxvcHQpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bSsrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG51bSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NhdmVTY2VuZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG9wdC5yZXBsYWNlU3RyICE9PSB1bmRlZmluZWQpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdzYXZlU2NlbmUnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZihzZWFyY2hSZXBsYWNlKHRoaXMsb3B0KSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW0rK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG51bSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3NhdmVTY2VuZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBub3ROZWVkVW5kbzoxXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0pO1xuXG4vLyBwbHVnaW5zL2N1c3RvbXN0eWxlLmpzXG4vKipcclxuICog6Ieq5a6a5LmJ5qC35byPXHJcbiAqIEBmaWxlXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIOagueaNrmNvbmZpZ+mFjee9ruaWh+S7tumHjOKAnGN1c3RvbXN0eWxl4oCd6YCJ6aG555qE5YC85a+55Yy56YWN55qE5qCH562+5omn6KGM5qC35byP5pu/5o2i44CCXHJcbiAqIEBjb21tYW5kIGN1c3RvbXN0eWxlXHJcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGBqYXZhc2NyaXB0XHJcbiAqIGVkaXRvci5leGVjQ29tbWFuZCggJ2N1c3RvbXN0eWxlJyApO1xyXG4gKiBgYGBcclxuICovXHJcblVFLnBsdWdpbnNbJ2N1c3RvbXN0eWxlJ10gPSBmdW5jdGlvbigpIHtcclxuICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICBtZS5zZXRPcHQoeyAnY3VzdG9tc3R5bGUnOltcclxuICAgICAgICB7dGFnOidoMScsbmFtZTondGMnLCBzdHlsZTonZm9udC1zaXplOjMycHg7Zm9udC13ZWlnaHQ6Ym9sZDtib3JkZXItYm90dG9tOiNjY2MgMnB4IHNvbGlkO3BhZGRpbmc6MCA0cHggMCAwO3RleHQtYWxpZ246Y2VudGVyO21hcmdpbjowIDAgMjBweCAwOyd9LFxyXG4gICAgICAgIHt0YWc6J2gxJyxuYW1lOid0bCcsIHN0eWxlOidmb250LXNpemU6MzJweDtmb250LXdlaWdodDpib2xkO2JvcmRlci1ib3R0b206I2NjYyAycHggc29saWQ7cGFkZGluZzowIDRweCAwIDA7dGV4dC1hbGlnbjpsZWZ0O21hcmdpbjowIDAgMTBweCAwOyd9LFxyXG4gICAgICAgIHt0YWc6J3NwYW4nLG5hbWU6J2ltJywgc3R5bGU6J2ZvbnQtc2l6ZToxNnB4O2ZvbnQtc3R5bGU6aXRhbGljO2ZvbnQtd2VpZ2h0OmJvbGQ7bGluZS1oZWlnaHQ6MThweDsnfSxcclxuICAgICAgICB7dGFnOidzcGFuJyxuYW1lOidoaScsIHN0eWxlOidmb250LXNpemU6MTZweDtmb250LXN0eWxlOml0YWxpYztmb250LXdlaWdodDpib2xkO2NvbG9yOnJnYig1MSwgMTUzLCAyMDQpO2xpbmUtaGVpZ2h0OjE4cHg7J31cclxuICAgIF19KTtcclxuICAgIG1lLmNvbW1hbmRzWydjdXN0b21zdHlsZSddID0ge1xyXG4gICAgICAgIGV4ZWNDb21tYW5kIDogZnVuY3Rpb24oY21kTmFtZSwgb2JqKSB7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSA9IG9iai50YWcsXHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGRvbVV0aWxzLmZpbmRQYXJlbnQobWUuc2VsZWN0aW9uLmdldFN0YXJ0KCksIGZ1bmN0aW9uKG5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuZ2V0QXR0cmlidXRlKCdsYWJlbCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sIHRydWUpLFxyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLGJrLHRtcE9iaiA9IHt9O1xyXG4gICAgICAgICAgICBmb3IgKHZhciBwIGluIG9iaikge1xyXG4gICAgICAgICAgICAgICBpZihvYmpbcF0hPT11bmRlZmluZWQpXHJcbiAgICAgICAgICAgICAgICAgICAgdG1wT2JqW3BdID0gb2JqW3BdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0bXBPYmoudGFnO1xyXG4gICAgICAgICAgICBpZiAobm9kZSAmJiBub2RlLmdldEF0dHJpYnV0ZSgnbGFiZWwnKSA9PSBvYmoubGFiZWwpIHtcclxuICAgICAgICAgICAgICAgIHJhbmdlID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuICAgICAgICAgICAgICAgIGJrID0gcmFuZ2UuY3JlYXRlQm9va21hcmsoKTtcclxuICAgICAgICAgICAgICAgIGlmIChyYW5nZS5jb2xsYXBzZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAvL3RyYWNlOjE3MzIg5Yig5o6J6Ieq5a6a5LmJ5qCH562+77yM6KaB5pyJcOadpeWbnuWhq+ermeS9jVxyXG4gICAgICAgICAgICAgICAgICAgIGlmKGR0ZC4kYmxvY2tbbm9kZS50YWdOYW1lXSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmaWxsTm9kZSA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMubW92ZUNoaWxkKG5vZGUsIGZpbGxOb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShmaWxsTm9kZSwgbm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShub2RlKTtcclxuICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKG5vZGUsdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjb21tb24gPSBkb21VdGlscy5nZXRDb21tb25BbmNlc3Rvcihiay5zdGFydCwgYmsuZW5kKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVzID0gZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoY29tbW9uLCB0YWdOYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBpZihuZXcgUmVnRXhwKHRhZ05hbWUsJ2knKS50ZXN0KGNvbW1vbi50YWdOYW1lKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVzLnB1c2goY29tbW9uKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsbmk7IG5pID0gbm9kZXNbaSsrXTspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5pLmdldEF0dHJpYnV0ZSgnbGFiZWwnKSA9PSBvYmoubGFiZWwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcyA9IGRvbVV0aWxzLmdldFBvc2l0aW9uKG5pLCBiay5zdGFydCkscGUgPSBkb21VdGlscy5nZXRQb3NpdGlvbihuaSwgYmsuZW5kKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgocHMgJiBkb21VdGlscy5QT1NJVElPTl9GT0xMT1dJTkcgfHwgcHMgJiBkb21VdGlscy5QT1NJVElPTl9DT05UQUlOUylcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHBlICYgZG9tVXRpbHMuUE9TSVRJT05fUFJFQ0VESU5HIHx8IHBlICYgZG9tVXRpbHMuUE9TSVRJT05fQ09OVEFJTlMpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZHRkLiRibG9ja1t0YWdOYW1lXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZmlsbE5vZGUgPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLm1vdmVDaGlsZChuaSwgZmlsbE5vZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuaS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShmaWxsTm9kZSwgbmkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShuaSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGRvbVV0aWxzLmZpbmRQYXJlbnQoY29tbW9uLCBmdW5jdGlvbihub2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmdldEF0dHJpYnV0ZSgnbGFiZWwnKSA9PSBvYmoubGFiZWw7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUpIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShub2RlLCB0cnVlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJhbmdlLm1vdmVUb0Jvb2ttYXJrKGJrKS5zZWxlY3QoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChkdGQuJGJsb2NrW3RhZ05hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5leGVjQ29tbWFuZCgncGFyYWdyYXBoJywgdGFnTmFtZSwgdG1wT2JqLCdjdXN0b21zdHlsZScpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFyYW5nZS5jb2xsYXBzZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UuY29sbGFwc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGRvbVV0aWxzLmZpbmRQYXJlbnQobWUuc2VsZWN0aW9uLmdldFN0YXJ0KCksIGZ1bmN0aW9uKG5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmdldEF0dHJpYnV0ZSgnbGFiZWwnKSA9PSBvYmoubGFiZWw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcE5vZGUgPSBtZS5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmluc2VydEFmdGVyKG5vZGUsIHBOb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuZmlsbE5vZGUobWUuZG9jdW1lbnQsIHBOb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQocE5vZGUsIDApLnNldEN1cnNvcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJhbmdlLmNvbGxhcHNlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuc2V0QXR0cmlidXRlcyhub2RlLCB0bXBPYmopO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5pbnNlcnROb2RlKG5vZGUpLnNldFN0YXJ0KG5vZGUsIDApLnNldEN1cnNvcigpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgYmsgPSByYW5nZS5jcmVhdGVCb29rbWFyaygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLmFwcGx5SW5saW5lU3R5bGUodGFnTmFtZSwgdG1wT2JqKS5tb3ZlVG9Cb29rbWFyayhiaykuc2VsZWN0KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSxcclxuICAgICAgICBxdWVyeUNvbW1hbmRWYWx1ZSA6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICB2YXIgcGFyZW50ID0gZG9tVXRpbHMuZmlsdGVyTm9kZUxpc3QoXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGlvbi5nZXRTdGFydEVsZW1lbnRQYXRoKCksXHJcbiAgICAgICAgICAgICAgICBmdW5jdGlvbihub2RlKXtyZXR1cm4gbm9kZS5nZXRBdHRyaWJ1dGUoJ2xhYmVsJyl9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIHJldHVybiAgcGFyZW50ID8gcGFyZW50LmdldEF0dHJpYnV0ZSgnbGFiZWwnKSA6ICcnO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICAvL+W9k+WOu+aOiWN1c3RvbXN0eWxl5piv77yM5aaC5p6c5piv5Z2X5YWD57Sg77yM55SocOS7o+abv1xyXG4gICAgbWUuYWRkTGlzdGVuZXIoJ2tleXVwJywgZnVuY3Rpb24odHlwZSwgZXZ0KSB7XHJcbiAgICAgICAgdmFyIGtleUNvZGUgPSBldnQua2V5Q29kZSB8fCBldnQud2hpY2g7XHJcblxyXG4gICAgICAgIGlmIChrZXlDb2RlID09IDMyIHx8IGtleUNvZGUgPT0gMTMpIHtcclxuICAgICAgICAgICAgdmFyIHJhbmdlID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgICAgIGlmIChyYW5nZS5jb2xsYXBzZWQpIHtcclxuICAgICAgICAgICAgICAgIHZhciBub2RlID0gZG9tVXRpbHMuZmluZFBhcmVudChtZS5zZWxlY3Rpb24uZ2V0U3RhcnQoKSwgZnVuY3Rpb24obm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmdldEF0dHJpYnV0ZSgnbGFiZWwnKTtcclxuICAgICAgICAgICAgICAgIH0sIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKG5vZGUgJiYgZHRkLiRibG9ja1tub2RlLnRhZ05hbWVdICYmIGRvbVV0aWxzLmlzRW1wdHlOb2RlKG5vZGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwID0gbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5pbnNlcnRBZnRlcihub2RlLCBwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuZmlsbE5vZGUobWUuZG9jdW1lbnQsIHApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUobm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KHAsIDApLnNldEN1cnNvcigpO1xyXG5cclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufTtcblxuLy8gcGx1Z2lucy9jYXRjaHJlbW90ZWltYWdlLmpzXG4vLy9pbXBvcnQgY29yZVxyXG4vLy9jb21tYW5kcyDov5znqIvlm77niYfmipPlj5ZcclxuLy8vY29tbWFuZHNOYW1lICBjYXRjaFJlbW90ZUltYWdlLGNhdGNocmVtb3RlaW1hZ2VlbmFibGVcclxuLy8vY29tbWFuZHNUaXRsZSAg6L+c56iL5Zu+54mH5oqT5Y+WXHJcbi8qKlxyXG4gKiDov5znqIvlm77niYfmipPlj5Ys5b2T5byA5ZCv5pys5o+S5Lu25pe25omA5pyJ5LiN56ym5ZCI5pys5Zyw5Z+f5ZCN55qE5Zu+54mH6YO95bCG6KKr5oqT5Y+W5oiQ5Li65pys5Zyw5pyN5Yqh5Zmo5LiK55qE5Zu+54mHXHJcbiAqL1xyXG5VRS5wbHVnaW5zWydjYXRjaHJlbW90ZWltYWdlJ10gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgbWUgPSB0aGlzLFxyXG4gICAgICAgIGFqYXggPSBVRS5hamF4O1xyXG5cclxuICAgIC8qIOiuvue9rum7mOiupOWAvCAqL1xyXG4gICAgaWYgKG1lLm9wdGlvbnMuY2F0Y2hSZW1vdGVJbWFnZUVuYWJsZSA9PT0gZmFsc2UpIHJldHVybjtcclxuICAgIG1lLnNldE9wdCh7XHJcbiAgICAgICAgY2F0Y2hSZW1vdGVJbWFnZUVuYWJsZTogZmFsc2VcclxuICAgIH0pO1xyXG5cclxuICAgIG1lLmFkZExpc3RlbmVyKFwiYWZ0ZXJwYXN0ZVwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgbWUuZmlyZUV2ZW50KFwiY2F0Y2hSZW1vdGVJbWFnZVwiKTtcclxuICAgIH0pO1xyXG5cclxuICAgIG1lLmFkZExpc3RlbmVyKFwiY2F0Y2hSZW1vdGVJbWFnZVwiLCBmdW5jdGlvbiAoKSB7XHJcblxyXG4gICAgICAgIHZhciBjYXRjaGVyTG9jYWxEb21haW4gPSBtZS5nZXRPcHQoJ2NhdGNoZXJMb2NhbERvbWFpbicpLFxyXG4gICAgICAgICAgICBjYXRjaGVyQWN0aW9uVXJsID0gbWUuZ2V0QWN0aW9uVXJsKG1lLmdldE9wdCgnY2F0Y2hlckFjdGlvbk5hbWUnKSksXHJcbiAgICAgICAgICAgIGNhdGNoZXJVcmxQcmVmaXggPSBtZS5nZXRPcHQoJ2NhdGNoZXJVcmxQcmVmaXgnKSxcclxuICAgICAgICAgICAgY2F0Y2hlckZpZWxkTmFtZSA9IG1lLmdldE9wdCgnY2F0Y2hlckZpZWxkTmFtZScpO1xyXG5cclxuICAgICAgICB2YXIgcmVtb3RlSW1hZ2VzID0gW10sXHJcbiAgICAgICAgICAgIGltZ3MgPSBkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZShtZS5kb2N1bWVudCwgXCJpbWdcIiksXHJcbiAgICAgICAgICAgIHRlc3QgPSBmdW5jdGlvbiAoc3JjLCB1cmxzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3JjLmluZGV4T2YobG9jYXRpb24uaG9zdCkgIT0gLTEgfHwgLyheXFwuKXwoXlxcLykvLnRlc3Qoc3JjKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHVybHMpIHtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgdXJsOyB1cmwgPSB1cmxzW2orK107KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcmMuaW5kZXhPZih1cmwpICE9PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSBpbWdzW2krK107KSB7XHJcbiAgICAgICAgICAgIGlmIChjaS5nZXRBdHRyaWJ1dGUoXCJ3b3JkX2ltZ1wiKSkge1xyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHNyYyA9IGNpLmdldEF0dHJpYnV0ZShcIl9zcmNcIikgfHwgY2kuc3JjIHx8IFwiXCI7XHJcbiAgICAgICAgICAgIGlmICgvXihodHRwcz98ZnRwKTovaS50ZXN0KHNyYykgJiYgIXRlc3Qoc3JjLCBjYXRjaGVyTG9jYWxEb21haW4pKSB7XHJcbiAgICAgICAgICAgICAgICByZW1vdGVJbWFnZXMucHVzaChzcmMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAocmVtb3RlSW1hZ2VzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBjYXRjaHJlbW90ZWltYWdlKHJlbW90ZUltYWdlcywge1xyXG4gICAgICAgICAgICAgICAgLy/miJDlip/mipPlj5ZcclxuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluZm8gPSByLnN0YXRlICE9PSB1bmRlZmluZWQgPyByOmV2YWwoXCIoXCIgKyByLnJlc3BvbnNlVGV4dCArIFwiKVwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8qIOiOt+WPlua6kOi3r+W+hOWSjOaWsOi3r+W+hCAqL1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBpLCBqLCBjaSwgY2osIG9sZFNyYywgbmV3U3JjLCBsaXN0ID0gaW5mby5saXN0O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBjaSA9IGltZ3NbaSsrXTspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2xkU3JjID0gY2kuZ2V0QXR0cmlidXRlKFwiX3NyY1wiKSB8fCBjaS5zcmMgfHwgXCJcIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMDsgY2ogPSBsaXN0W2orK107KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob2xkU3JjID09IGNqLnNvdXJjZSAmJiBjai5zdGF0ZSA9PSBcIlNVQ0NFU1NcIikgeyAgLy/mipPlj5blpLHotKXml7bkuI3lgZrmm7/mjaLlpITnkIZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTcmMgPSBjYXRjaGVyVXJsUHJlZml4ICsgY2oudXJsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnNldEF0dHJpYnV0ZXMoY2ksIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJzcmNcIjogbmV3U3JjLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIl9zcmNcIjogbmV3U3JjXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdjYXRjaHJlbW90ZXN1Y2Nlc3MnKVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIC8v5Zue6LCD5aSx6LSl77yM5pys5qyh6K+35rGC6LaF5pe2XHJcbiAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudChcImNhdGNocmVtb3RlZXJyb3JcIik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZnVuY3Rpb24gY2F0Y2hyZW1vdGVpbWFnZShpbWdzLCBjYWxsYmFja3MpIHtcclxuICAgICAgICAgICAgdmFyIHBhcmFtcyA9IHV0aWxzLnNlcmlhbGl6ZVBhcmFtKG1lLnF1ZXJ5Q29tbWFuZFZhbHVlKCdzZXJ2ZXJwYXJhbScpKSB8fCAnJyxcclxuICAgICAgICAgICAgICAgIHVybCA9IHV0aWxzLmZvcm1hdFVybChjYXRjaGVyQWN0aW9uVXJsICsgKGNhdGNoZXJBY3Rpb25VcmwuaW5kZXhPZignPycpID09IC0xID8gJz8nOicmJykgKyBwYXJhbXMpLFxyXG4gICAgICAgICAgICAgICAgaXNKc29ucCA9IHV0aWxzLmlzQ3Jvc3NEb21haW5VcmwodXJsKSxcclxuICAgICAgICAgICAgICAgIG9wdCA9IHtcclxuICAgICAgICAgICAgICAgICAgICAnbWV0aG9kJzogJ1BPU1QnLFxyXG4gICAgICAgICAgICAgICAgICAgICdkYXRhVHlwZSc6IGlzSnNvbnAgPyAnanNvbnAnOicnLFxyXG4gICAgICAgICAgICAgICAgICAgICd0aW1lb3V0JzogNjAwMDAsIC8v5Y2V5L2N77ya5q+r56eS77yM5Zue6LCD6K+35rGC6LaF5pe26K6+572u44CC55uu5qCH55So5oi35aaC5p6c572R6YCf5LiN5piv5b6I5b+r55qE6K+d5q2k5aSE5bu66K6u6K6+572u5LiA5Liq6L6D5aSn55qE5pWw5YC8XHJcbiAgICAgICAgICAgICAgICAgICAgJ29uc3VjY2Vzcyc6IGNhbGxiYWNrc1tcInN1Y2Nlc3NcIl0sXHJcbiAgICAgICAgICAgICAgICAgICAgJ29uZXJyb3InOiBjYWxsYmFja3NbXCJlcnJvclwiXVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgb3B0W2NhdGNoZXJGaWVsZE5hbWVdID0gaW1ncztcclxuICAgICAgICAgICAgYWpheC5yZXF1ZXN0KHVybCwgb3B0KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfSk7XHJcbn07XG5cbi8vIHBsdWdpbnMvc25hcHNjcmVlbi5qc1xuLyoqXHJcbiAqIOaIquWxj+aPkuS7tu+8jOS4ulVFZGl0b3Lmj5Dkvpvmj5LlhaXmlK/mjIFcclxuICogQGZpbGVcclxuICogQHNpbmNlIDEuNC4yXHJcbiAqL1xyXG5VRS5wbHVnaW4ucmVnaXN0ZXIoJ3NuYXBzY3JlZW4nLCBmdW5jdGlvbiAoKXtcclxuXHJcbiAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgdmFyIHNuYXBwbHVnaW47XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0TG9jYXRpb24odXJsKXtcclxuICAgICAgICB2YXIgc2VhcmNoLFxyXG4gICAgICAgICAgICBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpLFxyXG4gICAgICAgICAgICBwYXJhbXMgPSB1dGlscy5zZXJpYWxpemVQYXJhbShtZS5xdWVyeUNvbW1hbmRWYWx1ZSgnc2VydmVycGFyYW0nKSkgfHwgJyc7XHJcblxyXG4gICAgICAgIGEuaHJlZiA9IHVybDtcclxuICAgICAgICBpZiAoYnJvd3Nlci5pZSkge1xyXG4gICAgICAgICAgICBhLmhyZWYgPSBhLmhyZWY7XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgc2VhcmNoID0gYS5zZWFyY2g7XHJcbiAgICAgICAgaWYgKHBhcmFtcykge1xyXG4gICAgICAgICAgICBzZWFyY2ggPSBzZWFyY2ggKyAoc2VhcmNoLmluZGV4T2YoJz8nKSA9PSAtMSA/ICc/JzonJicpKyBwYXJhbXM7XHJcbiAgICAgICAgICAgIHNlYXJjaCA9IHNlYXJjaC5yZXBsYWNlKC9bJl0rL2lnLCAnJicpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAncG9ydCc6IGEucG9ydCxcclxuICAgICAgICAgICAgJ2hvc3RuYW1lJzogYS5ob3N0bmFtZSxcclxuICAgICAgICAgICAgJ3BhdGgnOiBhLnBhdGhuYW1lICsgc2VhcmNoIHx8ICArIGEuaGFzaFxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGNvbW1hbmRzOntcclxuICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAqIOWtl+S9k+iDjOaZr+minOiJslxyXG4gICAgICAgICAgICAgKiBAY29tbWFuZCBzbmFwc2NyZWVuXHJcbiAgICAgICAgICAgICAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICAgICAgICAgICAgICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxyXG4gICAgICAgICAgICAgKiBAZXhhbXBsZVxyXG4gICAgICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XHJcbiAgICAgICAgICAgICAqIGVkaXRvci5leGVjQ29tbWFuZCgnc25hcHNjcmVlbicpO1xyXG4gICAgICAgICAgICAgKiBgYGBcclxuICAgICAgICAgICAgICovXHJcbiAgICAgICAgICAgICdzbmFwc2NyZWVuJzp7XHJcbiAgICAgICAgICAgICAgICBleGVjQ29tbWFuZDpmdW5jdGlvbiAoY21kKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHVybCwgbG9jYWwsIHJlcztcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbGFuZyA9IG1lLmdldExhbmcoXCJzbmFwU2NyZWVuX3BsdWdpblwiKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYoIXNuYXBwbHVnaW4pe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGFpbmVyID0gbWUuY29udGFpbmVyO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZG9jID0gbWUuY29udGFpbmVyLm93bmVyRG9jdW1lbnQgfHwgbWUuY29udGFpbmVyLmRvY3VtZW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzbmFwcGx1Z2luID0gZG9jLmNyZWF0ZUVsZW1lbnQoXCJvYmplY3RcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyeXtzbmFwcGx1Z2luLnR5cGUgPSBcImFwcGxpY2F0aW9uL3gtcGx1Z2luYmFpZHVzbmFwXCI7fWNhdGNoKGUpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNuYXBwbHVnaW4uc3R5bGUuY3NzVGV4dCA9IFwicG9zaXRpb246YWJzb2x1dGU7bGVmdDotOTk5OXB4O3dpZHRoOjA7aGVpZ2h0OjA7XCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNuYXBwbHVnaW4uc2V0QXR0cmlidXRlKFwid2lkdGhcIixcIjBcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNuYXBwbHVnaW4uc2V0QXR0cmlidXRlKFwiaGVpZ2h0XCIsXCIwXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoc25hcHBsdWdpbik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBvblN1Y2Nlc3MocnMpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0cnl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBycyA9IGV2YWwoXCIoXCIrIHJzICtcIilcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihycy5zdGF0ZSA9PSAnU1VDQ0VTUycpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcHQgPSBtZS5vcHRpb25zO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKCdpbnNlcnRpbWFnZScsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjOiBvcHQuc25hcHNjcmVlblVybFByZWZpeCArIHJzLnVybCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3NyYzogb3B0LnNuYXBzY3JlZW5VcmxQcmVmaXggKyBycy51cmwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsdDogcnMudGl0bGUgfHwgJycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0U3R5bGU6IG9wdC5zbmFwc2NyZWVuSW1nQWxpZ25cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQocnMuc3RhdGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGVydChsYW5nLmNhbGxCYWNrRXJyb3JNc2cpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHVybCA9IG1lLmdldEFjdGlvblVybChtZS5nZXRPcHQoJ3NuYXBzY3JlZW5BY3Rpb25OYW1lJykpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxvY2FsID0gZ2V0TG9jYXRpb24odXJsKTtcclxuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5e1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzID1zbmFwcGx1Z2luLnNhdmVTbmFwc2hvdChsb2NhbC5ob3N0bmFtZSwgbG9jYWwucGF0aCwgbG9jYWwucG9ydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1jYXRjaChlKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLnVpLl9kaWFsb2dzWydzbmFwc2NyZWVuRGlhbG9nJ10ub3BlbigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MocmVzKTtcclxuICAgICAgICAgICAgICAgICAgICB9LCA1MCk7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoXCJXaW5kb3dzXCIsMCkgIT0gLTEpID8gMDotMTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufSk7XHJcblxuXG4vLyBwbHVnaW5zL2luc2VydHBhcmFncmFwaC5qc1xuLyoqXHJcbiAqIOaPkuWFpeauteiQvVxyXG4gKiBAZmlsZVxyXG4gKiBAc2luY2UgMS4yLjYuMVxyXG4gKi9cclxuXHJcblxyXG4vKipcclxuICog5o+S5YWl5q616JC9XHJcbiAqIEBjb21tYW5kIGluc2VydHBhcmFncmFwaFxyXG4gKiBAbWV0aG9kIGV4ZWNDb21tYW5kXHJcbiAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcclxuICogQGV4YW1wbGVcclxuICogYGBgamF2YXNjcmlwdFxyXG4gKiAvL2VkaXRvcuaYr+e8lui+keWZqOWunuS+i1xyXG4gKiBlZGl0b3IuZXhlY0NvbW1hbmQoICdpbnNlcnRwYXJhZ3JhcGgnICk7XHJcbiAqIGBgYFxyXG4gKi9cclxuXHJcblVFLmNvbW1hbmRzWydpbnNlcnRwYXJhZ3JhcGgnXSA9IHtcclxuICAgIGV4ZWNDb21tYW5kIDogZnVuY3Rpb24oIGNtZE5hbWUsZnJvbnQpIHtcclxuICAgICAgICB2YXIgbWUgPSB0aGlzLFxyXG4gICAgICAgICAgICByYW5nZSA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxyXG4gICAgICAgICAgICBzdGFydCA9IHJhbmdlLnN0YXJ0Q29udGFpbmVyLHRtcE5vZGU7XHJcbiAgICAgICAgd2hpbGUoc3RhcnQgKXtcclxuICAgICAgICAgICAgaWYoZG9tVXRpbHMuaXNCb2R5KHN0YXJ0KSl7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0bXBOb2RlID0gc3RhcnQ7XHJcbiAgICAgICAgICAgIHN0YXJ0ID0gc3RhcnQucGFyZW50Tm9kZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYodG1wTm9kZSl7XHJcbiAgICAgICAgICAgIHZhciBwID0gbWUuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xyXG4gICAgICAgICAgICBpZihmcm9udCl7XHJcbiAgICAgICAgICAgICAgICB0bXBOb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHAsdG1wTm9kZSlcclxuICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICB0bXBOb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHAsdG1wTm9kZS5uZXh0U2libGluZylcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBkb21VdGlscy5maWxsTm9kZShtZS5kb2N1bWVudCxwKTtcclxuICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQocCwwKS5zZXRDdXJzb3IoZmFsc2UsdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59O1xyXG5cclxuXG5cbi8vIHBsdWdpbnMvd2ViYXBwLmpzXG4vKipcclxuICog55m+5bqm5bqU55SoXHJcbiAqIEBmaWxlXHJcbiAqIEBzaW5jZSAxLjIuNi4xXHJcbiAqL1xyXG5cclxuXHJcbi8qKlxyXG4gKiDmj5LlhaXnmb7luqblupTnlKhcclxuICogQGNvbW1hbmQgd2ViYXBwXHJcbiAqIEBtZXRob2QgZXhlY0NvbW1hbmRcclxuICogQHJlbWluZCDpnIDopoHnmb7luqZBUFBLZXlcclxuICogQHJlbWluZCDnmb7luqblupTnlKjkuLvpobXvvJogPGEgaHJlZj1cImh0dHA6Ly9hcHAuYmFpZHUuY29tL1wiIHRhcmdldD1cIl9ibGFua1wiPmh0dHA6Ly9hcHAuYmFpZHUuY29tLzwvYT5cclxuICogQHBhcmFtIHsgT2JqZWN0IH0gYXBwT3B0aW9ucyDlupTnlKjmiYDpnIDnmoTlj4LmlbDpobnvvIwg5pSv5oyB55qEa2V55pyJ77yaIHRpdGxlPT7lupTnlKjmoIfpopjvvIwgd2lkdGg9PuW6lOeUqOWuueWZqOWuveW6pu+8jFxyXG4gKiBoZWlnaHQ9PuW6lOeUqOWuueWZqOmrmOW6pu+8jGxvZ289PuW6lOeUqGxvZ2/vvIx1cmw9PuW6lOeUqOWcsOWdgFxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGBqYXZhc2NyaXB0XHJcbiAqIC8vZWRpdG9y5piv57yW6L6R5Zmo5a6e5L6LXHJcbiAqIC8v5Zyo57yW6L6R5Zmo6YeM5o+S5YWl5LiA5Liq4oCc5qSN54mp5aSn5oiY5YO15bC44oCd55qEQVBQXHJcbiAqIGVkaXRvci5leGVjQ29tbWFuZCggJ3dlYmFwcCcgLCB7XHJcbiAqICAgICB0aXRsZTogJ+akjeeJqeWkp+aImOWDteWwuCcsXHJcbiAqICAgICB3aWR0aDogNTYwLFxyXG4gKiAgICAgaGVpZ2h0OiA0NjUsXHJcbiAqICAgICBsb2dvOiAn5bqU55So5bGV56S655qE5Zu+54mHJyxcclxuICogICAgIHVybDogJ+eZvuW6puW6lOeUqOeahOWcsOWdgCdcclxuICogfSApO1xyXG4gKiBgYGBcclxuICovXHJcblxyXG4vL1VFLnBsdWdpbnNbJ3dlYmFwcCddID0gZnVuY3Rpb24gKCkge1xyXG4vLyAgICB2YXIgbWUgPSB0aGlzO1xyXG4vLyAgICBmdW5jdGlvbiBjcmVhdGVJbnNlcnRTdHIoIG9iaiwgdG9JZnJhbWUsIGFkZFBhcmFncmFwaCApIHtcclxuLy8gICAgICAgIHJldHVybiAhdG9JZnJhbWUgP1xyXG4vLyAgICAgICAgICAgICAgICAoYWRkUGFyYWdyYXBoID8gJzxwPicgOiAnJykgKyAnPGltZyB0aXRsZT1cIicrb2JqLnRpdGxlKydcIiB3aWR0aD1cIicgKyBvYmoud2lkdGggKyAnXCIgaGVpZ2h0PVwiJyArIG9iai5oZWlnaHQgKyAnXCInICtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICAnIHNyYz1cIicgKyBtZS5vcHRpb25zLlVFRElUT1JfSE9NRV9VUkwgKyAndGhlbWVzL2RlZmF1bHQvaW1hZ2VzL3NwYWNlci5naWZcIiBzdHlsZT1cImJhY2tncm91bmQ6dXJsKCcgKyBvYmoubG9nbysnKSBuby1yZXBlYXQgY2VudGVyIGNlbnRlcjsgYm9yZGVyOjFweCBzb2xpZCBncmF5O1wiIGNsYXNzPVwiZWR1aS1mYWtlZC13ZWJhcHBcIiBfdXJsPVwiJyArIG9iai51cmwgKyAnXCIgLz4nICtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICAoYWRkUGFyYWdyYXBoID8gJzwvcD4nIDogJycpXHJcbi8vICAgICAgICAgICAgICAgIDpcclxuLy8gICAgICAgICAgICAgICAgJzxpZnJhbWUgY2xhc3M9XCJlZHVpLWZha2VkLXdlYmFwcFwiIHRpdGxlPVwiJytvYmoudGl0bGUrJ1wiIHdpZHRoPVwiJyArIG9iai53aWR0aCArICdcIiBoZWlnaHQ9XCInICsgb2JqLmhlaWdodCArICdcIiAgc2Nyb2xsaW5nPVwibm9cIiBmcmFtZWJvcmRlcj1cIjBcIiBzcmM9XCInICsgb2JqLnVybCArICdcIiBsb2dvX3VybCA9ICcrb2JqLmxvZ28rJz48L2lmcmFtZT4nO1xyXG4vLyAgICB9XHJcbi8vXHJcbi8vICAgIGZ1bmN0aW9uIHN3aXRjaEltZ0FuZElmcmFtZSggaW1nMmZyYW1lICkge1xyXG4vLyAgICAgICAgdmFyIHRtcGRpdixcclxuLy8gICAgICAgICAgICAgICAgbm9kZXMgPSBkb21VdGlscy5nZXRFbGVtZW50c0J5VGFnTmFtZSggbWUuZG9jdW1lbnQsICFpbWcyZnJhbWUgPyBcImlmcmFtZVwiIDogXCJpbWdcIiApO1xyXG4vLyAgICAgICAgZm9yICggdmFyIGkgPSAwLCBub2RlOyBub2RlID0gbm9kZXNbaSsrXTsgKSB7XHJcbi8vICAgICAgICAgICAgaWYgKCBub2RlLmNsYXNzTmFtZSAhPSBcImVkdWktZmFrZWQtd2ViYXBwXCIgKXtcclxuLy8gICAgICAgICAgICAgICAgY29udGludWU7XHJcbi8vICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgICAgIHRtcGRpdiA9IG1lLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIFwiZGl2XCIgKTtcclxuLy8gICAgICAgICAgICB0bXBkaXYuaW5uZXJIVE1MID0gY3JlYXRlSW5zZXJ0U3RyKCBpbWcyZnJhbWUgPyB7dXJsOm5vZGUuZ2V0QXR0cmlidXRlKCBcIl91cmxcIiApLCB3aWR0aDpub2RlLndpZHRoLCBoZWlnaHQ6bm9kZS5oZWlnaHQsdGl0bGU6bm9kZS50aXRsZSxsb2dvOm5vZGUuc3R5bGUuYmFja2dyb3VuZEltYWdlLnJlcGxhY2UoXCJ1cmwoXCIsXCJcIikucmVwbGFjZShcIilcIixcIlwiKX0gOiB7dXJsOm5vZGUuZ2V0QXR0cmlidXRlKCBcInNyY1wiLCAyICksdGl0bGU6bm9kZS50aXRsZSwgd2lkdGg6bm9kZS53aWR0aCwgaGVpZ2h0Om5vZGUuaGVpZ2h0LGxvZ286bm9kZS5nZXRBdHRyaWJ1dGUoXCJsb2dvX3VybFwiKX0sIGltZzJmcmFtZSA/IHRydWUgOiBmYWxzZSxmYWxzZSApO1xyXG4vLyAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoIHRtcGRpdi5maXJzdENoaWxkLCBub2RlICk7XHJcbi8vICAgICAgICB9XHJcbi8vICAgIH1cclxuLy9cclxuLy8gICAgbWUuYWRkTGlzdGVuZXIoIFwiYmVmb3JlZ2V0Y29udGVudFwiLCBmdW5jdGlvbiAoKSB7XHJcbi8vICAgICAgICBzd2l0Y2hJbWdBbmRJZnJhbWUoIHRydWUgKTtcclxuLy8gICAgfSApO1xyXG4vLyAgICBtZS5hZGRMaXN0ZW5lciggJ2FmdGVyc2V0Y29udGVudCcsIGZ1bmN0aW9uICgpIHtcclxuLy8gICAgICAgIHN3aXRjaEltZ0FuZElmcmFtZSggZmFsc2UgKTtcclxuLy8gICAgfSApO1xyXG4vLyAgICBtZS5hZGRMaXN0ZW5lciggJ2FmdGVyZ2V0Y29udGVudCcsIGZ1bmN0aW9uICggY21kTmFtZSApIHtcclxuLy8gICAgICAgIGlmICggY21kTmFtZSA9PSAnYWZ0ZXJnZXRjb250ZW50JyAmJiBtZS5xdWVyeUNvbW1hbmRTdGF0ZSggJ3NvdXJjZScgKSApe1xyXG4vLyAgICAgICAgICAgIHJldHVybjtcclxuLy8gICAgICAgIH1cclxuLy8gICAgICAgIHN3aXRjaEltZ0FuZElmcmFtZSggZmFsc2UgKTtcclxuLy8gICAgfSApO1xyXG4vL1xyXG4vLyAgICBtZS5jb21tYW5kc1snd2ViYXBwJ10gPSB7XHJcbi8vICAgICAgICBleGVjQ29tbWFuZDpmdW5jdGlvbiAoIGNtZCwgb2JqICkge1xyXG4vLyAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKCBcImluc2VydGh0bWxcIiwgY3JlYXRlSW5zZXJ0U3RyKCBvYmosIGZhbHNlLHRydWUgKSApO1xyXG4vLyAgICAgICAgfVxyXG4vLyAgICB9O1xyXG4vL307XHJcblxyXG5VRS5wbHVnaW4ucmVnaXN0ZXIoJ3dlYmFwcCcsIGZ1bmN0aW9uICgpe1xyXG4gICAgdmFyIG1lID0gdGhpcztcclxuICAgIGZ1bmN0aW9uIGNyZWF0ZUluc2VydFN0cihvYmosdG9FbWJlZCl7XHJcbiAgICAgICAgcmV0dXJuICAhdG9FbWJlZCA/XHJcbiAgICAgICAgICAgICc8aW1nIHRpdGxlPVwiJytvYmoudGl0bGUrJ1wiIHdpZHRoPVwiJyArIG9iai53aWR0aCArICdcIiBoZWlnaHQ9XCInICsgb2JqLmhlaWdodCArICdcIicgK1xyXG4gICAgICAgICAgICAgICAgJyBzcmM9XCInICsgbWUub3B0aW9ucy5VRURJVE9SX0hPTUVfVVJMICsgJ3RoZW1lcy9kZWZhdWx0L2ltYWdlcy9zcGFjZXIuZ2lmXCIgX2xvZ29fdXJsPVwiJytvYmoubG9nbysnXCIgc3R5bGU9XCJiYWNrZ3JvdW5kOnVybCgnICsgb2JqLmxvZ29cclxuICAgICAgICAgICAgICAgICsnKSBuby1yZXBlYXQgY2VudGVyIGNlbnRlcjsgYm9yZGVyOjFweCBzb2xpZCBncmF5O1wiIGNsYXNzPVwiZWR1aS1mYWtlZC13ZWJhcHBcIiBfdXJsPVwiJyArIG9iai51cmwgKyAnXCIgJyArXHJcbiAgICAgICAgICAgICAgICAob2JqLmFsaWduICYmICFvYmouY3NzZmxvYXQ/ICdhbGlnbj1cIicgKyBvYmouYWxpZ24gKyAnXCInIDogJycpICtcclxuICAgICAgICAgICAgICAgIChvYmouY3NzZmxvYXQgPyAnc3R5bGU9XCJmbG9hdDonICsgb2JqLmNzc2Zsb2F0ICsgJ1wiJyA6ICcnKSArXHJcbiAgICAgICAgICAgICAgICAnLz4nXHJcbiAgICAgICAgICAgIDpcclxuICAgICAgICAgICAgJzxpZnJhbWUgY2xhc3M9XCJlZHVpLWZha2VkLXdlYmFwcFwiIHRpdGxlPVwiJytvYmoudGl0bGUrJ1wiICcgK1xyXG4gICAgICAgICAgICAgICAgKG9iai5hbGlnbiAmJiAhb2JqLmNzc2Zsb2F0PyAnYWxpZ249XCInICsgb2JqLmFsaWduICsgJ1wiJyA6ICcnKSArXHJcbiAgICAgICAgICAgICAgICAob2JqLmNzc2Zsb2F0ID8gJ3N0eWxlPVwiZmxvYXQ6JyArIG9iai5jc3NmbG9hdCArICdcIicgOiAnJykgK1xyXG4gICAgICAgICAgICAgICAgJ3dpZHRoPVwiJyArIG9iai53aWR0aCArICdcIiBoZWlnaHQ9XCInICsgb2JqLmhlaWdodCArICdcIiAgc2Nyb2xsaW5nPVwibm9cIiBmcmFtZWJvcmRlcj1cIjBcIiBzcmM9XCInICsgb2JqLnVybCArICdcIiBsb2dvX3VybCA9IFwiJytvYmoubG9nbysnXCI+PC9pZnJhbWU+J1xyXG5cclxuICAgIH1cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgb3V0cHV0UnVsZTogZnVuY3Rpb24ocm9vdCl7XHJcbiAgICAgICAgICAgIHV0aWxzLmVhY2gocm9vdC5nZXROb2Rlc0J5VGFnTmFtZSgnaW1nJyksZnVuY3Rpb24obm9kZSl7XHJcbiAgICAgICAgICAgICAgICB2YXIgaHRtbDtcclxuICAgICAgICAgICAgICAgIGlmKG5vZGUuZ2V0QXR0cignY2xhc3MnKSA9PSAnZWR1aS1mYWtlZC13ZWJhcHAnKXtcclxuICAgICAgICAgICAgICAgICAgICBodG1sID0gIGNyZWF0ZUluc2VydFN0cih7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOm5vZGUuZ2V0QXR0cigndGl0bGUnKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgJ3dpZHRoJzpub2RlLmdldEF0dHIoJ3dpZHRoJyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICdoZWlnaHQnOm5vZGUuZ2V0QXR0cignaGVpZ2h0JyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICdhbGlnbic6bm9kZS5nZXRBdHRyKCdhbGlnbicpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAnY3NzZmxvYXQnOm5vZGUuZ2V0U3R5bGUoJ2Zsb2F0JyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICd1cmwnOm5vZGUuZ2V0QXR0cihcIl91cmxcIiksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICdsb2dvJzpub2RlLmdldEF0dHIoJ19sb2dvX3VybCcpXHJcbiAgICAgICAgICAgICAgICAgICAgfSx0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZW1iZWQgPSBVRS51Tm9kZS5jcmVhdGVFbGVtZW50KGh0bWwpO1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoZW1iZWQsbm9kZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSxcclxuICAgICAgICBpbnB1dFJ1bGU6ZnVuY3Rpb24ocm9vdCl7XHJcbiAgICAgICAgICAgIHV0aWxzLmVhY2gocm9vdC5nZXROb2Rlc0J5VGFnTmFtZSgnaWZyYW1lJyksZnVuY3Rpb24obm9kZSl7XHJcbiAgICAgICAgICAgICAgICBpZihub2RlLmdldEF0dHIoJ2NsYXNzJykgPT0gJ2VkdWktZmFrZWQtd2ViYXBwJyl7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGltZyA9IFVFLnVOb2RlLmNyZWF0ZUVsZW1lbnQoY3JlYXRlSW5zZXJ0U3RyKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6bm9kZS5nZXRBdHRyKCd0aXRsZScpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAnd2lkdGgnOm5vZGUuZ2V0QXR0cignd2lkdGgnKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCc6bm9kZS5nZXRBdHRyKCdoZWlnaHQnKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgJ2FsaWduJzpub2RlLmdldEF0dHIoJ2FsaWduJyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICdjc3NmbG9hdCc6bm9kZS5nZXRTdHlsZSgnZmxvYXQnKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgJ3VybCc6bm9kZS5nZXRBdHRyKFwic3JjXCIpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAnbG9nbyc6bm9kZS5nZXRBdHRyKCdsb2dvX3VybCcpXHJcbiAgICAgICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoaW1nLG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG5cclxuICAgICAgICB9LFxyXG4gICAgICAgIGNvbW1hbmRzOntcclxuICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAqIOaPkuWFpeeZvuW6puW6lOeUqFxyXG4gICAgICAgICAgICAgKiBAY29tbWFuZCB3ZWJhcHBcclxuICAgICAgICAgICAgICogQG1ldGhvZCBleGVjQ29tbWFuZFxyXG4gICAgICAgICAgICAgKiBAcmVtaW5kIOmcgOimgeeZvuW6pkFQUEtleVxyXG4gICAgICAgICAgICAgKiBAcmVtaW5kIOeZvuW6puW6lOeUqOS4u+mhte+8miA8YSBocmVmPVwiaHR0cDovL2FwcC5iYWlkdS5jb20vXCIgdGFyZ2V0PVwiX2JsYW5rXCI+aHR0cDovL2FwcC5iYWlkdS5jb20vPC9hPlxyXG4gICAgICAgICAgICAgKiBAcGFyYW0geyBPYmplY3QgfSBhcHBPcHRpb25zIOW6lOeUqOaJgOmcgOeahOWPguaVsOmhue+8jCDmlK/mjIHnmoRrZXnmnInvvJogdGl0bGU9PuW6lOeUqOagh+mimO+8jCB3aWR0aD0+5bqU55So5a655Zmo5a695bqm77yMXHJcbiAgICAgICAgICAgICAqIGhlaWdodD0+5bqU55So5a655Zmo6auY5bqm77yMbG9nbz0+5bqU55SobG9nb++8jHVybD0+5bqU55So5Zyw5Z2AXHJcbiAgICAgICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgICAgICogLy9lZGl0b3LmmK/nvJbovpHlmajlrp7kvotcclxuICAgICAgICAgICAgICogLy/lnKjnvJbovpHlmajph4zmj5LlhaXkuIDkuKrigJzmpI3nianlpKfmiJjlg7XlsLjigJ3nmoRBUFBcclxuICAgICAgICAgICAgICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnd2ViYXBwJyAsIHtcclxuICAgICAgICAgICAgICogICAgIHRpdGxlOiAn5qSN54mp5aSn5oiY5YO15bC4JyxcclxuICAgICAgICAgICAgICogICAgIHdpZHRoOiA1NjAsXHJcbiAgICAgICAgICAgICAqICAgICBoZWlnaHQ6IDQ2NSxcclxuICAgICAgICAgICAgICogICAgIGxvZ286ICflupTnlKjlsZXnpLrnmoTlm77niYcnLFxyXG4gICAgICAgICAgICAgKiAgICAgdXJsOiAn55m+5bqm5bqU55So55qE5Zyw5Z2AJ1xyXG4gICAgICAgICAgICAgKiB9ICk7XHJcbiAgICAgICAgICAgICAqIGBgYFxyXG4gICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgJ3dlYmFwcCc6e1xyXG4gICAgICAgICAgICAgICAgZXhlY0NvbW1hbmQ6ZnVuY3Rpb24gKGNtZCwgb2JqKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0ciA9IGNyZWF0ZUluc2VydFN0cih1dGlscy5leHRlbmQob2JqLHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsaWduOidub25lJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKFwiaW5zZXJ0aHRtbFwiLHN0cik7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGltZyA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLmdldENsb3NlZE5vZGUoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmxhZyA9IGltZyAmJiAoaW1nLmNsYXNzTmFtZSA9PSBcImVkdWktZmFrZWQtd2ViYXBwXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmbGFnID8gMSA6IDA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0pO1xuXG4vLyBwbHVnaW5zL3RlbXBsYXRlLmpzXG4vLy9pbXBvcnQgY29yZVxyXG4vLy9pbXBvcnQgcGx1Z2luc1xcaW5zZXJ0aHRtbC5qc1xyXG4vLy9pbXBvcnQgcGx1Z2luc1xcY2xlYXJkb2MuanNcclxuLy8vY29tbWFuZHMg5qih5p2/XHJcbi8vL2NvbW1hbmRzTmFtZSAgdGVtcGxhdGVcclxuLy8vY29tbWFuZHNUaXRsZSAg5qih5p2/XHJcbi8vL2NvbW1hbmRzRGlhbG9nICBkaWFsb2dzXFx0ZW1wbGF0ZVxyXG5VRS5wbHVnaW5zWyd0ZW1wbGF0ZSddID0gZnVuY3Rpb24gKCkge1xyXG4gICAgVUUuY29tbWFuZHNbJ3RlbXBsYXRlJ10gPSB7XHJcbiAgICAgICAgZXhlY0NvbW1hbmQ6ZnVuY3Rpb24gKGNtZCwgb2JqKSB7XHJcbiAgICAgICAgICAgIG9iai5odG1sICYmIHRoaXMuZXhlY0NvbW1hbmQoXCJpbnNlcnRodG1sXCIsIG9iai5odG1sKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgdGhpcy5hZGRMaXN0ZW5lcihcImNsaWNrXCIsIGZ1bmN0aW9uICh0eXBlLCBldnQpIHtcclxuICAgICAgICB2YXIgZWwgPSBldnQudGFyZ2V0IHx8IGV2dC5zcmNFbGVtZW50LFxyXG4gICAgICAgICAgICByYW5nZSA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCk7XHJcbiAgICAgICAgdmFyIHRub2RlID0gZG9tVXRpbHMuZmluZFBhcmVudChlbCwgZnVuY3Rpb24gKG5vZGUpIHtcclxuICAgICAgICAgICAgaWYgKG5vZGUuY2xhc3NOYW1lICYmIGRvbVV0aWxzLmhhc0NsYXNzKG5vZGUsIFwidWVfdFwiKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LCB0cnVlKTtcclxuICAgICAgICB0bm9kZSAmJiByYW5nZS5zZWxlY3ROb2RlKHRub2RlKS5zaHJpbmtCb3VuZGFyeSgpLnNlbGVjdCgpO1xyXG4gICAgfSk7XHJcbiAgICB0aGlzLmFkZExpc3RlbmVyKFwia2V5ZG93blwiLCBmdW5jdGlvbiAodHlwZSwgZXZ0KSB7XHJcbiAgICAgICAgdmFyIHJhbmdlID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcclxuICAgICAgICBpZiAoIXJhbmdlLmNvbGxhcHNlZCkge1xyXG4gICAgICAgICAgICBpZiAoIWV2dC5jdHJsS2V5ICYmICFldnQubWV0YUtleSAmJiAhZXZ0LnNoaWZ0S2V5ICYmICFldnQuYWx0S2V5KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdG5vZGUgPSBkb21VdGlscy5maW5kUGFyZW50KHJhbmdlLnN0YXJ0Q29udGFpbmVyLCBmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChub2RlLmNsYXNzTmFtZSAmJiBkb21VdGlscy5oYXNDbGFzcyhub2RlLCBcInVlX3RcIikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAodG5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmVDbGFzc2VzKHRub2RlLCBbXCJ1ZV90XCJdKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59O1xyXG5cblxuLy8gcGx1Z2lucy9tdXNpYy5qc1xuLyoqXHJcbiAqIOaPkuWFpemfs+S5kOWRveS7pFxyXG4gKiBAZmlsZVxyXG4gKi9cclxuVUUucGx1Z2luLnJlZ2lzdGVyKCdtdXNpYycsIGZ1bmN0aW9uICgpe1xyXG4gICAgdmFyIG1lID0gdGhpcztcclxuICAgIGZ1bmN0aW9uIGNyZWF0SW5zZXJ0U3RyKHVybCx3aWR0aCxoZWlnaHQsYWxpZ24sY3NzZmxvYXQsdG9FbWJlZCl7XHJcbiAgICAgICAgcmV0dXJuICAhdG9FbWJlZCA/XHJcbiAgICAgICAgICAgICAgICAnPGltZyAnICtcclxuICAgICAgICAgICAgICAgICAgICAoYWxpZ24gJiYgIWNzc2Zsb2F0PyAnYWxpZ249XCInICsgYWxpZ24gKyAnXCInIDogJycpICtcclxuICAgICAgICAgICAgICAgICAgICAoY3NzZmxvYXQgPyAnc3R5bGU9XCJmbG9hdDonICsgY3NzZmxvYXQgKyAnXCInIDogJycpICtcclxuICAgICAgICAgICAgICAgICAgICAnIHdpZHRoPVwiJysgd2lkdGggKydcIiBoZWlnaHQ9XCInICsgaGVpZ2h0ICsgJ1wiIF91cmw9XCInK3VybCsnXCIgY2xhc3M9XCJlZHVpLWZha2VkLW11c2ljXCInICtcclxuICAgICAgICAgICAgICAgICAgICAnIHNyYz1cIicrbWUub3B0aW9ucy5sYW5nUGF0aCttZS5vcHRpb25zLmxhbmcrJy9pbWFnZXMvbXVzaWMucG5nXCIgLz4nXHJcbiAgICAgICAgICAgIDpcclxuICAgICAgICAgICAgJzxlbWJlZCB0eXBlPVwiYXBwbGljYXRpb24veC1zaG9ja3dhdmUtZmxhc2hcIiBjbGFzcz1cImVkdWktZmFrZWQtbXVzaWNcIiBwbHVnaW5zcGFnZT1cImh0dHA6Ly93d3cubWFjcm9tZWRpYS5jb20vZ28vZ2V0Zmxhc2hwbGF5ZXJcIicgK1xyXG4gICAgICAgICAgICAgICAgJyBzcmM9XCInICsgdXJsICsgJ1wiIHdpZHRoPVwiJyArIHdpZHRoICArICdcIiBoZWlnaHQ9XCInICsgaGVpZ2h0ICArICdcIiAnKyAoYWxpZ24gJiYgIWNzc2Zsb2F0PyAnYWxpZ249XCInICsgYWxpZ24gKyAnXCInIDogJycpICtcclxuICAgICAgICAgICAgICAgIChjc3NmbG9hdCA/ICdzdHlsZT1cImZsb2F0OicgKyBjc3NmbG9hdCArICdcIicgOiAnJykgK1xyXG4gICAgICAgICAgICAgICAgJyB3bW9kZT1cInRyYW5zcGFyZW50XCIgcGxheT1cInRydWVcIiBsb29wPVwiZmFsc2VcIiBtZW51PVwiZmFsc2VcIiBhbGxvd3NjcmlwdGFjY2Vzcz1cIm5ldmVyXCIgYWxsb3dmdWxsc2NyZWVuPVwidHJ1ZVwiID4nO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBvdXRwdXRSdWxlOiBmdW5jdGlvbihyb290KXtcclxuICAgICAgICAgICAgdXRpbHMuZWFjaChyb290LmdldE5vZGVzQnlUYWdOYW1lKCdpbWcnKSxmdW5jdGlvbihub2RlKXtcclxuICAgICAgICAgICAgICAgIHZhciBodG1sO1xyXG4gICAgICAgICAgICAgICAgaWYobm9kZS5nZXRBdHRyKCdjbGFzcycpID09ICdlZHVpLWZha2VkLW11c2ljJyl7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNzc2Zsb2F0ID0gbm9kZS5nZXRTdHlsZSgnZmxvYXQnKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYWxpZ24gPSBub2RlLmdldEF0dHIoJ2FsaWduJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaHRtbCA9ICBjcmVhdEluc2VydFN0cihub2RlLmdldEF0dHIoXCJfdXJsXCIpLCBub2RlLmdldEF0dHIoJ3dpZHRoJyksIG5vZGUuZ2V0QXR0cignaGVpZ2h0JyksIGFsaWduLCBjc3NmbG9hdCwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGVtYmVkID0gVUUudU5vZGUuY3JlYXRlRWxlbWVudChodG1sKTtcclxuICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKGVtYmVkLG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgaW5wdXRSdWxlOmZ1bmN0aW9uKHJvb3Qpe1xyXG4gICAgICAgICAgICB1dGlscy5lYWNoKHJvb3QuZ2V0Tm9kZXNCeVRhZ05hbWUoJ2VtYmVkJyksZnVuY3Rpb24obm9kZSl7XHJcbiAgICAgICAgICAgICAgICBpZihub2RlLmdldEF0dHIoJ2NsYXNzJykgPT0gJ2VkdWktZmFrZWQtbXVzaWMnKXtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgY3NzZmxvYXQgPSBub2RlLmdldFN0eWxlKCdmbG9hdCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBhbGlnbiA9IG5vZGUuZ2V0QXR0cignYWxpZ24nKTtcclxuICAgICAgICAgICAgICAgICAgICBodG1sID0gIGNyZWF0SW5zZXJ0U3RyKG5vZGUuZ2V0QXR0cihcInNyY1wiKSwgbm9kZS5nZXRBdHRyKCd3aWR0aCcpLCBub2RlLmdldEF0dHIoJ2hlaWdodCcpLCBhbGlnbiwgY3NzZmxvYXQsZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBpbWcgPSBVRS51Tm9kZS5jcmVhdGVFbGVtZW50KGh0bWwpO1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoaW1nLG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG5cclxuICAgICAgICB9LFxyXG4gICAgICAgIGNvbW1hbmRzOntcclxuICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAqIOaPkuWFpemfs+S5kFxyXG4gICAgICAgICAgICAgKiBAY29tbWFuZCBtdXNpY1xyXG4gICAgICAgICAgICAgKiBAbWV0aG9kIGV4ZWNDb21tYW5kXHJcbiAgICAgICAgICAgICAqIEBwYXJhbSB7IE9iamVjdCB9IG11c2ljT3B0aW9ucyDmj5LlhaXpn7PkuZDnmoTlj4LmlbDpobnvvIwg5pSv5oyB55qEa2V55pyJ77yaIHVybD0+6Z+z5LmQ5Zyw5Z2A77ybXHJcbiAgICAgICAgICAgICAqIHdpZHRoPT7pn7PkuZDlrrnlmajlrr3luqbvvJtoZWlnaHQ9Pumfs+S5kOWuueWZqOmrmOW6pu+8m2FsaWduPT7pn7PkuZDmlofku7bnmoTlr7npvZDmlrnlvI/vvIwg5Y+v6YCJ5YC85pyJOiBsZWZ0LCBjZW50ZXIsIHJpZ2h0LCBub25lXHJcbiAgICAgICAgICAgICAqIEBleGFtcGxlXHJcbiAgICAgICAgICAgICAqIGBgYGphdmFzY3JpcHRcclxuICAgICAgICAgICAgICogLy9lZGl0b3LmmK/nvJbovpHlmajlrp7kvotcclxuICAgICAgICAgICAgICogLy/lnKjnvJbovpHlmajph4zmj5LlhaXkuIDkuKrigJzmpI3nianlpKfmiJjlg7XlsLjigJ3nmoRBUFBcclxuICAgICAgICAgICAgICogZWRpdG9yLmV4ZWNDb21tYW5kKCAnbXVzaWMnICwge1xyXG4gICAgICAgICAgICAgKiAgICAgd2lkdGg6IDQwMCxcclxuICAgICAgICAgICAgICogICAgIGhlaWdodDogOTUsXHJcbiAgICAgICAgICAgICAqICAgICBhbGlnbjogXCJjZW50ZXJcIixcclxuICAgICAgICAgICAgICogICAgIHVybDogXCLpn7PkuZDlnLDlnYBcIlxyXG4gICAgICAgICAgICAgKiB9ICk7XHJcbiAgICAgICAgICAgICAqIGBgYFxyXG4gICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgJ211c2ljJzp7XHJcbiAgICAgICAgICAgICAgICBleGVjQ29tbWFuZDpmdW5jdGlvbiAoY21kLCBtdXNpY09iaikge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0ciA9IGNyZWF0SW5zZXJ0U3RyKG11c2ljT2JqLnVybCwgbXVzaWNPYmoud2lkdGggfHwgNDAwLCBtdXNpY09iai5oZWlnaHQgfHwgOTUsIFwibm9uZVwiLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuZXhlY0NvbW1hbmQoXCJpbnNlcnRodG1sXCIsc3RyKTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZTpmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW1nID0gbWUuc2VsZWN0aW9uLmdldFJhbmdlKCkuZ2V0Q2xvc2VkTm9kZSgpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmbGFnID0gaW1nICYmIChpbWcuY2xhc3NOYW1lID09IFwiZWR1aS1mYWtlZC1tdXNpY1wiKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmxhZyA/IDEgOiAwO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59KTtcblxuLy8gcGx1Z2lucy9hdXRvdXBsb2FkLmpzXG4vKipcbiAqIEBkZXNjcmlwdGlvblxuICogMS7mi5bmlL7mlofku7bliLDnvJbovpHljLrln5/vvIzoh6rliqjkuIrkvKDlubbmj5LlhaXliLDpgInljLpcbiAqIDIu5o+S5YWl57KY6LS05p2/55qE5Zu+54mH77yM6Ieq5Yqo5LiK5Lyg5bm25o+S5YWl5Yiw6YCJ5Yy6XG4gKiBAYXV0aG9yIEppbnFuXG4gKiBAZGF0ZSAyMDEzLTEwLTE0XG4gKi9cblVFLnBsdWdpbi5yZWdpc3RlcignYXV0b3VwbG9hZCcsIGZ1bmN0aW9uICgpe1xuXG4gICAgZnVuY3Rpb24gc2VuZEFuZEluc2VydEZpbGUoZmlsZSwgZWRpdG9yKSB7XG4gICAgICAgIHZhciBtZSAgPSBlZGl0b3I7XG4gICAgICAgIC8v5qih5ouf5pWw5o2uXG4gICAgICAgIHZhciBmaWVsZE5hbWUsIHVybFByZWZpeCwgbWF4U2l6ZSwgYWxsb3dGaWxlcywgYWN0aW9uVXJsLFxuICAgICAgICAgICAgbG9hZGluZ0h0bWwsIGVycm9ySGFuZGxlciwgc3VjY2Vzc0hhbmRsZXIsXG4gICAgICAgICAgICBmaWxldHlwZSA9IC9pbWFnZVxcL1xcdysvaS50ZXN0KGZpbGUudHlwZSkgPyAnaW1hZ2UnOidmaWxlJyxcbiAgICAgICAgICAgIGxvYWRpbmdJZCA9ICdsb2FkaW5nXycgKyAoK25ldyBEYXRlKCkpLnRvU3RyaW5nKDM2KTtcblxuICAgICAgICBmaWVsZE5hbWUgPSBtZS5nZXRPcHQoZmlsZXR5cGUgKyAnRmllbGROYW1lJyk7XG4gICAgICAgIHVybFByZWZpeCA9IG1lLmdldE9wdChmaWxldHlwZSArICdVcmxQcmVmaXgnKTtcbiAgICAgICAgbWF4U2l6ZSA9IG1lLmdldE9wdChmaWxldHlwZSArICdNYXhTaXplJyk7XG4gICAgICAgIGFsbG93RmlsZXMgPSBtZS5nZXRPcHQoZmlsZXR5cGUgKyAnQWxsb3dGaWxlcycpO1xuICAgICAgICBhY3Rpb25VcmwgPSBtZS5nZXRBY3Rpb25VcmwobWUuZ2V0T3B0KGZpbGV0eXBlICsgJ0FjdGlvbk5hbWUnKSk7XG4gICAgICAgIGVycm9ySGFuZGxlciA9IGZ1bmN0aW9uKHRpdGxlKSB7XG4gICAgICAgICAgICB2YXIgbG9hZGVyID0gbWUuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobG9hZGluZ0lkKTtcbiAgICAgICAgICAgIGxvYWRlciAmJiBkb21VdGlscy5yZW1vdmUobG9hZGVyKTtcbiAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnc2hvd21lc3NhZ2UnLCB7XG4gICAgICAgICAgICAgICAgJ2lkJzogbG9hZGluZ0lkLFxuICAgICAgICAgICAgICAgICdjb250ZW50JzogdGl0bGUsXG4gICAgICAgICAgICAgICAgJ3R5cGUnOiAnZXJyb3InLFxuICAgICAgICAgICAgICAgICd0aW1lb3V0JzogNDAwMFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGZpbGV0eXBlID09ICdpbWFnZScpIHtcbiAgICAgICAgICAgIGxvYWRpbmdIdG1sID0gJzxpbWcgY2xhc3M9XCJsb2FkaW5nY2xhc3NcIiBpZD1cIicgKyBsb2FkaW5nSWQgKyAnXCIgc3JjPVwiJyArXG4gICAgICAgICAgICAgICAgbWUub3B0aW9ucy50aGVtZVBhdGggKyBtZS5vcHRpb25zLnRoZW1lICtcbiAgICAgICAgICAgICAgICAnL2ltYWdlcy9zcGFjZXIuZ2lmXCIgdGl0bGU9XCInICsgKG1lLmdldExhbmcoJ2F1dG91cGxvYWQubG9hZGluZycpIHx8ICcnKSArICdcIiA+JztcbiAgICAgICAgICAgIHN1Y2Nlc3NIYW5kbGVyID0gZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgIHZhciBsaW5rID0gdXJsUHJlZml4ICsgZGF0YS51cmwsXG4gICAgICAgICAgICAgICAgICAgIGxvYWRlciA9IG1lLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGxvYWRpbmdJZCk7XG4gICAgICAgICAgICAgICAgaWYgKGxvYWRlcikge1xuICAgICAgICAgICAgICAgICAgICBsb2FkZXIuc2V0QXR0cmlidXRlKCdzcmMnLCBsaW5rKTtcbiAgICAgICAgICAgICAgICAgICAgbG9hZGVyLnNldEF0dHJpYnV0ZSgnX3NyYycsIGxpbmspO1xuICAgICAgICAgICAgICAgICAgICBsb2FkZXIuc2V0QXR0cmlidXRlKCd0aXRsZScsIGRhdGEudGl0bGUgfHwgJycpO1xuICAgICAgICAgICAgICAgICAgICBsb2FkZXIuc2V0QXR0cmlidXRlKCdhbHQnLCBkYXRhLm9yaWdpbmFsIHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgbG9hZGVyLnJlbW92ZUF0dHJpYnV0ZSgnaWQnKTtcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlQ2xhc3Nlcyhsb2FkZXIsICdsb2FkaW5nY2xhc3MnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9hZGluZ0h0bWwgPSAnPHA+JyArXG4gICAgICAgICAgICAgICAgJzxpbWcgY2xhc3M9XCJsb2FkaW5nY2xhc3NcIiBpZD1cIicgKyBsb2FkaW5nSWQgKyAnXCIgc3JjPVwiJyArXG4gICAgICAgICAgICAgICAgbWUub3B0aW9ucy50aGVtZVBhdGggKyBtZS5vcHRpb25zLnRoZW1lICtcbiAgICAgICAgICAgICAgICAnL2ltYWdlcy9zcGFjZXIuZ2lmXCIgdGl0bGU9XCInICsgKG1lLmdldExhbmcoJ2F1dG91cGxvYWQubG9hZGluZycpIHx8ICcnKSArICdcIiA+JyArXG4gICAgICAgICAgICAgICAgJzwvcD4nO1xuICAgICAgICAgICAgc3VjY2Vzc0hhbmRsZXIgPSBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgICAgdmFyIGxpbmsgPSB1cmxQcmVmaXggKyBkYXRhLnVybCxcbiAgICAgICAgICAgICAgICAgICAgbG9hZGVyID0gbWUuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobG9hZGluZ0lkKTtcblxuICAgICAgICAgICAgICAgIHZhciBybmcgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxcbiAgICAgICAgICAgICAgICAgICAgYmsgPSBybmcuY3JlYXRlQm9va21hcmsoKTtcbiAgICAgICAgICAgICAgICBybmcuc2VsZWN0Tm9kZShsb2FkZXIpLnNlbGVjdCgpO1xuICAgICAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKCdpbnNlcnRmaWxlJywgeyd1cmwnOiBsaW5rfSk7XG4gICAgICAgICAgICAgICAgcm5nLm1vdmVUb0Jvb2ttYXJrKGJrKS5zZWxlY3QoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICAvKiDmj5LlhaVsb2FkaW5n55qE5Y2g5L2N56ymICovXG4gICAgICAgIG1lLmV4ZWNDb21tYW5kKCdpbnNlcnRodG1sJywgbG9hZGluZ0h0bWwpO1xuXG4gICAgICAgIC8qIOWIpOaWreWQjuerr+mFjee9ruaYr+WQpuayoeacieWKoOi9veaIkOWKnyAqL1xuICAgICAgICBpZiAoIW1lLmdldE9wdChmaWxldHlwZSArICdBY3Rpb25OYW1lJykpIHtcbiAgICAgICAgICAgIGVycm9ySGFuZGxlcihtZS5nZXRMYW5nKCdhdXRvdXBsb2FkLmVycm9yTG9hZENvbmZpZycpKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICAvKiDliKTmlq3mlofku7blpKflsI/mmK/lkKbotoXlh7rpmZDliLYgKi9cbiAgICAgICAgaWYoZmlsZS5zaXplID4gbWF4U2l6ZSkge1xuICAgICAgICAgICAgZXJyb3JIYW5kbGVyKG1lLmdldExhbmcoJ2F1dG91cGxvYWQuZXhjZWVkU2l6ZUVycm9yJykpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIC8qIOWIpOaWreaWh+S7tuagvOW8j+aYr+WQpui2heWHuuWFgeiuuCAqL1xuICAgICAgICB2YXIgZmlsZWV4dCA9IGZpbGUubmFtZSA/IGZpbGUubmFtZS5zdWJzdHIoZmlsZS5uYW1lLmxhc3RJbmRleE9mKCcuJykpOicnO1xuICAgICAgICBpZiAoKGZpbGVleHQgJiYgZmlsZXR5cGUgIT0gJ2ltYWdlJykgfHwgKGFsbG93RmlsZXMgJiYgKGFsbG93RmlsZXMuam9pbignJykgKyAnLicpLmluZGV4T2YoZmlsZWV4dC50b0xvd2VyQ2FzZSgpICsgJy4nKSA9PSAtMSkpIHtcbiAgICAgICAgICAgIGVycm9ySGFuZGxlcihtZS5nZXRMYW5nKCdhdXRvdXBsb2FkLmV4Y2VlZFR5cGVFcnJvcicpKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qIOWIm+W7ukFqYXjlubbmj5DkuqQgKi9cbiAgICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpLFxuICAgICAgICAgICAgZmQgPSBuZXcgRm9ybURhdGEoKSxcbiAgICAgICAgICAgIHBhcmFtcyA9IHV0aWxzLnNlcmlhbGl6ZVBhcmFtKG1lLnF1ZXJ5Q29tbWFuZFZhbHVlKCdzZXJ2ZXJwYXJhbScpKSB8fCAnJyxcbiAgICAgICAgICAgIHVybCA9IHV0aWxzLmZvcm1hdFVybChhY3Rpb25VcmwgKyAoYWN0aW9uVXJsLmluZGV4T2YoJz8nKSA9PSAtMSA/ICc/JzonJicpICsgcGFyYW1zKTtcblxuICAgICAgICBmZC5hcHBlbmQoZmllbGROYW1lLCBmaWxlLCBmaWxlLm5hbWUgfHwgKCdibG9iLicgKyBmaWxlLnR5cGUuc3Vic3RyKCdpbWFnZS8nLmxlbmd0aCkpKTtcbiAgICAgICAgZmQuYXBwZW5kKCd0eXBlJywgJ2FqYXgnKTtcbiAgICAgICAgeGhyLm9wZW4oXCJwb3N0XCIsIHVybCwgdHJ1ZSk7XG4gICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKFwiWC1SZXF1ZXN0ZWQtV2l0aFwiLCBcIlhNTEh0dHBSZXF1ZXN0XCIpO1xuICAgICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICB0cnl7XG4gICAgICAgICAgICAgICAgdmFyIGpzb24gPSAobmV3IEZ1bmN0aW9uKFwicmV0dXJuIFwiICsgdXRpbHMudHJpbShlLnRhcmdldC5yZXNwb25zZSkpKSgpO1xuICAgICAgICAgICAgICAgIGlmIChqc29uLnN0YXRlID09ICdTVUNDRVNTJyAmJiBqc29uLnVybCkge1xuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzSGFuZGxlcihqc29uKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBlcnJvckhhbmRsZXIoanNvbi5zdGF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfWNhdGNoKGVyKXtcbiAgICAgICAgICAgICAgICBlcnJvckhhbmRsZXIobWUuZ2V0TGFuZygnYXV0b3VwbG9hZC5sb2FkRXJyb3InKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB4aHIuc2VuZChmZCk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0UGFzdGVJbWFnZShlKXtcbiAgICAgICAgcmV0dXJuIGUuY2xpcGJvYXJkRGF0YSAmJiBlLmNsaXBib2FyZERhdGEuaXRlbXMgJiYgZS5jbGlwYm9hcmREYXRhLml0ZW1zLmxlbmd0aCA9PSAxICYmIC9eaW1hZ2VcXC8vLnRlc3QoZS5jbGlwYm9hcmREYXRhLml0ZW1zWzBdLnR5cGUpID8gZS5jbGlwYm9hcmREYXRhLml0ZW1zOm51bGw7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGdldERyb3BJbWFnZShlKXtcbiAgICAgICAgcmV0dXJuICBlLmRhdGFUcmFuc2ZlciAmJiBlLmRhdGFUcmFuc2Zlci5maWxlcyA/IGUuZGF0YVRyYW5zZmVyLmZpbGVzOm51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgb3V0cHV0UnVsZTogZnVuY3Rpb24ocm9vdCl7XG4gICAgICAgICAgICB1dGlscy5lYWNoKHJvb3QuZ2V0Tm9kZXNCeVRhZ05hbWUoJ2ltZycpLGZ1bmN0aW9uKG4pe1xuICAgICAgICAgICAgICAgIGlmICgvXFxiKGxvYWRlcnJvcmNsYXNzKXwoYmxvYWRlcnJvcmNsYXNzKVxcYi8udGVzdChuLmdldEF0dHIoJ2NsYXNzJykpKSB7XG4gICAgICAgICAgICAgICAgICAgIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHV0aWxzLmVhY2gocm9vdC5nZXROb2Rlc0J5VGFnTmFtZSgncCcpLGZ1bmN0aW9uKG4pe1xuICAgICAgICAgICAgICAgIGlmICgvXFxibG9hZHBhcmFcXGIvLnRlc3Qobi5nZXRBdHRyKCdjbGFzcycpKSkge1xuICAgICAgICAgICAgICAgICAgICBuLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sXG4gICAgICAgIGJpbmRFdmVudHM6e1xuICAgICAgICAgICAgLy/mj5LlhaXnspjotLTmnb/nmoTlm77niYfvvIzmi5bmlL7mj5LlhaXlm77niYdcbiAgICAgICAgICAgICdyZWFkeSc6ZnVuY3Rpb24oZSl7XG4gICAgICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcbiAgICAgICAgICAgICAgICBpZih3aW5kb3cuRm9ybURhdGEgJiYgd2luZG93LkZpbGVSZWFkZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMub24obWUuYm9keSwgJ3Bhc3RlIGRyb3AnLCBmdW5jdGlvbihlKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYXNJbWcgPSBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtcztcbiAgICAgICAgICAgICAgICAgICAgICAgIC8v6I635Y+W57KY6LS05p2/5paH5Lu25YiX6KGo5oiW6ICF5ouW5pS+5paH5Lu25YiX6KGoXG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtcyA9IGUudHlwZSA9PSAncGFzdGUnID8gZ2V0UGFzdGVJbWFnZShlKTpnZXREcm9wSW1hZ2UoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihpdGVtcyl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxlbiA9IGl0ZW1zLmxlbmd0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAobGVuLS0pe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlID0gaXRlbXNbbGVuXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoZmlsZS5nZXRBc0ZpbGUpIGZpbGUgPSBmaWxlLmdldEFzRmlsZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihmaWxlICYmIGZpbGUuc2l6ZSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRBbmRJbnNlcnRGaWxlKGZpbGUsIG1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc0ltZyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzSW1nICYmIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgLy/lj5bmtojmi5bmlL7lm77niYfml7blh7rnjrDnmoTmloflrZflhYnmoIfkvY3nva7mj5DnpLpcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMub24obWUuYm9keSwgJ2RyYWdvdmVyJywgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGUuZGF0YVRyYW5zZmVyLnR5cGVzWzBdID09ICdGaWxlcycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIC8v6K6+572ubG9hZGluZ+eahOagt+W8j1xuICAgICAgICAgICAgICAgICAgICB1dGlscy5jc3NSdWxlKCdsb2FkaW5nJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICcubG9hZGluZ2NsYXNze2Rpc3BsYXk6aW5saW5lLWJsb2NrO2N1cnNvcjpkZWZhdWx0O2JhY2tncm91bmQ6IHVybChcXCcnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKyB0aGlzLm9wdGlvbnMudGhlbWVQYXRoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKyB0aGlzLm9wdGlvbnMudGhlbWUgKycvaW1hZ2VzL2xvYWRpbmcuZ2lmXFwnKSBuby1yZXBlYXQgY2VudGVyIGNlbnRlciB0cmFuc3BhcmVudDtib3JkZXI6MXB4IHNvbGlkICNjY2NjY2M7bWFyZ2luLWxlZnQ6MXB4O2hlaWdodDogMjJweDt3aWR0aDogMjJweDt9XFxuJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJy5sb2FkZXJyb3JjbGFzc3tkaXNwbGF5OmlubGluZS1ibG9jaztjdXJzb3I6ZGVmYXVsdDtiYWNrZ3JvdW5kOiB1cmwoXFwnJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgdGhpcy5vcHRpb25zLnRoZW1lUGF0aFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgdGhpcy5vcHRpb25zLnRoZW1lICsnL2ltYWdlcy9sb2FkZXJyb3IucG5nXFwnKSBuby1yZXBlYXQgY2VudGVyIGNlbnRlciB0cmFuc3BhcmVudDtib3JkZXI6MXB4IHNvbGlkICNjY2NjY2M7bWFyZ2luLXJpZ2h0OjFweDtoZWlnaHQ6IDIycHg7d2lkdGg6IDIycHg7JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ30nLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb2N1bWVudCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufSk7XG5cbi8vIHBsdWdpbnMvYXV0b3NhdmUuanNcblVFLnBsdWdpbi5yZWdpc3RlcignYXV0b3NhdmUnLCBmdW5jdGlvbiAoKXtcblxuICAgIHZhciBtZSA9IHRoaXMsXG4gICAgICAgIC8v5peg6ZmQ5b6q546v5L+d5oqkXG4gICAgICAgIGxhc3RTYXZlVGltZSA9IG5ldyBEYXRlKCksXG4gICAgICAgIC8v5pyA5bCP5L+d5a2Y6Ze06ZqU5pe26Ze0XG4gICAgICAgIE1JTl9USU1FID0gMjAsXG4gICAgICAgIC8vYXV0byBzYXZlIGtleVxuICAgICAgICBzYXZlS2V5ID0gbnVsbDtcblxuICAgIGZ1bmN0aW9uIHNhdmUgKCBlZGl0b3IgKSB7XG5cbiAgICAgICAgdmFyIHNhdmVEYXRhO1xuXG4gICAgICAgIGlmICggbmV3IERhdGUoKSAtIGxhc3RTYXZlVGltZSA8IE1JTl9USU1FICkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCAhZWRpdG9yLmhhc0NvbnRlbnRzKCkgKSB7XG4gICAgICAgICAgICAvL+i/memHjOS4jeiDveiwg+eUqOWRveS7pOadpeWIoOmZpO+8jCDkvJrpgKDmiJDkuovku7bmrbvlvqrnjq9cbiAgICAgICAgICAgIHNhdmVLZXkgJiYgbWUucmVtb3ZlUHJlZmVyZW5jZXMoIHNhdmVLZXkgKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxhc3RTYXZlVGltZSA9IG5ldyBEYXRlKCk7XG5cbiAgICAgICAgZWRpdG9yLl9zYXZlRmxhZyA9IG51bGw7XG5cbiAgICAgICAgc2F2ZURhdGEgPSBtZS5ib2R5LmlubmVySFRNTDtcblxuICAgICAgICBpZiAoIGVkaXRvci5maXJlRXZlbnQoIFwiYmVmb3JlYXV0b3NhdmVcIiwge1xuICAgICAgICAgICAgY29udGVudDogc2F2ZURhdGFcbiAgICAgICAgfSApID09PSBmYWxzZSApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIG1lLnNldFByZWZlcmVuY2VzKCBzYXZlS2V5LCBzYXZlRGF0YSApO1xuXG4gICAgICAgIGVkaXRvci5maXJlRXZlbnQoIFwiYWZ0ZXJhdXRvc2F2ZVwiLCB7XG4gICAgICAgICAgICBjb250ZW50OiBzYXZlRGF0YVxuICAgICAgICB9ICk7XG5cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBkZWZhdWx0T3B0aW9uczoge1xuICAgICAgICAgICAgLy/pu5jorqTpl7TpmpTml7bpl7RcbiAgICAgICAgICAgIHNhdmVJbnRlcnZhbDogNTAwXG4gICAgICAgIH0sXG4gICAgICAgIGJpbmRFdmVudHM6e1xuICAgICAgICAgICAgJ3JlYWR5JzpmdW5jdGlvbigpe1xuXG4gICAgICAgICAgICAgICAgdmFyIF9zdWZmaXggPSBcIi1kcmFmdHMtZGF0YVwiLFxuICAgICAgICAgICAgICAgICAgICBrZXkgPSBudWxsO1xuXG4gICAgICAgICAgICAgICAgaWYgKCBtZS5rZXkgKSB7XG4gICAgICAgICAgICAgICAgICAgIGtleSA9IG1lLmtleSArIF9zdWZmaXg7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAga2V5ID0gKCBtZS5jb250YWluZXIucGFyZW50Tm9kZS5pZCB8fCAndWUtY29tbW9uJyApICsgX3N1ZmZpeDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvL+mhtemdouWcsOWdgCvnvJbovpHlmahJRCDkv53mjIHllK/kuIBcbiAgICAgICAgICAgICAgICBzYXZlS2V5ID0gKCBsb2NhdGlvbi5wcm90b2NvbCArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSApLnJlcGxhY2UoIC9bLjpcXC9dL2csICdfJyApICsga2V5O1xuXG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICAnY29udGVudGNoYW5nZSc6IGZ1bmN0aW9uICgpIHtcblxuICAgICAgICAgICAgICAgIGlmICggIXNhdmVLZXkgKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoIG1lLl9zYXZlRmxhZyApIHtcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCggbWUuX3NhdmVGbGFnICk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCBtZS5vcHRpb25zLnNhdmVJbnRlcnZhbCA+IDAgKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgbWUuX3NhdmVGbGFnID0gd2luZG93LnNldFRpbWVvdXQoIGZ1bmN0aW9uICgpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgc2F2ZSggbWUgKTtcblxuICAgICAgICAgICAgICAgICAgICB9LCBtZS5vcHRpb25zLnNhdmVJbnRlcnZhbCApO1xuXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgICAgICBzYXZlKG1lKTtcblxuICAgICAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGNvbW1hbmRzOntcbiAgICAgICAgICAgICdjbGVhcmxvY2FsZGF0YSc6e1xuICAgICAgICAgICAgICAgIGV4ZWNDb21tYW5kOmZ1bmN0aW9uIChjbWQsIG5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBzYXZlS2V5ICYmIG1lLmdldFByZWZlcmVuY2VzKCBzYXZlS2V5ICkgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5yZW1vdmVQcmVmZXJlbmNlcyggc2F2ZUtleSApXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG5vdE5lZWRVbmRvOiB0cnVlLFxuICAgICAgICAgICAgICAgIGlnbm9yZUNvbnRlbnRDaGFuZ2U6dHJ1ZVxuICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgJ2dldGxvY2FsZGF0YSc6e1xuICAgICAgICAgICAgICAgIGV4ZWNDb21tYW5kOmZ1bmN0aW9uIChjbWQsIG5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNhdmVLZXkgPyBtZS5nZXRQcmVmZXJlbmNlcyggc2F2ZUtleSApIHx8ICcnIDogJyc7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBub3ROZWVkVW5kbzogdHJ1ZSxcbiAgICAgICAgICAgICAgICBpZ25vcmVDb250ZW50Q2hhbmdlOnRydWVcbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgICdkcmFmdHMnOntcbiAgICAgICAgICAgICAgICBleGVjQ29tbWFuZDpmdW5jdGlvbiAoY21kLCBuYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICggc2F2ZUtleSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmJvZHkuaW5uZXJIVE1MID0gbWUuZ2V0UHJlZmVyZW5jZXMoIHNhdmVLZXkgKSB8fCAnPHA+Jytkb21VdGlscy5maWxsSHRtbCsnPC9wPic7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5mb2N1cyh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcXVlcnlDb21tYW5kU3RhdGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNhdmVLZXkgPyAoIG1lLmdldFByZWZlcmVuY2VzKCBzYXZlS2V5ICkgPT09IG51bGwgPyAtMSA6IDAgKSA6IC0xO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgbm90TmVlZFVuZG86IHRydWUsXG4gICAgICAgICAgICAgICAgaWdub3JlQ29udGVudENoYW5nZTp0cnVlXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbn0pO1xuXG4vLyBwbHVnaW5zL2NoYXJ0cy5qc1xuVUUucGx1Z2luLnJlZ2lzdGVyKCdjaGFydHMnLCBmdW5jdGlvbiAoKXtcblxuICAgIHZhciBtZSA9IHRoaXM7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBiaW5kRXZlbnRzOiB7XG4gICAgICAgICAgICAnY2hhcnRzZXJyb3InOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGNvbW1hbmRzOntcbiAgICAgICAgICAgICdjaGFydHMnOiB7XG4gICAgICAgICAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uICggY21kLCBkYXRhICkge1xuXG4gICAgICAgICAgICAgICAgICAgIHZhciB0YWJsZU5vZGUgPSBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlKCkuc3RhcnRDb250YWluZXIsICd0YWJsZScsIHRydWUpLFxuICAgICAgICAgICAgICAgICAgICAgICAgZmxhZ1RleHQgPSBbXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZyA9IHt9O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICggIXRhYmxlTm9kZSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmICggIXZhbGlkRGF0YSggdGFibGVOb2RlICkgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoIFwiY2hhcnRzZXJyb3JcIiApO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgY29uZmlnLnRpdGxlID0gZGF0YS50aXRsZSB8fCAnJztcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnLnN1YlRpdGxlID0gZGF0YS5zdWJUaXRsZSB8fCAnJztcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnLnhUaXRsZSA9IGRhdGEueFRpdGxlIHx8ICcnO1xuICAgICAgICAgICAgICAgICAgICBjb25maWcueVRpdGxlID0gZGF0YS55VGl0bGUgfHwgJyc7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZy5zdWZmaXggPSBkYXRhLnN1ZmZpeCB8fCAnJztcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnLnRpcCA9IGRhdGEudGlwIHx8ICcnO1xuICAgICAgICAgICAgICAgICAgICAvL+aVsOaNruWvuem9kOaWueW8j1xuICAgICAgICAgICAgICAgICAgICBjb25maWcuZGF0YUZvcm1hdCA9IGRhdGEudGFibGVEYXRhRm9ybWF0IHx8ICcnO1xuICAgICAgICAgICAgICAgICAgICAvL+WbvuihqOexu+Wei1xuICAgICAgICAgICAgICAgICAgICBjb25maWcuY2hhcnRUeXBlID0gZGF0YS5jaGFydFR5cGUgfHwgMDtcblxuICAgICAgICAgICAgICAgICAgICBmb3IgKCB2YXIga2V5IGluIGNvbmZpZyApIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCAhY29uZmlnLmhhc093blByb3BlcnR5KCBrZXkgKSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgZmxhZ1RleHQucHVzaCgga2V5K1wiOlwiK2NvbmZpZ1sga2V5IF0gKTtcblxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgdGFibGVOb2RlLnNldEF0dHJpYnV0ZSggXCJkYXRhLWNoYXJ0XCIsIGZsYWdUZXh0LmpvaW4oIFwiO1wiICkgKTtcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMuYWRkQ2xhc3MoIHRhYmxlTm9kZSwgXCJlZHVpLWNoYXJ0cy10YWJsZVwiICk7XG5cblxuXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBxdWVyeUNvbW1hbmRTdGF0ZTogZnVuY3Rpb24gKCBjbWQsIG5hbWUgKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgdmFyIHRhYmxlTm9kZSA9IGRvbVV0aWxzLmZpbmRQYXJlbnRCeVRhZ05hbWUodGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2UoKS5zdGFydENvbnRhaW5lciwgJ3RhYmxlJywgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0YWJsZU5vZGUgJiYgdmFsaWREYXRhKCB0YWJsZU5vZGUgKSA/IDAgOiAtMTtcblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgaW5wdXRSdWxlOmZ1bmN0aW9uKHJvb3Qpe1xuICAgICAgICAgICAgdXRpbHMuZWFjaChyb290LmdldE5vZGVzQnlUYWdOYW1lKCd0YWJsZScpLGZ1bmN0aW9uKCB0YWJsZU5vZGUgKXtcblxuICAgICAgICAgICAgICAgIGlmICggdGFibGVOb2RlLmdldEF0dHIoXCJkYXRhLWNoYXJ0XCIpICE9PSB1bmRlZmluZWQgKSB7XG4gICAgICAgICAgICAgICAgICAgIHRhYmxlTm9kZS5zZXRBdHRyKFwic3R5bGVcIik7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgIH0sXG4gICAgICAgIG91dHB1dFJ1bGU6ZnVuY3Rpb24ocm9vdCl7XG4gICAgICAgICAgICB1dGlscy5lYWNoKHJvb3QuZ2V0Tm9kZXNCeVRhZ05hbWUoJ3RhYmxlJyksZnVuY3Rpb24oIHRhYmxlTm9kZSApe1xuXG4gICAgICAgICAgICAgICAgaWYgKCB0YWJsZU5vZGUuZ2V0QXR0cihcImRhdGEtY2hhcnRcIikgIT09IHVuZGVmaW5lZCApIHtcbiAgICAgICAgICAgICAgICAgICAgdGFibGVOb2RlLnNldEF0dHIoXCJzdHlsZVwiLCBcImRpc3BsYXk6IG5vbmU7XCIpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSlcblxuICAgICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gdmFsaWREYXRhICggdGFibGUgKSB7XG5cbiAgICAgICAgdmFyIGZpcnN0Um93cyA9IG51bGwsXG4gICAgICAgICAgICBjZWxsQ291bnQgPSAwO1xuXG4gICAgICAgIC8v6KGM5pWw5LiN5aSfXG4gICAgICAgIGlmICggdGFibGUucm93cy5sZW5ndGggPCAyICkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy/liJfmlbDkuI3lpJ9cbiAgICAgICAgaWYgKCB0YWJsZS5yb3dzWzBdLmNlbGxzLmxlbmd0aCA8IDIgKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICAvL+esrOS4gOihjOaJgOaciWNlbGzlv4XpobvmmK90aFxuICAgICAgICBmaXJzdFJvd3MgPSB0YWJsZS5yb3dzWyAwIF0uY2VsbHM7XG4gICAgICAgIGNlbGxDb3VudCA9IGZpcnN0Um93cy5sZW5ndGg7XG5cbiAgICAgICAgZm9yICggdmFyIGkgPSAwLCBjZWxsOyBjZWxsID0gZmlyc3RSb3dzWyBpIF07IGkrKyApIHtcblxuICAgICAgICAgICAgaWYgKCBjZWxsLnRhZ05hbWUudG9Mb3dlckNhc2UoKSAhPT0gJ3RoJyApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAoIHZhciBpID0gMSwgcm93OyByb3cgPSB0YWJsZS5yb3dzWyBpIF07IGkrKyApIHtcblxuICAgICAgICAgICAgLy/mr4/ooYzljZXlhYPmoLzmlbDkuI3ljLnphY3vvIwg6L+U5ZueZmFsc2VcbiAgICAgICAgICAgIGlmICggcm93LmNlbGxzLmxlbmd0aCAhPSBjZWxsQ291bnQgKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvL+esrOS4gOWIl+S4jeaYr3Ro5Lmf6L+U5ZueZmFsc2VcbiAgICAgICAgICAgIGlmICggcm93LmNlbGxzWzBdLnRhZ05hbWUudG9Mb3dlckNhc2UoKSAhPT0gJ3RoJyApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZvciAoIHZhciBqID0gMSwgY2VsbDsgY2VsbCA9IHJvdy5jZWxsc1sgaiBdOyBqKysgKSB7XG5cbiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSB1dGlscy50cmltKCAoIGNlbGwuaW5uZXJUZXh0IHx8IGNlbGwudGV4dENvbnRlbnQgfHwgJycgKSApO1xuXG4gICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKCBuZXcgUmVnRXhwKCBVRS5kb20uZG9tVXRpbHMuZmlsbENoYXIsICdnJyApLCAnJyApLnJlcGxhY2UoIC9eXFxzK3xcXHMrJC9nLCAnJyApO1xuXG4gICAgICAgICAgICAgICAgLy/lv4XpobvmmK/mlbDlrZdcbiAgICAgICAgICAgICAgICBpZiAoICEvXlxcZCpcXC4/XFxkKyQvLnRlc3QoIHZhbHVlICkgKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG5cbiAgICB9XG5cbn0pO1xuXG4vLyBwbHVnaW5zL3NlY3Rpb24uanNcbi8qKlxuICog55uu5b2V5aSn57qy5pSv5oyB5o+S5Lu2XG4gKiBAZmlsZVxuICogQHNpbmNlIDEuMy4wXG4gKi9cblVFLnBsdWdpbi5yZWdpc3Rlcignc2VjdGlvbicsIGZ1bmN0aW9uICgpe1xuICAgIC8qIOebruW9leiKgueCueWvueixoSAqL1xuICAgIGZ1bmN0aW9uIFNlY3Rpb24ob3B0aW9uKXtcbiAgICAgICAgdGhpcy50YWcgPSAnJztcbiAgICAgICAgdGhpcy5sZXZlbCA9IC0xLFxuICAgICAgICAgICAgdGhpcy5kb20gPSBudWxsO1xuICAgICAgICB0aGlzLm5leHRTZWN0aW9uID0gbnVsbDtcbiAgICAgICAgdGhpcy5wcmV2aW91c1NlY3Rpb24gPSBudWxsO1xuICAgICAgICB0aGlzLnBhcmVudFNlY3Rpb24gPSBudWxsO1xuICAgICAgICB0aGlzLnN0YXJ0QWRkcmVzcyA9IFtdO1xuICAgICAgICB0aGlzLmVuZEFkZHJlc3MgPSBbXTtcbiAgICAgICAgdGhpcy5jaGlsZHJlbiA9IFtdO1xuICAgIH1cbiAgICBmdW5jdGlvbiBnZXRTZWN0aW9uKG9wdGlvbikge1xuICAgICAgICB2YXIgc2VjdGlvbiA9IG5ldyBTZWN0aW9uKCk7XG4gICAgICAgIHJldHVybiB1dGlscy5leHRlbmQoc2VjdGlvbiwgb3B0aW9uKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gZ2V0Tm9kZUZyb21BZGRyZXNzKHN0YXJ0QWRkcmVzcywgcm9vdCkge1xuICAgICAgICB2YXIgY3VycmVudCA9IHJvb3Q7XG4gICAgICAgIGZvcih2YXIgaSA9IDA7aSA8IHN0YXJ0QWRkcmVzcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgaWYoIWN1cnJlbnQuY2hpbGROb2RlcykgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC5jaGlsZE5vZGVzW3N0YXJ0QWRkcmVzc1tpXV07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGN1cnJlbnQ7XG4gICAgfVxuXG4gICAgdmFyIG1lID0gdGhpcztcblxuICAgIHJldHVybiB7XG4gICAgICAgIGJpbmRNdWx0aUV2ZW50czp7XG4gICAgICAgICAgICB0eXBlOiAnYWZ0ZXJzZXRjb250ZW50IGFmdGVyc2NlbmNlcmVzdG9yZScsXG4gICAgICAgICAgICBoYW5kbGVyOiBmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgndXBkYXRlU2VjdGlvbnMnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgYmluZEV2ZW50czp7XG4gICAgICAgICAgICAvKiDliJ3lp4vljJbjgIHmi5bmi73jgIHnspjotLTjgIHmiafooYxzZXRjb250ZW505LmL5ZCOICovXG4gICAgICAgICAgICAncmVhZHknOiBmdW5jdGlvbiAoKXtcbiAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3VwZGF0ZVNlY3Rpb25zJyk7XG4gICAgICAgICAgICAgICAgZG9tVXRpbHMub24obWUuYm9keSwgJ2Ryb3AgcGFzdGUnLCBmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3VwZGF0ZVNlY3Rpb25zJyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLyog5omn6KGMcGFyYWdyYXBo5ZG95Luk5LmL5ZCOICovXG4gICAgICAgICAgICAnYWZ0ZXJleGVjY29tbWFuZCc6IGZ1bmN0aW9uICh0eXBlLCBjbWQpIHtcbiAgICAgICAgICAgICAgICBpZihjbWQgPT0gJ3BhcmFncmFwaCcpIHtcbiAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCd1cGRhdGVTZWN0aW9ucycpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAvKiDpg6jliIbplK7nm5jmk43kvZzvvIzop6blj5F1cGRhdGVTZWN0aW9uc+S6i+S7tiAqL1xuICAgICAgICAgICAgJ2tleXVwJzogZnVuY3Rpb24gKHR5cGUsIGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzLFxuICAgICAgICAgICAgICAgICAgICByYW5nZSA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpO1xuICAgICAgICAgICAgICAgIGlmKHJhbmdlLmNvbGxhcHNlZCAhPSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgndXBkYXRlU2VjdGlvbnMnKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB2YXIga2V5Q29kZSA9IGUua2V5Q29kZSB8fCBlLndoaWNoO1xuICAgICAgICAgICAgICAgICAgICBpZihrZXlDb2RlID09IDEzIHx8IGtleUNvZGUgPT0gOCB8fCBrZXlDb2RlID09IDQ2KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3VwZGF0ZVNlY3Rpb25zJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGNvbW1hbmRzOntcbiAgICAgICAgICAgICdnZXRzZWN0aW9ucyc6IHtcbiAgICAgICAgICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKGNtZCwgbGV2ZWxzKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBsZXZlbEZuID0gbGV2ZWxzIHx8IFsnaDEnLCAnaDInLCAnaDMnLCAnaDQnLCAnaDUnLCAnaDYnXTtcblxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxldmVsRm4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbGV2ZWxGbltpXSA9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldmVsRm5baV0gPSBmdW5jdGlvbihmbil7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihub2RlKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnRhZ05hbWUgPT0gZm4udG9VcHBlckNhc2UoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0obGV2ZWxGbltpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBsZXZlbEZuW2ldICE9ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXZlbEZuW2ldID0gZnVuY3Rpb24gKG5vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGdldFNlY3Rpb25MZXZlbChub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxldmVsRm4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGV2ZWxGbltpXShub2RlKSkgcmV0dXJuIGk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGlyZWN0b3J5ID0gZ2V0U2VjdGlvbih7J2xldmVsJzotMSwgJ3RpdGxlJzoncm9vdCd9KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzID0gRGlyZWN0b3J5O1xuXG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHRyYXZlcnNhbChub2RlLCBEaXJlY3RvcnkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsZXZlbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBTZWN0aW9uID0gbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW4gPSBub2RlLmNoaWxkTm9kZXM7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkcmVuW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldmVsID0gZ2V0U2VjdGlvbkxldmVsKGNoaWxkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGV2ZWwgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWRkcmVzcyA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLnNlbGVjdE5vZGUoY2hpbGQpLmNyZWF0ZUFkZHJlc3ModHJ1ZSkuc3RhcnRBZGRyZXNzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGdldFNlY3Rpb24oe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd0YWcnOiBjaGlsZC50YWdOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd0aXRsZSc6IGNoaWxkLmlubmVyVGV4dCB8fCBjaGlsZC50ZXh0Q29udGVudCB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGV2ZWwnOiBsZXZlbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZG9tJzogY2hpbGQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXJ0QWRkcmVzcyc6IHV0aWxzLmNsb25lKGFkZHJlc3MsIFtdKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZW5kQWRkcmVzcyc6IHV0aWxzLmNsb25lKGFkZHJlc3MsIFtdKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY2hpbGRyZW4nOiBbXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzLm5leHRTZWN0aW9uID0gY3VycmVudDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudC5wcmV2aW91c1NlY3Rpb24gPSBwcmV2aW91cztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gcHJldmlvdXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKGxldmVsIDw9IHBhcmVudC5sZXZlbCl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50U2VjdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50LnBhcmVudFNlY3Rpb24gPSBwYXJlbnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5jaGlsZHJlbi5wdXNoKGN1cnJlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBTZWN0aW9uID0gcHJldmlvdXMgPSBjdXJyZW50O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLm5vZGVUeXBlID09PSAxICYmIHRyYXZlcnNhbChjaGlsZCwgRGlyZWN0b3J5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wU2VjdGlvbiAmJiB0bXBTZWN0aW9uLmVuZEFkZHJlc3NbdG1wU2VjdGlvbi5lbmRBZGRyZXNzLmxlbmd0aCAtIDFdICsrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0cmF2ZXJzYWwobWUuYm9keSwgRGlyZWN0b3J5KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIERpcmVjdG9yeTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG5vdE5lZWRVbmRvOiB0cnVlXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ21vdmVzZWN0aW9uJzoge1xuICAgICAgICAgICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoY21kLCBzb3VyY2VTZWN0aW9uLCB0YXJnZXRTZWN0aW9uLCBpc0FmdGVyKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgdmFyIG1lID0gdGhpcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldEFkZHJlc3MsXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYoIXNvdXJjZVNlY3Rpb24gfHwgIXRhcmdldFNlY3Rpb24gfHwgdGFyZ2V0U2VjdGlvbi5sZXZlbCA9PSAtMSkgcmV0dXJuO1xuXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldEFkZHJlc3MgPSBpc0FmdGVyID8gdGFyZ2V0U2VjdGlvbi5lbmRBZGRyZXNzOnRhcmdldFNlY3Rpb24uc3RhcnRBZGRyZXNzO1xuICAgICAgICAgICAgICAgICAgICB0YXJnZXQgPSBnZXROb2RlRnJvbUFkZHJlc3ModGFyZ2V0QWRkcmVzcywgbWUuYm9keSk7XG5cbiAgICAgICAgICAgICAgICAgICAgLyog5Yik5pat55uu5qCH5Zyw5Z2A5piv5ZCm6KKr5rqQ56ug6IqC5YyF5ZCrICovXG4gICAgICAgICAgICAgICAgICAgIGlmKCF0YXJnZXRBZGRyZXNzIHx8ICF0YXJnZXQgfHwgaXNDb250YWluc0FkZHJlc3Moc291cmNlU2VjdGlvbi5zdGFydEFkZHJlc3MsIHNvdXJjZVNlY3Rpb24uZW5kQWRkcmVzcywgdGFyZ2V0QWRkcmVzcykpIHJldHVybjtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgc3RhcnROb2RlID0gZ2V0Tm9kZUZyb21BZGRyZXNzKHNvdXJjZVNlY3Rpb24uc3RhcnRBZGRyZXNzLCBtZS5ib2R5KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZE5vZGUgPSBnZXROb2RlRnJvbUFkZHJlc3Moc291cmNlU2VjdGlvbi5lbmRBZGRyZXNzLCBtZS5ib2R5KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXh0Tm9kZTtcblxuICAgICAgICAgICAgICAgICAgICBpZihpc0FmdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gZW5kTm9kZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICggY3VycmVudCAmJiAhKGRvbVV0aWxzLmdldFBvc2l0aW9uKCBzdGFydE5vZGUsIGN1cnJlbnQgKSAmIGRvbVV0aWxzLlBPU0lUSU9OX0ZPTExPV0lORykgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE5vZGUgPSBjdXJyZW50LnByZXZpb3VzU2libGluZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5pbnNlcnRBZnRlcih0YXJnZXQsIGN1cnJlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGN1cnJlbnQgPT0gc3RhcnROb2RlKSBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gbmV4dE5vZGU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gc3RhcnROb2RlO1xuICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKCBjdXJyZW50ICYmICEoZG9tVXRpbHMuZ2V0UG9zaXRpb24oIGN1cnJlbnQsIGVuZE5vZGUgKSAmIGRvbVV0aWxzLlBPU0lUSU9OX0ZPTExPV0lORykgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE5vZGUgPSBjdXJyZW50Lm5leHRTaWJsaW5nO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShjdXJyZW50LCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGN1cnJlbnQgPT0gZW5kTm9kZSkgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IG5leHROb2RlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCd1cGRhdGVTZWN0aW9ucycpO1xuXG4gICAgICAgICAgICAgICAgICAgIC8qIOiOt+WPluWcsOWdgOeahOWMheWQq+WFs+ezuyAqL1xuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBpc0NvbnRhaW5zQWRkcmVzcyhzdGFydEFkZHJlc3MsIGVuZEFkZHJlc3MsIGFkZHJlc3NUYXJnZXQpe1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlzQWZ0ZXJTdGFydEFkZHJlc3MgPSBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0JlZm9yZUVuZEFkZHJlc3MgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGk8IHN0YXJ0QWRkcmVzcy5sZW5ndGg7IGkrKyl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaSA+PSBhZGRyZXNzVGFyZ2V0Lmxlbmd0aCkgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoYWRkcmVzc1RhcmdldFtpXSA+IHN0YXJ0QWRkcmVzc1tpXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0FmdGVyU3RhcnRBZGRyZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGFkZHJlc3NUYXJnZXRbaV0gPCBzdGFydEFkZHJlc3NbaV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaTwgZW5kQWRkcmVzcy5sZW5ndGg7IGkrKyl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaSA+PSBhZGRyZXNzVGFyZ2V0Lmxlbmd0aCkgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoYWRkcmVzc1RhcmdldFtpXSA8IHN0YXJ0QWRkcmVzc1tpXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0JlZm9yZUVuZEFkZHJlc3MgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoYWRkcmVzc1RhcmdldFtpXSA+IHN0YXJ0QWRkcmVzc1tpXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNBZnRlclN0YXJ0QWRkcmVzcyAmJiBpc0JlZm9yZUVuZEFkZHJlc3M7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ2RlbGV0ZXNlY3Rpb24nOiB7XG4gICAgICAgICAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uIChjbWQsIHNlY3Rpb24sIGtlZXBDaGlsZHJlbikge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmKCFzZWN0aW9uKSByZXR1cm47XG5cbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZyb21BZGRyZXNzKHN0YXJ0QWRkcmVzcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBtZS5ib2R5O1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDtpIDwgc3RhcnRBZGRyZXNzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWN1cnJlbnQuY2hpbGROb2RlcykgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuY2hpbGROb2Rlc1tzdGFydEFkZHJlc3NbaV1dO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB2YXIgc3RhcnROb2RlID0gZ2V0Tm9kZUZyb21BZGRyZXNzKHNlY3Rpb24uc3RhcnRBZGRyZXNzKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZE5vZGUgPSBnZXROb2RlRnJvbUFkZHJlc3Moc2VjdGlvbi5lbmRBZGRyZXNzKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBzdGFydE5vZGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXh0Tm9kZTtcblxuICAgICAgICAgICAgICAgICAgICBpZigha2VlcENoaWxkcmVuKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoIGN1cnJlbnQgJiYgZG9tVXRpbHMuaW5Eb2MoZW5kTm9kZSwgbWUuZG9jdW1lbnQpICYmICEoZG9tVXRpbHMuZ2V0UG9zaXRpb24oIGN1cnJlbnQsIGVuZE5vZGUgKSAmIGRvbVV0aWxzLlBPU0lUSU9OX0ZPTExPV0lORykgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE5vZGUgPSBjdXJyZW50Lm5leHRTaWJsaW5nO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShjdXJyZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gbmV4dE5vZGU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmUoY3VycmVudCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ3VwZGF0ZVNlY3Rpb25zJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdzZWxlY3RzZWN0aW9uJzoge1xuICAgICAgICAgICAgICAgIGV4ZWNDb21tYW5kOiBmdW5jdGlvbiAoY21kLCBzZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKCFzZWN0aW9uICYmICFzZWN0aW9uLmRvbSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UgPSBtZS5zZWxlY3Rpb24uZ2V0UmFuZ2UoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXJ0QWRkcmVzcyc6dXRpbHMuY2xvbmUoc2VjdGlvbi5zdGFydEFkZHJlc3MsIFtdKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZW5kQWRkcmVzcyc6dXRpbHMuY2xvbmUoc2VjdGlvbi5lbmRBZGRyZXNzLCBbXSlcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGFkZHJlc3MuZW5kQWRkcmVzc1thZGRyZXNzLmVuZEFkZHJlc3MubGVuZ3RoIC0gMV0rKztcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2UubW92ZVRvQWRkcmVzcyhhZGRyZXNzKS5zZWxlY3QoKS5zY3JvbGxUb1ZpZXcoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBub3ROZWVkVW5kbzogdHJ1ZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdzY3JvbGx0b3NlY3Rpb24nOiB7XG4gICAgICAgICAgICAgICAgZXhlY0NvbW1hbmQ6IGZ1bmN0aW9uIChjbWQsIHNlY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYoIXNlY3Rpb24gJiYgIXNlY3Rpb24uZG9tKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZSA9IG1lLnNlbGVjdGlvbi5nZXRSYW5nZSgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3RhcnRBZGRyZXNzJzpzZWN0aW9uLnN0YXJ0QWRkcmVzcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZW5kQWRkcmVzcyc6c2VjdGlvbi5lbmRBZGRyZXNzXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBhZGRyZXNzLmVuZEFkZHJlc3NbYWRkcmVzcy5lbmRBZGRyZXNzLmxlbmd0aCAtIDFdKys7XG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLm1vdmVUb0FkZHJlc3MoYWRkcmVzcykuc2Nyb2xsVG9WaWV3KCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgbm90TmVlZFVuZG86IHRydWVcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn0pO1xuXG4vLyBwbHVnaW5zL3NpbXBsZXVwbG9hZC5qc1xuLyoqXG4gKiBAZGVzY3JpcHRpb25cbiAqIOeugOWNleS4iuS8oDrngrnlh7vmjInpkq4s55u05o6l6YCJ5oup5paH5Lu25LiK5LygXG4gKiBAYXV0aG9yIEppbnFuXG4gKiBAZGF0ZSAyMDE0LTAzLTMxXG4gKi9cblVFLnBsdWdpbi5yZWdpc3Rlcignc2ltcGxldXBsb2FkJywgZnVuY3Rpb24gKCl7XG4gICAgdmFyIG1lID0gdGhpcyxcbiAgICAgICAgaXNMb2FkZWQgPSBmYWxzZSxcbiAgICAgICAgY29udGFpbmVyQnRuO1xuXG4gICAgZnVuY3Rpb24gaW5pdFVwbG9hZEJ0bigpe1xuICAgICAgICB2YXIgdyA9IGNvbnRhaW5lckJ0bi5vZmZzZXRXaWR0aCB8fCAyMCxcbiAgICAgICAgICAgIGggPSBjb250YWluZXJCdG4ub2Zmc2V0SGVpZ2h0IHx8IDIwLFxuICAgICAgICAgICAgYnRuSWZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyksXG4gICAgICAgICAgICBidG5TdHlsZSA9ICdkaXNwbGF5OmJsb2NrO3dpZHRoOicgKyB3ICsgJ3B4O2hlaWdodDonICsgaCArICdweDtvdmVyZmxvdzpoaWRkZW47Ym9yZGVyOjA7bWFyZ2luOjA7cGFkZGluZzowO3Bvc2l0aW9uOmFic29sdXRlO3RvcDowO2xlZnQ6MDtmaWx0ZXI6YWxwaGEob3BhY2l0eT0wKTstbW96LW9wYWNpdHk6MDsta2h0bWwtb3BhY2l0eTogMDtvcGFjaXR5OiAwO2N1cnNvcjpwb2ludGVyOyc7XG5cbiAgICAgICAgZG9tVXRpbHMub24oYnRuSWZyYW1lLCAnbG9hZCcsIGZ1bmN0aW9uKCl7XG5cbiAgICAgICAgICAgIHZhciB0aW1lc3RyYXAgPSAoK25ldyBEYXRlKCkpLnRvU3RyaW5nKDM2KSxcbiAgICAgICAgICAgICAgICB3cmFwcGVyLFxuICAgICAgICAgICAgICAgIGJ0bklmcmFtZURvYyxcbiAgICAgICAgICAgICAgICBidG5JZnJhbWVCb2R5O1xuXG4gICAgICAgICAgICBidG5JZnJhbWVEb2MgPSAoYnRuSWZyYW1lLmNvbnRlbnREb2N1bWVudCB8fCBidG5JZnJhbWUuY29udGVudFdpbmRvdy5kb2N1bWVudCk7XG4gICAgICAgICAgICBidG5JZnJhbWVCb2R5ID0gYnRuSWZyYW1lRG9jLmJvZHk7XG4gICAgICAgICAgICB3cmFwcGVyID0gYnRuSWZyYW1lRG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuXG4gICAgICAgICAgICB3cmFwcGVyLmlubmVySFRNTCA9ICc8Zm9ybSBpZD1cImVkdWlfZm9ybV8nICsgdGltZXN0cmFwICsgJ1wiIHRhcmdldD1cImVkdWlfaWZyYW1lXycgKyB0aW1lc3RyYXAgKyAnXCIgbWV0aG9kPVwiUE9TVFwiIGVuY3R5cGU9XCJtdWx0aXBhcnQvZm9ybS1kYXRhXCIgYWN0aW9uPVwiJyArIG1lLmdldE9wdCgnc2VydmVyVXJsJykgKyAnXCIgJyArXG4gICAgICAgICAgICAnc3R5bGU9XCInICsgYnRuU3R5bGUgKyAnXCI+JyArXG4gICAgICAgICAgICAnPGlucHV0IGlkPVwiZWR1aV9pbnB1dF8nICsgdGltZXN0cmFwICsgJ1wiIHR5cGU9XCJmaWxlXCIgYWNjZXB0PVwiaW1hZ2UvKlwiIG5hbWU9XCInICsgbWUub3B0aW9ucy5pbWFnZUZpZWxkTmFtZSArICdcIiAnICtcbiAgICAgICAgICAgICdzdHlsZT1cIicgKyBidG5TdHlsZSArICdcIj4nICtcbiAgICAgICAgICAgICc8L2Zvcm0+JyArXG4gICAgICAgICAgICAnPGlmcmFtZSBpZD1cImVkdWlfaWZyYW1lXycgKyB0aW1lc3RyYXAgKyAnXCIgbmFtZT1cImVkdWlfaWZyYW1lXycgKyB0aW1lc3RyYXAgKyAnXCIgc3R5bGU9XCJkaXNwbGF5Om5vbmU7d2lkdGg6MDtoZWlnaHQ6MDtib3JkZXI6MDttYXJnaW46MDtwYWRkaW5nOjA7cG9zaXRpb246YWJzb2x1dGU7XCI+PC9pZnJhbWU+JztcblxuICAgICAgICAgICAgd3JhcHBlci5jbGFzc05hbWUgPSAnZWR1aS0nICsgbWUub3B0aW9ucy50aGVtZTtcbiAgICAgICAgICAgIHdyYXBwZXIuaWQgPSBtZS51aS5pZCArICdfaWZyYW1ldXBsb2FkJztcbiAgICAgICAgICAgIGJ0bklmcmFtZUJvZHkuc3R5bGUuY3NzVGV4dCA9IGJ0blN0eWxlO1xuICAgICAgICAgICAgYnRuSWZyYW1lQm9keS5zdHlsZS53aWR0aCA9IHcgKyAncHgnO1xuICAgICAgICAgICAgYnRuSWZyYW1lQm9keS5zdHlsZS5oZWlnaHQgPSBoICsgJ3B4JztcbiAgICAgICAgICAgIGJ0bklmcmFtZUJvZHkuYXBwZW5kQ2hpbGQod3JhcHBlcik7XG5cbiAgICAgICAgICAgIGlmIChidG5JZnJhbWVCb2R5LnBhcmVudE5vZGUpIHtcbiAgICAgICAgICAgICAgICBidG5JZnJhbWVCb2R5LnBhcmVudE5vZGUuc3R5bGUud2lkdGggPSB3ICsgJ3B4JztcbiAgICAgICAgICAgICAgICBidG5JZnJhbWVCb2R5LnBhcmVudE5vZGUuc3R5bGUuaGVpZ2h0ID0gdyArICdweCc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhciBmb3JtID0gYnRuSWZyYW1lRG9jLmdldEVsZW1lbnRCeUlkKCdlZHVpX2Zvcm1fJyArIHRpbWVzdHJhcCk7XG4gICAgICAgICAgICB2YXIgaW5wdXQgPSBidG5JZnJhbWVEb2MuZ2V0RWxlbWVudEJ5SWQoJ2VkdWlfaW5wdXRfJyArIHRpbWVzdHJhcCk7XG4gICAgICAgICAgICB2YXIgaWZyYW1lID0gYnRuSWZyYW1lRG9jLmdldEVsZW1lbnRCeUlkKCdlZHVpX2lmcmFtZV8nICsgdGltZXN0cmFwKTtcblxuICAgICAgICAgICAgZG9tVXRpbHMub24oaW5wdXQsICdjaGFuZ2UnLCBmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgIGlmKCFpbnB1dC52YWx1ZSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHZhciBsb2FkaW5nSWQgPSAnbG9hZGluZ18nICsgKCtuZXcgRGF0ZSgpKS50b1N0cmluZygzNik7XG4gICAgICAgICAgICAgICAgdmFyIHBhcmFtcyA9IHV0aWxzLnNlcmlhbGl6ZVBhcmFtKG1lLnF1ZXJ5Q29tbWFuZFZhbHVlKCdzZXJ2ZXJwYXJhbScpKSB8fCAnJztcblxuICAgICAgICAgICAgICAgIHZhciBpbWFnZUFjdGlvblVybCA9IG1lLmdldEFjdGlvblVybChtZS5nZXRPcHQoJ2ltYWdlQWN0aW9uTmFtZScpKTtcbiAgICAgICAgICAgICAgICB2YXIgYWxsb3dGaWxlcyA9IG1lLmdldE9wdCgnaW1hZ2VBbGxvd0ZpbGVzJyk7XG5cbiAgICAgICAgICAgICAgICBtZS5mb2N1cygpO1xuICAgICAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKCdpbnNlcnRodG1sJywgJzxpbWcgY2xhc3M9XCJsb2FkaW5nY2xhc3NcIiBpZD1cIicgKyBsb2FkaW5nSWQgKyAnXCIgc3JjPVwiJyArIG1lLm9wdGlvbnMudGhlbWVQYXRoICsgbWUub3B0aW9ucy50aGVtZSArJy9pbWFnZXMvc3BhY2VyLmdpZlwiIHRpdGxlPVwiJyArIChtZS5nZXRMYW5nKCdzaW1wbGV1cGxvYWQubG9hZGluZycpIHx8ICcnKSArICdcIiA+Jyk7XG5cbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjYWxsYmFjaygpe1xuICAgICAgICAgICAgICAgICAgICB0cnl7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGluaywganNvbiwgbG9hZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvZHkgPSAoaWZyYW1lLmNvbnRlbnREb2N1bWVudCB8fCBpZnJhbWUuY29udGVudFdpbmRvdy5kb2N1bWVudCkuYm9keSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBib2R5LmlubmVyVGV4dCB8fCBib2R5LnRleHRDb250ZW50IHx8ICcnO1xuICAgICAgICAgICAgICAgICAgICAgICAganNvbiA9IChuZXcgRnVuY3Rpb24oXCJyZXR1cm4gXCIgKyByZXN1bHQpKSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGluayA9IG1lLm9wdGlvbnMuaW1hZ2VVcmxQcmVmaXggKyBqc29uLnVybDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGpzb24uc3RhdGUgPT0gJ1NVQ0NFU1MnICYmIGpzb24udXJsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGVyID0gbWUuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobG9hZGluZ0lkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkZXIuc2V0QXR0cmlidXRlKCdzcmMnLCBsaW5rKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkZXIuc2V0QXR0cmlidXRlKCdfc3JjJywgbGluayk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGVyLnNldEF0dHJpYnV0ZSgndGl0bGUnLCBqc29uLnRpdGxlIHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkZXIuc2V0QXR0cmlidXRlKCdhbHQnLCBqc29uLm9yaWdpbmFsIHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkZXIucmVtb3ZlQXR0cmlidXRlKCdpZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZUNsYXNzZXMobG9hZGVyLCAnbG9hZGluZ2NsYXNzJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3dFcnJvckxvYWRlciAmJiBzaG93RXJyb3JMb2FkZXIoanNvbi5zdGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1jYXRjaChlcil7XG4gICAgICAgICAgICAgICAgICAgICAgICBzaG93RXJyb3JMb2FkZXIgJiYgc2hvd0Vycm9yTG9hZGVyKG1lLmdldExhbmcoJ3NpbXBsZXVwbG9hZC5sb2FkRXJyb3InKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZm9ybS5yZXNldCgpO1xuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy51bihpZnJhbWUsICdsb2FkJywgY2FsbGJhY2spO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzaG93RXJyb3JMb2FkZXIodGl0bGUpe1xuICAgICAgICAgICAgICAgICAgICBpZihsb2FkaW5nSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2FkZXIgPSBtZS5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChsb2FkaW5nSWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGVyICYmIGRvbVV0aWxzLnJlbW92ZShsb2FkZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KCdzaG93bWVzc2FnZScsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaWQnOiBsb2FkaW5nSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2NvbnRlbnQnOiB0aXRsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndHlwZSc6ICdlcnJvcicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3RpbWVvdXQnOiA0MDAwXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8qIOWIpOaWreWQjuerr+mFjee9ruaYr+WQpuayoeacieWKoOi9veaIkOWKnyAqL1xuICAgICAgICAgICAgICAgIGlmICghbWUuZ2V0T3B0KCdpbWFnZUFjdGlvbk5hbWUnKSkge1xuICAgICAgICAgICAgICAgICAgICBlcnJvckhhbmRsZXIobWUuZ2V0TGFuZygnYXV0b3VwbG9hZC5lcnJvckxvYWRDb25maWcnKSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8g5Yik5pat5paH5Lu25qC85byP5piv5ZCm6ZSZ6K+vXG4gICAgICAgICAgICAgICAgdmFyIGZpbGVuYW1lID0gaW5wdXQudmFsdWUsXG4gICAgICAgICAgICAgICAgICAgIGZpbGVleHQgPSBmaWxlbmFtZSA/IGZpbGVuYW1lLnN1YnN0cihmaWxlbmFtZS5sYXN0SW5kZXhPZignLicpKTonJztcbiAgICAgICAgICAgICAgICBpZiAoIWZpbGVleHQgfHwgKGFsbG93RmlsZXMgJiYgKGFsbG93RmlsZXMuam9pbignJykgKyAnLicpLmluZGV4T2YoZmlsZWV4dC50b0xvd2VyQ2FzZSgpICsgJy4nKSA9PSAtMSkpIHtcbiAgICAgICAgICAgICAgICAgICAgc2hvd0Vycm9yTG9hZGVyKG1lLmdldExhbmcoJ3NpbXBsZXVwbG9hZC5leGNlZWRUeXBlRXJyb3InKSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBkb21VdGlscy5vbihpZnJhbWUsICdsb2FkJywgY2FsbGJhY2spO1xuICAgICAgICAgICAgICAgIGZvcm0uYWN0aW9uID0gdXRpbHMuZm9ybWF0VXJsKGltYWdlQWN0aW9uVXJsICsgKGltYWdlQWN0aW9uVXJsLmluZGV4T2YoJz8nKSA9PSAtMSA/ICc/JzonJicpICsgcGFyYW1zKTtcbiAgICAgICAgICAgICAgICBmb3JtLnN1Ym1pdCgpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHZhciBzdGF0ZVRpbWVyO1xuICAgICAgICAgICAgbWUuYWRkTGlzdGVuZXIoJ3NlbGVjdGlvbmNoYW5nZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoc3RhdGVUaW1lcik7XG4gICAgICAgICAgICAgICAgc3RhdGVUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZSA9IG1lLnF1ZXJ5Q29tbWFuZFN0YXRlKCdzaW1wbGV1cGxvYWQnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlID09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC5kaXNhYmxlZCA9ICdkaXNhYmxlZCc7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSwgNDAwKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaXNMb2FkZWQgPSB0cnVlO1xuICAgICAgICB9KTtcblxuICAgICAgICBidG5JZnJhbWUuc3R5bGUuY3NzVGV4dCA9IGJ0blN0eWxlO1xuICAgICAgICBjb250YWluZXJCdG4uYXBwZW5kQ2hpbGQoYnRuSWZyYW1lKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBiaW5kRXZlbnRzOntcbiAgICAgICAgICAgICdyZWFkeSc6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIC8v6K6+572ubG9hZGluZ+eahOagt+W8j1xuICAgICAgICAgICAgICAgIHV0aWxzLmNzc1J1bGUoJ2xvYWRpbmcnLFxuICAgICAgICAgICAgICAgICAgICAnLmxvYWRpbmdjbGFzc3tkaXNwbGF5OmlubGluZS1ibG9jaztjdXJzb3I6ZGVmYXVsdDtiYWNrZ3JvdW5kOiB1cmwoXFwnJ1xuICAgICAgICAgICAgICAgICAgICArIHRoaXMub3B0aW9ucy50aGVtZVBhdGhcbiAgICAgICAgICAgICAgICAgICAgKyB0aGlzLm9wdGlvbnMudGhlbWUgKycvaW1hZ2VzL2xvYWRpbmcuZ2lmXFwnKSBuby1yZXBlYXQgY2VudGVyIGNlbnRlciB0cmFuc3BhcmVudDtib3JkZXI6MXB4IHNvbGlkICNjY2NjY2M7bWFyZ2luLXJpZ2h0OjFweDtoZWlnaHQ6IDIycHg7d2lkdGg6IDIycHg7fVxcbicgK1xuICAgICAgICAgICAgICAgICAgICAnLmxvYWRlcnJvcmNsYXNze2Rpc3BsYXk6aW5saW5lLWJsb2NrO2N1cnNvcjpkZWZhdWx0O2JhY2tncm91bmQ6IHVybChcXCcnXG4gICAgICAgICAgICAgICAgICAgICsgdGhpcy5vcHRpb25zLnRoZW1lUGF0aFxuICAgICAgICAgICAgICAgICAgICArIHRoaXMub3B0aW9ucy50aGVtZSArJy9pbWFnZXMvbG9hZGVycm9yLnBuZ1xcJykgbm8tcmVwZWF0IGNlbnRlciBjZW50ZXIgdHJhbnNwYXJlbnQ7Ym9yZGVyOjFweCBzb2xpZCAjY2NjY2NjO21hcmdpbi1yaWdodDoxcHg7aGVpZ2h0OiAyMnB4O3dpZHRoOiAyMnB4OycgK1xuICAgICAgICAgICAgICAgICAgICAnfScsXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZG9jdW1lbnQpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIC8qIOWIneWni+WMlueugOWNleS4iuS8oOaMiemSriAqL1xuICAgICAgICAgICAgJ3NpbXBsZXVwbG9hZGJ0bnJlYWR5JzogZnVuY3Rpb24odHlwZSwgY29udGFpbmVyKSB7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyQnRuID0gY29udGFpbmVyO1xuICAgICAgICAgICAgICAgIG1lLmFmdGVyQ29uZmlnUmVhZHkoaW5pdFVwbG9hZEJ0bik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIG91dHB1dFJ1bGU6IGZ1bmN0aW9uKHJvb3Qpe1xuICAgICAgICAgICAgdXRpbHMuZWFjaChyb290LmdldE5vZGVzQnlUYWdOYW1lKCdpbWcnKSxmdW5jdGlvbihuKXtcbiAgICAgICAgICAgICAgICBpZiAoL1xcYihsb2FkZXJyb3JjbGFzcyl8KGJsb2FkZXJyb3JjbGFzcylcXGIvLnRlc3Qobi5nZXRBdHRyKCdjbGFzcycpKSkge1xuICAgICAgICAgICAgICAgICAgICBuLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sXG4gICAgICAgIGNvbW1hbmRzOiB7XG4gICAgICAgICAgICAnc2ltcGxldXBsb2FkJzoge1xuICAgICAgICAgICAgICAgIHF1ZXJ5Q29tbWFuZFN0YXRlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpc0xvYWRlZCA/IDA6LTE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufSk7XG5cbi8vIHBsdWdpbnMvc2VydmVycGFyYW0uanNcbi8qKlxuICog5pyN5Yqh5Zmo5o+Q5Lqk55qE6aKd5aSW5Y+C5pWw5YiX6KGo6K6+572u5o+S5Lu2XG4gKiBAZmlsZVxuICogQHNpbmNlIDEuMi42LjFcbiAqL1xuVUUucGx1Z2luLnJlZ2lzdGVyKCdzZXJ2ZXJwYXJhbScsIGZ1bmN0aW9uICgpe1xuXG4gICAgdmFyIG1lID0gdGhpcyxcbiAgICAgICAgc2VydmVyUGFyYW0gPSB7fTtcblxuICAgIHJldHVybiB7XG4gICAgICAgIGNvbW1hbmRzOntcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICog5L+u5pS55pyN5Yqh5Zmo5o+Q5Lqk55qE6aKd5aSW5Y+C5pWw5YiX6KGoLOa4hemZpOaJgOaciemhuVxuICAgICAgICAgICAgICogQGNvbW1hbmQgc2VydmVycGFyYW1cbiAgICAgICAgICAgICAqIEBtZXRob2QgZXhlY0NvbW1hbmRcbiAgICAgICAgICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcbiAgICAgICAgICAgICAqIEBleGFtcGxlXG4gICAgICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAgICAgKiBlZGl0b3IuZXhlY0NvbW1hbmQoJ3NlcnZlcnBhcmFtJyk7XG4gICAgICAgICAgICAgKiBlZGl0b3IucXVlcnlDb21tYW5kVmFsdWUoJ3NlcnZlcnBhcmFtJyk7IC8v6L+U5Zue56m6XG4gICAgICAgICAgICAgKiBgYGBcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiDkv67mlLnmnI3liqHlmajmj5DkuqTnmoTpop3lpJblj4LmlbDliJfooags5Yig6Zmk5oyH5a6a6aG5XG4gICAgICAgICAgICAgKiBAY29tbWFuZCBzZXJ2ZXJwYXJhbVxuICAgICAgICAgICAgICogQG1ldGhvZCBleGVjQ29tbWFuZFxuICAgICAgICAgICAgICogQHBhcmFtIHsgU3RyaW5nIH0gY21kIOWRveS7pOWtl+espuS4slxuICAgICAgICAgICAgICogQHBhcmFtIHsgU3RyaW5nIH0ga2V5IOimgea4hemZpOeahOWxnuaAp1xuICAgICAgICAgICAgICogQGV4YW1wbGVcbiAgICAgICAgICAgICAqIGBgYGphdmFzY3JpcHRcbiAgICAgICAgICAgICAqIGVkaXRvci5leGVjQ29tbWFuZCgnc2VydmVycGFyYW0nLCAnbmFtZScpOyAvL+WIoOmZpOWxnuaAp25hbWVcbiAgICAgICAgICAgICAqIGBgYFxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIOS/ruaUueacjeWKoeWZqOaPkOS6pOeahOmineWkluWPguaVsOWIl+ihqCzkvb/nlKjplK7lgLzmt7vliqDpoblcbiAgICAgICAgICAgICAqIEBjb21tYW5kIHNlcnZlcnBhcmFtXG4gICAgICAgICAgICAgKiBAbWV0aG9kIGV4ZWNDb21tYW5kXG4gICAgICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXG4gICAgICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBrZXkg6KaB5re75Yqg55qE5bGe5oCnXG4gICAgICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSB2YWx1ZSDopoHmt7vliqDlsZ7mgKfnmoTlgLxcbiAgICAgICAgICAgICAqIEBleGFtcGxlXG4gICAgICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAgICAgKiBlZGl0b3IuZXhlY0NvbW1hbmQoJ3NlcnZlcnBhcmFtJywgJ25hbWUnLCAnaGVsbG8nKTtcbiAgICAgICAgICAgICAqIGVkaXRvci5xdWVyeUNvbW1hbmRWYWx1ZSgnc2VydmVycGFyYW0nKTsgLy/ov5Tlm57lr7nosaEgeyduYW1lJzogJ2hlbGxvJ31cbiAgICAgICAgICAgICAqIGBgYFxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIOS/ruaUueacjeWKoeWZqOaPkOS6pOeahOmineWkluWPguaVsOWIl+ihqCzkvKDlhaXplK7lgLzlr7nlr7nosaHmt7vliqDlpJrpoblcbiAgICAgICAgICAgICAqIEBjb21tYW5kIHNlcnZlcnBhcmFtXG4gICAgICAgICAgICAgKiBAbWV0aG9kIGV4ZWNDb21tYW5kXG4gICAgICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXG4gICAgICAgICAgICAgKiBAcGFyYW0geyBPYmplY3QgfSBrZXkg5Lyg5YWl55qE6ZSu5YC85a+55a+56LGhXG4gICAgICAgICAgICAgKiBAZXhhbXBsZVxuICAgICAgICAgICAgICogYGBgamF2YXNjcmlwdFxuICAgICAgICAgICAgICogZWRpdG9yLmV4ZWNDb21tYW5kKCdzZXJ2ZXJwYXJhbScsIHsnbmFtZSc6ICdoZWxsbyd9KTtcbiAgICAgICAgICAgICAqIGVkaXRvci5xdWVyeUNvbW1hbmRWYWx1ZSgnc2VydmVycGFyYW0nKTsgLy/ov5Tlm57lr7nosaEgeyduYW1lJzogJ2hlbGxvJ31cbiAgICAgICAgICAgICAqIGBgYFxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIOS/ruaUueacjeWKoeWZqOaPkOS6pOeahOmineWkluWPguaVsOWIl+ihqCzkvb/nlKjoh6rlrprkuYnlh73mlbDmt7vliqDlpJrpoblcbiAgICAgICAgICAgICAqIEBjb21tYW5kIHNlcnZlcnBhcmFtXG4gICAgICAgICAgICAgKiBAbWV0aG9kIGV4ZWNDb21tYW5kXG4gICAgICAgICAgICAgKiBAcGFyYW0geyBTdHJpbmcgfSBjbWQg5ZG95Luk5a2X56ym5LiyXG4gICAgICAgICAgICAgKiBAcGFyYW0geyBGdW5jdGlvbiB9IGtleSDoh6rlrprkuYnojrflj5blj4LmlbDnmoTlh73mlbBcbiAgICAgICAgICAgICAqIEBleGFtcGxlXG4gICAgICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAgICAgKiBlZGl0b3IuZXhlY0NvbW1hbmQoJ3NlcnZlcnBhcmFtJywgZnVuY3Rpb24oZWRpdG9yKXtcbiAgICAgICAgICAgICAqICAgICByZXR1cm4geydrZXknOiAndmFsdWUnfTtcbiAgICAgICAgICAgICAqIH0pO1xuICAgICAgICAgICAgICogZWRpdG9yLnF1ZXJ5Q29tbWFuZFZhbHVlKCdzZXJ2ZXJwYXJhbScpOyAvL+i/lOWbnuWvueixoSB7J2tleSc6ICd2YWx1ZSd9XG4gICAgICAgICAgICAgKiBgYGBcbiAgICAgICAgICAgICAqL1xuXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIOiOt+WPluacjeWKoeWZqOaPkOS6pOeahOmineWkluWPguaVsOWIl+ihqFxuICAgICAgICAgICAgICogQGNvbW1hbmQgc2VydmVycGFyYW1cbiAgICAgICAgICAgICAqIEBtZXRob2QgcXVlcnlDb21tYW5kVmFsdWVcbiAgICAgICAgICAgICAqIEBwYXJhbSB7IFN0cmluZyB9IGNtZCDlkb3ku6TlrZfnrKbkuLJcbiAgICAgICAgICAgICAqIEBleGFtcGxlXG4gICAgICAgICAgICAgKiBgYGBqYXZhc2NyaXB0XG4gICAgICAgICAgICAgKiBlZGl0b3IucXVlcnlDb21tYW5kVmFsdWUoICdzZXJ2ZXJwYXJhbScgKTsgLy/ov5Tlm57lr7nosaEgeydrZXknOiAndmFsdWUnfVxuICAgICAgICAgICAgICogYGBgXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICdzZXJ2ZXJwYXJhbSc6e1xuICAgICAgICAgICAgICAgIGV4ZWNDb21tYW5kOmZ1bmN0aW9uIChjbWQsIGtleSwgdmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkIHx8IGtleSA9PT0gbnVsbCkgeyAvL+S4jeS8oOWPguaVsCzmuIXnqbrliJfooahcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlclBhcmFtID0ge307XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodXRpbHMuaXNTdHJpbmcoa2V5KSkgeyAvL+S8oOWFpemUruWAvFxuICAgICAgICAgICAgICAgICAgICAgICAgaWYodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBzZXJ2ZXJQYXJhbVtrZXldO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXJQYXJhbVtrZXldID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodXRpbHMuaXNPYmplY3Qoa2V5KSkgeyAvL+S8oOWFpeWvueixoSzopobnm5bliJfooajpoblcbiAgICAgICAgICAgICAgICAgICAgICAgIHV0aWxzLmV4dGVuZChzZXJ2ZXJQYXJhbSwga2V5LCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh1dGlscy5pc0Z1bmN0aW9uKGtleSkpeyAvL+S8oOWFpeWHveaVsCzmt7vliqDliJfooajpoblcbiAgICAgICAgICAgICAgICAgICAgICAgIHV0aWxzLmV4dGVuZChzZXJ2ZXJQYXJhbSwga2V5KCksIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBxdWVyeUNvbW1hbmRWYWx1ZTogZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlcnZlclBhcmFtIHx8IHt9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn0pO1xuXG5cbi8vIHBsdWdpbnMvaW5zZXJ0ZmlsZS5qc1xuLyoqXG4gKiDmj5LlhaXpmYTku7ZcbiAqL1xuVUUucGx1Z2luLnJlZ2lzdGVyKCdpbnNlcnRmaWxlJywgZnVuY3Rpb24gKCl7XG5cbiAgICB2YXIgbWUgPSB0aGlzO1xuXG4gICAgZnVuY3Rpb24gZ2V0RmlsZUljb24odXJsKXtcbiAgICAgICAgdmFyIGV4dCA9IHVybC5zdWJzdHIodXJsLmxhc3RJbmRleE9mKCcuJykgKyAxKS50b0xvd2VyQ2FzZSgpLFxuICAgICAgICAgICAgbWFwcyA9IHtcbiAgICAgICAgICAgICAgICBcInJhclwiOlwiaWNvbl9yYXIuZ2lmXCIsXG4gICAgICAgICAgICAgICAgXCJ6aXBcIjpcImljb25fcmFyLmdpZlwiLFxuICAgICAgICAgICAgICAgIFwidGFyXCI6XCJpY29uX3Jhci5naWZcIixcbiAgICAgICAgICAgICAgICBcImd6XCI6XCJpY29uX3Jhci5naWZcIixcbiAgICAgICAgICAgICAgICBcImJ6MlwiOlwiaWNvbl9yYXIuZ2lmXCIsXG4gICAgICAgICAgICAgICAgXCJkb2NcIjpcImljb25fZG9jLmdpZlwiLFxuICAgICAgICAgICAgICAgIFwiZG9jeFwiOlwiaWNvbl9kb2MuZ2lmXCIsXG4gICAgICAgICAgICAgICAgXCJwZGZcIjpcImljb25fcGRmLmdpZlwiLFxuICAgICAgICAgICAgICAgIFwibXAzXCI6XCJpY29uX21wMy5naWZcIixcbiAgICAgICAgICAgICAgICBcInhsc1wiOlwiaWNvbl94bHMuZ2lmXCIsXG4gICAgICAgICAgICAgICAgXCJjaG1cIjpcImljb25fY2htLmdpZlwiLFxuICAgICAgICAgICAgICAgIFwicHB0XCI6XCJpY29uX3BwdC5naWZcIixcbiAgICAgICAgICAgICAgICBcInBwdHhcIjpcImljb25fcHB0LmdpZlwiLFxuICAgICAgICAgICAgICAgIFwiYXZpXCI6XCJpY29uX212LmdpZlwiLFxuICAgICAgICAgICAgICAgIFwicm12YlwiOlwiaWNvbl9tdi5naWZcIixcbiAgICAgICAgICAgICAgICBcIndtdlwiOlwiaWNvbl9tdi5naWZcIixcbiAgICAgICAgICAgICAgICBcImZsdlwiOlwiaWNvbl9tdi5naWZcIixcbiAgICAgICAgICAgICAgICBcInN3ZlwiOlwiaWNvbl9tdi5naWZcIixcbiAgICAgICAgICAgICAgICBcInJtXCI6XCJpY29uX212LmdpZlwiLFxuICAgICAgICAgICAgICAgIFwiZXhlXCI6XCJpY29uX2V4ZS5naWZcIixcbiAgICAgICAgICAgICAgICBcInBzZFwiOlwiaWNvbl9wc2QuZ2lmXCIsXG4gICAgICAgICAgICAgICAgXCJ0eHRcIjpcImljb25fdHh0LmdpZlwiLFxuICAgICAgICAgICAgICAgIFwianBnXCI6XCJpY29uX2pwZy5naWZcIixcbiAgICAgICAgICAgICAgICBcInBuZ1wiOlwiaWNvbl9qcGcuZ2lmXCIsXG4gICAgICAgICAgICAgICAgXCJqcGVnXCI6XCJpY29uX2pwZy5naWZcIixcbiAgICAgICAgICAgICAgICBcImdpZlwiOlwiaWNvbl9qcGcuZ2lmXCIsXG4gICAgICAgICAgICAgICAgXCJpY29cIjpcImljb25fanBnLmdpZlwiLFxuICAgICAgICAgICAgICAgIFwiYm1wXCI6XCJpY29uX2pwZy5naWZcIlxuICAgICAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIG1hcHNbZXh0XSA/IG1hcHNbZXh0XTptYXBzWyd0eHQnXTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBjb21tYW5kczp7XG4gICAgICAgICAgICAnaW5zZXJ0ZmlsZSc6IHtcbiAgICAgICAgICAgICAgICBleGVjQ29tbWFuZDogZnVuY3Rpb24gKGNvbW1hbmQsIGZpbGVsaXN0KXtcbiAgICAgICAgICAgICAgICAgICAgZmlsZWxpc3QgPSB1dGlscy5pc0FycmF5KGZpbGVsaXN0KSA/IGZpbGVsaXN0IDogW2ZpbGVsaXN0XTtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgaSwgaXRlbSwgaWNvbiwgdGl0bGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBodG1sID0gJycsXG4gICAgICAgICAgICAgICAgICAgICAgICBVUkwgPSBtZS5nZXRPcHQoJ1VFRElUT1JfSE9NRV9VUkwnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGljb25EaXIgPSBVUkwgKyAoVVJMLnN1YnN0cihVUkwubGVuZ3RoIC0gMSkgPT0gJy8nID8gJyc6Jy8nKSArICdkaWFsb2dzL2F0dGFjaG1lbnQvZmlsZVR5cGVJbWFnZXMvJztcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGZpbGVsaXN0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtID0gZmlsZWxpc3RbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICBpY29uID0gaWNvbkRpciArIGdldEZpbGVJY29uKGl0ZW0udXJsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlID0gaXRlbS50aXRsZSB8fCBpdGVtLnVybC5zdWJzdHIoaXRlbS51cmwubGFzdEluZGV4T2YoJy8nKSArIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaHRtbCArPSAnPHAgc3R5bGU9XCJsaW5lLWhlaWdodDogMTZweDtcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGltZyBzdHlsZT1cInZlcnRpY2FsLWFsaWduOiBtaWRkbGU7IG1hcmdpbi1yaWdodDogMnB4O1wiIHNyYz1cIicrIGljb24gKyAnXCIgX3NyYz1cIicgKyBpY29uICsgJ1wiIC8+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxhIHN0eWxlPVwiZm9udC1zaXplOjEycHg7IGNvbG9yOiMwMDY2Y2M7XCIgaHJlZj1cIicgKyBpdGVtLnVybCArJ1wiIHRpdGxlPVwiJyArIHRpdGxlICsgJ1wiPicgKyB0aXRsZSArICc8L2E+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvcD4nO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIG1lLmV4ZWNDb21tYW5kKCdpbnNlcnRIdG1sJywgaHRtbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufSk7XG5cblxuXG5cbi8vIHBsdWdpbnMveHNzRmlsdGVyLmpzXG4vKipcbiAqIEBmaWxlIHhzc0ZpbHRlci5qc1xuICogQGRlc2MgeHNz6L+H5ruk5ZmoXG4gKiBAYXV0aG9yIHJvYmJlbm11XG4gKi9cblxuVUUucGx1Z2lucy54c3NGaWx0ZXIgPSBmdW5jdGlvbigpIHtcblxuXHR2YXIgY29uZmlnID0gVUVESVRPUl9DT05GSUc7XG5cdHZhciB3aGl0TGlzdCA9IGNvbmZpZy53aGl0TGlzdDtcblxuXHRmdW5jdGlvbiBmaWx0ZXIobm9kZSkge1xuXG5cdFx0dmFyIHRhZ05hbWUgPSBub2RlLnRhZ05hbWU7XG5cdFx0dmFyIGF0dHJzID0gbm9kZS5hdHRycztcblxuXHRcdGlmICghd2hpdExpc3QuaGFzT3duUHJvcGVydHkodGFnTmFtZSkpIHtcblx0XHRcdG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTtcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cblx0XHRVRS51dGlscy5lYWNoKGF0dHJzLCBmdW5jdGlvbiAodmFsLCBrZXkpIHtcblxuXHRcdFx0aWYgKHdoaXRMaXN0W3RhZ05hbWVdLmluZGV4T2Yoa2V5KSA9PT0gLTEpIHtcblx0XHRcdFx0bm9kZS5zZXRBdHRyKGtleSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHQvLyDmt7vliqBpbnNlcnRodG1sXFxwYXN0ZeetieaTjeS9nOeUqOeahOi/h+a7pOinhOWImVxuXHRpZiAod2hpdExpc3QgJiYgY29uZmlnLnhzc0ZpbHRlclJ1bGVzKSB7XG5cdFx0dGhpcy5vcHRpb25zLmZpbHRlclJ1bGVzID0gZnVuY3Rpb24gKCkge1xuXG5cdFx0XHR2YXIgcmVzdWx0ID0ge307XG5cblx0XHRcdFVFLnV0aWxzLmVhY2god2hpdExpc3QsIGZ1bmN0aW9uKHZhbCwga2V5KSB7XG5cdFx0XHRcdHJlc3VsdFtrZXldID0gZnVuY3Rpb24gKG5vZGUpIHtcblx0XHRcdFx0XHRyZXR1cm4gZmlsdGVyKG5vZGUpO1xuXHRcdFx0XHR9O1xuXHRcdFx0fSk7XG5cblx0XHRcdHJldHVybiByZXN1bHQ7XG5cdFx0fSgpO1xuXHR9XG5cblx0dmFyIHRhZ0xpc3QgPSBbXTtcblxuXHRVRS51dGlscy5lYWNoKHdoaXRMaXN0LCBmdW5jdGlvbiAodmFsLCBrZXkpIHtcblx0XHR0YWdMaXN0LnB1c2goa2V5KTtcblx0fSk7XG5cblx0Ly8g5re75YqgaW5wdXTov4fmu6Top4TliJlcblx0Ly9cblx0aWYgKHdoaXRMaXN0ICYmIGNvbmZpZy5pbnB1dFhzc0ZpbHRlcikge1xuXHRcdHRoaXMuYWRkSW5wdXRSdWxlKGZ1bmN0aW9uIChyb290KSB7XG5cblx0XHRcdHJvb3QudHJhdmVyc2FsKGZ1bmN0aW9uKG5vZGUpIHtcblx0XHRcdFx0aWYgKG5vZGUudHlwZSAhPT0gJ2VsZW1lbnQnKSB7XG5cdFx0XHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGZpbHRlcihub2RlKTtcblx0XHRcdH0pO1xuXHRcdH0pO1xuXHR9XG5cdC8vIOa3u+WKoG91dHB1dOi/h+a7pOinhOWImVxuXHQvL1xuXHRpZiAod2hpdExpc3QgJiYgY29uZmlnLm91dHB1dFhzc0ZpbHRlcikge1xuXHRcdHRoaXMuYWRkT3V0cHV0UnVsZShmdW5jdGlvbiAocm9vdCkge1xuXG5cdFx0XHRyb290LnRyYXZlcnNhbChmdW5jdGlvbihub2RlKSB7XG5cdFx0XHRcdGlmIChub2RlLnR5cGUgIT09ICdlbGVtZW50Jykge1xuXHRcdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdFx0fVxuXHRcdFx0XHRmaWx0ZXIobm9kZSk7XG5cdFx0XHR9KTtcblx0XHR9KTtcblx0fVxuXG59O1xuXG5cbi8vIHVpL3VpLmpzXG52YXIgYmFpZHUgPSBiYWlkdSB8fCB7fTtcclxuYmFpZHUuZWRpdG9yID0gYmFpZHUuZWRpdG9yIHx8IHt9O1xyXG5VRS51aSA9IGJhaWR1LmVkaXRvci51aSA9IHt9O1xuXG4vLyB1aS91aXV0aWxzLmpzXG4oZnVuY3Rpb24gKCl7XHJcbiAgICB2YXIgYnJvd3NlciA9IGJhaWR1LmVkaXRvci5icm93c2VyLFxyXG4gICAgICAgIGRvbVV0aWxzID0gYmFpZHUuZWRpdG9yLmRvbS5kb21VdGlscztcclxuXHJcbiAgICB2YXIgbWFnaWMgPSAnJEVESVRPUlVJJztcclxuICAgIHZhciByb290ID0gd2luZG93W21hZ2ljXSA9IHt9O1xyXG4gICAgdmFyIHVpZE1hZ2ljID0gJ0lEJyArIG1hZ2ljO1xyXG4gICAgdmFyIHVpZENvdW50ID0gMDtcclxuXHJcbiAgICB2YXIgdWlVdGlscyA9IGJhaWR1LmVkaXRvci51aS51aVV0aWxzID0ge1xyXG4gICAgICAgIHVpZDogZnVuY3Rpb24gKG9iail7XHJcbiAgICAgICAgICAgIHJldHVybiAob2JqID8gb2JqW3VpZE1hZ2ljXSB8fCAob2JqW3VpZE1hZ2ljXSA9ICsrIHVpZENvdW50KSA6ICsrIHVpZENvdW50KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGhvb2s6IGZ1bmN0aW9uICggZm4sIGNhbGxiYWNrICkge1xyXG4gICAgICAgICAgICB2YXIgZGc7XHJcbiAgICAgICAgICAgIGlmIChmbiAmJiBmbi5fY2FsbGJhY2tzKSB7XHJcbiAgICAgICAgICAgICAgICBkZyA9IGZuO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZGcgPSBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZm4pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcSA9IGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja3MgPSBkZy5fY2FsbGJhY2tzO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBrID0gY2FsbGJhY2tzLmxlbmd0aDtcclxuICAgICAgICAgICAgICAgICAgICB3aGlsZSAoayAtLSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgciA9IGNhbGxiYWNrc1trXS5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBxID0gcjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcTtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBkZy5fY2FsbGJhY2tzID0gW107XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZGcuX2NhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgcmV0dXJuIGRnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY3JlYXRlRWxlbWVudEJ5SHRtbDogZnVuY3Rpb24gKGh0bWwpe1xyXG4gICAgICAgICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICAgICAgZWwuaW5uZXJIVE1MID0gaHRtbDtcclxuICAgICAgICAgICAgZWwgPSBlbC5maXJzdENoaWxkO1xyXG4gICAgICAgICAgICBlbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsKTtcclxuICAgICAgICAgICAgcmV0dXJuIGVsO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0Vmlld3BvcnRFbGVtZW50OiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgcmV0dXJuIChicm93c2VyLmllICYmIGJyb3dzZXIucXVpcmtzKSA/XHJcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5IDogZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50O1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0Q2xpZW50UmVjdDogZnVuY3Rpb24gKGVsZW1lbnQpe1xyXG4gICAgICAgICAgICB2YXIgYmNyO1xyXG4gICAgICAgICAgICAvL3RyYWNlICBJRTbkuIvlnKjmjqfliLbnvJbovpHlmajmmL7pmpDml7blj6/og73kvJrmiqXplJnvvIxjYXRjaOS4gOS4i1xyXG4gICAgICAgICAgICB0cnl7XHJcbiAgICAgICAgICAgICAgICBiY3IgPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgICAgICB9Y2F0Y2goZSl7XHJcbiAgICAgICAgICAgICAgICBiY3I9e2xlZnQ6MCx0b3A6MCxoZWlnaHQ6MCx3aWR0aDowfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciByZWN0ID0ge1xyXG4gICAgICAgICAgICAgICAgbGVmdDogTWF0aC5yb3VuZChiY3IubGVmdCksXHJcbiAgICAgICAgICAgICAgICB0b3A6IE1hdGgucm91bmQoYmNyLnRvcCksXHJcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IE1hdGgucm91bmQoYmNyLmJvdHRvbSAtIGJjci50b3ApLFxyXG4gICAgICAgICAgICAgICAgd2lkdGg6IE1hdGgucm91bmQoYmNyLnJpZ2h0IC0gYmNyLmxlZnQpXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHZhciBkb2M7XHJcbiAgICAgICAgICAgIHdoaWxlICgoZG9jID0gZWxlbWVudC5vd25lckRvY3VtZW50KSAhPT0gZG9jdW1lbnQgJiZcclxuICAgICAgICAgICAgICAgIChlbGVtZW50ID0gZG9tVXRpbHMuZ2V0V2luZG93KGRvYykuZnJhbWVFbGVtZW50KSkge1xyXG4gICAgICAgICAgICAgICAgYmNyID0gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICAgICAgICAgIHJlY3QubGVmdCArPSBiY3IubGVmdDtcclxuICAgICAgICAgICAgICAgIHJlY3QudG9wICs9IGJjci50b3A7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmVjdC5ib3R0b20gPSByZWN0LnRvcCArIHJlY3QuaGVpZ2h0O1xyXG4gICAgICAgICAgICByZWN0LnJpZ2h0ID0gcmVjdC5sZWZ0ICsgcmVjdC53aWR0aDtcclxuICAgICAgICAgICAgcmV0dXJuIHJlY3Q7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRWaWV3cG9ydFJlY3Q6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICB2YXIgdmlld3BvcnRFbCA9IHVpVXRpbHMuZ2V0Vmlld3BvcnRFbGVtZW50KCk7XHJcbiAgICAgICAgICAgIHZhciB3aWR0aCA9ICh3aW5kb3cuaW5uZXJXaWR0aCB8fCB2aWV3cG9ydEVsLmNsaWVudFdpZHRoKSB8IDA7XHJcbiAgICAgICAgICAgIHZhciBoZWlnaHQgPSAod2luZG93LmlubmVySGVpZ2h0IHx8dmlld3BvcnRFbC5jbGllbnRIZWlnaHQpIHwgMDtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIGxlZnQ6IDAsXHJcbiAgICAgICAgICAgICAgICB0b3A6IDAsXHJcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IGhlaWdodCxcclxuICAgICAgICAgICAgICAgIHdpZHRoOiB3aWR0aCxcclxuICAgICAgICAgICAgICAgIGJvdHRvbTogaGVpZ2h0LFxyXG4gICAgICAgICAgICAgICAgcmlnaHQ6IHdpZHRoXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXRWaWV3cG9ydE9mZnNldDogZnVuY3Rpb24gKGVsZW1lbnQsIG9mZnNldCl7XHJcbiAgICAgICAgICAgIHZhciByZWN0O1xyXG4gICAgICAgICAgICB2YXIgZml4ZWRMYXllciA9IHVpVXRpbHMuZ2V0Rml4ZWRMYXllcigpO1xyXG4gICAgICAgICAgICBpZiAoZWxlbWVudC5wYXJlbnROb2RlID09PSBmaXhlZExheWVyKSB7XHJcbiAgICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlLmxlZnQgPSBvZmZzZXQubGVmdCArICdweCc7XHJcbiAgICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlLnRvcCA9IG9mZnNldC50b3AgKyAncHgnO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMuc2V0Vmlld3BvcnRPZmZzZXQoZWxlbWVudCwgb2Zmc2V0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0RXZlbnRPZmZzZXQ6IGZ1bmN0aW9uIChldnQpe1xyXG4gICAgICAgICAgICB2YXIgZWwgPSBldnQudGFyZ2V0IHx8IGV2dC5zcmNFbGVtZW50O1xyXG4gICAgICAgICAgICB2YXIgcmVjdCA9IHVpVXRpbHMuZ2V0Q2xpZW50UmVjdChlbCk7XHJcbiAgICAgICAgICAgIHZhciBvZmZzZXQgPSB1aVV0aWxzLmdldFZpZXdwb3J0T2Zmc2V0QnlFdmVudChldnQpO1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgbGVmdDogb2Zmc2V0LmxlZnQgLSByZWN0LmxlZnQsXHJcbiAgICAgICAgICAgICAgICB0b3A6IG9mZnNldC50b3AgLSByZWN0LnRvcFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0Vmlld3BvcnRPZmZzZXRCeUV2ZW50OiBmdW5jdGlvbiAoZXZ0KXtcclxuICAgICAgICAgICAgdmFyIGVsID0gZXZ0LnRhcmdldCB8fCBldnQuc3JjRWxlbWVudDtcclxuICAgICAgICAgICAgdmFyIGZyYW1lRWwgPSBkb21VdGlscy5nZXRXaW5kb3coZWwpLmZyYW1lRWxlbWVudDtcclxuICAgICAgICAgICAgdmFyIG9mZnNldCA9IHtcclxuICAgICAgICAgICAgICAgIGxlZnQ6IGV2dC5jbGllbnRYLFxyXG4gICAgICAgICAgICAgICAgdG9wOiBldnQuY2xpZW50WVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBpZiAoZnJhbWVFbCAmJiBlbC5vd25lckRvY3VtZW50ICE9PSBkb2N1bWVudCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlY3QgPSB1aVV0aWxzLmdldENsaWVudFJlY3QoZnJhbWVFbCk7XHJcbiAgICAgICAgICAgICAgICBvZmZzZXQubGVmdCArPSByZWN0LmxlZnQ7XHJcbiAgICAgICAgICAgICAgICBvZmZzZXQudG9wICs9IHJlY3QudG9wO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBvZmZzZXQ7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXRHbG9iYWw6IGZ1bmN0aW9uIChpZCwgb2JqKXtcclxuICAgICAgICAgICAgcm9vdFtpZF0gPSBvYmo7XHJcbiAgICAgICAgICAgIHJldHVybiBtYWdpYyArICdbXCInICsgaWQgICsgJ1wiXSc7XHJcbiAgICAgICAgfSxcclxuICAgICAgICB1bnNldEdsb2JhbDogZnVuY3Rpb24gKGlkKXtcclxuICAgICAgICAgICAgZGVsZXRlIHJvb3RbaWRdO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY29weUF0dHJpYnV0ZXM6IGZ1bmN0aW9uICh0Z3QsIHNyYyl7XHJcbiAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVzID0gc3JjLmF0dHJpYnV0ZXM7XHJcbiAgICAgICAgICAgIHZhciBrID0gYXR0cmlidXRlcy5sZW5ndGg7XHJcbiAgICAgICAgICAgIHdoaWxlIChrIC0tKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYXR0ck5vZGUgPSBhdHRyaWJ1dGVzW2tdO1xyXG4gICAgICAgICAgICAgICAgaWYgKCBhdHRyTm9kZS5ub2RlTmFtZSAhPSAnc3R5bGUnICYmIGF0dHJOb2RlLm5vZGVOYW1lICE9ICdjbGFzcycgJiYgKCFicm93c2VyLmllIHx8IGF0dHJOb2RlLnNwZWNpZmllZCkgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGd0LnNldEF0dHJpYnV0ZShhdHRyTm9kZS5ub2RlTmFtZSwgYXR0ck5vZGUubm9kZVZhbHVlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoc3JjLmNsYXNzTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMuYWRkQ2xhc3ModGd0LHNyYy5jbGFzc05hbWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChzcmMuc3R5bGUuY3NzVGV4dCkge1xyXG4gICAgICAgICAgICAgICAgdGd0LnN0eWxlLmNzc1RleHQgKz0gJzsnICsgc3JjLnN0eWxlLmNzc1RleHQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIHJlbW92ZVN0eWxlOiBmdW5jdGlvbiAoZWwsIHN0eWxlTmFtZSl7XHJcbiAgICAgICAgICAgIGlmIChlbC5zdHlsZS5yZW1vdmVQcm9wZXJ0eSkge1xyXG4gICAgICAgICAgICAgICAgZWwuc3R5bGUucmVtb3ZlUHJvcGVydHkoc3R5bGVOYW1lKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChlbC5zdHlsZS5yZW1vdmVBdHRyaWJ1dGUpIHtcclxuICAgICAgICAgICAgICAgIGVsLnN0eWxlLnJlbW92ZUF0dHJpYnV0ZShzdHlsZU5hbWUpO1xyXG4gICAgICAgICAgICB9IGVsc2UgdGhyb3cgJyc7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBjb250YWluczogZnVuY3Rpb24gKGVsQSwgZWxCKXtcclxuICAgICAgICAgICAgcmV0dXJuIGVsQSAmJiBlbEIgJiYgKGVsQSA9PT0gZWxCID8gZmFsc2UgOiAoXHJcbiAgICAgICAgICAgICAgICBlbEEuY29udGFpbnMgPyBlbEEuY29udGFpbnMoZWxCKSA6XHJcbiAgICAgICAgICAgICAgICAgICAgZWxBLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGVsQikgJiAxNlxyXG4gICAgICAgICAgICAgICAgKSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzdGFydERyYWc6IGZ1bmN0aW9uIChldnQsIGNhbGxiYWNrcyxkb2Mpe1xyXG4gICAgICAgICAgICB2YXIgZG9jID0gZG9jIHx8IGRvY3VtZW50O1xyXG4gICAgICAgICAgICB2YXIgc3RhcnRYID0gZXZ0LmNsaWVudFg7XHJcbiAgICAgICAgICAgIHZhciBzdGFydFkgPSBldnQuY2xpZW50WTtcclxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlTW91c2VNb3ZlKGV2dCl7XHJcbiAgICAgICAgICAgICAgICB2YXIgeCA9IGV2dC5jbGllbnRYIC0gc3RhcnRYO1xyXG4gICAgICAgICAgICAgICAgdmFyIHkgPSBldnQuY2xpZW50WSAtIHN0YXJ0WTtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbmRyYWdtb3ZlKHgsIHksZXZ0KTtcclxuICAgICAgICAgICAgICAgIGlmIChldnQuc3RvcFByb3BhZ2F0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBldnQuY2FuY2VsQnViYmxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoZG9jLmFkZEV2ZW50TGlzdGVuZXIpIHtcclxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZU1vdXNlVXAoZXZ0KXtcclxuICAgICAgICAgICAgICAgICAgICBkb2MucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlTW91c2VNb3ZlLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICBkb2MucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGhhbmRsZU1vdXNlVXAsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlTW91c2VVcCwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uZHJhZ3N0b3AoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBoYW5kbGVNb3VzZU1vdmUsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVNb3VzZVVwLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlTW91c2VVcCwgdHJ1ZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgZWxtID0gZXZ0LnNyY0VsZW1lbnQ7XHJcbiAgICAgICAgICAgICAgICBlbG0uc2V0Q2FwdHVyZSgpO1xyXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVsZWFzZUNhcHRydWUoKXtcclxuICAgICAgICAgICAgICAgICAgICBlbG0ucmVsZWFzZUNhcHR1cmUoKTtcclxuICAgICAgICAgICAgICAgICAgICBlbG0uZGV0YWNoRXZlbnQoJ29ubW91c2Vtb3ZlJywgaGFuZGxlTW91c2VNb3ZlKTtcclxuICAgICAgICAgICAgICAgICAgICBlbG0uZGV0YWNoRXZlbnQoJ29ubW91c2V1cCcsIHJlbGVhc2VDYXB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICBlbG0uZGV0YWNoRXZlbnQoJ29ubG9zZWNhcHRydWUnLCByZWxlYXNlQ2FwdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uZHJhZ3N0b3AoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsbS5hdHRhY2hFdmVudCgnb25tb3VzZW1vdmUnLCBoYW5kbGVNb3VzZU1vdmUpO1xyXG4gICAgICAgICAgICAgICAgZWxtLmF0dGFjaEV2ZW50KCdvbm1vdXNldXAnLCByZWxlYXNlQ2FwdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBlbG0uYXR0YWNoRXZlbnQoJ29ubG9zZWNhcHRydWUnLCByZWxlYXNlQ2FwdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBldnQucmV0dXJuVmFsdWUgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYWxsYmFja3Mub25kcmFnc3RhcnQoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldEZpeGVkTGF5ZXI6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICB2YXIgbGF5ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZWR1aV9maXhlZGxheWVyJyk7XHJcbiAgICAgICAgICAgIGlmIChsYXllciA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBsYXllciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgICAgICAgICAgbGF5ZXIuaWQgPSAnZWR1aV9maXhlZGxheWVyJztcclxuICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobGF5ZXIpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGJyb3dzZXIuaWUgJiYgYnJvd3Nlci52ZXJzaW9uIDw9IDgpIHtcclxuICAgICAgICAgICAgICAgICAgICBsYXllci5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7XHJcbiAgICAgICAgICAgICAgICAgICAgYmluZEZpeGVkTGF5ZXIoKTtcclxuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KHVwZGF0ZUZpeGVkT2Zmc2V0KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGF5ZXIuc3R5bGUucG9zaXRpb24gPSAnZml4ZWQnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbGF5ZXIuc3R5bGUubGVmdCA9ICcwJztcclxuICAgICAgICAgICAgICAgIGxheWVyLnN0eWxlLnRvcCA9ICcwJztcclxuICAgICAgICAgICAgICAgIGxheWVyLnN0eWxlLndpZHRoID0gJzAnO1xyXG4gICAgICAgICAgICAgICAgbGF5ZXIuc3R5bGUuaGVpZ2h0ID0gJzAnO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBsYXllcjtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG1ha2VVbnNlbGVjdGFibGU6IGZ1bmN0aW9uIChlbGVtZW50KXtcclxuICAgICAgICAgICAgaWYgKGJyb3dzZXIub3BlcmEgfHwgKGJyb3dzZXIuaWUgJiYgYnJvd3Nlci52ZXJzaW9uIDwgOSkpIHtcclxuICAgICAgICAgICAgICAgIGVsZW1lbnQudW5zZWxlY3RhYmxlID0gJ29uJztcclxuICAgICAgICAgICAgICAgIGlmIChlbGVtZW50Lmhhc0NoaWxkTm9kZXMoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MDsgaTxlbGVtZW50LmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuY2hpbGROb2Rlc1tpXS5ub2RlVHlwZSA9PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aVV0aWxzLm1ha2VVbnNlbGVjdGFibGUoZWxlbWVudC5jaGlsZE5vZGVzW2ldKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LnN0eWxlLk1velVzZXJTZWxlY3QgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUuTW96VXNlclNlbGVjdCA9ICdub25lJztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5zdHlsZS5XZWJraXRVc2VyU2VsZWN0ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlLldlYmtpdFVzZXJTZWxlY3QgPSAnbm9uZSc7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuc3R5bGUuS2h0bWxVc2VyU2VsZWN0ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlLktodG1sVXNlclNlbGVjdCA9ICdub25lJztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBmdW5jdGlvbiB1cGRhdGVGaXhlZE9mZnNldCgpe1xyXG4gICAgICAgIHZhciBsYXllciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlZHVpX2ZpeGVkbGF5ZXInKTtcclxuICAgICAgICB1aVV0aWxzLnNldFZpZXdwb3J0T2Zmc2V0KGxheWVyLCB7XHJcbiAgICAgICAgICAgIGxlZnQ6IDAsXHJcbiAgICAgICAgICAgIHRvcDogMFxyXG4gICAgICAgIH0pO1xyXG4vLyAgICAgICAgbGF5ZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuLy8gICAgICAgIGxheWVyLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xyXG5cclxuICAgICAgICAvLyN0cmFjZTogMTM1NFxyXG4vLyAgICAgICAgc2V0VGltZW91dCh1cGRhdGVGaXhlZE9mZnNldCk7XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiBiaW5kRml4ZWRMYXllcihhZGpPZmZzZXQpe1xyXG4gICAgICAgIGRvbVV0aWxzLm9uKHdpbmRvdywgJ3Njcm9sbCcsIHVwZGF0ZUZpeGVkT2Zmc2V0KTtcclxuICAgICAgICBkb21VdGlscy5vbih3aW5kb3csICdyZXNpemUnLCBiYWlkdS5lZGl0b3IudXRpbHMuZGVmZXIodXBkYXRlRml4ZWRPZmZzZXQsIDAsIHRydWUpKTtcclxuICAgIH1cclxufSkoKTtcclxuXG5cbi8vIHVpL3VpYmFzZS5qc1xuKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciB1dGlscyA9IGJhaWR1LmVkaXRvci51dGlscyxcclxuICAgICAgICB1aVV0aWxzID0gYmFpZHUuZWRpdG9yLnVpLnVpVXRpbHMsXHJcbiAgICAgICAgRXZlbnRCYXNlID0gYmFpZHUuZWRpdG9yLkV2ZW50QmFzZSxcclxuICAgICAgICBVSUJhc2UgPSBiYWlkdS5lZGl0b3IudWkuVUlCYXNlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgVUlCYXNlLnByb3RvdHlwZSA9IHtcclxuICAgICAgICBjbGFzc05hbWU6JycsXHJcbiAgICAgICAgdWlOYW1lOicnLFxyXG4gICAgICAgIGluaXRPcHRpb25zOmZ1bmN0aW9uIChvcHRpb25zKSB7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGsgaW4gb3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgbWVba10gPSBvcHRpb25zW2tdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuaWQgPSB0aGlzLmlkIHx8ICdlZHVpJyArIHVpVXRpbHMudWlkKCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBpbml0VUlCYXNlOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdGhpcy5fZ2xvYmFsS2V5ID0gdXRpbHMudW5odG1sKHVpVXRpbHMuc2V0R2xvYmFsKHRoaXMuaWQsIHRoaXMpKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHJlbmRlcjpmdW5jdGlvbiAoaG9sZGVyKSB7XHJcbiAgICAgICAgICAgIHZhciBodG1sID0gdGhpcy5yZW5kZXJIdG1sKCk7XHJcbiAgICAgICAgICAgIHZhciBlbCA9IHVpVXRpbHMuY3JlYXRlRWxlbWVudEJ5SHRtbChodG1sKTtcclxuXHJcbiAgICAgICAgICAgIC8vYnkgeHVoZW5nIOe7meavj+S4qm5vZGXmt7vliqBjbGFzc1xyXG4gICAgICAgICAgICB2YXIgbGlzdCA9IGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKGVsLCBcIipcIik7XHJcbiAgICAgICAgICAgIHZhciB0aGVtZSA9IFwiZWR1aS1cIiArICh0aGlzLnRoZW1lIHx8IHRoaXMuZWRpdG9yLm9wdGlvbnMudGhlbWUpO1xyXG4gICAgICAgICAgICB2YXIgbGF5ZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZWR1aV9maXhlZGxheWVyJyk7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBub2RlOyBub2RlID0gbGlzdFtpKytdOykge1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMuYWRkQ2xhc3Mobm9kZSwgdGhlbWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLmFkZENsYXNzKGVsLCB0aGVtZSk7XHJcbiAgICAgICAgICAgIGlmKGxheWVyKXtcclxuICAgICAgICAgICAgICAgIGxheWVyLmNsYXNzTmFtZT1cIlwiO1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMuYWRkQ2xhc3MobGF5ZXIsdGhlbWUpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB2YXIgc2VhdEVsID0gdGhpcy5nZXREb20oKTtcclxuICAgICAgICAgICAgaWYgKHNlYXRFbCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBzZWF0RWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoZWwsIHNlYXRFbCk7XHJcbiAgICAgICAgICAgICAgICB1aVV0aWxzLmNvcHlBdHRyaWJ1dGVzKGVsLCBzZWF0RWwpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBob2xkZXIgPT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgICAgICAgICBob2xkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChob2xkZXIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaG9sZGVyID0gaG9sZGVyIHx8IHVpVXRpbHMuZ2V0Rml4ZWRMYXllcigpO1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMuYWRkQ2xhc3MoaG9sZGVyLCB0aGVtZSk7XHJcbiAgICAgICAgICAgICAgICBob2xkZXIuYXBwZW5kQ2hpbGQoZWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMucG9zdFJlbmRlcigpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0RG9tOmZ1bmN0aW9uIChuYW1lKSB7XHJcbiAgICAgICAgICAgIGlmICghbmFtZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuaWQpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuaWQgKyAnXycgKyBuYW1lKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcG9zdFJlbmRlcjpmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdwb3N0cmVuZGVyJyk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRIdG1sVHBsOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZm9ybWF0SHRtbDpmdW5jdGlvbiAodHBsKSB7XHJcbiAgICAgICAgICAgIHZhciBwcmVmaXggPSAnZWR1aS0nICsgdGhpcy51aU5hbWU7XHJcbiAgICAgICAgICAgIHJldHVybiAodHBsXHJcbiAgICAgICAgICAgICAgICAucmVwbGFjZSgvIyMvZywgdGhpcy5pZClcclxuICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8lJS0vZywgdGhpcy51aU5hbWUgPyBwcmVmaXggKyAnLScgOiAnJylcclxuICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8lJS9nLCAodGhpcy51aU5hbWUgPyBwcmVmaXggOiAnJykgKyAnICcgKyB0aGlzLmNsYXNzTmFtZSlcclxuICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCRcXCQvZywgdGhpcy5fZ2xvYmFsS2V5KSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICByZW5kZXJIdG1sOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0SHRtbCh0aGlzLmdldEh0bWxUcGwoKSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBkaXNwb3NlOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGJveCA9IHRoaXMuZ2V0RG9tKCk7XHJcbiAgICAgICAgICAgIGlmIChib3gpIGJhaWR1LmVkaXRvci5kb20uZG9tVXRpbHMucmVtb3ZlKGJveCk7XHJcbiAgICAgICAgICAgIHVpVXRpbHMudW5zZXRHbG9iYWwodGhpcy5pZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHV0aWxzLmluaGVyaXRzKFVJQmFzZSwgRXZlbnRCYXNlKTtcclxufSkoKTtcclxuXG5cbi8vIHVpL3NlcGFyYXRvci5qc1xuKGZ1bmN0aW9uICgpe1xyXG4gICAgdmFyIHV0aWxzID0gYmFpZHUuZWRpdG9yLnV0aWxzLFxyXG4gICAgICAgIFVJQmFzZSA9IGJhaWR1LmVkaXRvci51aS5VSUJhc2UsXHJcbiAgICAgICAgU2VwYXJhdG9yID0gYmFpZHUuZWRpdG9yLnVpLlNlcGFyYXRvciA9IGZ1bmN0aW9uIChvcHRpb25zKXtcclxuICAgICAgICAgICAgdGhpcy5pbml0T3B0aW9ucyhvcHRpb25zKTtcclxuICAgICAgICAgICAgdGhpcy5pbml0U2VwYXJhdG9yKCk7XHJcbiAgICAgICAgfTtcclxuICAgIFNlcGFyYXRvci5wcm90b3R5cGUgPSB7XHJcbiAgICAgICAgdWlOYW1lOiAnc2VwYXJhdG9yJyxcclxuICAgICAgICBpbml0U2VwYXJhdG9yOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgdGhpcy5pbml0VUlCYXNlKCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRIdG1sVHBsOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgcmV0dXJuICc8ZGl2IGlkPVwiIyNcIiBjbGFzcz1cImVkdWktYm94ICUlXCI+PC9kaXY+JztcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgdXRpbHMuaW5oZXJpdHMoU2VwYXJhdG9yLCBVSUJhc2UpO1xyXG5cclxufSkoKTtcclxuXG5cbi8vIHVpL21hc2suanNcbi8vL2ltcG9ydCBjb3JlXHJcbi8vL2ltcG9ydCB1aWNvcmVcclxuKGZ1bmN0aW9uICgpe1xyXG4gICAgdmFyIHV0aWxzID0gYmFpZHUuZWRpdG9yLnV0aWxzLFxyXG4gICAgICAgIGRvbVV0aWxzID0gYmFpZHUuZWRpdG9yLmRvbS5kb21VdGlscyxcclxuICAgICAgICBVSUJhc2UgPSBiYWlkdS5lZGl0b3IudWkuVUlCYXNlLFxyXG4gICAgICAgIHVpVXRpbHMgPSBiYWlkdS5lZGl0b3IudWkudWlVdGlscztcclxuICAgIFxyXG4gICAgdmFyIE1hc2sgPSBiYWlkdS5lZGl0b3IudWkuTWFzayA9IGZ1bmN0aW9uIChvcHRpb25zKXtcclxuICAgICAgICB0aGlzLmluaXRPcHRpb25zKG9wdGlvbnMpO1xyXG4gICAgICAgIHRoaXMuaW5pdFVJQmFzZSgpO1xyXG4gICAgfTtcclxuICAgIE1hc2sucHJvdG90eXBlID0ge1xyXG4gICAgICAgIGdldEh0bWxUcGw6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICByZXR1cm4gJzxkaXYgaWQ9XCIjI1wiIGNsYXNzPVwiZWR1aS1tYXNrICUlXCIgb25jbGljaz1cInJldHVybiAkJC5fb25DbGljayhldmVudCwgdGhpcyk7XCIgb25tb3VzZWRvd249XCJyZXR1cm4gJCQuX29uTW91c2VEb3duKGV2ZW50LCB0aGlzKTtcIj48L2Rpdj4nO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLm9uKHdpbmRvdywgJ3Jlc2l6ZScsIGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIW1lLmlzSGlkZGVuKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuX2ZpbGwoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzaG93OiBmdW5jdGlvbiAoekluZGV4KXtcclxuICAgICAgICAgICAgdGhpcy5fZmlsbCgpO1xyXG4gICAgICAgICAgICB0aGlzLmdldERvbSgpLnN0eWxlLmRpc3BsYXkgPSAnJztcclxuICAgICAgICAgICAgdGhpcy5nZXREb20oKS5zdHlsZS56SW5kZXggPSB6SW5kZXg7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBoaWRlOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgdGhpcy5nZXREb20oKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xyXG4gICAgICAgICAgICB0aGlzLmdldERvbSgpLnN0eWxlLnpJbmRleCA9ICcnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgaXNIaWRkZW46IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREb20oKS5zdHlsZS5kaXNwbGF5ID09ICdub25lJztcclxuICAgICAgICB9LFxyXG4gICAgICAgIF9vbk1vdXNlRG93bjogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIF9vbkNsaWNrOiBmdW5jdGlvbiAoZSwgdGFyZ2V0KXtcclxuICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2NsaWNrJywgZSwgdGFyZ2V0KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIF9maWxsOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgdmFyIGVsID0gdGhpcy5nZXREb20oKTtcclxuICAgICAgICAgICAgdmFyIHZwUmVjdCA9IHVpVXRpbHMuZ2V0Vmlld3BvcnRSZWN0KCk7XHJcbiAgICAgICAgICAgIGVsLnN0eWxlLndpZHRoID0gdnBSZWN0LndpZHRoICsgJ3B4JztcclxuICAgICAgICAgICAgZWwuc3R5bGUuaGVpZ2h0ID0gdnBSZWN0LmhlaWdodCArICdweCc7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHV0aWxzLmluaGVyaXRzKE1hc2ssIFVJQmFzZSk7XHJcbn0pKCk7XHJcblxuXG4vLyB1aS9wb3B1cC5qc1xuLy8vaW1wb3J0IGNvcmVcclxuLy8vaW1wb3J0IHVpY29yZVxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIHV0aWxzID0gYmFpZHUuZWRpdG9yLnV0aWxzLFxyXG4gICAgICAgIHVpVXRpbHMgPSBiYWlkdS5lZGl0b3IudWkudWlVdGlscyxcclxuICAgICAgICBkb21VdGlscyA9IGJhaWR1LmVkaXRvci5kb20uZG9tVXRpbHMsXHJcbiAgICAgICAgVUlCYXNlID0gYmFpZHUuZWRpdG9yLnVpLlVJQmFzZSxcclxuICAgICAgICBQb3B1cCA9IGJhaWR1LmVkaXRvci51aS5Qb3B1cCA9IGZ1bmN0aW9uIChvcHRpb25zKXtcclxuICAgICAgICAgICAgdGhpcy5pbml0T3B0aW9ucyhvcHRpb25zKTtcclxuICAgICAgICAgICAgdGhpcy5pbml0UG9wdXAoKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgIHZhciBhbGxQb3B1cHMgPSBbXTtcclxuICAgIGZ1bmN0aW9uIGNsb3NlQWxsUG9wdXAoIGV2dCxlbCApe1xyXG4gICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGFsbFBvcHVwcy5sZW5ndGg7IGkrKyApIHtcclxuICAgICAgICAgICAgdmFyIHBvcCA9IGFsbFBvcHVwc1tpXTtcclxuICAgICAgICAgICAgaWYgKCFwb3AuaXNIaWRkZW4oKSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHBvcC5xdWVyeUF1dG9IaWRlKGVsKSAhPT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZihldnQmJi9zY3JvbGwvaWcudGVzdChldnQudHlwZSkmJnBvcC5jbGFzc05hbWU9PVwiZWR1aS13b3JkcGFzdGVwb3BcIikgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgcG9wLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYoYWxsUG9wdXBzLmxlbmd0aClcclxuICAgICAgICAgICAgcG9wLmVkaXRvci5maXJlRXZlbnQoXCJhZnRlcmhpZGVwb3BcIik7XHJcbiAgICB9XHJcblxyXG4gICAgUG9wdXAucG9zdEhpZGUgPSBjbG9zZUFsbFBvcHVwO1xyXG5cclxuICAgIHZhciBBTkNIT1JfQ0xBU1NFUyA9IFsnZWR1aS1hbmNob3ItdG9wbGVmdCcsJ2VkdWktYW5jaG9yLXRvcHJpZ2h0JyxcclxuICAgICAgICAnZWR1aS1hbmNob3ItYm90dG9tbGVmdCcsJ2VkdWktYW5jaG9yLWJvdHRvbXJpZ2h0J107XHJcbiAgICBQb3B1cC5wcm90b3R5cGUgPSB7XHJcbiAgICAgICAgU0hBRE9XX1JBRElVUzogNSxcclxuICAgICAgICBjb250ZW50OiBudWxsLFxyXG4gICAgICAgIF9oaWRkZW46IGZhbHNlLFxyXG4gICAgICAgIGF1dG9SZW5kZXI6IHRydWUsXHJcbiAgICAgICAgY2FuU2lkZUxlZnQ6IHRydWUsXHJcbiAgICAgICAgY2FuU2lkZVVwOiB0cnVlLFxyXG4gICAgICAgIGluaXRQb3B1cDogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdFVJQmFzZSgpO1xyXG4gICAgICAgICAgICBhbGxQb3B1cHMucHVzaCggdGhpcyApO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0SHRtbFRwbDogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHJldHVybiAnPGRpdiBpZD1cIiMjXCIgY2xhc3M9XCJlZHVpLXBvcHVwICUlXCIgb25tb3VzZWRvd249XCJyZXR1cm4gZmFsc2U7XCI+JyArXHJcbiAgICAgICAgICAgICAgICAnIDxkaXYgaWQ9XCIjI19ib2R5XCIgY2xhc3M9XCJlZHVpLXBvcHVwLWJvZHlcIj4nICtcclxuICAgICAgICAgICAgICAgICcgPGlmcmFtZSBzdHlsZT1cInBvc2l0aW9uOmFic29sdXRlO3otaW5kZXg6LTE7bGVmdDowO3RvcDowO2JhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50O1wiIGZyYW1lYm9yZGVyPVwiMFwiIHdpZHRoPVwiMTAwJVwiIGhlaWdodD1cIjEwMCVcIiBzcmM9XCJhYm91dDpibGFua1wiPjwvaWZyYW1lPicgK1xyXG4gICAgICAgICAgICAgICAgJyA8ZGl2IGNsYXNzPVwiZWR1aS1zaGFkb3dcIj48L2Rpdj4nICtcclxuICAgICAgICAgICAgICAgICcgPGRpdiBpZD1cIiMjX2NvbnRlbnRcIiBjbGFzcz1cImVkdWktcG9wdXAtY29udGVudFwiPicgK1xyXG4gICAgICAgICAgICAgICAgdGhpcy5nZXRDb250ZW50SHRtbFRwbCgpICtcclxuICAgICAgICAgICAgICAgICcgIDwvZGl2PicgK1xyXG4gICAgICAgICAgICAgICAgJyA8L2Rpdj4nICtcclxuICAgICAgICAgICAgICAgICc8L2Rpdj4nO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0Q29udGVudEh0bWxUcGw6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICBpZih0aGlzLmNvbnRlbnQpe1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmNvbnRlbnQgPT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jb250ZW50O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29udGVudC5yZW5kZXJIdG1sKCk7XHJcbiAgICAgICAgICAgIH1lbHNle1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICcnXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSxcclxuICAgICAgICBfVUlCYXNlX3Bvc3RSZW5kZXI6IFVJQmFzZS5wcm90b3R5cGUucG9zdFJlbmRlcixcclxuICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbiAoKXtcclxuXHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5jb250ZW50IGluc3RhbmNlb2YgVUlCYXNlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRlbnQucG9zdFJlbmRlcigpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvL+aNleiOt+m8oOagh+a7mui9rlxyXG4gICAgICAgICAgICBpZiggdGhpcy5jYXB0dXJlV2hlZWwgJiYgIXRoaXMuY2FwdHVyZWQgKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5jYXB0dXJlZCA9IHRydWU7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIHdpbkhlaWdodCA9ICggZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCB8fCBkb2N1bWVudC5ib2R5LmNsaWVudEhlaWdodCApICAtIDgwLFxyXG4gICAgICAgICAgICAgICAgICAgIF9oZWlnaHQgPSB0aGlzLmdldERvbSgpLm9mZnNldEhlaWdodCxcclxuICAgICAgICAgICAgICAgICAgICBfdG9wID0gdWlVdGlscy5nZXRDbGllbnRSZWN0KCB0aGlzLmNvbWJveC5nZXREb20oKSApLnRvcCxcclxuICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gdGhpcy5nZXREb20oJ2NvbnRlbnQnKSxcclxuICAgICAgICAgICAgICAgICAgICBpZnIgPSB0aGlzLmdldERvbSgnYm9keScpLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpZnJhbWUnKSxcclxuICAgICAgICAgICAgICAgICAgICBtZSA9IHRoaXM7XHJcblxyXG4gICAgICAgICAgICAgICAgaWZyLmxlbmd0aCAmJiAoIGlmciA9IGlmclswXSApO1xyXG5cclxuICAgICAgICAgICAgICAgIHdoaWxlKCBfdG9wICsgX2hlaWdodCA+IHdpbkhlaWdodCApIHtcclxuICAgICAgICAgICAgICAgICAgICBfaGVpZ2h0IC09IDMwO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29udGVudC5zdHlsZS5oZWlnaHQgPSBfaGVpZ2h0ICsgJ3B4JztcclxuICAgICAgICAgICAgICAgIC8v5ZCM5q2l5pu05pS5aWZyYW1l6auY5bqmXHJcbiAgICAgICAgICAgICAgICBpZnIgJiYgKCBpZnIuc3R5bGUuaGVpZ2h0ID0gX2hlaWdodCArICdweCcgKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvL+mYu+atouWcqGNvbWJveOS4iueahOm8oOagh+a7mui9ruS6i+S7tiwg6Ziy5q2i55So5oi355qE5q2j5bi45pON5L2c6KKr6K+v6KejXHJcbiAgICAgICAgICAgICAgICBpZiggd2luZG93LlhNTEh0dHBSZXF1ZXN0ICkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5vbiggY29udGVudCwgKCAnb25tb3VzZXdoZWVsJyBpbiBkb2N1bWVudC5ib2R5ICkgPyAnbW91c2V3aGVlbCcgOidET01Nb3VzZVNjcm9sbCcgLCBmdW5jdGlvbihlKXtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGUucHJldmVudERlZmF1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUucmV0dXJuVmFsdWUgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoIGUud2hlZWxEZWx0YSApIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50LnNjcm9sbFRvcCAtPSAoIGUud2hlZWxEZWx0YSAvIDEyMCApKjYwO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50LnNjcm9sbFRvcCAtPSAoIGUuZGV0YWlsIC8gLTMgKSo2MDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy9pZTZcclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5vbiggdGhpcy5nZXREb20oKSwgJ21vdXNld2hlZWwnICwgZnVuY3Rpb24oZSl7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlLnJldHVyblZhbHVlID0gZmFsc2U7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5nZXREb20oJ2NvbnRlbnQnKS5zY3JvbGxUb3AgLT0gKCBlLndoZWVsRGVsdGEgLyAxMjAgKSo2MDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgncG9zdFJlbmRlckFmdGVyJyk7XHJcbiAgICAgICAgICAgIHRoaXMuaGlkZSh0cnVlKTtcclxuICAgICAgICAgICAgdGhpcy5fVUlCYXNlX3Bvc3RSZW5kZXIoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIF9kb0F1dG9SZW5kZXI6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuZ2V0RG9tKCkgJiYgdGhpcy5hdXRvUmVuZGVyKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcigpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBtZXN1cmVTaXplOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgdmFyIGJveCA9IHRoaXMuZ2V0RG9tKCdjb250ZW50Jyk7XHJcbiAgICAgICAgICAgIHJldHVybiB1aVV0aWxzLmdldENsaWVudFJlY3QoYm94KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGZpdFNpemU6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICBpZiggdGhpcy5jYXB0dXJlV2hlZWwgJiYgdGhpcy5zaXplZCApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9fc2l6ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnNpemVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgdmFyIHBvcEJvZHlFbCA9IHRoaXMuZ2V0RG9tKCdib2R5Jyk7XHJcbiAgICAgICAgICAgIHBvcEJvZHlFbC5zdHlsZS53aWR0aCA9ICcnO1xyXG4gICAgICAgICAgICBwb3BCb2R5RWwuc3R5bGUuaGVpZ2h0ID0gJyc7XHJcbiAgICAgICAgICAgIHZhciBzaXplID0gdGhpcy5tZXN1cmVTaXplKCk7XHJcbiAgICAgICAgICAgIGlmKCB0aGlzLmNhcHR1cmVXaGVlbCApIHtcclxuICAgICAgICAgICAgICAgIHBvcEJvZHlFbC5zdHlsZS53aWR0aCA9ICAtKC0yMCAtc2l6ZS53aWR0aCkgKyAncHgnO1xyXG4gICAgICAgICAgICAgICAgdmFyIGhlaWdodCA9IHBhcnNlSW50KCB0aGlzLmdldERvbSgnY29udGVudCcpLnN0eWxlLmhlaWdodCwgMTAgKTtcclxuICAgICAgICAgICAgICAgICF3aW5kb3cuaXNOYU4oIGhlaWdodCApICYmICggc2l6ZS5oZWlnaHQgPSBoZWlnaHQgKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHBvcEJvZHlFbC5zdHlsZS53aWR0aCA9ICBzaXplLndpZHRoICsgJ3B4JztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBwb3BCb2R5RWwuc3R5bGUuaGVpZ2h0ID0gc2l6ZS5oZWlnaHQgKyAncHgnO1xyXG4gICAgICAgICAgICB0aGlzLl9fc2l6ZSA9IHNpemU7XHJcbiAgICAgICAgICAgIHRoaXMuY2FwdHVyZVdoZWVsICYmICh0aGlzLmdldERvbSgnY29udGVudCcpLnN0eWxlLm92ZXJmbG93ID0gJ2F1dG8nKTtcclxuICAgICAgICAgICAgcmV0dXJuIHNpemU7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzaG93QW5jaG9yOiBmdW5jdGlvbiAoIGVsZW1lbnQsIGhveiApe1xyXG4gICAgICAgICAgICB0aGlzLnNob3dBbmNob3JSZWN0KCB1aVV0aWxzLmdldENsaWVudFJlY3QoIGVsZW1lbnQgKSwgaG96ICk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzaG93QW5jaG9yUmVjdDogZnVuY3Rpb24gKCByZWN0LCBob3osIGFkaiApe1xyXG4gICAgICAgICAgICB0aGlzLl9kb0F1dG9SZW5kZXIoKTtcclxuICAgICAgICAgICAgdmFyIHZwUmVjdCA9IHVpVXRpbHMuZ2V0Vmlld3BvcnRSZWN0KCk7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0RG9tKCkuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nO1xyXG4gICAgICAgICAgICB0aGlzLl9zaG93KCk7XHJcbiAgICAgICAgICAgIHZhciBwb3BTaXplID0gdGhpcy5maXRTaXplKCk7XHJcblxyXG4gICAgICAgICAgICB2YXIgc2lkZUxlZnQsIHNpZGVVcCwgbGVmdCwgdG9wO1xyXG4gICAgICAgICAgICBpZiAoaG96KSB7XHJcbiAgICAgICAgICAgICAgICBzaWRlTGVmdCA9IHRoaXMuY2FuU2lkZUxlZnQgJiYgKHJlY3QucmlnaHQgKyBwb3BTaXplLndpZHRoID4gdnBSZWN0LnJpZ2h0ICYmIHJlY3QubGVmdCA+IHBvcFNpemUud2lkdGgpO1xyXG4gICAgICAgICAgICAgICAgc2lkZVVwID0gdGhpcy5jYW5TaWRlVXAgJiYgKHJlY3QudG9wICsgcG9wU2l6ZS5oZWlnaHQgPiB2cFJlY3QuYm90dG9tICYmIHJlY3QuYm90dG9tID4gcG9wU2l6ZS5oZWlnaHQpO1xyXG4gICAgICAgICAgICAgICAgbGVmdCA9IChzaWRlTGVmdCA/IHJlY3QubGVmdCAtIHBvcFNpemUud2lkdGggOiByZWN0LnJpZ2h0KTtcclxuICAgICAgICAgICAgICAgIHRvcCA9IChzaWRlVXAgPyByZWN0LmJvdHRvbSAtIHBvcFNpemUuaGVpZ2h0IDogcmVjdC50b3ApO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc2lkZUxlZnQgPSB0aGlzLmNhblNpZGVMZWZ0ICYmIChyZWN0LnJpZ2h0ICsgcG9wU2l6ZS53aWR0aCA+IHZwUmVjdC5yaWdodCAmJiByZWN0LmxlZnQgPiBwb3BTaXplLndpZHRoKTtcclxuICAgICAgICAgICAgICAgIHNpZGVVcCA9IHRoaXMuY2FuU2lkZVVwICYmIChyZWN0LnRvcCArIHBvcFNpemUuaGVpZ2h0ID4gdnBSZWN0LmJvdHRvbSAmJiByZWN0LmJvdHRvbSA+IHBvcFNpemUuaGVpZ2h0KTtcclxuICAgICAgICAgICAgICAgIGxlZnQgPSAoc2lkZUxlZnQgPyByZWN0LnJpZ2h0IC0gcG9wU2l6ZS53aWR0aCA6IHJlY3QubGVmdCk7XHJcbiAgICAgICAgICAgICAgICB0b3AgPSAoc2lkZVVwID8gcmVjdC50b3AgLSBwb3BTaXplLmhlaWdodCA6IHJlY3QuYm90dG9tKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdmFyIHBvcEVsID0gdGhpcy5nZXREb20oKTtcclxuICAgICAgICAgICAgdWlVdGlscy5zZXRWaWV3cG9ydE9mZnNldChwb3BFbCwge1xyXG4gICAgICAgICAgICAgICAgbGVmdDogbGVmdCxcclxuICAgICAgICAgICAgICAgIHRvcDogdG9wXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBkb21VdGlscy5yZW1vdmVDbGFzc2VzKHBvcEVsLCBBTkNIT1JfQ0xBU1NFUyk7XHJcbiAgICAgICAgICAgIHBvcEVsLmNsYXNzTmFtZSArPSAnICcgKyBBTkNIT1JfQ0xBU1NFU1soc2lkZVVwID8gMSA6IDApICogMiArIChzaWRlTGVmdCA/IDEgOiAwKV07XHJcbiAgICAgICAgICAgIGlmKHRoaXMuZWRpdG9yKXtcclxuICAgICAgICAgICAgICAgIHBvcEVsLnN0eWxlLnpJbmRleCA9IHRoaXMuZWRpdG9yLmNvbnRhaW5lci5zdHlsZS56SW5kZXggKiAxICsgMTA7XHJcbiAgICAgICAgICAgICAgICBiYWlkdS5lZGl0b3IudWkudWlVdGlscy5nZXRGaXhlZExheWVyKCkuc3R5bGUuekluZGV4ID0gcG9wRWwuc3R5bGUuekluZGV4IC0gMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmdldERvbSgpLnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7XHJcblxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2hvd0F0OiBmdW5jdGlvbiAob2Zmc2V0KSB7XHJcbiAgICAgICAgICAgIHZhciBsZWZ0ID0gb2Zmc2V0LmxlZnQ7XHJcbiAgICAgICAgICAgIHZhciB0b3AgPSBvZmZzZXQudG9wO1xyXG4gICAgICAgICAgICB2YXIgcmVjdCA9IHtcclxuICAgICAgICAgICAgICAgIGxlZnQ6IGxlZnQsXHJcbiAgICAgICAgICAgICAgICB0b3A6IHRvcCxcclxuICAgICAgICAgICAgICAgIHJpZ2h0OiBsZWZ0LFxyXG4gICAgICAgICAgICAgICAgYm90dG9tOiB0b3AsXHJcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IDAsXHJcbiAgICAgICAgICAgICAgICB3aWR0aDogMFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB0aGlzLnNob3dBbmNob3JSZWN0KHJlY3QsIGZhbHNlLCB0cnVlKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIF9zaG93OiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX2hpZGRlbikge1xyXG4gICAgICAgICAgICAgICAgdmFyIGJveCA9IHRoaXMuZ2V0RG9tKCk7XHJcbiAgICAgICAgICAgICAgICBib3guc3R5bGUuZGlzcGxheSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5faGlkZGVuID0gZmFsc2U7XHJcbi8vICAgICAgICAgICAgICAgIGlmIChib3guc2V0QWN0aXZlKSB7XHJcbi8vICAgICAgICAgICAgICAgICAgICBib3guc2V0QWN0aXZlKCk7XHJcbi8vICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdzaG93Jyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGlzSGlkZGVuOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hpZGRlbjtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNob3c6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICB0aGlzLl9kb0F1dG9SZW5kZXIoKTtcclxuICAgICAgICAgICAgdGhpcy5fc2hvdygpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgaGlkZTogZnVuY3Rpb24gKG5vdE5vZml0eSl7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5faGlkZGVuICYmIHRoaXMuZ2V0RG9tKCkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0RG9tKCkuc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuICAgICAgICAgICAgICAgIHRoaXMuX2hpZGRlbiA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBpZiAoIW5vdE5vZml0eSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdoaWRlJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIHF1ZXJ5QXV0b0hpZGU6IGZ1bmN0aW9uIChlbCl7XHJcbiAgICAgICAgICAgIHJldHVybiAhZWwgfHwgIXVpVXRpbHMuY29udGFpbnModGhpcy5nZXREb20oKSwgZWwpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICB1dGlscy5pbmhlcml0cyhQb3B1cCwgVUlCYXNlKTtcclxuICAgIFxyXG4gICAgZG9tVXRpbHMub24oIGRvY3VtZW50LCAnbW91c2Vkb3duJywgZnVuY3Rpb24gKCBldnQgKSB7XHJcbiAgICAgICAgdmFyIGVsID0gZXZ0LnRhcmdldCB8fCBldnQuc3JjRWxlbWVudDtcclxuICAgICAgICBjbG9zZUFsbFBvcHVwKCBldnQsZWwgKTtcclxuICAgIH0gKTtcclxuICAgIGRvbVV0aWxzLm9uKCB3aW5kb3csICdzY3JvbGwnLCBmdW5jdGlvbiAoZXZ0LGVsKSB7XHJcbiAgICAgICAgY2xvc2VBbGxQb3B1cCggZXZ0LGVsICk7XHJcbiAgICB9ICk7XHJcblxyXG59KSgpO1xyXG5cblxuLy8gdWkvY29sb3JwaWNrZXIuanNcbi8vL2ltcG9ydCBjb3JlXHJcbi8vL2ltcG9ydCB1aWNvcmVcclxuKGZ1bmN0aW9uICgpe1xyXG4gICAgdmFyIHV0aWxzID0gYmFpZHUuZWRpdG9yLnV0aWxzLFxyXG4gICAgICAgIFVJQmFzZSA9IGJhaWR1LmVkaXRvci51aS5VSUJhc2UsXHJcbiAgICAgICAgQ29sb3JQaWNrZXIgPSBiYWlkdS5lZGl0b3IudWkuQ29sb3JQaWNrZXIgPSBmdW5jdGlvbiAob3B0aW9ucyl7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdE9wdGlvbnMob3B0aW9ucyk7XHJcbiAgICAgICAgICAgIHRoaXMubm9Db2xvclRleHQgPSB0aGlzLm5vQ29sb3JUZXh0IHx8IHRoaXMuZWRpdG9yLmdldExhbmcoXCJjbGVhckNvbG9yXCIpO1xyXG4gICAgICAgICAgICB0aGlzLmluaXRVSUJhc2UoKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgIENvbG9yUGlja2VyLnByb3RvdHlwZSA9IHtcclxuICAgICAgICBnZXRIdG1sVHBsOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgcmV0dXJuIGdlbkNvbG9yUGlja2VyKHRoaXMubm9Db2xvclRleHQsdGhpcy5lZGl0b3IpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgX29uVGFibGVDbGljazogZnVuY3Rpb24gKGV2dCl7XHJcbiAgICAgICAgICAgIHZhciB0Z3QgPSBldnQudGFyZ2V0IHx8IGV2dC5zcmNFbGVtZW50O1xyXG4gICAgICAgICAgICB2YXIgY29sb3IgPSB0Z3QuZ2V0QXR0cmlidXRlKCdkYXRhLWNvbG9yJyk7XHJcbiAgICAgICAgICAgIGlmIChjb2xvcikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3BpY2tjb2xvcicsIGNvbG9yKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgX29uVGFibGVPdmVyOiBmdW5jdGlvbiAoZXZ0KXtcclxuICAgICAgICAgICAgdmFyIHRndCA9IGV2dC50YXJnZXQgfHwgZXZ0LnNyY0VsZW1lbnQ7XHJcbiAgICAgICAgICAgIHZhciBjb2xvciA9IHRndC5nZXRBdHRyaWJ1dGUoJ2RhdGEtY29sb3InKTtcclxuICAgICAgICAgICAgaWYgKGNvbG9yKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmdldERvbSgncHJldmlldycpLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBfb25UYWJsZU91dDogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0RG9tKCdwcmV2aWV3Jykuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gJyc7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBfb25QaWNrTm9Db2xvcjogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdwaWNrbm9jb2xvcicpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICB1dGlscy5pbmhlcml0cyhDb2xvclBpY2tlciwgVUlCYXNlKTtcclxuXHJcbiAgICB2YXIgQ09MT1JTID0gKFxyXG4gICAgICAgICdmZmZmZmYsMDAwMDAwLGVlZWNlMSwxZjQ5N2QsNGY4MWJkLGMwNTA0ZCw5YmJiNTksODA2NGEyLDRiYWNjNixmNzk2NDYsJyArXHJcbiAgICAgICAgICAgICdmMmYyZjIsN2Y3ZjdmLGRkZDljMyxjNmQ5ZjAsZGJlNWYxLGYyZGNkYixlYmYxZGQsZTVlMGVjLGRiZWVmMyxmZGVhZGEsJyArXHJcbiAgICAgICAgICAgICdkOGQ4ZDgsNTk1OTU5LGM0YmQ5Nyw4ZGIzZTIsYjhjY2U0LGU1YjliNyxkN2UzYmMsY2NjMWQ5LGI3ZGRlOCxmYmQ1YjUsJyArXHJcbiAgICAgICAgICAgICdiZmJmYmYsM2YzZjNmLDkzODk1Myw1NDhkZDQsOTViM2Q3LGQ5OTY5NCxjM2Q2OWIsYjJhMmM3LDkyY2RkYyxmYWMwOGYsJyArXHJcbiAgICAgICAgICAgICdhNWE1YTUsMjYyNjI2LDQ5NDQyOSwxNzM2NWQsMzY2MDkyLDk1MzczNCw3NjkyM2MsNWY0OTdhLDMxODU5YixlMzZjMDksJyArXHJcbiAgICAgICAgICAgICc3ZjdmN2YsMGMwYzBjLDFkMWIxMCwwZjI0M2UsMjQ0MDYxLDYzMjQyMyw0ZjYxMjgsM2YzMTUxLDIwNTg2Nyw5NzQ4MDYsJyArXHJcbiAgICAgICAgICAgICdjMDAwMDAsZmYwMDAwLGZmYzAwMCxmZmZmMDAsOTJkMDUwLDAwYjA1MCwwMGIwZjAsMDA3MGMwLDAwMjA2MCw3MDMwYTAsJykuc3BsaXQoJywnKTtcclxuXHJcbiAgICBmdW5jdGlvbiBnZW5Db2xvclBpY2tlcihub0NvbG9yVGV4dCxlZGl0b3Ipe1xyXG4gICAgICAgIHZhciBodG1sID0gJzxkaXYgaWQ9XCIjI1wiIGNsYXNzPVwiZWR1aS1jb2xvcnBpY2tlciAlJVwiPicgK1xyXG4gICAgICAgICAgICAnPGRpdiBjbGFzcz1cImVkdWktY29sb3JwaWNrZXItdG9wYmFyIGVkdWktY2xlYXJmaXhcIj4nICtcclxuICAgICAgICAgICAgJzxkaXYgdW5zZWxlY3RhYmxlPVwib25cIiBpZD1cIiMjX3ByZXZpZXdcIiBjbGFzcz1cImVkdWktY29sb3JwaWNrZXItcHJldmlld1wiPjwvZGl2PicgK1xyXG4gICAgICAgICAgICAnPGRpdiB1bnNlbGVjdGFibGU9XCJvblwiIGNsYXNzPVwiZWR1aS1jb2xvcnBpY2tlci1ub2NvbG9yXCIgb25jbGljaz1cIiQkLl9vblBpY2tOb0NvbG9yKGV2ZW50LCB0aGlzKTtcIj4nKyBub0NvbG9yVGV4dCArJzwvZGl2PicgK1xyXG4gICAgICAgICAgICAnPC9kaXY+JyArXHJcbiAgICAgICAgICAgICc8dGFibGUgIGNsYXNzPVwiZWR1aS1ib3hcIiBzdHlsZT1cImJvcmRlci1jb2xsYXBzZTogY29sbGFwc2U7XCIgb25tb3VzZW92ZXI9XCIkJC5fb25UYWJsZU92ZXIoZXZlbnQsIHRoaXMpO1wiIG9ubW91c2VvdXQ9XCIkJC5fb25UYWJsZU91dChldmVudCwgdGhpcyk7XCIgb25jbGljaz1cInJldHVybiAkJC5fb25UYWJsZUNsaWNrKGV2ZW50LCB0aGlzKTtcIiBjZWxsc3BhY2luZz1cIjBcIiBjZWxscGFkZGluZz1cIjBcIj4nICtcclxuICAgICAgICAgICAgJzx0ciBzdHlsZT1cImJvcmRlci1ib3R0b206IDFweCBzb2xpZCAjZGRkO2ZvbnQtc2l6ZTogMTNweDtsaW5lLWhlaWdodDogMjVweDtjb2xvcjojMzlDO3BhZGRpbmctdG9wOiAycHhcIj48dGQgY29sc3Bhbj1cIjEwXCI+JytlZGl0b3IuZ2V0TGFuZyhcInRoZW1lQ29sb3JcIikrJzwvdGQ+IDwvdHI+JytcclxuICAgICAgICAgICAgJzx0ciBjbGFzcz1cImVkdWktY29sb3JwaWNrZXItdGFibGVmaXJzdHJvd1wiID4nO1xyXG4gICAgICAgIGZvciAodmFyIGk9MDsgaTxDT0xPUlMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKGkgJiYgaSUxMCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgaHRtbCArPSAnPC90cj4nKyhpPT02MD8nPHRyIHN0eWxlPVwiYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICNkZGQ7Zm9udC1zaXplOiAxM3B4O2xpbmUtaGVpZ2h0OiAyNXB4O2NvbG9yOiMzOUM7XCI+PHRkIGNvbHNwYW49XCIxMFwiPicrZWRpdG9yLmdldExhbmcoXCJzdGFuZGFyZENvbG9yXCIpKyc8L3RkPjwvdHI+JzonJykrJzx0cicrKGk9PTYwPycgY2xhc3M9XCJlZHVpLWNvbG9ycGlja2VyLXRhYmxlZmlyc3Ryb3dcIic6JycpKyc+JztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBodG1sICs9IGk8NzAgPyAnPHRkIHN0eWxlPVwicGFkZGluZzogMCAycHg7XCI+PGEgaGlkZWZvY3VzIHRpdGxlPVwiJytDT0xPUlNbaV0rJ1wiIG9uY2xpY2s9XCJyZXR1cm4gZmFsc2U7XCIgaHJlZj1cImphdmFzY3JpcHQ6XCIgdW5zZWxlY3RhYmxlPVwib25cIiBjbGFzcz1cImVkdWktYm94IGVkdWktY29sb3JwaWNrZXItY29sb3JjZWxsXCInICtcclxuICAgICAgICAgICAgICAgICcgZGF0YS1jb2xvcj1cIiMnKyBDT0xPUlNbaV0gKydcIicrXHJcbiAgICAgICAgICAgICAgICAnIHN0eWxlPVwiYmFja2dyb3VuZC1jb2xvcjojJysgQ09MT1JTW2ldICsnO2JvcmRlcjpzb2xpZCAjY2NjOycrXHJcbiAgICAgICAgICAgICAgICAoaTwxMCB8fCBpPj02MD8nYm9yZGVyLXdpZHRoOjFweDsnOlxyXG4gICAgICAgICAgICAgICAgICAgIGk+PTEwJiZpPDIwPydib3JkZXItd2lkdGg6MXB4IDFweCAwIDFweDsnOlxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgJ2JvcmRlci13aWR0aDowIDFweCAwIDFweDsnKStcclxuICAgICAgICAgICAgICAgICdcIicgK1xyXG4gICAgICAgICAgICAgICAgJz48L2E+PC90ZD4nOicnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBodG1sICs9ICc8L3RyPjwvdGFibGU+PC9kaXY+JztcclxuICAgICAgICByZXR1cm4gaHRtbDtcclxuICAgIH1cclxufSkoKTtcclxuXG5cbi8vIHVpL3RhYmxlcGlja2VyLmpzXG4vLy9pbXBvcnQgY29yZVxyXG4vLy9pbXBvcnQgdWljb3JlXHJcbihmdW5jdGlvbiAoKXtcclxuICAgIHZhciB1dGlscyA9IGJhaWR1LmVkaXRvci51dGlscyxcclxuICAgICAgICB1aVV0aWxzID0gYmFpZHUuZWRpdG9yLnVpLnVpVXRpbHMsXHJcbiAgICAgICAgVUlCYXNlID0gYmFpZHUuZWRpdG9yLnVpLlVJQmFzZTtcclxuICAgIFxyXG4gICAgdmFyIFRhYmxlUGlja2VyID0gYmFpZHUuZWRpdG9yLnVpLlRhYmxlUGlja2VyID0gZnVuY3Rpb24gKG9wdGlvbnMpe1xyXG4gICAgICAgIHRoaXMuaW5pdE9wdGlvbnMob3B0aW9ucyk7XHJcbiAgICAgICAgdGhpcy5pbml0VGFibGVQaWNrZXIoKTtcclxuICAgIH07XHJcbiAgICBUYWJsZVBpY2tlci5wcm90b3R5cGUgPSB7XHJcbiAgICAgICAgZGVmYXVsdE51bVJvd3M6IDEwLFxyXG4gICAgICAgIGRlZmF1bHROdW1Db2xzOiAxMCxcclxuICAgICAgICBtYXhOdW1Sb3dzOiAyMCxcclxuICAgICAgICBtYXhOdW1Db2xzOiAyMCxcclxuICAgICAgICBudW1Sb3dzOiAxMCxcclxuICAgICAgICBudW1Db2xzOiAxMCxcclxuICAgICAgICBsZW5ndGhPZkNlbGxTaWRlOiAyMixcclxuICAgICAgICBpbml0VGFibGVQaWNrZXI6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICB0aGlzLmluaXRVSUJhc2UoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldEh0bWxUcGw6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICByZXR1cm4gJzxkaXYgaWQ9XCIjI1wiIGNsYXNzPVwiZWR1aS10YWJsZXBpY2tlciAlJVwiPicgK1xyXG4gICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiZWR1aS10YWJsZXBpY2tlci1ib2R5XCI+JyArXHJcbiAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiZWR1aS1pbmZvYXJlYVwiPicgK1xyXG4gICAgICAgICAgICAgICAgICAgJzxzcGFuIGlkPVwiIyNfbGFiZWxcIiBjbGFzcz1cImVkdWktbGFiZWxcIj48L3NwYW4+JyArXHJcbiAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcclxuICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJlZHVpLXBpY2thcmVhXCInICtcclxuICAgICAgICAgICAgICAgICAgICcgb25tb3VzZW1vdmU9XCIkJC5fb25Nb3VzZU1vdmUoZXZlbnQsIHRoaXMpO1wiJyArXHJcbiAgICAgICAgICAgICAgICAgICAnIG9ubW91c2VvdmVyPVwiJCQuX29uTW91c2VPdmVyKGV2ZW50LCB0aGlzKTtcIicgK1xyXG4gICAgICAgICAgICAgICAgICAgJyBvbm1vdXNlb3V0PVwiJCQuX29uTW91c2VPdXQoZXZlbnQsIHRoaXMpO1wiJyArXHJcbiAgICAgICAgICAgICAgICAgICAnIG9uY2xpY2s9XCIkJC5fb25DbGljayhldmVudCwgdGhpcyk7XCInICtcclxuICAgICAgICAgICAgICAgICAgJz4nICtcclxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBpZD1cIiMjX292ZXJsYXlcIiBjbGFzcz1cImVkdWktb3ZlcmxheVwiPjwvZGl2PicgK1xyXG4gICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXHJcbiAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xyXG4gICAgICAgICAgICAgICAgJzwvZGl2Pic7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBfVUlCYXNlX3JlbmRlcjogVUlCYXNlLnByb3RvdHlwZS5yZW5kZXIsXHJcbiAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoaG9sZGVyKXtcclxuICAgICAgICAgICAgdGhpcy5fVUlCYXNlX3JlbmRlcihob2xkZXIpO1xyXG4gICAgICAgICAgICB0aGlzLmdldERvbSgnbGFiZWwnKS5pbm5lckhUTUwgPSAnMCcrdGhpcy5lZGl0b3IuZ2V0TGFuZyhcInRfcm93XCIpKycgeCAwJyt0aGlzLmVkaXRvci5nZXRMYW5nKFwidF9jb2xcIik7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBfdHJhY2s6IGZ1bmN0aW9uIChudW1Db2xzLCBudW1Sb3dzKXtcclxuICAgICAgICAgICAgdmFyIHN0eWxlID0gdGhpcy5nZXREb20oJ292ZXJsYXknKS5zdHlsZTtcclxuICAgICAgICAgICAgdmFyIHNpZGVMZW4gPSB0aGlzLmxlbmd0aE9mQ2VsbFNpZGU7XHJcbiAgICAgICAgICAgIHN0eWxlLndpZHRoID0gbnVtQ29scyAqIHNpZGVMZW4gKyAncHgnO1xyXG4gICAgICAgICAgICBzdHlsZS5oZWlnaHQgPSBudW1Sb3dzICogc2lkZUxlbiArICdweCc7XHJcbiAgICAgICAgICAgIHZhciBsYWJlbCA9IHRoaXMuZ2V0RG9tKCdsYWJlbCcpO1xyXG4gICAgICAgICAgICBsYWJlbC5pbm5lckhUTUwgPSBudW1Db2xzICt0aGlzLmVkaXRvci5nZXRMYW5nKFwidF9jb2xcIikrJyB4ICcgKyBudW1Sb3dzICsgdGhpcy5lZGl0b3IuZ2V0TGFuZyhcInRfcm93XCIpO1xyXG4gICAgICAgICAgICB0aGlzLm51bUNvbHMgPSBudW1Db2xzO1xyXG4gICAgICAgICAgICB0aGlzLm51bVJvd3MgPSBudW1Sb3dzO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgX29uTW91c2VPdmVyOiBmdW5jdGlvbiAoZXZ0LCBlbCl7XHJcbiAgICAgICAgICAgIHZhciByZWwgPSBldnQucmVsYXRlZFRhcmdldCB8fCBldnQuZnJvbUVsZW1lbnQ7XHJcbiAgICAgICAgICAgIGlmICghdWlVdGlscy5jb250YWlucyhlbCwgcmVsKSAmJiBlbCAhPT0gcmVsKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmdldERvbSgnbGFiZWwnKS5pbm5lckhUTUwgPSAnMCcrdGhpcy5lZGl0b3IuZ2V0TGFuZyhcInRfY29sXCIpKycgeCAwJyt0aGlzLmVkaXRvci5nZXRMYW5nKFwidF9yb3dcIik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmdldERvbSgnb3ZlcmxheScpLnN0eWxlLnZpc2liaWxpdHkgPSAnJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgX29uTW91c2VPdXQ6IGZ1bmN0aW9uIChldnQsIGVsKXtcclxuICAgICAgICAgICAgdmFyIHJlbCA9IGV2dC5yZWxhdGVkVGFyZ2V0IHx8IGV2dC50b0VsZW1lbnQ7XHJcbiAgICAgICAgICAgIGlmICghdWlVdGlscy5jb250YWlucyhlbCwgcmVsKSAmJiBlbCAhPT0gcmVsKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmdldERvbSgnbGFiZWwnKS5pbm5lckhUTUwgPSAnMCcrdGhpcy5lZGl0b3IuZ2V0TGFuZyhcInRfY29sXCIpKycgeCAwJyt0aGlzLmVkaXRvci5nZXRMYW5nKFwidF9yb3dcIik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmdldERvbSgnb3ZlcmxheScpLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgX29uTW91c2VNb3ZlOiBmdW5jdGlvbiAoZXZ0LCBlbCl7XHJcbiAgICAgICAgICAgIHZhciBzdHlsZSA9IHRoaXMuZ2V0RG9tKCdvdmVybGF5Jykuc3R5bGU7XHJcbiAgICAgICAgICAgIHZhciBvZmZzZXQgPSB1aVV0aWxzLmdldEV2ZW50T2Zmc2V0KGV2dCk7XHJcbiAgICAgICAgICAgIHZhciBzaWRlTGVuID0gdGhpcy5sZW5ndGhPZkNlbGxTaWRlO1xyXG4gICAgICAgICAgICB2YXIgbnVtQ29scyA9IE1hdGguY2VpbChvZmZzZXQubGVmdCAvIHNpZGVMZW4pO1xyXG4gICAgICAgICAgICB2YXIgbnVtUm93cyA9IE1hdGguY2VpbChvZmZzZXQudG9wIC8gc2lkZUxlbik7XHJcbiAgICAgICAgICAgIHRoaXMuX3RyYWNrKG51bUNvbHMsIG51bVJvd3MpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgX29uQ2xpY2s6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgncGlja3RhYmxlJywgdGhpcy5udW1Db2xzLCB0aGlzLm51bVJvd3MpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICB1dGlscy5pbmhlcml0cyhUYWJsZVBpY2tlciwgVUlCYXNlKTtcclxufSkoKTtcclxuXG5cbi8vIHVpL3N0YXRlZnVsLmpzXG4oZnVuY3Rpb24gKCl7XHJcbiAgICB2YXIgYnJvd3NlciA9IGJhaWR1LmVkaXRvci5icm93c2VyLFxyXG4gICAgICAgIGRvbVV0aWxzID0gYmFpZHUuZWRpdG9yLmRvbS5kb21VdGlscyxcclxuICAgICAgICB1aVV0aWxzID0gYmFpZHUuZWRpdG9yLnVpLnVpVXRpbHM7XHJcbiAgICBcclxuICAgIHZhciBUUExfU1RBVEVGVUwgPSAnb25tb3VzZWRvd249XCIkJC5TdGF0ZWZ1bF9vbk1vdXNlRG93bihldmVudCwgdGhpcyk7XCInICtcclxuICAgICAgICAnIG9ubW91c2V1cD1cIiQkLlN0YXRlZnVsX29uTW91c2VVcChldmVudCwgdGhpcyk7XCInICtcclxuICAgICAgICAoIGJyb3dzZXIuaWUgPyAoXHJcbiAgICAgICAgJyBvbm1vdXNlZW50ZXI9XCIkJC5TdGF0ZWZ1bF9vbk1vdXNlRW50ZXIoZXZlbnQsIHRoaXMpO1wiJyArXHJcbiAgICAgICAgJyBvbm1vdXNlbGVhdmU9XCIkJC5TdGF0ZWZ1bF9vbk1vdXNlTGVhdmUoZXZlbnQsIHRoaXMpO1wiJyApXHJcbiAgICAgICAgOiAoXHJcbiAgICAgICAgJyBvbm1vdXNlb3Zlcj1cIiQkLlN0YXRlZnVsX29uTW91c2VPdmVyKGV2ZW50LCB0aGlzKTtcIicgK1xyXG4gICAgICAgICcgb25tb3VzZW91dD1cIiQkLlN0YXRlZnVsX29uTW91c2VPdXQoZXZlbnQsIHRoaXMpO1wiJyApKTtcclxuICAgIFxyXG4gICAgYmFpZHUuZWRpdG9yLnVpLlN0YXRlZnVsID0ge1xyXG4gICAgICAgIGFsd2FseXNIb3ZlcmFibGU6IGZhbHNlLFxyXG4gICAgICAgIHRhcmdldDpudWxsLC8v55uu5qCH5YWD57Sg5ZKMdGhpc+aMh+WQkWRvbeS4jeS4gOagt1xyXG4gICAgICAgIFN0YXRlZnVsX2luaXQ6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICB0aGlzLl9TdGF0ZWZ1bF9kR2V0SHRtbFRwbCA9IHRoaXMuZ2V0SHRtbFRwbDtcclxuICAgICAgICAgICAgdGhpcy5nZXRIdG1sVHBsID0gdGhpcy5TdGF0ZWZ1bF9nZXRIdG1sVHBsO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgU3RhdGVmdWxfZ2V0SHRtbFRwbDogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHZhciB0cGwgPSB0aGlzLl9TdGF0ZWZ1bF9kR2V0SHRtbFRwbCgpO1xyXG4gICAgICAgICAgICAvLyDkvb/nlKhmdW5jdGlvbumBv+WFjSTovazkuYlcclxuICAgICAgICAgICAgcmV0dXJuIHRwbC5yZXBsYWNlKC9zdGF0ZWZ1bC9nLCBmdW5jdGlvbiAoKXsgcmV0dXJuIFRQTF9TVEFURUZVTDsgfSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBTdGF0ZWZ1bF9vbk1vdXNlRW50ZXI6IGZ1bmN0aW9uIChldnQsIGVsKXtcclxuICAgICAgICAgICAgdGhpcy50YXJnZXQ9ZWw7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pc0Rpc2FibGVkKCkgfHwgdGhpcy5hbHdhbHlzSG92ZXJhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFkZFN0YXRlKCdob3ZlcicpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ292ZXInKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgU3RhdGVmdWxfb25Nb3VzZUxlYXZlOiBmdW5jdGlvbiAoZXZ0LCBlbCl7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pc0Rpc2FibGVkKCkgfHwgdGhpcy5hbHdhbHlzSG92ZXJhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVN0YXRlKCdob3ZlcicpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVTdGF0ZSgnYWN0aXZlJyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnb3V0Jyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIFN0YXRlZnVsX29uTW91c2VPdmVyOiBmdW5jdGlvbiAoZXZ0LCBlbCl7XHJcbiAgICAgICAgICAgIHZhciByZWwgPSBldnQucmVsYXRlZFRhcmdldDtcclxuICAgICAgICAgICAgaWYgKCF1aVV0aWxzLmNvbnRhaW5zKGVsLCByZWwpICYmIGVsICE9PSByZWwpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuU3RhdGVmdWxfb25Nb3VzZUVudGVyKGV2dCwgZWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBTdGF0ZWZ1bF9vbk1vdXNlT3V0OiBmdW5jdGlvbiAoZXZ0LCBlbCl7XHJcbiAgICAgICAgICAgIHZhciByZWwgPSBldnQucmVsYXRlZFRhcmdldDtcclxuICAgICAgICAgICAgaWYgKCF1aVV0aWxzLmNvbnRhaW5zKGVsLCByZWwpICYmIGVsICE9PSByZWwpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuU3RhdGVmdWxfb25Nb3VzZUxlYXZlKGV2dCwgZWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBTdGF0ZWZ1bF9vbk1vdXNlRG93bjogZnVuY3Rpb24gKGV2dCwgZWwpe1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaXNEaXNhYmxlZCgpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFkZFN0YXRlKCdhY3RpdmUnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgU3RhdGVmdWxfb25Nb3VzZVVwOiBmdW5jdGlvbiAoZXZ0LCBlbCl7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pc0Rpc2FibGVkKCkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlU3RhdGUoJ2FjdGl2ZScpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBTdGF0ZWZ1bF9wb3N0UmVuZGVyOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZGlzYWJsZWQgJiYgIXRoaXMuaGFzU3RhdGUoJ2Rpc2FibGVkJykpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYWRkU3RhdGUoJ2Rpc2FibGVkJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGhhc1N0YXRlOiBmdW5jdGlvbiAoc3RhdGUpe1xyXG4gICAgICAgICAgICByZXR1cm4gZG9tVXRpbHMuaGFzQ2xhc3ModGhpcy5nZXRTdGF0ZURvbSgpLCAnZWR1aS1zdGF0ZS0nICsgc3RhdGUpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgYWRkU3RhdGU6IGZ1bmN0aW9uIChzdGF0ZSl7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5oYXNTdGF0ZShzdGF0ZSkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0U3RhdGVEb20oKS5jbGFzc05hbWUgKz0gJyBlZHVpLXN0YXRlLScgKyBzdGF0ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcmVtb3ZlU3RhdGU6IGZ1bmN0aW9uIChzdGF0ZSl7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmhhc1N0YXRlKHN0YXRlKSkge1xyXG4gICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlQ2xhc3Nlcyh0aGlzLmdldFN0YXRlRG9tKCksIFsnZWR1aS1zdGF0ZS0nICsgc3RhdGVdKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0U3RhdGVEb206IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREb20oJ3N0YXRlJyk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBpc0NoZWNrZWQ6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5oYXNTdGF0ZSgnY2hlY2tlZCcpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0Q2hlY2tlZDogZnVuY3Rpb24gKGNoZWNrZWQpe1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaXNEaXNhYmxlZCgpICYmIGNoZWNrZWQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYWRkU3RhdGUoJ2NoZWNrZWQnKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlU3RhdGUoJ2NoZWNrZWQnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgaXNEaXNhYmxlZDogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmhhc1N0YXRlKCdkaXNhYmxlZCcpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uIChkaXNhYmxlZCl7XHJcbiAgICAgICAgICAgIGlmIChkaXNhYmxlZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVTdGF0ZSgnaG92ZXInKTtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlU3RhdGUoJ2NoZWNrZWQnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlU3RhdGUoJ2FjdGl2ZScpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hZGRTdGF0ZSgnZGlzYWJsZWQnKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlU3RhdGUoJ2Rpc2FibGVkJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59KSgpO1xyXG5cblxuLy8gdWkvYnV0dG9uLmpzXG4vLy9pbXBvcnQgY29yZVxyXG4vLy9pbXBvcnQgdWljb3JlXHJcbi8vL2ltcG9ydCB1aS9zdGF0ZWZ1bC5qc1xyXG4oZnVuY3Rpb24gKCl7XHJcbiAgICB2YXIgdXRpbHMgPSBiYWlkdS5lZGl0b3IudXRpbHMsXHJcbiAgICAgICAgVUlCYXNlID0gYmFpZHUuZWRpdG9yLnVpLlVJQmFzZSxcclxuICAgICAgICBTdGF0ZWZ1bCA9IGJhaWR1LmVkaXRvci51aS5TdGF0ZWZ1bCxcclxuICAgICAgICBCdXR0b24gPSBiYWlkdS5lZGl0b3IudWkuQnV0dG9uID0gZnVuY3Rpb24gKG9wdGlvbnMpe1xyXG4gICAgICAgICAgICBpZihvcHRpb25zLm5hbWUpe1xyXG4gICAgICAgICAgICAgICAgdmFyIGJ0bk5hbWUgPSBvcHRpb25zLm5hbWU7XHJcbiAgICAgICAgICAgICAgICB2YXIgY3NzUnVsZXMgPSBvcHRpb25zLmNzc1J1bGVzO1xyXG4gICAgICAgICAgICAgICAgaWYoIW9wdGlvbnMuY2xhc3NOYW1lKXtcclxuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmNsYXNzTmFtZSA9ICAnZWR1aS1mb3ItJyArIGJ0bk5hbWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBvcHRpb25zLmNzc1J1bGVzID0gJy5lZHVpLWRlZmF1bHQgIC5lZHVpLWZvci0nKyBidG5OYW1lICsnIC5lZHVpLWljb24geycrIGNzc1J1bGVzICsnfSdcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmluaXRPcHRpb25zKG9wdGlvbnMpO1xyXG4gICAgICAgICAgICB0aGlzLmluaXRCdXR0b24oKTtcclxuICAgICAgICB9O1xyXG4gICAgQnV0dG9uLnByb3RvdHlwZSA9IHtcclxuICAgICAgICB1aU5hbWU6ICdidXR0b24nLFxyXG4gICAgICAgIGxhYmVsOiAnJyxcclxuICAgICAgICB0aXRsZTogJycsXHJcbiAgICAgICAgc2hvd0ljb246IHRydWUsXHJcbiAgICAgICAgc2hvd1RleHQ6IHRydWUsXHJcbiAgICAgICAgY3NzUnVsZXM6JycsXHJcbiAgICAgICAgaW5pdEJ1dHRvbjogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdFVJQmFzZSgpO1xyXG4gICAgICAgICAgICB0aGlzLlN0YXRlZnVsX2luaXQoKTtcclxuICAgICAgICAgICAgaWYodGhpcy5jc3NSdWxlcyl7XHJcbiAgICAgICAgICAgICAgICB1dGlscy5jc3NSdWxlKCdlZHVpLWN1c3RvbWl6ZS0nK3RoaXMubmFtZSsnLXN0eWxlJyx0aGlzLmNzc1J1bGVzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0SHRtbFRwbDogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHJldHVybiAnPGRpdiBpZD1cIiMjXCIgY2xhc3M9XCJlZHVpLWJveCAlJVwiPicgK1xyXG4gICAgICAgICAgICAgICAgJzxkaXYgaWQ9XCIjI19zdGF0ZVwiIHN0YXRlZnVsPicgK1xyXG4gICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiJSUtd3JhcFwiPjxkaXYgaWQ9XCIjI19ib2R5XCIgdW5zZWxlY3RhYmxlPVwib25cIiAnICsgKHRoaXMudGl0bGUgPyAndGl0bGU9XCInICsgdGhpcy50aXRsZSArICdcIicgOiAnJykgK1xyXG4gICAgICAgICAgICAgICAgICcgY2xhc3M9XCIlJS1ib2R5XCIgb25tb3VzZWRvd249XCJyZXR1cm4gJCQuX29uTW91c2VEb3duKGV2ZW50LCB0aGlzKTtcIiBvbmNsaWNrPVwicmV0dXJuICQkLl9vbkNsaWNrKGV2ZW50LCB0aGlzKTtcIj4nICtcclxuICAgICAgICAgICAgICAgICAgKHRoaXMuc2hvd0ljb24gPyAnPGRpdiBjbGFzcz1cImVkdWktYm94IGVkdWktaWNvblwiPjwvZGl2PicgOiAnJykgK1xyXG4gICAgICAgICAgICAgICAgICAodGhpcy5zaG93VGV4dCA/ICc8ZGl2IGNsYXNzPVwiZWR1aS1ib3ggZWR1aS1sYWJlbFwiPicgKyB0aGlzLmxhYmVsICsgJzwvZGl2PicgOiAnJykgK1xyXG4gICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcclxuICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcclxuICAgICAgICAgICAgICAgICc8L2Rpdj48L2Rpdj4nO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHRoaXMuU3RhdGVmdWxfcG9zdFJlbmRlcigpO1xyXG4gICAgICAgICAgICB0aGlzLnNldERpc2FibGVkKHRoaXMuZGlzYWJsZWQpXHJcbiAgICAgICAgfSxcclxuICAgICAgICBfb25Nb3VzZURvd246IGZ1bmN0aW9uIChlKXtcclxuICAgICAgICAgICAgdmFyIHRhcmdldCA9IGUudGFyZ2V0IHx8IGUuc3JjRWxlbWVudCxcclxuICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YXJnZXQgJiYgdGFyZ2V0LnRhZ05hbWUgJiYgdGFyZ2V0LnRhZ05hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgaWYgKHRhZ05hbWUgPT0gJ2lucHV0JyB8fCB0YWdOYW1lID09ICdvYmplY3QnIHx8IHRhZ05hbWUgPT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgX29uQ2xpY2s6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaXNEaXNhYmxlZCgpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnY2xpY2snKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0VGl0bGU6IGZ1bmN0aW9uKHRleHQpe1xyXG4gICAgICAgICAgICB2YXIgbGFiZWwgPSB0aGlzLmdldERvbSgnbGFiZWwnKTtcclxuICAgICAgICAgICAgbGFiZWwuaW5uZXJIVE1MID0gdGV4dDtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgdXRpbHMuaW5oZXJpdHMoQnV0dG9uLCBVSUJhc2UpO1xyXG4gICAgdXRpbHMuZXh0ZW5kKEJ1dHRvbi5wcm90b3R5cGUsIFN0YXRlZnVsKTtcclxuXHJcbn0pKCk7XHJcblxuXG4vLyB1aS9zcGxpdGJ1dHRvbi5qc1xuLy8vaW1wb3J0IGNvcmVcclxuLy8vaW1wb3J0IHVpY29yZVxyXG4vLy9pbXBvcnQgdWkvc3RhdGVmdWwuanNcclxuKGZ1bmN0aW9uICgpe1xyXG4gICAgdmFyIHV0aWxzID0gYmFpZHUuZWRpdG9yLnV0aWxzLFxyXG4gICAgICAgIHVpVXRpbHMgPSBiYWlkdS5lZGl0b3IudWkudWlVdGlscyxcclxuICAgICAgICBkb21VdGlscyA9IGJhaWR1LmVkaXRvci5kb20uZG9tVXRpbHMsXHJcbiAgICAgICAgVUlCYXNlID0gYmFpZHUuZWRpdG9yLnVpLlVJQmFzZSxcclxuICAgICAgICBTdGF0ZWZ1bCA9IGJhaWR1LmVkaXRvci51aS5TdGF0ZWZ1bCxcclxuICAgICAgICBTcGxpdEJ1dHRvbiA9IGJhaWR1LmVkaXRvci51aS5TcGxpdEJ1dHRvbiA9IGZ1bmN0aW9uIChvcHRpb25zKXtcclxuICAgICAgICAgICAgdGhpcy5pbml0T3B0aW9ucyhvcHRpb25zKTtcclxuICAgICAgICAgICAgdGhpcy5pbml0U3BsaXRCdXR0b24oKTtcclxuICAgICAgICB9O1xyXG4gICAgU3BsaXRCdXR0b24ucHJvdG90eXBlID0ge1xyXG4gICAgICAgIHBvcHVwOiBudWxsLFxyXG4gICAgICAgIHVpTmFtZTogJ3NwbGl0YnV0dG9uJyxcclxuICAgICAgICB0aXRsZTogJycsXHJcbiAgICAgICAgaW5pdFNwbGl0QnV0dG9uOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgdGhpcy5pbml0VUlCYXNlKCk7XHJcbiAgICAgICAgICAgIHRoaXMuU3RhdGVmdWxfaW5pdCgpO1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5wb3B1cCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcG9wdXAgPSB0aGlzLnBvcHVwO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cCA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldFBvcHVwKHBvcHVwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgX1VJQmFzZV9wb3N0UmVuZGVyOiBVSUJhc2UucHJvdG90eXBlLnBvc3RSZW5kZXIsXHJcbiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHRoaXMuU3RhdGVmdWxfcG9zdFJlbmRlcigpO1xyXG4gICAgICAgICAgICB0aGlzLl9VSUJhc2VfcG9zdFJlbmRlcigpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0UG9wdXA6IGZ1bmN0aW9uIChwb3B1cCl7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnBvcHVwID09PSBwb3B1cCkgcmV0dXJuO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5wb3B1cCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBvcHVwLmRpc3Bvc2UoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBwb3B1cC5hZGRMaXN0ZW5lcignc2hvdycsIHV0aWxzLmJpbmQodGhpcy5fb25Qb3B1cFNob3csIHRoaXMpKTtcclxuICAgICAgICAgICAgcG9wdXAuYWRkTGlzdGVuZXIoJ2hpZGUnLCB1dGlscy5iaW5kKHRoaXMuX29uUG9wdXBIaWRlLCB0aGlzKSk7XHJcbiAgICAgICAgICAgIHBvcHVwLmFkZExpc3RlbmVyKCdwb3N0cmVuZGVyJywgdXRpbHMuYmluZChmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgICAgIHBvcHVwLmdldERvbSgnYm9keScpLmFwcGVuZENoaWxkKFxyXG4gICAgICAgICAgICAgICAgICAgIHVpVXRpbHMuY3JlYXRlRWxlbWVudEJ5SHRtbCgnPGRpdiBpZD1cIicgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwLmlkICsgJ19ib3JkZXJlcmFzZXJcIiBjbGFzcz1cImVkdWktYm9yZGVyZXJhc2VyIGVkdWktYmFja2dyb3VuZFwiIHN0eWxlPVwid2lkdGg6JyArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICh1aVV0aWxzLmdldENsaWVudFJlY3QodGhpcy5nZXREb20oKSkud2lkdGggKyAyMCkgKyAncHhcIj48L2Rpdj4nKVxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICBwb3B1cC5nZXREb20oKS5jbGFzc05hbWUgKz0gJyAnICsgdGhpcy5jbGFzc05hbWU7XHJcbiAgICAgICAgICAgIH0sIHRoaXMpKTtcclxuICAgICAgICAgICAgdGhpcy5wb3B1cCA9IHBvcHVwO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgX29uUG9wdXBTaG93OiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgdGhpcy5hZGRTdGF0ZSgnb3BlbmVkJyk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBfb25Qb3B1cEhpZGU6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZVN0YXRlKCdvcGVuZWQnKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldEh0bWxUcGw6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICByZXR1cm4gJzxkaXYgaWQ9XCIjI1wiIGNsYXNzPVwiZWR1aS1ib3ggJSVcIj4nICtcclxuICAgICAgICAgICAgICAgICc8ZGl2ICcrICh0aGlzLnRpdGxlID8gJ3RpdGxlPVwiJyArIHRoaXMudGl0bGUgKyAnXCInIDogJycpICsnIGlkPVwiIyNfc3RhdGVcIiBzdGF0ZWZ1bD48ZGl2IGNsYXNzPVwiJSUtYm9keVwiPicgK1xyXG4gICAgICAgICAgICAgICAgJzxkaXYgaWQ9XCIjI19idXR0b25fYm9keVwiIGNsYXNzPVwiZWR1aS1ib3ggZWR1aS1idXR0b24tYm9keVwiIG9uY2xpY2s9XCIkJC5fb25CdXR0b25DbGljayhldmVudCwgdGhpcyk7XCI+JyArXHJcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImVkdWktYm94IGVkdWktaWNvblwiPjwvZGl2PicgK1xyXG4gICAgICAgICAgICAgICAgJzwvZGl2PicgK1xyXG4gICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJlZHVpLWJveCBlZHVpLXNwbGl0Ym9yZGVyXCI+PC9kaXY+JyArXHJcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImVkdWktYm94IGVkdWktYXJyb3dcIiBvbmNsaWNrPVwiJCQuX29uQXJyb3dDbGljaygpO1wiPjwvZGl2PicgK1xyXG4gICAgICAgICAgICAgICAgJzwvZGl2PjwvZGl2PjwvZGl2Pic7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzaG93UG9wdXA6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICAvLyDlvZNwb3B1cOW+gOS4iuW8ueWHuueahOaXtuWAme+8jOWBmueJueauiuWkhOeQhlxyXG4gICAgICAgICAgICB2YXIgcmVjdCA9IHVpVXRpbHMuZ2V0Q2xpZW50UmVjdCh0aGlzLmdldERvbSgpKTtcclxuICAgICAgICAgICAgcmVjdC50b3AgLT0gdGhpcy5wb3B1cC5TSEFET1dfUkFESVVTO1xyXG4gICAgICAgICAgICByZWN0LmhlaWdodCArPSB0aGlzLnBvcHVwLlNIQURPV19SQURJVVM7XHJcbiAgICAgICAgICAgIHRoaXMucG9wdXAuc2hvd0FuY2hvclJlY3QocmVjdCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBfb25BcnJvd0NsaWNrOiBmdW5jdGlvbiAoZXZlbnQsIGVsKXtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmlzRGlzYWJsZWQoKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zaG93UG9wdXAoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgX29uQnV0dG9uQ2xpY2s6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaXNEaXNhYmxlZCgpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnYnV0dG9uY2xpY2snKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICB1dGlscy5pbmhlcml0cyhTcGxpdEJ1dHRvbiwgVUlCYXNlKTtcclxuICAgIHV0aWxzLmV4dGVuZChTcGxpdEJ1dHRvbi5wcm90b3R5cGUsIFN0YXRlZnVsLCB0cnVlKTtcclxuXHJcbn0pKCk7XHJcblxuXG4vLyB1aS9jb2xvcmJ1dHRvbi5qc1xuLy8vaW1wb3J0IGNvcmVcclxuLy8vaW1wb3J0IHVpY29yZVxyXG4vLy9pbXBvcnQgdWkvY29sb3JwaWNrZXIuanNcclxuLy8vaW1wb3J0IHVpL3BvcHVwLmpzXHJcbi8vL2ltcG9ydCB1aS9zcGxpdGJ1dHRvbi5qc1xyXG4oZnVuY3Rpb24gKCl7XHJcbiAgICB2YXIgdXRpbHMgPSBiYWlkdS5lZGl0b3IudXRpbHMsXHJcbiAgICAgICAgdWlVdGlscyA9IGJhaWR1LmVkaXRvci51aS51aVV0aWxzLFxyXG4gICAgICAgIENvbG9yUGlja2VyID0gYmFpZHUuZWRpdG9yLnVpLkNvbG9yUGlja2VyLFxyXG4gICAgICAgIFBvcHVwID0gYmFpZHUuZWRpdG9yLnVpLlBvcHVwLFxyXG4gICAgICAgIFNwbGl0QnV0dG9uID0gYmFpZHUuZWRpdG9yLnVpLlNwbGl0QnV0dG9uLFxyXG4gICAgICAgIENvbG9yQnV0dG9uID0gYmFpZHUuZWRpdG9yLnVpLkNvbG9yQnV0dG9uID0gZnVuY3Rpb24gKG9wdGlvbnMpe1xyXG4gICAgICAgICAgICB0aGlzLmluaXRPcHRpb25zKG9wdGlvbnMpO1xyXG4gICAgICAgICAgICB0aGlzLmluaXRDb2xvckJ1dHRvbigpO1xyXG4gICAgICAgIH07XHJcbiAgICBDb2xvckJ1dHRvbi5wcm90b3R5cGUgPSB7XHJcbiAgICAgICAgaW5pdENvbG9yQnV0dG9uOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcclxuICAgICAgICAgICAgdGhpcy5wb3B1cCA9IG5ldyBQb3B1cCh7XHJcbiAgICAgICAgICAgICAgICBjb250ZW50OiBuZXcgQ29sb3JQaWNrZXIoe1xyXG4gICAgICAgICAgICAgICAgICAgIG5vQ29sb3JUZXh0OiBtZS5lZGl0b3IuZ2V0TGFuZyhcImNsZWFyQ29sb3JcIiksXHJcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yOm1lLmVkaXRvcixcclxuICAgICAgICAgICAgICAgICAgICBvbnBpY2tjb2xvcjogZnVuY3Rpb24gKHQsIGNvbG9yKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuX29uUGlja0NvbG9yKGNvbG9yKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIG9ucGlja25vY29sb3I6IGZ1bmN0aW9uICh0LCBjb2xvcil7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLl9vblBpY2tOb0NvbG9yKGNvbG9yKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgIGVkaXRvcjptZS5lZGl0b3JcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdFNwbGl0QnV0dG9uKCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBfU3BsaXRCdXR0b25fcG9zdFJlbmRlcjogU3BsaXRCdXR0b24ucHJvdG90eXBlLnBvc3RSZW5kZXIsXHJcbiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHRoaXMuX1NwbGl0QnV0dG9uX3Bvc3RSZW5kZXIoKTtcclxuICAgICAgICAgICAgdGhpcy5nZXREb20oJ2J1dHRvbl9ib2R5JykuYXBwZW5kQ2hpbGQoXHJcbiAgICAgICAgICAgICAgICB1aVV0aWxzLmNyZWF0ZUVsZW1lbnRCeUh0bWwoJzxkaXYgaWQ9XCInICsgdGhpcy5pZCArICdfY29sb3JsdW1wXCIgY2xhc3M9XCJlZHVpLWNvbG9ybHVtcFwiPjwvZGl2PicpXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0RG9tKCkuY2xhc3NOYW1lICs9ICcgZWR1aS1jb2xvcmJ1dHRvbic7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXRDb2xvcjogZnVuY3Rpb24gKGNvbG9yKXtcclxuICAgICAgICAgICAgdGhpcy5nZXREb20oJ2NvbG9ybHVtcCcpLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yO1xyXG4gICAgICAgICAgICB0aGlzLmNvbG9yID0gY29sb3I7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBfb25QaWNrQ29sb3I6IGZ1bmN0aW9uIChjb2xvcil7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmZpcmVFdmVudCgncGlja2NvbG9yJywgY29sb3IpICE9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRDb2xvcihjb2xvcik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBvcHVwLmhpZGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgX29uUGlja05vQ29sb3I6IGZ1bmN0aW9uIChjb2xvcil7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmZpcmVFdmVudCgncGlja25vY29sb3InKSAhPT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucG9wdXAuaGlkZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHV0aWxzLmluaGVyaXRzKENvbG9yQnV0dG9uLCBTcGxpdEJ1dHRvbik7XHJcblxyXG59KSgpO1xyXG5cblxuLy8gdWkvdGFibGVidXR0b24uanNcbi8vL2ltcG9ydCBjb3JlXHJcbi8vL2ltcG9ydCB1aWNvcmVcclxuLy8vaW1wb3J0IHVpL3BvcHVwLmpzXHJcbi8vL2ltcG9ydCB1aS90YWJsZXBpY2tlci5qc1xyXG4vLy9pbXBvcnQgdWkvc3BsaXRidXR0b24uanNcclxuKGZ1bmN0aW9uICgpe1xyXG4gICAgdmFyIHV0aWxzID0gYmFpZHUuZWRpdG9yLnV0aWxzLFxyXG4gICAgICAgIFBvcHVwID0gYmFpZHUuZWRpdG9yLnVpLlBvcHVwLFxyXG4gICAgICAgIFRhYmxlUGlja2VyID0gYmFpZHUuZWRpdG9yLnVpLlRhYmxlUGlja2VyLFxyXG4gICAgICAgIFNwbGl0QnV0dG9uID0gYmFpZHUuZWRpdG9yLnVpLlNwbGl0QnV0dG9uLFxyXG4gICAgICAgIFRhYmxlQnV0dG9uID0gYmFpZHUuZWRpdG9yLnVpLlRhYmxlQnV0dG9uID0gZnVuY3Rpb24gKG9wdGlvbnMpe1xyXG4gICAgICAgICAgICB0aGlzLmluaXRPcHRpb25zKG9wdGlvbnMpO1xyXG4gICAgICAgICAgICB0aGlzLmluaXRUYWJsZUJ1dHRvbigpO1xyXG4gICAgICAgIH07XHJcbiAgICBUYWJsZUJ1dHRvbi5wcm90b3R5cGUgPSB7XHJcbiAgICAgICAgaW5pdFRhYmxlQnV0dG9uOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcclxuICAgICAgICAgICAgdGhpcy5wb3B1cCA9IG5ldyBQb3B1cCh7XHJcbiAgICAgICAgICAgICAgICBjb250ZW50OiBuZXcgVGFibGVQaWNrZXIoe1xyXG4gICAgICAgICAgICAgICAgICAgIGVkaXRvcjptZS5lZGl0b3IsXHJcbiAgICAgICAgICAgICAgICAgICAgb25waWNrdGFibGU6IGZ1bmN0aW9uICh0LCBudW1Db2xzLCBudW1Sb3dzKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuX29uUGlja1RhYmxlKG51bUNvbHMsIG51bVJvd3MpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgJ2VkaXRvcic6bWUuZWRpdG9yXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLmluaXRTcGxpdEJ1dHRvbigpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgX29uUGlja1RhYmxlOiBmdW5jdGlvbiAobnVtQ29scywgbnVtUm93cyl7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmZpcmVFdmVudCgncGlja3RhYmxlJywgbnVtQ29scywgbnVtUm93cykgIT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBvcHVwLmhpZGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICB1dGlscy5pbmhlcml0cyhUYWJsZUJ1dHRvbiwgU3BsaXRCdXR0b24pO1xyXG5cclxufSkoKTtcclxuXG5cbi8vIHVpL2F1dG90eXBlc2V0cGlja2VyLmpzXG4vLy9pbXBvcnQgY29yZVxyXG4vLy9pbXBvcnQgdWljb3JlXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgdXRpbHMgPSBiYWlkdS5lZGl0b3IudXRpbHMsXHJcbiAgICAgICAgVUlCYXNlID0gYmFpZHUuZWRpdG9yLnVpLlVJQmFzZTtcclxuXHJcbiAgICB2YXIgQXV0b1R5cGVTZXRQaWNrZXIgPSBiYWlkdS5lZGl0b3IudWkuQXV0b1R5cGVTZXRQaWNrZXIgPSBmdW5jdGlvbiAob3B0aW9ucykge1xyXG4gICAgICAgIHRoaXMuaW5pdE9wdGlvbnMob3B0aW9ucyk7XHJcbiAgICAgICAgdGhpcy5pbml0QXV0b1R5cGVTZXRQaWNrZXIoKTtcclxuICAgIH07XHJcbiAgICBBdXRvVHlwZVNldFBpY2tlci5wcm90b3R5cGUgPSB7XHJcbiAgICAgICAgaW5pdEF1dG9UeXBlU2V0UGlja2VyOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdGhpcy5pbml0VUlCYXNlKCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRIdG1sVHBsOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcy5lZGl0b3IsXHJcbiAgICAgICAgICAgICAgICBvcHQgPSBtZS5vcHRpb25zLmF1dG90eXBlc2V0LFxyXG4gICAgICAgICAgICAgICAgbGFuZyA9IG1lLmdldExhbmcoXCJhdXRvVHlwZVNldFwiKTtcclxuXHJcbiAgICAgICAgICAgIHZhciB0ZXh0QWxpZ25JbnB1dE5hbWUgPSAndGV4dEFsaWduVmFsdWUnICsgbWUudWlkLFxyXG4gICAgICAgICAgICAgICAgaW1hZ2VCbG9ja0lucHV0TmFtZSA9ICdpbWFnZUJsb2NrTGluZVZhbHVlJyArIG1lLnVpZCxcclxuICAgICAgICAgICAgICAgIHN5bWJvbENvbnZlcklucHV0TmFtZSA9ICdzeW1ib2xDb252ZXJWYWx1ZScgKyBtZS51aWQ7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gJzxkaXYgaWQ9XCIjI1wiIGNsYXNzPVwiZWR1aS1hdXRvdHlwZXNldHBpY2tlciAlJVwiPicgK1xyXG4gICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJlZHVpLWF1dG90eXBlc2V0cGlja2VyLWJvZHlcIj4nICtcclxuICAgICAgICAgICAgICAgICc8dGFibGUgPicgK1xyXG4gICAgICAgICAgICAgICAgJzx0cj48dGQgbm93cmFwPjxpbnB1dCB0eXBlPVwiY2hlY2tib3hcIiBuYW1lPVwibWVyZ2VFbXB0eWxpbmVcIiAnICsgKG9wdFtcIm1lcmdlRW1wdHlsaW5lXCJdID8gXCJjaGVja2VkXCIgOiBcIlwiICkgKyAnPicgKyBsYW5nLm1lcmdlTGluZSArICc8L3RkPjx0ZCBjb2xzcGFuPVwiMlwiPjxpbnB1dCB0eXBlPVwiY2hlY2tib3hcIiBuYW1lPVwicmVtb3ZlRW1wdHlsaW5lXCIgJyArIChvcHRbXCJyZW1vdmVFbXB0eWxpbmVcIl0gPyBcImNoZWNrZWRcIiA6IFwiXCIgKSArICc+JyArIGxhbmcuZGVsTGluZSArICc8L3RkPjwvdHI+JyArXHJcbiAgICAgICAgICAgICAgICAnPHRyPjx0ZCBub3dyYXA+PGlucHV0IHR5cGU9XCJjaGVja2JveFwiIG5hbWU9XCJyZW1vdmVDbGFzc1wiICcgKyAob3B0W1wicmVtb3ZlQ2xhc3NcIl0gPyBcImNoZWNrZWRcIiA6IFwiXCIgKSArICc+JyArIGxhbmcucmVtb3ZlRm9ybWF0ICsgJzwvdGQ+PHRkIGNvbHNwYW49XCIyXCI+PGlucHV0IHR5cGU9XCJjaGVja2JveFwiIG5hbWU9XCJpbmRlbnRcIiAnICsgKG9wdFtcImluZGVudFwiXSA/IFwiY2hlY2tlZFwiIDogXCJcIiApICsgJz4nICsgbGFuZy5pbmRlbnQgKyAnPC90ZD48L3RyPicgK1xyXG4gICAgICAgICAgICAgICAgJzx0cj4nICtcclxuICAgICAgICAgICAgICAgICc8dGQgbm93cmFwPjxpbnB1dCB0eXBlPVwiY2hlY2tib3hcIiBuYW1lPVwidGV4dEFsaWduXCIgJyArIChvcHRbXCJ0ZXh0QWxpZ25cIl0gPyBcImNoZWNrZWRcIiA6IFwiXCIgKSArICc+JyArIGxhbmcuYWxpZ25tZW50ICsgJzwvdGQ+JyArXHJcbiAgICAgICAgICAgICAgICAnPHRkIGNvbHNwYW49XCIyXCIgaWQ9XCInICsgdGV4dEFsaWduSW5wdXROYW1lICsgJ1wiPicgK1xyXG4gICAgICAgICAgICAgICAgJzxpbnB1dCB0eXBlPVwicmFkaW9cIiBuYW1lPVwiJysgdGV4dEFsaWduSW5wdXROYW1lICsnXCIgdmFsdWU9XCJsZWZ0XCIgJyArICgob3B0W1widGV4dEFsaWduXCJdICYmIG9wdFtcInRleHRBbGlnblwiXSA9PSBcImxlZnRcIikgPyBcImNoZWNrZWRcIiA6IFwiXCIpICsgJz4nICsgbWUuZ2V0TGFuZyhcImp1c3RpZnlsZWZ0XCIpICtcclxuICAgICAgICAgICAgICAgICc8aW5wdXQgdHlwZT1cInJhZGlvXCIgbmFtZT1cIicrIHRleHRBbGlnbklucHV0TmFtZSArJ1wiIHZhbHVlPVwiY2VudGVyXCIgJyArICgob3B0W1widGV4dEFsaWduXCJdICYmIG9wdFtcInRleHRBbGlnblwiXSA9PSBcImNlbnRlclwiKSA/IFwiY2hlY2tlZFwiIDogXCJcIikgKyAnPicgKyBtZS5nZXRMYW5nKFwianVzdGlmeWNlbnRlclwiKSArXHJcbiAgICAgICAgICAgICAgICAnPGlucHV0IHR5cGU9XCJyYWRpb1wiIG5hbWU9XCInKyB0ZXh0QWxpZ25JbnB1dE5hbWUgKydcIiB2YWx1ZT1cInJpZ2h0XCIgJyArICgob3B0W1widGV4dEFsaWduXCJdICYmIG9wdFtcInRleHRBbGlnblwiXSA9PSBcInJpZ2h0XCIpID8gXCJjaGVja2VkXCIgOiBcIlwiKSArICc+JyArIG1lLmdldExhbmcoXCJqdXN0aWZ5cmlnaHRcIikgK1xyXG4gICAgICAgICAgICAgICAgJzwvdGQ+JyArXHJcbiAgICAgICAgICAgICAgICAnPC90cj4nICtcclxuICAgICAgICAgICAgICAgICc8dHI+JyArXHJcbiAgICAgICAgICAgICAgICAnPHRkIG5vd3JhcD48aW5wdXQgdHlwZT1cImNoZWNrYm94XCIgbmFtZT1cImltYWdlQmxvY2tMaW5lXCIgJyArIChvcHRbXCJpbWFnZUJsb2NrTGluZVwiXSA/IFwiY2hlY2tlZFwiIDogXCJcIiApICsgJz4nICsgbGFuZy5pbWFnZUZsb2F0ICsgJzwvdGQ+JyArXHJcbiAgICAgICAgICAgICAgICAnPHRkIG5vd3JhcCBpZD1cIicrIGltYWdlQmxvY2tJbnB1dE5hbWUgKydcIj4nICtcclxuICAgICAgICAgICAgICAgICc8aW5wdXQgdHlwZT1cInJhZGlvXCIgbmFtZT1cIicrIGltYWdlQmxvY2tJbnB1dE5hbWUgKydcIiB2YWx1ZT1cIm5vbmVcIiAnICsgKChvcHRbXCJpbWFnZUJsb2NrTGluZVwiXSAmJiBvcHRbXCJpbWFnZUJsb2NrTGluZVwiXSA9PSBcIm5vbmVcIikgPyBcImNoZWNrZWRcIiA6IFwiXCIpICsgJz4nICsgbWUuZ2V0TGFuZyhcImRlZmF1bHRcIikgK1xyXG4gICAgICAgICAgICAgICAgJzxpbnB1dCB0eXBlPVwicmFkaW9cIiBuYW1lPVwiJysgaW1hZ2VCbG9ja0lucHV0TmFtZSArJ1wiIHZhbHVlPVwibGVmdFwiICcgKyAoKG9wdFtcImltYWdlQmxvY2tMaW5lXCJdICYmIG9wdFtcImltYWdlQmxvY2tMaW5lXCJdID09IFwibGVmdFwiKSA/IFwiY2hlY2tlZFwiIDogXCJcIikgKyAnPicgKyBtZS5nZXRMYW5nKFwianVzdGlmeWxlZnRcIikgK1xyXG4gICAgICAgICAgICAgICAgJzxpbnB1dCB0eXBlPVwicmFkaW9cIiBuYW1lPVwiJysgaW1hZ2VCbG9ja0lucHV0TmFtZSArJ1wiIHZhbHVlPVwiY2VudGVyXCIgJyArICgob3B0W1wiaW1hZ2VCbG9ja0xpbmVcIl0gJiYgb3B0W1wiaW1hZ2VCbG9ja0xpbmVcIl0gPT0gXCJjZW50ZXJcIikgPyBcImNoZWNrZWRcIiA6IFwiXCIpICsgJz4nICsgbWUuZ2V0TGFuZyhcImp1c3RpZnljZW50ZXJcIikgK1xyXG4gICAgICAgICAgICAgICAgJzxpbnB1dCB0eXBlPVwicmFkaW9cIiBuYW1lPVwiJysgaW1hZ2VCbG9ja0lucHV0TmFtZSArJ1wiIHZhbHVlPVwicmlnaHRcIiAnICsgKChvcHRbXCJpbWFnZUJsb2NrTGluZVwiXSAmJiBvcHRbXCJpbWFnZUJsb2NrTGluZVwiXSA9PSBcInJpZ2h0XCIpID8gXCJjaGVja2VkXCIgOiBcIlwiKSArICc+JyArIG1lLmdldExhbmcoXCJqdXN0aWZ5cmlnaHRcIikgK1xyXG4gICAgICAgICAgICAgICAgJzwvdGQ+JyArXHJcbiAgICAgICAgICAgICAgICAnPC90cj4nICtcclxuICAgICAgICAgICAgICAgICc8dHI+PHRkIG5vd3JhcD48aW5wdXQgdHlwZT1cImNoZWNrYm94XCIgbmFtZT1cImNsZWFyRm9udFNpemVcIiAnICsgKG9wdFtcImNsZWFyRm9udFNpemVcIl0gPyBcImNoZWNrZWRcIiA6IFwiXCIgKSArICc+JyArIGxhbmcucmVtb3ZlRm9udHNpemUgKyAnPC90ZD48dGQgY29sc3Bhbj1cIjJcIj48aW5wdXQgdHlwZT1cImNoZWNrYm94XCIgbmFtZT1cImNsZWFyRm9udEZhbWlseVwiICcgKyAob3B0W1wiY2xlYXJGb250RmFtaWx5XCJdID8gXCJjaGVja2VkXCIgOiBcIlwiICkgKyAnPicgKyBsYW5nLnJlbW92ZUZvbnRGYW1pbHkgKyAnPC90ZD48L3RyPicgK1xyXG4gICAgICAgICAgICAgICAgJzx0cj48dGQgbm93cmFwIGNvbHNwYW49XCIzXCI+PGlucHV0IHR5cGU9XCJjaGVja2JveFwiIG5hbWU9XCJyZW1vdmVFbXB0eU5vZGVcIiAnICsgKG9wdFtcInJlbW92ZUVtcHR5Tm9kZVwiXSA/IFwiY2hlY2tlZFwiIDogXCJcIiApICsgJz4nICsgbGFuZy5yZW1vdmVIdG1sICsgJzwvdGQ+PC90cj4nICtcclxuICAgICAgICAgICAgICAgICc8dHI+PHRkIG5vd3JhcCBjb2xzcGFuPVwiM1wiPjxpbnB1dCB0eXBlPVwiY2hlY2tib3hcIiBuYW1lPVwicGFzdGVGaWx0ZXJcIiAnICsgKG9wdFtcInBhc3RlRmlsdGVyXCJdID8gXCJjaGVja2VkXCIgOiBcIlwiICkgKyAnPicgKyBsYW5nLnBhc3RlRmlsdGVyICsgJzwvdGQ+PC90cj4nICtcclxuICAgICAgICAgICAgICAgICc8dHI+JyArXHJcbiAgICAgICAgICAgICAgICAnPHRkIG5vd3JhcD48aW5wdXQgdHlwZT1cImNoZWNrYm94XCIgbmFtZT1cInN5bWJvbENvbnZlclwiICcgKyAob3B0W1wiYmRjMnNiXCJdIHx8IG9wdFtcInRvYmRjXCJdID8gXCJjaGVja2VkXCIgOiBcIlwiICkgKyAnPicgKyBsYW5nLnN5bWJvbCArICc8L3RkPicgK1xyXG4gICAgICAgICAgICAgICAgJzx0ZCBpZD1cIicgKyBzeW1ib2xDb252ZXJJbnB1dE5hbWUgKyAnXCI+JyArXHJcbiAgICAgICAgICAgICAgICAnPGlucHV0IHR5cGU9XCJyYWRpb1wiIG5hbWU9XCJiZGNcIiB2YWx1ZT1cImJkYzJzYlwiICcgKyAob3B0W1wiYmRjMnNiXCJdID8gXCJjaGVja2VkXCIgOiBcIlwiICkgKyAnPicgKyBsYW5nLmJkYzJzYiArXHJcbiAgICAgICAgICAgICAgICAnPGlucHV0IHR5cGU9XCJyYWRpb1wiIG5hbWU9XCJiZGNcIiB2YWx1ZT1cInRvYmRjXCIgJyArIChvcHRbXCJ0b2JkY1wiXSA/IFwiY2hlY2tlZFwiIDogXCJcIiApICsgJz4nICsgbGFuZy50b2JkYyArICcnICtcclxuICAgICAgICAgICAgICAgICc8L3RkPicgK1xyXG4gICAgICAgICAgICAgICAgJzx0ZCBub3dyYXAgYWxpZ249XCJyaWdodFwiPjxidXR0b24gPicgKyBsYW5nLnJ1biArICc8L2J1dHRvbj48L3RkPicgK1xyXG4gICAgICAgICAgICAgICAgJzwvdHI+JyArXHJcbiAgICAgICAgICAgICAgICAnPC90YWJsZT4nICtcclxuICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcclxuICAgICAgICAgICAgICAgICc8L2Rpdj4nO1xyXG5cclxuXHJcbiAgICAgICAgfSxcclxuICAgICAgICBfVUlCYXNlX3JlbmRlcjpVSUJhc2UucHJvdG90eXBlLnJlbmRlclxyXG4gICAgfTtcclxuICAgIHV0aWxzLmluaGVyaXRzKEF1dG9UeXBlU2V0UGlja2VyLCBVSUJhc2UpO1xyXG59KSgpO1xyXG5cblxuLy8gdWkvYXV0b3R5cGVzZXRidXR0b24uanNcbi8vL2ltcG9ydCBjb3JlXHJcbi8vL2ltcG9ydCB1aWNvcmVcclxuLy8vaW1wb3J0IHVpL3BvcHVwLmpzXHJcbi8vL2ltcG9ydCB1aS9hdXRvdHlwZXNldHBpY2tlci5qc1xyXG4vLy9pbXBvcnQgdWkvc3BsaXRidXR0b24uanNcclxuKGZ1bmN0aW9uICgpe1xyXG4gICAgdmFyIHV0aWxzID0gYmFpZHUuZWRpdG9yLnV0aWxzLFxyXG4gICAgICAgIFBvcHVwID0gYmFpZHUuZWRpdG9yLnVpLlBvcHVwLFxyXG4gICAgICAgIEF1dG9UeXBlU2V0UGlja2VyID0gYmFpZHUuZWRpdG9yLnVpLkF1dG9UeXBlU2V0UGlja2VyLFxyXG4gICAgICAgIFNwbGl0QnV0dG9uID0gYmFpZHUuZWRpdG9yLnVpLlNwbGl0QnV0dG9uLFxyXG4gICAgICAgIEF1dG9UeXBlU2V0QnV0dG9uID0gYmFpZHUuZWRpdG9yLnVpLkF1dG9UeXBlU2V0QnV0dG9uID0gZnVuY3Rpb24gKG9wdGlvbnMpe1xyXG4gICAgICAgICAgICB0aGlzLmluaXRPcHRpb25zKG9wdGlvbnMpO1xyXG4gICAgICAgICAgICB0aGlzLmluaXRBdXRvVHlwZVNldEJ1dHRvbigpO1xyXG4gICAgICAgIH07XHJcbiAgICBmdW5jdGlvbiBnZXRQYXJhKG1lKXtcclxuXHJcbiAgICAgICAgdmFyIG9wdCA9IHt9LFxyXG4gICAgICAgICAgICBjb250ID0gbWUuZ2V0RG9tKCksXHJcbiAgICAgICAgICAgIGVkaXRvcklkID0gbWUuZWRpdG9yLnVpZCxcclxuICAgICAgICAgICAgaW5wdXRUeXBlID0gbnVsbCxcclxuICAgICAgICAgICAgYXR0ck5hbWUgPSBudWxsLFxyXG4gICAgICAgICAgICBpcHRzID0gZG9tVXRpbHMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoY29udCxcImlucHV0XCIpO1xyXG4gICAgICAgIGZvcih2YXIgaT1pcHRzLmxlbmd0aC0xLGlwdDtpcHQ9aXB0c1tpLS1dOyl7XHJcbiAgICAgICAgICAgIGlucHV0VHlwZSA9IGlwdC5nZXRBdHRyaWJ1dGUoXCJ0eXBlXCIpO1xyXG4gICAgICAgICAgICBpZihpbnB1dFR5cGU9PVwiY2hlY2tib3hcIil7XHJcbiAgICAgICAgICAgICAgICBhdHRyTmFtZSA9IGlwdC5nZXRBdHRyaWJ1dGUoXCJuYW1lXCIpO1xyXG4gICAgICAgICAgICAgICAgb3B0W2F0dHJOYW1lXSAmJiBkZWxldGUgb3B0W2F0dHJOYW1lXTtcclxuICAgICAgICAgICAgICAgIGlmKGlwdC5jaGVja2VkKXtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYXR0clZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIGF0dHJOYW1lICsgXCJWYWx1ZVwiICsgZWRpdG9ySWQgKTtcclxuICAgICAgICAgICAgICAgICAgICBpZihhdHRyVmFsdWUpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZigvaW5wdXQvaWcudGVzdChhdHRyVmFsdWUudGFnTmFtZSkpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0W2F0dHJOYW1lXSA9IGF0dHJWYWx1ZS52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpcHRDaGlsZHMgPSBhdHRyVmFsdWUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJpbnB1dFwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaj1pcHRDaGlsZHMubGVuZ3RoLTEsaXB0Y2hpbGQ7aXB0Y2hpbGQ9aXB0Q2hpbGRzW2otLV07KXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpcHRjaGlsZC5jaGVja2VkKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0W2F0dHJOYW1lXSA9IGlwdGNoaWxkLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRbYXR0ck5hbWVdID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIG9wdFthdHRyTmFtZV0gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG9wdFtpcHQuZ2V0QXR0cmlidXRlKFwidmFsdWVcIildID0gaXB0LmNoZWNrZWQ7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB2YXIgc2VsZWN0cyA9IGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lKGNvbnQsXCJzZWxlY3RcIik7XHJcbiAgICAgICAgZm9yKHZhciBpPTAsc2k7c2k9c2VsZWN0c1tpKytdOyl7XHJcbiAgICAgICAgICAgIHZhciBhdHRyID0gc2kuZ2V0QXR0cmlidXRlKCduYW1lJyk7XHJcbiAgICAgICAgICAgIG9wdFthdHRyXSA9IG9wdFthdHRyXSA/IHNpLnZhbHVlIDogJyc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB1dGlscy5leHRlbmQobWUuZWRpdG9yLm9wdGlvbnMuYXV0b3R5cGVzZXQsb3B0KTtcclxuXHJcbiAgICAgICAgbWUuZWRpdG9yLnNldFByZWZlcmVuY2VzKCdhdXRvdHlwZXNldCcsIG9wdCk7XHJcbiAgICB9XHJcblxyXG4gICAgQXV0b1R5cGVTZXRCdXR0b24ucHJvdG90eXBlID0ge1xyXG4gICAgICAgIGluaXRBdXRvVHlwZVNldEJ1dHRvbjogZnVuY3Rpb24gKCl7XHJcblxyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICB0aGlzLnBvcHVwID0gbmV3IFBvcHVwKHtcclxuICAgICAgICAgICAgICAgIC8v5Lyg5YWl6YWN572u5Y+C5pWwXHJcbiAgICAgICAgICAgICAgICBjb250ZW50OiBuZXcgQXV0b1R5cGVTZXRQaWNrZXIoe2VkaXRvcjptZS5lZGl0b3J9KSxcclxuICAgICAgICAgICAgICAgICdlZGl0b3InOm1lLmVkaXRvcixcclxuICAgICAgICAgICAgICAgIGhpZGUgOiBmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5faGlkZGVuICYmIHRoaXMuZ2V0RG9tKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZ2V0UGFyYSh0aGlzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXREb20oKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRkZW4gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnaGlkZScpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHZhciBmbGFnID0gMDtcclxuICAgICAgICAgICAgdGhpcy5wb3B1cC5hZGRMaXN0ZW5lcigncG9zdFJlbmRlckFmdGVyJyxmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgdmFyIHBvcHVwVUkgPSB0aGlzO1xyXG4gICAgICAgICAgICAgICAgaWYoZmxhZylyZXR1cm47XHJcbiAgICAgICAgICAgICAgICB2YXIgY29udCA9IHRoaXMuZ2V0RG9tKCksXHJcbiAgICAgICAgICAgICAgICAgICAgYnRuID0gY29udC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYnV0dG9uJylbMF07XHJcblxyXG4gICAgICAgICAgICAgICAgYnRuLm9uY2xpY2sgPSBmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgICAgIGdldFBhcmEocG9wdXBVSSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuZWRpdG9yLmV4ZWNDb21tYW5kKCdhdXRvdHlwZXNldCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIHBvcHVwVUkuaGlkZSgpXHJcbiAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLm9uKGNvbnQsICdjbGljaycsIGZ1bmN0aW9uKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS50YXJnZXQgfHwgZS5zcmNFbGVtZW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlZGl0b3JJZCA9IG1lLmVkaXRvci51aWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQudGFnTmFtZSA9PSAnSU5QVVQnKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyDngrnlh7vlm77niYfmta7liqjnmoRjaGVja2JveCzljrvpmaTlr7nlupTnmoRyYWRpb1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0Lm5hbWUgPT0gJ2ltYWdlQmxvY2tMaW5lJyB8fCB0YXJnZXQubmFtZSA9PSAndGV4dEFsaWduJyB8fCB0YXJnZXQubmFtZSA9PSAnc3ltYm9sQ29udmVyJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoZWNrZWQgPSB0YXJnZXQuY2hlY2tlZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWRpb1RkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIHRhcmdldC5uYW1lICsgJ1ZhbHVlJyArIGVkaXRvcklkKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWRpb3MgPSByYWRpb1RkLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbnB1dCcpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmFsdXRTZWxlY3QgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdpbWFnZUJsb2NrTGluZSc6ICdub25lJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3RleHRBbGlnbic6ICdsZWZ0JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3N5bWJvbENvbnZlcic6ICd0b2JkYydcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmFkaW9zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoZWNrZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJhZGlvc1tpXS52YWx1ZSA9PSBkZWZhbHV0U2VsZWN0W3RhcmdldC5uYW1lXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFkaW9zW2ldLmNoZWNrZWQgPSAnY2hlY2tlZCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWRpb3NbaV0uY2hlY2tlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyDngrnlh7tyYWRpbyzpgInkuK3lr7nlupTnmoRjaGVja2JveFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0Lm5hbWUgPT0gKCdpbWFnZUJsb2NrTGluZVZhbHVlJyArIGVkaXRvcklkKSB8fCB0YXJnZXQubmFtZSA9PSAoJ3RleHRBbGlnblZhbHVlJyArIGVkaXRvcklkKSB8fCB0YXJnZXQubmFtZSA9PSAnYmRjJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoZWNrYm94cyA9IHRhcmdldC5wYXJlbnROb2RlLnByZXZpb3VzU2libGluZy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaW5wdXQnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrYm94cyAmJiAoY2hlY2tib3hzWzBdLmNoZWNrZWQgPSB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgZ2V0UGFyYShwb3B1cFVJKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICBmbGFnID0gMTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdFNwbGl0QnV0dG9uKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIHV0aWxzLmluaGVyaXRzKEF1dG9UeXBlU2V0QnV0dG9uLCBTcGxpdEJ1dHRvbik7XHJcblxyXG59KSgpO1xyXG5cblxuLy8gdWkvY2VsbGFsaWducGlja2VyLmpzXG4vLy9pbXBvcnQgY29yZVxuLy8vaW1wb3J0IHVpY29yZVxuKGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgdXRpbHMgPSBiYWlkdS5lZGl0b3IudXRpbHMsXG4gICAgICAgIFBvcHVwID0gYmFpZHUuZWRpdG9yLnVpLlBvcHVwLFxuICAgICAgICBTdGF0ZWZ1bCA9IGJhaWR1LmVkaXRvci51aS5TdGF0ZWZ1bCxcbiAgICAgICAgVUlCYXNlID0gYmFpZHUuZWRpdG9yLnVpLlVJQmFzZTtcblxuICAgIC8qKlxuICAgICAqIOivpeWPguaVsOWwhuaWsOWinuS4gOS4quWPguaVsO+8miBzZWxlY3RlZO+8jCDlj4LmlbDnsbvlnovkuLrkuIDkuKpPYmplY3TvvIwg5b2i5aaCeyAnYWxpZ24nOiAnY2VudGVyJywgJ3ZhbGlnbic6ICd0b3AnIH3vvIwg6KGo56S65Y2V5YWD5qC855qE5Yid5aeLXG4gICAgICog5a+56b2Q54q25oCB5Li677yaIOerluebtOWxheS4iu+8jOawtOW5s+WxheS4rTsg5YW25LitIGFsaWdu55qE5Y+W5YC85Li677yaJ2NlbnRlcicsICdsZWZ0JywgJ3JpZ2h0JzsgdmFsaWdu55qE5Y+W5YC85Li6OiAndG9wJywgJ21pZGRsZScsICdib3R0b20nXG4gICAgICogQHVwZGF0ZSAyMDEzLzQvMiBoYW5jb25nMDNAYmFpZHUuY29tXG4gICAgICovXG4gICAgdmFyIENlbGxBbGlnblBpY2tlciA9IGJhaWR1LmVkaXRvci51aS5DZWxsQWxpZ25QaWNrZXIgPSBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgICB0aGlzLmluaXRPcHRpb25zKG9wdGlvbnMpO1xuICAgICAgICB0aGlzLmluaXRTZWxlY3RlZCgpO1xuICAgICAgICB0aGlzLmluaXRDZWxsQWxpZ25QaWNrZXIoKTtcbiAgICB9O1xuICAgIENlbGxBbGlnblBpY2tlci5wcm90b3R5cGUgPSB7XG4gICAgICAgIC8v5Yid5aeL5YyW6YCJ5Lit54q25oCB77yMIOivpeaWueazleWwhuagueaNruS8oOmAkui/m+adpeeahOWPguaVsOiOt+WPluWIsOW6lOivpemAieS4reeahOWvuem9kOaWueW8j+Wbvuagh+eahOe0ouW8lVxuICAgICAgICBpbml0U2VsZWN0ZWQ6IGZ1bmN0aW9uKCl7XG5cbiAgICAgICAgICAgIHZhciBzdGF0dXMgPSB7XG5cbiAgICAgICAgICAgICAgICB2YWxpZ246IHtcbiAgICAgICAgICAgICAgICAgICAgdG9wOiAwLFxuICAgICAgICAgICAgICAgICAgICBtaWRkbGU6IDEsXG4gICAgICAgICAgICAgICAgICAgIGJvdHRvbTogMlxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgYWxpZ246IHtcbiAgICAgICAgICAgICAgICAgICAgbGVmdDogMCxcbiAgICAgICAgICAgICAgICAgICAgY2VudGVyOiAxLFxuICAgICAgICAgICAgICAgICAgICByaWdodDogMlxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgY291bnQ6IDNcblxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gLTE7XG5cbiAgICAgICAgICAgIGlmKCB0aGlzLnNlbGVjdGVkICkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRJbmRleCA9IHN0YXR1cy52YWxpZ25bIHRoaXMuc2VsZWN0ZWQudmFsaWduIF0gKiBzdGF0dXMuY291bnQgKyBzdGF0dXMuYWxpZ25bIHRoaXMuc2VsZWN0ZWQuYWxpZ24gXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9LFxuICAgICAgICBpbml0Q2VsbEFsaWduUGlja2VyOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdFVJQmFzZSgpO1xuICAgICAgICAgICAgdGhpcy5TdGF0ZWZ1bF9pbml0KCk7XG4gICAgICAgIH0sXG4gICAgICAgIGdldEh0bWxUcGw6ZnVuY3Rpb24gKCkge1xuXG4gICAgICAgICAgICB2YXIgYWxpZ25UeXBlID0gWyAnbGVmdCcsICdjZW50ZXInLCAncmlnaHQnIF0sXG4gICAgICAgICAgICAgICAgQ09VTlQgPSA5LFxuICAgICAgICAgICAgICAgIHRlbXBDbGFzc05hbWUgPSBudWxsLFxuICAgICAgICAgICAgICAgIHRlbXBJbmRleCA9IC0xLFxuICAgICAgICAgICAgICAgIHRtcGwgPSBbXTtcblxuXG4gICAgICAgICAgICBmb3IoIHZhciBpPSAwOyBpPENPVU5UOyBpKysgKSB7XG5cbiAgICAgICAgICAgICAgICB0ZW1wQ2xhc3NOYW1lID0gdGhpcy5zZWxlY3RlZEluZGV4ID09PSBpID8gJyBjbGFzcz1cImVkdWktY2VsbGFsaWduLXNlbGVjdGVkXCIgJyA6ICcnO1xuICAgICAgICAgICAgICAgIHRlbXBJbmRleCA9IGkgJSAzO1xuXG4gICAgICAgICAgICAgICAgdGVtcEluZGV4ID09PSAwICYmIHRtcGwucHVzaCgnPHRyPicpO1xuXG4gICAgICAgICAgICAgICAgdG1wbC5wdXNoKCAnPHRkIGluZGV4PVwiJysgaSArJ1wiICcgKyB0ZW1wQ2xhc3NOYW1lICsgJyBzdGF0ZWZ1bD48ZGl2IGNsYXNzPVwiZWR1aS1pY29uIGVkdWktJysgYWxpZ25UeXBlWyB0ZW1wSW5kZXggXSArJ1wiPjwvZGl2PjwvdGQ+JyApO1xuXG4gICAgICAgICAgICAgICAgdGVtcEluZGV4ID09PSAyICYmIHRtcGwucHVzaCgnPC90cj4nKTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gJzxkaXYgaWQ9XCIjI1wiIGNsYXNzPVwiZWR1aS1jZWxsYWxpZ25waWNrZXIgJSVcIj4nICtcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImVkdWktY2VsbGFsaWducGlja2VyLWJvZHlcIj4nICtcbiAgICAgICAgICAgICAgICAnPHRhYmxlIG9uY2xpY2s9XCIkJC5fb25DbGljayhldmVudCk7XCI+JyArXG4gICAgICAgICAgICAgICAgdG1wbC5qb2luKCcnKSArXG4gICAgICAgICAgICAgICAgJzwvdGFibGU+JyArXG4gICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICc8L2Rpdj4nO1xuICAgICAgICB9LFxuICAgICAgICBnZXRTdGF0ZURvbTogZnVuY3Rpb24gKCl7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy50YXJnZXQ7XG4gICAgICAgIH0sXG4gICAgICAgIF9vbkNsaWNrOiBmdW5jdGlvbiAoZXZ0KXtcbiAgICAgICAgICAgIHZhciB0YXJnZXQ9IGV2dC50YXJnZXQgfHwgZXZ0LnNyY0VsZW1lbnQ7XG4gICAgICAgICAgICBpZigvaWNvbi8udGVzdCh0YXJnZXQuY2xhc3NOYW1lKSl7XG4gICAgICAgICAgICAgICAgdGhpcy5pdGVtc1t0YXJnZXQucGFyZW50Tm9kZS5nZXRBdHRyaWJ1dGUoXCJpbmRleFwiKV0ub25jbGljaygpO1xuICAgICAgICAgICAgICAgIFBvcHVwLnBvc3RIaWRlKGV2dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIF9VSUJhc2VfcmVuZGVyOlVJQmFzZS5wcm90b3R5cGUucmVuZGVyXG4gICAgfTtcbiAgICB1dGlscy5pbmhlcml0cyhDZWxsQWxpZ25QaWNrZXIsIFVJQmFzZSk7XG4gICAgdXRpbHMuZXh0ZW5kKENlbGxBbGlnblBpY2tlci5wcm90b3R5cGUsIFN0YXRlZnVsLHRydWUpO1xufSkoKTtcblxuXG5cblxuXG4vLyB1aS9wYXN0ZXBpY2tlci5qc1xuLy8vaW1wb3J0IGNvcmVcbi8vL2ltcG9ydCB1aWNvcmVcbihmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHV0aWxzID0gYmFpZHUuZWRpdG9yLnV0aWxzLFxuICAgICAgICBTdGF0ZWZ1bCA9IGJhaWR1LmVkaXRvci51aS5TdGF0ZWZ1bCxcbiAgICAgICAgdWlVdGlscyA9IGJhaWR1LmVkaXRvci51aS51aVV0aWxzLFxuICAgICAgICBVSUJhc2UgPSBiYWlkdS5lZGl0b3IudWkuVUlCYXNlO1xuXG4gICAgdmFyIFBhc3RlUGlja2VyID0gYmFpZHUuZWRpdG9yLnVpLlBhc3RlUGlja2VyID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5pbml0T3B0aW9ucyhvcHRpb25zKTtcbiAgICAgICAgdGhpcy5pbml0UGFzdGVQaWNrZXIoKTtcbiAgICB9O1xuICAgIFBhc3RlUGlja2VyLnByb3RvdHlwZSA9IHtcbiAgICAgICAgaW5pdFBhc3RlUGlja2VyOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdFVJQmFzZSgpO1xuICAgICAgICAgICAgdGhpcy5TdGF0ZWZ1bF9pbml0KCk7XG4gICAgICAgIH0sXG4gICAgICAgIGdldEh0bWxUcGw6ZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuICc8ZGl2IGNsYXNzPVwiZWR1aS1wYXN0ZWljb25cIiBvbmNsaWNrPVwiJCQuX29uQ2xpY2sodGhpcylcIj48L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImVkdWktcGFzdGVjb250YWluZXJcIj4nICtcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImVkdWktdGl0bGVcIj4nICsgdGhpcy5lZGl0b3IuZ2V0TGFuZyhcInBhc3RlT3B0XCIpICsgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiZWR1aS1idXR0b25cIj4nICtcbiAgICAgICAgICAgICAgICAnPGRpdiB0aXRsZT1cIicgKyB0aGlzLmVkaXRvci5nZXRMYW5nKFwicGFzdGVTb3VyY2VGb3JtYXRcIikgKyAnXCIgb25jbGljaz1cIiQkLmZvcm1hdChmYWxzZSlcIiBzdGF0ZWZ1bD4nICtcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImVkdWktcmljaHR4dGljb25cIj48L2Rpdj48L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAnPGRpdiB0aXRsZT1cIicgKyB0aGlzLmVkaXRvci5nZXRMYW5nKFwidGFnRm9ybWF0XCIpICsgJ1wiIG9uY2xpY2s9XCIkJC5mb3JtYXQoMilcIiBzdGF0ZWZ1bD4nICtcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImVkdWktdGFnaWNvblwiPjwvZGl2PjwvZGl2PicgK1xuICAgICAgICAgICAgICAgICc8ZGl2IHRpdGxlPVwiJyArIHRoaXMuZWRpdG9yLmdldExhbmcoXCJwYXN0ZVRleHRGb3JtYXRcIikgKyAnXCIgb25jbGljaz1cIiQkLmZvcm1hdCh0cnVlKVwiIHN0YXRlZnVsPicgK1xuICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiZWR1aS1wbGFpbnR4dGljb25cIj48L2Rpdj48L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICc8L2Rpdj4nXG4gICAgICAgIH0sXG4gICAgICAgIGdldFN0YXRlRG9tOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRhcmdldDtcbiAgICAgICAgfSxcbiAgICAgICAgZm9ybWF0OmZ1bmN0aW9uIChwYXJhbSkge1xuICAgICAgICAgICAgdGhpcy5lZGl0b3IudWkuX2lzVHJhbnNmZXIgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5lZGl0b3IuZmlyZUV2ZW50KCdwYXN0ZVRyYW5zZmVyJywgcGFyYW0pO1xuICAgICAgICB9LFxuICAgICAgICBfb25DbGljazpmdW5jdGlvbiAoY3VyKSB7XG4gICAgICAgICAgICB2YXIgbm9kZSA9IGRvbVV0aWxzLmdldE5leHREb21Ob2RlKGN1ciksXG4gICAgICAgICAgICAgICAgc2NyZWVuSHQgPSB1aVV0aWxzLmdldFZpZXdwb3J0UmVjdCgpLmhlaWdodCxcbiAgICAgICAgICAgICAgICBzdWJQb3AgPSB1aVV0aWxzLmdldENsaWVudFJlY3Qobm9kZSk7XG5cbiAgICAgICAgICAgIGlmICgoc3ViUG9wLnRvcCArIHN1YlBvcC5oZWlnaHQpID4gc2NyZWVuSHQpXG4gICAgICAgICAgICAgICAgbm9kZS5zdHlsZS50b3AgPSAoLXN1YlBvcC5oZWlnaHQgLSBjdXIub2Zmc2V0SGVpZ2h0KSArIFwicHhcIjtcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBub2RlLnN0eWxlLnRvcCA9IFwiXCI7XG5cbiAgICAgICAgICAgIGlmICgvaGlkZGVuL2lnLnRlc3QoZG9tVXRpbHMuZ2V0Q29tcHV0ZWRTdHlsZShub2RlLCBcInZpc2liaWxpdHlcIikpKSB7XG4gICAgICAgICAgICAgICAgbm9kZS5zdHlsZS52aXNpYmlsaXR5ID0gXCJ2aXNpYmxlXCI7XG4gICAgICAgICAgICAgICAgZG9tVXRpbHMuYWRkQ2xhc3MoY3VyLCBcImVkdWktc3RhdGUtb3BlbmVkXCIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBub2RlLnN0eWxlLnZpc2liaWxpdHkgPSBcImhpZGRlblwiO1xuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZUNsYXNzZXMoY3VyLCBcImVkdWktc3RhdGUtb3BlbmVkXCIpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIF9VSUJhc2VfcmVuZGVyOlVJQmFzZS5wcm90b3R5cGUucmVuZGVyXG4gICAgfTtcbiAgICB1dGlscy5pbmhlcml0cyhQYXN0ZVBpY2tlciwgVUlCYXNlKTtcbiAgICB1dGlscy5leHRlbmQoUGFzdGVQaWNrZXIucHJvdG90eXBlLCBTdGF0ZWZ1bCwgdHJ1ZSk7XG59KSgpO1xuXG5cblxuXG5cblxuLy8gdWkvdG9vbGJhci5qc1xuKGZ1bmN0aW9uICgpe1xyXG4gICAgdmFyIHV0aWxzID0gYmFpZHUuZWRpdG9yLnV0aWxzLFxyXG4gICAgICAgIHVpVXRpbHMgPSBiYWlkdS5lZGl0b3IudWkudWlVdGlscyxcclxuICAgICAgICBVSUJhc2UgPSBiYWlkdS5lZGl0b3IudWkuVUlCYXNlLFxyXG4gICAgICAgIFRvb2xiYXIgPSBiYWlkdS5lZGl0b3IudWkuVG9vbGJhciA9IGZ1bmN0aW9uIChvcHRpb25zKXtcclxuICAgICAgICAgICAgdGhpcy5pbml0T3B0aW9ucyhvcHRpb25zKTtcclxuICAgICAgICAgICAgdGhpcy5pbml0VG9vbGJhcigpO1xyXG4gICAgICAgIH07XHJcbiAgICBUb29sYmFyLnByb3RvdHlwZSA9IHtcclxuICAgICAgICBpdGVtczogbnVsbCxcclxuICAgICAgICBpbml0VG9vbGJhcjogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHRoaXMuaXRlbXMgPSB0aGlzLml0ZW1zIHx8IFtdO1xyXG4gICAgICAgICAgICB0aGlzLmluaXRVSUJhc2UoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGFkZDogZnVuY3Rpb24gKGl0ZW0saW5kZXgpe1xyXG4gICAgICAgICAgICBpZihpbmRleCA9PT0gdW5kZWZpbmVkKXtcclxuICAgICAgICAgICAgICAgIHRoaXMuaXRlbXMucHVzaChpdGVtKTtcclxuICAgICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgICAgICB0aGlzLml0ZW1zLnNwbGljZShpbmRleCwwLGl0ZW0pXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRIdG1sVHBsOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgdmFyIGJ1ZmYgPSBbXTtcclxuICAgICAgICAgICAgZm9yICh2YXIgaT0wOyBpPHRoaXMuaXRlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGJ1ZmZbaV0gPSB0aGlzLml0ZW1zW2ldLnJlbmRlckh0bWwoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gJzxkaXYgaWQ9XCIjI1wiIGNsYXNzPVwiZWR1aS10b29sYmFyICUlXCIgb25zZWxlY3RzdGFydD1cInJldHVybiBmYWxzZTtcIiBvbm1vdXNlZG93bj1cInJldHVybiAkJC5fb25Nb3VzZURvd24oZXZlbnQsIHRoaXMpO1wiPicgK1xyXG4gICAgICAgICAgICAgICAgYnVmZi5qb2luKCcnKSArXHJcbiAgICAgICAgICAgICAgICAnPC9kaXY+J1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcG9zdFJlbmRlcjogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHZhciBib3ggPSB0aGlzLmdldERvbSgpO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpPTA7IGk8dGhpcy5pdGVtcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pdGVtc1tpXS5wb3N0UmVuZGVyKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdWlVdGlscy5tYWtlVW5zZWxlY3RhYmxlKGJveCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBfb25Nb3VzZURvd246IGZ1bmN0aW9uIChlKXtcclxuICAgICAgICAgICAgdmFyIHRhcmdldCA9IGUudGFyZ2V0IHx8IGUuc3JjRWxlbWVudCxcclxuICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YXJnZXQgJiYgdGFyZ2V0LnRhZ05hbWUgJiYgdGFyZ2V0LnRhZ05hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgaWYgKHRhZ05hbWUgPT0gJ2lucHV0JyB8fCB0YWdOYW1lID09ICdvYmplY3QnIHx8IHRhZ05hbWUgPT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICB1dGlscy5pbmhlcml0cyhUb29sYmFyLCBVSUJhc2UpO1xyXG5cclxufSkoKTtcclxuXG5cbi8vIHVpL21lbnUuanNcbi8vL2ltcG9ydCBjb3JlXHJcbi8vL2ltcG9ydCB1aWNvcmVcclxuLy8vaW1wb3J0IHVpXFxwb3B1cC5qc1xyXG4vLy9pbXBvcnQgdWlcXHN0YXRlZnVsLmpzXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgdXRpbHMgPSBiYWlkdS5lZGl0b3IudXRpbHMsXHJcbiAgICAgICAgZG9tVXRpbHMgPSBiYWlkdS5lZGl0b3IuZG9tLmRvbVV0aWxzLFxyXG4gICAgICAgIHVpVXRpbHMgPSBiYWlkdS5lZGl0b3IudWkudWlVdGlscyxcclxuICAgICAgICBVSUJhc2UgPSBiYWlkdS5lZGl0b3IudWkuVUlCYXNlLFxyXG4gICAgICAgIFBvcHVwID0gYmFpZHUuZWRpdG9yLnVpLlBvcHVwLFxyXG4gICAgICAgIFN0YXRlZnVsID0gYmFpZHUuZWRpdG9yLnVpLlN0YXRlZnVsLFxyXG4gICAgICAgIENlbGxBbGlnblBpY2tlciA9IGJhaWR1LmVkaXRvci51aS5DZWxsQWxpZ25QaWNrZXIsXHJcblxyXG4gICAgICAgIE1lbnUgPSBiYWlkdS5lZGl0b3IudWkuTWVudSA9IGZ1bmN0aW9uIChvcHRpb25zKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdE9wdGlvbnMob3B0aW9ucyk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5pdE1lbnUoKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgIHZhciBtZW51U2VwYXJhdG9yID0ge1xyXG4gICAgICAgIHJlbmRlckh0bWw6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gJzxkaXYgY2xhc3M9XCJlZHVpLW1lbnVpdGVtIGVkdWktbWVudXNlcGFyYXRvclwiPjxkaXYgY2xhc3M9XCJlZHVpLW1lbnVzZXBhcmF0b3ItaW5uZXJcIj48L2Rpdj48L2Rpdj4nO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcG9zdFJlbmRlcjpmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBxdWVyeUF1dG9IaWRlOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIE1lbnUucHJvdG90eXBlID0ge1xyXG4gICAgICAgIGl0ZW1zOm51bGwsXHJcbiAgICAgICAgdWlOYW1lOidtZW51JyxcclxuICAgICAgICBpbml0TWVudTpmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaXRlbXMgPSB0aGlzLml0ZW1zIHx8IFtdO1xyXG4gICAgICAgICAgICB0aGlzLmluaXRQb3B1cCgpO1xyXG4gICAgICAgICAgICB0aGlzLmluaXRJdGVtcygpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgaW5pdEl0ZW1zOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLml0ZW1zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgaXRlbSA9IHRoaXMuaXRlbXNbaV07XHJcbiAgICAgICAgICAgICAgICBpZiAoaXRlbSA9PSAnLScpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW1zW2ldID0gdGhpcy5nZXRTZXBhcmF0b3IoKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIShpdGVtIGluc3RhbmNlb2YgTWVudUl0ZW0pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaXRlbS5lZGl0b3IgPSB0aGlzLmVkaXRvcjtcclxuICAgICAgICAgICAgICAgICAgICBpdGVtLnRoZW1lID0gdGhpcy5lZGl0b3Iub3B0aW9ucy50aGVtZTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW1zW2ldID0gdGhpcy5jcmVhdGVJdGVtKGl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRTZXBhcmF0b3I6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gbWVudVNlcGFyYXRvcjtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGNyZWF0ZUl0ZW06ZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgICAgICAgLy/mlrDlop7kuIDkuKrlj4LmlbBtZW51LCDor6Xlj4LmlbDlrZjlgqjkuoZtZW51SXRlbeaJgOWvueW6lOeahG1lbnXlvJXnlKhcclxuICAgICAgICAgICAgaXRlbS5tZW51ID0gdGhpcztcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBNZW51SXRlbShpdGVtKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIF9Qb3B1cF9nZXRDb250ZW50SHRtbFRwbDpQb3B1cC5wcm90b3R5cGUuZ2V0Q29udGVudEh0bWxUcGwsXHJcbiAgICAgICAgZ2V0Q29udGVudEh0bWxUcGw6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pdGVtcy5sZW5ndGggPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX1BvcHVwX2dldENvbnRlbnRIdG1sVHBsKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGJ1ZmYgPSBbXTtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLml0ZW1zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgaXRlbSA9IHRoaXMuaXRlbXNbaV07XHJcbiAgICAgICAgICAgICAgICBidWZmW2ldID0gaXRlbS5yZW5kZXJIdG1sKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuICgnPGRpdiBjbGFzcz1cIiUlLWJvZHlcIj4nICsgYnVmZi5qb2luKCcnKSArICc8L2Rpdj4nKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIF9Qb3B1cF9wb3N0UmVuZGVyOlBvcHVwLnByb3RvdHlwZS5wb3N0UmVuZGVyLFxyXG4gICAgICAgIHBvc3RSZW5kZXI6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuaXRlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciBpdGVtID0gdGhpcy5pdGVtc1tpXTtcclxuICAgICAgICAgICAgICAgIGl0ZW0ub3duZXJNZW51ID0gdGhpcztcclxuICAgICAgICAgICAgICAgIGl0ZW0ucG9zdFJlbmRlcigpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLm9uKHRoaXMuZ2V0RG9tKCksICdtb3VzZW92ZXInLCBmdW5jdGlvbiAoZXZ0KSB7XHJcbiAgICAgICAgICAgICAgICBldnQgPSBldnQgfHwgZXZlbnQ7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVsID0gZXZ0LnJlbGF0ZWRUYXJnZXQgfHwgZXZ0LmZyb21FbGVtZW50O1xyXG4gICAgICAgICAgICAgICAgdmFyIGVsID0gbWUuZ2V0RG9tKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXVpVXRpbHMuY29udGFpbnMoZWwsIHJlbCkgJiYgZWwgIT09IHJlbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCgnb3ZlcicpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5fUG9wdXBfcG9zdFJlbmRlcigpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcXVlcnlBdXRvSGlkZTpmdW5jdGlvbiAoZWwpIHtcclxuICAgICAgICAgICAgaWYgKGVsKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodWlVdGlscy5jb250YWlucyh0aGlzLmdldERvbSgpLCBlbCkpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuaXRlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbSA9IHRoaXMuaXRlbXNbaV07XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ucXVlcnlBdXRvSGlkZShlbCkgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGNsZWFySXRlbXM6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuaXRlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciBpdGVtID0gdGhpcy5pdGVtc1tpXTtcclxuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChpdGVtLl9zaG93aW5nVGltZXIpO1xyXG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGl0ZW0uX2Nsb3NpbmdUaW1lcik7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXRlbS5zdWJNZW51KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaXRlbS5zdWJNZW51LmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLml0ZW1zID0gW107XHJcbiAgICAgICAgfSxcclxuICAgICAgICBkZXN0cm95OmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZ2V0RG9tKCkpIHtcclxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZSh0aGlzLmdldERvbSgpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmNsZWFySXRlbXMoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGRpc3Bvc2U6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgdXRpbHMuaW5oZXJpdHMoTWVudSwgUG9wdXApO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogQHVwZGF0ZSAyMDEzLzA0LzAzIGhhbmNvbmcwMyDmlrDlop7kuIDkuKrlj4LmlbBtZW51LCDor6Xlj4LmlbDlrZjlgqjkuoZtZW51SXRlbeaJgOWvueW6lOeahG1lbnXlvJXnlKhcclxuICAgICAqIEB0eXBlIHtGdW5jdGlvbn1cclxuICAgICAqL1xyXG4gICAgdmFyIE1lbnVJdGVtID0gYmFpZHUuZWRpdG9yLnVpLk1lbnVJdGVtID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcclxuICAgICAgICB0aGlzLmluaXRPcHRpb25zKG9wdGlvbnMpO1xyXG4gICAgICAgIHRoaXMuaW5pdFVJQmFzZSgpO1xyXG4gICAgICAgIHRoaXMuU3RhdGVmdWxfaW5pdCgpO1xyXG4gICAgICAgIGlmICh0aGlzLnN1Yk1lbnUgJiYgISh0aGlzLnN1Yk1lbnUgaW5zdGFuY2VvZiBNZW51KSkge1xyXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5jbGFzc05hbWUgJiYgb3B0aW9ucy5jbGFzc05hbWUuaW5kZXhPZihcImFsaWdudGRcIikgIT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7XHJcblxyXG4gICAgICAgICAgICAgICAgLy/ojrflj5bljZXlhYPmoLzlr7npvZDliJ3lp4vnirbmgIFcclxuICAgICAgICAgICAgICAgIHRoaXMuc3ViTWVudS5zZWxlY3RlZCA9IHRoaXMuZWRpdG9yLnF1ZXJ5Q29tbWFuZFZhbHVlKCAnY2VsbGFsaWdubWVudCcgKTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLnN1Yk1lbnUgPSBuZXcgUG9wdXAoe1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6bmV3IENlbGxBbGlnblBpY2tlcih0aGlzLnN1Yk1lbnUpLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudE1lbnU6bWUsXHJcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yOm1lLmVkaXRvcixcclxuICAgICAgICAgICAgICAgICAgICBkZXN0cm95OmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2V0RG9tKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZSh0aGlzLmdldERvbSgpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdWJNZW51LmFkZExpc3RlbmVyKFwicG9zdFJlbmRlckFmdGVyXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5vbih0aGlzLmdldERvbSgpLCBcIm1vdXNlb3ZlclwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmFkZFN0YXRlKCdvcGVuZWQnKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdWJNZW51ID0gbmV3IE1lbnUodGhpcy5zdWJNZW51KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBNZW51SXRlbS5wcm90b3R5cGUgPSB7XHJcbiAgICAgICAgbGFiZWw6JycsXHJcbiAgICAgICAgc3ViTWVudTpudWxsLFxyXG4gICAgICAgIG93bmVyTWVudTpudWxsLFxyXG4gICAgICAgIHVpTmFtZTonbWVudWl0ZW0nLFxyXG4gICAgICAgIGFsd2FseXNIb3ZlcmFibGU6dHJ1ZSxcclxuICAgICAgICBnZXRIdG1sVHBsOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuICc8ZGl2IGlkPVwiIyNcIiBjbGFzcz1cIiUlXCIgc3RhdGVmdWwgb25jbGljaz1cIiQkLl9vbkNsaWNrKGV2ZW50LCB0aGlzKTtcIj4nICtcclxuICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiJSUtYm9keVwiPicgK1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJMYWJlbEh0bWwoKSArXHJcbiAgICAgICAgICAgICAgICAnPC9kaXY+JyArXHJcbiAgICAgICAgICAgICAgICAnPC9kaXY+JztcclxuICAgICAgICB9LFxyXG4gICAgICAgIHBvc3RSZW5kZXI6ZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICB0aGlzLmFkZExpc3RlbmVyKCdvdmVyJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgbWUub3duZXJNZW51LmZpcmVFdmVudCgnc3VibWVudW92ZXInLCBtZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAobWUuc3ViTWVudSkge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLmRlbGF5U2hvd1N1Yk1lbnUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnN1Yk1lbnUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0RG9tKCkuY2xhc3NOYW1lICs9ICcgZWR1aS1oYXNzdWJtZW51JztcclxuICAgICAgICAgICAgICAgIHRoaXMuc3ViTWVudS5yZW5kZXIoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuYWRkTGlzdGVuZXIoJ291dCcsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBtZS5kZWxheUhpZGVTdWJNZW51KCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3ViTWVudS5hZGRMaXN0ZW5lcignb3ZlcicsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQobWUuX2Nsb3NpbmdUaW1lcik7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuX2Nsb3NpbmdUaW1lciA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuYWRkU3RhdGUoJ29wZW5lZCcpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm93bmVyTWVudS5hZGRMaXN0ZW5lcignaGlkZScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBtZS5oaWRlU3ViTWVudSgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm93bmVyTWVudS5hZGRMaXN0ZW5lcignc3VibWVudW92ZXInLCBmdW5jdGlvbiAodCwgc3ViTWVudSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdWJNZW51ICE9PSBtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5kZWxheUhpZGVTdWJNZW51KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN1Yk1lbnUuX2Jha1F1ZXJ5QXV0b0hpZGUgPSB0aGlzLnN1Yk1lbnUucXVlcnlBdXRvSGlkZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3ViTWVudS5xdWVyeUF1dG9IaWRlID0gZnVuY3Rpb24gKGVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVsICYmIHVpVXRpbHMuY29udGFpbnMobWUuZ2V0RG9tKCksIGVsKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9iYWtRdWVyeUF1dG9IaWRlKGVsKTtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5nZXREb20oKS5zdHlsZS50YWJJbmRleCA9ICctMSc7XHJcbiAgICAgICAgICAgIHVpVXRpbHMubWFrZVVuc2VsZWN0YWJsZSh0aGlzLmdldERvbSgpKTtcclxuICAgICAgICAgICAgdGhpcy5TdGF0ZWZ1bF9wb3N0UmVuZGVyKCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBkZWxheVNob3dTdWJNZW51OmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcclxuICAgICAgICAgICAgaWYgKCFtZS5pc0Rpc2FibGVkKCkpIHtcclxuICAgICAgICAgICAgICAgIG1lLmFkZFN0YXRlKCdvcGVuZWQnKTtcclxuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChtZS5fc2hvd2luZ1RpbWVyKTtcclxuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChtZS5fY2xvc2luZ1RpbWVyKTtcclxuICAgICAgICAgICAgICAgIG1lLl9jbG9zaW5nVGltZXIgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgbWUuX3Nob3dpbmdUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLnNob3dTdWJNZW51KCk7XHJcbiAgICAgICAgICAgICAgICB9LCAyNTApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBkZWxheUhpZGVTdWJNZW51OmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcclxuICAgICAgICAgICAgaWYgKCFtZS5pc0Rpc2FibGVkKCkpIHtcclxuICAgICAgICAgICAgICAgIG1lLnJlbW92ZVN0YXRlKCdvcGVuZWQnKTtcclxuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChtZS5fc2hvd2luZ1RpbWVyKTtcclxuICAgICAgICAgICAgICAgIGlmICghbWUuX2Nsb3NpbmdUaW1lcikge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lLl9jbG9zaW5nVGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtZS5oYXNTdGF0ZSgnb3BlbmVkJykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLmhpZGVTdWJNZW51KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuX2Nsb3NpbmdUaW1lciA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgNDAwKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcmVuZGVyTGFiZWxIdG1sOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuICc8ZGl2IGNsYXNzPVwiZWR1aS1hcnJvd1wiPjwvZGl2PicgK1xyXG4gICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJlZHVpLWJveCBlZHVpLWljb25cIj48L2Rpdj4nICtcclxuICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiZWR1aS1ib3ggZWR1aS1sYWJlbCAlJS1sYWJlbFwiPicgKyAodGhpcy5sYWJlbCB8fCAnJykgKyAnPC9kaXY+JztcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldFN0YXRlRG9tOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RG9tKCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBxdWVyeUF1dG9IaWRlOmZ1bmN0aW9uIChlbCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zdWJNZW51ICYmIHRoaXMuaGFzU3RhdGUoJ29wZW5lZCcpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdWJNZW51LnF1ZXJ5QXV0b0hpZGUoZWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBfb25DbGljazpmdW5jdGlvbiAoZXZlbnQsIHRoaXNfKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmhhc1N0YXRlKCdkaXNhYmxlZCcpKSByZXR1cm47XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmZpcmVFdmVudCgnY2xpY2snLCBldmVudCwgdGhpc18pICE9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc3ViTWVudSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1N1Yk1lbnUoKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgUG9wdXAucG9zdEhpZGUoZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzaG93U3ViTWVudTpmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciByZWN0ID0gdWlVdGlscy5nZXRDbGllbnRSZWN0KHRoaXMuZ2V0RG9tKCkpO1xyXG4gICAgICAgICAgICByZWN0LnJpZ2h0IC09IDU7XHJcbiAgICAgICAgICAgIHJlY3QubGVmdCArPSAyO1xyXG4gICAgICAgICAgICByZWN0LndpZHRoIC09IDc7XHJcbiAgICAgICAgICAgIHJlY3QudG9wIC09IDQ7XHJcbiAgICAgICAgICAgIHJlY3QuYm90dG9tICs9IDQ7XHJcbiAgICAgICAgICAgIHJlY3QuaGVpZ2h0ICs9IDg7XHJcbiAgICAgICAgICAgIHRoaXMuc3ViTWVudS5zaG93QW5jaG9yUmVjdChyZWN0LCB0cnVlLCB0cnVlKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGhpZGVTdWJNZW51OmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdGhpcy5zdWJNZW51LmhpZGUoKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgdXRpbHMuaW5oZXJpdHMoTWVudUl0ZW0sIFVJQmFzZSk7XHJcbiAgICB1dGlscy5leHRlbmQoTWVudUl0ZW0ucHJvdG90eXBlLCBTdGF0ZWZ1bCwgdHJ1ZSk7XHJcbn0pKCk7XHJcblxuXG4vLyB1aS9jb21ib3guanNcbi8vL2ltcG9ydCBjb3JlXHJcbi8vL2ltcG9ydCB1aWNvcmVcclxuLy8vaW1wb3J0IHVpL21lbnUuanNcclxuLy8vaW1wb3J0IHVpL3NwbGl0YnV0dG9uLmpzXHJcbihmdW5jdGlvbiAoKXtcclxuICAgIC8vIHRvZG86IG1lbnXlkoxpdGVt5o+Q5oiQ6YCa55SobGlzdFxyXG4gICAgdmFyIHV0aWxzID0gYmFpZHUuZWRpdG9yLnV0aWxzLFxyXG4gICAgICAgIHVpVXRpbHMgPSBiYWlkdS5lZGl0b3IudWkudWlVdGlscyxcclxuICAgICAgICBNZW51ID0gYmFpZHUuZWRpdG9yLnVpLk1lbnUsXHJcbiAgICAgICAgU3BsaXRCdXR0b24gPSBiYWlkdS5lZGl0b3IudWkuU3BsaXRCdXR0b24sXHJcbiAgICAgICAgQ29tYm94ID0gYmFpZHUuZWRpdG9yLnVpLkNvbWJveCA9IGZ1bmN0aW9uIChvcHRpb25zKXtcclxuICAgICAgICAgICAgdGhpcy5pbml0T3B0aW9ucyhvcHRpb25zKTtcclxuICAgICAgICAgICAgdGhpcy5pbml0Q29tYm94KCk7XHJcbiAgICAgICAgfTtcclxuICAgIENvbWJveC5wcm90b3R5cGUgPSB7XHJcbiAgICAgICAgdWlOYW1lOiAnY29tYm94JyxcclxuICAgICAgICBvbmJ1dHRvbmNsaWNrOmZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdGhpcy5zaG93UG9wdXAoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGluaXRDb21ib3g6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICB0aGlzLml0ZW1zID0gdGhpcy5pdGVtcyB8fCBbXTtcclxuICAgICAgICAgICAgZm9yICh2YXIgaT0wOyBpPHRoaXMuaXRlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciBpdGVtID0gdGhpcy5pdGVtc1tpXTtcclxuICAgICAgICAgICAgICAgIGl0ZW0udWlOYW1lID0gJ2xpc3RpdGVtJztcclxuICAgICAgICAgICAgICAgIGl0ZW0uaW5kZXggPSBpO1xyXG4gICAgICAgICAgICAgICAgaXRlbS5vbmNsaWNrID0gZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgbWUuc2VsZWN0QnlJbmRleCh0aGlzLmluZGV4KTtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5wb3B1cCA9IG5ldyBNZW51KHtcclxuICAgICAgICAgICAgICAgIGl0ZW1zOiB0aGlzLml0ZW1zLFxyXG4gICAgICAgICAgICAgICAgdWlOYW1lOiAnbGlzdCcsXHJcbiAgICAgICAgICAgICAgICBlZGl0b3I6dGhpcy5lZGl0b3IsXHJcbiAgICAgICAgICAgICAgICBjYXB0dXJlV2hlZWw6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBjb21ib3g6IHRoaXNcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmluaXRTcGxpdEJ1dHRvbigpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgX1NwbGl0QnV0dG9uX3Bvc3RSZW5kZXI6IFNwbGl0QnV0dG9uLnByb3RvdHlwZS5wb3N0UmVuZGVyLFxyXG4gICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICB0aGlzLl9TcGxpdEJ1dHRvbl9wb3N0UmVuZGVyKCk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0TGFiZWwodGhpcy5sYWJlbCB8fCAnJyk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodGhpcy5pbml0VmFsdWUgfHwgJycpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2hvd1BvcHVwOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgdmFyIHJlY3QgPSB1aVV0aWxzLmdldENsaWVudFJlY3QodGhpcy5nZXREb20oKSk7XHJcbiAgICAgICAgICAgIHJlY3QudG9wICs9IDE7XHJcbiAgICAgICAgICAgIHJlY3QuYm90dG9tIC09IDE7XHJcbiAgICAgICAgICAgIHJlY3QuaGVpZ2h0IC09IDI7XHJcbiAgICAgICAgICAgIHRoaXMucG9wdXAuc2hvd0FuY2hvclJlY3QocmVjdCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRWYWx1ZTogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnZhbHVlO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0VmFsdWU6IGZ1bmN0aW9uICh2YWx1ZSl7XHJcbiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuaW5kZXhCeVZhbHVlKHZhbHVlKTtcclxuICAgICAgICAgICAgaWYgKGluZGV4ICE9IC0xKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkSW5kZXggPSBpbmRleDtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0TGFiZWwodGhpcy5pdGVtc1tpbmRleF0ubGFiZWwpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMuaXRlbXNbaW5kZXhdLnZhbHVlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEluZGV4ID0gLTE7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldExhYmVsKHRoaXMuZ2V0TGFiZWxGb3JVbmtub3dWYWx1ZSh2YWx1ZSkpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXRMYWJlbDogZnVuY3Rpb24gKGxhYmVsKXtcclxuICAgICAgICAgICAgdGhpcy5nZXREb20oJ2J1dHRvbl9ib2R5JykuaW5uZXJIVE1MID0gbGFiZWw7XHJcbiAgICAgICAgICAgIHRoaXMubGFiZWwgPSBsYWJlbDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldExhYmVsRm9yVW5rbm93VmFsdWU6IGZ1bmN0aW9uICh2YWx1ZSl7XHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGluZGV4QnlWYWx1ZTogZnVuY3Rpb24gKHZhbHVlKXtcclxuICAgICAgICAgICAgZm9yICh2YXIgaT0wOyBpPHRoaXMuaXRlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PSB0aGlzLml0ZW1zW2ldLnZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIC0xO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0SXRlbTogZnVuY3Rpb24gKGluZGV4KXtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXRlbXNbaW5kZXhdO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2VsZWN0QnlJbmRleDogZnVuY3Rpb24gKGluZGV4KXtcclxuICAgICAgICAgICAgaWYgKGluZGV4IDwgdGhpcy5pdGVtcy5sZW5ndGggJiYgdGhpcy5maXJlRXZlbnQoJ3NlbGVjdCcsIGluZGV4KSAhPT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRJbmRleCA9IGluZGV4O1xyXG4gICAgICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMuaXRlbXNbaW5kZXhdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRMYWJlbCh0aGlzLml0ZW1zW2luZGV4XS5sYWJlbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgdXRpbHMuaW5oZXJpdHMoQ29tYm94LCBTcGxpdEJ1dHRvbik7XHJcbn0pKCk7XHJcblxuXG4vLyB1aS9kaWFsb2cuanNcbi8vL2ltcG9ydCBjb3JlXHJcbi8vL2ltcG9ydCB1aWNvcmVcclxuLy8vaW1wb3J0IHVpL21hc2suanNcclxuLy8vaW1wb3J0IHVpL2J1dHRvbi5qc1xyXG4oZnVuY3Rpb24gKCl7XHJcbiAgICB2YXIgdXRpbHMgPSBiYWlkdS5lZGl0b3IudXRpbHMsXHJcbiAgICAgICAgZG9tVXRpbHMgPSBiYWlkdS5lZGl0b3IuZG9tLmRvbVV0aWxzLFxyXG4gICAgICAgIHVpVXRpbHMgPSBiYWlkdS5lZGl0b3IudWkudWlVdGlscyxcclxuICAgICAgICBNYXNrID0gYmFpZHUuZWRpdG9yLnVpLk1hc2ssXHJcbiAgICAgICAgVUlCYXNlID0gYmFpZHUuZWRpdG9yLnVpLlVJQmFzZSxcclxuICAgICAgICBCdXR0b24gPSBiYWlkdS5lZGl0b3IudWkuQnV0dG9uLFxyXG4gICAgICAgIERpYWxvZyA9IGJhaWR1LmVkaXRvci51aS5EaWFsb2cgPSBmdW5jdGlvbiAob3B0aW9ucyl7XHJcbiAgICAgICAgICAgIGlmKG9wdGlvbnMubmFtZSl7XHJcbiAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IG9wdGlvbnMubmFtZTtcclxuICAgICAgICAgICAgICAgIHZhciBjc3NSdWxlcyA9IG9wdGlvbnMuY3NzUnVsZXM7XHJcbiAgICAgICAgICAgICAgICBpZighb3B0aW9ucy5jbGFzc05hbWUpe1xyXG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuY2xhc3NOYW1lID0gICdlZHVpLWZvci0nICsgbmFtZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmKGNzc1J1bGVzKXtcclxuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmNzc1J1bGVzID0gJy5lZHVpLWRlZmF1bHQgLmVkdWktZm9yLScrIG5hbWUgKycgLmVkdWktZGlhbG9nLWNvbnRlbnQgIHsnKyBjc3NSdWxlcyArJ30nXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5pbml0T3B0aW9ucyh1dGlscy5leHRlbmQoe1xyXG4gICAgICAgICAgICAgICAgYXV0b1Jlc2V0OiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgZHJhZ2dhYmxlOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgb25vazogZnVuY3Rpb24gKCl7fSxcclxuICAgICAgICAgICAgICAgIG9uY2FuY2VsOiBmdW5jdGlvbiAoKXt9LFxyXG4gICAgICAgICAgICAgICAgb25jbG9zZTogZnVuY3Rpb24gKHQsIG9rKXtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2sgPyB0aGlzLm9ub2soKSA6IHRoaXMub25jYW5jZWwoKTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAvL+aYr+WQpuaOp+WItmRpYWxvZ+S4reeahHNjcm9sbOS6i+S7tu+8jCDpu5jorqTkuLrkuI3pmLvmraJcclxuICAgICAgICAgICAgICAgIGhvbGRTY3JvbGw6IGZhbHNlXHJcbiAgICAgICAgICAgIH0sb3B0aW9ucykpO1xyXG4gICAgICAgICAgICB0aGlzLmluaXREaWFsb2coKTtcclxuICAgICAgICB9O1xyXG4gICAgdmFyIG1vZGFsTWFzaztcclxuICAgIHZhciBkcmFnTWFzaztcclxuICAgIHZhciBhY3RpdmVEaWFsb2c7XHJcbiAgICBEaWFsb2cucHJvdG90eXBlID0ge1xyXG4gICAgICAgIGRyYWdnYWJsZTogZmFsc2UsXHJcbiAgICAgICAgdWlOYW1lOiAnZGlhbG9nJyxcclxuICAgICAgICBpbml0RGlhbG9nOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcyxcclxuICAgICAgICAgICAgICAgIHRoZW1lPXRoaXMuZWRpdG9yLm9wdGlvbnMudGhlbWU7XHJcbiAgICAgICAgICAgIGlmKHRoaXMuY3NzUnVsZXMpe1xyXG4gICAgICAgICAgICAgICAgdXRpbHMuY3NzUnVsZSgnZWR1aS1jdXN0b21pemUtJyt0aGlzLm5hbWUrJy1zdHlsZScsdGhpcy5jc3NSdWxlcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5pbml0VUlCYXNlKCk7XHJcbiAgICAgICAgICAgIHRoaXMubW9kYWxNYXNrID0gKG1vZGFsTWFzayB8fCAobW9kYWxNYXNrID0gbmV3IE1hc2soe1xyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lOiAnZWR1aS1kaWFsb2ctbW9kYWxtYXNrJyxcclxuICAgICAgICAgICAgICAgIHRoZW1lOnRoZW1lLFxyXG4gICAgICAgICAgICAgICAgb25jbGljazogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZlRGlhbG9nICYmIGFjdGl2ZURpYWxvZy5jbG9zZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pKSk7XHJcbiAgICAgICAgICAgIHRoaXMuZHJhZ01hc2sgPSAoZHJhZ01hc2sgfHwgKGRyYWdNYXNrID0gbmV3IE1hc2soe1xyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lOiAnZWR1aS1kaWFsb2ctZHJhZ21hc2snLFxyXG4gICAgICAgICAgICAgICAgdGhlbWU6dGhlbWVcclxuICAgICAgICAgICAgfSkpKTtcclxuICAgICAgICAgICAgdGhpcy5jbG9zZUJ1dHRvbiA9IG5ldyBCdXR0b24oe1xyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lOiAnZWR1aS1kaWFsb2ctY2xvc2VidXR0b24nLFxyXG4gICAgICAgICAgICAgICAgdGl0bGU6IG1lLmNsb3NlRGlhbG9nLFxyXG4gICAgICAgICAgICAgICAgdGhlbWU6dGhlbWUsXHJcbiAgICAgICAgICAgICAgICBvbmNsaWNrOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgICAgICAgICBtZS5jbG9zZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5mdWxsc2NyZWVuICYmIHRoaXMuaW5pdFJlc2l6ZUV2ZW50KCk7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5idXR0b25zKSB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTA7IGk8dGhpcy5idXR0b25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCEodGhpcy5idXR0b25zW2ldIGluc3RhbmNlb2YgQnV0dG9uKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJ1dHRvbnNbaV0gPSBuZXcgQnV0dG9uKHV0aWxzLmV4dGVuZCh0aGlzLmJ1dHRvbnNbaV0se1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yIDogdGhpcy5lZGl0b3JcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSx0cnVlKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBpbml0UmVzaXplRXZlbnQ6IGZ1bmN0aW9uICgpIHtcclxuXHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7XHJcblxyXG4gICAgICAgICAgICBkb21VdGlscy5vbiggd2luZG93LCBcInJlc2l6ZVwiLCBmdW5jdGlvbiAoKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCBtZS5faGlkZGVuIHx8IG1lLl9oaWRkZW4gPT09IHVuZGVmaW5lZCApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCBtZS5fX3Jlc2l6ZVRpbWVyICkge1xyXG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoIG1lLl9fcmVzaXplVGltZXIgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBtZS5fX3Jlc2l6ZVRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoIGZ1bmN0aW9uICgpIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbWUuX19yZXNpemVUaW1lciA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBkaWFsb2dXcmFwTm9kZSA9IG1lLmdldERvbSgpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50Tm9kZSA9IG1lLmdldERvbSgnY29udGVudCcpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB3cmFwUmVjdCA9IFVFLnVpLnVpVXRpbHMuZ2V0Q2xpZW50UmVjdCggZGlhbG9nV3JhcE5vZGUgKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudFJlY3QgPSBVRS51aS51aVV0aWxzLmdldENsaWVudFJlY3QoIGNvbnRlbnROb2RlICksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZwUmVjdCA9IHVpVXRpbHMuZ2V0Vmlld3BvcnRSZWN0KCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnROb2RlLnN0eWxlLndpZHRoID0gKCB2cFJlY3Qud2lkdGggLSB3cmFwUmVjdC53aWR0aCArIGNvbnRlbnRSZWN0LndpZHRoICkgKyBcInB4XCI7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGVudE5vZGUuc3R5bGUuaGVpZ2h0ID0gKCB2cFJlY3QuaGVpZ2h0IC0gd3JhcFJlY3QuaGVpZ2h0ICsgY29udGVudFJlY3QuaGVpZ2h0ICkgKyBcInB4XCI7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZ1dyYXBOb2RlLnN0eWxlLndpZHRoID0gdnBSZWN0LndpZHRoICsgXCJweFwiO1xyXG4gICAgICAgICAgICAgICAgICAgIGRpYWxvZ1dyYXBOb2RlLnN0eWxlLmhlaWdodCA9IHZwUmVjdC5oZWlnaHQgKyBcInB4XCI7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIG1lLmZpcmVFdmVudCggXCJyZXNpemVcIiApO1xyXG5cclxuICAgICAgICAgICAgICAgIH0sIDEwMCApO1xyXG5cclxuICAgICAgICAgICAgfSApO1xyXG5cclxuICAgICAgICB9LFxyXG4gICAgICAgIGZpdFNpemU6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICB2YXIgcG9wQm9keUVsID0gdGhpcy5nZXREb20oJ2JvZHknKTtcclxuLy8gICAgICAgICAgICBpZiAoIShiYWlkdS5lZGl0b3IuYnJvd3Nlci5pZSAmJiBiYWlkdS5lZGl0b3IuYnJvd3Nlci52ZXJzaW9uID09IDcpKSB7XHJcbi8vICAgICAgICAgICAgICAgIHVpVXRpbHMucmVtb3ZlU3R5bGUocG9wQm9keUVsLCAnd2lkdGgnKTtcclxuLy8gICAgICAgICAgICAgICAgdWlVdGlscy5yZW1vdmVTdHlsZShwb3BCb2R5RWwsICdoZWlnaHQnKTtcclxuLy8gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBzaXplID0gdGhpcy5tZXN1cmVTaXplKCk7XHJcbiAgICAgICAgICAgIHBvcEJvZHlFbC5zdHlsZS53aWR0aCA9IHNpemUud2lkdGggKyAncHgnO1xyXG4gICAgICAgICAgICBwb3BCb2R5RWwuc3R5bGUuaGVpZ2h0ID0gc2l6ZS5oZWlnaHQgKyAncHgnO1xyXG4gICAgICAgICAgICByZXR1cm4gc2l6ZTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNhZmVTZXRPZmZzZXQ6IGZ1bmN0aW9uIChvZmZzZXQpe1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICB2YXIgZWwgPSBtZS5nZXREb20oKTtcclxuICAgICAgICAgICAgdmFyIHZwUmVjdCA9IHVpVXRpbHMuZ2V0Vmlld3BvcnRSZWN0KCk7XHJcbiAgICAgICAgICAgIHZhciByZWN0ID0gdWlVdGlscy5nZXRDbGllbnRSZWN0KGVsKTtcclxuICAgICAgICAgICAgdmFyIGxlZnQgPSBvZmZzZXQubGVmdDtcclxuICAgICAgICAgICAgaWYgKGxlZnQgKyByZWN0LndpZHRoID4gdnBSZWN0LnJpZ2h0KSB7XHJcbiAgICAgICAgICAgICAgICBsZWZ0ID0gdnBSZWN0LnJpZ2h0IC0gcmVjdC53aWR0aDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgdG9wID0gb2Zmc2V0LnRvcDtcclxuICAgICAgICAgICAgaWYgKHRvcCArIHJlY3QuaGVpZ2h0ID4gdnBSZWN0LmJvdHRvbSkge1xyXG4gICAgICAgICAgICAgICAgdG9wID0gdnBSZWN0LmJvdHRvbSAtIHJlY3QuaGVpZ2h0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsLnN0eWxlLmxlZnQgPSBNYXRoLm1heChsZWZ0LCAwKSArICdweCc7XHJcbiAgICAgICAgICAgIGVsLnN0eWxlLnRvcCA9IE1hdGgubWF4KHRvcCwgMCkgKyAncHgnO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2hvd0F0Q2VudGVyOiBmdW5jdGlvbiAoKXtcclxuXHJcbiAgICAgICAgICAgIHZhciB2cFJlY3QgPSB1aVV0aWxzLmdldFZpZXdwb3J0UmVjdCgpO1xyXG5cclxuICAgICAgICAgICAgaWYgKCAhdGhpcy5mdWxsc2NyZWVuICkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5nZXREb20oKS5zdHlsZS5kaXNwbGF5ID0gJyc7XHJcbiAgICAgICAgICAgICAgICB2YXIgcG9wU2l6ZSA9IHRoaXMuZml0U2l6ZSgpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHRpdGxlSGVpZ2h0ID0gdGhpcy5nZXREb20oJ3RpdGxlYmFyJykub2Zmc2V0SGVpZ2h0IHwgMDtcclxuICAgICAgICAgICAgICAgIHZhciBsZWZ0ID0gdnBSZWN0LndpZHRoIC8gMiAtIHBvcFNpemUud2lkdGggLyAyO1xyXG4gICAgICAgICAgICAgICAgdmFyIHRvcCA9IHZwUmVjdC5oZWlnaHQgLyAyIC0gKHBvcFNpemUuaGVpZ2h0IC0gdGl0bGVIZWlnaHQpIC8gMiAtIHRpdGxlSGVpZ2h0O1xyXG4gICAgICAgICAgICAgICAgdmFyIHBvcEVsID0gdGhpcy5nZXREb20oKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2FmZVNldE9mZnNldCh7XHJcbiAgICAgICAgICAgICAgICAgICAgbGVmdDogTWF0aC5tYXgobGVmdCB8IDAsIDApLFxyXG4gICAgICAgICAgICAgICAgICAgIHRvcDogTWF0aC5tYXgodG9wIHwgMCwgMClcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFkb21VdGlscy5oYXNDbGFzcyhwb3BFbCwgJ2VkdWktc3RhdGUtY2VudGVyZWQnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBvcEVsLmNsYXNzTmFtZSArPSAnIGVkdWktc3RhdGUtY2VudGVyZWQnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIGRpYWxvZ1dyYXBOb2RlID0gdGhpcy5nZXREb20oKSxcclxuICAgICAgICAgICAgICAgICAgICBjb250ZW50Tm9kZSA9IHRoaXMuZ2V0RG9tKCdjb250ZW50Jyk7XHJcblxyXG4gICAgICAgICAgICAgICAgZGlhbG9nV3JhcE5vZGUuc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgd3JhcFJlY3QgPSBVRS51aS51aVV0aWxzLmdldENsaWVudFJlY3QoIGRpYWxvZ1dyYXBOb2RlICksXHJcbiAgICAgICAgICAgICAgICAgICAgY29udGVudFJlY3QgPSBVRS51aS51aVV0aWxzLmdldENsaWVudFJlY3QoIGNvbnRlbnROb2RlICk7XHJcbiAgICAgICAgICAgICAgICBkaWFsb2dXcmFwTm9kZS5zdHlsZS5sZWZ0ID0gXCItMTAwMDAwcHhcIjtcclxuXHJcbiAgICAgICAgICAgICAgICBjb250ZW50Tm9kZS5zdHlsZS53aWR0aCA9ICggdnBSZWN0LndpZHRoIC0gd3JhcFJlY3Qud2lkdGggKyBjb250ZW50UmVjdC53aWR0aCApICsgXCJweFwiO1xyXG4gICAgICAgICAgICAgICAgY29udGVudE5vZGUuc3R5bGUuaGVpZ2h0ID0gKCB2cFJlY3QuaGVpZ2h0IC0gd3JhcFJlY3QuaGVpZ2h0ICsgY29udGVudFJlY3QuaGVpZ2h0ICkgKyBcInB4XCI7XHJcblxyXG4gICAgICAgICAgICAgICAgZGlhbG9nV3JhcE5vZGUuc3R5bGUud2lkdGggPSB2cFJlY3Qud2lkdGggKyBcInB4XCI7XHJcbiAgICAgICAgICAgICAgICBkaWFsb2dXcmFwTm9kZS5zdHlsZS5oZWlnaHQgPSB2cFJlY3QuaGVpZ2h0ICsgXCJweFwiO1xyXG4gICAgICAgICAgICAgICAgZGlhbG9nV3JhcE5vZGUuc3R5bGUubGVmdCA9IDA7XHJcblxyXG4gICAgICAgICAgICAgICAgLy/kv53lrZjnjq/looPnmoRvdmVyZmxvd+WAvFxyXG4gICAgICAgICAgICAgICAgdGhpcy5fb3JpZ2luYWxDb250ZXh0ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGh0bWw6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcmZsb3dYOiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUub3ZlcmZsb3dYLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBvdmVyZmxvd1k6IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZS5vdmVyZmxvd1lcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGJvZHk6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcmZsb3dYOiBkb2N1bWVudC5ib2R5LnN0eWxlLm92ZXJmbG93WCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcmZsb3dZOiBkb2N1bWVudC5ib2R5LnN0eWxlLm92ZXJmbG93WVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlLm92ZXJmbG93WCA9ICdoaWRkZW4nO1xyXG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlLm92ZXJmbG93WSA9ICdoaWRkZW4nO1xyXG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS5vdmVyZmxvd1ggPSAnaGlkZGVuJztcclxuICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUub3ZlcmZsb3dZID0gJ2hpZGRlbic7XHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLl9zaG93KCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRDb250ZW50SHRtbDogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHZhciBjb250ZW50SHRtbCA9ICcnO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuY29udGVudCA9PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICAgICAgY29udGVudEh0bWwgPSB0aGlzLmNvbnRlbnQ7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pZnJhbWVVcmwpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRlbnRIdG1sID0gJzxzcGFuIGlkPVwiJysgdGhpcy5pZCArJ19jb250bWFza1wiIGNsYXNzPVwiZGlhbG9nY29udG1hc2tcIj48L3NwYW4+PGlmcmFtZSBpZD1cIicrIHRoaXMuaWQgK1xyXG4gICAgICAgICAgICAgICAgICAgICdfaWZyYW1lXCIgY2xhc3M9XCIlJS1pZnJhbWVcIiBoZWlnaHQ9XCIxMDAlXCIgd2lkdGg9XCIxMDAlXCIgZnJhbWVib3JkZXI9XCIwXCIgc3JjPVwiJysgdGhpcy5pZnJhbWVVcmwgKydcIj48L2lmcmFtZT4nO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBjb250ZW50SHRtbDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldEh0bWxUcGw6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICB2YXIgZm9vdEh0bWwgPSAnJztcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmJ1dHRvbnMpIHtcclxuICAgICAgICAgICAgICAgIHZhciBidWZmID0gW107XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTA7IGk8dGhpcy5idXR0b25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYnVmZltpXSA9IHRoaXMuYnV0dG9uc1tpXS5yZW5kZXJIdG1sKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBmb290SHRtbCA9ICc8ZGl2IGNsYXNzPVwiJSUtZm9vdFwiPicgK1xyXG4gICAgICAgICAgICAgICAgICAgICAnPGRpdiBpZD1cIiMjX2J1dHRvbnNcIiBjbGFzcz1cIiUlLWJ1dHRvbnNcIj4nICsgYnVmZi5qb2luKCcnKSArICc8L2Rpdj4nICtcclxuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuICc8ZGl2IGlkPVwiIyNcIiBjbGFzcz1cIiUlXCI+PGRpdiAnKyAoICF0aGlzLmZ1bGxzY3JlZW4gPyAnY2xhc3M9XCIlJVwiJyA6ICdjbGFzcz1cIiUlLXdyYXAgZWR1aS1kaWFsb2ctZnVsbHNjcmVlbi1mbGFnXCInICkgKyc+PGRpdiBpZD1cIiMjX2JvZHlcIiBjbGFzcz1cIiUlLWJvZHlcIj4nICtcclxuICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiJSUtc2hhZG93XCI+PC9kaXY+JyArXHJcbiAgICAgICAgICAgICAgICAnPGRpdiBpZD1cIiMjX3RpdGxlYmFyXCIgY2xhc3M9XCIlJS10aXRsZWJhclwiPicgK1xyXG4gICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCIlJS1kcmFnaGFuZGxlXCIgb25tb3VzZWRvd249XCIkJC5fb25UaXRsZWJhck1vdXNlRG93bihldmVudCwgdGhpcyk7XCI+JyArXHJcbiAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPVwiJSUtY2FwdGlvblwiPicgKyAodGhpcy50aXRsZSB8fCAnJykgKyAnPC9zcGFuPicgK1xyXG4gICAgICAgICAgICAgICAgJzwvZGl2PicgK1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZUJ1dHRvbi5yZW5kZXJIdG1sKCkgK1xyXG4gICAgICAgICAgICAgICAgJzwvZGl2PicgK1xyXG4gICAgICAgICAgICAgICAgJzxkaXYgaWQ9XCIjI19jb250ZW50XCIgY2xhc3M9XCIlJS1jb250ZW50XCI+JysgKCB0aGlzLmF1dG9SZXNldCA/ICcnIDogdGhpcy5nZXRDb250ZW50SHRtbCgpKSArJzwvZGl2PicgK1xyXG4gICAgICAgICAgICAgICAgZm9vdEh0bWwgK1xyXG4gICAgICAgICAgICAgICAgJzwvZGl2PjwvZGl2PjwvZGl2Pic7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgLy8gdG9kbzog5L+d5oyB5bGF5LitL+iusOS9j+S4iuasoeWFs+mXreS9jee9rumAiemhuVxyXG4gICAgICAgICAgICBpZiAoIXRoaXMubW9kYWxNYXNrLmdldERvbSgpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm1vZGFsTWFzay5yZW5kZXIoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubW9kYWxNYXNrLmhpZGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIXRoaXMuZHJhZ01hc2suZ2V0RG9tKCkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZHJhZ01hc2sucmVuZGVyKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRyYWdNYXNrLmhpZGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICB0aGlzLmFkZExpc3RlbmVyKCdzaG93JywgZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgICAgICBtZS5tb2RhbE1hc2suc2hvdyh0aGlzLmdldERvbSgpLnN0eWxlLnpJbmRleCAtIDIpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5hZGRMaXN0ZW5lcignaGlkZScsIGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICAgICAgbWUubW9kYWxNYXNrLmhpZGUoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmJ1dHRvbnMpIHtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MDsgaTx0aGlzLmJ1dHRvbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmJ1dHRvbnNbaV0ucG9zdFJlbmRlcigpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRvbVV0aWxzLm9uKHdpbmRvdywgJ3Jlc2l6ZScsIGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIW1lLmlzSGlkZGVuKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuc2FmZVNldE9mZnNldCh1aVV0aWxzLmdldENsaWVudFJlY3QobWUuZ2V0RG9tKCkpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAvL2hvbGTkvY9zY3JvbGzkuovku7bvvIzpmLLmraJkaWFsb2fnmoTmu5rliqjlvbHlk43pobXpnaJcclxuLy8gICAgICAgICAgICBpZiggdGhpcy5ob2xkU2Nyb2xsICkge1xyXG4vL1xyXG4vLyAgICAgICAgICAgICAgICBpZiggIW1lLmlmcmFtZVVybCApIHtcclxuLy8gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLm9uKCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggbWUuaWQgKyBcIl9pZnJhbWVcIiksICFicm93c2VyLmdlY2tvID8gXCJtb3VzZXdoZWVsXCIgOiBcIkRPTU1vdXNlU2Nyb2xsXCIsIGZ1bmN0aW9uKGUpe1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnByZXZlbnREZWZhdWx0KGUpO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgfSApO1xyXG4vLyAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4vLyAgICAgICAgICAgICAgICAgICAgbWUuYWRkTGlzdGVuZXIoJ2RpYWxvZ2FmdGVycmVzZXQnLCBmdW5jdGlvbigpe1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZnJhbWVXaW5kb3cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggbWUuaWQgKyBcIl9pZnJhbWVcIikuY29udGVudFdpbmRvdztcclxuLy9cclxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIGJyb3dzZXIuaWUgKSB7XHJcbi8vXHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGltZXIgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXtcclxuLy9cclxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiggaWZyYW1lV2luZG93LmRvY3VtZW50ICYmIGlmcmFtZVdpbmRvdy5kb2N1bWVudC5ib2R5ICkge1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuY2xlYXJJbnRlcnZhbCggdGltZXIgKTtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXIgPSBudWxsO1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5vbiggaWZyYW1lV2luZG93LmRvY3VtZW50LmJvZHksICFicm93c2VyLmdlY2tvID8gXCJtb3VzZXdoZWVsXCIgOiBcIkRPTU1vdXNlU2Nyb2xsXCIsIGZ1bmN0aW9uKGUpe1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucHJldmVudERlZmF1bHQoZSk7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gKTtcclxuLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbi8vXHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAxMDApO1xyXG4vL1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4vLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMub24oIGlmcmFtZVdpbmRvdywgIWJyb3dzZXIuZ2Vja28gPyBcIm1vdXNld2hlZWxcIiA6IFwiRE9NTW91c2VTY3JvbGxcIiwgZnVuY3Rpb24oZSl7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucHJldmVudERlZmF1bHQoZSk7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ICk7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuLy9cclxuLy8gICAgICAgICAgICAgICAgICAgICAgICB9LCAxKTtcclxuLy8gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4vLyAgICAgICAgICAgICAgICB9XHJcbi8vXHJcbi8vICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLl9oaWRlKCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBtZXN1cmVTaXplOiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgdmFyIGJvZHkgPSB0aGlzLmdldERvbSgnYm9keScpO1xyXG4gICAgICAgICAgICB2YXIgd2lkdGggPSB1aVV0aWxzLmdldENsaWVudFJlY3QodGhpcy5nZXREb20oJ2NvbnRlbnQnKSkud2lkdGg7XHJcbiAgICAgICAgICAgIHZhciBkaWFsb2dCb2R5U3R5bGUgPSBib2R5LnN0eWxlO1xyXG4gICAgICAgICAgICBkaWFsb2dCb2R5U3R5bGUud2lkdGggPSB3aWR0aDtcclxuICAgICAgICAgICAgcmV0dXJuIHVpVXRpbHMuZ2V0Q2xpZW50UmVjdChib2R5KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIF9vblRpdGxlYmFyTW91c2VEb3duOiBmdW5jdGlvbiAoZXZ0LCBlbCl7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmRyYWdnYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlY3Q7XHJcbiAgICAgICAgICAgICAgICB2YXIgdnBSZWN0ID0gdWlVdGlscy5nZXRWaWV3cG9ydFJlY3QoKTtcclxuICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICAgICAgICAgICAgICB1aVV0aWxzLnN0YXJ0RHJhZyhldnQsIHtcclxuICAgICAgICAgICAgICAgICAgICBvbmRyYWdzdGFydDogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlY3QgPSB1aVV0aWxzLmdldENsaWVudFJlY3QobWUuZ2V0RG9tKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5nZXREb20oJ2NvbnRtYXNrJykuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuZHJhZ01hc2suc2hvdyhtZS5nZXREb20oKS5zdHlsZS56SW5kZXggLSAxKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIG9uZHJhZ21vdmU6IGZ1bmN0aW9uICh4LCB5KXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxlZnQgPSByZWN0LmxlZnQgKyB4O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9wID0gcmVjdC50b3AgKyB5O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5zYWZlU2V0T2Zmc2V0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IGxlZnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3A6IHRvcFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIG9uZHJhZ3N0b3A6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5nZXREb20oJ2NvbnRtYXNrJykuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmVDbGFzc2VzKG1lLmdldERvbSgpLCBbJ2VkdWktc3RhdGUtY2VudGVyZWQnXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmRyYWdNYXNrLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICB0aGlzLmdldERvbSgnY29udGVudCcpLmlubmVySFRNTCA9IHRoaXMuZ2V0Q29udGVudEh0bWwoKTtcclxuICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2RpYWxvZ2FmdGVycmVzZXQnKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIF9zaG93OiBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX2hpZGRlbikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5nZXREb20oKS5zdHlsZS5kaXNwbGF5ID0gJyc7XHJcblxyXG4gICAgICAgICAgICAgICAgLy/opoHpq5jov4fnvJbovpHlmajnmoR6aW5keGVcclxuICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLmNvbnRhaW5lci5zdHlsZS56SW5kZXggJiYgKHRoaXMuZ2V0RG9tKCkuc3R5bGUuekluZGV4ID0gdGhpcy5lZGl0b3IuY29udGFpbmVyLnN0eWxlLnpJbmRleCAqIDEgKyAxMCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9oaWRkZW4gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdzaG93Jyk7XHJcbiAgICAgICAgICAgICAgICBiYWlkdS5lZGl0b3IudWkudWlVdGlscy5nZXRGaXhlZExheWVyKCkuc3R5bGUuekluZGV4ID0gdGhpcy5nZXREb20oKS5zdHlsZS56SW5kZXggLSA0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBpc0hpZGRlbjogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9oaWRkZW47XHJcbiAgICAgICAgfSxcclxuICAgICAgICBfaGlkZTogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5faGlkZGVuKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgd3JhcE5vZGUgPSB0aGlzLmdldERvbSgpO1xyXG4gICAgICAgICAgICAgICAgd3JhcE5vZGUuc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuICAgICAgICAgICAgICAgIHdyYXBOb2RlLnN0eWxlLnpJbmRleCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgd3JhcE5vZGUuc3R5bGUud2lkdGggPSAnJztcclxuICAgICAgICAgICAgICAgIHdyYXBOb2RlLnN0eWxlLmhlaWdodCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5faGlkZGVuID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdoaWRlJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIG9wZW46IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICBpZiAodGhpcy5hdXRvUmVzZXQpIHtcclxuICAgICAgICAgICAgICAgIC8v5pyJ5Y+v6IO96L+Y5rKh5pyJ5riy5p+TXHJcbiAgICAgICAgICAgICAgICB0cnl7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNldCgpO1xyXG4gICAgICAgICAgICAgICAgfWNhdGNoKGUpe1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuKClcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnNob3dBdENlbnRlcigpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pZnJhbWVVcmwpIHtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXREb20oJ2lmcmFtZScpLmZvY3VzKCk7XHJcbiAgICAgICAgICAgICAgICB9IGNhdGNoKGV4KXt9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYWN0aXZlRGlhbG9nID0gdGhpcztcclxuICAgICAgICB9LFxyXG4gICAgICAgIF9vbkNsb3NlQnV0dG9uQ2xpY2s6IGZ1bmN0aW9uIChldnQsIGVsKXtcclxuICAgICAgICAgICAgdGhpcy5jbG9zZShmYWxzZSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBjbG9zZTogZnVuY3Rpb24gKG9rKXtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZmlyZUV2ZW50KCdjbG9zZScsIG9rKSAhPT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgIC8v6L+Y5Y6f546v5aKDXHJcbiAgICAgICAgICAgICAgICBpZiAoIHRoaXMuZnVsbHNjcmVlbiApIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlLm92ZXJmbG93WCA9IHRoaXMuX29yaWdpbmFsQ29udGV4dC5odG1sLm92ZXJmbG93WDtcclxuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUub3ZlcmZsb3dZID0gdGhpcy5fb3JpZ2luYWxDb250ZXh0Lmh0bWwub3ZlcmZsb3dZO1xyXG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUub3ZlcmZsb3dYID0gdGhpcy5fb3JpZ2luYWxDb250ZXh0LmJvZHkub3ZlcmZsb3dYO1xyXG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUub3ZlcmZsb3dZID0gdGhpcy5fb3JpZ2luYWxDb250ZXh0LmJvZHkub3ZlcmZsb3dZO1xyXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9vcmlnaW5hbENvbnRleHQ7XHJcblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5faGlkZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8v6ZSA5q+BY29udGVudFxyXG4gICAgICAgICAgICAgICAgdmFyIGNvbnRlbnQgPSB0aGlzLmdldERvbSgnY29udGVudCcpO1xyXG4gICAgICAgICAgICAgICAgdmFyIGlmcmFtZSA9IHRoaXMuZ2V0RG9tKCdpZnJhbWUnKTtcclxuICAgICAgICAgICAgICAgIGlmIChjb250ZW50ICYmIGlmcmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBkb2MgPSBpZnJhbWUuY29udGVudERvY3VtZW50IHx8IGlmcmFtZS5jb250ZW50V2luZG93LmRvY3VtZW50O1xyXG4gICAgICAgICAgICAgICAgICAgIGRvYyAmJiAoZG9jLmJvZHkuaW5uZXJIVE1MID0gJycpO1xyXG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLnJlbW92ZShjb250ZW50KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICB1dGlscy5pbmhlcml0cyhEaWFsb2csIFVJQmFzZSk7XHJcbn0pKCk7XHJcblxuXG4vLyB1aS9tZW51YnV0dG9uLmpzXG4vLy9pbXBvcnQgY29yZVxyXG4vLy9pbXBvcnQgdWljb3JlXHJcbi8vL2ltcG9ydCB1aS9tZW51LmpzXHJcbi8vL2ltcG9ydCB1aS9zcGxpdGJ1dHRvbi5qc1xyXG4oZnVuY3Rpb24gKCl7XHJcbiAgICB2YXIgdXRpbHMgPSBiYWlkdS5lZGl0b3IudXRpbHMsXHJcbiAgICAgICAgTWVudSA9IGJhaWR1LmVkaXRvci51aS5NZW51LFxyXG4gICAgICAgIFNwbGl0QnV0dG9uID0gYmFpZHUuZWRpdG9yLnVpLlNwbGl0QnV0dG9uLFxyXG4gICAgICAgIE1lbnVCdXR0b24gPSBiYWlkdS5lZGl0b3IudWkuTWVudUJ1dHRvbiA9IGZ1bmN0aW9uIChvcHRpb25zKXtcclxuICAgICAgICAgICAgdGhpcy5pbml0T3B0aW9ucyhvcHRpb25zKTtcclxuICAgICAgICAgICAgdGhpcy5pbml0TWVudUJ1dHRvbigpO1xyXG4gICAgICAgIH07XHJcbiAgICBNZW51QnV0dG9uLnByb3RvdHlwZSA9IHtcclxuICAgICAgICBpbml0TWVudUJ1dHRvbjogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7XHJcbiAgICAgICAgICAgIHRoaXMudWlOYW1lID0gXCJtZW51YnV0dG9uXCI7XHJcbiAgICAgICAgICAgIHRoaXMucG9wdXAgPSBuZXcgTWVudSh7XHJcbiAgICAgICAgICAgICAgICBpdGVtczogbWUuaXRlbXMsXHJcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU6IG1lLmNsYXNzTmFtZSxcclxuICAgICAgICAgICAgICAgIGVkaXRvcjptZS5lZGl0b3JcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMucG9wdXAuYWRkTGlzdGVuZXIoJ3Nob3cnLCBmdW5jdGlvbiAoKXtcclxuICAgICAgICAgICAgICAgIHZhciBsaXN0ID0gdGhpcztcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MDsgaTxsaXN0Lml0ZW1zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGlzdC5pdGVtc1tpXS5yZW1vdmVTdGF0ZSgnY2hlY2tlZCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChsaXN0Lml0ZW1zW2ldLnZhbHVlID09IG1lLl92YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsaXN0Lml0ZW1zW2ldLmFkZFN0YXRlKCdjaGVja2VkJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmFsdWUgPSBtZS5fdmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5pbml0U3BsaXRCdXR0b24oKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNldFZhbHVlIDogZnVuY3Rpb24odmFsdWUpe1xyXG4gICAgICAgICAgICB0aGlzLl92YWx1ZSA9IHZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgIH07XHJcbiAgICB1dGlscy5pbmhlcml0cyhNZW51QnV0dG9uLCBTcGxpdEJ1dHRvbik7XHJcbn0pKCk7XG5cbi8vIHVpL211bHRpTWVudS5qc1xuLy8vaW1wb3J0IGNvcmVcclxuLy8vaW1wb3J0IHVpY29yZVxyXG4gLy8vY29tbWFuZHMg6KGo5oOFXHJcbihmdW5jdGlvbigpe1xyXG4gICAgdmFyIHV0aWxzID0gYmFpZHUuZWRpdG9yLnV0aWxzLFxyXG4gICAgICAgIFBvcHVwID0gYmFpZHUuZWRpdG9yLnVpLlBvcHVwLFxyXG4gICAgICAgIFNwbGl0QnV0dG9uID0gYmFpZHUuZWRpdG9yLnVpLlNwbGl0QnV0dG9uLFxyXG4gICAgICAgIE11bHRpTWVudVBvcCA9IGJhaWR1LmVkaXRvci51aS5NdWx0aU1lbnVQb3AgPSBmdW5jdGlvbihvcHRpb25zKXtcclxuICAgICAgICAgICAgdGhpcy5pbml0T3B0aW9ucyhvcHRpb25zKTtcclxuICAgICAgICAgICAgdGhpcy5pbml0TXVsdGlNZW51KCk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICBNdWx0aU1lbnVQb3AucHJvdG90eXBlID0ge1xyXG4gICAgICAgIGluaXRNdWx0aU1lbnU6IGZ1bmN0aW9uICgpe1xyXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xyXG4gICAgICAgICAgICB0aGlzLnBvcHVwID0gbmV3IFBvcHVwKHtcclxuICAgICAgICAgICAgICAgIGNvbnRlbnQ6ICcnLFxyXG4gICAgICAgICAgICAgICAgZWRpdG9yIDogbWUuZWRpdG9yLFxyXG4gICAgICAgICAgICAgICAgaWZyYW1lX3JlbmRlcmVkOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIG9uc2hvdzogZnVuY3Rpb24gKCl7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlmcmFtZV9yZW5kZXJlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlmcmFtZV9yZW5kZXJlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0RG9tKCdjb250ZW50JykuaW5uZXJIVE1MID0gJzxpZnJhbWUgaWQ9XCInK21lLmlkKydfaWZyYW1lXCIgc3JjPVwiJysgbWUuaWZyYW1lVXJsICsnXCIgZnJhbWVib3JkZXI9XCIwXCI+PC9pZnJhbWU+JztcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWUuZWRpdG9yLmNvbnRhaW5lci5zdHlsZS56SW5kZXggJiYgKHRoaXMuZ2V0RG9tKCkuc3R5bGUuekluZGV4ID0gbWUuZWRpdG9yLmNvbnRhaW5lci5zdHlsZS56SW5kZXggKiAxICsgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAvLyBjYW5TaWRlVXA6ZmFsc2UsXHJcbiAgICAgICAgICAgICAgIC8vIGNhblNpZGVMZWZ0OmZhbHNlXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLm9uYnV0dG9uY2xpY2sgPSBmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zaG93UG9wdXAoKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdGhpcy5pbml0U3BsaXRCdXR0b24oKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfTtcclxuXHJcbiAgICB1dGlscy5pbmhlcml0cyhNdWx0aU1lbnVQb3AsIFNwbGl0QnV0dG9uKTtcclxufSkoKTtcclxuXG5cbi8vIHVpL3Nob3J0Y3V0bWVudS5qc1xuKGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgVUkgPSBiYWlkdS5lZGl0b3IudWksXG4gICAgICAgIFVJQmFzZSA9IFVJLlVJQmFzZSxcbiAgICAgICAgdWlVdGlscyA9IFVJLnVpVXRpbHMsXG4gICAgICAgIHV0aWxzID0gYmFpZHUuZWRpdG9yLnV0aWxzLFxuICAgICAgICBkb21VdGlscyA9IGJhaWR1LmVkaXRvci5kb20uZG9tVXRpbHM7XG5cbiAgICB2YXIgYWxsTWVudXMgPSBbXSwvL+WtmOWCqOaJgOacieW/q+aNt+iPnOWNlVxuICAgICAgICB0aW1lSUQsXG4gICAgICAgIGlzU3ViTWVudVNob3cgPSBmYWxzZTsvL+aYr+WQpuacieWtkHBvcOaYvuekulxuXG4gICAgdmFyIFNob3J0Q3V0TWVudSA9IFVJLlNob3J0Q3V0TWVudSA9IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICAgIHRoaXMuaW5pdE9wdGlvbnMgKG9wdGlvbnMpO1xuICAgICAgICB0aGlzLmluaXRTaG9ydEN1dE1lbnUgKCk7XG4gICAgfTtcblxuICAgIFNob3J0Q3V0TWVudS5wb3N0SGlkZSA9IGhpZGVBbGxNZW51O1xuXG4gICAgU2hvcnRDdXRNZW51LnByb3RvdHlwZSA9IHtcbiAgICAgICAgaXNIaWRkZW4gOiB0cnVlICxcbiAgICAgICAgU1BBQ0UgOiA1ICxcbiAgICAgICAgaW5pdFNob3J0Q3V0TWVudSA6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHRoaXMuaXRlbXMgPSB0aGlzLml0ZW1zIHx8IFtdO1xuICAgICAgICAgICAgdGhpcy5pbml0VUlCYXNlICgpO1xuICAgICAgICAgICAgdGhpcy5pbml0SXRlbXMgKCk7XG4gICAgICAgICAgICB0aGlzLmluaXRFdmVudCAoKTtcbiAgICAgICAgICAgIGFsbE1lbnVzLnB1c2ggKHRoaXMpO1xuICAgICAgICB9ICxcbiAgICAgICAgaW5pdEV2ZW50IDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIG1lID0gdGhpcyxcbiAgICAgICAgICAgICAgICBkb2MgPSBtZS5lZGl0b3IuZG9jdW1lbnQ7XG5cbiAgICAgICAgICAgIGRvbVV0aWxzLm9uIChkb2MgLCBcIm1vdXNlbW92ZVwiICwgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAobWUuaXNIaWRkZW4gPT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgICAgIC8v5pyJcG9w5pi+56S65bCx5LiN6ZqQ6JeP5b+r5o236I+c5Y2VXG4gICAgICAgICAgICAgICAgICAgIGlmIChtZS5nZXRTdWJNZW51TWFyayAoKSB8fCBtZS5ldmVudFR5cGUgPT0gXCJjb250ZXh0bWVudVwiKSAgIHJldHVybjtcblxuXG4gICAgICAgICAgICAgICAgICAgIHZhciBmbGFnID0gdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsID0gbWUuZ2V0RG9tICgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgd3QgPSBlbC5vZmZzZXRXaWR0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGh0ID0gZWwub2Zmc2V0SGVpZ2h0LFxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzdGFuY2VYID0gd3QgLyAyICsgbWUuU1BBQ0UsLy/ot53nprvkuK3lv4NY5qCH5YeGXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXN0YW5jZVkgPSBodCAvIDIsLy/ot53nprvkuK3lv4NZ5qCH5YeGXG4gICAgICAgICAgICAgICAgICAgICAgICB4ID0gTWF0aC5hYnMgKGUuc2NyZWVuWCAtIG1lLmxlZnQpLC8v56a75Lit5b+D6Led56a75qiq5Z2Q5qCHXG4gICAgICAgICAgICAgICAgICAgICAgICB5ID0gTWF0aC5hYnMgKGUuc2NyZWVuWSAtIG1lLnRvcCk7Ly/nprvkuK3lv4Pot53nprvnurXlnZDmoIdcblxuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQgKHRpbWVJRCk7XG4gICAgICAgICAgICAgICAgICAgIHRpbWVJRCA9IHNldFRpbWVvdXQgKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh5ID4gMCAmJiB5IDwgZGlzdGFuY2VZKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuc2V0T3BhY2l0eSAoZWwgLCBcIjFcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHkgPiBkaXN0YW5jZVkgJiYgeSA8IGRpc3RhbmNlWSArIDcwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuc2V0T3BhY2l0eSAoZWwgLCBcIjAuNVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGFnID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHkgPiBkaXN0YW5jZVkgKyA3MCAmJiB5IDwgZGlzdGFuY2VZICsgMTQwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuaGlkZSAoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWcgJiYgeCA+IDAgJiYgeCA8IGRpc3RhbmNlWCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLnNldE9wYWNpdHkgKGVsICwgXCIxXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHggPiBkaXN0YW5jZVggJiYgeCA8IGRpc3RhbmNlWCArIDcwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWUuc2V0T3BhY2l0eSAoZWwgLCBcIjAuNVwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh4ID4gZGlzdGFuY2VYICsgNzAgJiYgeCA8IGRpc3RhbmNlWCArIDE0MCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLmhpZGUgKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvL2llXFxmZuS4iyBtb3VzZW91dOS4jeWHhlxuICAgICAgICAgICAgaWYgKGJyb3dzZXIuY2hyb21lKSB7XG4gICAgICAgICAgICAgICAgZG9tVXRpbHMub24gKGRvYyAsIFwibW91c2VvdXRcIiAsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciByZWxhdGVkVGd0ID0gZS5yZWxhdGVkVGFyZ2V0IHx8IGUudG9FbGVtZW50O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZWxhdGVkVGd0ID09IG51bGwgfHwgcmVsYXRlZFRndC50YWdOYW1lID09IFwiSFRNTFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5oaWRlICgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG1lLmVkaXRvci5hZGRMaXN0ZW5lciAoXCJhZnRlcmhpZGVwb3BcIiAsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoIW1lLmlzSGlkZGVuKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzU3ViTWVudVNob3cgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0gLFxuICAgICAgICBpbml0SXRlbXMgOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAodXRpbHMuaXNBcnJheSAodGhpcy5pdGVtcykpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5pdGVtcy5sZW5ndGggOyBpIDwgbGVuIDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpdGVtID0gdGhpcy5pdGVtc1tpXS50b0xvd2VyQ2FzZSAoKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoVUlbaXRlbV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbXNbaV0gPSBuZXcgVUlbaXRlbV0gKHRoaXMuZWRpdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbXNbaV0uY2xhc3NOYW1lICs9IFwiIGVkdWktc2hvcnRjdXRzdWJtZW51IFwiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9ICxcbiAgICAgICAgc2V0T3BhY2l0eSA6IGZ1bmN0aW9uIChlbCAsIHZhbHVlKSB7XG4gICAgICAgICAgICBpZiAoYnJvd3Nlci5pZSAmJiBicm93c2VyLnZlcnNpb24gPCA5KSB7XG4gICAgICAgICAgICAgICAgZWwuc3R5bGUuZmlsdGVyID0gXCJhbHBoYShvcGFjaXR5ID0gXCIgKyBwYXJzZUZsb2F0ICh2YWx1ZSkgKiAxMDAgKyBcIik7XCJcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZWwuc3R5bGUub3BhY2l0eSA9IHZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9ICxcbiAgICAgICAgZ2V0U3ViTWVudU1hcmsgOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpc1N1Yk1lbnVTaG93ID0gZmFsc2U7XG4gICAgICAgICAgICB2YXIgbGF5ZXJFbGUgPSB1aVV0aWxzLmdldEZpeGVkTGF5ZXIgKCk7XG4gICAgICAgICAgICB2YXIgbGlzdCA9IGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lIChsYXllckVsZSAsIFwiZGl2XCIgLCBmdW5jdGlvbiAobm9kZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBkb21VdGlscy5oYXNDbGFzcyAobm9kZSAsIFwiZWR1aS1zaG9ydGN1dHN1Ym1lbnUgZWR1aS1wb3B1cFwiKVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBub2RlIDsgbm9kZSA9IGxpc3RbaSsrXSA7KSB7XG4gICAgICAgICAgICAgICAgaWYgKG5vZGUuc3R5bGUuZGlzcGxheSAhPSBcIm5vbmVcIikge1xuICAgICAgICAgICAgICAgICAgICBpc1N1Yk1lbnVTaG93ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gaXNTdWJNZW51U2hvdztcbiAgICAgICAgfSAsXG4gICAgICAgIHNob3cgOiBmdW5jdGlvbiAoZSAsIGhhc0NvbnRleHRtZW51KSB7XG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzLFxuICAgICAgICAgICAgICAgIG9mZnNldCA9IHt9LFxuICAgICAgICAgICAgICAgIGVsID0gdGhpcy5nZXREb20gKCksXG4gICAgICAgICAgICAgICAgZml4ZWRsYXllciA9IHVpVXRpbHMuZ2V0Rml4ZWRMYXllciAoKTtcblxuICAgICAgICAgICAgZnVuY3Rpb24gc2V0UG9zIChvZmZzZXQpIHtcbiAgICAgICAgICAgICAgICBpZiAob2Zmc2V0LmxlZnQgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG9mZnNldC5sZWZ0ID0gMDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKG9mZnNldC50b3AgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG9mZnNldC50b3AgPSAwO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbC5zdHlsZS5jc3NUZXh0ID0gXCJwb3NpdGlvbjphYnNvbHV0ZTtsZWZ0OlwiICsgb2Zmc2V0LmxlZnQgKyBcInB4O3RvcDpcIiArIG9mZnNldC50b3AgKyBcInB4O1wiO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmdW5jdGlvbiBzZXRQb3NCeUN4dE1lbnUgKG1lbnUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIW1lbnUudGFnTmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBtZW51ID0gbWVudS5nZXREb20gKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG9mZnNldC5sZWZ0ID0gcGFyc2VJbnQgKG1lbnUuc3R5bGUubGVmdCk7XG4gICAgICAgICAgICAgICAgb2Zmc2V0LnRvcCA9IHBhcnNlSW50IChtZW51LnN0eWxlLnRvcCk7XG4gICAgICAgICAgICAgICAgb2Zmc2V0LnRvcCAtPSBlbC5vZmZzZXRIZWlnaHQgKyAxNTtcbiAgICAgICAgICAgICAgICBzZXRQb3MgKG9mZnNldCk7XG4gICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgbWUuZXZlbnRUeXBlID0gZS50eXBlO1xuICAgICAgICAgICAgZWwuc3R5bGUuY3NzVGV4dCA9IFwiZGlzcGxheTpibG9jaztsZWZ0Oi05OTk5cHhcIjtcblxuICAgICAgICAgICAgaWYgKGUudHlwZSA9PSBcImNvbnRleHRtZW51XCIgJiYgaGFzQ29udGV4dG1lbnUpIHtcbiAgICAgICAgICAgICAgICB2YXIgbWVudSA9IGRvbVV0aWxzLmdldEVsZW1lbnRzQnlUYWdOYW1lIChmaXhlZGxheWVyICwgXCJkaXZcIiAsIFwiZWR1aS1jb250ZXh0bWVudVwiKVswXTtcbiAgICAgICAgICAgICAgICBpZiAobWVudSkge1xuICAgICAgICAgICAgICAgICAgICBzZXRQb3NCeUN4dE1lbnUgKG1lbnUpXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbWUuZWRpdG9yLmFkZExpc3RlbmVyIChcImFmdGVyc2hvd2NvbnRleHRtZW51XCIgLCBmdW5jdGlvbiAodHlwZSAsIG1lbnUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFBvc0J5Q3h0TWVudSAobWVudSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgb2Zmc2V0ID0gdWlVdGlscy5nZXRWaWV3cG9ydE9mZnNldEJ5RXZlbnQgKGUpO1xuICAgICAgICAgICAgICAgIG9mZnNldC50b3AgLT0gZWwub2Zmc2V0SGVpZ2h0ICsgbWUuU1BBQ0U7XG4gICAgICAgICAgICAgICAgb2Zmc2V0LmxlZnQgKz0gbWUuU1BBQ0UgKyAyMDtcbiAgICAgICAgICAgICAgICBzZXRQb3MgKG9mZnNldCk7XG4gICAgICAgICAgICAgICAgbWUuc2V0T3BhY2l0eSAoZWwgLCAwLjIpO1xuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgIG1lLmlzSGlkZGVuID0gZmFsc2U7XG4gICAgICAgICAgICBtZS5sZWZ0ID0gZS5zY3JlZW5YICsgZWwub2Zmc2V0V2lkdGggLyAyIC0gbWUuU1BBQ0U7XG4gICAgICAgICAgICBtZS50b3AgPSBlLnNjcmVlblkgLSAoZWwub2Zmc2V0SGVpZ2h0IC8gMikgLSBtZS5TUEFDRTtcblxuICAgICAgICAgICAgaWYgKG1lLmVkaXRvcikge1xuICAgICAgICAgICAgICAgIGVsLnN0eWxlLnpJbmRleCA9IG1lLmVkaXRvci5jb250YWluZXIuc3R5bGUuekluZGV4ICogMSArIDEwO1xuICAgICAgICAgICAgICAgIGZpeGVkbGF5ZXIuc3R5bGUuekluZGV4ID0gZWwuc3R5bGUuekluZGV4IC0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSAsXG4gICAgICAgIGhpZGUgOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5nZXREb20gKCkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmdldERvbSAoKS5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmlzSGlkZGVuID0gdHJ1ZTtcbiAgICAgICAgfSAsXG4gICAgICAgIHBvc3RSZW5kZXIgOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAodXRpbHMuaXNBcnJheSAodGhpcy5pdGVtcykpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaXRlbSA7IGl0ZW0gPSB0aGlzLml0ZW1zW2krK10gOykge1xuICAgICAgICAgICAgICAgICAgICBpdGVtLnBvc3RSZW5kZXIgKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9ICxcbiAgICAgICAgZ2V0SHRtbFRwbCA6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBidWZmO1xuICAgICAgICAgICAgaWYgKHV0aWxzLmlzQXJyYXkgKHRoaXMuaXRlbXMpKSB7XG4gICAgICAgICAgICAgICAgYnVmZiA9IFtdO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwIDsgaSA8IHRoaXMuaXRlbXMubGVuZ3RoIDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGJ1ZmZbaV0gPSB0aGlzLml0ZW1zW2ldLnJlbmRlckh0bWwgKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJ1ZmYgPSBidWZmLmpvaW4gKFwiXCIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBidWZmID0gdGhpcy5pdGVtcztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuICc8ZGl2IGlkPVwiIyNcIiBjbGFzcz1cIiUlIGVkdWktdG9vbGJhclwiIGRhdGEtc3JjPVwic2hvcnRjdXRtZW51XCIgb25tb3VzZWRvd249XCJyZXR1cm4gZmFsc2U7XCIgb25zZWxlY3RzdGFydD1cInJldHVybiBmYWxzZTtcIiA+JyArXG4gICAgICAgICAgICAgICAgYnVmZiArXG4gICAgICAgICAgICAgICAgJzwvZGl2Pic7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgdXRpbHMuaW5oZXJpdHMgKFNob3J0Q3V0TWVudSAsIFVJQmFzZSk7XG5cbiAgICBmdW5jdGlvbiBoaWRlQWxsTWVudSAoZSkge1xuICAgICAgICB2YXIgdGd0ID0gZS50YXJnZXQgfHwgZS5zcmNFbGVtZW50LFxuICAgICAgICAgICAgY3VyID0gZG9tVXRpbHMuZmluZFBhcmVudCAodGd0ICwgZnVuY3Rpb24gKG5vZGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZG9tVXRpbHMuaGFzQ2xhc3MgKG5vZGUgLCBcImVkdWktc2hvcnRjdXRtZW51XCIpIHx8IGRvbVV0aWxzLmhhc0NsYXNzIChub2RlICwgXCJlZHVpLXBvcHVwXCIpO1xuICAgICAgICAgICAgfSAsIHRydWUpO1xuXG4gICAgICAgIGlmICghY3VyKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbWVudSA7IG1lbnUgPSBhbGxNZW51c1tpKytdIDspIHtcbiAgICAgICAgICAgICAgICBtZW51LmhpZGUgKClcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGRvbVV0aWxzLm9uIChkb2N1bWVudCAsICdtb3VzZWRvd24nICwgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgaGlkZUFsbE1lbnUgKGUpO1xuICAgIH0pO1xuXG4gICAgZG9tVXRpbHMub24gKHdpbmRvdyAsICdzY3JvbGwnICwgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgaGlkZUFsbE1lbnUgKGUpO1xuICAgIH0pO1xuXG59KSAoKTtcblxuXG4vLyB1aS9icmVha2xpbmUuanNcbihmdW5jdGlvbiAoKXtcbiAgICB2YXIgdXRpbHMgPSBiYWlkdS5lZGl0b3IudXRpbHMsXG4gICAgICAgIFVJQmFzZSA9IGJhaWR1LmVkaXRvci51aS5VSUJhc2UsXG4gICAgICAgIEJyZWFrbGluZSA9IGJhaWR1LmVkaXRvci51aS5CcmVha2xpbmUgPSBmdW5jdGlvbiAob3B0aW9ucyl7XG4gICAgICAgICAgICB0aGlzLmluaXRPcHRpb25zKG9wdGlvbnMpO1xuICAgICAgICAgICAgdGhpcy5pbml0U2VwYXJhdG9yKCk7XG4gICAgICAgIH07XG4gICAgQnJlYWtsaW5lLnByb3RvdHlwZSA9IHtcbiAgICAgICAgdWlOYW1lOiAnQnJlYWtsaW5lJyxcbiAgICAgICAgaW5pdFNlcGFyYXRvcjogZnVuY3Rpb24gKCl7XG4gICAgICAgICAgICB0aGlzLmluaXRVSUJhc2UoKTtcbiAgICAgICAgfSxcbiAgICAgICAgZ2V0SHRtbFRwbDogZnVuY3Rpb24gKCl7XG4gICAgICAgICAgICByZXR1cm4gJzxici8+JztcbiAgICAgICAgfVxuICAgIH07XG4gICAgdXRpbHMuaW5oZXJpdHMoQnJlYWtsaW5lLCBVSUJhc2UpO1xuXG59KSgpO1xuXG5cbi8vIHVpL21lc3NhZ2UuanNcbi8vL2ltcG9ydCBjb3JlXG4vLy9pbXBvcnQgdWljb3JlXG4oZnVuY3Rpb24gKCkge1xuICAgIHZhciB1dGlscyA9IGJhaWR1LmVkaXRvci51dGlscyxcbiAgICAgICAgZG9tVXRpbHMgPSBiYWlkdS5lZGl0b3IuZG9tLmRvbVV0aWxzLFxuICAgICAgICBVSUJhc2UgPSBiYWlkdS5lZGl0b3IudWkuVUlCYXNlLFxuICAgICAgICBNZXNzYWdlID0gYmFpZHUuZWRpdG9yLnVpLk1lc3NhZ2UgPSBmdW5jdGlvbiAob3B0aW9ucyl7XG4gICAgICAgICAgICB0aGlzLmluaXRPcHRpb25zKG9wdGlvbnMpO1xuICAgICAgICAgICAgdGhpcy5pbml0TWVzc2FnZSgpO1xuICAgICAgICB9O1xuXG4gICAgTWVzc2FnZS5wcm90b3R5cGUgPSB7XG4gICAgICAgIGluaXRNZXNzYWdlOiBmdW5jdGlvbiAoKXtcbiAgICAgICAgICAgIHRoaXMuaW5pdFVJQmFzZSgpO1xuICAgICAgICB9LFxuICAgICAgICBnZXRIdG1sVHBsOiBmdW5jdGlvbiAoKXtcbiAgICAgICAgICAgIHJldHVybiAnPGRpdiBpZD1cIiMjXCIgY2xhc3M9XCJlZHVpLW1lc3NhZ2UgJSVcIj4nICtcbiAgICAgICAgICAgICcgPGRpdiBpZD1cIiMjX2Nsb3NlclwiIGNsYXNzPVwiZWR1aS1tZXNzYWdlLWNsb3NlclwiPsOXPC9kaXY+JyArXG4gICAgICAgICAgICAnIDxkaXYgaWQ9XCIjI19ib2R5XCIgY2xhc3M9XCJlZHVpLW1lc3NhZ2UtYm9keSBlZHVpLW1lc3NhZ2UtdHlwZS1pbmZvXCI+JyArXG4gICAgICAgICAgICAnIDxpZnJhbWUgc3R5bGU9XCJwb3NpdGlvbjphYnNvbHV0ZTt6LWluZGV4Oi0xO2xlZnQ6MDt0b3A6MDtiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDtcIiBmcmFtZWJvcmRlcj1cIjBcIiB3aWR0aD1cIjEwMCVcIiBoZWlnaHQ9XCIxMDAlXCIgc3JjPVwiYWJvdXQ6YmxhbmtcIj48L2lmcmFtZT4nICtcbiAgICAgICAgICAgICcgPGRpdiBjbGFzcz1cImVkdWktc2hhZG93XCI+PC9kaXY+JyArXG4gICAgICAgICAgICAnIDxkaXYgaWQ9XCIjI19jb250ZW50XCIgY2xhc3M9XCJlZHVpLW1lc3NhZ2UtY29udGVudFwiPicgK1xuICAgICAgICAgICAgJyAgPC9kaXY+JyArXG4gICAgICAgICAgICAnIDwvZGl2PicgK1xuICAgICAgICAgICAgJzwvZGl2Pic7XG4gICAgICAgIH0sXG4gICAgICAgIHJlc2V0OiBmdW5jdGlvbihvcHQpe1xuICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcbiAgICAgICAgICAgIGlmICghb3B0LmtlZXBzaG93KSB7XG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpO1xuICAgICAgICAgICAgICAgIG1lLnRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgICAgICBtZS5oaWRlKCk7XG4gICAgICAgICAgICAgICAgfSwgb3B0LnRpbWVvdXQgfHwgNDAwMCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG9wdC5jb250ZW50ICE9PSB1bmRlZmluZWQgJiYgbWUuc2V0Q29udGVudChvcHQuY29udGVudCk7XG4gICAgICAgICAgICBvcHQudHlwZSAhPT0gdW5kZWZpbmVkICYmIG1lLnNldFR5cGUob3B0LnR5cGUpO1xuXG4gICAgICAgICAgICBtZS5zaG93KCk7XG4gICAgICAgIH0sXG4gICAgICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzLFxuICAgICAgICAgICAgICAgIGNsb3NlciA9IHRoaXMuZ2V0RG9tKCdjbG9zZXInKTtcbiAgICAgICAgICAgIGNsb3NlciAmJiBkb21VdGlscy5vbihjbG9zZXIsICdjbGljaycsIGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgbWUuaGlkZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sXG4gICAgICAgIHNldENvbnRlbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpe1xuICAgICAgICAgICAgdGhpcy5nZXREb20oJ2NvbnRlbnQnKS5pbm5lckhUTUwgPSBjb250ZW50O1xuICAgICAgICB9LFxuICAgICAgICBzZXRUeXBlOiBmdW5jdGlvbih0eXBlKXtcbiAgICAgICAgICAgIHR5cGUgPSB0eXBlIHx8ICdpbmZvJztcbiAgICAgICAgICAgIHZhciBib2R5ID0gdGhpcy5nZXREb20oJ2JvZHknKTtcbiAgICAgICAgICAgIGJvZHkuY2xhc3NOYW1lID0gYm9keS5jbGFzc05hbWUucmVwbGFjZSgvZWR1aS1tZXNzYWdlLXR5cGUtW1xcdy1dKy8sICdlZHVpLW1lc3NhZ2UtdHlwZS0nICsgdHlwZSk7XG4gICAgICAgIH0sXG4gICAgICAgIGdldENvbnRlbnQ6IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREb20oJ2NvbnRlbnQnKS5pbm5lckhUTUw7XG4gICAgICAgIH0sXG4gICAgICAgIGdldFR5cGU6IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICB2YXIgYXJyID0gdGhpcy5nZXREb20oJ2JvZHknKS5tYXRjaCgvZWR1aS1tZXNzYWdlLXR5cGUtKFtcXHctXSspLyk7XG4gICAgICAgICAgICByZXR1cm4gYXJyID8gYXJyWzFdOicnO1xuICAgICAgICB9LFxuICAgICAgICBzaG93OiBmdW5jdGlvbiAoKXtcbiAgICAgICAgICAgIHRoaXMuZ2V0RG9tKCkuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XG4gICAgICAgIH0sXG4gICAgICAgIGhpZGU6IGZ1bmN0aW9uICgpe1xuICAgICAgICAgICAgdmFyIGRvbSA9IHRoaXMuZ2V0RG9tKCk7XG4gICAgICAgICAgICBpZiAoZG9tKSB7XG4gICAgICAgICAgICAgICAgZG9tLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICAgICAgICAgICAgZG9tLnBhcmVudE5vZGUgJiYgZG9tLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZG9tKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICB1dGlscy5pbmhlcml0cyhNZXNzYWdlLCBVSUJhc2UpO1xuXG59KSgpO1xuXG5cbi8vIGFkYXB0ZXIvZWRpdG9ydWkuanNcbi8vdWnot5/nvJbovpHlmajnmoTpgILphY3lsaRcbi8v6YKj5Liq5oyJ6ZKu5by55Ye65pivZGlhbG9n77yM5piv5LiL5ouJ562Q562J6YO95piv5Zyo6L+Z5LiqanPkuK3phY3nva5cbi8v6Ieq5bex5YaZ55qEdWnkuZ/opoHlnKjov5nph4zphY3nva7vvIzmlL7liLBiYWlkdS5lZGl0b3IudWnkuIvovrnvvIzlvZPnvJbovpHlmajlrp7kvovljJbnmoTml7blgJnkvJrmoLnmja51ZWRpdG9yLmNvbmZpZ+S4reeahHRvb2xiYXJz5om+5Yiw55u45bqU55qE6L+b6KGM5a6e5L6L5YyWXG4oZnVuY3Rpb24gKCkge1xuICAgIHZhciB1dGlscyA9IGJhaWR1LmVkaXRvci51dGlscztcbiAgICB2YXIgZWRpdG9ydWkgPSBiYWlkdS5lZGl0b3IudWk7XG4gICAgdmFyIF9EaWFsb2cgPSBlZGl0b3J1aS5EaWFsb2c7XG4gICAgZWRpdG9ydWkuYnV0dG9ucyA9IHt9O1xuXG4gICAgZWRpdG9ydWkuRGlhbG9nID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgICAgdmFyIGRpYWxvZyA9IG5ldyBfRGlhbG9nKG9wdGlvbnMpO1xuICAgICAgICBkaWFsb2cuYWRkTGlzdGVuZXIoJ2hpZGUnLCBmdW5jdGlvbiAoKSB7XG5cbiAgICAgICAgICAgIGlmIChkaWFsb2cuZWRpdG9yKSB7XG4gICAgICAgICAgICAgICAgdmFyIGVkaXRvciA9IGRpYWxvZy5lZGl0b3I7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJyb3dzZXIuZ2Vja28pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB5ID0gZWRpdG9yLndpbmRvdy5zY3JvbGxZLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggPSBlZGl0b3Iud2luZG93LnNjcm9sbFg7XG4gICAgICAgICAgICAgICAgICAgICAgICBlZGl0b3IuYm9keS5mb2N1cygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yLndpbmRvdy5zY3JvbGxUbyh4LCB5KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvci5mb2N1cygpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGRpYWxvZztcbiAgICB9O1xuXG4gICAgdmFyIGlmcmFtZVVybE1hcCA9IHtcbiAgICAgICAgJ2FuY2hvcic6J34vZGlhbG9ncy9hbmNob3IvYW5jaG9yLmh0bWwnLFxuICAgICAgICAnaW5zZXJ0aW1hZ2UnOid+L2RpYWxvZ3MvaW1hZ2UvaW1hZ2UuaHRtbCcsXG4gICAgICAgICdsaW5rJzonfi9kaWFsb2dzL2xpbmsvbGluay5odG1sJyxcbiAgICAgICAgJ3NwZWNoYXJzJzonfi9kaWFsb2dzL3NwZWNoYXJzL3NwZWNoYXJzLmh0bWwnLFxuICAgICAgICAnc2VhcmNocmVwbGFjZSc6J34vZGlhbG9ncy9zZWFyY2hyZXBsYWNlL3NlYXJjaHJlcGxhY2UuaHRtbCcsXG4gICAgICAgICdtYXAnOid+L2RpYWxvZ3MvbWFwL21hcC5odG1sJyxcbiAgICAgICAgJ2dtYXAnOid+L2RpYWxvZ3MvZ21hcC9nbWFwLmh0bWwnLFxuICAgICAgICAnaW5zZXJ0dmlkZW8nOid+L2RpYWxvZ3MvdmlkZW8vdmlkZW8uaHRtbCcsXG4gICAgICAgICdoZWxwJzonfi9kaWFsb2dzL2hlbHAvaGVscC5odG1sJyxcbiAgICAgICAgJ3ByZXZpZXcnOid+L2RpYWxvZ3MvcHJldmlldy9wcmV2aWV3Lmh0bWwnLFxuICAgICAgICAnZW1vdGlvbic6J34vZGlhbG9ncy9lbW90aW9uL2Vtb3Rpb24uaHRtbCcsXG4gICAgICAgICd3b3JkaW1hZ2UnOid+L2RpYWxvZ3Mvd29yZGltYWdlL3dvcmRpbWFnZS5odG1sJyxcbiAgICAgICAgJ2F0dGFjaG1lbnQnOid+L2RpYWxvZ3MvYXR0YWNobWVudC9hdHRhY2htZW50Lmh0bWwnLFxuICAgICAgICAnaW5zZXJ0ZnJhbWUnOid+L2RpYWxvZ3MvaW5zZXJ0ZnJhbWUvaW5zZXJ0ZnJhbWUuaHRtbCcsXG4gICAgICAgICdlZGl0dGlwJzonfi9kaWFsb2dzL3RhYmxlL2VkaXR0aXAuaHRtbCcsXG4gICAgICAgICdlZGl0dGFibGUnOid+L2RpYWxvZ3MvdGFibGUvZWRpdHRhYmxlLmh0bWwnLFxuICAgICAgICAnZWRpdHRkJzonfi9kaWFsb2dzL3RhYmxlL2VkaXR0ZC5odG1sJyxcbiAgICAgICAgJ3dlYmFwcCc6J34vZGlhbG9ncy93ZWJhcHAvd2ViYXBwLmh0bWwnLFxuICAgICAgICAnc25hcHNjcmVlbic6J34vZGlhbG9ncy9zbmFwc2NyZWVuL3NuYXBzY3JlZW4uaHRtbCcsXG4gICAgICAgICdzY3Jhd2wnOid+L2RpYWxvZ3Mvc2NyYXdsL3NjcmF3bC5odG1sJyxcbiAgICAgICAgJ211c2ljJzonfi9kaWFsb2dzL211c2ljL211c2ljLmh0bWwnLFxuICAgICAgICAndGVtcGxhdGUnOid+L2RpYWxvZ3MvdGVtcGxhdGUvdGVtcGxhdGUuaHRtbCcsXG4gICAgICAgICdiYWNrZ3JvdW5kJzonfi9kaWFsb2dzL2JhY2tncm91bmQvYmFja2dyb3VuZC5odG1sJyxcbiAgICAgICAgJ2NoYXJ0cyc6ICd+L2RpYWxvZ3MvY2hhcnRzL2NoYXJ0cy5odG1sJ1xuICAgIH07XG4gICAgLy/kuLrlt6XlhbfmoI/mt7vliqDmjInpkq7vvIzku6XkuIvpg73mmK/nu5/kuIDnmoTmjInpkq7op6blj5Hlkb3ku6TvvIzmiYDku6XlhpnlnKjkuIDotbdcbiAgICB2YXIgYnRuQ21kcyA9IFsndW5kbycsICdyZWRvJywgJ2Zvcm1hdG1hdGNoJyxcbiAgICAgICAgJ2JvbGQnLCAnaXRhbGljJywgJ3VuZGVybGluZScsICdmb250Ym9yZGVyJywgJ3RvdXBwZXJjYXNlJywgJ3RvbG93ZXJjYXNlJyxcbiAgICAgICAgJ3N0cmlrZXRocm91Z2gnLCAnc3Vic2NyaXB0JywgJ3N1cGVyc2NyaXB0JywgJ3NvdXJjZScsICdpbmRlbnQnLCAnb3V0ZGVudCcsXG4gICAgICAgICdibG9ja3F1b3RlJywgJ3Bhc3RlcGxhaW4nLCAncGFnZWJyZWFrJyxcbiAgICAgICAgJ3NlbGVjdGFsbCcsICdwcmludCcsJ2hvcml6b250YWwnLCAncmVtb3ZlZm9ybWF0JywgJ3RpbWUnLCAnZGF0ZScsICd1bmxpbmsnLFxuICAgICAgICAnaW5zZXJ0cGFyYWdyYXBoYmVmb3JldGFibGUnLCAnaW5zZXJ0cm93JywgJ2luc2VydGNvbCcsICdtZXJnZXJpZ2h0JywgJ21lcmdlZG93bicsICdkZWxldGVyb3cnLFxuICAgICAgICAnZGVsZXRlY29sJywgJ3NwbGl0dG9yb3dzJywgJ3NwbGl0dG9jb2xzJywgJ3NwbGl0dG9jZWxscycsICdtZXJnZWNlbGxzJywgJ2RlbGV0ZXRhYmxlJywgJ2RyYWZ0cyddO1xuXG4gICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IGJ0bkNtZHNbaSsrXTspIHtcbiAgICAgICAgY2kgPSBjaS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBlZGl0b3J1aVtjaV0gPSBmdW5jdGlvbiAoY21kKSB7XG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGVkaXRvcikge1xuICAgICAgICAgICAgICAgIHZhciB1aSA9IG5ldyBlZGl0b3J1aS5CdXR0b24oe1xuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6J2VkdWktZm9yLScgKyBjbWQsXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOmVkaXRvci5vcHRpb25zLmxhYmVsTWFwW2NtZF0gfHwgZWRpdG9yLmdldExhbmcoXCJsYWJlbE1hcC5cIiArIGNtZCkgfHwgJycsXG4gICAgICAgICAgICAgICAgICAgIG9uY2xpY2s6ZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmV4ZWNDb21tYW5kKGNtZCk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHRoZW1lOmVkaXRvci5vcHRpb25zLnRoZW1lLFxuICAgICAgICAgICAgICAgICAgICBzaG93VGV4dDpmYWxzZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGVkaXRvcnVpLmJ1dHRvbnNbY21kXSA9IHVpO1xuICAgICAgICAgICAgICAgIGVkaXRvci5hZGRMaXN0ZW5lcignc2VsZWN0aW9uY2hhbmdlJywgZnVuY3Rpb24gKHR5cGUsIGNhdXNlQnlVaSwgdWlSZWFkeSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgc3RhdGUgPSBlZGl0b3IucXVlcnlDb21tYW5kU3RhdGUoY21kKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlID09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1aS5zZXREaXNhYmxlZCh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVpLnNldENoZWNrZWQoZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF1aVJlYWR5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdWkuc2V0RGlzYWJsZWQoZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpLnNldENoZWNrZWQoc3RhdGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfShjaSk7XG4gICAgfVxuXG4gICAgLy/muIXpmaTmlofmoaNcbiAgICBlZGl0b3J1aS5jbGVhcmRvYyA9IGZ1bmN0aW9uIChlZGl0b3IpIHtcbiAgICAgICAgdmFyIHVpID0gbmV3IGVkaXRvcnVpLkJ1dHRvbih7XG4gICAgICAgICAgICBjbGFzc05hbWU6J2VkdWktZm9yLWNsZWFyZG9jJyxcbiAgICAgICAgICAgIHRpdGxlOmVkaXRvci5vcHRpb25zLmxhYmVsTWFwLmNsZWFyZG9jIHx8IGVkaXRvci5nZXRMYW5nKFwibGFiZWxNYXAuY2xlYXJkb2NcIikgfHwgJycsXG4gICAgICAgICAgICB0aGVtZTplZGl0b3Iub3B0aW9ucy50aGVtZSxcbiAgICAgICAgICAgIG9uY2xpY2s6ZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChjb25maXJtKGVkaXRvci5nZXRMYW5nKFwiY29uZmlybUNsZWFyXCIpKSkge1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3IuZXhlY0NvbW1hbmQoJ2NsZWFyZG9jJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgZWRpdG9ydWkuYnV0dG9uc1tcImNsZWFyZG9jXCJdID0gdWk7XG4gICAgICAgIGVkaXRvci5hZGRMaXN0ZW5lcignc2VsZWN0aW9uY2hhbmdlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdWkuc2V0RGlzYWJsZWQoZWRpdG9yLnF1ZXJ5Q29tbWFuZFN0YXRlKCdjbGVhcmRvYycpID09IC0xKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB1aTtcbiAgICB9O1xuXG4gICAgLy/mjpLniYjvvIzlm77niYfmjpLniYjvvIzmloflrZfmlrnlkJFcbiAgICB2YXIgdHlwZXNldCA9IHtcbiAgICAgICAgJ2p1c3RpZnknOlsnbGVmdCcsICdyaWdodCcsICdjZW50ZXInLCAnanVzdGlmeSddLFxuICAgICAgICAnaW1hZ2VmbG9hdCc6Wydub25lJywgJ2xlZnQnLCAnY2VudGVyJywgJ3JpZ2h0J10sXG4gICAgICAgICdkaXJlY3Rpb25hbGl0eSc6WydsdHInLCAncnRsJ11cbiAgICB9O1xuXG4gICAgZm9yICh2YXIgcCBpbiB0eXBlc2V0KSB7XG5cbiAgICAgICAgKGZ1bmN0aW9uIChjbWQsIHZhbCkge1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IHZhbFtpKytdOykge1xuICAgICAgICAgICAgICAgIChmdW5jdGlvbiAoY21kMikge1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3J1aVtjbWQucmVwbGFjZSgnZmxvYXQnLCAnJykgKyBjbWQyXSA9IGZ1bmN0aW9uIChlZGl0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1aSA9IG5ldyBlZGl0b3J1aS5CdXR0b24oe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTonZWR1aS1mb3ItJyArIGNtZC5yZXBsYWNlKCdmbG9hdCcsICcnKSArIGNtZDIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6ZWRpdG9yLm9wdGlvbnMubGFiZWxNYXBbY21kLnJlcGxhY2UoJ2Zsb2F0JywgJycpICsgY21kMl0gfHwgZWRpdG9yLmdldExhbmcoXCJsYWJlbE1hcC5cIiArIGNtZC5yZXBsYWNlKCdmbG9hdCcsICcnKSArIGNtZDIpIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZW1lOmVkaXRvci5vcHRpb25zLnRoZW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uY2xpY2s6ZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlZGl0b3IuZXhlY0NvbW1hbmQoY21kLCBjbWQyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvcnVpLmJ1dHRvbnNbY21kXSA9IHVpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmFkZExpc3RlbmVyKCdzZWxlY3Rpb25jaGFuZ2UnLCBmdW5jdGlvbiAodHlwZSwgY2F1c2VCeVVpLCB1aVJlYWR5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdWkuc2V0RGlzYWJsZWQoZWRpdG9yLnF1ZXJ5Q29tbWFuZFN0YXRlKGNtZCkgPT0gLTEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpLnNldENoZWNrZWQoZWRpdG9yLnF1ZXJ5Q29tbWFuZFZhbHVlKGNtZCkgPT0gY21kMiAmJiAhdWlSZWFkeSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1aTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9KShjaSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkocCwgdHlwZXNldFtwXSlcbiAgICB9XG5cbiAgICAvL+Wtl+S9k+minOiJsuWSjOiDjOaZr+minOiJslxuICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSBbJ2JhY2tjb2xvcicsICdmb3JlY29sb3InXVtpKytdOykge1xuICAgICAgICBlZGl0b3J1aVtjaV0gPSBmdW5jdGlvbiAoY21kKSB7XG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGVkaXRvcikge1xuICAgICAgICAgICAgICAgIHZhciB1aSA9IG5ldyBlZGl0b3J1aS5Db2xvckJ1dHRvbih7XG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTonZWR1aS1mb3ItJyArIGNtZCxcbiAgICAgICAgICAgICAgICAgICAgY29sb3I6J2RlZmF1bHQnLFxuICAgICAgICAgICAgICAgICAgICB0aXRsZTplZGl0b3Iub3B0aW9ucy5sYWJlbE1hcFtjbWRdIHx8IGVkaXRvci5nZXRMYW5nKFwibGFiZWxNYXAuXCIgKyBjbWQpIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICBlZGl0b3I6ZWRpdG9yLFxuICAgICAgICAgICAgICAgICAgICBvbnBpY2tjb2xvcjpmdW5jdGlvbiAodCwgY29sb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvci5leGVjQ29tbWFuZChjbWQsIGNvbG9yKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgb25waWNrbm9jb2xvcjpmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlZGl0b3IuZXhlY0NvbW1hbmQoY21kLCAnZGVmYXVsdCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDb2xvcigndHJhbnNwYXJlbnQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29sb3IgPSAnZGVmYXVsdCc7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIG9uYnV0dG9uY2xpY2s6ZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmV4ZWNDb21tYW5kKGNtZCwgdGhpcy5jb2xvcik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBlZGl0b3J1aS5idXR0b25zW2NtZF0gPSB1aTtcbiAgICAgICAgICAgICAgICBlZGl0b3IuYWRkTGlzdGVuZXIoJ3NlbGVjdGlvbmNoYW5nZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdWkuc2V0RGlzYWJsZWQoZWRpdG9yLnF1ZXJ5Q29tbWFuZFN0YXRlKGNtZCkgPT0gLTEpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHJldHVybiB1aTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0oY2kpO1xuICAgIH1cblxuXG4gICAgdmFyIGRpYWxvZ0J0bnMgPSB7XG4gICAgICAgIG5vT2s6WydzZWFyY2hyZXBsYWNlJywgJ2hlbHAnLCAnc3BlY2hhcnMnLCAnd2ViYXBwJywncHJldmlldyddLFxuICAgICAgICBvazpbJ2F0dGFjaG1lbnQnLCAnYW5jaG9yJywgJ2xpbmsnLCAnaW5zZXJ0aW1hZ2UnLCAnbWFwJywgJ2dtYXAnLCAnaW5zZXJ0ZnJhbWUnLCAnd29yZGltYWdlJyxcbiAgICAgICAgICAgICdpbnNlcnR2aWRlbycsICdpbnNlcnRmcmFtZScsICdlZGl0dGlwJywgJ2VkaXR0YWJsZScsICdlZGl0dGQnLCAnc2NyYXdsJywgJ3RlbXBsYXRlJywgJ211c2ljJywgJ2JhY2tncm91bmQnLCAnY2hhcnRzJ11cbiAgICB9O1xuXG4gICAgZm9yICh2YXIgcCBpbiBkaWFsb2dCdG5zKSB7XG4gICAgICAgIChmdW5jdGlvbiAodHlwZSwgdmFscykge1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpOyBjaSA9IHZhbHNbaSsrXTspIHtcbiAgICAgICAgICAgICAgICAvL3RvZG8gb3BlcmHkuIvlrZjlnKjpl67pophcbiAgICAgICAgICAgICAgICBpZiAoYnJvd3Nlci5vcGVyYSAmJiBjaSA9PT0gXCJzZWFyY2hyZXBsYWNlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIChmdW5jdGlvbiAoY21kKSB7XG4gICAgICAgICAgICAgICAgICAgIGVkaXRvcnVpW2NtZF0gPSBmdW5jdGlvbiAoZWRpdG9yLCBpZnJhbWVVcmwsIHRpdGxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZnJhbWVVcmwgPSBpZnJhbWVVcmwgfHwgKGVkaXRvci5vcHRpb25zLmlmcmFtZVVybE1hcCB8fCB7fSlbY21kXSB8fCBpZnJhbWVVcmxNYXBbY21kXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlID0gZWRpdG9yLm9wdGlvbnMubGFiZWxNYXBbY21kXSB8fCBlZGl0b3IuZ2V0TGFuZyhcImxhYmVsTWFwLlwiICsgY21kKSB8fCAnJztcblxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpYWxvZztcbiAgICAgICAgICAgICAgICAgICAgICAgIC8v5rKh5pyJaWZyYW1lVXJs5LiN5Yib5bu6ZGlhbG9nXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaWZyYW1lVXJsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nID0gbmV3IGVkaXRvcnVpLkRpYWxvZyh1dGlscy5leHRlbmQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZnJhbWVVcmw6ZWRpdG9yLnVpLm1hcFVybChpZnJhbWVVcmwpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlZGl0b3I6ZWRpdG9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6J2VkdWktZm9yLScgKyBjbWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOnRpdGxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBob2xkU2Nyb2xsOiBjbWQgPT09ICdpbnNlcnRpbWFnZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxzY3JlZW46IC9jaGFydHN8cHJldmlldy8udGVzdChjbWQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbG9zZURpYWxvZzplZGl0b3IuZ2V0TGFuZyhcImNsb3NlRGlhbG9nXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgdHlwZSA9PSAnb2snID8ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25zOltcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6J2VkdWktb2tidXR0b24nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOmVkaXRvci5nZXRMYW5nKFwib2tcIiksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yOmVkaXRvcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbmNsaWNrOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmNsb3NlKHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOidlZHVpLWNhbmNlbGJ1dHRvbicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6ZWRpdG9yLmdldExhbmcoXCJjYW5jZWxcIiksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yOmVkaXRvcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbmNsaWNrOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmNsb3NlKGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IDoge30pKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvci51aS5fZGlhbG9nc1tjbWQgKyBcIkRpYWxvZ1wiXSA9IGRpYWxvZztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVpID0gbmV3IGVkaXRvcnVpLkJ1dHRvbih7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOidlZHVpLWZvci0nICsgY21kLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOnRpdGxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uY2xpY2s6ZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlhbG9nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGNtZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJ3b3JkaW1hZ2VcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGltYWdlcyA9IGVkaXRvci5leGVjQ29tbWFuZChcIndvcmRpbWFnZVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGltYWdlcyAmJiBpbWFnZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWFsb2cucmVuZGVyKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWFsb2cub3BlbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJzY3Jhd2xcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVkaXRvci5xdWVyeUNvbW1hbmRTdGF0ZShcInNjcmF3bFwiKSAhPSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nLnJlbmRlcigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nLm9wZW4oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpYWxvZy5yZW5kZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nLm9wZW4oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlbWU6ZWRpdG9yLm9wdGlvbnMudGhlbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ6KGNtZCA9PSAnc2NyYXdsJyAmJiBlZGl0b3IucXVlcnlDb21tYW5kU3RhdGUoXCJzY3Jhd2xcIikgPT0gLTEpIHx8ICggY21kID09ICdjaGFydHMnIClcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9ydWkuYnV0dG9uc1tjbWRdID0gdWk7XG4gICAgICAgICAgICAgICAgICAgICAgICBlZGl0b3IuYWRkTGlzdGVuZXIoJ3NlbGVjdGlvbmNoYW5nZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL+WPquWtmOWcqOS6juWPs+mUruiPnOWNleiAjOaXoOW3peWFt+agj+aMiemSrueahHVp5LiN6ZyA6KaB5qOA5rWL54q25oCBXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVuTmVlZENoZWNrU3RhdGUgPSB7J2VkaXR0YWJsZSc6MX07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNtZCBpbiB1bk5lZWRDaGVja1N0YXRlKXJldHVybjtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZSA9IGVkaXRvci5xdWVyeUNvbW1hbmRTdGF0ZShjbWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1aS5nZXREb20oKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aS5zZXREaXNhYmxlZChzdGF0ZSA9PSAtMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpLnNldENoZWNrZWQoc3RhdGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1aTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9KShjaS50b0xvd2VyQ2FzZSgpKVxuICAgICAgICAgICAgfVxuICAgICAgICB9KShwLCBkaWFsb2dCdG5zW3BdKTtcbiAgICB9XG5cbiAgICBlZGl0b3J1aS5zbmFwc2NyZWVuID0gZnVuY3Rpb24gKGVkaXRvciwgaWZyYW1lVXJsLCB0aXRsZSkge1xuICAgICAgICB0aXRsZSA9IGVkaXRvci5vcHRpb25zLmxhYmVsTWFwWydzbmFwc2NyZWVuJ10gfHwgZWRpdG9yLmdldExhbmcoXCJsYWJlbE1hcC5zbmFwc2NyZWVuXCIpIHx8ICcnO1xuICAgICAgICB2YXIgdWkgPSBuZXcgZWRpdG9ydWkuQnV0dG9uKHtcbiAgICAgICAgICAgIGNsYXNzTmFtZTonZWR1aS1mb3Itc25hcHNjcmVlbicsXG4gICAgICAgICAgICB0aXRsZTp0aXRsZSxcbiAgICAgICAgICAgIG9uY2xpY2s6ZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGVkaXRvci5leGVjQ29tbWFuZChcInNuYXBzY3JlZW5cIik7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdGhlbWU6ZWRpdG9yLm9wdGlvbnMudGhlbWVcblxuICAgICAgICB9KTtcbiAgICAgICAgZWRpdG9ydWkuYnV0dG9uc1snc25hcHNjcmVlbiddID0gdWk7XG4gICAgICAgIGlmcmFtZVVybCA9IGlmcmFtZVVybCB8fCAoZWRpdG9yLm9wdGlvbnMuaWZyYW1lVXJsTWFwIHx8IHt9KVtcInNuYXBzY3JlZW5cIl0gfHwgaWZyYW1lVXJsTWFwW1wic25hcHNjcmVlblwiXTtcbiAgICAgICAgaWYgKGlmcmFtZVVybCkge1xuICAgICAgICAgICAgdmFyIGRpYWxvZyA9IG5ldyBlZGl0b3J1aS5EaWFsb2coe1xuICAgICAgICAgICAgICAgIGlmcmFtZVVybDplZGl0b3IudWkubWFwVXJsKGlmcmFtZVVybCksXG4gICAgICAgICAgICAgICAgZWRpdG9yOmVkaXRvcixcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU6J2VkdWktZm9yLXNuYXBzY3JlZW4nLFxuICAgICAgICAgICAgICAgIHRpdGxlOnRpdGxlLFxuICAgICAgICAgICAgICAgIGJ1dHRvbnM6W1xuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6J2VkdWktb2tidXR0b24nLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6ZWRpdG9yLmdldExhbmcoXCJva1wiKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvcjplZGl0b3IsXG4gICAgICAgICAgICAgICAgICAgICAgICBvbmNsaWNrOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWFsb2cuY2xvc2UodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTonZWR1aS1jYW5jZWxidXR0b24nLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6ZWRpdG9yLmdldExhbmcoXCJjYW5jZWxcIiksXG4gICAgICAgICAgICAgICAgICAgICAgICBlZGl0b3I6ZWRpdG9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgb25jbGljazpmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nLmNsb3NlKGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIF1cblxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBkaWFsb2cucmVuZGVyKCk7XG4gICAgICAgICAgICBlZGl0b3IudWkuX2RpYWxvZ3NbXCJzbmFwc2NyZWVuRGlhbG9nXCJdID0gZGlhbG9nO1xuICAgICAgICB9XG4gICAgICAgIGVkaXRvci5hZGRMaXN0ZW5lcignc2VsZWN0aW9uY2hhbmdlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdWkuc2V0RGlzYWJsZWQoZWRpdG9yLnF1ZXJ5Q29tbWFuZFN0YXRlKCdzbmFwc2NyZWVuJykgPT0gLTEpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHVpO1xuICAgIH07XG5cbiAgICBlZGl0b3J1aS5pbnNlcnRjb2RlID0gZnVuY3Rpb24gKGVkaXRvciwgbGlzdCwgdGl0bGUpIHtcbiAgICAgICAgbGlzdCA9IGVkaXRvci5vcHRpb25zWydpbnNlcnRjb2RlJ10gfHwgW107XG4gICAgICAgIHRpdGxlID0gZWRpdG9yLm9wdGlvbnMubGFiZWxNYXBbJ2luc2VydGNvZGUnXSB8fCBlZGl0b3IuZ2V0TGFuZyhcImxhYmVsTWFwLmluc2VydGNvZGVcIikgfHwgJyc7XG4gICAgICAgLy8gaWYgKCFsaXN0Lmxlbmd0aCkgcmV0dXJuO1xuICAgICAgICB2YXIgaXRlbXMgPSBbXTtcbiAgICAgICAgdXRpbHMuZWFjaChsaXN0LGZ1bmN0aW9uKGtleSx2YWwpe1xuICAgICAgICAgICAgaXRlbXMucHVzaCh7XG4gICAgICAgICAgICAgICAgbGFiZWw6a2V5LFxuICAgICAgICAgICAgICAgIHZhbHVlOnZhbCxcbiAgICAgICAgICAgICAgICB0aGVtZTplZGl0b3Iub3B0aW9ucy50aGVtZSxcbiAgICAgICAgICAgICAgICByZW5kZXJMYWJlbEh0bWw6ZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxkaXYgY2xhc3M9XCJlZHVpLWxhYmVsICUlLWxhYmVsXCIgPicgKyAodGhpcy5sYWJlbCB8fCAnJykgKyAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdmFyIHVpID0gbmV3IGVkaXRvcnVpLkNvbWJveCh7XG4gICAgICAgICAgICBlZGl0b3I6ZWRpdG9yLFxuICAgICAgICAgICAgaXRlbXM6aXRlbXMsXG4gICAgICAgICAgICBvbnNlbGVjdDpmdW5jdGlvbiAodCwgaW5kZXgpIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuZXhlY0NvbW1hbmQoJ2luc2VydGNvZGUnLCB0aGlzLml0ZW1zW2luZGV4XS52YWx1ZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25idXR0b25jbGljazpmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zaG93UG9wdXAoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0aXRsZTp0aXRsZSxcbiAgICAgICAgICAgIGluaXRWYWx1ZTp0aXRsZSxcbiAgICAgICAgICAgIGNsYXNzTmFtZTonZWR1aS1mb3ItaW5zZXJ0Y29kZScsXG4gICAgICAgICAgICBpbmRleEJ5VmFsdWU6ZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSB0aGlzLml0ZW1zW2ldOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaS52YWx1ZS5pbmRleE9mKHZhbHVlKSAhPSAtMSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGVkaXRvcnVpLmJ1dHRvbnNbJ2luc2VydGNvZGUnXSA9IHVpO1xuICAgICAgICBlZGl0b3IuYWRkTGlzdGVuZXIoJ3NlbGVjdGlvbmNoYW5nZScsIGZ1bmN0aW9uICh0eXBlLCBjYXVzZUJ5VWksIHVpUmVhZHkpIHtcbiAgICAgICAgICAgIGlmICghdWlSZWFkeSkge1xuICAgICAgICAgICAgICAgIHZhciBzdGF0ZSA9IGVkaXRvci5xdWVyeUNvbW1hbmRTdGF0ZSgnaW5zZXJ0Y29kZScpO1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICB1aS5zZXREaXNhYmxlZCh0cnVlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB1aS5zZXREaXNhYmxlZChmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGVkaXRvci5xdWVyeUNvbW1hbmRWYWx1ZSgnaW5zZXJ0Y29kZScpO1xuICAgICAgICAgICAgICAgICAgICBpZighdmFsdWUpe1xuICAgICAgICAgICAgICAgICAgICAgICAgdWkuc2V0VmFsdWUodGl0bGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vdHJhY2U6MTg3MSBpZeS4i+S7jua6kOeggeaooeW8j+WIh+aNouWbnuadpeaXtu+8jOWtl+S9k+S8muW4puWNleW8leWPt++8jOiAjOS4lOS8muaciemAl+WPt1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZSAmJiAodmFsdWUgPSB2YWx1ZS5yZXBsYWNlKC9bJ1wiXS9nLCAnJykuc3BsaXQoJywnKVswXSk7XG4gICAgICAgICAgICAgICAgICAgIHVpLnNldFZhbHVlKHZhbHVlKTtcblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHVpO1xuICAgIH07XG4gICAgZWRpdG9ydWkuZm9udGZhbWlseSA9IGZ1bmN0aW9uIChlZGl0b3IsIGxpc3QsIHRpdGxlKSB7XG5cbiAgICAgICAgbGlzdCA9IGVkaXRvci5vcHRpb25zWydmb250ZmFtaWx5J10gfHwgW107XG4gICAgICAgIHRpdGxlID0gZWRpdG9yLm9wdGlvbnMubGFiZWxNYXBbJ2ZvbnRmYW1pbHknXSB8fCBlZGl0b3IuZ2V0TGFuZyhcImxhYmVsTWFwLmZvbnRmYW1pbHlcIikgfHwgJyc7XG4gICAgICAgIGlmICghbGlzdC5sZW5ndGgpIHJldHVybjtcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNpLCBpdGVtcyA9IFtdOyBjaSA9IGxpc3RbaV07IGkrKykge1xuICAgICAgICAgICAgdmFyIGxhbmdMYWJlbCA9IGVkaXRvci5nZXRMYW5nKCdmb250ZmFtaWx5JylbY2kubmFtZV0gfHwgXCJcIjtcbiAgICAgICAgICAgIChmdW5jdGlvbiAoa2V5LCB2YWwpIHtcbiAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6a2V5LFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTp2YWwsXG4gICAgICAgICAgICAgICAgICAgIHRoZW1lOmVkaXRvci5vcHRpb25zLnRoZW1lLFxuICAgICAgICAgICAgICAgICAgICByZW5kZXJMYWJlbEh0bWw6ZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8ZGl2IGNsYXNzPVwiZWR1aS1sYWJlbCAlJS1sYWJlbFwiIHN0eWxlPVwiZm9udC1mYW1pbHk6JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXRpbHMudW5odG1sKHRoaXMudmFsdWUpICsgJ1wiPicgKyAodGhpcy5sYWJlbCB8fCAnJykgKyAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSkoY2kubGFiZWwgfHwgbGFuZ0xhYmVsLCBjaS52YWwpXG4gICAgICAgIH1cbiAgICAgICAgdmFyIHVpID0gbmV3IGVkaXRvcnVpLkNvbWJveCh7XG4gICAgICAgICAgICBlZGl0b3I6ZWRpdG9yLFxuICAgICAgICAgICAgaXRlbXM6aXRlbXMsXG4gICAgICAgICAgICBvbnNlbGVjdDpmdW5jdGlvbiAodCwgaW5kZXgpIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuZXhlY0NvbW1hbmQoJ0ZvbnRGYW1pbHknLCB0aGlzLml0ZW1zW2luZGV4XS52YWx1ZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25idXR0b25jbGljazpmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zaG93UG9wdXAoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0aXRsZTp0aXRsZSxcbiAgICAgICAgICAgIGluaXRWYWx1ZTp0aXRsZSxcbiAgICAgICAgICAgIGNsYXNzTmFtZTonZWR1aS1mb3ItZm9udGZhbWlseScsXG4gICAgICAgICAgICBpbmRleEJ5VmFsdWU6ZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaTsgY2kgPSB0aGlzLml0ZW1zW2ldOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaS52YWx1ZS5pbmRleE9mKHZhbHVlKSAhPSAtMSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGVkaXRvcnVpLmJ1dHRvbnNbJ2ZvbnRmYW1pbHknXSA9IHVpO1xuICAgICAgICBlZGl0b3IuYWRkTGlzdGVuZXIoJ3NlbGVjdGlvbmNoYW5nZScsIGZ1bmN0aW9uICh0eXBlLCBjYXVzZUJ5VWksIHVpUmVhZHkpIHtcbiAgICAgICAgICAgIGlmICghdWlSZWFkeSkge1xuICAgICAgICAgICAgICAgIHZhciBzdGF0ZSA9IGVkaXRvci5xdWVyeUNvbW1hbmRTdGF0ZSgnRm9udEZhbWlseScpO1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICB1aS5zZXREaXNhYmxlZCh0cnVlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB1aS5zZXREaXNhYmxlZChmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGVkaXRvci5xdWVyeUNvbW1hbmRWYWx1ZSgnRm9udEZhbWlseScpO1xuICAgICAgICAgICAgICAgICAgICAvL3RyYWNlOjE4NzEgaWXkuIvku47mupDnoIHmqKHlvI/liIfmjaLlm57mnaXml7bvvIzlrZfkvZPkvJrluKbljZXlvJXlj7fvvIzogIzkuJTkvJrmnInpgJflj7dcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgJiYgKHZhbHVlID0gdmFsdWUucmVwbGFjZSgvWydcIl0vZywgJycpLnNwbGl0KCcsJylbMF0pO1xuICAgICAgICAgICAgICAgICAgICB1aS5zZXRWYWx1ZSh2YWx1ZSk7XG5cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB1aTtcbiAgICB9O1xuXG4gICAgZWRpdG9ydWkuZm9udHNpemUgPSBmdW5jdGlvbiAoZWRpdG9yLCBsaXN0LCB0aXRsZSkge1xuICAgICAgICB0aXRsZSA9IGVkaXRvci5vcHRpb25zLmxhYmVsTWFwWydmb250c2l6ZSddIHx8IGVkaXRvci5nZXRMYW5nKFwibGFiZWxNYXAuZm9udHNpemVcIikgfHwgJyc7XG4gICAgICAgIGxpc3QgPSBsaXN0IHx8IGVkaXRvci5vcHRpb25zWydmb250c2l6ZSddIHx8IFtdO1xuICAgICAgICBpZiAoIWxpc3QubGVuZ3RoKSByZXR1cm47XG4gICAgICAgIHZhciBpdGVtcyA9IFtdO1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHZhciBzaXplID0gbGlzdFtpXSArICdweCc7XG4gICAgICAgICAgICBpdGVtcy5wdXNoKHtcbiAgICAgICAgICAgICAgICBsYWJlbDpzaXplLFxuICAgICAgICAgICAgICAgIHZhbHVlOnNpemUsXG4gICAgICAgICAgICAgICAgdGhlbWU6ZWRpdG9yLm9wdGlvbnMudGhlbWUsXG4gICAgICAgICAgICAgICAgcmVuZGVyTGFiZWxIdG1sOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8ZGl2IGNsYXNzPVwiZWR1aS1sYWJlbCAlJS1sYWJlbFwiIHN0eWxlPVwibGluZS1oZWlnaHQ6MTtmb250LXNpemU6JyArXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbHVlICsgJ1wiPicgKyAodGhpcy5sYWJlbCB8fCAnJykgKyAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgdWkgPSBuZXcgZWRpdG9ydWkuQ29tYm94KHtcbiAgICAgICAgICAgIGVkaXRvcjplZGl0b3IsXG4gICAgICAgICAgICBpdGVtczppdGVtcyxcbiAgICAgICAgICAgIHRpdGxlOnRpdGxlLFxuICAgICAgICAgICAgaW5pdFZhbHVlOnRpdGxlLFxuICAgICAgICAgICAgb25zZWxlY3Q6ZnVuY3Rpb24gKHQsIGluZGV4KSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmV4ZWNDb21tYW5kKCdGb250U2l6ZScsIHRoaXMuaXRlbXNbaW5kZXhdLnZhbHVlKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvbmJ1dHRvbmNsaWNrOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dQb3B1cCgpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNsYXNzTmFtZTonZWR1aS1mb3ItZm9udHNpemUnXG4gICAgICAgIH0pO1xuICAgICAgICBlZGl0b3J1aS5idXR0b25zWydmb250c2l6ZSddID0gdWk7XG4gICAgICAgIGVkaXRvci5hZGRMaXN0ZW5lcignc2VsZWN0aW9uY2hhbmdlJywgZnVuY3Rpb24gKHR5cGUsIGNhdXNlQnlVaSwgdWlSZWFkeSkge1xuICAgICAgICAgICAgaWYgKCF1aVJlYWR5KSB7XG4gICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gZWRpdG9yLnF1ZXJ5Q29tbWFuZFN0YXRlKCdGb250U2l6ZScpO1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICB1aS5zZXREaXNhYmxlZCh0cnVlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB1aS5zZXREaXNhYmxlZChmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIHVpLnNldFZhbHVlKGVkaXRvci5xdWVyeUNvbW1hbmRWYWx1ZSgnRm9udFNpemUnKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdWk7XG4gICAgfTtcblxuICAgIGVkaXRvcnVpLnBhcmFncmFwaCA9IGZ1bmN0aW9uIChlZGl0b3IsIGxpc3QsIHRpdGxlKSB7XG4gICAgICAgIHRpdGxlID0gZWRpdG9yLm9wdGlvbnMubGFiZWxNYXBbJ3BhcmFncmFwaCddIHx8IGVkaXRvci5nZXRMYW5nKFwibGFiZWxNYXAucGFyYWdyYXBoXCIpIHx8ICcnO1xuICAgICAgICBsaXN0ID0gZWRpdG9yLm9wdGlvbnNbJ3BhcmFncmFwaCddIHx8IFtdO1xuICAgICAgICBpZiAodXRpbHMuaXNFbXB0eU9iamVjdChsaXN0KSkgcmV0dXJuO1xuICAgICAgICB2YXIgaXRlbXMgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaSBpbiBsaXN0KSB7XG4gICAgICAgICAgICBpdGVtcy5wdXNoKHtcbiAgICAgICAgICAgICAgICB2YWx1ZTppLFxuICAgICAgICAgICAgICAgIGxhYmVsOmxpc3RbaV0gfHwgZWRpdG9yLmdldExhbmcoXCJwYXJhZ3JhcGhcIilbaV0sXG4gICAgICAgICAgICAgICAgdGhlbWU6ZWRpdG9yLm9wdGlvbnMudGhlbWUsXG4gICAgICAgICAgICAgICAgcmVuZGVyTGFiZWxIdG1sOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8ZGl2IGNsYXNzPVwiZWR1aS1sYWJlbCAlJS1sYWJlbFwiPjxzcGFuIGNsYXNzPVwiZWR1aS1mb3ItJyArIHRoaXMudmFsdWUgKyAnXCI+JyArICh0aGlzLmxhYmVsIHx8ICcnKSArICc8L3NwYW4+PC9kaXY+JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICAgIHZhciB1aSA9IG5ldyBlZGl0b3J1aS5Db21ib3goe1xuICAgICAgICAgICAgZWRpdG9yOmVkaXRvcixcbiAgICAgICAgICAgIGl0ZW1zOml0ZW1zLFxuICAgICAgICAgICAgdGl0bGU6dGl0bGUsXG4gICAgICAgICAgICBpbml0VmFsdWU6dGl0bGUsXG4gICAgICAgICAgICBjbGFzc05hbWU6J2VkdWktZm9yLXBhcmFncmFwaCcsXG4gICAgICAgICAgICBvbnNlbGVjdDpmdW5jdGlvbiAodCwgaW5kZXgpIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuZXhlY0NvbW1hbmQoJ1BhcmFncmFwaCcsIHRoaXMuaXRlbXNbaW5kZXhdLnZhbHVlKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvbmJ1dHRvbmNsaWNrOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dQb3B1cCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgZWRpdG9ydWkuYnV0dG9uc1sncGFyYWdyYXBoJ10gPSB1aTtcbiAgICAgICAgZWRpdG9yLmFkZExpc3RlbmVyKCdzZWxlY3Rpb25jaGFuZ2UnLCBmdW5jdGlvbiAodHlwZSwgY2F1c2VCeVVpLCB1aVJlYWR5KSB7XG4gICAgICAgICAgICBpZiAoIXVpUmVhZHkpIHtcbiAgICAgICAgICAgICAgICB2YXIgc3RhdGUgPSBlZGl0b3IucXVlcnlDb21tYW5kU3RhdGUoJ1BhcmFncmFwaCcpO1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICB1aS5zZXREaXNhYmxlZCh0cnVlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB1aS5zZXREaXNhYmxlZChmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGVkaXRvci5xdWVyeUNvbW1hbmRWYWx1ZSgnUGFyYWdyYXBoJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHVpLmluZGV4QnlWYWx1ZSh2YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCAhPSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdWkuc2V0VmFsdWUodmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdWkuc2V0VmFsdWUodWkuaW5pdFZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHVpO1xuICAgIH07XG5cblxuICAgIC8v6Ieq5a6a5LmJ5qCH6aKYXG4gICAgZWRpdG9ydWkuY3VzdG9tc3R5bGUgPSBmdW5jdGlvbiAoZWRpdG9yKSB7XG4gICAgICAgIHZhciBsaXN0ID0gZWRpdG9yLm9wdGlvbnNbJ2N1c3RvbXN0eWxlJ10gfHwgW10sXG4gICAgICAgICAgICB0aXRsZSA9IGVkaXRvci5vcHRpb25zLmxhYmVsTWFwWydjdXN0b21zdHlsZSddIHx8IGVkaXRvci5nZXRMYW5nKFwibGFiZWxNYXAuY3VzdG9tc3R5bGVcIikgfHwgJyc7XG4gICAgICAgIGlmICghbGlzdC5sZW5ndGgpcmV0dXJuO1xuICAgICAgICB2YXIgbGFuZ0NzID0gZWRpdG9yLmdldExhbmcoJ2N1c3RvbXN0eWxlJyk7XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtcyA9IFtdLCB0OyB0ID0gbGlzdFtpKytdOykge1xuICAgICAgICAgICAgKGZ1bmN0aW9uICh0KSB7XG4gICAgICAgICAgICAgICAgdmFyIGNrID0ge307XG4gICAgICAgICAgICAgICAgY2subGFiZWwgPSB0LmxhYmVsID8gdC5sYWJlbCA6IGxhbmdDc1t0Lm5hbWVdO1xuICAgICAgICAgICAgICAgIGNrLnN0eWxlID0gdC5zdHlsZTtcbiAgICAgICAgICAgICAgICBjay5jbGFzc05hbWUgPSB0LmNsYXNzTmFtZTtcbiAgICAgICAgICAgICAgICBjay50YWcgPSB0LnRhZztcbiAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6Y2subGFiZWwsXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOmNrLFxuICAgICAgICAgICAgICAgICAgICB0aGVtZTplZGl0b3Iub3B0aW9ucy50aGVtZSxcbiAgICAgICAgICAgICAgICAgICAgcmVuZGVyTGFiZWxIdG1sOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGRpdiBjbGFzcz1cImVkdWktbGFiZWwgJSUtbGFiZWxcIj4nICsgJzwnICsgY2sudGFnICsgJyAnICsgKGNrLmNsYXNzTmFtZSA/ICcgY2xhc3M9XCInICsgY2suY2xhc3NOYW1lICsgJ1wiJyA6IFwiXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAoY2suc3R5bGUgPyAnIHN0eWxlPVwiJyArIGNrLnN0eWxlICsgJ1wiJyA6IFwiXCIpICsgJz4nICsgY2subGFiZWwgKyBcIjxcXC9cIiArIGNrLnRhZyArIFwiPlwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSkodCk7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgdWkgPSBuZXcgZWRpdG9ydWkuQ29tYm94KHtcbiAgICAgICAgICAgIGVkaXRvcjplZGl0b3IsXG4gICAgICAgICAgICBpdGVtczppdGVtcyxcbiAgICAgICAgICAgIHRpdGxlOnRpdGxlLFxuICAgICAgICAgICAgaW5pdFZhbHVlOnRpdGxlLFxuICAgICAgICAgICAgY2xhc3NOYW1lOidlZHVpLWZvci1jdXN0b21zdHlsZScsXG4gICAgICAgICAgICBvbnNlbGVjdDpmdW5jdGlvbiAodCwgaW5kZXgpIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuZXhlY0NvbW1hbmQoJ2N1c3RvbXN0eWxlJywgdGhpcy5pdGVtc1tpbmRleF0udmFsdWUpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9uYnV0dG9uY2xpY2s6ZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2hvd1BvcHVwKCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaW5kZXhCeVZhbHVlOmZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCB0aTsgdGkgPSB0aGlzLml0ZW1zW2krK107KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aS5sYWJlbCA9PSB2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGkgLSAxXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgZWRpdG9ydWkuYnV0dG9uc1snY3VzdG9tc3R5bGUnXSA9IHVpO1xuICAgICAgICBlZGl0b3IuYWRkTGlzdGVuZXIoJ3NlbGVjdGlvbmNoYW5nZScsIGZ1bmN0aW9uICh0eXBlLCBjYXVzZUJ5VWksIHVpUmVhZHkpIHtcbiAgICAgICAgICAgIGlmICghdWlSZWFkeSkge1xuICAgICAgICAgICAgICAgIHZhciBzdGF0ZSA9IGVkaXRvci5xdWVyeUNvbW1hbmRTdGF0ZSgnY3VzdG9tc3R5bGUnKTtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUgPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgdWkuc2V0RGlzYWJsZWQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdWkuc2V0RGlzYWJsZWQoZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBlZGl0b3IucXVlcnlDb21tYW5kVmFsdWUoJ2N1c3RvbXN0eWxlJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHVpLmluZGV4QnlWYWx1ZSh2YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCAhPSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdWkuc2V0VmFsdWUodmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdWkuc2V0VmFsdWUodWkuaW5pdFZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHVpO1xuICAgIH07XG4gICAgZWRpdG9ydWkuaW5zZXJ0dGFibGUgPSBmdW5jdGlvbiAoZWRpdG9yLCBpZnJhbWVVcmwsIHRpdGxlKSB7XG4gICAgICAgIHRpdGxlID0gZWRpdG9yLm9wdGlvbnMubGFiZWxNYXBbJ2luc2VydHRhYmxlJ10gfHwgZWRpdG9yLmdldExhbmcoXCJsYWJlbE1hcC5pbnNlcnR0YWJsZVwiKSB8fCAnJztcbiAgICAgICAgdmFyIHVpID0gbmV3IGVkaXRvcnVpLlRhYmxlQnV0dG9uKHtcbiAgICAgICAgICAgIGVkaXRvcjplZGl0b3IsXG4gICAgICAgICAgICB0aXRsZTp0aXRsZSxcbiAgICAgICAgICAgIGNsYXNzTmFtZTonZWR1aS1mb3ItaW5zZXJ0dGFibGUnLFxuICAgICAgICAgICAgb25waWNrdGFibGU6ZnVuY3Rpb24gKHQsIG51bUNvbHMsIG51bVJvd3MpIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuZXhlY0NvbW1hbmQoJ0luc2VydFRhYmxlJywge251bVJvd3M6bnVtUm93cywgbnVtQ29sczpudW1Db2xzLCBib3JkZXI6MX0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9uYnV0dG9uY2xpY2s6ZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2hvd1BvcHVwKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBlZGl0b3J1aS5idXR0b25zWydpbnNlcnR0YWJsZSddID0gdWk7XG4gICAgICAgIGVkaXRvci5hZGRMaXN0ZW5lcignc2VsZWN0aW9uY2hhbmdlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdWkuc2V0RGlzYWJsZWQoZWRpdG9yLnF1ZXJ5Q29tbWFuZFN0YXRlKCdpbnNlcnR0YWJsZScpID09IC0xKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB1aTtcbiAgICB9O1xuXG4gICAgZWRpdG9ydWkubGluZWhlaWdodCA9IGZ1bmN0aW9uIChlZGl0b3IpIHtcbiAgICAgICAgdmFyIHZhbCA9IGVkaXRvci5vcHRpb25zLmxpbmVoZWlnaHQgfHwgW107XG4gICAgICAgIGlmICghdmFsLmxlbmd0aClyZXR1cm47XG4gICAgICAgIGZvciAodmFyIGkgPSAwLCBjaSwgaXRlbXMgPSBbXTsgY2kgPSB2YWxbaSsrXTspIHtcbiAgICAgICAgICAgIGl0ZW1zLnB1c2goe1xuICAgICAgICAgICAgICAgIC8vdG9kbzrlhpnmrbvkuoZcbiAgICAgICAgICAgICAgICBsYWJlbDpjaSxcbiAgICAgICAgICAgICAgICB2YWx1ZTpjaSxcbiAgICAgICAgICAgICAgICB0aGVtZTplZGl0b3Iub3B0aW9ucy50aGVtZSxcbiAgICAgICAgICAgICAgICBvbmNsaWNrOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmV4ZWNDb21tYW5kKFwibGluZWhlaWdodFwiLCB0aGlzLnZhbHVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICAgIHZhciB1aSA9IG5ldyBlZGl0b3J1aS5NZW51QnV0dG9uKHtcbiAgICAgICAgICAgIGVkaXRvcjplZGl0b3IsXG4gICAgICAgICAgICBjbGFzc05hbWU6J2VkdWktZm9yLWxpbmVoZWlnaHQnLFxuICAgICAgICAgICAgdGl0bGU6ZWRpdG9yLm9wdGlvbnMubGFiZWxNYXBbJ2xpbmVoZWlnaHQnXSB8fCBlZGl0b3IuZ2V0TGFuZyhcImxhYmVsTWFwLmxpbmVoZWlnaHRcIikgfHwgJycsXG4gICAgICAgICAgICBpdGVtczppdGVtcyxcbiAgICAgICAgICAgIG9uYnV0dG9uY2xpY2s6ZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGVkaXRvci5xdWVyeUNvbW1hbmRWYWx1ZSgnTGluZUhlaWdodCcpIHx8IHRoaXMudmFsdWU7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmV4ZWNDb21tYW5kKFwiTGluZUhlaWdodFwiLCB2YWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBlZGl0b3J1aS5idXR0b25zWydsaW5laGVpZ2h0J10gPSB1aTtcbiAgICAgICAgZWRpdG9yLmFkZExpc3RlbmVyKCdzZWxlY3Rpb25jaGFuZ2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgc3RhdGUgPSBlZGl0b3IucXVlcnlDb21tYW5kU3RhdGUoJ0xpbmVIZWlnaHQnKTtcbiAgICAgICAgICAgIGlmIChzdGF0ZSA9PSAtMSkge1xuICAgICAgICAgICAgICAgIHVpLnNldERpc2FibGVkKHRydWUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB1aS5zZXREaXNhYmxlZChmYWxzZSk7XG4gICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gZWRpdG9yLnF1ZXJ5Q29tbWFuZFZhbHVlKCdMaW5lSGVpZ2h0Jyk7XG4gICAgICAgICAgICAgICAgdmFsdWUgJiYgdWkuc2V0VmFsdWUoKHZhbHVlICsgJycpLnJlcGxhY2UoL2NtLywgJycpKTtcbiAgICAgICAgICAgICAgICB1aS5zZXRDaGVja2VkKHN0YXRlKVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHVpO1xuICAgIH07XG5cbiAgICB2YXIgcm93c3BhY2luZ3MgPSBbJ3RvcCcsICdib3R0b20nXTtcbiAgICBmb3IgKHZhciByID0gMCwgcmk7IHJpID0gcm93c3BhY2luZ3NbcisrXTspIHtcbiAgICAgICAgKGZ1bmN0aW9uIChjbWQpIHtcbiAgICAgICAgICAgIGVkaXRvcnVpWydyb3dzcGFjaW5nJyArIGNtZF0gPSBmdW5jdGlvbiAoZWRpdG9yKSB7XG4gICAgICAgICAgICAgICAgdmFyIHZhbCA9IGVkaXRvci5vcHRpb25zWydyb3dzcGFjaW5nJyArIGNtZF0gfHwgW107XG4gICAgICAgICAgICAgICAgaWYgKCF2YWwubGVuZ3RoKSByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2ksIGl0ZW1zID0gW107IGNpID0gdmFsW2krK107KSB7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW1zLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6Y2ksXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTpjaSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoZW1lOmVkaXRvci5vcHRpb25zLnRoZW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgb25jbGljazpmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmV4ZWNDb21tYW5kKFwicm93c3BhY2luZ1wiLCB0aGlzLnZhbHVlLCBjbWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgdWkgPSBuZXcgZWRpdG9ydWkuTWVudUJ1dHRvbih7XG4gICAgICAgICAgICAgICAgICAgIGVkaXRvcjplZGl0b3IsXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTonZWR1aS1mb3Itcm93c3BhY2luZycgKyBjbWQsXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOmVkaXRvci5vcHRpb25zLmxhYmVsTWFwWydyb3dzcGFjaW5nJyArIGNtZF0gfHwgZWRpdG9yLmdldExhbmcoXCJsYWJlbE1hcC5yb3dzcGFjaW5nXCIgKyBjbWQpIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICBpdGVtczppdGVtcyxcbiAgICAgICAgICAgICAgICAgICAgb25idXR0b25jbGljazpmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBlZGl0b3IucXVlcnlDb21tYW5kVmFsdWUoJ3Jvd3NwYWNpbmcnLCBjbWQpIHx8IHRoaXMudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBlZGl0b3IuZXhlY0NvbW1hbmQoXCJyb3dzcGFjaW5nXCIsIHZhbHVlLCBjbWQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgZWRpdG9ydWkuYnV0dG9uc1tjbWRdID0gdWk7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmFkZExpc3RlbmVyKCdzZWxlY3Rpb25jaGFuZ2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZSA9IGVkaXRvci5xdWVyeUNvbW1hbmRTdGF0ZSgncm93c3BhY2luZycsIGNtZCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdWkuc2V0RGlzYWJsZWQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1aS5zZXREaXNhYmxlZChmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBlZGl0b3IucXVlcnlDb21tYW5kVmFsdWUoJ3Jvd3NwYWNpbmcnLCBjbWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgJiYgdWkuc2V0VmFsdWUoKHZhbHVlICsgJycpLnJlcGxhY2UoLyUvLCAnJykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdWkuc2V0Q2hlY2tlZChzdGF0ZSlcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHJldHVybiB1aTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkocmkpXG4gICAgfVxuICAgIC8v5pyJ5bqP77yM5peg5bqP5YiX6KGoXG4gICAgdmFyIGxpc3RzID0gWydpbnNlcnRvcmRlcmVkbGlzdCcsICdpbnNlcnR1bm9yZGVyZWRsaXN0J107XG4gICAgZm9yICh2YXIgbCA9IDAsIGNsOyBjbCA9IGxpc3RzW2wrK107KSB7XG4gICAgICAgIChmdW5jdGlvbiAoY21kKSB7XG4gICAgICAgICAgICBlZGl0b3J1aVtjbWRdID0gZnVuY3Rpb24gKGVkaXRvcikge1xuICAgICAgICAgICAgICAgIHZhciB2YWxzID0gZWRpdG9yLm9wdGlvbnNbY21kXSxcbiAgICAgICAgICAgICAgICAgICAgX29uTWVudUNsaWNrID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmV4ZWNDb21tYW5kKGNtZCwgdGhpcy52YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH0sIGl0ZW1zID0gW107XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiB2YWxzKSB7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW1zLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6dmFsc1tpXSB8fCBlZGl0b3IuZ2V0TGFuZygpW2NtZF1baV0gfHwgXCJcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOmksXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGVtZTplZGl0b3Iub3B0aW9ucy50aGVtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uY2xpY2s6X29uTWVudUNsaWNrXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciB1aSA9IG5ldyBlZGl0b3J1aS5NZW51QnV0dG9uKHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yOmVkaXRvcixcbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOidlZHVpLWZvci0nICsgY21kLFxuICAgICAgICAgICAgICAgICAgICB0aXRsZTplZGl0b3IuZ2V0TGFuZyhcImxhYmVsTWFwLlwiICsgY21kKSB8fCAnJyxcbiAgICAgICAgICAgICAgICAgICAgJ2l0ZW1zJzppdGVtcyxcbiAgICAgICAgICAgICAgICAgICAgb25idXR0b25jbGljazpmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBlZGl0b3IucXVlcnlDb21tYW5kVmFsdWUoY21kKSB8fCB0aGlzLnZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmV4ZWNDb21tYW5kKGNtZCwgdmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgZWRpdG9ydWkuYnV0dG9uc1tjbWRdID0gdWk7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmFkZExpc3RlbmVyKCdzZWxlY3Rpb25jaGFuZ2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZSA9IGVkaXRvci5xdWVyeUNvbW1hbmRTdGF0ZShjbWQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUgPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVpLnNldERpc2FibGVkKHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdWkuc2V0RGlzYWJsZWQoZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gZWRpdG9yLnF1ZXJ5Q29tbWFuZFZhbHVlKGNtZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB1aS5zZXRWYWx1ZSh2YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB1aS5zZXRDaGVja2VkKHN0YXRlKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfSkoY2wpXG4gICAgfVxuXG4gICAgZWRpdG9ydWkuZnVsbHNjcmVlbiA9IGZ1bmN0aW9uIChlZGl0b3IsIHRpdGxlKSB7XG4gICAgICAgIHRpdGxlID0gZWRpdG9yLm9wdGlvbnMubGFiZWxNYXBbJ2Z1bGxzY3JlZW4nXSB8fCBlZGl0b3IuZ2V0TGFuZyhcImxhYmVsTWFwLmZ1bGxzY3JlZW5cIikgfHwgJyc7XG4gICAgICAgIHZhciB1aSA9IG5ldyBlZGl0b3J1aS5CdXR0b24oe1xuICAgICAgICAgICAgY2xhc3NOYW1lOidlZHVpLWZvci1mdWxsc2NyZWVuJyxcbiAgICAgICAgICAgIHRpdGxlOnRpdGxlLFxuICAgICAgICAgICAgdGhlbWU6ZWRpdG9yLm9wdGlvbnMudGhlbWUsXG4gICAgICAgICAgICBvbmNsaWNrOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoZWRpdG9yLnVpKSB7XG4gICAgICAgICAgICAgICAgICAgIGVkaXRvci51aS5zZXRGdWxsU2NyZWVuKCFlZGl0b3IudWkuaXNGdWxsU2NyZWVuKCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnNldENoZWNrZWQoZWRpdG9yLnVpLmlzRnVsbFNjcmVlbigpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGVkaXRvcnVpLmJ1dHRvbnNbJ2Z1bGxzY3JlZW4nXSA9IHVpO1xuICAgICAgICBlZGl0b3IuYWRkTGlzdGVuZXIoJ3NlbGVjdGlvbmNoYW5nZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBzdGF0ZSA9IGVkaXRvci5xdWVyeUNvbW1hbmRTdGF0ZSgnZnVsbHNjcmVlbicpO1xuICAgICAgICAgICAgdWkuc2V0RGlzYWJsZWQoc3RhdGUgPT0gLTEpO1xuICAgICAgICAgICAgdWkuc2V0Q2hlY2tlZChlZGl0b3IudWkuaXNGdWxsU2NyZWVuKCkpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHVpO1xuICAgIH07XG5cbiAgICAvLyDooajmg4VcbiAgICBlZGl0b3J1aVtcImVtb3Rpb25cIl0gPSBmdW5jdGlvbiAoZWRpdG9yLCBpZnJhbWVVcmwpIHtcbiAgICAgICAgdmFyIGNtZCA9IFwiZW1vdGlvblwiO1xuICAgICAgICB2YXIgdWkgPSBuZXcgZWRpdG9ydWkuTXVsdGlNZW51UG9wKHtcbiAgICAgICAgICAgIHRpdGxlOmVkaXRvci5vcHRpb25zLmxhYmVsTWFwW2NtZF0gfHwgZWRpdG9yLmdldExhbmcoXCJsYWJlbE1hcC5cIiArIGNtZCArIFwiXCIpIHx8ICcnLFxuICAgICAgICAgICAgZWRpdG9yOmVkaXRvcixcbiAgICAgICAgICAgIGNsYXNzTmFtZTonZWR1aS1mb3ItJyArIGNtZCxcbiAgICAgICAgICAgIGlmcmFtZVVybDplZGl0b3IudWkubWFwVXJsKGlmcmFtZVVybCB8fCAoZWRpdG9yLm9wdGlvbnMuaWZyYW1lVXJsTWFwIHx8IHt9KVtjbWRdIHx8IGlmcmFtZVVybE1hcFtjbWRdKVxuICAgICAgICB9KTtcbiAgICAgICAgZWRpdG9ydWkuYnV0dG9uc1tjbWRdID0gdWk7XG5cbiAgICAgICAgZWRpdG9yLmFkZExpc3RlbmVyKCdzZWxlY3Rpb25jaGFuZ2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB1aS5zZXREaXNhYmxlZChlZGl0b3IucXVlcnlDb21tYW5kU3RhdGUoY21kKSA9PSAtMSlcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB1aTtcbiAgICB9O1xuXG4gICAgZWRpdG9ydWkuYXV0b3R5cGVzZXQgPSBmdW5jdGlvbiAoZWRpdG9yKSB7XG4gICAgICAgIHZhciB1aSA9IG5ldyBlZGl0b3J1aS5BdXRvVHlwZVNldEJ1dHRvbih7XG4gICAgICAgICAgICBlZGl0b3I6ZWRpdG9yLFxuICAgICAgICAgICAgdGl0bGU6ZWRpdG9yLm9wdGlvbnMubGFiZWxNYXBbJ2F1dG90eXBlc2V0J10gfHwgZWRpdG9yLmdldExhbmcoXCJsYWJlbE1hcC5hdXRvdHlwZXNldFwiKSB8fCAnJyxcbiAgICAgICAgICAgIGNsYXNzTmFtZTonZWR1aS1mb3ItYXV0b3R5cGVzZXQnLFxuICAgICAgICAgICAgb25idXR0b25jbGljazpmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmV4ZWNDb21tYW5kKCdhdXRvdHlwZXNldCcpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBlZGl0b3J1aS5idXR0b25zWydhdXRvdHlwZXNldCddID0gdWk7XG4gICAgICAgIGVkaXRvci5hZGRMaXN0ZW5lcignc2VsZWN0aW9uY2hhbmdlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdWkuc2V0RGlzYWJsZWQoZWRpdG9yLnF1ZXJ5Q29tbWFuZFN0YXRlKCdhdXRvdHlwZXNldCcpID09IC0xKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB1aTtcbiAgICB9O1xuXG4gICAgLyog566A5Y2V5LiK5Lyg5o+S5Lu2ICovXG4gICAgZWRpdG9ydWlbXCJzaW1wbGV1cGxvYWRcIl0gPSBmdW5jdGlvbiAoZWRpdG9yKSB7XG4gICAgICAgIHZhciBuYW1lID0gJ3NpbXBsZXVwbG9hZCcsXG4gICAgICAgICAgICB1aSA9IG5ldyBlZGl0b3J1aS5CdXR0b24oe1xuICAgICAgICAgICAgICAgIGNsYXNzTmFtZTonZWR1aS1mb3ItJyArIG5hbWUsXG4gICAgICAgICAgICAgICAgdGl0bGU6ZWRpdG9yLm9wdGlvbnMubGFiZWxNYXBbbmFtZV0gfHwgZWRpdG9yLmdldExhbmcoXCJsYWJlbE1hcC5cIiArIG5hbWUpIHx8ICcnLFxuICAgICAgICAgICAgICAgIG9uY2xpY2s6ZnVuY3Rpb24gKCkge30sXG4gICAgICAgICAgICAgICAgdGhlbWU6ZWRpdG9yLm9wdGlvbnMudGhlbWUsXG4gICAgICAgICAgICAgICAgc2hvd1RleHQ6ZmFsc2VcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBlZGl0b3J1aS5idXR0b25zW25hbWVdID0gdWk7XG4gICAgICAgIGVkaXRvci5hZGRMaXN0ZW5lcigncmVhZHknLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHZhciBiID0gdWkuZ2V0RG9tKCdib2R5JyksXG4gICAgICAgICAgICAgICAgaWNvblNwYW4gPSBiLmNoaWxkcmVuWzBdO1xuICAgICAgICAgICAgZWRpdG9yLmZpcmVFdmVudCgnc2ltcGxldXBsb2FkYnRucmVhZHknLCBpY29uU3Bhbik7XG4gICAgICAgIH0pO1xuICAgICAgICBlZGl0b3IuYWRkTGlzdGVuZXIoJ3NlbGVjdGlvbmNoYW5nZScsIGZ1bmN0aW9uICh0eXBlLCBjYXVzZUJ5VWksIHVpUmVhZHkpIHtcbiAgICAgICAgICAgIHZhciBzdGF0ZSA9IGVkaXRvci5xdWVyeUNvbW1hbmRTdGF0ZShuYW1lKTtcbiAgICAgICAgICAgIGlmIChzdGF0ZSA9PSAtMSkge1xuICAgICAgICAgICAgICAgIHVpLnNldERpc2FibGVkKHRydWUpO1xuICAgICAgICAgICAgICAgIHVpLnNldENoZWNrZWQoZmFsc2UpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoIXVpUmVhZHkpIHtcbiAgICAgICAgICAgICAgICAgICAgdWkuc2V0RGlzYWJsZWQoZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB1aS5zZXRDaGVja2VkKHN0YXRlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdWk7XG4gICAgfTtcblxufSkoKTtcblxuXG4vLyBhZGFwdGVyL2VkaXRvci5qc1xuLy8vaW1wb3J0IGNvcmVcbi8vL2NvbW1hbmRzIOWFqOWxj1xuLy8vY29tbWFuZHNOYW1lIEZ1bGxTY3JlZW5cbi8vL2NvbW1hbmRzVGl0bGUgIOWFqOWxj1xuKGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgdXRpbHMgPSBiYWlkdS5lZGl0b3IudXRpbHMsXG4gICAgICAgIHVpVXRpbHMgPSBiYWlkdS5lZGl0b3IudWkudWlVdGlscyxcbiAgICAgICAgVUlCYXNlID0gYmFpZHUuZWRpdG9yLnVpLlVJQmFzZSxcbiAgICAgICAgZG9tVXRpbHMgPSBiYWlkdS5lZGl0b3IuZG9tLmRvbVV0aWxzO1xuICAgIHZhciBub2RlU3RhY2sgPSBbXTtcblxuICAgIGZ1bmN0aW9uIEVkaXRvclVJKG9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5pbml0T3B0aW9ucyhvcHRpb25zKTtcbiAgICAgICAgdGhpcy5pbml0RWRpdG9yVUkoKTtcbiAgICB9XG5cbiAgICBFZGl0b3JVSS5wcm90b3R5cGUgPSB7XG4gICAgICAgIHVpTmFtZTonZWRpdG9yJyxcbiAgICAgICAgaW5pdEVkaXRvclVJOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHRoaXMuZWRpdG9yLnVpID0gdGhpcztcbiAgICAgICAgICAgIHRoaXMuX2RpYWxvZ3MgPSB7fTtcbiAgICAgICAgICAgIHRoaXMuaW5pdFVJQmFzZSgpO1xuICAgICAgICAgICAgdGhpcy5faW5pdFRvb2xiYXJzKCk7XG4gICAgICAgICAgICB2YXIgZWRpdG9yID0gdGhpcy5lZGl0b3IsXG4gICAgICAgICAgICAgICAgbWUgPSB0aGlzO1xuXG4gICAgICAgICAgICBlZGl0b3IuYWRkTGlzdGVuZXIoJ3JlYWR5JywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIC8v5o+Q5L6bZ2V0RGlhbG9n5pa55rOVXG4gICAgICAgICAgICAgICAgZWRpdG9yLmdldERpYWxvZyA9IGZ1bmN0aW9uIChuYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBlZGl0b3IudWkuX2RpYWxvZ3NbbmFtZSArIFwiRGlhbG9nXCJdO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgZG9tVXRpbHMub24oZWRpdG9yLndpbmRvdywgJ3Njcm9sbCcsIGZ1bmN0aW9uIChldnQpIHtcbiAgICAgICAgICAgICAgICAgICAgYmFpZHUuZWRpdG9yLnVpLlBvcHVwLnBvc3RIaWRlKGV2dCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgLy/mj5DkvpvnvJbovpHlmajlrp7ml7blrr3pq5go5YWo5bGP5pe25a696auY5LiN5Y+Y5YyWKVxuICAgICAgICAgICAgICAgIGVkaXRvci51aS5fYWN0dWFsRnJhbWVXaWR0aCA9IGVkaXRvci5vcHRpb25zLmluaXRpYWxGcmFtZVdpZHRoO1xuXG4gICAgICAgICAgICAgICAgVUUuYnJvd3Nlci5pZSAmJiBVRS5icm93c2VyLnZlcnNpb24gPT09IDYgJiYgZWRpdG9yLmNvbnRhaW5lci5vd25lckRvY3VtZW50LmV4ZWNDb21tYW5kKFwiQmFja2dyb3VuZEltYWdlQ2FjaGVcIiwgZmFsc2UsIHRydWUpO1xuXG4gICAgICAgICAgICAgICAgLy9kaXNwbGF5IGJvdHRvbS1iYXIgbGFiZWwgYmFzZWQgb24gY29uZmlnXG4gICAgICAgICAgICAgICAgaWYgKGVkaXRvci5vcHRpb25zLmVsZW1lbnRQYXRoRW5hYmxlZCkge1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3IudWkuZ2V0RG9tKCdlbGVtZW50cGF0aCcpLmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPVwiZWR1aS1lZGl0b3ItYnJlYWRjcnVtYlwiPicgKyBlZGl0b3IuZ2V0TGFuZyhcImVsZW1lbnRQYXRoVGlwXCIpICsgJzo8L2Rpdj4nO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZWRpdG9yLm9wdGlvbnMud29yZENvdW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNvdW50Rm4oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRDb3VudChlZGl0b3IsbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMudW4oZWRpdG9yLmRvY3VtZW50LCBcImNsaWNrXCIsIGFyZ3VtZW50cy5jYWxsZWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLm9uKGVkaXRvci5kb2N1bWVudCwgXCJjbGlja1wiLCBjb3VudEZuKTtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLnVpLmdldERvbSgnd29yZGNvdW50JykuaW5uZXJIVE1MID0gZWRpdG9yLmdldExhbmcoXCJ3b3JkQ291bnRUaXBcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVkaXRvci51aS5fc2NhbGUoKTtcbiAgICAgICAgICAgICAgICBpZiAoZWRpdG9yLm9wdGlvbnMuc2NhbGVFbmFibGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlZGl0b3IuYXV0b0hlaWdodEVuYWJsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvci5kaXNhYmxlQXV0b0hlaWdodCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIG1lLmVuYWJsZVNjYWxlKCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbWUuZGlzYWJsZVNjYWxlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghZWRpdG9yLm9wdGlvbnMuZWxlbWVudFBhdGhFbmFibGVkICYmICFlZGl0b3Iub3B0aW9ucy53b3JkQ291bnQgJiYgIWVkaXRvci5vcHRpb25zLnNjYWxlRW5hYmxlZCkge1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3IudWkuZ2V0RG9tKCdlbGVtZW50cGF0aCcpLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLnVpLmdldERvbSgnd29yZGNvdW50Jykuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3IudWkuZ2V0RG9tKCdzY2FsZScpLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoIWVkaXRvci5zZWxlY3Rpb24uaXNGb2N1cygpKXJldHVybjtcbiAgICAgICAgICAgICAgICBlZGl0b3IuZmlyZUV2ZW50KCdzZWxlY3Rpb25jaGFuZ2UnLCBmYWxzZSwgdHJ1ZSk7XG5cblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGVkaXRvci5hZGRMaXN0ZW5lcignbW91c2Vkb3duJywgZnVuY3Rpb24gKHQsIGV2dCkge1xuICAgICAgICAgICAgICAgIHZhciBlbCA9IGV2dC50YXJnZXQgfHwgZXZ0LnNyY0VsZW1lbnQ7XG4gICAgICAgICAgICAgICAgYmFpZHUuZWRpdG9yLnVpLlBvcHVwLnBvc3RIaWRlKGV2dCwgZWwpO1xuICAgICAgICAgICAgICAgIGJhaWR1LmVkaXRvci51aS5TaG9ydEN1dE1lbnUucG9zdEhpZGUoZXZ0KTtcblxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBlZGl0b3IuYWRkTGlzdGVuZXIoXCJkZWxjZWxsc1wiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKFVFLnVpWydlZGl0dGlwJ10pIHtcbiAgICAgICAgICAgICAgICAgICAgbmV3IFVFLnVpWydlZGl0dGlwJ10oZWRpdG9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWRpdG9yLmdldERpYWxvZygnZWRpdHRpcCcpLm9wZW4oKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB2YXIgcGFzdGVQb3AsIGlzUGFzdGUgPSBmYWxzZSwgdGltZXI7XG4gICAgICAgICAgICBlZGl0b3IuYWRkTGlzdGVuZXIoXCJhZnRlcnBhc3RlXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZihlZGl0b3IucXVlcnlDb21tYW5kU3RhdGUoJ3Bhc3RlcGxhaW4nKSlcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmKGJhaWR1LmVkaXRvci51aS5QYXN0ZVBpY2tlcil7XG4gICAgICAgICAgICAgICAgICAgIHBhc3RlUG9wID0gbmV3IGJhaWR1LmVkaXRvci51aS5Qb3B1cCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50Om5ldyBiYWlkdS5lZGl0b3IudWkuUGFzdGVQaWNrZXIoe2VkaXRvcjplZGl0b3J9KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvcjplZGl0b3IsXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6J2VkdWktd29yZHBhc3RlcG9wJ1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcGFzdGVQb3AucmVuZGVyKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlzUGFzdGUgPSB0cnVlO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGVkaXRvci5hZGRMaXN0ZW5lcihcImFmdGVyaW5zZXJ0aHRtbFwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocGFzdGVQb3AgJiYgKGlzUGFzdGUgfHwgZWRpdG9yLnVpLl9pc1RyYW5zZmVyKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYocGFzdGVQb3AuaXNIaWRkZW4oKSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNwYW4gPSBkb21VdGlscy5jcmVhdGVFbGVtZW50KGVkaXRvci5kb2N1bWVudCwgJ3NwYW4nLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3R5bGUnOlwibGluZS1oZWlnaHQ6MHB4O1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2lubmVySFRNTCc6J1xcdWZlZmYnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZSA9IGVkaXRvci5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZS5pbnNlcnROb2RlKHNwYW4pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0bXA9IGdldERvbU5vZGUoc3BhbiwgJ2ZpcnN0Q2hpbGQnLCAncHJldmlvdXNTaWJsaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wICYmIHBhc3RlUG9wLnNob3dBbmNob3IodG1wLm5vZGVUeXBlID09IDMgPyB0bXAucGFyZW50Tm9kZSA6IHRtcCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHNwYW4pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzdGVQb3Auc2hvdygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGVkaXRvci51aS5faXNUcmFuc2ZlcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzUGFzdGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sIDIwMClcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgZWRpdG9yLmFkZExpc3RlbmVyKCdjb250ZXh0bWVudScsIGZ1bmN0aW9uICh0LCBldnQpIHtcbiAgICAgICAgICAgICAgICBiYWlkdS5lZGl0b3IudWkuUG9wdXAucG9zdEhpZGUoZXZ0KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgZWRpdG9yLmFkZExpc3RlbmVyKCdrZXlkb3duJywgZnVuY3Rpb24gKHQsIGV2dCkge1xuICAgICAgICAgICAgICAgIGlmIChwYXN0ZVBvcCkgICAgcGFzdGVQb3AuZGlzcG9zZShldnQpO1xuICAgICAgICAgICAgICAgIHZhciBrZXlDb2RlID0gZXZ0LmtleUNvZGUgfHwgZXZ0LndoaWNoO1xuICAgICAgICAgICAgICAgIGlmKGV2dC5hbHRLZXkmJmtleUNvZGU9PTkwKXtcbiAgICAgICAgICAgICAgICAgICAgVUUudWkuYnV0dG9uc1snZnVsbHNjcmVlbiddLm9uY2xpY2soKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGVkaXRvci5hZGRMaXN0ZW5lcignd29yZGNvdW50JywgZnVuY3Rpb24gKHR5cGUpIHtcbiAgICAgICAgICAgICAgICBzZXRDb3VudCh0aGlzLG1lKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgZnVuY3Rpb24gc2V0Q291bnQoZWRpdG9yLHVpKSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLnNldE9wdCh7XG4gICAgICAgICAgICAgICAgICAgIHdvcmRDb3VudDp0cnVlLFxuICAgICAgICAgICAgICAgICAgICBtYXhpbXVtV29yZHM6MTAwMDAsXG4gICAgICAgICAgICAgICAgICAgIHdvcmRDb3VudE1zZzplZGl0b3Iub3B0aW9ucy53b3JkQ291bnRNc2cgfHwgZWRpdG9yLmdldExhbmcoXCJ3b3JkQ291bnRNc2dcIiksXG4gICAgICAgICAgICAgICAgICAgIHdvcmRPdmVyRmxvd01zZzplZGl0b3Iub3B0aW9ucy53b3JkT3ZlckZsb3dNc2cgfHwgZWRpdG9yLmdldExhbmcoXCJ3b3JkT3ZlckZsb3dNc2dcIilcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB2YXIgb3B0ID0gZWRpdG9yLm9wdGlvbnMsXG4gICAgICAgICAgICAgICAgICAgIG1heCA9IG9wdC5tYXhpbXVtV29yZHMsXG4gICAgICAgICAgICAgICAgICAgIG1zZyA9IG9wdC53b3JkQ291bnRNc2cgLFxuICAgICAgICAgICAgICAgICAgICBlcnJNc2cgPSBvcHQud29yZE92ZXJGbG93TXNnLFxuICAgICAgICAgICAgICAgICAgICBjb3VudERvbSA9IHVpLmdldERvbSgnd29yZGNvdW50Jyk7XG4gICAgICAgICAgICAgICAgaWYgKCFvcHQud29yZENvdW50KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIGNvdW50ID0gZWRpdG9yLmdldENvbnRlbnRMZW5ndGgodHJ1ZSk7XG4gICAgICAgICAgICAgICAgaWYgKGNvdW50ID4gbWF4KSB7XG4gICAgICAgICAgICAgICAgICAgIGNvdW50RG9tLmlubmVySFRNTCA9IGVyck1zZztcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmZpcmVFdmVudChcIndvcmRjb3VudG92ZXJmbG93XCIpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvdW50RG9tLmlubmVySFRNTCA9IG1zZy5yZXBsYWNlKFwieyNsZWF2ZX1cIiwgbWF4IC0gY291bnQpLnJlcGxhY2UoXCJ7I2NvdW50fVwiLCBjb3VudCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBlZGl0b3IuYWRkTGlzdGVuZXIoJ3NlbGVjdGlvbmNoYW5nZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoZWRpdG9yLm9wdGlvbnMuZWxlbWVudFBhdGhFbmFibGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIG1lWyhlZGl0b3IucXVlcnlDb21tYW5kU3RhdGUoJ2VsZW1lbnRwYXRoJykgPT0gLTEgPyAnZGlzJyA6ICdlbicpICsgJ2FibGVFbGVtZW50UGF0aCddKClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGVkaXRvci5vcHRpb25zLnNjYWxlRW5hYmxlZCkge1xuICAgICAgICAgICAgICAgICAgICBtZVsoZWRpdG9yLnF1ZXJ5Q29tbWFuZFN0YXRlKCdzY2FsZScpID09IC0xID8gJ2RpcycgOiAnZW4nKSArICdhYmxlU2NhbGUnXSgpO1xuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB2YXIgcG9wdXAgPSBuZXcgYmFpZHUuZWRpdG9yLnVpLlBvcHVwKHtcbiAgICAgICAgICAgICAgICBlZGl0b3I6ZWRpdG9yLFxuICAgICAgICAgICAgICAgIGNvbnRlbnQ6JycsXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lOidlZHVpLWJ1YmJsZScsXG4gICAgICAgICAgICAgICAgX29uRWRpdEJ1dHRvbkNsaWNrOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7XG4gICAgICAgICAgICAgICAgICAgIGVkaXRvci51aS5fZGlhbG9ncy5saW5rRGlhbG9nLm9wZW4oKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIF9vbkltZ0VkaXRCdXR0b25DbGljazpmdW5jdGlvbiAobmFtZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLnVpLl9kaWFsb2dzW25hbWVdICYmIGVkaXRvci51aS5fZGlhbG9nc1tuYW1lXS5vcGVuKCk7XG5cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIF9vbkltZ1NldEZsb2F0OmZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmV4ZWNDb21tYW5kKFwiaW1hZ2VmbG9hdFwiLCB2YWx1ZSk7XG5cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIF9zZXRJZnJhbWVBbGlnbjpmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZyYW1lID0gcG9wdXAuYW5jaG9yRWw7XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXdGcmFtZSA9IGZyYW1lLmNsb25lTm9kZSh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAtMjpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdGcmFtZS5zZXRBdHRyaWJ1dGUoXCJhbGlnblwiLCBcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgLTE6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3RnJhbWUuc2V0QXR0cmlidXRlKFwiYWxpZ25cIiwgXCJsZWZ0XCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0ZyYW1lLnNldEF0dHJpYnV0ZShcImFsaWduXCIsIFwicmlnaHRcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZnJhbWUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobmV3RnJhbWUsIGZyYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKGZyYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgcG9wdXAuYW5jaG9yRWwgPSBuZXdGcmFtZTtcbiAgICAgICAgICAgICAgICAgICAgcG9wdXAuc2hvd0FuY2hvcihwb3B1cC5hbmNob3JFbCk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBfdXBkYXRlSWZyYW1lOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZyYW1lID0gZWRpdG9yLl9pZnJhbWUgPSBwb3B1cC5hbmNob3JFbDtcbiAgICAgICAgICAgICAgICAgICAgaWYoZG9tVXRpbHMuaGFzQ2xhc3MoZnJhbWUsICd1ZWRpdG9yX2JhaWR1bWFwJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvci5zZWxlY3Rpb24uZ2V0UmFuZ2UoKS5zZWxlY3ROb2RlKGZyYW1lKS5zZWxlY3QoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvci51aS5fZGlhbG9ncy5tYXBEaWFsb2cub3BlbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcG9wdXAuaGlkZSgpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yLnVpLl9kaWFsb2dzLmluc2VydGZyYW1lRGlhbG9nLm9wZW4oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvcHVwLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgX29uUmVtb3ZlQnV0dG9uQ2xpY2s6ZnVuY3Rpb24gKGNtZE5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmV4ZWNDb21tYW5kKGNtZE5hbWUpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGUoKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHF1ZXJ5QXV0b0hpZGU6ZnVuY3Rpb24gKGVsKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlbCAmJiBlbC5vd25lckRvY3VtZW50ID09IGVkaXRvci5kb2N1bWVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAnaW1nJyB8fCBkb21VdGlscy5maW5kUGFyZW50QnlUYWdOYW1lKGVsLCAnYScsIHRydWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsICE9PSBwb3B1cC5hbmNob3JFbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYmFpZHUuZWRpdG9yLnVpLlBvcHVwLnByb3RvdHlwZS5xdWVyeUF1dG9IaWRlLmNhbGwodGhpcywgZWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcG9wdXAucmVuZGVyKCk7XG4gICAgICAgICAgICBpZiAoZWRpdG9yLm9wdGlvbnMuaW1hZ2VQb3B1cCkge1xuICAgICAgICAgICAgICAgIGVkaXRvci5hZGRMaXN0ZW5lcignbW91c2VvdmVyJywgZnVuY3Rpb24gKHQsIGV2dCkge1xuICAgICAgICAgICAgICAgICAgICBldnQgPSBldnQgfHwgd2luZG93LmV2ZW50O1xuICAgICAgICAgICAgICAgICAgICB2YXIgZWwgPSBldnQudGFyZ2V0IHx8IGV2dC5zcmNFbGVtZW50O1xuICAgICAgICAgICAgICAgICAgICBpZiAoZWRpdG9yLnVpLl9kaWFsb2dzLmluc2VydGZyYW1lRGlhbG9nICYmIC9pZnJhbWUvaWcudGVzdChlbC50YWdOYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGh0bWwgPSBwb3B1cC5mb3JtYXRIdG1sKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8bm9icj4nICsgZWRpdG9yLmdldExhbmcoXCJwcm9wZXJ0eVwiKSArICc6IDxzcGFuIG9uY2xpY2s9JCQuX3NldElmcmFtZUFsaWduKC0yKSBjbGFzcz1cImVkdWktY2xpY2thYmxlXCI+JyArIGVkaXRvci5nZXRMYW5nKFwiZGVmYXVsdFwiKSArICc8L3NwYW4+Jm5ic3A7Jm5ic3A7PHNwYW4gb25jbGljaz0kJC5fc2V0SWZyYW1lQWxpZ24oLTEpIGNsYXNzPVwiZWR1aS1jbGlja2FibGVcIj4nICsgZWRpdG9yLmdldExhbmcoXCJqdXN0aWZ5bGVmdFwiKSArICc8L3NwYW4+Jm5ic3A7Jm5ic3A7PHNwYW4gb25jbGljaz0kJC5fc2V0SWZyYW1lQWxpZ24oMSkgY2xhc3M9XCJlZHVpLWNsaWNrYWJsZVwiPicgKyBlZGl0b3IuZ2V0TGFuZyhcImp1c3RpZnlyaWdodFwiKSArICc8L3NwYW4+Jm5ic3A7Jm5ic3A7JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgPHNwYW4gb25jbGljaz1cIiQkLl91cGRhdGVJZnJhbWUoIHRoaXMpO1wiIGNsYXNzPVwiZWR1aS1jbGlja2FibGVcIj4nICsgZWRpdG9yLmdldExhbmcoXCJtb2RpZnlcIikgKyAnPC9zcGFuPjwvbm9icj4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChodG1sKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9wdXAuZ2V0RG9tKCdjb250ZW50JykuaW5uZXJIVE1MID0gaHRtbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3B1cC5hbmNob3JFbCA9IGVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcHVwLnNob3dBbmNob3IocG9wdXAuYW5jaG9yRWwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3B1cC5oaWRlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBlZGl0b3IuYWRkTGlzdGVuZXIoJ3NlbGVjdGlvbmNoYW5nZScsIGZ1bmN0aW9uICh0LCBjYXVzZUJ5VWkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjYXVzZUJ5VWkpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGh0bWwgPSAnJywgc3RyID0gXCJcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIGltZyA9IGVkaXRvci5zZWxlY3Rpb24uZ2V0UmFuZ2UoKS5nZXRDbG9zZWROb2RlKCksXG4gICAgICAgICAgICAgICAgICAgICAgICBkaWFsb2dzID0gZWRpdG9yLnVpLl9kaWFsb2dzO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW1nICYmIGltZy50YWdOYW1lID09ICdJTUcnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGlhbG9nTmFtZSA9ICdpbnNlcnRpbWFnZURpYWxvZyc7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW1nLmNsYXNzTmFtZS5pbmRleE9mKFwiZWR1aS1mYWtlZC12aWRlb1wiKSAhPSAtMSB8fCBpbWcuY2xhc3NOYW1lLmluZGV4T2YoXCJlZHVpLXVwbG9hZC12aWRlb1wiKSAhPSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpYWxvZ05hbWUgPSBcImluc2VydHZpZGVvRGlhbG9nXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbWcuY2xhc3NOYW1lLmluZGV4T2YoXCJlZHVpLWZha2VkLXdlYmFwcFwiKSAhPSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpYWxvZ05hbWUgPSBcIndlYmFwcERpYWxvZ1wiXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW1nLnNyYy5pbmRleE9mKFwiaHR0cDovL2FwaS5tYXAuYmFpZHUuY29tXCIpICE9IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nTmFtZSA9IFwibWFwRGlhbG9nXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbWcuY2xhc3NOYW1lLmluZGV4T2YoXCJlZHVpLWZha2VkLW11c2ljXCIpICE9IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nTmFtZSA9IFwibXVzaWNEaWFsb2dcIlxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGltZy5zcmMuaW5kZXhPZihcImh0dHA6Ly9tYXBzLmdvb2dsZS5jb20vbWFwcy9hcGkvc3RhdGljbWFwXCIpICE9IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nTmFtZSA9IFwiZ21hcERpYWxvZ1wiXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW1nLmdldEF0dHJpYnV0ZShcImFuY2hvcm5hbWVcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWFsb2dOYW1lID0gXCJhbmNob3JEaWFsb2dcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sID0gcG9wdXAuZm9ybWF0SHRtbChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxub2JyPicgKyBlZGl0b3IuZ2V0TGFuZyhcInByb3BlcnR5XCIpICsgJzogPHNwYW4gb25jbGljaz0kJC5fb25JbWdFZGl0QnV0dG9uQ2xpY2soXCJhbmNob3JEaWFsb2dcIikgY2xhc3M9XCJlZHVpLWNsaWNrYWJsZVwiPicgKyBlZGl0b3IuZ2V0TGFuZyhcIm1vZGlmeVwiKSArICc8L3NwYW4+Jm5ic3A7Jm5ic3A7JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHNwYW4gb25jbGljaz0kJC5fb25SZW1vdmVCdXR0b25DbGljayhcXCdhbmNob3JcXCcpIGNsYXNzPVwiZWR1aS1jbGlja2FibGVcIj4nICsgZWRpdG9yLmdldExhbmcoXCJkZWxldGVcIikgKyAnPC9zcGFuPjwvbm9icj4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbWcuZ2V0QXR0cmlidXRlKFwid29yZF9pbWdcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3RvZG8g5pS+5YiwZGlhbG9n5Y675YGa5p+l6K+iXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yLndvcmRfaW1nID0gW2ltZy5nZXRBdHRyaWJ1dGUoXCJ3b3JkX2ltZ1wiKV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9nTmFtZSA9IFwid29yZGltYWdlRGlhbG9nXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGRvbVV0aWxzLmhhc0NsYXNzKGltZywgJ2xvYWRpbmdjbGFzcycpIHx8IGRvbVV0aWxzLmhhc0NsYXNzKGltZywgJ2xvYWRlcnJvcmNsYXNzJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWFsb2dOYW1lID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZGlhbG9nc1tkaWFsb2dOYW1lXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHN0ciA9ICc8bm9icj4nICsgZWRpdG9yLmdldExhbmcoXCJwcm9wZXJ0eVwiKSArICc6ICcrXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzcGFuIG9uY2xpY2s9JCQuX29uSW1nU2V0RmxvYXQoXCJub25lXCIpIGNsYXNzPVwiZWR1aS1jbGlja2FibGVcIj4nICsgZWRpdG9yLmdldExhbmcoXCJkZWZhdWx0XCIpICsgJzwvc3Bhbj4mbmJzcDsmbmJzcDsnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHNwYW4gb25jbGljaz0kJC5fb25JbWdTZXRGbG9hdChcImxlZnRcIikgY2xhc3M9XCJlZHVpLWNsaWNrYWJsZVwiPicgKyBlZGl0b3IuZ2V0TGFuZyhcImp1c3RpZnlsZWZ0XCIpICsgJzwvc3Bhbj4mbmJzcDsmbmJzcDsnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHNwYW4gb25jbGljaz0kJC5fb25JbWdTZXRGbG9hdChcInJpZ2h0XCIpIGNsYXNzPVwiZWR1aS1jbGlja2FibGVcIj4nICsgZWRpdG9yLmdldExhbmcoXCJqdXN0aWZ5cmlnaHRcIikgKyAnPC9zcGFuPiZuYnNwOyZuYnNwOycgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3BhbiBvbmNsaWNrPSQkLl9vbkltZ1NldEZsb2F0KFwiY2VudGVyXCIpIGNsYXNzPVwiZWR1aS1jbGlja2FibGVcIj4nICsgZWRpdG9yLmdldExhbmcoXCJqdXN0aWZ5Y2VudGVyXCIpICsgJzwvc3Bhbj4mbmJzcDsmbmJzcDsnK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3BhbiBvbmNsaWNrPVwiJCQuX29uSW1nRWRpdEJ1dHRvbkNsaWNrKFxcJycgKyBkaWFsb2dOYW1lICsgJ1xcJyk7XCIgY2xhc3M9XCJlZHVpLWNsaWNrYWJsZVwiPicgKyBlZGl0b3IuZ2V0TGFuZyhcIm1vZGlmeVwiKSArICc8L3NwYW4+PC9ub2JyPic7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICFodG1sICYmIChodG1sID0gcG9wdXAuZm9ybWF0SHRtbChzdHIpKVxuXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGVkaXRvci51aS5fZGlhbG9ncy5saW5rRGlhbG9nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGluayA9IGVkaXRvci5xdWVyeUNvbW1hbmRWYWx1ZSgnbGluaycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVybDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsaW5rICYmICh1cmwgPSAobGluay5nZXRBdHRyaWJ1dGUoJ19ocmVmJykgfHwgbGluay5nZXRBdHRyaWJ1dGUoJ2hyZWYnLCAyKSkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHR4dCA9IHVybDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodXJsLmxlbmd0aCA+IDMwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR4dCA9IHVybC5zdWJzdHJpbmcoMCwgMjApICsgXCIuLi5cIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGh0bWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbCArPSAnPGRpdiBzdHlsZT1cImhlaWdodDo1cHg7XCI+PC9kaXY+J1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sICs9IHBvcHVwLmZvcm1hdEh0bWwoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8bm9icj4nICsgZWRpdG9yLmdldExhbmcoXCJhbnRob3JNc2dcIikgKyAnOiA8YSB0YXJnZXQ9XCJfYmxhbmtcIiBocmVmPVwiJyArIHVybCArICdcIiB0aXRsZT1cIicgKyB1cmwgKyAnXCIgPicgKyB0eHQgKyAnPC9hPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyA8c3BhbiBjbGFzcz1cImVkdWktY2xpY2thYmxlXCIgb25jbGljaz1cIiQkLl9vbkVkaXRCdXR0b25DbGljaygpO1wiPicgKyBlZGl0b3IuZ2V0TGFuZyhcIm1vZGlmeVwiKSArICc8L3NwYW4+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnIDxzcGFuIGNsYXNzPVwiZWR1aS1jbGlja2FibGVcIiBvbmNsaWNrPVwiJCQuX29uUmVtb3ZlQnV0dG9uQ2xpY2soXFwndW5saW5rXFwnKTtcIj4gJyArIGVkaXRvci5nZXRMYW5nKFwiY2xlYXJcIikgKyAnPC9zcGFuPjwvbm9icj4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3B1cC5zaG93QW5jaG9yKGxpbmspO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGh0bWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvcHVwLmdldERvbSgnY29udGVudCcpLmlubmVySFRNTCA9IGh0bWw7XG4gICAgICAgICAgICAgICAgICAgICAgICBwb3B1cC5hbmNob3JFbCA9IGltZyB8fCBsaW5rO1xuICAgICAgICAgICAgICAgICAgICAgICAgcG9wdXAuc2hvd0FuY2hvcihwb3B1cC5hbmNob3JFbCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwb3B1cC5oaWRlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9LFxuICAgICAgICBfaW5pdFRvb2xiYXJzOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBlZGl0b3IgPSB0aGlzLmVkaXRvcjtcbiAgICAgICAgICAgIHZhciB0b29sYmFycyA9IHRoaXMudG9vbGJhcnMgfHwgW107XG4gICAgICAgICAgICB2YXIgdG9vbGJhclVpcyA9IFtdO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b29sYmFycy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHZhciB0b29sYmFyID0gdG9vbGJhcnNbaV07XG4gICAgICAgICAgICAgICAgdmFyIHRvb2xiYXJVaSA9IG5ldyBiYWlkdS5lZGl0b3IudWkuVG9vbGJhcih7dGhlbWU6ZWRpdG9yLm9wdGlvbnMudGhlbWV9KTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRvb2xiYXIubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRvb2xiYXJJdGVtID0gdG9vbGJhcltqXTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRvb2xiYXJJdGVtVWkgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRvb2xiYXJJdGVtID09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b29sYmFySXRlbSA9IHRvb2xiYXJJdGVtLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9vbGJhckl0ZW0gPT0gJ3wnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9vbGJhckl0ZW0gPSAnU2VwYXJhdG9yJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRvb2xiYXJJdGVtID09ICd8fCcpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvb2xiYXJJdGVtID0gJ0JyZWFrbGluZSc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmFpZHUuZWRpdG9yLnVpW3Rvb2xiYXJJdGVtXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvb2xiYXJJdGVtVWkgPSBuZXcgYmFpZHUuZWRpdG9yLnVpW3Rvb2xiYXJJdGVtXShlZGl0b3IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAvL2Z1bGxzY3JlZW7ov5nph4zljZXni6zlpITnkIbkuIDkuIvvvIzmlL7liLDpppbooYzljrtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b29sYmFySXRlbSA9PSAnZnVsbHNjcmVlbicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9vbGJhclVpcyAmJiB0b29sYmFyVWlzWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvb2xiYXJVaXNbMF0uaXRlbXMuc3BsaWNlKDAsIDAsIHRvb2xiYXJJdGVtVWkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvb2xiYXJJdGVtVWkgJiYgdG9vbGJhclVpLml0ZW1zLnNwbGljZSgwLCAwLCB0b29sYmFySXRlbVVpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcblxuXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b29sYmFySXRlbVVpID0gdG9vbGJhckl0ZW07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHRvb2xiYXJJdGVtVWkgJiYgdG9vbGJhckl0ZW1VaS5pZCkge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB0b29sYmFyVWkuYWRkKHRvb2xiYXJJdGVtVWkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRvb2xiYXJVaXNbaV0gPSB0b29sYmFyVWk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8v5o6l5Y+X5aSW6YOo5a6a5Yi255qEVUlcblxuICAgICAgICAgICAgdXRpbHMuZWFjaChVRS5fY3VzdG9taXplVUksZnVuY3Rpb24ob2JqLGtleSl7XG4gICAgICAgICAgICAgICAgdmFyIGl0ZW1VSSxpbmRleDtcbiAgICAgICAgICAgICAgICBpZihvYmouaWQgJiYgb2JqLmlkICE9IGVkaXRvci5rZXkpe1xuICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaXRlbVVJID0gb2JqLmV4ZWNGbi5jYWxsKGVkaXRvcixlZGl0b3Isa2V5KTtcbiAgICAgICAgICAgICAgICBpZihpdGVtVUkpe1xuICAgICAgICAgICAgICAgICAgICBpbmRleCA9IG9iai5pbmRleDtcbiAgICAgICAgICAgICAgICAgICAgaWYoaW5kZXggPT09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbmRleCA9IHRvb2xiYXJVaS5pdGVtcy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdG9vbGJhclVpLmFkZChpdGVtVUksaW5kZXgpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMudG9vbGJhcnMgPSB0b29sYmFyVWlzO1xuICAgICAgICB9LFxuICAgICAgICBnZXRIdG1sVHBsOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiAnPGRpdiBpZD1cIiMjXCIgY2xhc3M9XCIlJVwiPicgK1xuICAgICAgICAgICAgICAgICc8ZGl2IGlkPVwiIyNfdG9vbGJhcmJveFwiIGNsYXNzPVwiJSUtdG9vbGJhcmJveFwiPicgK1xuICAgICAgICAgICAgICAgICh0aGlzLnRvb2xiYXJzLmxlbmd0aCA/XG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGlkPVwiIyNfdG9vbGJhcmJveG91dGVyXCIgY2xhc3M9XCIlJS10b29sYmFyYm94b3V0ZXJcIj48ZGl2IGNsYXNzPVwiJSUtdG9vbGJhcmJveGlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclRvb2xiYXJCb3hIdG1sKCkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PjwvZGl2PicgOiAnJykgK1xuICAgICAgICAgICAgICAgICc8ZGl2IGlkPVwiIyNfdG9vbGJhcm1zZ1wiIGNsYXNzPVwiJSUtdG9vbGJhcm1zZ1wiIHN0eWxlPVwiZGlzcGxheTpub25lO1wiPicgK1xuICAgICAgICAgICAgICAgICc8ZGl2IGlkID0gXCIjI191cGxvYWRfZGlhbG9nXCIgY2xhc3M9XCIlJS10b29sYmFybXNnLXVwbG9hZFwiIG9uY2xpY2s9XCIkJC5zaG93V29yZEltYWdlRGlhbG9nKCk7XCI+JyArIHRoaXMuZWRpdG9yLmdldExhbmcoXCJjbGlja1RvVXBsb2FkXCIpICsgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiJSUtdG9vbGJhcm1zZy1jbG9zZVwiIG9uY2xpY2s9XCIkJC5oaWRlVG9vbGJhck1zZygpO1wiPng8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAnPGRpdiBpZD1cIiMjX3Rvb2xiYXJtc2dfbGFiZWxcIiBjbGFzcz1cIiUlLXRvb2xiYXJtc2ctbGFiZWxcIj48L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAnPGRpdiBzdHlsZT1cImhlaWdodDowO292ZXJmbG93OmhpZGRlbjtjbGVhcjpib3RoO1wiPjwvZGl2PicgK1xuICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAnPGRpdiBpZD1cIiMjX21lc3NhZ2VfaG9sZGVyXCIgY2xhc3M9XCIlJS1tZXNzYWdlaG9sZGVyXCI+PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICc8ZGl2IGlkPVwiIyNfaWZyYW1laG9sZGVyXCIgY2xhc3M9XCIlJS1pZnJhbWVob2xkZXJcIj4nICtcbiAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgLy9tb2RpZnkgd2Rjb3VudCBieSBtYXRhb1xuICAgICAgICAgICAgICAgICc8ZGl2IGlkPVwiIyNfYm90dG9tYmFyXCIgY2xhc3M9XCIlJS1ib3R0b21Db250YWluZXJcIj48dGFibGU+PHRyPicgK1xuICAgICAgICAgICAgICAgICc8dGQgaWQ9XCIjI19lbGVtZW50cGF0aFwiIGNsYXNzPVwiJSUtYm90dG9tYmFyXCI+PC90ZD4nICtcbiAgICAgICAgICAgICAgICAnPHRkIGlkPVwiIyNfd29yZGNvdW50XCIgY2xhc3M9XCIlJS13b3JkY291bnRcIj48L3RkPicgK1xuICAgICAgICAgICAgICAgICc8dGQgaWQ9XCIjI19zY2FsZVwiIGNsYXNzPVwiJSUtc2NhbGVcIj48ZGl2IGNsYXNzPVwiJSUtaWNvblwiPjwvZGl2PjwvdGQ+JyArXG4gICAgICAgICAgICAgICAgJzwvdHI+PC90YWJsZT48L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAnPGRpdiBpZD1cIiMjX3NjYWxlbGF5ZXJcIj48L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAnPC9kaXY+JztcbiAgICAgICAgfSxcbiAgICAgICAgc2hvd1dvcmRJbWFnZURpYWxvZzpmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB0aGlzLl9kaWFsb2dzWyd3b3JkaW1hZ2VEaWFsb2cnXS5vcGVuKCk7XG4gICAgICAgIH0sXG4gICAgICAgIHJlbmRlclRvb2xiYXJCb3hIdG1sOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBidWZmID0gW107XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMudG9vbGJhcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBidWZmLnB1c2godGhpcy50b29sYmFyc1tpXS5yZW5kZXJIdG1sKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGJ1ZmYuam9pbignJyk7XG4gICAgICAgIH0sXG4gICAgICAgIHNldEZ1bGxTY3JlZW46ZnVuY3Rpb24gKGZ1bGxzY3JlZW4pIHtcblxuICAgICAgICAgICAgdmFyIGVkaXRvciA9IHRoaXMuZWRpdG9yLFxuICAgICAgICAgICAgICAgIGNvbnRhaW5lciA9IGVkaXRvci5jb250YWluZXIucGFyZW50Tm9kZS5wYXJlbnROb2RlO1xuICAgICAgICAgICAgaWYgKHRoaXMuX2Z1bGxzY3JlZW4gIT0gZnVsbHNjcmVlbikge1xuICAgICAgICAgICAgICAgIHRoaXMuX2Z1bGxzY3JlZW4gPSBmdWxsc2NyZWVuO1xuICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLmZpcmVFdmVudCgnYmVmb3JlZnVsbHNjcmVlbmNoYW5nZScsIGZ1bGxzY3JlZW4pO1xuICAgICAgICAgICAgICAgIGlmIChiYWlkdS5lZGl0b3IuYnJvd3Nlci5nZWNrbykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgYmsgPSBlZGl0b3Iuc2VsZWN0aW9uLmdldFJhbmdlKCkuY3JlYXRlQm9va21hcmsoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGZ1bGxzY3JlZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGNvbnRhaW5lci50YWdOYW1lICE9IFwiQk9EWVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcG9zaXRpb24gPSBiYWlkdS5lZGl0b3IuZG9tLmRvbVV0aWxzLmdldENvbXB1dGVkU3R5bGUoY29udGFpbmVyLCBcInBvc2l0aW9uXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZVN0YWNrLnB1c2gocG9zaXRpb24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLnN0eWxlLnBvc2l0aW9uID0gXCJzdGF0aWNcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lciA9IGNvbnRhaW5lci5wYXJlbnROb2RlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2Jha0h0bWxPdmVyZmxvdyA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZS5vdmVyZmxvdztcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYmFrQm9keU92ZXJmbG93ID0gZG9jdW1lbnQuYm9keS5zdHlsZS5vdmVyZmxvdztcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYmFrQXV0b0hlaWdodCA9IHRoaXMuZWRpdG9yLmF1dG9IZWlnaHRFbmFibGVkO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9iYWtTY3JvbGxUb3AgPSBNYXRoLm1heChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wLCBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcCk7XG5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYmFrRWRpdG9yQ29udGFuaW5lcldpZHRoID0gZWRpdG9yLmlmcmFtZS5wYXJlbnROb2RlLm9mZnNldFdpZHRoO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fYmFrQXV0b0hlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy/lvZPlhajlsY/ml7bkuI3og73miafooYzoh6rliqjplb/pq5hcbiAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvci5hdXRvSGVpZ2h0RW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lZGl0b3IuZGlzYWJsZUF1dG9IZWlnaHQoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nO1xuICAgICAgICAgICAgICAgICAgICAvL+S/ruWkje+8jOa7muWKqOadoeS4jeaUtui1t+eahOmXrumimFxuXG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbygwLHdpbmRvdy5zY3JvbGxZKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYmFrQ3NzVGV4dCA9IHRoaXMuZ2V0RG9tKCkuc3R5bGUuY3NzVGV4dDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYmFrQ3NzVGV4dDEgPSB0aGlzLmdldERvbSgnaWZyYW1laG9sZGVyJykuc3R5bGUuY3NzVGV4dDtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmlmcmFtZS5wYXJlbnROb2RlLnN0eWxlLndpZHRoID0gJyc7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUZ1bGxTY3JlZW4oKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY29udGFpbmVyLnRhZ05hbWUgIT0gXCJCT0RZXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5zdHlsZS5wb3NpdGlvbiA9IG5vZGVTdGFjay5zaGlmdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyID0gY29udGFpbmVyLnBhcmVudE5vZGU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXREb20oKS5zdHlsZS5jc3NUZXh0ID0gdGhpcy5fYmFrQ3NzVGV4dDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXREb20oJ2lmcmFtZWhvbGRlcicpLnN0eWxlLmNzc1RleHQgPSB0aGlzLl9iYWtDc3NUZXh0MTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2Jha0F1dG9IZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvci5hdXRvSGVpZ2h0RW5hYmxlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5lbmFibGVBdXRvSGVpZ2h0KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUub3ZlcmZsb3cgPSB0aGlzLl9iYWtIdG1sT3ZlcmZsb3c7XG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUub3ZlcmZsb3cgPSB0aGlzLl9iYWtCb2R5T3ZlcmZsb3c7XG4gICAgICAgICAgICAgICAgICAgIGVkaXRvci5pZnJhbWUucGFyZW50Tm9kZS5zdHlsZS53aWR0aCA9IHRoaXMuX2Jha0VkaXRvckNvbnRhbmluZXJXaWR0aCArICdweCc7XG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbygwLCB0aGlzLl9iYWtTY3JvbGxUb3ApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoYnJvd3Nlci5nZWNrbyAmJiBlZGl0b3IuYm9keS5jb250ZW50RWRpdGFibGUgPT09ICd0cnVlJykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpO1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGlucHV0KTtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmJvZHkuY29udGVudEVkaXRhYmxlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQuZm9jdXMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvci5ib2R5LmNvbnRlbnRFZGl0YWJsZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmZpcmVFdmVudCgnZnVsbHNjcmVlbmNoYW5nZWQnLCBmdWxsc2NyZWVuKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlZGl0b3Iuc2VsZWN0aW9uLmdldFJhbmdlKCkubW92ZVRvQm9va21hcmsoYmspLnNlbGVjdCh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWlkdS5lZGl0b3IuZG9tLmRvbVV0aWxzLnJlbW92ZShpbnB1dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVsbHNjcmVlbiAmJiB3aW5kb3cuc2Nyb2xsKDAsIDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSwgMClcbiAgICAgICAgICAgICAgICAgICAgfSwgMClcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZihlZGl0b3IuYm9keS5jb250ZW50RWRpdGFibGUgPT09ICd0cnVlJyl7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLmZpcmVFdmVudCgnZnVsbHNjcmVlbmNoYW5nZWQnLCBmdWxsc2NyZWVuKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyTGF5b3V0KCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIF91cGRhdGVGdWxsU2NyZWVuOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9mdWxsc2NyZWVuKSB7XG4gICAgICAgICAgICAgICAgdmFyIHZwUmVjdCA9IHVpVXRpbHMuZ2V0Vmlld3BvcnRSZWN0KCk7XG4gICAgICAgICAgICAgICAgdGhpcy5nZXREb20oKS5zdHlsZS5jc3NUZXh0ID0gJ2JvcmRlcjowO3Bvc2l0aW9uOmFic29sdXRlO2xlZnQ6MDt0b3A6JyArICh0aGlzLmVkaXRvci5vcHRpb25zLnRvcE9mZnNldCB8fCAwKSArICdweDt3aWR0aDonICsgdnBSZWN0LndpZHRoICsgJ3B4O2hlaWdodDonICsgdnBSZWN0LmhlaWdodCArICdweDt6LWluZGV4OicgKyAodGhpcy5nZXREb20oKS5zdHlsZS56SW5kZXggKiAxICsgMTAwKTtcbiAgICAgICAgICAgICAgICB1aVV0aWxzLnNldFZpZXdwb3J0T2Zmc2V0KHRoaXMuZ2V0RG9tKCksIHsgbGVmdDowLCB0b3A6dGhpcy5lZGl0b3Iub3B0aW9ucy50b3BPZmZzZXQgfHwgMCB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRIZWlnaHQodnBSZWN0LmhlaWdodCAtIHRoaXMuZ2V0RG9tKCd0b29sYmFyYm94Jykub2Zmc2V0SGVpZ2h0IC0gdGhpcy5nZXREb20oJ2JvdHRvbWJhcicpLm9mZnNldEhlaWdodCAtICh0aGlzLmVkaXRvci5vcHRpb25zLnRvcE9mZnNldCB8fCAwKSx0cnVlKTtcbiAgICAgICAgICAgICAgICAvL+S4jeaJi+WKqOiwg+S4gOS4i++8jOS8muWvvOiHtOWFqOWxj+WkseaViFxuICAgICAgICAgICAgICAgIGlmKGJyb3dzZXIuZ2Vja28pe1xuICAgICAgICAgICAgICAgICAgICB0cnl7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cub25yZXNpemUoKTtcbiAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGUpe1xuXG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgX3VwZGF0ZUVsZW1lbnRQYXRoOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBib3R0b20gPSB0aGlzLmdldERvbSgnZWxlbWVudHBhdGgnKSwgbGlzdDtcbiAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnRQYXRoRW5hYmxlZCAmJiAobGlzdCA9IHRoaXMuZWRpdG9yLnF1ZXJ5Q29tbWFuZFZhbHVlKCdlbGVtZW50cGF0aCcpKSkge1xuXG4gICAgICAgICAgICAgICAgdmFyIGJ1ZmYgPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2k7IGNpID0gbGlzdFtpXTsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGJ1ZmZbaV0gPSB0aGlzLmZvcm1hdEh0bWwoJzxzcGFuIHVuc2VsZWN0YWJsZT1cIm9uXCIgb25jbGljaz1cIiQkLmVkaXRvci5leGVjQ29tbWFuZCgmcXVvdDtlbGVtZW50cGF0aCZxdW90OywgJnF1b3Q7JyArIGkgKyAnJnF1b3Q7KTtcIj4nICsgY2kgKyAnPC9zcGFuPicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBib3R0b20uaW5uZXJIVE1MID0gJzxkaXYgY2xhc3M9XCJlZHVpLWVkaXRvci1icmVhZGNydW1iXCIgb25tb3VzZWRvd249XCJyZXR1cm4gZmFsc2U7XCI+JyArIHRoaXMuZWRpdG9yLmdldExhbmcoXCJlbGVtZW50UGF0aFRpcFwiKSArICc6ICcgKyBidWZmLmpvaW4oJyAmZ3Q7ICcpICsgJzwvZGl2Pic7XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYm90dG9tLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSdcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgZGlzYWJsZUVsZW1lbnRQYXRoOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBib3R0b20gPSB0aGlzLmdldERvbSgnZWxlbWVudHBhdGgnKTtcbiAgICAgICAgICAgIGJvdHRvbS5pbm5lckhUTUwgPSAnJztcbiAgICAgICAgICAgIGJvdHRvbS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICAgICAgdGhpcy5lbGVtZW50UGF0aEVuYWJsZWQgPSBmYWxzZTtcblxuICAgICAgICB9LFxuICAgICAgICBlbmFibGVFbGVtZW50UGF0aDpmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgYm90dG9tID0gdGhpcy5nZXREb20oJ2VsZW1lbnRwYXRoJyk7XG4gICAgICAgICAgICBib3R0b20uc3R5bGUuZGlzcGxheSA9ICcnO1xuICAgICAgICAgICAgdGhpcy5lbGVtZW50UGF0aEVuYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5fdXBkYXRlRWxlbWVudFBhdGgoKTtcbiAgICAgICAgfSxcbiAgICAgICAgX3NjYWxlOmZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBkb2MgPSBkb2N1bWVudCxcbiAgICAgICAgICAgICAgICBlZGl0b3IgPSB0aGlzLmVkaXRvcixcbiAgICAgICAgICAgICAgICBlZGl0b3JIb2xkZXIgPSBlZGl0b3IuY29udGFpbmVyLFxuICAgICAgICAgICAgICAgIGVkaXRvckRvY3VtZW50ID0gZWRpdG9yLmRvY3VtZW50LFxuICAgICAgICAgICAgICAgIHRvb2xiYXJCb3ggPSB0aGlzLmdldERvbShcInRvb2xiYXJib3hcIiksXG4gICAgICAgICAgICAgICAgYm90dG9tYmFyID0gdGhpcy5nZXREb20oXCJib3R0b21iYXJcIiksXG4gICAgICAgICAgICAgICAgc2NhbGUgPSB0aGlzLmdldERvbShcInNjYWxlXCIpLFxuICAgICAgICAgICAgICAgIHNjYWxlbGF5ZXIgPSB0aGlzLmdldERvbShcInNjYWxlbGF5ZXJcIik7XG5cbiAgICAgICAgICAgIHZhciBpc01vdXNlTW92ZSA9IGZhbHNlLFxuICAgICAgICAgICAgICAgIHBvc2l0aW9uID0gbnVsbCxcbiAgICAgICAgICAgICAgICBtaW5FZGl0b3JIZWlnaHQgPSAwLFxuICAgICAgICAgICAgICAgIG1pbkVkaXRvcldpZHRoID0gZWRpdG9yLm9wdGlvbnMubWluRnJhbWVXaWR0aCxcbiAgICAgICAgICAgICAgICBwYWdlWCA9IDAsXG4gICAgICAgICAgICAgICAgcGFnZVkgPSAwLFxuICAgICAgICAgICAgICAgIHNjYWxlV2lkdGggPSAwLFxuICAgICAgICAgICAgICAgIHNjYWxlSGVpZ2h0ID0gMDtcblxuICAgICAgICAgICAgZnVuY3Rpb24gZG93bigpIHtcbiAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IGRvbVV0aWxzLmdldFhZKGVkaXRvckhvbGRlcik7XG5cbiAgICAgICAgICAgICAgICBpZiAoIW1pbkVkaXRvckhlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICBtaW5FZGl0b3JIZWlnaHQgPSBlZGl0b3Iub3B0aW9ucy5taW5GcmFtZUhlaWdodCArIHRvb2xiYXJCb3gub2Zmc2V0SGVpZ2h0ICsgYm90dG9tYmFyLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBzY2FsZWxheWVyLnN0eWxlLmNzc1RleHQgPSBcInBvc2l0aW9uOmFic29sdXRlO2xlZnQ6MDtkaXNwbGF5Ojt0b3A6MDtiYWNrZ3JvdW5kLWNvbG9yOiM0MUFCRkY7b3BhY2l0eTowLjQ7ZmlsdGVyOiBBbHBoYShvcGFjaXR5PTQwKTt3aWR0aDpcIiArIGVkaXRvckhvbGRlci5vZmZzZXRXaWR0aCArIFwicHg7aGVpZ2h0OlwiXG4gICAgICAgICAgICAgICAgICAgICsgZWRpdG9ySG9sZGVyLm9mZnNldEhlaWdodCArIFwicHg7ei1pbmRleDpcIiArIChlZGl0b3Iub3B0aW9ucy56SW5kZXggKyAxKTtcblxuICAgICAgICAgICAgICAgIGRvbVV0aWxzLm9uKGRvYywgXCJtb3VzZW1vdmVcIiwgbW92ZSk7XG4gICAgICAgICAgICAgICAgZG9tVXRpbHMub24oZWRpdG9yRG9jdW1lbnQsIFwibW91c2V1cFwiLCB1cCk7XG4gICAgICAgICAgICAgICAgZG9tVXRpbHMub24oZG9jLCBcIm1vdXNldXBcIiwgdXApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YXIgbWUgPSB0aGlzO1xuICAgICAgICAgICAgLy9ieSB4dWhlbmcg5YWo5bGP5pe25YWz5o6J57yp5pS+XG4gICAgICAgICAgICB0aGlzLmVkaXRvci5hZGRMaXN0ZW5lcignZnVsbHNjcmVlbmNoYW5nZWQnLCBmdW5jdGlvbiAoZSwgZnVsbFNjcmVlbikge1xuICAgICAgICAgICAgICAgIGlmIChmdWxsU2NyZWVuKSB7XG4gICAgICAgICAgICAgICAgICAgIG1lLmRpc2FibGVTY2FsZSgpO1xuXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1lLmVkaXRvci5vcHRpb25zLnNjYWxlRW5hYmxlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWUuZW5hYmxlU2NhbGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0bXBOb2RlID0gbWUuZWRpdG9yLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmVkaXRvci5ib2R5LmFwcGVuZENoaWxkKHRtcE5vZGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbWUuZWRpdG9yLmJvZHkuc3R5bGUuaGVpZ2h0ID0gTWF0aC5tYXgoZG9tVXRpbHMuZ2V0WFkodG1wTm9kZSkueSwgbWUuZWRpdG9yLmlmcmFtZS5vZmZzZXRIZWlnaHQgLSAyMCkgKyAncHgnO1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9tVXRpbHMucmVtb3ZlKHRtcE5vZGUpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGZ1bmN0aW9uIG1vdmUoZXZlbnQpIHtcbiAgICAgICAgICAgICAgICBjbGVhclNlbGVjdGlvbigpO1xuICAgICAgICAgICAgICAgIHZhciBlID0gZXZlbnQgfHwgd2luZG93LmV2ZW50O1xuICAgICAgICAgICAgICAgIHBhZ2VYID0gZS5wYWdlWCB8fCAoZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0ICsgZS5jbGllbnRYKTtcbiAgICAgICAgICAgICAgICBwYWdlWSA9IGUucGFnZVkgfHwgKGRvYy5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wICsgZS5jbGllbnRZKTtcbiAgICAgICAgICAgICAgICBzY2FsZVdpZHRoID0gcGFnZVggLSBwb3NpdGlvbi54O1xuICAgICAgICAgICAgICAgIHNjYWxlSGVpZ2h0ID0gcGFnZVkgLSBwb3NpdGlvbi55O1xuXG4gICAgICAgICAgICAgICAgaWYgKHNjYWxlV2lkdGggPj0gbWluRWRpdG9yV2lkdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNNb3VzZU1vdmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBzY2FsZWxheWVyLnN0eWxlLndpZHRoID0gc2NhbGVXaWR0aCArICdweCc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzY2FsZUhlaWdodCA+PSBtaW5FZGl0b3JIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNNb3VzZU1vdmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBzY2FsZWxheWVyLnN0eWxlLmhlaWdodCA9IHNjYWxlSGVpZ2h0ICsgXCJweFwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZnVuY3Rpb24gdXAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKGlzTW91c2VNb3ZlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzTW91c2VNb3ZlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGVkaXRvci51aS5fYWN0dWFsRnJhbWVXaWR0aCA9IHNjYWxlbGF5ZXIub2Zmc2V0V2lkdGggLSAyO1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3JIb2xkZXIuc3R5bGUud2lkdGggPSBlZGl0b3IudWkuX2FjdHVhbEZyYW1lV2lkdGggKyAncHgnO1xuXG4gICAgICAgICAgICAgICAgICAgIGVkaXRvci5zZXRIZWlnaHQoc2NhbGVsYXllci5vZmZzZXRIZWlnaHQgLSBib3R0b21iYXIub2Zmc2V0SGVpZ2h0IC0gdG9vbGJhckJveC5vZmZzZXRIZWlnaHQgLSAyLHRydWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoc2NhbGVsYXllcikge1xuICAgICAgICAgICAgICAgICAgICBzY2FsZWxheWVyLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2xlYXJTZWxlY3Rpb24oKTtcbiAgICAgICAgICAgICAgICBkb21VdGlscy51bihkb2MsIFwibW91c2Vtb3ZlXCIsIG1vdmUpO1xuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnVuKGVkaXRvckRvY3VtZW50LCBcIm1vdXNldXBcIiwgdXApO1xuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnVuKGRvYywgXCJtb3VzZXVwXCIsIHVwKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZnVuY3Rpb24gY2xlYXJTZWxlY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgaWYgKGJyb3dzZXIuaWUpXG4gICAgICAgICAgICAgICAgICAgIGRvYy5zZWxlY3Rpb24uY2xlYXIoKTtcbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5nZXRTZWxlY3Rpb24oKS5yZW1vdmVBbGxSYW5nZXMoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5lbmFibGVTY2FsZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAvL3RyYWNlOjI4NjhcbiAgICAgICAgICAgICAgICBpZiAoZWRpdG9yLnF1ZXJ5Q29tbWFuZFN0YXRlKFwic291cmNlXCIpID09IDEpICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICBzY2FsZS5zdHlsZS5kaXNwbGF5ID0gXCJcIjtcbiAgICAgICAgICAgICAgICB0aGlzLnNjYWxlRW5hYmxlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgZG9tVXRpbHMub24oc2NhbGUsIFwibW91c2Vkb3duXCIsIGRvd24pO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuZGlzYWJsZVNjYWxlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHNjYWxlLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcbiAgICAgICAgICAgICAgICB0aGlzLnNjYWxlRW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGRvbVV0aWxzLnVuKHNjYWxlLCBcIm1vdXNlZG93blwiLCBkb3duKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0sXG4gICAgICAgIGlzRnVsbFNjcmVlbjpmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fZnVsbHNjcmVlbjtcbiAgICAgICAgfSxcbiAgICAgICAgcG9zdFJlbmRlcjpmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBVSUJhc2UucHJvdG90eXBlLnBvc3RSZW5kZXIuY2FsbCh0aGlzKTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy50b29sYmFycy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHRoaXMudG9vbGJhcnNbaV0ucG9zdFJlbmRlcigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIG1lID0gdGhpcztcbiAgICAgICAgICAgIHZhciB0aW1lcklkLFxuICAgICAgICAgICAgICAgIGRvbVV0aWxzID0gYmFpZHUuZWRpdG9yLmRvbS5kb21VdGlscyxcbiAgICAgICAgICAgICAgICB1cGRhdGVGdWxsU2NyZWVuVGltZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVySWQpO1xuICAgICAgICAgICAgICAgICAgICB0aW1lcklkID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZS5fdXBkYXRlRnVsbFNjcmVlbigpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgZG9tVXRpbHMub24od2luZG93LCAncmVzaXplJywgdXBkYXRlRnVsbFNjcmVlblRpbWUpO1xuXG4gICAgICAgICAgICBtZS5hZGRMaXN0ZW5lcignZGVzdHJveScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBkb21VdGlscy51bih3aW5kb3csICdyZXNpemUnLCB1cGRhdGVGdWxsU2NyZWVuVGltZSk7XG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVySWQpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfSxcbiAgICAgICAgc2hvd1Rvb2xiYXJNc2c6ZnVuY3Rpb24gKG1zZywgZmxhZykge1xuICAgICAgICAgICAgdGhpcy5nZXREb20oJ3Rvb2xiYXJtc2dfbGFiZWwnKS5pbm5lckhUTUwgPSBtc2c7XG4gICAgICAgICAgICB0aGlzLmdldERvbSgndG9vbGJhcm1zZycpLnN0eWxlLmRpc3BsYXkgPSAnJztcbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgICBpZiAoIWZsYWcpIHtcbiAgICAgICAgICAgICAgICB2YXIgdyA9IHRoaXMuZ2V0RG9tKCd1cGxvYWRfZGlhbG9nJyk7XG4gICAgICAgICAgICAgICAgdy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBoaWRlVG9vbGJhck1zZzpmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB0aGlzLmdldERvbSgndG9vbGJhcm1zZycpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICAgIH0sXG4gICAgICAgIG1hcFVybDpmdW5jdGlvbiAodXJsKSB7XG4gICAgICAgICAgICByZXR1cm4gdXJsID8gdXJsLnJlcGxhY2UoJ34vJywgdGhpcy5lZGl0b3Iub3B0aW9ucy5VRURJVE9SX0hPTUVfVVJMIHx8ICcnKSA6ICcnXG4gICAgICAgIH0sXG4gICAgICAgIHRyaWdnZXJMYXlvdXQ6ZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIGRvbSA9IHRoaXMuZ2V0RG9tKCk7XG4gICAgICAgICAgICBpZiAoZG9tLnN0eWxlLnpvb20gPT0gJzEnKSB7XG4gICAgICAgICAgICAgICAgZG9tLnN0eWxlLnpvb20gPSAnMTAwJSc7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGRvbS5zdHlsZS56b29tID0gJzEnO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcbiAgICB1dGlscy5pbmhlcml0cyhFZGl0b3JVSSwgYmFpZHUuZWRpdG9yLnVpLlVJQmFzZSk7XG5cblxuICAgIHZhciBpbnN0YW5jZXMgPSB7fTtcblxuXG4gICAgVUUudWkuRWRpdG9yID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgICAgdmFyIGVkaXRvciA9IG5ldyBVRS5FZGl0b3Iob3B0aW9ucyk7XG4gICAgICAgIGVkaXRvci5vcHRpb25zLmVkaXRvciA9IGVkaXRvcjtcbiAgICAgICAgdXRpbHMubG9hZEZpbGUoZG9jdW1lbnQsIHtcbiAgICAgICAgICAgIGhyZWY6ZWRpdG9yLm9wdGlvbnMudGhlbWVQYXRoICsgZWRpdG9yLm9wdGlvbnMudGhlbWUgKyBcIi9jc3MvdWVkaXRvci5jc3NcIixcbiAgICAgICAgICAgIHRhZzpcImxpbmtcIixcbiAgICAgICAgICAgIHR5cGU6XCJ0ZXh0L2Nzc1wiLFxuICAgICAgICAgICAgcmVsOlwic3R5bGVzaGVldFwiXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHZhciBvbGRSZW5kZXIgPSBlZGl0b3IucmVuZGVyO1xuICAgICAgICBlZGl0b3IucmVuZGVyID0gZnVuY3Rpb24gKGhvbGRlcikge1xuICAgICAgICAgICAgaWYgKGhvbGRlci5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nKSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmtleSA9IGhvbGRlcjtcbiAgICAgICAgICAgICAgICBpbnN0YW5jZXNbaG9sZGVyXSA9IGVkaXRvcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHV0aWxzLmRvbVJlYWR5KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IubGFuZ0lzUmVhZHkgPyByZW5kZXJVSSgpIDogZWRpdG9yLmFkZExpc3RlbmVyKFwibGFuZ1JlYWR5XCIsIHJlbmRlclVJKTtcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiByZW5kZXJVSSgpIHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLnNldE9wdCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbE1hcDplZGl0b3Iub3B0aW9ucy5sYWJlbE1hcCB8fCBlZGl0b3IuZ2V0TGFuZygnbGFiZWxNYXAnKVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgbmV3IEVkaXRvclVJKGVkaXRvci5vcHRpb25zKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGhvbGRlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhvbGRlci5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9sZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaG9sZGVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGhvbGRlciAmJiBob2xkZXIuZ2V0QXR0cmlidXRlKCduYW1lJykgJiYgKCBlZGl0b3Iub3B0aW9ucy50ZXh0YXJlYSA9IGhvbGRlci5nZXRBdHRyaWJ1dGUoJ25hbWUnKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaG9sZGVyICYmIC9zY3JpcHR8dGV4dGFyZWEvaWcudGVzdChob2xkZXIudGFnTmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9sZGVyLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5ld0RpdiwgaG9sZGVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udCA9IGhvbGRlci52YWx1ZSB8fCBob2xkZXIuaW5uZXJIVE1MO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvci5vcHRpb25zLmluaXRpYWxDb250ZW50ID0gL15bXFx0XFxyXFxuIF0qJC8udGVzdChjb250KSA/IGVkaXRvci5vcHRpb25zLmluaXRpYWxDb250ZW50IDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udC5yZXBsYWNlKC8+W1xcblxcclxcdF0rKFsgXXs0fSkrL2csICc+JylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bXFxuXFxyXFx0XSsoWyBdezR9KSs8L2csICc8JylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8+W1xcblxcclxcdF0rPC9nLCAnPjwnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBob2xkZXIuY2xhc3NOYW1lICYmIChuZXdEaXYuY2xhc3NOYW1lID0gaG9sZGVyLmNsYXNzTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9sZGVyLnN0eWxlLmNzc1RleHQgJiYgKG5ld0Rpdi5zdHlsZS5jc3NUZXh0ID0gaG9sZGVyLnN0eWxlLmNzc1RleHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgvdGV4dGFyZWEvaS50ZXN0KGhvbGRlci50YWdOYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlZGl0b3IudGV4dGFyZWEgPSBob2xkZXI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVkaXRvci50ZXh0YXJlYS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBob2xkZXIucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChob2xkZXIpO1xuXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaG9sZGVyLmlkKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3RGl2LmlkID0gaG9sZGVyLmlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5yZW1vdmVBdHRyaWJ1dGVzKGhvbGRlciwnaWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9sZGVyID0gbmV3RGl2O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvbGRlci5pbm5lckhUTUwgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGRvbVV0aWxzLmFkZENsYXNzKGhvbGRlciwgXCJlZHVpLVwiICsgZWRpdG9yLm9wdGlvbnMudGhlbWUpO1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3IudWkucmVuZGVyKGhvbGRlcik7XG4gICAgICAgICAgICAgICAgICAgIHZhciBvcHQgPSBlZGl0b3Iub3B0aW9ucztcbiAgICAgICAgICAgICAgICAgICAgLy/nu5nlrp7kvovmt7vliqDkuIDkuKrnvJbovpHlmajnmoTlrrnlmajlvJXnlKhcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmNvbnRhaW5lciA9IGVkaXRvci51aS5nZXREb20oKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudHMgPSBkb21VdGlscy5maW5kUGFyZW50cyhob2xkZXIsdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBkaXNwbGF5cyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwICxjaTtjaT1wYXJlbnRzW2ldO2krKyl7XG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5c1tpXSA9IGNpLnN0eWxlLmRpc3BsYXk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJ1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHQuaW5pdGlhbEZyYW1lV2lkdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdC5taW5GcmFtZVdpZHRoID0gb3B0LmluaXRpYWxGcmFtZVdpZHRoO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0Lm1pbkZyYW1lV2lkdGggPSBvcHQuaW5pdGlhbEZyYW1lV2lkdGggPSBob2xkZXIub2Zmc2V0V2lkdGg7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGVXaWR0aCA9IGhvbGRlci5zdHlsZS53aWR0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKC8lJC8udGVzdChzdHlsZVdpZHRoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdC5pbml0aWFsRnJhbWVXaWR0aCA9IHN0eWxlV2lkdGg7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdC5pbml0aWFsRnJhbWVIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdC5taW5GcmFtZUhlaWdodCA9IG9wdC5pbml0aWFsRnJhbWVIZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHQuaW5pdGlhbEZyYW1lSGVpZ2h0ID0gb3B0Lm1pbkZyYW1lSGVpZ2h0ID0gaG9sZGVyLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwICxjaTtjaT1wYXJlbnRzW2ldO2krKyl7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaS5zdHlsZS5kaXNwbGF5ID0gIGRpc3BsYXlzW2ldXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy/nvJbovpHlmajmnIDlpJblrrnlmajorr7nva7kuobpq5jluqbvvIzkvJrlr7zoh7TvvIznvJbovpHlmajkuI3ljaDkvY1cbiAgICAgICAgICAgICAgICAgICAgLy90b2RvIOWFiOWOu+aOie+8jOayoeacieaJvuWIsOWOn+WboFxuICAgICAgICAgICAgICAgICAgICBpZihob2xkZXIuc3R5bGUuaGVpZ2h0KXtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhvbGRlci5zdHlsZS5oZWlnaHQgPSAnJ1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVkaXRvci5jb250YWluZXIuc3R5bGUud2lkdGggPSBvcHQuaW5pdGlhbEZyYW1lV2lkdGggKyAoLyUkLy50ZXN0KG9wdC5pbml0aWFsRnJhbWVXaWR0aCkgPyAnJyA6ICdweCcpO1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3IuY29udGFpbmVyLnN0eWxlLnpJbmRleCA9IG9wdC56SW5kZXg7XG4gICAgICAgICAgICAgICAgICAgIG9sZFJlbmRlci5jYWxsKGVkaXRvciwgZWRpdG9yLnVpLmdldERvbSgnaWZyYW1laG9sZGVyJykpO1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3IuZmlyZUV2ZW50KFwiYWZ0ZXJ1aXJlYWR5XCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBlZGl0b3I7XG4gICAgfTtcblxuXG4gICAgLyoqXG4gICAgICogQGZpbGVcbiAgICAgKiBAbmFtZSBVRVxuICAgICAqIEBzaG9ydCBVRVxuICAgICAqIEBkZXNjIFVFZGl0b3LnmoTpobbpg6jlkb3lkI3nqbrpl7RcbiAgICAgKi9cbiAgICAvKipcbiAgICAgKiBAbmFtZSBnZXRFZGl0b3JcbiAgICAgKiBAc2luY2UgMS4yLjQrXG4gICAgICogQGdyYW1tYXIgVUUuZ2V0RWRpdG9yKGlkLFtvcHRdKSAgPT4gIEVkaXRvcuWunuS+i1xuICAgICAqIEBkZXNjIOaPkOS+m+S4gOS4quWFqOWxgOeahOaWueazleW+l+WIsOe8lui+keWZqOWunuS+i1xuICAgICAqXG4gICAgICogKiAnJ2lkJycgIOaUvue9rue8lui+keWZqOeahOWuueWZqGlkLCDlpoLmnpzlrrnlmajkuIvnmoTnvJbovpHlmajlt7Lnu4/lrZjlnKjvvIzlsLHnm7TmjqXov5Tlm55cbiAgICAgKiAqICcnb3B0Jycg57yW6L6R5Zmo55qE5Y+v6YCJ5Y+C5pWwXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiAgVUUuZ2V0RWRpdG9yKCdjb250YWluZXJJZCcse29ucmVhZHk6ZnVuY3Rpb24oKXsvL+WIm+W7uuS4gOS4que8lui+keWZqOWunuS+i1xuICAgICAqICAgICAgdGhpcy5zZXRDb250ZW50KCdoZWxsbycpXG4gICAgICogIH19KTtcbiAgICAgKiAgVUUuZ2V0RWRpdG9yKCdjb250YWluZXJJZCcpOyAvL+i/lOWbnuWImuWIm+W7uueahOWunuS+i1xuICAgICAqXG4gICAgICovXG4gIC8qICBVRS5nZXRFZGl0b3IgPSBmdW5jdGlvbiAoaWQsIG9wdCkge1xuICAgICAgICB2YXIgZWRpdG9yID0gaW5zdGFuY2VzW2lkXTtcbiAgICAgICAgaWYgKCFlZGl0b3IpIHtcbiAgICAgICAgICAgIGVkaXRvciA9IGluc3RhbmNlc1tpZF0gPSBuZXcgVUUudWkuRWRpdG9yKG9wdCk7XG4gICAgICAgICAgICBlZGl0b3IucmVuZGVyKGlkKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZWRpdG9yO1xuICAgIH07Ki9cbiAgICBVRS5nZXRFZGl0b3IgPSBmdW5jdGlvbiAoaWQsIG9wdCkge1xuXG4gICAgXHRVRS5kZWxFZGl0b3IoaWQpO1xuICAgIFx0dmFyIGVkaXRvciA9IG5ldyBVRS51aS5FZGl0b3Iob3B0KTtcbiAgICBcdGVkaXRvci5yZW5kZXIoaWQpO1xuICAgIFx0cmV0dXJuIGVkaXRvcjtcbiAgICBcdH07XG5cbiAgICBVRS5kZWxFZGl0b3IgPSBmdW5jdGlvbiAoaWQpIHtcbiAgICAgICAgdmFyIGVkaXRvcjtcbiAgICAgICAgaWYgKGVkaXRvciA9IGluc3RhbmNlc1tpZF0pIHtcbiAgICAgICAgICAgIGVkaXRvci5rZXkgJiYgZWRpdG9yLmRlc3Ryb3koKTtcbiAgICAgICAgICAgIGRlbGV0ZSBpbnN0YW5jZXNbaWRdXG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgVUUucmVnaXN0ZXJVSSA9IGZ1bmN0aW9uKHVpTmFtZSxmbixpbmRleCxlZGl0b3JJZCl7XG4gICAgICAgIHV0aWxzLmVhY2godWlOYW1lLnNwbGl0KC9cXHMrLyksIGZ1bmN0aW9uIChuYW1lKSB7XG4gICAgICAgICAgICBVRS5fY3VzdG9taXplVUlbbmFtZV0gPSB7XG4gICAgICAgICAgICAgICAgaWQgOiBlZGl0b3JJZCxcbiAgICAgICAgICAgICAgICBleGVjRm46Zm4sXG4gICAgICAgICAgICAgICAgaW5kZXg6aW5kZXhcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pXG5cbiAgICB9XG5cbn0pKCk7XG5cbi8vIGFkYXB0ZXIvbWVzc2FnZS5qc1xuVUUucmVnaXN0ZXJVSSgnbWVzc2FnZScsIGZ1bmN0aW9uKGVkaXRvcikge1xuXG4gICAgdmFyIGVkaXRvcnVpID0gYmFpZHUuZWRpdG9yLnVpO1xuICAgIHZhciBNZXNzYWdlID0gZWRpdG9ydWkuTWVzc2FnZTtcbiAgICB2YXIgaG9sZGVyO1xuICAgIHZhciBfbWVzc2FnZUl0ZW1zID0gW107XG4gICAgdmFyIG1lID0gZWRpdG9yO1xuXG4gICAgbWUuYWRkTGlzdGVuZXIoJ3JlYWR5JywgZnVuY3Rpb24oKXtcbiAgICAgICAgaG9sZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobWUudWkuaWQgKyAnX21lc3NhZ2VfaG9sZGVyJyk7XG4gICAgICAgIHVwZGF0ZUhvbGRlclBvcygpO1xuICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICB1cGRhdGVIb2xkZXJQb3MoKTtcbiAgICAgICAgfSwgNTAwKTtcbiAgICB9KTtcblxuICAgIG1lLmFkZExpc3RlbmVyKCdzaG93bWVzc2FnZScsIGZ1bmN0aW9uKHR5cGUsIG9wdCl7XG4gICAgICAgIG9wdCA9IHV0aWxzLmlzU3RyaW5nKG9wdCkgPyB7XG4gICAgICAgICAgICAnY29udGVudCc6IG9wdFxuICAgICAgICB9IDogb3B0O1xuICAgICAgICB2YXIgbWVzc2FnZSA9IG5ldyBNZXNzYWdlKHtcbiAgICAgICAgICAgICAgICAndGltZW91dCc6IG9wdC50aW1lb3V0LFxuICAgICAgICAgICAgICAgICd0eXBlJzogb3B0LnR5cGUsXG4gICAgICAgICAgICAgICAgJ2NvbnRlbnQnOiBvcHQuY29udGVudCxcbiAgICAgICAgICAgICAgICAna2VlcHNob3cnOiBvcHQua2VlcHNob3csXG4gICAgICAgICAgICAgICAgJ2VkaXRvcic6IG1lXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIG1pZCA9IG9wdC5pZCB8fCAoJ21zZ18nICsgKCtuZXcgRGF0ZSgpKS50b1N0cmluZygzNikpO1xuICAgICAgICBtZXNzYWdlLnJlbmRlcihob2xkZXIpO1xuICAgICAgICBfbWVzc2FnZUl0ZW1zW21pZF0gPSBtZXNzYWdlO1xuICAgICAgICBtZXNzYWdlLnJlc2V0KG9wdCk7XG4gICAgICAgIHVwZGF0ZUhvbGRlclBvcygpO1xuICAgICAgICByZXR1cm4gbWlkO1xuICAgIH0pO1xuXG4gICAgbWUuYWRkTGlzdGVuZXIoJ3VwZGF0ZW1lc3NhZ2UnLGZ1bmN0aW9uKHR5cGUsIGlkLCBvcHQpe1xuICAgICAgICBvcHQgPSB1dGlscy5pc1N0cmluZyhvcHQpID8ge1xuICAgICAgICAgICAgJ2NvbnRlbnQnOiBvcHRcbiAgICAgICAgfSA6IG9wdDtcbiAgICAgICAgdmFyIG1lc3NhZ2UgPSBfbWVzc2FnZUl0ZW1zW2lkXTtcbiAgICAgICAgbWVzc2FnZS5yZW5kZXIoaG9sZGVyKTtcbiAgICAgICAgbWVzc2FnZSAmJiBtZXNzYWdlLnJlc2V0KG9wdCk7XG4gICAgfSk7XG5cbiAgICBtZS5hZGRMaXN0ZW5lcignaGlkZW1lc3NhZ2UnLGZ1bmN0aW9uKHR5cGUsIGlkKXtcbiAgICAgICAgdmFyIG1lc3NhZ2UgPSBfbWVzc2FnZUl0ZW1zW2lkXTtcbiAgICAgICAgbWVzc2FnZSAmJiBtZXNzYWdlLmhpZGUoKTtcbiAgICB9KTtcblxuICAgIGZ1bmN0aW9uIHVwZGF0ZUhvbGRlclBvcygpe1xuICAgICAgICB2YXIgdG9vbGJhcmJveCA9IG1lLnVpLmdldERvbSgndG9vbGJhcmJveCcpO1xuICAgICAgICBpZiAodG9vbGJhcmJveCkge1xuICAgICAgICAgICAgaG9sZGVyLnN0eWxlLnRvcCA9IHRvb2xiYXJib3gub2Zmc2V0SGVpZ2h0ICsgMyArICdweCc7XG4gICAgICAgIH1cbiAgICAgICAgaG9sZGVyLnN0eWxlLnpJbmRleCA9IE1hdGgubWF4KG1lLm9wdGlvbnMuekluZGV4LCBtZS5pZnJhbWUuc3R5bGUuekluZGV4KSArIDE7XG4gICAgfVxuXG59KTtcblxuXG4vLyBhZGFwdGVyL2F1dG9zYXZlLmpzXG5VRS5yZWdpc3RlclVJKCdhdXRvc2F2ZScsIGZ1bmN0aW9uKGVkaXRvcikge1xuICAgIHZhciB0aW1lciA9IG51bGwsdWlkID0gbnVsbDtcbiAgICBlZGl0b3Iub24oJ2FmdGVyYXV0b3NhdmUnLGZ1bmN0aW9uKCl7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG5cbiAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICBpZih1aWQpe1xuICAgICAgICAgICAgICAgIGVkaXRvci50cmlnZ2VyKCdoaWRlbWVzc2FnZScsdWlkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHVpZCA9IGVkaXRvci50cmlnZ2VyKCdzaG93bWVzc2FnZScse1xuICAgICAgICAgICAgICAgIGNvbnRlbnQgOiBlZGl0b3IuZ2V0TGFuZygnYXV0b3NhdmUuc3VjY2VzcycpLFxuICAgICAgICAgICAgICAgIHRpbWVvdXQgOiAyMDAwXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9LDIwMDApXG4gICAgfSlcblxufSk7XG5cblxuXG59KSgpO1xuIl0sImZpbGUiOiJwbHVnaW5zL3VlZGl0b3IvdWVkaXRvci5hbGwuanMifQ==
